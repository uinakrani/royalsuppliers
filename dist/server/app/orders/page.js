(()=>{var e={};e.id=569,e.ids=[569],e.modules={55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},25528:e=>{"use strict";e.exports=require("next/dist\\client\\components\\action-async-storage.external.js")},91877:e=>{"use strict";e.exports=require("next/dist\\client\\components\\request-async-storage.external.js")},25319:e=>{"use strict";e.exports=require("next/dist\\client\\components\\static-generation-async-storage.external.js")},6113:e=>{"use strict";e.exports=require("crypto")},9523:e=>{"use strict";e.exports=require("dns")},82361:e=>{"use strict";e.exports=require("events")},57147:e=>{"use strict";e.exports=require("fs")},13685:e=>{"use strict";e.exports=require("http")},85158:e=>{"use strict";e.exports=require("http2")},41808:e=>{"use strict";e.exports=require("net")},22037:e=>{"use strict";e.exports=require("os")},71017:e=>{"use strict";e.exports=require("path")},77282:e=>{"use strict";e.exports=require("process")},12781:e=>{"use strict";e.exports=require("stream")},24404:e=>{"use strict";e.exports=require("tls")},57310:e=>{"use strict";e.exports=require("url")},73837:e=>{"use strict";e.exports=require("util")},59796:e=>{"use strict";e.exports=require("zlib")},523:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>i.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>c,routeModule:()=>x,tree:()=>o});var a=r(67096),s=r(16132),n=r(37284),i=r.n(n),l=r(32564),d={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>l[e]);r.d(t,d);let o=["",{children:["orders",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,43692)),"C:\\Users\\ashis\\Desktop\\royalsuppliers\\royalsuppliers\\app\\orders\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,29184)),"C:\\Users\\ashis\\Desktop\\royalsuppliers\\royalsuppliers\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,9291,23)),"next/dist/client/components/not-found-error"]}],c=["C:\\Users\\ashis\\Desktop\\royalsuppliers\\royalsuppliers\\app\\orders\\page.tsx"],m="/orders/page",u={require:r,loadChunk:()=>Promise.resolve()},x=new a.AppPageRouteModule({definition:{kind:s.x.APP_PAGE,page:"/orders/page",pathname:"/orders",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},86789:(e,t,r)=>{Promise.resolve().then(r.bind(r,82074))},82074:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>OrdersPage});var a=r(30784),s=r(9885),n=r(59233),i=r(39431),l=r(37317),d=r(81766),o=r(2861),c=r(97684),m=r(93188),u=r(39546),x=r(26303),p=r(93680),y=r(22385),g=r(4780),h=r(37004),f=r(517),b=r(12029),j=r(59494),N=r(56206);r(88908);var v=r(79803),w=r(82332);function PaymentEditPopup({isOpen:e,onClose:t,onSave:r,initialData:n,maxAmount:i}){let[l,o]=(0,s.useState)(!1),[c,m]=(0,s.useState)(!1),[u,x]=(0,s.useState)(!1),[p,y]=(0,s.useState)("amount"),g=(0,s.useRef)(null),[h,f]=((0,s.useRef)(null),(0,s.useState)("")),[b,j]=(0,s.useState)(""),[P,C]=(0,s.useState)({});(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");x(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(e?(document.body.style.overflow="hidden",o(!1),m(!1),y("amount"),f(n.amount.toString()),j(new Date(n.date).toISOString().split("T")[0]),C({}),requestAnimationFrame(()=>{m(!0)})):(m(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[e,n]);let handleClose=()=>{o(!0),m(!1),setTimeout(()=>{t(),o(!1)},250)};return e&&(a.Fragment,"amount"!==p&&(()=>y("amount"),v.Z),N.Z,"amount"===p&&(P.amount,P.amount&&P.amount,i&&(0,d.formatIndianCurrency)(i)),"date"===p&&(P.date,P.date&&P.date),w.Z),null}var P=r(83643),C=r(64782),I=r(92484),S=r(58683),k=r(50007),T=r(66908),E=r(2389),A=r(533);let safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t};function PartyDetailPopup({group:e,isOpen:t,onClose:r,onEditOrder:n,onDeleteOrder:i,onOrderClick:o,onPaymentAdded:c,onPaymentRemoved:g}){let[h,b]=(0,s.useState)(!1),[j,v]=(0,s.useState)(!1),[w,I]=(0,s.useState)(!1),[S,D]=(0,s.useState)(!1),$=(0,s.useRef)(null);(0,s.useRef)(null),(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");D(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(t?(b(!1),v(!1),requestAnimationFrame(()=>{v(!0)}),document.body.style.overflow="hidden"):(v(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[t]);let handleClose=()=>{b(!0),v(!1),setTimeout(()=>{r(),b(!1)},250)},handleAddPayment=async()=>{if(!e||w)return;let t=e.totalSelling-e.totalPaid;try{let r=await C.h.prompt({title:"Add Payment",message:`Remaining balance: ${(0,d.formatIndianCurrency)(t)}`,inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Add Payment",cancelText:"Cancel"});if(!r)return;let a=Math.abs(parseFloat(String(r).replace(/,/g,"")));if(isNaN(a)||a<=0){(0,P.showToast)("Invalid amount","error");return}let s=await C.h.prompt({title:"Payment Note (optional)",inputLabel:"Note",inputPlaceholder:"Add a note (optional)",inputType:"text",required:!1,confirmText:"Save",cancelText:"Skip"});I(!0),await l.s.addPayment(e.partyName,a,s||void 0),(0,P.showToast)("Payment added successfully!","success"),c&&await c()}catch(e){e?.message&&!e.message.includes("SweetAlert")&&(0,P.showToast)(`Failed to add payment: ${e?.message||"Unknown error"}`,"error")}finally{I(!1)}},handleRemovePayment=async t=>{if(!e||w)return;let r=await C.h.confirm({title:"Remove Payment?",message:"Are you sure you want to remove this payment? This action cannot be undone.",icon:"warning",confirmText:"Remove",cancelText:"Cancel"});if(r)try{I(!0),await l.s.removePayment(t),(0,P.showToast)("Payment removed successfully!","success"),g&&await g()}catch(e){(0,P.showToast)(`Failed to remove payment: ${e?.message||"Unknown error"}`,"error")}finally{I(!1)}};if(!t||!e)return null;let O=e.totalSelling-e.totalPaid,M=safeParseDate(e.lastPaymentDate);return a.Fragment,p.Z,e.partyName,e.orders.length>0&&e.orders[0].siteName&&e.orders[0].siteName,N.Z,k.Z,(0,d.formatIndianCurrency)(e.totalSelling),e.totalProfit,(0,d.formatIndianCurrency)(e.totalProfit),(0,d.formatIndianCurrency)(e.totalPaid),(0,d.formatIndianCurrency)(Math.abs(O)),M&&null!==e.lastPaymentAmount&&((0,m.ZP)(M,"dd MMM yyyy"),(0,d.formatIndianCurrency)(e.lastPaymentAmount)),u.Z,e.orders.length,e.orders.map((e,t)=>{let r=safeParseDate(e.date),s=Array.isArray(e.material)?e.material:e.material?[e.material]:[],n=Number(e.originalTotal||0),i=e.partialPayments||[],l=i.reduce((e,t)=>e+t.amount,0),c=n-l,u=(0,A.I)(e),x=(0,A.w)(e);return(0,a.jsxs)("div",{className:"bg-white rounded-lg p-2 border border-blue-300 transition-all duration-150 active:bg-blue-50 native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden",animation:`fadeInUp 0.2s ease-out ${.03*t}s both`},onClick:t=>{o&&((0,E.m)(t),handleClose(),setTimeout(()=>o(e),300))},children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-0.5",children:[r&&a.jsx("span",{className:"text-[9px] text-gray-500",children:(0,m.ZP)(r,"dd MMM")}),a.jsx("span",{className:"text-xs font-semibold text-gray-900 truncate",children:e.siteName})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1 flex-wrap",children:[s.slice(0,2).map((e,t)=>a.jsx("span",{className:"bg-primary-50 text-primary-700 px-1 py-0.5 rounded text-[8px] font-medium",children:e},t)),s.length>2&&(0,a.jsxs)("span",{className:"text-[8px] text-gray-500",children:["+",s.length-2]})]})]}),(0,a.jsxs)("div",{className:"text-right ml-2 flex-shrink-0",children:[a.jsx("p",{className:"text-xs font-bold text-primary-600",children:(0,d.formatIndianCurrency)(e.total)}),a.jsx("div",{className:"text-[10px] font-semibold mt-0.5 text-right leading-tight",children:x?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("span",{className:"text-gray-500 line-through block",children:["Profit: ",(0,d.formatIndianCurrency)(e.profit)]}),a.jsx("span",{className:`${u>=0?"text-green-600":"text-red-600"} block`,children:(0,d.formatIndianCurrency)(u)})]}):(0,a.jsxs)("span",{className:`${e.profit>=0?"text-green-600":"text-red-600"}`,children:["Profit: ",(0,d.formatIndianCurrency)(e.profit)]})})]})]}),n>0&&(0,a.jsxs)("div",{className:"flex items-center justify-between pt-1 border-t border-gray-100 text-[9px]",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600",children:"Exp:"}),a.jsx("span",{className:"text-gray-700",children:(0,d.formatIndianCurrency)(n)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600",children:"Paid:"}),a.jsx("span",{className:`${l>0?"text-green-600":"text-gray-600"}`,children:(0,d.formatIndianCurrency)(l)})]}),c>0&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-gray-600",children:"Rem:"}),a.jsx("span",{className:"text-red-600",children:(0,d.formatIndianCurrency)(c)})]})]})]},e.id)}),T.Z,e.payments.length,y.Z,e.payments.length>0?a.jsx("div",{className:"space-y-2",children:e.payments.map((e,t)=>{let r=safeParseDate(e.payment.date);return a.jsx("div",{className:"bg-white rounded-lg p-2.5 border border-green-300 transition-all duration-200 active:bg-green-50",style:{animation:`fadeInUp 0.3s ease-out ${.05*t}s both`},children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{className:"flex-1",children:[a.jsx("p",{className:"text-sm font-bold text-gray-900",children:(0,d.formatIndianCurrency)(e.payment.amount)}),r&&(0,a.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[a.jsx(f.Z,{size:12,className:"text-gray-400"}),a.jsx("p",{className:"text-xs text-gray-500",children:(0,m.ZP)(r,"dd MMM yyyy HH:mm")})]}),e.payment.note&&a.jsx("p",{className:"text-xs text-gray-600 mt-1",children:e.payment.note})]}),!e.ledgerEntryId&&a.jsx("button",{onClick:t=>{(0,E.m)(t),handleRemovePayment(e.payment.id)},disabled:w,className:"p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 active:bg-red-200 transition-colors touch-manipulation native-press disabled:opacity-50 disabled:cursor-not-allowed",title:"Remove Payment",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:a.jsx(x.Z,{size:14})}),e.ledgerEntryId&&a.jsx("span",{className:"text-[9px] text-gray-400 px-2 py-1 bg-gray-100 rounded",title:"Linked to ledger entry - edit in ledger",children:"From Ledger"})]})},`${e.invoiceId}-${e.payment.id}-${t}`)})}):a.jsx("div",{className:"bg-white border border-green-300 rounded-lg p-4 text-center",children:a.jsx("p",{className:"text-sm text-gray-500",children:"No payments recorded"})}),null}var D=r(13303);let OrderDetailPopup_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t},$="manual-party-adjustment";function OrderDetailPopup({order:e,isOpen:t,onClose:r,onEdit:i,onDelete:l,onEditPayment:o,onRemovePayment:c,onOrderUpdated:y}){let[g,b]=(0,s.useState)(!1),[v,w]=(0,s.useState)(!1),[I,S]=(0,s.useState)(!1),E=(0,s.useRef)(null),[A,O]=((0,s.useRef)(null),(0,s.useState)("")),[M,Z]=(0,s.useState)(!1);(0,s.useEffect)(()=>{if(e){let t=(e.customerPayments||[]).reduce((e,t)=>e+t.amount,0),r=t>0?t:e.total;O(r.toString())}},[e]);let handleSaveAdjustment=async()=>{if(!e?.id)return;let t=parseFloat(A);if(isNaN(t)||t<0){(0,P.showToast)("Invalid amount","error");return}let r=e.customerPayments||[],a=r.find(e=>e.id===$),s=r.filter(e=>e.id!==$),i=s.reduce((e,t)=>e+t.amount,0);if(t+.01<i){(0,P.showToast)(`Actual amount cannot be less than recorded receipts (${(0,d.formatIndianCurrency)(i)})`,"error");return}let l=Number((t-i).toFixed(2)),o=[...s];if(l>.01){let e=a?.createdAt||new Date().toISOString();o.push({id:a?.id||$,amount:l,date:e,createdAt:e,note:"Manual adjustment via order details"})}try{await n.XK.updateOrder(e.id,{customerPayments:o}),Z(!1),O(t.toString()),y&&await y(),(0,P.showToast)("Party payment saved","success")}catch(e){console.error(e),(0,P.showToast)("Failed to save party payment","error")}};(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");S(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(t?(b(!1),w(!1),requestAnimationFrame(()=>{w(!0)}),document.body.style.overflow="hidden"):(w(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[t]);let handleClose=()=>{b(!0),w(!1),setTimeout(()=>{r(),b(!1)},250)};if(!t||!e)return null;let z=OrderDetailPopup_safeParseDate(e.date),R=Array.isArray(e.material)?e.material:e.material?[e.material]:[],F=e.partialPayments||[],_=F.reduce((e,t)=>e+t.amount,0),L=(e.customerPayments||[]).reduce((e,t)=>e+t.amount,0),q=F.reduce((e,t)=>e+t.amount,0),W=Number(e.expenseAdjustment||0),U=Number(e.revenueAdjustment||0),G=Number(e.adjustmentAmount||0),H=e.profit+W+U+G,B=L-q-e.additionalCost+G;return a.Fragment,N.Z,p.Z,e.partyName,(0,d.formatIndianCurrency)(e.total),e.siteName,k.Z,e.profit,(0,d.formatIndianCurrency)(e.profit),T.Z,(0,d.formatIndianCurrency)(_),f.Z,z&&(0,m.ZP)(z,"dd MMM yyyy"),z&&(0,m.ZP)(z,"hh:mm a"),D.Z,e.truckOwner,e.truckNo,T.Z,M?(0,a.jsxs)("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:handleSaveAdjustment,className:"text-green-600 text-xs font-bold",children:"Save"}),a.jsx("button",{onClick:()=>Z(!1),className:"text-gray-500 text-xs",children:"Cancel"})]}):a.jsx("button",{onClick:()=>Z(!0),className:"text-primary-600 text-xs font-medium",children:"Adjust Party Payment"}),M?(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"text-xs text-gray-600 w-20",children:"Actual Paid:"}),a.jsx("input",{type:"number",value:A,onChange:e=>O(e.target.value),className:"flex-1 p-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-primary-500 outline-none",placeholder:"Enter amount"})]}),(0,a.jsxs)("div",{className:"text-[10px] text-gray-500",children:["Expected Total: ",(0,d.formatIndianCurrency)(e.total)]})]}):(0,a.jsxs)("div",{className:"flex flex-col gap-2 text-xs text-gray-700",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[a.jsx("span",{children:"Realized Profit (Payments)"}),a.jsx("span",{className:`font-bold ${B>=0?"text-green-700":"text-red-600"}`,children:(0,d.formatIndianCurrency)(B)})]}),(0,a.jsxs)("div",{className:"border-t border-yellow-200 pt-2 space-y-1 text-[10px] text-gray-600",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Projected Profit (Original)"}),a.jsx("span",{className:"font-medium text-gray-700",children:(0,d.formatIndianCurrency)(e.profit)})]}),Math.abs(W)>.01&&(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Raw Expense Adjustment"}),a.jsx("span",{className:`${W>=0?"text-green-700":"text-red-600"} font-semibold`,children:(0,d.formatIndianCurrency)(W)})]}),Math.abs(U)>.01&&(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Party Payment Adjustment"}),a.jsx("span",{className:`${U>=0?"text-green-700":"text-red-600"} font-semibold`,children:(0,d.formatIndianCurrency)(U)})]}),Math.abs(G)>.01&&(0,a.jsxs)("div",{className:"flex justify-between",children:[a.jsx("span",{children:"Manual Adjustment"}),a.jsx("span",{className:`${G>=0?"text-green-700":"text-red-600"} font-semibold`,children:(0,d.formatIndianCurrency)(G)})]}),(0,a.jsxs)("div",{className:"flex justify-between font-semibold text-gray-900 text-xs border-t border-yellow-200 pt-2 mt-1",children:[a.jsx("span",{children:"Projected Profit (Adjusted)"}),a.jsx("span",{className:`${H>=0?"text-green-700":"text-red-600"}`,children:(0,d.formatIndianCurrency)(H)})]})]})]}),h.Z,R.map((e,t)=>a.jsx("span",{className:"bg-white px-2 py-1 rounded text-xs font-medium text-gray-700 border border-gray-300",children:e},t)),T.Z,0===F.length?a.jsx("div",{className:"text-center text-gray-500 py-4 text-xs",children:"No payments added yet"}):a.jsx("div",{className:"space-y-2",children:F.map(t=>{let r=OrderDetailPopup_safeParseDate(t.date),s=!!t.ledgerEntryId;return(0,a.jsxs)("div",{className:"bg-white rounded-lg p-2.5 border border-blue-300 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[a.jsx("span",{className:"font-semibold text-gray-900",style:{fontSize:"13px"},children:(0,d.formatIndianCurrency)(t.amount)}),s&&a.jsx("span",{className:"text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-medium",children:"From Ledger"})]}),r&&a.jsx("span",{className:"text-xs text-gray-500",children:(0,m.ZP)(r,"dd MMM yyyy")})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[r&&a.jsx("div",{className:"text-xs text-gray-500",children:(0,m.ZP)(r,"hh:mm a")}),t.note&&(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:["â€¢ ",t.note]})]})]}),!s&&(0,a.jsxs)("div",{className:"flex gap-1 ml-2",children:[a.jsx("button",{onClick:()=>{handleClose(),setTimeout(()=>{o(e,t.id)},300)},className:"p-1.5 bg-blue-100 text-blue-700 rounded active:bg-blue-200 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Edit Payment",children:a.jsx(j.Z,{size:14})}),a.jsx("button",{onClick:async()=>{let r=await C.h.confirm({title:"Remove Payment?",message:"Are you sure you want to remove this payment?",icon:"warning"});r&&(c(e,t.id),y&&await y())},className:"p-1.5 bg-red-100 text-red-700 rounded active:bg-red-200 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Remove Payment",children:a.jsx(x.Z,{size:14})})]})]},t.id)})}),e.weight.toFixed(2),(0,d.formatIndianCurrency)(e.rate),e.originalWeight.toFixed(2),(0,d.formatIndianCurrency)(e.originalRate),(0,d.formatIndianCurrency)(e.originalTotal),(0,d.formatIndianCurrency)(e.additionalCost),e.invoiced?(0,a.jsxs)("span",{className:"flex items-center gap-1 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium",children:[a.jsx(u.Z,{size:12}),"Invoiced"]}):a.jsx("span",{className:"text-xs text-gray-500",children:"Not Invoiced"}),(()=>{let t=e.partialPayments||[],r=t.reduce((e,t)=>e+t.amount,0);return(0,n.sA)(e)?a.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium",children:"Paid"}):r>0?a.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-medium",children:"Partially Paid"}):null})(),x.Z,j.Z,null}function SelectionSheet({isOpen:e,onClose:t,title:r,children:n}){let i=(0,s.useRef)(null),l=(0,s.useRef)(null),[d,o]=(0,s.useState)(!1),[c,m]=(0,s.useState)(!1);(0,s.useEffect)(()=>(e?(document.body.style.overflow="hidden",o(!1),requestAnimationFrame(()=>{m(!0)})):(m(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[e]);let handleClose=()=>{o(!0),m(!1),setTimeout(()=>{t(),o(!1)},300)};return e?(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{ref:l,onClick:e=>{e.target===l.current&&handleClose()},className:`fixed inset-0 bg-black/50 z-[99990] transition-opacity duration-300 ${d||!c?"opacity-0":"opacity-100"}`,style:{WebkitTapHighlightColor:"transparent",backdropFilter:"blur(2px)"}}),(0,a.jsxs)("div",{ref:i,className:`fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-[100000] transition-transform duration-300 ease-out ${d||!c?"translate-y-full":"translate-y-0"}`,style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y",paddingBottom:"env(safe-area-inset-bottom, 0)",backfaceVisibility:"hidden",willChange:"transform",maxHeight:"85vh",display:"flex",flexDirection:"column"},onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"flex justify-center pt-3 pb-2 flex-shrink-0",onClick:handleClose,children:a.jsx("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full"})}),(0,a.jsxs)("div",{className:"px-4 pb-2 flex items-center justify-between flex-shrink-0 border-b border-gray-100",children:[a.jsx("h3",{className:"text-lg font-bold text-gray-900",children:r}),a.jsx("button",{onClick:handleClose,className:"p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition-colors",children:a.jsx(N.Z,{size:20})})]}),a.jsx("div",{className:"overflow-y-auto p-4",children:n})]})]}):null}var O=r(71817);let SupplierDetailPopup_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t};function SupplierDetailPopup({group:e,isOpen:t,onClose:r,onEditOrder:n,onDeleteOrder:i,onOrderClick:l,onRefresh:o}){let[c,x]=(0,s.useState)(!1),[p,y]=(0,s.useState)(!1),[g,b]=(0,s.useState)(!1),j=(0,s.useRef)(null);(0,s.useRef)(null),(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");b(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(t?(x(!1),y(!1),requestAnimationFrame(()=>{y(!0)}),document.body.style.overflow="hidden"):(y(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[t]);let handleClose=()=>{x(!0),y(!1),setTimeout(()=>{r(),x(!1)},250)};if(!t||!e)return null;let v=SupplierDetailPopup_safeParseDate(e.lastPaymentDate);return a.Fragment,h.Z,e.supplierName,N.Z,O.Z,(0,d.formatIndianCurrency)(e.totalAmount),(0,d.formatIndianCurrency)(e.ledgerPayments.reduce((e,t)=>e+Number(t.entry.amount||0),0)),(()=>{let t=e.ledgerPayments.reduce((e,t)=>e+Number(t.entry.amount||0),0),r=e.orders.reduce((t,r)=>{let a=(r.partialPayments||[]).filter(t=>{let r=new Set(e.ledgerPayments.map(e=>e.entry.id).filter(Boolean));return t.ledgerEntryId&&r.has(t.ledgerEntryId)});return t+a.reduce((e,t)=>e+Number(t.amount||0),0)},0),s=t-r;return Math.abs(s)>.01?(0,a.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center text-xs mb-1",children:[a.jsx("span",{className:"text-gray-600",children:"Distributed to Orders:"}),a.jsx("span",{className:"font-semibold text-blue-600",children:(0,d.formatIndianCurrency)(r)})]}),s>0&&(0,a.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[a.jsx("span",{className:"text-gray-600",children:"Undistributed Amount:"}),a.jsx("span",{className:"font-semibold text-orange-600",children:(0,d.formatIndianCurrency)(s)})]}),a.jsx("div",{className:"text-xs text-gray-600 mt-1.5 px-2 py-1 bg-orange-50 rounded",children:s>0?"Not enough unpaid orders to distribute full amount":"Over-distributed - check for errors"})]}):null})(),(0,d.formatIndianCurrency)(e.totalPaid),e.remainingAmount,(0,d.formatIndianCurrency)(Math.abs(e.remainingAmount)),v&&null!==e.lastPaymentAmount&&(f.Z,(0,m.ZP)(v,"dd MMM yyyy"),(0,d.formatIndianCurrency)(e.lastPaymentAmount)),u.Z,e.orders.length,e.orders.map((t,r)=>{let s=SupplierDetailPopup_safeParseDate(t.date),n=Array.isArray(t.material)?t.material:t.material?[t.material]:[],i=Number(t.originalTotal||0),o=t.partialPayments||[],c=o.filter(e=>!e.ledgerEntryId),u=new Set(e.ledgerPayments.map(e=>e.entry.id).filter(Boolean)),x=o.filter(e=>!!e.ledgerEntryId&&u.has(e.ledgerEntryId)),p=x.map(t=>{let r=e.ledgerPayments.find(e=>e.entry.id===t.ledgerEntryId);return{...t,amount:t.amount,ledgerEntry:r?.entry}}),y=o.reduce((e,t)=>e+Number(t.amount||0),0),g=c.reduce((e,t)=>e+Number(t.amount||0),0);p.reduce((e,t)=>e+Number(t.amount||0),0);let h=i-y;return a.jsx("div",{className:"bg-white rounded-lg border border-gray-200 transition-all duration-150 active:bg-gray-50 native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden",animation:`fadeInUp 0.2s ease-out ${.03*r}s both`},onClick:e=>{l&&((0,E.m)(e),handleClose(),setTimeout(()=>l(t),300))},children:(0,a.jsxs)("div",{className:"p-3",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1.5",children:[s&&a.jsx("span",{className:"text-sm font-bold text-gray-900",children:(0,m.ZP)(s,"dd MMM")}),a.jsx("span",{className:"text-xs text-gray-600 truncate",children:t.siteName})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5 flex-wrap",children:[n.slice(0,2).map((e,t)=>a.jsx("span",{className:"bg-primary-50 text-primary-700 px-2 py-0.5 rounded text-xs font-medium",children:e},t)),n.length>2&&(0,a.jsxs)("span",{className:"text-xs text-gray-500",children:["+",n.length-2]})]})]}),a.jsx("div",{className:"text-right ml-3 flex-shrink-0",children:a.jsx("p",{className:"text-base font-bold text-orange-600",children:(0,d.formatIndianCurrency)(i)})})]}),i>0&&(0,a.jsxs)("div",{className:"pt-2 mt-2 border-t border-gray-100",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[a.jsx("span",{className:"text-xs text-gray-600",children:"Raw Material Expense"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(i)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[a.jsx("span",{className:"text-xs text-gray-600",children:"Direct Payments"}),a.jsx("span",{className:`text-sm font-semibold ${g>0?"text-blue-600":"text-gray-500"}`,children:(0,d.formatIndianCurrency)(g)})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[a.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Payment from Ledger"}),a.jsx("span",{className:`text-sm font-bold ${i-g>0?"text-purple-600":"text-gray-500"}`,children:(0,d.formatIndianCurrency)(Math.max(0,i-g))})]}),a.jsx("div",{className:"text-xs text-gray-500 mt-1 px-2 py-1 bg-purple-50 rounded",children:"(Raw Material Expense - Direct Payments)"}),h>0&&(0,a.jsxs)("div",{className:"flex items-center justify-between mt-2 pt-2 border-t border-gray-200",children:[a.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Remaining Unpaid"}),a.jsx("span",{className:"text-sm font-semibold text-red-600",children:(0,d.formatIndianCurrency)(h)})]}),y>0&&(0,a.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-100",children:[a.jsx("div",{className:"text-xs text-gray-500 mb-1.5 font-medium",children:"Payments"}),(0,a.jsxs)("div",{className:"space-y-1",children:[c.map((e,t)=>{let r=SupplierDetailPopup_safeParseDate(e.date);return(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[r&&a.jsx("span",{className:"text-gray-500",children:(0,m.ZP)(r,"dd MMM")}),e.note&&(0,a.jsxs)("span",{className:"truncate",children:["â€¢ ",e.note]}),a.jsx("span",{className:"text-blue-600",children:"Direct"})]}),a.jsx("span",{className:"font-medium text-gray-900 ml-2",children:(0,d.formatIndianCurrency)(e.amount)})]},t)}),p.map((e,t)=>{let r=e.ledgerEntry?.date?SupplierDetailPopup_safeParseDate(e.ledgerEntry.date):SupplierDetailPopup_safeParseDate(e.date),s=e.ledgerEntry?.note||e.note;return(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[r&&a.jsx("span",{className:"text-gray-500",children:(0,m.ZP)(r,"dd MMM")}),s&&(0,a.jsxs)("span",{className:"truncate",children:["â€¢ ",s]}),a.jsx("span",{className:"text-green-600",children:"Ledger"})]}),a.jsx("span",{className:"font-medium text-gray-900 ml-2",children:(0,d.formatIndianCurrency)(e.amount)})]},t)})]})]})]})]})},t.id)}),T.Z,e.ledgerPayments.length,e.ledgerPayments.length>0?a.jsx("div",{className:"space-y-2",children:e.ledgerPayments.map((e,t)=>{let r=SupplierDetailPopup_safeParseDate(e.entry.date);return a.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-3 transition-all duration-200",style:{animation:`fadeInUp 0.3s ease-out ${.05*t}s both`},children:a.jsx("div",{className:"flex justify-between items-start",children:(0,a.jsxs)("div",{className:"flex-1",children:[a.jsx("p",{className:"text-base font-bold text-gray-900",children:(0,d.formatIndianCurrency)(e.entry.amount)}),r&&(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mt-1",children:[a.jsx(f.Z,{size:14,className:"text-gray-400"}),a.jsx("p",{className:"text-xs text-gray-500",children:(0,m.ZP)(r,"dd MMM yyyy")})]}),e.entry.note&&a.jsx("p",{className:"text-xs text-gray-600 mt-1.5",children:e.entry.note})]})})},e.entry.id||t)})}):a.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:a.jsx("p",{className:"text-sm text-gray-500",children:"No payments recorded"})}),null}var M=r(57114),Z=r(9909);let page_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t},safeGetTime=e=>{let t=page_safeParseDate(e);return t?t.getTime():0};function OrdersPage(){let[e,t]=(0,s.useState)([]),[r,v]=(0,s.useState)([]),[w,k]=(0,s.useState)([]),[T,D]=(0,s.useState)([]),[$,O]=(0,s.useState)(!0),[z,R]=(0,s.useState)(!1),[F,_]=(0,s.useState)(null),[L,q]=(0,s.useState)(new Set),[W,U]=(0,s.useState)(!1),[G,H]=(0,s.useState)({}),[B,K]=(0,s.useState)(new Set),[X,V]=(0,s.useState)("allOrders"),[Y,J]=(0,s.useState)(null),[Q,ee]=(0,s.useState)(!1),[et,er]=(0,s.useState)(null),[ea,es]=(0,s.useState)(!1),[en,ei]=(0,s.useState)(null),[el,ed]=(0,s.useState)(!1),[eo,ec]=(0,s.useState)([]),[em,eu]=(0,s.useState)(null),[ex,ep]=(0,s.useState)(!1),[ey,eg]=(0,s.useState)(null),[eh,ef]=(0,s.useState)(null),eb=(0,s.useRef)(null),[ej,eN]=(0,s.useState)(!0),ev=(0,s.useRef)(0),[ew,eP]=(0,s.useState)(new Set),[eC,eI]=(0,s.useState)(new Set),[eS,ek]=(0,s.useState)(null),eT=(0,s.useRef)(null),eE=(0,s.useRef)(null),[eA,eD]=(0,s.useState)(""),[e$,eO]=(0,s.useState)(""),[eM,eZ]=(0,s.useState)(""),[ez,eR]=(0,s.useState)(""),[eF,e_]=(0,s.useState)([]),[eL,eq]=(0,s.useState)(null),eW=(0,M.useSearchParams)(),eU=(0,M.useRouter)();(0,s.useEffect)(()=>{let initializeData=async()=>{O(!0);try{await loadOrders(),await Promise.allSettled([loadInvoices(),loadPartyPayments(),loadPartyNames(),loadLedgerEntries()])}catch(e){console.error("Error initializing data:",e)}finally{O(!1)}};initializeData();let e=Z.ledgerService.subscribe(e=>{ec(e)});return()=>{e()}},[]);let loadLedgerEntries=async()=>{try{let e=await Z.ledgerService.list();ec(e)}catch(e){console.error("Error loading ledger entries:",e)}};(0,s.useEffect)(()=>{if(!eb.current){eN(!0);return}let e=eb.current,t=!1,handleScroll=()=>{t||(window.requestAnimationFrame(()=>{let r=e.scrollTop;r>50&&r>ev.current?eN(!1):eN(!0),ev.current=r,t=!1}),t=!0)};return e.addEventListener("scroll",handleScroll,{passive:!0}),()=>e.removeEventListener("scroll",handleScroll)},[X]),(0,s.useEffect)(()=>{let e=eW.get("highlight");if(e){eq(e),setTimeout(()=>{let t=document.querySelector(`[data-order-id="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100);let t=setTimeout(()=>{eq(null),eU.replace("/orders",{scroll:!1})},1e3);return()=>clearTimeout(t)}},[eW,eU,r]);let loadPartyNames=async()=>{try{let e=await n.XK.getUniquePartyNames();e_(e)}catch(e){console.error("Error loading party names:",e)}},loadOrders=async()=>{try{let e=await n.XK.getAllOrders();t(e)}catch(e){throw console.error("Error loading orders:",e),e}},loadInvoices=async()=>{try{let e=await i.z.getAllInvoices();k(e)}catch(e){console.error("Error loading invoices:",e)}},loadPartyPayments=async()=>{try{let e=await l.s.getAllPayments();D(e)}catch(e){console.error("Error loading party payments:",e)}};(0,s.useEffect)(()=>{let t=[...e];if(ew.size>0)t=t.filter(e=>ew.has(e.partyName?.trim()||""));else if(B.size>0)t=t.filter(e=>{let t=e.partyName?.trim()||"";return B.has(t)});else if(G.partyName){let e=G.partyName.split(",").map(e=>e.trim().toLowerCase());t=t.filter(t=>e.some(e=>t.partyName.toLowerCase()===e))}if(eC.size>0)t=t.filter(e=>{let t=Array.isArray(e.material)?e.material.map(e=>String(e).trim()):[String(e.material||"").trim()].filter(Boolean);return t.some(e=>eC.has(e))});else if(G.material){let e=G.material.split(",").map(e=>e.trim().toLowerCase());t=t.filter(t=>{let r=Array.isArray(t.material)?t.material.map(e=>e.toLowerCase()):[t.material.toLowerCase()];return e.some(e=>r.some(t=>t.includes(e)))})}if(G.startDate){let e=page_safeParseDate(G.startDate);e&&(t=t.filter(t=>{let r=page_safeParseDate(t.date);return r&&r>=e}))}if(G.endDate){let e=page_safeParseDate(G.endDate);e&&(t=t.filter(t=>{let r=page_safeParseDate(t.date);return r&&r<=e}))}let getTime=e=>safeGetTime(e.createdAt||e.updatedAt||e.date);t.sort((e,t)=>getTime(t)-getTime(e)),v(t)},[e,G,B,ew,eC]);let handleSaveOrder=async e=>{console.log("\uD83D\uDCDD handleSaveOrder called",{isEdit:!!F?.id,orderId:F?.id,orderData:e});try{if(F?.id){console.log("\uD83D\uDD04 Updating order:",F.id);let t=F.partialPayments||[],r=e.partialPayments||[];console.log("\uD83D\uDD0D Checking for ledger payment changes:",{oldPayments:t.map(e=>({id:e.id,amount:e.amount,ledgerEntryId:e.ledgerEntryId})),newPayments:r.map(e=>({id:e.id,amount:e.amount,ledgerEntryId:e.ledgerEntryId}))});let a=new Set;if(t.forEach(e=>{if(e.ledgerEntryId){let t=r.find(t=>t.id===e.id);if(t){let r=Math.abs(Number(t.amount)-Number(e.amount))>.01;r?(console.log(`  âœï¸  Ledger payment ${e.id} amount changed: ${e.amount} â†’ ${t.amount} (ledgerEntryId: ${e.ledgerEntryId})`),a.add(e.ledgerEntryId)):console.log(`  â„¹ï¸  Ledger payment ${e.id} modified (date/note only, no redistribution needed)`)}else console.log(`  âŒ Ledger payment ${e.id} was removed (ledgerEntryId: ${e.ledgerEntryId})`),a.add(e.ledgerEntryId)}}),r.forEach(e=>{if(e.ledgerEntryId){let r=t.find(t=>t.id===e.id);r||(console.log(`  âž• New ledger payment ${e.id} added (ledgerEntryId: ${e.ledgerEntryId})`),a.add(e.ledgerEntryId))}}),console.log(`ðŸ“Š Found ${a.size} ledger entry/entries to redistribute:`,Array.from(a)),await n.XK.updateOrder(F.id,e),console.log("âœ… Order updated"),a.size>0){console.log(`ðŸ”„ Redistributing ${a.size} ledger entry/entries`),await new Promise(e=>setTimeout(e,500));let t=Array.from(a);for(let a of t)try{let t=r.find(e=>e.ledgerEntryId===a),s=t?.date||e.date||new Date().toISOString();await redistributeLedgerEntry(a,s),console.log(`âœ… Redistributed ledger entry ${a}`)}catch(e){console.error(`Error redistributing ledger entry ${a}:`,e)}}(0,P.showToast)("Order updated successfully!","success")}else{console.log("âž• Creating new order");let t=await n.XK.createOrder(e);(0,P.showToast)("Order created successfully!","success"),await loadOrders(),_(null),R(!1),eq(t),eU.replace(`/orders?highlight=${t}`,{scroll:!1}),setTimeout(()=>{eq(null),eU.replace("/orders",{scroll:!1})},1e3);return}await loadOrders(),await loadInvoices(),await loadPartyPayments(),_(null),R(!1)}catch(e){throw console.error("Error in handleSaveOrder:",e),e}},getOrderPaymentInfo=e=>{let t=Number(e.originalTotal||0),r=e.partialPayments||[],a=r.reduce((e,t)=>e+t.amount,0);return{expenseAmount:t,totalPaid:a,remainingAmount:t-a}},handleAddPaymentToOrder=async e=>{let{expenseAmount:t,totalPaid:r,remainingAmount:a}=getOrderPaymentInfo(e),s=(0,n.sA)(e);if(s){let e=await C.h.confirm({title:"Order Already Paid",message:`This order is already marked as paid (within â‚¹250 tolerance). Adding more payments may cause overpayment. Continue?`,icon:"warning",confirmText:"Continue",cancelText:"Cancel"});if(!e)return}let i=(e.partialPayments||[]).filter(e=>e.ledgerEntryId),l=i.length>0,o=i.reduce((e,t)=>e+Number(t.amount||0),0);try{let i=l?`Remaining: ${(0,d.formatIndianCurrency)(a)}
Ledger payments: ${(0,d.formatIndianCurrency)(o)}`:`Remaining amount: ${(0,d.formatIndianCurrency)(a)}`,c=await C.h.prompt({title:"Add Payment",message:i,inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Next",cancelText:"Cancel"});if(!c)return;let m=Math.abs(parseFloat(String(c).replace(/,/g,"")));if(!m||Number.isNaN(m)||m<=0){(0,P.showToast)("Invalid amount","error");return}let u=await C.h.prompt({title:"Add Note (optional)",inputLabel:"Note",inputPlaceholder:"e.g. Cash payment / Bank transfer",inputType:"text",required:!1,confirmText:"Next",cancelText:"Skip"}),x=r+m,p=x>t,y=p?x-t:0;if(p&&l){let r=await C.h.confirm({title:"Overpayment Detected",message:`Adding this payment would result in overpayment of ${(0,d.formatIndianCurrency)(y)}.

Total payments: ${(0,d.formatIndianCurrency)(x)}
Original total: ${(0,d.formatIndianCurrency)(t)}
Ledger payments on this order: ${(0,d.formatIndianCurrency)(o)}

Would you like to reduce the ledger payment(s) on this order and redistribute to other unpaid orders of this supplier?`,icon:"question",confirmText:"Reduce & Redistribute",cancelText:"Cancel"});if(!r)return;try{let t=y,r=new Set,a=[...e.partialPayments||[]],s=[];for(let{index:e,payment:n}of(a.forEach((e,t)=>{e.ledgerEntryId&&s.push({index:t,payment:e})}),s.sort((e,t)=>{let r=new Date(e.payment.date).getTime(),a=new Date(t.payment.date).getTime();return a-r}),s)){if(t<=0)break;let s=Number(n.amount||0),i=Math.min(t,s),l=s-i;l>0?a[e]={...n,amount:l}:a.splice(e,1),r.add(n.ledgerEntryId),t-=i,console.log(`  ðŸ”„ Reducing ledger payment ${n.id} by ${i} (from ${s} to ${l})`)}let i=new Date().toISOString(),l={id:Date.now().toString()+Math.random().toString(36).substr(2,9),amount:m,date:i,note:u||void 0};a.push(l),await n.XK.updateOrder(e.id,{partialPayments:a}),console.log(`âœ… Updated order ${e.id} with reduced ledger payments and new direct payment`),await new Promise(e=>setTimeout(e,500));let d=Array.from(r);for(let e of d)try{let t=a.find(t=>t.ledgerEntryId===e),r=t?.date||new Date().toISOString();await redistributeLedgerEntry(e,r),console.log(`âœ… Redistributed ledger entry ${e}`)}catch(t){console.error(`Error redistributing ledger entry ${e}:`,t)}if((0,P.showToast)("Payment added and ledger payments redistributed!","success"),await loadOrders(),Y?.id===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&J(t)}if(em?.id===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&eu(t)}return}catch(e){console.error("Error reducing ledger payments:",e),(0,P.showToast)(e.message||"Failed to reduce ledger payments","error");return}}else if(p&&!l){let e=await C.h.confirm({title:"Overpayment Warning",message:`Adding this payment would result in overpayment of ${(0,d.formatIndianCurrency)(y)}.

Total payments: ${(0,d.formatIndianCurrency)(x)}
Original total: ${(0,d.formatIndianCurrency)(t)}

Continue anyway?`,icon:"warning",confirmText:"Continue",cancelText:"Cancel"});if(!e)return}let g=!1;if(s||p)(s||p&&!l)&&(g=!0);else{let e=r+m,s=e>=t-250;if(s){let e=await C.h.confirm({title:"Add Payment",message:`Payment amount: ${(0,d.formatIndianCurrency)(m)}
Remaining: ${(0,d.formatIndianCurrency)(a)}

This payment will mark the order as paid. Continue?`,icon:"question",confirmText:"Add Payment",cancelText:"Cancel"});if(!e)return;g=!0}}await n.XK.addPaymentToOrder(e.id,m,u||void 0,g),(0,P.showToast)("Payment added successfully!","success"),await new Promise(e=>setTimeout(e,500)),await loadOrders();let h=await n.XK.getOrderById(e.id);if(h&&console.log("Order after payment:",{id:h.id,partialPayments:h.partialPayments}),Y?.id===e.id){let t=await n.XK.getOrderById(e.id);t&&J(t)}if(em?.id===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&eu(t)}}catch(e){console.error("Error adding payment:",e),(0,P.showToast)(e.message||"Failed to add payment","error")}},handleEditPayment=(e,t)=>{let r=e.partialPayments?.find(e=>e.id===t);r?.ledgerEntryId||eg({order:e,paymentId:t})},handleSavePaymentEdit=async e=>{if(ey&&ey.order.id)try{let t=ey.order.partialPayments?.find(e=>e.id===ey.paymentId),r=!!t?.ledgerEntryId,a=!!r&&!!t&&Math.abs(Number(e.amount)-Number(t.amount))>.01;if(await n.XK.updatePartialPayment(ey.order.id,ey.paymentId,e,t?.ledgerEntryId),r&&t.ledgerEntryId&&a&&await redistributeLedgerEntry(t.ledgerEntryId,e.date),await loadOrders(),em?.id===ey.order.id&&ey.order.id){let e=await n.XK.getOrderById(ey.order.id);e&&eu(e)}if(Y?.id===ey.order.id&&ey.order.id){let e=await n.XK.getOrderById(ey.order.id);e&&J(e)}eg(null)}catch(e){console.error("Failed to update payment:",e),(0,P.showToast)(e.message||"Failed to update payment","error"),eg(null)}},redistributeLedgerEntry=async(e,t)=>{try{console.log(`ðŸ”„ Redistributing ledger entry ${e} (date: ${t})`);let r=await Z.ledgerService.getEntryById(e);if(!r){console.warn(`âŒ Ledger entry ${e} not found`);return}if("debit"!==r.type||!r.supplier){console.warn(`âŒ Ledger entry is not an expense with supplier (type: ${r.type}, supplier: ${r.supplier})`);return}console.log("Redistribution is handled server-side by orderService.redistributeSupplierPayment; skipping duplicate client distribution.")}catch(e){throw console.error("âŒ Error redistributing ledger entry:",e),e}},handleRemovePayment=async(e,t)=>{if(!e.id)return;let r=e.partialPayments?.find(e=>e.id===t),a=!!r?.ledgerEntryId;try{let s=await C.h.confirm({title:"Remove Payment?",message:a?"This payment is from a ledger entry. Removing it will trigger redistribution of the ledger entry. Continue?":"Are you sure you want to remove this payment? This action cannot be undone.",icon:"warning",confirmText:"Remove",cancelText:"Cancel"});if(!s)return;if(await n.XK.removePartialPayment(e.id,t),a&&r.ledgerEntryId)try{let t=e.date||new Date().toISOString();await redistributeLedgerEntry(r.ledgerEntryId,t),(0,P.showToast)("Payment removed and ledger entry redistributed!","success")}catch(e){console.error("Error redistributing ledger entry:",e),(0,P.showToast)("Payment removed, but redistribution failed","error")}else(0,P.showToast)("Payment removed successfully!","success");if(await loadOrders(),em?.id===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&eu(t)}if(Y?.id===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&J(t)}}catch(e){e?.message&&!e.message.includes("SweetAlert")&&(0,P.showToast)(`Failed to remove payment: ${e?.message||"Unknown error"}`,"error")}},handleDeleteOrder=async e=>{try{console.log("Delete button clicked for order:",e);let t=await C.h.confirm({title:"Delete Order?",message:"Are you sure you want to delete this order? This action cannot be undone.",icon:"warning",confirmText:"Delete",cancelText:"Cancel"});console.log("SweetAlert confirmed:",t),t&&(await n.XK.deleteOrder(e),(0,P.showToast)("Order deleted successfully!","success"),await loadOrders(),await loadInvoices(),await loadPartyPayments())}catch(e){console.error("Error deleting order:",e),e?.message&&!e.message.includes("SweetAlert")&&(0,P.showToast)(`Failed to delete order: ${e?.message||"Unknown error"}`,"error")}},toggleOrderSelection=e=>{let t=new Set(L);t.has(e)?t.delete(e):t.add(e),q(t)},getUniqueMaterials=()=>{let t=new Set;return e.forEach(e=>{if(Array.isArray(e.material))e.material.forEach(e=>{let r=String(e||"").trim();r&&t.add(r)});else if(e.material){let r=String(e.material).trim();r&&t.add(r)}}),Array.from(t).sort()},clearPartyFilter=()=>{eP(new Set),ek(null)},clearMaterialFilter=()=>{eI(new Set),ek(null)},handleBulkDelete=async()=>{if(0!==L.size)try{let e=await C.h.confirm({title:"Delete Selected Orders?",message:`Are you sure you want to delete ${L.size} order(s)? This action cannot be undone.`,icon:"warning",confirmText:"Delete",cancelText:"Cancel"});if(!e)return;let t=Array.from(L),r=0,a=0;for(let e of t)try{await n.XK.deleteOrder(e),r++}catch(t){console.error(`Failed to delete order ${e}:`,t),a++}r>0?((0,P.showToast)(`Successfully deleted ${r} order(s)${a>0?`. ${a} failed.`:""}`,"success"),q(new Set),await loadOrders(),await loadInvoices(),await loadPartyPayments()):(0,P.showToast)("Failed to delete orders.","error")}catch(e){e?.message&&!e.message.includes("SweetAlert")&&(0,P.showToast)(`Failed to delete orders: ${e?.message||"Unknown error"}`,"error")}},handleBulkCreateInvoice=async()=>{if(0===L.size)return;let e=Array.from(L),t=r.filter(t=>e.includes(t.id)&&!t.invoiced);if(0===t.length){(0,P.showToast)("All selected orders already have invoices","info");return}if(t.length<e.length){let r=e.length-t.length;try{let e=await C.h.confirm({title:"Some Orders Already Invoiced",message:`${r} order(s) already have invoices. Create invoice for ${t.length} order(s) only?`,icon:"info",confirmText:"Create Invoice",cancelText:"Cancel"});if(!e)return}catch(e){e?.message&&e.message.includes("SweetAlert");return}}try{let e=t.map(e=>e.id);(0,P.showToast)("Creating invoice...","info"),await i.z.createInvoice(e),(0,P.showToast)(`Invoice created successfully for ${t.length} order(s)!`,"success"),q(new Set),await loadOrders(),await loadInvoices(),await loadPartyPayments()}catch(e){(0,P.showToast)(`Failed to create invoice: ${e?.message||"Unknown error"}`,"error")}},applyFilterForm=()=>{let e={};eA&&(e.partyName=eA),e$&&(e.material=e$),eM&&(e.startDate=eM),ez&&(e.endDate=ez),H(e),eA&&K(new Set),U(!1)},resetFilters=()=>{eD(""),eO(""),eZ(""),eR(""),H({}),K(new Set),U(!1)},handlePartyGroupClick=e=>{er(e),es(!0)},getPartyGroups=()=>{let e=new Map;r.forEach(t=>{let r=t.partyName;e.has(r)||e.set(r,[]),e.get(r).push(t)});let t=[];return e.forEach((e,r)=>{let a=e.reduce((e,t)=>e+t.total,0),s=e.reduce((e,t)=>e+(0,A.I)(t),0),n=T.filter(e=>e.partyName===r),i=[],l=0,d=null,o=null;n.forEach(e=>{i.push({invoiceId:"",invoiceNumber:"",payment:{id:e.id,amount:e.amount,date:e.date,...e.note?{note:e.note}:{}},ledgerEntryId:e.ledgerEntryId}),l+=e.amount;let t=page_safeParseDate(e.date);if(t){let r=page_safeParseDate(d);(!r||t>r)&&(d=e.date,o=e.amount)}}),i.sort((e,t)=>safeGetTime(t.payment.date)-safeGetTime(e.payment.date)),t.push({partyName:r,totalSelling:a,totalPaid:l,totalProfit:s,lastPaymentDate:d,lastPaymentAmount:o,orders:e.sort((e,t)=>{let r=safeGetTime(e.createdAt||e.updatedAt||e.date),a=safeGetTime(t.createdAt||t.updatedAt||t.date);return a-r}),payments:i})}),t.sort((e,t)=>e.partyName.localeCompare(t.partyName))},getSupplierGroups=()=>{let e=new Map;r.forEach(t=>{let r=t.supplier;r&&""!==r.trim()&&(e.has(r)||e.set(r,[]),e.get(r).push(t))});let t=[];return e.forEach((e,r)=>{let a=0,s=0,n=0,i=0;e.forEach(e=>{let t=Number(e.originalTotal||0),r=e.partialPayments||[],l=r.filter(e=>!e.ledgerEntryId),d=l.reduce((e,t)=>e+Number(t.amount||0),0),o=r.filter(e=>e.ledgerEntryId),c=o.reduce((e,t)=>e+Number(t.amount||0),0);a+=Math.max(0,t-d),s+=r.reduce((e,t)=>e+Number(t.amount||0),0),n+=d,i+=c});let l=eo.filter(e=>"debit"===e.type&&e.supplier===r),d=l.reduce((e,t)=>e+Number(t.amount||0),0),o=Math.max(0,a-d),c=new Set(l.map(e=>e.id).filter(Boolean)),m=0;e.forEach(e=>{let t=e.partialPayments||[];t.forEach(e=>{e.ledgerEntryId&&c.has(e.ledgerEntryId)&&(m+=e.amount)})});let u=l.reduce((e,t)=>e+Number(t.amount||0),0);Math.abs(u-m)>.01&&console.warn(`âš ï¸ Supplier ${r}: Ledger entry total (${u}) doesn't match partial payments with ledgerEntryId (${m})`);let x=n+i;Math.abs(s-x)>.01&&console.warn(`âš ï¸ Supplier ${r}: Payment totals mismatch! totalPaid (${s}) != direct (${n}) + supplier (${i}) = ${x}`);let p=a-i;Math.abs(o-p)>.01&&console.warn(`âš ï¸ Supplier ${r}: Remaining amount mismatch! remainingAmount (${o}) != totalAmount (${a}) - supplier payments (${i}) = ${p}`);let y=null,g=null;e.forEach(e=>{let t=e.partialPayments||[];t.forEach(e=>{let t=page_safeParseDate(e.date);if(t){let r=page_safeParseDate(y);(!r||t>r)&&(y=e.date,g=e.amount)}})}),l.forEach(e=>{let t=page_safeParseDate(e.date);if(t){let r=page_safeParseDate(y);(!r||t>r)&&(y=e.date,g=e.amount)}});let h=l.map(e=>({entry:e})).sort((e,t)=>safeGetTime(t.entry.date)-safeGetTime(e.entry.date));t.push({supplierName:r,totalAmount:a,totalPaid:s,remainingAmount:o,lastPaymentDate:y,lastPaymentAmount:g,orders:e.sort((e,t)=>{let r=safeGetTime(e.createdAt||e.updatedAt||e.date),a=safeGetTime(t.createdAt||t.updatedAt||t.date);return a-r}),ledgerPayments:h})}),t.sort((e,t)=>{let r=safeGetTime(e.lastPaymentDate),a=safeGetTime(t.lastPaymentDate);return a-r})},handleSupplierGroupClick=e=>{ei(e),ed(!0)};return(0,a.jsxs)("div",{className:"bg-gray-50",style:{height:"100dvh",minHeight:"100dvh",display:"flex",flexDirection:"column",overflow:"hidden"},children:[a.jsx(I.Z,{isOpen:W,onClose:()=>U(!1),title:"Filters",children:(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Party Name"}),a.jsx("div",{className:"grid grid-cols-2 gap-1.5 p-2 border border-gray-300 rounded-lg bg-gray-50 max-h-48 overflow-y-auto",children:eF.map(e=>(0,a.jsxs)("label",{className:"flex items-center space-x-1.5 cursor-pointer hover:bg-gray-100 p-1.5 rounded transition-colors",children:[a.jsx("input",{type:"checkbox",checked:eA.split(",").includes(e),onChange:t=>{let r=eA.split(",").filter(e=>e.trim());eD((t.target.checked?[...r,e]:r.filter(t=>t!==e)).join(","))},className:"custom-checkbox"}),a.jsx("span",{className:"text-xs text-gray-700",children:e})]},e))})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Material"}),a.jsx("div",{className:"grid grid-cols-2 gap-1.5 p-2 border border-gray-300 rounded-lg bg-gray-50 max-h-48 overflow-y-auto",children:["Bodeli","Panetha","Nareshware","Kali","Chikhli Kapchi VSI","Chikhli Kapchi","Areth"].map(e=>(0,a.jsxs)("label",{className:"flex items-center space-x-1.5 cursor-pointer hover:bg-gray-100 p-1.5 rounded transition-colors",children:[a.jsx("input",{type:"checkbox",checked:e$.split(",").includes(e),onChange:t=>{let r=e$.split(",").filter(e=>e.trim());eO((t.target.checked?[...r,e]:r.filter(t=>t!==e)).join(","))},className:"custom-checkbox"}),a.jsx("span",{className:"text-xs text-gray-700",children:e})]},e))})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Start Date"}),a.jsx("input",{type:"date",value:eM,onChange:e=>eZ(e.target.value),className:"w-full p-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"End Date"}),a.jsx("input",{type:"date",value:ez,onChange:e=>eR(e.target.value),className:"w-full p-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 pt-2 border-t border-gray-200 sticky bottom-0 bg-white pb-2",children:[a.jsx("button",{onClick:()=>{applyFilterForm(),U(!1)},className:"flex-1 bg-primary-600 text-white px-3 py-2 rounded-lg text-xs font-medium hover:bg-primary-700 transition-colors",children:"Apply"}),a.jsx("button",{onClick:()=>{resetFilters(),U(!1)},className:"flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium hover:bg-gray-300 transition-colors",children:"Reset"})]})]})}),a.jsx("div",{className:"fixed left-0 right-0 z-[45] flex items-end justify-center",style:{bottom:L.size>0?"9.75rem":"5.25rem",paddingLeft:"max(0.75rem, env(safe-area-inset-left, 0px))",paddingRight:"max(0.75rem, env(safe-area-inset-right, 0px))",pointerEvents:"none",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)",transform:ej?"translateY(0)":"translateY(calc(100% + 1rem))",opacity:ej?1:0},children:(0,a.jsxs)("div",{className:"bg-white/95 backdrop-blur-xl border border-gray-200/60 rounded-2xl flex gap-2 w-full",style:{padding:"0.5rem",boxShadow:"0 2px 16px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.03)",pointerEvents:ej?"auto":"none"},children:[a.jsx("button",{onClick:e=>{(0,E.m)(e),V("allOrders")},className:`flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ${"allOrders"===X?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"}`,style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"All Orders"}),a.jsx("button",{onClick:e=>{(0,E.m)(e),V("byParty")},className:`flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ${"byParty"===X?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"}`,style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"By Party"}),a.jsx("button",{onClick:e=>{(0,E.m)(e),V("suppliers")},className:`flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ${"suppliers"===X?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"}`,style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"Suppliers"})]})}),L.size>0&&a.jsx("div",{className:"fixed left-0 right-0 z-[44] flex items-end justify-center",style:{bottom:"5.25rem",paddingLeft:"max(0.75rem, env(safe-area-inset-left, 0px))",paddingRight:"max(0.75rem, env(safe-area-inset-right, 0px))",pointerEvents:"none"},children:a.jsx("div",{className:"bg-white/95 backdrop-blur-xl border border-gray-200/60 rounded-2xl w-full",style:{padding:"0.75rem",boxShadow:"0 2px 16px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.03)",pointerEvents:"auto"},children:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("button",{onClick:e=>{(0,E.m)(e),handleBulkCreateInvoice()},className:"flex-1 bg-green-600 text-white px-3 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-1.5 active:bg-green-700 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:[a.jsx(u.Z,{size:18}),(0,a.jsxs)("span",{children:["Create Invoice (",L.size,")"]})]}),(0,a.jsxs)("button",{onClick:e=>{(0,E.m)(e),handleBulkDelete()},className:"flex-1 bg-red-600 text-white px-3 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-1.5 active:bg-red-700 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:[a.jsx(x.Z,{size:18}),(0,a.jsxs)("span",{children:["Delete (",L.size,")"]})]}),a.jsx("button",{onClick:e=>{(0,E.m)(e),q(new Set)},className:"px-4 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-medium active:bg-gray-300 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"Clear"})]})})}),(0,a.jsxs)("div",{ref:eb,onClick:e=>{null===e.target.closest("[data-order-id]")&&null===e.target.closest("button")&&ef(null)},style:{flex:1,overflowY:"auto",overflowX:"allOrders"===X?"auto":"visible",WebkitOverflowScrolling:"touch",paddingBottom:L.size>0?"16rem":"9rem"},children:[$?a.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-30 bg-gray-50",children:a.jsx(S.Z,{size:100})}):0===r.length?a.jsx("div",{className:"p-2.5 text-center text-sm text-gray-500",children:"No orders found"}):"byParty"===X?a.jsx("div",{className:"p-2 space-y-2",children:getPartyGroups().map((e,t)=>{let r=e.totalSelling-e.totalPaid,s=page_safeParseDate(e.lastPaymentDate);return e.totalSelling>0&&(e.totalPaid,e.totalSelling),a.jsx("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden transition-all duration-200 hover:border-primary-300 active:scale-[0.99] native-press",style:{animation:`fadeInUp 0.3s ease-out ${.04*t}s both`,WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},onClick:t=>{t.target.closest("button")||((0,E.m)(t),handlePartyGroupClick(e))},children:(0,a.jsxs)("div",{className:"p-2.5",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-0.5",children:[a.jsx(p.Z,{size:13,className:"text-primary-600 flex-shrink-0"}),a.jsx("h3",{className:"font-bold text-sm text-gray-900 truncate",children:e.partyName})]}),e.orders.length>0&&e.orders[0].siteName&&a.jsx("p",{className:"text-[10px] text-gray-500 truncate ml-4.5",children:e.orders[0].siteName})]}),a.jsx("button",{onClick:async t=>{t.stopPropagation(),(0,E.m)(t);let r=e.totalSelling-e.totalPaid;try{let t=await C.h.prompt({title:"Add Payment",message:`Remaining balance: ${(0,d.formatIndianCurrency)(r)}`,inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Add Payment",cancelText:"Cancel"});if(!t)return;let a=Math.abs(parseFloat(String(t).replace(/,/g,"")));if(isNaN(a)||a<=0){(0,P.showToast)("Invalid amount","error");return}let s=await C.h.prompt({title:"Payment Note (optional)",inputLabel:"Note",inputPlaceholder:"Add a note (optional)",inputType:"text",required:!1,confirmText:"Save",cancelText:"Skip"});await l.s.addPayment(e.partyName,a,s||void 0),(0,P.showToast)("Payment added successfully!","success"),await Promise.all([loadPartyPayments(),loadOrders()])}catch(e){e?.message&&!e.message.includes("SweetAlert")&&(0,P.showToast)(`Failed to add payment: ${e?.message||"Unknown error"}`,"error")}},className:"p-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 active:bg-primary-800 transition-all native-press flex items-center justify-center flex-shrink-0",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:a.jsx(y.Z,{size:16})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2 flex-wrap gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[10px] text-gray-600",children:"Total:"}),a.jsx("span",{className:"text-xs font-bold text-primary-700",children:(0,d.formatIndianCurrency)(e.totalSelling)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[10px] text-gray-600",children:"Profit:"}),a.jsx("span",{className:`text-xs font-bold ${e.totalProfit>=0?"text-green-600":"text-red-600"}`,children:(0,d.formatIndianCurrency)(e.totalProfit)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[10px] text-gray-600",children:"Receive:"}),a.jsx("span",{className:"text-xs font-bold text-green-600",children:(0,d.formatIndianCurrency)(e.totalPaid)})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"text-[10px] text-gray-600",children:"Due:"}),a.jsx("span",{className:`text-xs font-bold ${r>0?"text-red-600":"text-green-600"}`,children:(0,d.formatIndianCurrency)(Math.abs(r))})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between pt-1.5 border-t border-gray-100",children:[s&&null!==e.lastPaymentAmount?(0,a.jsxs)("span",{className:"text-[10px] text-gray-500",children:[(0,m.ZP)(s,"dd MMM")," â€¢ ",(0,d.formatIndianCurrency)(e.lastPaymentAmount)]}):a.jsx("span",{className:"text-[10px] text-gray-400",children:"No payments"}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsxs)("span",{className:"text-[10px] text-gray-500",children:[e.orders.length," order",1!==e.orders.length?"s":""]}),a.jsx(g.Z,{size:11,className:"text-gray-400"})]})]})]})},e.partyName)})}):"suppliers"===X?(0,a.jsxs)("div",{className:"p-3",children:[a.jsx("div",{className:"grid grid-cols-2 gap-3",children:getSupplierGroups().map((e,t)=>{let r=page_safeParseDate(e.lastPaymentDate),s=e.totalAmount>0?e.totalPaid/e.totalAmount*100:0;return(0,a.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden transition-all duration-200 hover:border-orange-400 hover:shadow-md active:scale-[0.98] native-press group",style:{animation:`fadeInUp 0.3s ease-out ${.03*t}s both`,WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},onClick:t=>{t.target.closest("button")||((0,E.m)(t),handleSupplierGroupClick(e))},children:[a.jsx("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 px-3 py-2.5 border-b border-orange-200/50",children:(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[a.jsx("div",{className:"p-1.5 bg-orange-500 rounded-lg shadow-sm group-hover:scale-110 transition-transform duration-200",children:a.jsx(h.Z,{size:14,className:"text-white"})}),a.jsx("h3",{className:"font-bold text-sm text-gray-900 truncate leading-tight",children:e.supplierName})]}),a.jsx(g.Z,{size:16,className:"text-orange-500 flex-shrink-0 ml-1 group-hover:translate-x-0.5 transition-transform duration-200"})]})}),(0,a.jsxs)("div",{className:"p-3",children:[(0,a.jsxs)("div",{className:"space-y-2 mb-3",children:[(0,a.jsxs)("div",{className:"bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-2 border border-gray-200/50",children:[a.jsx("div",{className:"text-[10px] text-gray-600 mb-0.5 font-medium",children:"Total Amount"}),a.jsx("div",{className:"text-sm font-bold text-gray-900 truncate",children:(0,d.formatIndianCurrency)(e.totalAmount)})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,a.jsxs)("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-2 border border-green-200/50",children:[a.jsx("div",{className:"text-[10px] text-green-700 mb-0.5 font-medium",children:"Paid"}),a.jsx("div",{className:"text-xs font-bold text-green-700 truncate",children:(0,d.formatIndianCurrency)(e.totalPaid)})]}),(0,a.jsxs)("div",{className:`rounded-lg p-2 border ${e.remainingAmount>0?"bg-gradient-to-br from-red-50 to-red-100 border-red-200/50":"bg-gradient-to-br from-green-50 to-green-100 border-green-200/50"}`,children:[a.jsx("div",{className:`text-[10px] mb-0.5 font-medium ${e.remainingAmount>0?"text-red-700":"text-green-700"}`,children:"Remaining"}),a.jsx("div",{className:`text-xs font-bold truncate ${e.remainingAmount>0?"text-red-700":"text-green-700"}`,children:(0,d.formatIndianCurrency)(Math.abs(e.remainingAmount))})]})]})]}),e.totalAmount>0&&(0,a.jsxs)("div",{className:"mb-3",children:[a.jsx("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden shadow-inner",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-700 ease-out shadow-sm",style:{width:`${Math.min(100,s)}%`}})}),(0,a.jsxs)("div",{className:"text-[9px] text-gray-500 mt-1 text-center font-medium",children:[s.toFixed(1),"% Paid"]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-600 font-medium",children:[e.orders.length," ",1===e.orders.length?"Order":"Orders"]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),(0,a.jsxs)("span",{className:"text-[10px] text-gray-600 font-medium",children:[e.ledgerPayments.length," ",1===e.ledgerPayments.length?"Payment":"Payments"]})]})]}),r&&null!==e.lastPaymentAmount&&a.jsx("div",{className:"mt-2 pt-2 border-t border-gray-100",children:(0,a.jsxs)("div",{className:"flex items-center gap-1.5 text-[10px]",children:[a.jsx(f.Z,{size:10,className:"text-gray-400"}),a.jsx("span",{className:"text-gray-600 font-medium",children:"Last:"}),a.jsx("span",{className:"text-gray-700 font-semibold",children:(0,m.ZP)(r,"dd MMM")}),a.jsx("span",{className:"text-gray-500",children:"â€¢"}),a.jsx("span",{className:"text-gray-700 font-semibold",children:(0,d.formatIndianCurrency)(e.lastPaymentAmount)})]})})]})]},e.supplierName)})}),0===getSupplierGroups().length&&(0,a.jsxs)("div",{className:"col-span-2 p-8 text-center",children:[a.jsx(h.Z,{size:48,className:"mx-auto mb-3 text-gray-300"}),a.jsx("p",{className:"text-sm font-medium text-gray-500",children:"No suppliers found"}),a.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Suppliers will appear here when you create orders"})]})]}):(0,a.jsxs)("div",{className:"inline-block min-w-full",style:{paddingTop:"0.5rem"},children:[r.length>0&&(0,a.jsxs)("div",{className:"sticky top-0 z-30 shadow-sm bg-white min-w-max",children:[a.jsx("div",{ref:eT,className:"bg-white border-b border-gray-100 px-2 py-2 flex items-center justify-between sticky left-0 z-40 w-screen max-w-[100%]",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:[a.jsx("input",{type:"checkbox",checked:r.length>0&&r.every(e=>L.has(e.id)),onChange:e=>{if(e.target.checked){let e=new Set(r.map(e=>e.id));q(e)}else q(new Set)},className:"custom-checkbox",style:{width:"22px",height:"22px"},onClick:e=>e.stopPropagation()}),(0,a.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Select All (",r.length,")"]})]})}),a.jsx("div",{ref:eE,className:"bg-gray-50 min-w-max",children:(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("div",{className:"w-12 px-1 py-1.5 flex-shrink-0"}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Date"})}),a.jsx("div",{className:"w-28 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer",onClick:e=>{e.stopPropagation(),ek("party")},children:[a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Party/Site"}),a.jsx("div",{className:`p-0.5 hover:bg-gray-200 rounded transition-colors ${ew.size>0?"text-primary-600":"text-gray-400"}`,children:a.jsx(b.Z,{size:10})}),ew.size>0&&(0,a.jsxs)("span",{className:"text-[9px] text-primary-600 font-bold",children:["(",ew.size,")"]})]})}),a.jsx("div",{className:"w-28 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,a.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer",onClick:e=>{e.stopPropagation(),ek("material")},children:[a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Material"}),a.jsx("div",{className:`p-0.5 hover:bg-gray-200 rounded transition-colors ${eC.size>0?"text-primary-600":"text-gray-400"}`,children:a.jsx(b.Z,{size:10})}),eC.size>0&&(0,a.jsxs)("span",{className:"text-[9px] text-primary-600 font-bold",children:["(",eC.size,")"]})]})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Wt/Rate"})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Total"})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Truck"})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Orig Wt/Rate"})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Orig Total"})}),a.jsx("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Add/Profit"})}),a.jsx("div",{className:"w-36 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:a.jsx("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Actions"})})]})}),a.jsx("div",{className:"bg-primary-600 text-white border-t border-primary-700 border-b border-primary-500 min-w-max",children:(0,a.jsxs)("div",{className:"flex items-center",children:[a.jsx("div",{className:"w-12 px-1 py-0.5 flex-shrink-0"}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:a.jsx("span",{className:"text-[9px] font-bold uppercase",children:"Total"})}),a.jsx("div",{className:"w-28 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),a.jsx("div",{className:"w-28 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:a.jsx("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(r.reduce((e,t)=>e+t.total,0))})}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:a.jsx("div",{className:"text-[9px] font-bold",children:r.reduce((e,t)=>e+t.originalWeight,0).toLocaleString("en-IN")})}),a.jsx("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:a.jsx("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(r.reduce((e,t)=>e+t.originalTotal,0))})}),(0,a.jsxs)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:[a.jsx("div",{className:"text-[9px] font-bold",children:(0,d.formatIndianCurrency)(r.reduce((e,t)=>e+t.additionalCost,0))}),a.jsx("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(r.reduce((e,t)=>e+t.profit,0))})]}),a.jsx("div",{className:"w-36 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"})]})})]}),a.jsx("div",{className:"divide-y divide-gray-100 min-w-max",children:r.map((e,t)=>{let r=page_safeParseDate(e.date),s=Array.isArray(e.material)?e.material:e.material?[e.material]:[],i=e.partialPayments||[],l=i.reduce((e,t)=>e+t.amount,0),o=e.customerPayments||[],c=o.reduce((e,t)=>e+t.amount,0);e.originalTotal;let x=(0,n.sA)(e),p=(0,n.jX)(e);return a.jsx("div",{"data-order-id":e.id,className:"border-b border-gray-100",children:(0,a.jsxs)("div",{onClick:t=>{t.target.closest("button")||t.target.closest('input[type="checkbox"]')||ef(e.id||null)},className:`flex items-center touch-manipulation transition-colors ${eh===e.id?"bg-yellow-100":L.has(e.id)?"bg-primary-50":x?"bg-green-50/30":"bg-white"}`,style:{WebkitTapHighlightColor:"transparent",animation:`fadeInUp 0.2s ease-out ${.02*t}s both`,position:"relative",overflow:"hidden",minHeight:"2rem",lineHeight:"1rem"},children:[a.jsx("div",{className:"w-12 px-1 py-1 flex-shrink-0 flex items-center justify-center border-r border-gray-100",children:a.jsx("input",{type:"checkbox",checked:L.has(e.id),onChange:t=>{t.stopPropagation(),toggleOrderSelection(e.id)},className:"custom-checkbox",style:{width:"18px",height:"18px"},onClick:e=>e.stopPropagation()})}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"text-gray-600 text-[10px] leading-tight font-medium",children:r?(0,m.ZP)(r,"dd MMM"):"N/A"}),e.invoiced&&a.jsx(u.Z,{size:10,className:"text-blue-600 mt-0.5"})]}),(0,a.jsxs)("div",{className:"w-28 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"font-semibold text-gray-900 truncate text-[11px] leading-tight",children:e.partyName}),e.siteName&&a.jsx("div",{className:"text-[9px] text-gray-500 truncate",children:e.siteName})]}),a.jsx("div",{className:"w-28 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:(0,a.jsxs)("div",{className:"flex flex-wrap gap-0.5",children:[s.slice(0,2).map((e,t)=>a.jsx("span",{className:"bg-primary-50 text-primary-700 px-1 py-0.5 rounded text-[9px] font-medium whitespace-nowrap",title:e,children:e},t)),s.length>2&&(0,a.jsxs)("span",{className:"text-[9px] text-gray-500",children:["+",s.length-2]})]})}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"text-gray-700 text-[10px] leading-tight",children:e.weight.toLocaleString("en-IN")}),a.jsx("div",{className:"text-gray-700 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.rate)})]}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"font-bold text-primary-600 text-[11px] leading-tight",children:(0,d.formatIndianCurrency)(e.total)}),a.jsx("div",{className:"text-[10px] text-green-600 font-semibold leading-tight",children:(0,d.formatIndianCurrency)(c)})]}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"text-gray-700 text-[10px] leading-tight truncate font-semibold",children:e.truckOwner}),e.truckNo&&a.jsx("div",{className:"text-gray-700 text-[9px] leading-tight truncate",children:e.truckNo}),e.supplier&&a.jsx("div",{className:"text-orange-600 text-[9px] leading-tight truncate",children:e.supplier})]}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"text-gray-700 text-[10px] leading-tight",children:e.originalWeight.toLocaleString("en-IN")}),a.jsx("div",{className:"text-gray-700 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.originalRate)})]}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"font-semibold text-gray-800 text-[11px] leading-tight",children:(0,d.formatIndianCurrency)(e.originalTotal)}),a.jsx("div",{className:"text-[10px] text-green-600 font-semibold leading-tight",children:(0,d.formatIndianCurrency)(l)}),x&&a.jsx("span",{className:"bg-green-500 text-white px-1 py-0.5 rounded text-[8px] font-bold",children:"PAID"}),p&&a.jsx("span",{className:"bg-blue-500 text-white px-1 py-0.5 rounded text-[8px] font-bold ml-1",children:"PARTY PAID"})]}),(0,a.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[a.jsx("div",{className:"text-blue-600 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.additionalCost)}),(()=>{let t=Number(e.expenseAdjustment||0),r=Number(e.revenueAdjustment||0),s=Number(e.adjustmentAmount||0),n=e.profit+t+r+s,i=Math.abs(n-e.profit)>.01,l=(e.customerPayments||[]).reduce((e,t)=>e+t.amount,0),o=(e.partialPayments||[]).reduce((e,t)=>e+t.amount,0);if(p&&x){let t=l-o-e.additionalCost+s;return(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"font-semibold text-[11px] leading-tight text-gray-500 line-through opacity-60",children:(0,d.formatIndianCurrency)(e.profit)}),a.jsx("div",{className:`font-bold text-[11px] leading-tight ${t>=0?"text-green-700":"text-red-700"}`,children:(0,d.formatIndianCurrency)(t)})]})}return p&&i?(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"font-semibold text-[11px] leading-tight text-gray-500 line-through opacity-60",children:(0,d.formatIndianCurrency)(e.profit)}),a.jsx("div",{className:`font-bold text-[11px] leading-tight ${n>=0?"text-green-700":"text-red-700"}`,children:(0,d.formatIndianCurrency)(n)})]}):a.jsx("div",{className:`font-semibold text-[11px] leading-tight ${e.profit>=0?"text-green-600":"text-red-600"}`,children:(0,d.formatIndianCurrency)(e.profit)})})()]}),(0,a.jsxs)("div",{className:"w-36 px-1 py-1 flex-shrink-0 flex items-center gap-2 justify-center",children:[a.jsx("button",{onClick:t=>{t.stopPropagation(),J(e),ee(!0)},className:"p-2 text-gray-600 hover:text-primary-600 transition-colors rounded-full hover:bg-primary-50 bg-white border border-gray-200 shadow-sm active:scale-95",title:"View",children:a.jsx(u.Z,{size:18})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),_(e),R(!0)},className:"p-2 text-gray-600 hover:text-primary-600 transition-colors rounded-full hover:bg-primary-50 bg-white border border-gray-200 shadow-sm active:scale-95",title:"Edit",children:a.jsx(j.Z,{size:18})})]})]})},e.id)})})]}),z&&a.jsx(c.Z,{order:F,onClose:()=>{R(!1),_(null)},onSave:handleSaveOrder}),a.jsx(OrderDetailPopup,{order:Y,isOpen:Q,onClose:()=>{ee(!1),J(null)},onEdit:e=>{_(e),ee(!1),R(!0)},onDelete:handleDeleteOrder,onEditPayment:handleEditPayment,onRemovePayment:handleRemovePayment,onOrderUpdated:async()=>{if(await loadOrders(),Y?.id){let e=await n.XK.getOrderById(Y.id);e&&J(e)}}}),a.jsx(PartyDetailPopup,{group:et,isOpen:ea,onClose:()=>{es(!1),er(null)},onEditOrder:e=>{_(e),R(!0)},onDeleteOrder:handleDeleteOrder,onOrderClick:e=>{J(e),ee(!0)},onPaymentAdded:async()=>{if(await loadPartyPayments(),await loadOrders(),et?.partyName){let e=getPartyGroups().find(e=>e.partyName===et.partyName);e&&er(e)}},onPaymentRemoved:async()=>{await loadPartyPayments()}}),a.jsx(SupplierDetailPopup,{group:en,isOpen:el,onClose:()=>{ed(!1),ei(null)},onEditOrder:e=>{_(e),R(!0)},onDeleteOrder:handleDeleteOrder,onOrderClick:e=>{J(e),ee(!0)},onRefresh:async()=>{await loadOrders(),await loadLedgerEntries()}}),ex&&em&&(0,a.jsxs)(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:()=>{ep(!1),eu(null)}}),(0,a.jsxs)("div",{className:"fixed inset-x-0 bottom-0 bg-white rounded-t-2xl border-t border-gray-100 z-50 max-h-[80vh] overflow-y-auto",children:[(0,a.jsxs)("div",{className:"sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Payment History"}),a.jsx("button",{onClick:()=>{ep(!1),eu(null)},className:"p-1.5 hover:bg-gray-100 rounded-lg transition-colors",children:a.jsx(N.Z,{size:20,className:"text-gray-600"})})]}),a.jsx("div",{className:"p-4 space-y-4",children:(()=>{let{expenseAmount:e,totalPaid:t,remainingAmount:r}=getOrderPaymentInfo(em),s=em.partialPayments||[];return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Total Expense"}),a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(e)})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[a.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Total Paid"}),a.jsx("span",{className:"text-sm font-semibold text-green-600",children:(0,d.formatIndianCurrency)(t)})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[a.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Remaining"}),a.jsx("span",{className:`text-sm font-semibold ${r>0?"text-red-600":"text-green-600"}`,children:(0,d.formatIndianCurrency)(r)})]})]}),(0,a.jsxs)("div",{children:[a.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Payment Records"}),0===s.length?a.jsx("p",{className:"text-sm text-gray-500 text-center py-4",children:"No payment records found"}):a.jsx("div",{className:"space-y-2",children:s.map(e=>{s.filter(t=>t.id!==e.id).reduce((e,t)=>e+t.amount,0);let t=!!e.ledgerEntryId;return(0,a.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[a.jsx("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(e.amount)}),t&&a.jsx("span",{className:"text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-medium",children:"From Ledger"})]}),a.jsx("span",{className:"text-xs text-gray-500",children:(()=>{let t=page_safeParseDate(e.date);return t?(0,m.ZP)(t,"dd MMM yyyy, hh:mm a"):"Invalid Date"})()})]}),e.note&&a.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:e.note})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 ml-3",children:[!t&&a.jsx("button",{onClick:()=>handleEditPayment(em,e.id),className:"p-1.5 bg-blue-50 text-blue-600 rounded active:bg-blue-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Edit payment",children:a.jsx(j.Z,{size:16})}),!t&&a.jsx("button",{onClick:()=>handleRemovePayment(em,e.id),className:"p-1.5 bg-red-50 text-red-600 rounded active:bg-red-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Remove payment",children:a.jsx(x.Z,{size:16})})]})]},e.id)})})]}),r>0&&(0,a.jsxs)("button",{onClick:()=>{ep(!1),handleAddPaymentToOrder(em)},className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[a.jsx(y.Z,{size:18}),"Add Payment"]})]})})()})]})]}),ey&&ey.order.partialPayments&&(()=>{let e=ey.order.partialPayments.find(e=>e.id===ey.paymentId);if(!e)return null;let t=ey.order.partialPayments.filter(e=>e.id!==ey.paymentId).reduce((e,t)=>e+t.amount,0),r=Number(ey.order.originalTotal||0);return a.jsx(PaymentEditPopup,{isOpen:!!ey,onClose:()=>eg(null),onSave:handleSavePaymentEdit,initialData:{amount:e.amount,date:e.date},maxAmount:r-t})})()]}),a.jsx(SelectionSheet,{isOpen:"party"===eS,onClose:()=>ek(null),title:"Filter by Party",children:(0,a.jsxs)("div",{className:"space-y-1",children:[ew.size>0&&(0,a.jsxs)("button",{onClick:()=>{clearPartyFilter(),ek(null)},className:"w-full text-left px-4 py-3 text-red-600 font-medium hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2",children:[a.jsx(x.Z,{size:16}),"Clear Filter"]}),0===eF.length?a.jsx("div",{className:"text-center text-gray-500 py-8",children:"No parties found"}):eF.map(e=>{let t=ew.has(e);return(0,a.jsxs)("button",{onClick:()=>{let t=new Set;t.add(e),eP(t),ek(null)},className:`w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center justify-between ${t?"bg-primary-50 text-primary-700 font-semibold":"hover:bg-gray-50 text-gray-700"}`,children:[a.jsx("span",{className:"truncate",children:e}),t&&a.jsx("div",{className:"w-2 h-2 rounded-full bg-primary-600"})]},e)})]})}),a.jsx(SelectionSheet,{isOpen:"material"===eS,onClose:()=>ek(null),title:"Filter by Material",children:(0,a.jsxs)("div",{className:"space-y-1",children:[eC.size>0&&(0,a.jsxs)("button",{onClick:()=>{clearMaterialFilter(),ek(null)},className:"w-full text-left px-4 py-3 text-red-600 font-medium hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2",children:[a.jsx(x.Z,{size:16}),"Clear Filter"]}),0===getUniqueMaterials().length?a.jsx("div",{className:"text-center text-gray-500 py-8",children:"No materials found"}):getUniqueMaterials().map(e=>{let t=eC.has(e);return(0,a.jsxs)("button",{onClick:()=>{let t=new Set;t.add(e),eI(t),ek(null)},className:`w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center justify-between ${t?"bg-primary-50 text-primary-700 font-semibold":"hover:bg-gray-50 text-gray-700"}`,children:[a.jsx("span",{className:"truncate",children:e}),t&&a.jsx("div",{className:"w-2 h-2 rounded-full bg-primary-600"})]},e)})]})}),a.jsx(o.Z,{})]})}},533:(e,t,r)=>{"use strict";r.d(t,{I:()=>getAdjustedProfit,w:()=>hasProfitAdjustments});let toNumber=e=>{if("number"==typeof e)return e;if("string"==typeof e){let t=Number(e);return isNaN(t)?0:t}return 0},getAdjustedProfit=e=>{let t=toNumber(e.expenseAdjustment),r=toNumber(e.revenueAdjustment),a=toNumber(e.adjustmentAmount),s=e.profit+t+r+a;return Math.round(100*s)/100},hasProfitAdjustments=e=>{let t=getAdjustedProfit(e);return Math.abs(t-e.profit)>.01}},43692:(e,t,r)=>{"use strict";r.r(t),r.d(t,{$$typeof:()=>i,__esModule:()=>n,default:()=>d});var a=r(95153);let s=(0,a.createProxy)(String.raw`C:\Users\ashis\Desktop\royalsuppliers\royalsuppliers\app\orders\page.tsx`),{__esModule:n,$$typeof:i}=s,l=s.default,d=l}};var t=require("../../webpack-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),r=t.X(0,[252,166,392,813,416,910,943,123,233,766,599,512,265],()=>__webpack_exec__(523));module.exports=r})();