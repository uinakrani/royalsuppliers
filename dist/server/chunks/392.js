exports.id=392,exports.ids=[392],exports.modules={1605:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.addAdminServicesToServer=T.registerAdminService=void 0;let R=[];function registerAdminService(S,T){R.push({getServiceDefinition:S,getHandlers:T})}function addAdminServicesToServer(S){for(let{getServiceDefinition:T,getHandlers:P}of R)S.addService(T(),P())}T.registerAdminService=registerAdminService,T.addAdminServicesToServer=addAdminServicesToServer},77257:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.BackoffTimeout=void 0;let R=1e3,P=1.6,O=12e4,N=.2;function uniformRandom(S,T){return Math.random()*(T-S)+S}let BackoffTimeout=class BackoffTimeout{constructor(S,T){this.callback=S,this.initialDelay=R,this.multiplier=P,this.maxDelay=O,this.jitter=N,this.running=!1,this.hasRef=!0,this.startTime=new Date,this.endTime=new Date,T&&(T.initialDelay&&(this.initialDelay=T.initialDelay),T.multiplier&&(this.multiplier=T.multiplier),T.jitter&&(this.jitter=T.jitter),T.maxDelay&&(this.maxDelay=T.maxDelay)),this.nextDelay=this.initialDelay,this.timerId=setTimeout(()=>{},0),clearTimeout(this.timerId)}runTimer(S){var T,R;this.endTime=this.startTime,this.endTime.setMilliseconds(this.endTime.getMilliseconds()+this.nextDelay),clearTimeout(this.timerId),this.timerId=setTimeout(()=>{this.callback(),this.running=!1},S),this.hasRef||null===(R=(T=this.timerId).unref)||void 0===R||R.call(T)}runOnce(){this.running=!0,this.startTime=new Date,this.runTimer(this.nextDelay);let S=Math.min(this.nextDelay*this.multiplier,this.maxDelay),T=S*this.jitter;this.nextDelay=S+uniformRandom(-T,T)}stop(){clearTimeout(this.timerId),this.running=!1}reset(){if(this.nextDelay=this.initialDelay,this.running){let S=new Date,T=this.startTime;T.setMilliseconds(T.getMilliseconds()+this.nextDelay),clearTimeout(this.timerId),S<T?this.runTimer(T.getTime()-S.getTime()):this.running=!1}}isRunning(){return this.running}ref(){var S,T;this.hasRef=!0,null===(T=(S=this.timerId).ref)||void 0===T||T.call(S)}unref(){var S,T;this.hasRef=!1,null===(T=(S=this.timerId).unref)||void 0===T||T.call(S)}getEndTime(){return this.endTime}};T.BackoffTimeout=BackoffTimeout},68612:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.CallCredentials=void 0;let P=R(32908);function isCurrentOauth2Client(S){return"getRequestHeaders"in S&&"function"==typeof S.getRequestHeaders}let CallCredentials=class CallCredentials{static createFromMetadataGenerator(S){return new SingleCallCredentials(S)}static createFromGoogleCredential(S){return CallCredentials.createFromMetadataGenerator((T,R)=>{let O;(O=isCurrentOauth2Client(S)?S.getRequestHeaders(T.service_url):new Promise((R,P)=>{S.getRequestMetadata(T.service_url,(S,T)=>{if(S){P(S);return}if(!T){P(Error("Headers not set by metadata plugin"));return}R(T)})})).then(S=>{let T=new P.Metadata;for(let R of Object.keys(S))T.add(R,S[R]);R(null,T)},S=>{R(S)})})}static createEmpty(){return new EmptyCallCredentials}};T.CallCredentials=CallCredentials;let ComposedCallCredentials=class ComposedCallCredentials extends CallCredentials{constructor(S){super(),this.creds=S}async generateMetadata(S){let T=new P.Metadata,R=await Promise.all(this.creds.map(T=>T.generateMetadata(S)));for(let S of R)T.merge(S);return T}compose(S){return new ComposedCallCredentials(this.creds.concat([S]))}_equals(S){return this===S||S instanceof ComposedCallCredentials&&this.creds.every((T,R)=>T._equals(S.creds[R]))}};let SingleCallCredentials=class SingleCallCredentials extends CallCredentials{constructor(S){super(),this.metadataGenerator=S}generateMetadata(S){return new Promise((T,R)=>{this.metadataGenerator(S,(S,P)=>{void 0!==P?T(P):R(S)})})}compose(S){return new ComposedCallCredentials([this,S])}_equals(S){return this===S||S instanceof SingleCallCredentials&&this.metadataGenerator===S.metadataGenerator}};let EmptyCallCredentials=class EmptyCallCredentials extends CallCredentials{generateMetadata(S){return Promise.resolve(new P.Metadata)}compose(S){return S}_equals(S){return S instanceof EmptyCallCredentials}}},88577:(S,T)=>{"use strict";function isInterceptingListener(S){return void 0!==S.onReceiveMetadata&&1===S.onReceiveMetadata.length}Object.defineProperty(T,"__esModule",{value:!0}),T.InterceptingListenerImpl=T.isInterceptingListener=void 0,T.isInterceptingListener=isInterceptingListener;let InterceptingListenerImpl=class InterceptingListenerImpl{constructor(S,T){this.listener=S,this.nextListener=T,this.processingMetadata=!1,this.hasPendingMessage=!1,this.processingMessage=!1,this.pendingStatus=null}processPendingMessage(){this.hasPendingMessage&&(this.nextListener.onReceiveMessage(this.pendingMessage),this.pendingMessage=null,this.hasPendingMessage=!1)}processPendingStatus(){this.pendingStatus&&this.nextListener.onReceiveStatus(this.pendingStatus)}onReceiveMetadata(S){this.processingMetadata=!0,this.listener.onReceiveMetadata(S,S=>{this.processingMetadata=!1,this.nextListener.onReceiveMetadata(S),this.processPendingMessage(),this.processPendingStatus()})}onReceiveMessage(S){this.processingMessage=!0,this.listener.onReceiveMessage(S,S=>{this.processingMessage=!1,this.processingMetadata?(this.pendingMessage=S,this.hasPendingMessage=!0):(this.nextListener.onReceiveMessage(S),this.processPendingStatus())})}onReceiveStatus(S){this.listener.onReceiveStatus(S,S=>{this.processingMetadata||this.processingMessage?this.pendingStatus=S:this.nextListener.onReceiveStatus(S)})}};T.InterceptingListenerImpl=InterceptingListenerImpl},60060:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.getNextCallNumber=void 0;let R=0;function getNextCallNumber(){return R++}T.getNextCallNumber=getNextCallNumber},12953:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ClientDuplexStreamImpl=T.ClientWritableStreamImpl=T.ClientReadableStreamImpl=T.ClientUnaryCallImpl=T.callErrorFromStatus=void 0;let P=R(82361),O=R(12781),N=R(69238);function callErrorFromStatus(S,T){let R=`${S.code} ${N.Status[S.code]}: ${S.details}`,P=Error(R),O=`${P.stack}
for call at
${T}`;return Object.assign(Error(R),S,{stack:O})}T.callErrorFromStatus=callErrorFromStatus;let ClientUnaryCallImpl=class ClientUnaryCallImpl extends P.EventEmitter{constructor(){super()}cancel(){var S;null===(S=this.call)||void 0===S||S.cancelWithStatus(N.Status.CANCELLED,"Cancelled on client")}getPeer(){var S,T;return null!==(T=null===(S=this.call)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:"unknown"}};T.ClientUnaryCallImpl=ClientUnaryCallImpl;let ClientReadableStreamImpl=class ClientReadableStreamImpl extends O.Readable{constructor(S){super({objectMode:!0}),this.deserialize=S}cancel(){var S;null===(S=this.call)||void 0===S||S.cancelWithStatus(N.Status.CANCELLED,"Cancelled on client")}getPeer(){var S,T;return null!==(T=null===(S=this.call)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:"unknown"}_read(S){var T;null===(T=this.call)||void 0===T||T.startRead()}};T.ClientReadableStreamImpl=ClientReadableStreamImpl;let ClientWritableStreamImpl=class ClientWritableStreamImpl extends O.Writable{constructor(S){super({objectMode:!0}),this.serialize=S}cancel(){var S;null===(S=this.call)||void 0===S||S.cancelWithStatus(N.Status.CANCELLED,"Cancelled on client")}getPeer(){var S,T;return null!==(T=null===(S=this.call)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:"unknown"}_write(S,T,R){var P;let O={callback:R},N=Number(T);Number.isNaN(N)||(O.flags=N),null===(P=this.call)||void 0===P||P.sendMessageWithContext(O,S)}_final(S){var T;null===(T=this.call)||void 0===T||T.halfClose(),S()}};T.ClientWritableStreamImpl=ClientWritableStreamImpl;let ClientDuplexStreamImpl=class ClientDuplexStreamImpl extends O.Duplex{constructor(S,T){super({objectMode:!0}),this.serialize=S,this.deserialize=T}cancel(){var S;null===(S=this.call)||void 0===S||S.cancelWithStatus(N.Status.CANCELLED,"Cancelled on client")}getPeer(){var S,T;return null!==(T=null===(S=this.call)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:"unknown"}_read(S){var T;null===(T=this.call)||void 0===T||T.startRead()}_write(S,T,R){var P;let O={callback:R},N=Number(T);Number.isNaN(N)||(O.flags=N),null===(P=this.call)||void 0===P||P.sendMessageWithContext(O,S)}_final(S){var T;null===(T=this.call)||void 0===T||T.halfClose(),S()}};T.ClientDuplexStreamImpl=ClientDuplexStreamImpl},77021:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ChannelCredentials=void 0;let P=R(24404),O=R(68612),N=R(66801);function verifyIsBufferOrNull(S,T){if(S&&!(S instanceof Buffer))throw TypeError(`${T}, if provided, must be a Buffer.`)}let ChannelCredentials=class ChannelCredentials{constructor(S){this.callCredentials=S||O.CallCredentials.createEmpty()}_getCallCredentials(){return this.callCredentials}static createSsl(S,T,R,O){var M;if(verifyIsBufferOrNull(S,"Root certificate"),verifyIsBufferOrNull(T,"Private key"),verifyIsBufferOrNull(R,"Certificate chain"),T&&!R)throw Error("Private key must be given with accompanying certificate chain");if(!T&&R)throw Error("Certificate chain must be given with accompanying private key");let L=(0,P.createSecureContext)({ca:null!==(M=null!=S?S:(0,N.getDefaultRootsData)())&&void 0!==M?M:void 0,key:null!=T?T:void 0,cert:null!=R?R:void 0,ciphers:N.CIPHER_SUITES});return new SecureChannelCredentialsImpl(L,null!=O?O:{})}static createFromSecureContext(S,T){return new SecureChannelCredentialsImpl(S,null!=T?T:{})}static createInsecure(){return new InsecureChannelCredentialsImpl}};T.ChannelCredentials=ChannelCredentials;let InsecureChannelCredentialsImpl=class InsecureChannelCredentialsImpl extends ChannelCredentials{constructor(S){super(S)}compose(S){throw Error("Cannot compose insecure credentials")}_getConnectionOptions(){return null}_isSecure(){return!1}_equals(S){return S instanceof InsecureChannelCredentialsImpl}};let SecureChannelCredentialsImpl=class SecureChannelCredentialsImpl extends ChannelCredentials{constructor(S,T){super(),this.secureContext=S,this.verifyOptions=T,this.connectionOptions={secureContext:S},(null==T?void 0:T.checkServerIdentity)&&(this.connectionOptions.checkServerIdentity=T.checkServerIdentity)}compose(S){let T=this.callCredentials.compose(S);return new ComposedChannelCredentialsImpl(this,T)}_getConnectionOptions(){return Object.assign({},this.connectionOptions)}_isSecure(){return!0}_equals(S){return this===S||S instanceof SecureChannelCredentialsImpl&&this.secureContext===S.secureContext&&this.verifyOptions.checkServerIdentity===S.verifyOptions.checkServerIdentity}};let ComposedChannelCredentialsImpl=class ComposedChannelCredentialsImpl extends ChannelCredentials{constructor(S,T){super(T),this.channelCredentials=S}compose(S){let T=this.callCredentials.compose(S);return new ComposedChannelCredentialsImpl(this.channelCredentials,T)}_getConnectionOptions(){return this.channelCredentials._getConnectionOptions()}_isSecure(){return!0}_equals(S){return this===S||S instanceof ComposedChannelCredentialsImpl&&this.channelCredentials._equals(S.channelCredentials)&&this.callCredentials._equals(S.callCredentials)}}},70332:(S,T)=>{"use strict";function channelOptionsEqual(S,T){let R=Object.keys(S).sort(),P=Object.keys(T).sort();if(R.length!==P.length)return!1;for(let O=0;O<R.length;O+=1)if(R[O]!==P[O]||S[R[O]]!==T[P[O]])return!1;return!0}Object.defineProperty(T,"__esModule",{value:!0}),T.channelOptionsEqual=T.recognizedOptions=void 0,T.recognizedOptions={"grpc.ssl_target_name_override":!0,"grpc.primary_user_agent":!0,"grpc.secondary_user_agent":!0,"grpc.default_authority":!0,"grpc.keepalive_time_ms":!0,"grpc.keepalive_timeout_ms":!0,"grpc.keepalive_permit_without_calls":!0,"grpc.service_config":!0,"grpc.max_concurrent_streams":!0,"grpc.initial_reconnect_backoff_ms":!0,"grpc.max_reconnect_backoff_ms":!0,"grpc.use_local_subchannel_pool":!0,"grpc.max_send_message_length":!0,"grpc.max_receive_message_length":!0,"grpc.enable_http_proxy":!0,"grpc.enable_channelz":!0,"grpc.dns_min_time_between_resolutions_ms":!0,"grpc.enable_retries":!0,"grpc.per_rpc_retry_buffer_size":!0,"grpc.retry_buffer_size":!0,"grpc.max_connection_age_ms":!0,"grpc.max_connection_age_grace_ms":!0,"grpc-node.max_session_memory":!0,"grpc.service_config_disable_resolution":!0,"grpc.client_idle_timeout_ms":!0,"grpc-node.tls_enable_trace":!0},T.channelOptionsEqual=channelOptionsEqual},49914:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ChannelImplementation=void 0;let P=R(77021),O=R(35233);let ChannelImplementation=class ChannelImplementation{constructor(S,T,R){if("string"!=typeof S)throw TypeError("Channel target must be a string");if(!(T instanceof P.ChannelCredentials))throw TypeError("Channel credentials must be a ChannelCredentials object");if(R&&"object"!=typeof R)throw TypeError("Channel options must be an object");this.internalChannel=new O.InternalChannel(S,T,R)}close(){this.internalChannel.close()}getTarget(){return this.internalChannel.getTarget()}getConnectivityState(S){return this.internalChannel.getConnectivityState(S)}watchConnectivityState(S,T,R){this.internalChannel.watchConnectivityState(S,T,R)}getChannelzRef(){return this.internalChannel.getChannelzRef()}createCall(S,T,R,P,O){if("string"!=typeof S)throw TypeError("Channel#createCall: method must be a string");if(!("number"==typeof T||T instanceof Date))throw TypeError("Channel#createCall: deadline must be a number or Date");return this.internalChannel.createCall(S,T,R,P,O)}};T.ChannelImplementation=ChannelImplementation},83316:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=T.getChannelzServiceDefinition=T.getChannelzHandlers=T.unregisterChannelzRef=T.registerChannelzSocket=T.registerChannelzServer=T.registerChannelzSubchannel=T.registerChannelzChannel=T.ChannelzCallTracker=T.ChannelzChildrenTracker=T.ChannelzTrace=void 0;let P=R(41808),O=R(91360),N=R(69238),M=R(72782),L=R(1605),V=R(47697);function channelRefToMessage(S){return{channel_id:S.id,name:S.name}}function subchannelRefToMessage(S){return{subchannel_id:S.id,name:S.name}}function serverRefToMessage(S){return{server_id:S.id}}function socketRefToMessage(S){return{socket_id:S.id,name:S.name}}let U=32;let ChannelzTrace=class ChannelzTrace{constructor(){this.events=[],this.eventsLogged=0,this.creationTimestamp=new Date}addTrace(S,T,R){let P=new Date;this.events.push({description:T,severity:S,timestamp:P,childChannel:(null==R?void 0:R.kind)==="channel"?R:void 0,childSubchannel:(null==R?void 0:R.kind)==="subchannel"?R:void 0}),this.events.length>=2*U&&(this.events=this.events.slice(U)),this.eventsLogged+=1}getTraceMessage(){return{creation_timestamp:dateToProtoTimestamp(this.creationTimestamp),num_events_logged:this.eventsLogged,events:this.events.map(S=>({description:S.description,severity:S.severity,timestamp:dateToProtoTimestamp(S.timestamp),channel_ref:S.childChannel?channelRefToMessage(S.childChannel):null,subchannel_ref:S.childSubchannel?subchannelRefToMessage(S.childSubchannel):null}))}}};T.ChannelzTrace=ChannelzTrace;let ChannelzChildrenTracker=class ChannelzChildrenTracker{constructor(){this.channelChildren=new Map,this.subchannelChildren=new Map,this.socketChildren=new Map}refChild(S){var T,R,P;switch(S.kind){case"channel":{let R=null!==(T=this.channelChildren.get(S.id))&&void 0!==T?T:{ref:S,count:0};R.count+=1,this.channelChildren.set(S.id,R);break}case"subchannel":{let T=null!==(R=this.subchannelChildren.get(S.id))&&void 0!==R?R:{ref:S,count:0};T.count+=1,this.subchannelChildren.set(S.id,T);break}case"socket":{let T=null!==(P=this.socketChildren.get(S.id))&&void 0!==P?P:{ref:S,count:0};T.count+=1,this.socketChildren.set(S.id,T)}}}unrefChild(S){switch(S.kind){case"channel":{let T=this.channelChildren.get(S.id);void 0!==T&&(T.count-=1,0===T.count?this.channelChildren.delete(S.id):this.channelChildren.set(S.id,T));break}case"subchannel":{let T=this.subchannelChildren.get(S.id);void 0!==T&&(T.count-=1,0===T.count?this.subchannelChildren.delete(S.id):this.subchannelChildren.set(S.id,T));break}case"socket":{let T=this.socketChildren.get(S.id);void 0!==T&&(T.count-=1,0===T.count?this.socketChildren.delete(S.id):this.socketChildren.set(S.id,T))}}}getChildLists(){let S=[];for(let{ref:T}of this.channelChildren.values())S.push(T);let T=[];for(let{ref:S}of this.subchannelChildren.values())T.push(S);let R=[];for(let{ref:S}of this.socketChildren.values())R.push(S);return{channels:S,subchannels:T,sockets:R}}};T.ChannelzChildrenTracker=ChannelzChildrenTracker;let ChannelzCallTracker=class ChannelzCallTracker{constructor(){this.callsStarted=0,this.callsSucceeded=0,this.callsFailed=0,this.lastCallStartedTimestamp=null}addCallStarted(){this.callsStarted+=1,this.lastCallStartedTimestamp=new Date}addCallSucceeded(){this.callsSucceeded+=1}addCallFailed(){this.callsFailed+=1}};T.ChannelzCallTracker=ChannelzCallTracker;let W=1;function getNextId(){return W++}let K=[],Q=[],$=[],Y=[];function registerChannelzChannel(S,T,R){let P=getNextId(),O={id:P,name:S,kind:"channel"};return R&&(K[P]={ref:O,getInfo:T}),O}function registerChannelzSubchannel(S,T,R){let P=getNextId(),O={id:P,name:S,kind:"subchannel"};return R&&(Q[P]={ref:O,getInfo:T}),O}function registerChannelzServer(S,T){let R=getNextId(),P={id:R,kind:"server"};return T&&($[R]={ref:P,getInfo:S}),P}function registerChannelzSocket(S,T,R){let P=getNextId(),O={id:P,name:S,kind:"socket"};return R&&(Y[P]={ref:O,getInfo:T}),O}function unregisterChannelzRef(S){switch(S.kind){case"channel":delete K[S.id];return;case"subchannel":delete Q[S.id];return;case"server":delete $[S.id];return;case"socket":delete Y[S.id];return}}function parseIPv6Section(S){let T=Number.parseInt(S,16);return[T/256|0,T%256]}function parseIPv6Chunk(S){if(""===S)return[];let T=S.split(":").map(S=>parseIPv6Section(S)),R=[];return R.concat(...T)}function ipAddressStringToBuffer(S){if((0,P.isIPv4)(S))return Buffer.from(Uint8Array.from(S.split(".").map(S=>Number.parseInt(S))));if(!(0,P.isIPv6)(S))return null;{let T,R;let P=S.indexOf("::");-1===P?(T=S,R=""):(T=S.substring(0,P),R=S.substring(P+2));let O=Buffer.from(parseIPv6Chunk(T)),N=Buffer.from(parseIPv6Chunk(R)),M=Buffer.alloc(16-O.length-N.length,0);return Buffer.concat([O,M,N])}}function connectivityStateToMessage(S){switch(S){case O.ConnectivityState.CONNECTING:return{state:"CONNECTING"};case O.ConnectivityState.IDLE:return{state:"IDLE"};case O.ConnectivityState.READY:return{state:"READY"};case O.ConnectivityState.SHUTDOWN:return{state:"SHUTDOWN"};case O.ConnectivityState.TRANSIENT_FAILURE:return{state:"TRANSIENT_FAILURE"};default:return{state:"UNKNOWN"}}}function dateToProtoTimestamp(S){if(!S)return null;let T=S.getTime();return{seconds:T/1e3|0,nanos:T%1e3*1e6}}function getChannelMessage(S){let T=S.getInfo();return{ref:channelRefToMessage(S.ref),data:{target:T.target,state:connectivityStateToMessage(T.state),calls_started:T.callTracker.callsStarted,calls_succeeded:T.callTracker.callsSucceeded,calls_failed:T.callTracker.callsFailed,last_call_started_timestamp:dateToProtoTimestamp(T.callTracker.lastCallStartedTimestamp),trace:T.trace.getTraceMessage()},channel_ref:T.children.channels.map(S=>channelRefToMessage(S)),subchannel_ref:T.children.subchannels.map(S=>subchannelRefToMessage(S))}}function GetChannel(S,T){let R=Number.parseInt(S.request.channel_id),P=K[R];if(void 0===P){T({code:N.Status.NOT_FOUND,details:"No channel data found for id "+R});return}T(null,{channel:getChannelMessage(P)})}function GetTopChannels(S,T){let R=Number.parseInt(S.request.max_results),P=[],O=Number.parseInt(S.request.start_channel_id);for(;O<K.length;O++){let S=K[O];if(void 0!==S&&(P.push(getChannelMessage(S)),P.length>=R))break}T(null,{channel:P,end:O>=$.length})}function getServerMessage(S){let T=S.getInfo();return{ref:serverRefToMessage(S.ref),data:{calls_started:T.callTracker.callsStarted,calls_succeeded:T.callTracker.callsSucceeded,calls_failed:T.callTracker.callsFailed,last_call_started_timestamp:dateToProtoTimestamp(T.callTracker.lastCallStartedTimestamp),trace:T.trace.getTraceMessage()},listen_socket:T.listenerChildren.sockets.map(S=>socketRefToMessage(S))}}function GetServer(S,T){let R=Number.parseInt(S.request.server_id),P=$[R];if(void 0===P){T({code:N.Status.NOT_FOUND,details:"No server data found for id "+R});return}T(null,{server:getServerMessage(P)})}function GetServers(S,T){let R=Number.parseInt(S.request.max_results),P=[],O=Number.parseInt(S.request.start_server_id);for(;O<$.length;O++){let S=$[O];if(void 0!==S&&(P.push(getServerMessage(S)),P.length>=R))break}T(null,{server:P,end:O>=$.length})}function GetSubchannel(S,T){let R=Number.parseInt(S.request.subchannel_id),P=Q[R];if(void 0===P){T({code:N.Status.NOT_FOUND,details:"No subchannel data found for id "+R});return}let O=P.getInfo(),M={ref:subchannelRefToMessage(P.ref),data:{target:O.target,state:connectivityStateToMessage(O.state),calls_started:O.callTracker.callsStarted,calls_succeeded:O.callTracker.callsSucceeded,calls_failed:O.callTracker.callsFailed,last_call_started_timestamp:dateToProtoTimestamp(O.callTracker.lastCallStartedTimestamp),trace:O.trace.getTraceMessage()},socket_ref:O.children.sockets.map(S=>socketRefToMessage(S))};T(null,{subchannel:M})}function subchannelAddressToAddressMessage(S){var T;return(0,M.isTcpSubchannelAddress)(S)?{address:"tcpip_address",tcpip_address:{ip_address:null!==(T=ipAddressStringToBuffer(S.host))&&void 0!==T?T:void 0,port:S.port}}:{address:"uds_address",uds_address:{filename:S.path}}}function GetSocket(S,T){var R,P,O,M,L;let V=Number.parseInt(S.request.socket_id),U=Y[V];if(void 0===U){T({code:N.Status.NOT_FOUND,details:"No socket data found for id "+V});return}let W=U.getInfo(),K=W.security?{model:"tls",tls:{cipher_suite:W.security.cipherSuiteStandardName?"standard_name":"other_name",standard_name:null!==(R=W.security.cipherSuiteStandardName)&&void 0!==R?R:void 0,other_name:null!==(P=W.security.cipherSuiteOtherName)&&void 0!==P?P:void 0,local_certificate:null!==(O=W.security.localCertificate)&&void 0!==O?O:void 0,remote_certificate:null!==(M=W.security.remoteCertificate)&&void 0!==M?M:void 0}}:null,Q={ref:socketRefToMessage(U.ref),local:W.localAddress?subchannelAddressToAddressMessage(W.localAddress):null,remote:W.remoteAddress?subchannelAddressToAddressMessage(W.remoteAddress):null,remote_name:null!==(L=W.remoteName)&&void 0!==L?L:void 0,security:K,data:{keep_alives_sent:W.keepAlivesSent,streams_started:W.streamsStarted,streams_succeeded:W.streamsSucceeded,streams_failed:W.streamsFailed,last_local_stream_created_timestamp:dateToProtoTimestamp(W.lastLocalStreamCreatedTimestamp),last_remote_stream_created_timestamp:dateToProtoTimestamp(W.lastRemoteStreamCreatedTimestamp),messages_received:W.messagesReceived,messages_sent:W.messagesSent,last_message_received_timestamp:dateToProtoTimestamp(W.lastMessageReceivedTimestamp),last_message_sent_timestamp:dateToProtoTimestamp(W.lastMessageSentTimestamp),local_flow_control_window:W.localFlowControlWindow?{value:W.localFlowControlWindow}:null,remote_flow_control_window:W.remoteFlowControlWindow?{value:W.remoteFlowControlWindow}:null}};T(null,{socket:Q})}function GetServerSockets(S,T){let R=Number.parseInt(S.request.server_id),P=$[R];if(void 0===P){T({code:N.Status.NOT_FOUND,details:"No server data found for id "+R});return}let O=Number.parseInt(S.request.start_socket_id),M=Number.parseInt(S.request.max_results),L=P.getInfo(),V=L.sessionChildren.sockets.sort((S,T)=>S.id-T.id),U=[],W=0;for(;W<V.length&&(!(V[W].id>=O)||(U.push(socketRefToMessage(V[W])),!(U.length>=M)));W++);T(null,{socket_ref:U,end:W>=V.length})}function getChannelzHandlers(){return{GetChannel,GetTopChannels,GetServer,GetServers,GetSubchannel,GetSocket,GetServerSockets}}T.registerChannelzChannel=registerChannelzChannel,T.registerChannelzSubchannel=registerChannelzSubchannel,T.registerChannelzServer=registerChannelzServer,T.registerChannelzSocket=registerChannelzSocket,T.unregisterChannelzRef=unregisterChannelzRef,T.getChannelzHandlers=getChannelzHandlers;let X=null;function getChannelzServiceDefinition(){if(X)return X;let S=R(18196).J_,T=S("channelz.proto",{keepCase:!0,longs:String,enums:String,defaults:!0,oneofs:!0,includeDirs:[`${__dirname}/../../proto`]}),P=(0,V.loadPackageDefinition)(T);return X=P.grpc.channelz.v1.Channelz.service}function setup(){(0,L.registerAdminService)(getChannelzServiceDefinition,getChannelzHandlers)}T.getChannelzServiceDefinition=getChannelzServiceDefinition,T.setup=setup},72158:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.getInterceptingCall=T.InterceptingCall=T.RequesterBuilder=T.ListenerBuilder=T.InterceptorConfigurationError=void 0;let P=R(32908),O=R(88577),N=R(69238),M=R(9006);let InterceptorConfigurationError=class InterceptorConfigurationError extends Error{constructor(S){super(S),this.name="InterceptorConfigurationError",Error.captureStackTrace(this,InterceptorConfigurationError)}};T.InterceptorConfigurationError=InterceptorConfigurationError;let ListenerBuilder=class ListenerBuilder{constructor(){this.metadata=void 0,this.message=void 0,this.status=void 0}withOnReceiveMetadata(S){return this.metadata=S,this}withOnReceiveMessage(S){return this.message=S,this}withOnReceiveStatus(S){return this.status=S,this}build(){return{onReceiveMetadata:this.metadata,onReceiveMessage:this.message,onReceiveStatus:this.status}}};T.ListenerBuilder=ListenerBuilder;let RequesterBuilder=class RequesterBuilder{constructor(){this.start=void 0,this.message=void 0,this.halfClose=void 0,this.cancel=void 0}withStart(S){return this.start=S,this}withSendMessage(S){return this.message=S,this}withHalfClose(S){return this.halfClose=S,this}withCancel(S){return this.cancel=S,this}build(){return{start:this.start,sendMessage:this.message,halfClose:this.halfClose,cancel:this.cancel}}};T.RequesterBuilder=RequesterBuilder;let L={onReceiveMetadata:(S,T)=>{T(S)},onReceiveMessage:(S,T)=>{T(S)},onReceiveStatus:(S,T)=>{T(S)}},V={start:(S,T,R)=>{R(S,T)},sendMessage:(S,T)=>{T(S)},halfClose:S=>{S()},cancel:S=>{S()}};let InterceptingCall=class InterceptingCall{constructor(S,T){var R,P,O,N;this.nextCall=S,this.processingMetadata=!1,this.pendingMessageContext=null,this.processingMessage=!1,this.pendingHalfClose=!1,T?this.requester={start:null!==(R=T.start)&&void 0!==R?R:V.start,sendMessage:null!==(P=T.sendMessage)&&void 0!==P?P:V.sendMessage,halfClose:null!==(O=T.halfClose)&&void 0!==O?O:V.halfClose,cancel:null!==(N=T.cancel)&&void 0!==N?N:V.cancel}:this.requester=V}cancelWithStatus(S,T){this.requester.cancel(()=>{this.nextCall.cancelWithStatus(S,T)})}getPeer(){return this.nextCall.getPeer()}processPendingMessage(){this.pendingMessageContext&&(this.nextCall.sendMessageWithContext(this.pendingMessageContext,this.pendingMessage),this.pendingMessageContext=null,this.pendingMessage=null)}processPendingHalfClose(){this.pendingHalfClose&&this.nextCall.halfClose()}start(S,T){var R,P,N,M,V,U;let W={onReceiveMetadata:null!==(P=null===(R=null==T?void 0:T.onReceiveMetadata)||void 0===R?void 0:R.bind(T))&&void 0!==P?P:S=>{},onReceiveMessage:null!==(M=null===(N=null==T?void 0:T.onReceiveMessage)||void 0===N?void 0:N.bind(T))&&void 0!==M?M:S=>{},onReceiveStatus:null!==(U=null===(V=null==T?void 0:T.onReceiveStatus)||void 0===V?void 0:V.bind(T))&&void 0!==U?U:S=>{}};this.processingMetadata=!0,this.requester.start(S,W,(S,T)=>{var R,P,N;let M;if(this.processingMetadata=!1,(0,O.isInterceptingListener)(T))M=T;else{let S={onReceiveMetadata:null!==(R=T.onReceiveMetadata)&&void 0!==R?R:L.onReceiveMetadata,onReceiveMessage:null!==(P=T.onReceiveMessage)&&void 0!==P?P:L.onReceiveMessage,onReceiveStatus:null!==(N=T.onReceiveStatus)&&void 0!==N?N:L.onReceiveStatus};M=new O.InterceptingListenerImpl(S,W)}this.nextCall.start(S,M),this.processPendingMessage(),this.processPendingHalfClose()})}sendMessageWithContext(S,T){this.processingMessage=!0,this.requester.sendMessage(T,R=>{this.processingMessage=!1,this.processingMetadata?(this.pendingMessageContext=S,this.pendingMessage=T):(this.nextCall.sendMessageWithContext(S,R),this.processPendingHalfClose())})}sendMessage(S){this.sendMessageWithContext({},S)}startRead(){this.nextCall.startRead()}halfClose(){this.requester.halfClose(()=>{this.processingMetadata||this.processingMessage?this.pendingHalfClose=!0:this.nextCall.halfClose()})}};function getCall(S,T,R){var P,O;let N=null!==(P=R.deadline)&&void 0!==P?P:1/0,M=R.host,L=null!==(O=R.parent)&&void 0!==O?O:null,V=R.propagate_flags,U=R.credentials,W=S.createCall(T,N,M,L,V);return U&&W.setCredentials(U),W}T.InterceptingCall=InterceptingCall;let BaseInterceptingCall=class BaseInterceptingCall{constructor(S,T){this.call=S,this.methodDefinition=T}cancelWithStatus(S,T){this.call.cancelWithStatus(S,T)}getPeer(){return this.call.getPeer()}sendMessageWithContext(S,T){let R;try{R=this.methodDefinition.requestSerialize(T)}catch(S){this.call.cancelWithStatus(N.Status.INTERNAL,`Request message serialization failure: ${(0,M.getErrorMessage)(S)}`);return}this.call.sendMessageWithContext(S,R)}sendMessage(S){this.sendMessageWithContext({},S)}start(S,T){let R=null;this.call.start(S,{onReceiveMetadata:S=>{var R;null===(R=null==T?void 0:T.onReceiveMetadata)||void 0===R||R.call(T,S)},onReceiveMessage:S=>{var O;let L;try{L=this.methodDefinition.responseDeserialize(S)}catch(S){R={code:N.Status.INTERNAL,details:`Response message parsing error: ${(0,M.getErrorMessage)(S)}`,metadata:new P.Metadata},this.call.cancelWithStatus(R.code,R.details);return}null===(O=null==T?void 0:T.onReceiveMessage)||void 0===O||O.call(T,L)},onReceiveStatus:S=>{var P,O;R?null===(P=null==T?void 0:T.onReceiveStatus)||void 0===P||P.call(T,R):null===(O=null==T?void 0:T.onReceiveStatus)||void 0===O||O.call(T,S)}})}startRead(){this.call.startRead()}halfClose(){this.call.halfClose()}};let BaseUnaryInterceptingCall=class BaseUnaryInterceptingCall extends BaseInterceptingCall{constructor(S,T){super(S,T)}start(S,T){var R,P;let O=!1,N={onReceiveMetadata:null!==(P=null===(R=null==T?void 0:T.onReceiveMetadata)||void 0===R?void 0:R.bind(T))&&void 0!==P?P:S=>{},onReceiveMessage:S=>{var R;O=!0,null===(R=null==T?void 0:T.onReceiveMessage)||void 0===R||R.call(T,S)},onReceiveStatus:S=>{var R,P;O||null===(R=null==T?void 0:T.onReceiveMessage)||void 0===R||R.call(T,null),null===(P=null==T?void 0:T.onReceiveStatus)||void 0===P||P.call(T,S)}};super.start(S,N),this.call.startRead()}};let BaseStreamingInterceptingCall=class BaseStreamingInterceptingCall extends BaseInterceptingCall{};function getBottomInterceptingCall(S,T,R){let P=getCall(S,R.path,T);return R.responseStream?new BaseStreamingInterceptingCall(P,R):new BaseUnaryInterceptingCall(P,R)}function getInterceptingCall(S,T,R,P){if(S.clientInterceptors.length>0&&S.clientInterceptorProviders.length>0)throw new InterceptorConfigurationError("Both interceptors and interceptor_providers were passed as options to the client constructor. Only one of these is allowed.");if(S.callInterceptors.length>0&&S.callInterceptorProviders.length>0)throw new InterceptorConfigurationError("Both interceptors and interceptor_providers were passed as call options. Only one of these is allowed.");let O=[];O=S.callInterceptors.length>0||S.callInterceptorProviders.length>0?[].concat(S.callInterceptors,S.callInterceptorProviders.map(S=>S(T))).filter(S=>S):[].concat(S.clientInterceptors,S.clientInterceptorProviders.map(S=>S(T))).filter(S=>S);let N=Object.assign({},R,{method_definition:T}),M=O.reduceRight((S,T)=>R=>T(R,S),S=>getBottomInterceptingCall(P,S,T));return M(N)}T.getInterceptingCall=getInterceptingCall},47307:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Client=void 0;let P=R(12953),O=R(49914),N=R(91360),M=R(69238),L=R(32908),V=R(72158),U=Symbol(),W=Symbol(),K=Symbol(),Q=Symbol();function isFunction(S){return"function"==typeof S}function getErrorStackString(S){return S.stack.split("\n").slice(1).join("\n")}let Client=class Client{constructor(S,T,R={}){var P,N;if(R=Object.assign({},R),this[W]=null!==(P=R.interceptors)&&void 0!==P?P:[],delete R.interceptors,this[K]=null!==(N=R.interceptor_providers)&&void 0!==N?N:[],delete R.interceptor_providers,this[W].length>0&&this[K].length>0)throw Error("Both interceptors and interceptor_providers were passed as options to the client constructor. Only one of these is allowed.");if(this[Q]=R.callInvocationTransformer,delete R.callInvocationTransformer,R.channelOverride)this[U]=R.channelOverride;else if(R.channelFactoryOverride){let P=R.channelFactoryOverride;delete R.channelFactoryOverride,this[U]=P(S,T,R)}else this[U]=new O.ChannelImplementation(S,T,R)}close(){this[U].close()}getChannel(){return this[U]}waitForReady(S,T){let checkState=R=>{let P;if(R){T(Error("Failed to connect before the deadline"));return}try{P=this[U].getConnectivityState(!0)}catch(S){T(Error("The channel has been closed"));return}if(P===N.ConnectivityState.READY)T();else try{this[U].watchConnectivityState(P,S,checkState)}catch(S){T(Error("The channel has been closed"))}};setImmediate(checkState)}checkOptionalUnaryResponseArguments(S,T,R){if(isFunction(S))return{metadata:new L.Metadata,options:{},callback:S};if(isFunction(T))return S instanceof L.Metadata?{metadata:S,options:{},callback:T}:{metadata:new L.Metadata,options:S,callback:T};if(!(S instanceof L.Metadata&&T instanceof Object&&isFunction(R)))throw Error("Incorrect arguments passed");return{metadata:S,options:T,callback:R}}makeUnaryRequest(S,T,R,O,N,L,$){var Y,X;let Z=this.checkOptionalUnaryResponseArguments(N,L,$),ee={path:S,requestStream:!1,responseStream:!1,requestSerialize:T,responseDeserialize:R},et={argument:O,metadata:Z.metadata,call:new P.ClientUnaryCallImpl,channel:this[U],methodDefinition:ee,callOptions:Z.options,callback:Z.callback};this[Q]&&(et=this[Q](et));let er=et.call,en={clientInterceptors:this[W],clientInterceptorProviders:this[K],callInterceptors:null!==(Y=et.callOptions.interceptors)&&void 0!==Y?Y:[],callInterceptorProviders:null!==(X=et.callOptions.interceptor_providers)&&void 0!==X?X:[]},ei=(0,V.getInterceptingCall)(en,et.methodDefinition,et.callOptions,et.channel);er.call=ei;let es=null,ea=!1,eo=Error();return ei.start(et.metadata,{onReceiveMetadata:S=>{er.emit("metadata",S)},onReceiveMessage(S){null!==es&&ei.cancelWithStatus(M.Status.INTERNAL,"Too many responses received"),es=S},onReceiveStatus(S){if(!ea){if(ea=!0,S.code===M.Status.OK){if(null===es){let T=getErrorStackString(eo);et.callback((0,P.callErrorFromStatus)({code:M.Status.INTERNAL,details:"No message received",metadata:S.metadata},T))}else et.callback(null,es)}else{let T=getErrorStackString(eo);et.callback((0,P.callErrorFromStatus)(S,T))}eo=null,er.emit("status",S)}}}),ei.sendMessage(O),ei.halfClose(),er}makeClientStreamRequest(S,T,R,O,N,L){var $,Y;let X=this.checkOptionalUnaryResponseArguments(O,N,L),Z={path:S,requestStream:!0,responseStream:!1,requestSerialize:T,responseDeserialize:R},ee={metadata:X.metadata,call:new P.ClientWritableStreamImpl(T),channel:this[U],methodDefinition:Z,callOptions:X.options,callback:X.callback};this[Q]&&(ee=this[Q](ee));let et=ee.call,er={clientInterceptors:this[W],clientInterceptorProviders:this[K],callInterceptors:null!==($=ee.callOptions.interceptors)&&void 0!==$?$:[],callInterceptorProviders:null!==(Y=ee.callOptions.interceptor_providers)&&void 0!==Y?Y:[]},en=(0,V.getInterceptingCall)(er,ee.methodDefinition,ee.callOptions,ee.channel);et.call=en;let ei=null,es=!1,ea=Error();return en.start(ee.metadata,{onReceiveMetadata:S=>{et.emit("metadata",S)},onReceiveMessage(S){null!==ei&&en.cancelWithStatus(M.Status.INTERNAL,"Too many responses received"),ei=S},onReceiveStatus(S){if(!es){if(es=!0,S.code===M.Status.OK){if(null===ei){let T=getErrorStackString(ea);ee.callback((0,P.callErrorFromStatus)({code:M.Status.INTERNAL,details:"No message received",metadata:S.metadata},T))}else ee.callback(null,ei)}else{let T=getErrorStackString(ea);ee.callback((0,P.callErrorFromStatus)(S,T))}ea=null,et.emit("status",S)}}}),et}checkMetadataAndOptions(S,T){let R,P;return S instanceof L.Metadata?(R=S,P=T||{}):(P=S||{},R=new L.Metadata),{metadata:R,options:P}}makeServerStreamRequest(S,T,R,O,N,L){var $,Y;let X=this.checkMetadataAndOptions(N,L),Z={path:S,requestStream:!1,responseStream:!0,requestSerialize:T,responseDeserialize:R},ee={argument:O,metadata:X.metadata,call:new P.ClientReadableStreamImpl(R),channel:this[U],methodDefinition:Z,callOptions:X.options};this[Q]&&(ee=this[Q](ee));let et=ee.call,er={clientInterceptors:this[W],clientInterceptorProviders:this[K],callInterceptors:null!==($=ee.callOptions.interceptors)&&void 0!==$?$:[],callInterceptorProviders:null!==(Y=ee.callOptions.interceptor_providers)&&void 0!==Y?Y:[]},en=(0,V.getInterceptingCall)(er,ee.methodDefinition,ee.callOptions,ee.channel);et.call=en;let ei=!1,es=Error();return en.start(ee.metadata,{onReceiveMetadata(S){et.emit("metadata",S)},onReceiveMessage(S){et.push(S)},onReceiveStatus(S){if(!ei){if(ei=!0,et.push(null),S.code!==M.Status.OK){let T=getErrorStackString(es);et.emit("error",(0,P.callErrorFromStatus)(S,T))}es=null,et.emit("status",S)}}}),en.sendMessage(O),en.halfClose(),et}makeBidiStreamRequest(S,T,R,O,N){var L,$;let Y=this.checkMetadataAndOptions(O,N),X={path:S,requestStream:!0,responseStream:!0,requestSerialize:T,responseDeserialize:R},Z={metadata:Y.metadata,call:new P.ClientDuplexStreamImpl(T,R),channel:this[U],methodDefinition:X,callOptions:Y.options};this[Q]&&(Z=this[Q](Z));let ee=Z.call,et={clientInterceptors:this[W],clientInterceptorProviders:this[K],callInterceptors:null!==(L=Z.callOptions.interceptors)&&void 0!==L?L:[],callInterceptorProviders:null!==($=Z.callOptions.interceptor_providers)&&void 0!==$?$:[]},er=(0,V.getInterceptingCall)(et,Z.methodDefinition,Z.callOptions,Z.channel);ee.call=er;let en=!1,ei=Error();return er.start(Z.metadata,{onReceiveMetadata(S){ee.emit("metadata",S)},onReceiveMessage(S){ee.push(S)},onReceiveStatus(S){if(!en){if(en=!0,ee.push(null),S.code!==M.Status.OK){let T=getErrorStackString(ei);ee.emit("error",(0,P.callErrorFromStatus)(S,T))}ei=null,ee.emit("status",S)}}}),ee}};T.Client=Client},56702:(S,T)=>{"use strict";var R;Object.defineProperty(T,"__esModule",{value:!0}),T.CompressionAlgorithms=void 0,function(S){S[S.identity=0]="identity",S[S.deflate=1]="deflate",S[S.gzip=2]="gzip"}(R||(T.CompressionAlgorithms=R={}))},69718:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.CompressionFilterFactory=T.CompressionFilter=void 0;let P=R(59796),O=R(56702),N=R(69238),M=R(81818),L=R(68200),isCompressionAlgorithmKey=S=>"number"==typeof S&&"string"==typeof O.CompressionAlgorithms[S];let CompressionHandler=class CompressionHandler{async writeMessage(S,T){let R=S;T&&(R=await this.compressMessage(R));let P=Buffer.allocUnsafe(R.length+5);return P.writeUInt8(T?1:0,0),P.writeUInt32BE(R.length,1),R.copy(P,5),P}async readMessage(S){let T=1===S.readUInt8(0),R=S.slice(5);return T&&(R=await this.decompressMessage(R)),R}};let IdentityHandler=class IdentityHandler extends CompressionHandler{async compressMessage(S){return S}async writeMessage(S,T){let R=Buffer.allocUnsafe(S.length+5);return R.writeUInt8(0,0),R.writeUInt32BE(S.length,1),S.copy(R,5),R}decompressMessage(S){return Promise.reject(Error('Received compressed message but "grpc-encoding" header was identity'))}};let DeflateHandler=class DeflateHandler extends CompressionHandler{constructor(S){super(),this.maxRecvMessageLength=S}compressMessage(S){return new Promise((T,R)=>{P.deflate(S,(S,P)=>{S?R(S):T(P)})})}decompressMessage(S){return new Promise((T,R)=>{let O=0,M=[],L=P.createInflate();L.on("data",S=>{M.push(S),O+=S.byteLength,-1!==this.maxRecvMessageLength&&O>this.maxRecvMessageLength&&(L.destroy(),R({code:N.Status.RESOURCE_EXHAUSTED,details:`Received message that decompresses to a size larger than ${this.maxRecvMessageLength}`}))}),L.on("end",()=>{T(Buffer.concat(M))}),L.write(S),L.end()})}};let GzipHandler=class GzipHandler extends CompressionHandler{constructor(S){super(),this.maxRecvMessageLength=S}compressMessage(S){return new Promise((T,R)=>{P.gzip(S,(S,P)=>{S?R(S):T(P)})})}decompressMessage(S){return new Promise((T,R)=>{let O=0,M=[],L=P.createGunzip();L.on("data",S=>{M.push(S),O+=S.byteLength,-1!==this.maxRecvMessageLength&&O>this.maxRecvMessageLength&&(L.destroy(),R({code:N.Status.RESOURCE_EXHAUSTED,details:`Received message that decompresses to a size larger than ${this.maxRecvMessageLength}`}))}),L.on("end",()=>{T(Buffer.concat(M))}),L.write(S),L.end()})}};let UnknownHandler=class UnknownHandler extends CompressionHandler{constructor(S){super(),this.compressionName=S}compressMessage(S){return Promise.reject(Error(`Received message compressed with unsupported compression method ${this.compressionName}`))}decompressMessage(S){return Promise.reject(Error(`Compression method not supported: ${this.compressionName}`))}};function getCompressionHandler(S,T){switch(S){case"identity":return new IdentityHandler;case"deflate":return new DeflateHandler(T);case"gzip":return new GzipHandler(T);default:return new UnknownHandler(S)}}let CompressionFilter=class CompressionFilter extends M.BaseFilter{constructor(S,T){var R,P;super(),this.sharedFilterConfig=T,this.sendCompression=new IdentityHandler,this.receiveCompression=new IdentityHandler,this.currentCompressionAlgorithm="identity";let M=S["grpc.default_compression_algorithm"];if(this.maxReceiveMessageLength=null!==(R=S["grpc.max_receive_message_length"])&&void 0!==R?R:N.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH,void 0!==M){if(isCompressionAlgorithmKey(M)){let S=O.CompressionAlgorithms[M],R=null===(P=T.serverSupportedEncodingHeader)||void 0===P?void 0:P.split(",");(!R||R.includes(S))&&(this.currentCompressionAlgorithm=S,this.sendCompression=getCompressionHandler(this.currentCompressionAlgorithm,-1))}else L.log(N.LogVerbosity.ERROR,`Invalid value provided for grpc.default_compression_algorithm option: ${M}`)}}async sendMetadata(S){let T=await S;return T.set("grpc-accept-encoding","identity,deflate,gzip"),T.set("accept-encoding","identity"),"identity"===this.currentCompressionAlgorithm?T.remove("grpc-encoding"):T.set("grpc-encoding",this.currentCompressionAlgorithm),T}receiveMetadata(S){let T=S.get("grpc-encoding");if(T.length>0){let S=T[0];"string"==typeof S&&(this.receiveCompression=getCompressionHandler(S,this.maxReceiveMessageLength))}S.remove("grpc-encoding");let R=S.get("grpc-accept-encoding")[0];if(R){this.sharedFilterConfig.serverSupportedEncodingHeader=R;let S=R.split(",");S.includes(this.currentCompressionAlgorithm)||(this.sendCompression=new IdentityHandler,this.currentCompressionAlgorithm="identity")}return S.remove("grpc-accept-encoding"),S}async sendMessage(S){var T;let R;let P=await S;return R=!(this.sendCompression instanceof IdentityHandler)&&((null!==(T=P.flags)&&void 0!==T?T:0)&2)==0,{message:await this.sendCompression.writeMessage(P.message,R),flags:P.flags}}async receiveMessage(S){return this.receiveCompression.readMessage(await S)}};T.CompressionFilter=CompressionFilter;let CompressionFilterFactory=class CompressionFilterFactory{constructor(S,T){this.options=T,this.sharedFilterConfig={}}createFilter(){return new CompressionFilter(this.options,this.sharedFilterConfig)}};T.CompressionFilterFactory=CompressionFilterFactory},91360:(S,T)=>{"use strict";var R;Object.defineProperty(T,"__esModule",{value:!0}),T.ConnectivityState=void 0,function(S){S[S.IDLE=0]="IDLE",S[S.CONNECTING=1]="CONNECTING",S[S.READY=2]="READY",S[S.TRANSIENT_FAILURE=3]="TRANSIENT_FAILURE",S[S.SHUTDOWN=4]="SHUTDOWN"}(R||(T.ConnectivityState=R={}))},69238:(S,T)=>{"use strict";var R,P,O;Object.defineProperty(T,"__esModule",{value:!0}),T.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH=T.DEFAULT_MAX_SEND_MESSAGE_LENGTH=T.Propagate=T.LogVerbosity=T.Status=void 0,function(S){S[S.OK=0]="OK",S[S.CANCELLED=1]="CANCELLED",S[S.UNKNOWN=2]="UNKNOWN",S[S.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",S[S.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",S[S.NOT_FOUND=5]="NOT_FOUND",S[S.ALREADY_EXISTS=6]="ALREADY_EXISTS",S[S.PERMISSION_DENIED=7]="PERMISSION_DENIED",S[S.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",S[S.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",S[S.ABORTED=10]="ABORTED",S[S.OUT_OF_RANGE=11]="OUT_OF_RANGE",S[S.UNIMPLEMENTED=12]="UNIMPLEMENTED",S[S.INTERNAL=13]="INTERNAL",S[S.UNAVAILABLE=14]="UNAVAILABLE",S[S.DATA_LOSS=15]="DATA_LOSS",S[S.UNAUTHENTICATED=16]="UNAUTHENTICATED"}(R||(T.Status=R={})),function(S){S[S.DEBUG=0]="DEBUG",S[S.INFO=1]="INFO",S[S.ERROR=2]="ERROR",S[S.NONE=3]="NONE"}(P||(T.LogVerbosity=P={})),function(S){S[S.DEADLINE=1]="DEADLINE",S[S.CENSUS_STATS_CONTEXT=2]="CENSUS_STATS_CONTEXT",S[S.CENSUS_TRACING_CONTEXT=4]="CENSUS_TRACING_CONTEXT",S[S.CANCELLATION=8]="CANCELLATION",S[S.DEFAULTS=65535]="DEFAULTS"}(O||(T.Propagate=O={})),T.DEFAULT_MAX_SEND_MESSAGE_LENGTH=-1,T.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH=4194304},6614:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.restrictControlPlaneStatusCode=void 0;let P=R(69238),O=[P.Status.OK,P.Status.INVALID_ARGUMENT,P.Status.NOT_FOUND,P.Status.ALREADY_EXISTS,P.Status.FAILED_PRECONDITION,P.Status.ABORTED,P.Status.OUT_OF_RANGE,P.Status.DATA_LOSS];function restrictControlPlaneStatusCode(S,T){return O.includes(S)?{code:P.Status.INTERNAL,details:`Invalid status from control plane: ${S} ${P.Status[S]} ${T}`}:{code:S,details:T}}T.restrictControlPlaneStatusCode=restrictControlPlaneStatusCode},50823:(S,T)=>{"use strict";function minDeadline(...S){let T=1/0;for(let R of S){let S=R instanceof Date?R.getTime():R;S<T&&(T=S)}return T}Object.defineProperty(T,"__esModule",{value:!0}),T.deadlineToString=T.getRelativeTimeout=T.getDeadlineTimeoutString=T.minDeadline=void 0,T.minDeadline=minDeadline;let R=[["m",1],["S",1e3],["M",6e4],["H",36e5]];function getDeadlineTimeoutString(S){let T=new Date().getTime();S instanceof Date&&(S=S.getTime());let P=Math.max(S-T,0);for(let[S,T]of R){let R=P/T;if(R<1e8)return String(Math.ceil(R))+S}throw Error("Deadline is too far in the future")}T.getDeadlineTimeoutString=getDeadlineTimeoutString;let P=2147483647;function getRelativeTimeout(S){let T=S instanceof Date?S.getTime():S,R=new Date().getTime(),O=T-R;return O<0?0:O>P?1/0:O}function deadlineToString(S){if(S instanceof Date)return S.toISOString();{let T=new Date(S);return Number.isNaN(T.getTime())?""+S:T.toISOString()}}T.getRelativeTimeout=getRelativeTimeout,T.deadlineToString=deadlineToString},89589:(S,T)=>{"use strict";function msToDuration(S){return{seconds:S/1e3|0,nanos:S%1e3*1e6|0}}function durationToMs(S){return 1e3*S.seconds+S.nanos/1e6|0}function isDuration(S){return"number"==typeof S.seconds&&"number"==typeof S.nanos}Object.defineProperty(T,"__esModule",{value:!0}),T.isDuration=T.durationToMs=T.msToDuration=void 0,T.msToDuration=msToDuration,T.durationToMs=durationToMs,T.isDuration=isDuration},9006:(S,T)=>{"use strict";function getErrorMessage(S){return S instanceof Error?S.message:String(S)}function getErrorCode(S){return"object"==typeof S&&null!==S&&"code"in S&&"number"==typeof S.code?S.code:null}Object.defineProperty(T,"__esModule",{value:!0}),T.getErrorCode=T.getErrorMessage=void 0,T.getErrorMessage=getErrorMessage,T.getErrorCode=getErrorCode},86868:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.OutlierDetectionLoadBalancingConfig=T.BaseSubchannelWrapper=T.registerAdminService=T.FilterStackFactory=T.BaseFilter=T.PickResultType=T.QueuePicker=T.UnavailablePicker=T.ChildLoadBalancerHandler=T.subchannelAddressToString=T.validateLoadBalancingConfig=T.getFirstUsableConfig=T.registerLoadBalancerType=T.createChildChannelControlHelper=T.BackoffTimeout=T.durationToMs=T.uriToString=T.createResolver=T.registerResolver=T.log=T.trace=void 0;var P=R(68200);Object.defineProperty(T,"trace",{enumerable:!0,get:function(){return P.trace}}),Object.defineProperty(T,"log",{enumerable:!0,get:function(){return P.log}});var O=R(14755);Object.defineProperty(T,"registerResolver",{enumerable:!0,get:function(){return O.registerResolver}}),Object.defineProperty(T,"createResolver",{enumerable:!0,get:function(){return O.createResolver}});var N=R(14717);Object.defineProperty(T,"uriToString",{enumerable:!0,get:function(){return N.uriToString}});var M=R(89589);Object.defineProperty(T,"durationToMs",{enumerable:!0,get:function(){return M.durationToMs}});var L=R(77257);Object.defineProperty(T,"BackoffTimeout",{enumerable:!0,get:function(){return L.BackoffTimeout}});var V=R(77203);Object.defineProperty(T,"createChildChannelControlHelper",{enumerable:!0,get:function(){return V.createChildChannelControlHelper}}),Object.defineProperty(T,"registerLoadBalancerType",{enumerable:!0,get:function(){return V.registerLoadBalancerType}}),Object.defineProperty(T,"getFirstUsableConfig",{enumerable:!0,get:function(){return V.getFirstUsableConfig}}),Object.defineProperty(T,"validateLoadBalancingConfig",{enumerable:!0,get:function(){return V.validateLoadBalancingConfig}});var U=R(72782);Object.defineProperty(T,"subchannelAddressToString",{enumerable:!0,get:function(){return U.subchannelAddressToString}});var W=R(38390);Object.defineProperty(T,"ChildLoadBalancerHandler",{enumerable:!0,get:function(){return W.ChildLoadBalancerHandler}});var K=R(32939);Object.defineProperty(T,"UnavailablePicker",{enumerable:!0,get:function(){return K.UnavailablePicker}}),Object.defineProperty(T,"QueuePicker",{enumerable:!0,get:function(){return K.QueuePicker}}),Object.defineProperty(T,"PickResultType",{enumerable:!0,get:function(){return K.PickResultType}});var Q=R(81818);Object.defineProperty(T,"BaseFilter",{enumerable:!0,get:function(){return Q.BaseFilter}});var $=R(4213);Object.defineProperty(T,"FilterStackFactory",{enumerable:!0,get:function(){return $.FilterStackFactory}});var Y=R(1605);Object.defineProperty(T,"registerAdminService",{enumerable:!0,get:function(){return Y.registerAdminService}});var X=R(69609);Object.defineProperty(T,"BaseSubchannelWrapper",{enumerable:!0,get:function(){return X.BaseSubchannelWrapper}});var Z=R(35683);Object.defineProperty(T,"OutlierDetectionLoadBalancingConfig",{enumerable:!0,get:function(){return Z.OutlierDetectionLoadBalancingConfig}})},4213:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.FilterStackFactory=T.FilterStack=void 0;let FilterStack=class FilterStack{constructor(S){this.filters=S}sendMetadata(S){let T=S;for(let S=0;S<this.filters.length;S++)T=this.filters[S].sendMetadata(T);return T}receiveMetadata(S){let T=S;for(let S=this.filters.length-1;S>=0;S--)T=this.filters[S].receiveMetadata(T);return T}sendMessage(S){let T=S;for(let S=0;S<this.filters.length;S++)T=this.filters[S].sendMessage(T);return T}receiveMessage(S){let T=S;for(let S=this.filters.length-1;S>=0;S--)T=this.filters[S].receiveMessage(T);return T}receiveTrailers(S){let T=S;for(let S=this.filters.length-1;S>=0;S--)T=this.filters[S].receiveTrailers(T);return T}push(S){this.filters.unshift(...S)}getFilters(){return this.filters}};T.FilterStack=FilterStack;let FilterStackFactory=class FilterStackFactory{constructor(S){this.factories=S}push(S){this.factories.unshift(...S)}clone(){return new FilterStackFactory([...this.factories])}createFilter(){return new FilterStack(this.factories.map(S=>S.createFilter()))}};T.FilterStackFactory=FilterStackFactory},81818:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.BaseFilter=void 0;let BaseFilter=class BaseFilter{async sendMetadata(S){return S}receiveMetadata(S){return S}async sendMessage(S){return S}async receiveMessage(S){return S}receiveTrailers(S){return S}};T.BaseFilter=BaseFilter},18304:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.getProxiedConnection=T.mapProxyName=void 0;let P=R(68200),O=R(69238),N=R(14755),M=R(13685),L=R(24404),V=R(68200),U=R(72782),W=R(14717),K=R(57310),Q=R(84988),$="proxy";function trace(S){V.trace(O.LogVerbosity.DEBUG,$,S)}function getProxyInfo(){let S,T="",R="";if(process.env.grpc_proxy)R="grpc_proxy",T=process.env.grpc_proxy;else if(process.env.https_proxy)R="https_proxy",T=process.env.https_proxy;else{if(!process.env.http_proxy)return{};R="http_proxy",T=process.env.http_proxy}try{S=new K.URL(T)}catch(S){return(0,P.log)(O.LogVerbosity.ERROR,`cannot parse value of "${R}" env var`),{}}if("http:"!==S.protocol)return(0,P.log)(O.LogVerbosity.ERROR,`"${S.protocol}" scheme not supported in proxy URI`),{};let N=null;S.username&&(S.password?((0,P.log)(O.LogVerbosity.INFO,"userinfo found in proxy URI"),N=`${S.username}:${S.password}`):N=S.username);let M=S.hostname,L=S.port;""===L&&(L="80");let V={address:`${M}:${L}`};return N&&(V.creds=N),trace("Proxy server "+V.address+" set by environment variable "+R),V}function getNoProxyHostList(){let S=process.env.no_grpc_proxy,T="no_grpc_proxy";return(S||(S=process.env.no_proxy,T="no_proxy"),S)?(trace("No proxy server list set by environment variable "+T),S.split(",")):[]}function mapProxyName(S,T){var R;let P={target:S,extraOptions:{}};if((null!==(R=T["grpc.enable_http_proxy"])&&void 0!==R?R:1)===0||"unix"===S.scheme)return P;let O=getProxyInfo();if(!O.address)return P;let N=(0,W.splitHostPort)(S.path);if(!N)return P;let M=N.host;for(let T of getNoProxyHostList())if(T===M)return trace("Not using proxy for target in no_proxy list: "+(0,W.uriToString)(S)),P;let L={"grpc.http_connect_target":(0,W.uriToString)(S)};return O.creds&&(L["grpc.http_connect_creds"]=O.creds),{target:{scheme:"dns",path:O.address},extraOptions:L}}function getProxiedConnection(S,T,R){var V;if(!("grpc.http_connect_target"in T))return Promise.resolve({});let K=T["grpc.http_connect_target"],$=(0,W.parseUri)(K);if(null===$)return Promise.resolve({});let Y=(0,W.splitHostPort)($.path);if(null===Y)return Promise.resolve({});let X=`${Y.host}:${null!==(V=Y.port)&&void 0!==V?V:Q.DEFAULT_PORT}`,Z={method:"CONNECT",path:X},ee={Host:X};(0,U.isTcpSubchannelAddress)(S)?(Z.host=S.host,Z.port=S.port):Z.socketPath=S.path,"grpc.http_connect_creds"in T&&(ee["Proxy-Authorization"]="Basic "+Buffer.from(T["grpc.http_connect_creds"]).toString("base64")),Z.headers=ee;let et=(0,U.subchannelAddressToString)(S);return trace("Using proxy "+et+" to connect to "+Z.path),new Promise((S,T)=>{let V=M.request(Z);V.once("connect",(M,U,K)=>{var Q;if(V.removeAllListeners(),U.removeAllListeners(),200===M.statusCode){if(trace("Successfully connected to "+Z.path+" through proxy "+et),"secureContext"in R){let P=(0,N.getDefaultAuthority)($),O=(0,W.splitHostPort)(P),M=null!==(Q=null==O?void 0:O.host)&&void 0!==Q?Q:P,V=L.connect(Object.assign({host:M,servername:M,socket:U},R),()=>{trace("Successfully established a TLS connection to "+Z.path+" through proxy "+et),S({socket:V,realTarget:$})});V.on("error",S=>{trace("Failed to establish a TLS connection to "+Z.path+" through proxy "+et+" with error "+S.message),T()})}else trace("Successfully established a plaintext connection to "+Z.path+" through proxy "+et),S({socket:U,realTarget:$})}else(0,P.log)(O.LogVerbosity.ERROR,"Failed to connect to "+Z.path+" through proxy "+et+" with status "+M.statusCode),T()}),V.once("error",S=>{V.removeAllListeners(),(0,P.log)(O.LogVerbosity.ERROR,"Failed to connect to proxy "+et+" with error "+S.message),T()}),V.end()})}T.mapProxyName=mapProxyName,T.getProxiedConnection=getProxiedConnection},16063:(S,T,R)=>{"use strict";Z={value:!0},Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=Z=T.Rz=Z=Z=Z=Z=Z=Z=T.SF=T.K9=void 0;let P=R(68612);Z={enumerable:!0,get:function(){return P.CallCredentials}};let O=R(49914);Z={enumerable:!0,get:function(){return O.ChannelImplementation}};let N=R(56702);Z={enumerable:!0,get:function(){return N.CompressionAlgorithms}};let M=R(91360);Z={enumerable:!0,get:function(){return M.ConnectivityState}};let L=R(77021);Z={enumerable:!0,get:function(){return L.ChannelCredentials}};let V=R(47307);Z={enumerable:!0,get:function(){return V.Client}};let U=R(69238);Z={enumerable:!0,get:function(){return U.LogVerbosity}},Z={enumerable:!0,get:function(){return U.Status}},Z={enumerable:!0,get:function(){return U.Propagate}};let W=R(68200),K=R(47697);Object.defineProperty(T,"Rz",{enumerable:!0,get:function(){return K.loadPackageDefinition}}),Z={enumerable:!0,get:function(){return K.makeClientConstructor}},Z={enumerable:!0,get:function(){return K.makeClientConstructor}};let Q=R(32908);Object.defineProperty(T,"SF",{enumerable:!0,get:function(){return Q.Metadata}});let $=R(92903);Z={enumerable:!0,get:function(){return $.Server}};let Y=R(62501);Z={enumerable:!0,get:function(){return Y.ServerCredentials}};let X=R(9929);Z={enumerable:!0,get:function(){return X.StatusBuilder}},T.K9={combineChannelCredentials:(S,...T)=>T.reduce((S,T)=>S.compose(T),S),combineCallCredentials:(S,...T)=>T.reduce((S,T)=>S.compose(T),S),createInsecure:L.ChannelCredentials.createInsecure,createSsl:L.ChannelCredentials.createSsl,createFromSecureContext:L.ChannelCredentials.createFromSecureContext,createFromMetadataGenerator:P.CallCredentials.createFromMetadataGenerator,createFromGoogleCredential:P.CallCredentials.createFromGoogleCredential,createEmpty:P.CallCredentials.createEmpty};let closeClient=S=>S.close();Z=closeClient;let waitForClientReady=(S,T,R)=>S.waitForReady(T,R);Z=waitForClientReady;let loadObject=(S,T)=>{throw Error("Not available in this library. Use @grpc/proto-loader and loadPackageDefinition instead")};Z=loadObject;let load=(S,T,R)=>{throw Error("Not available in this library. Use @grpc/proto-loader and loadPackageDefinition instead")};Z=load;let setLogger=S=>{W.setLogger(S)};Z=setLogger;let setLogVerbosity=S=>{W.setLoggerVerbosity(S)};Z=setLogVerbosity;let getClientChannel=S=>V.Client.prototype.getChannel.call(S);Z=getClientChannel;var Z,ee=R(72158);Z={enumerable:!0,get:function(){return ee.ListenerBuilder}},Z={enumerable:!0,get:function(){return ee.RequesterBuilder}},Z={enumerable:!0,get:function(){return ee.InterceptingCall}},Z={enumerable:!0,get:function(){return ee.InterceptorConfigurationError}};var et=R(83316);Z={enumerable:!0,get:function(){return et.getChannelzServiceDefinition}},Z={enumerable:!0,get:function(){return et.getChannelzHandlers}};var er=R(1605);Z={enumerable:!0,get:function(){return er.addAdminServicesToServer}};let en=R(86868);Z=en;let ei=R(84988),es=R(50864),ea=R(6443),eo=R(72190),eu=R(19580),ec=R(35683),ed=R(83316);(()=>{ei.setup(),es.setup(),ea.setup(),eo.setup(),eu.setup(),ec.setup(),ed.setup()})()},35233:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.InternalChannel=void 0;let P=R(77021),O=R(61839),N=R(88364),M=R(32939),L=R(69238),V=R(4213),U=R(69718),W=R(14755),K=R(68200),Q=R(18304),$=R(14717),Y=R(91360),X=R(83316),Z=R(80439),ee=R(50823),et=R(65700),er=R(60060),en=R(6614),ei=R(97564),es=R(69609),ea=2147483647,eo=1e3,eu=18e5,ec=new Map,ed=16777216,eh=1048576;let ChannelSubchannelWrapper=class ChannelSubchannelWrapper extends es.BaseSubchannelWrapper{constructor(S,T){super(S),this.channel=T,this.refCount=0,this.subchannelStateListener=(S,R,P,O)=>{T.throttleKeepalive(O)},S.addConnectivityStateListener(this.subchannelStateListener)}ref(){this.child.ref(),this.refCount+=1}unref(){this.child.unref(),this.refCount-=1,this.refCount<=0&&(this.child.removeConnectivityStateListener(this.subchannelStateListener),this.channel.removeWrappedSubchannel(this))}};let InternalChannel=class InternalChannel{constructor(S,T,R){var Z,ee,et,er,es,ep,ef,em;if(this.credentials=T,this.options=R,this.connectivityState=Y.ConnectivityState.IDLE,this.currentPicker=new M.UnavailablePicker,this.configSelectionQueue=[],this.pickQueue=[],this.connectivityStateWatchers=[],this.configSelector=null,this.currentResolutionError=null,this.wrappedSubchannels=new Set,this.callCount=0,this.idleTimer=null,this.channelzEnabled=!0,this.callTracker=new X.ChannelzCallTracker,this.childrenTracker=new X.ChannelzChildrenTracker,"string"!=typeof S)throw TypeError("Channel target must be a string");if(!(T instanceof P.ChannelCredentials))throw TypeError("Channel credentials must be a ChannelCredentials object");if(R&&"object"!=typeof R)throw TypeError("Channel options must be an object");this.originalTarget=S;let eg=(0,$.parseUri)(S);if(null===eg)throw Error(`Could not parse target name "${S}"`);let ey=(0,W.mapUriDefaultScheme)(eg);if(null===ey)throw Error(`Could not find a default scheme for target name "${S}"`);this.callRefTimer=setInterval(()=>{},ea),null===(ee=(Z=this.callRefTimer).unref)||void 0===ee||ee.call(Z),0===this.options["grpc.enable_channelz"]&&(this.channelzEnabled=!1),this.channelzTrace=new X.ChannelzTrace,this.channelzRef=(0,X.registerChannelzChannel)(S,()=>this.getChannelzInfo(),this.channelzEnabled),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Channel created"),this.options["grpc.default_authority"]?this.defaultAuthority=this.options["grpc.default_authority"]:this.defaultAuthority=(0,W.getDefaultAuthority)(ey);let ev=(0,Q.mapProxyName)(ey,R);this.target=ev.target,this.options=Object.assign({},this.options,ev.extraOptions),this.subchannelPool=(0,N.getSubchannelPool)((null!==(et=R["grpc.use_local_subchannel_pool"])&&void 0!==et?et:0)===0),this.retryBufferTracker=new ei.MessageBufferTracker(null!==(er=R["grpc.retry_buffer_size"])&&void 0!==er?er:ed,null!==(es=R["grpc.per_rpc_retry_buffer_size"])&&void 0!==es?es:eh),this.keepaliveTime=null!==(ep=R["grpc.keepalive_time_ms"])&&void 0!==ep?ep:-1,this.idleTimeoutMs=Math.max(null!==(ef=R["grpc.client_idle_timeout_ms"])&&void 0!==ef?ef:eu,eo);let eS={createSubchannel:(S,T)=>{let R=this.subchannelPool.getOrCreateSubchannel(this.target,S,Object.assign({},this.options,T),this.credentials);R.throttleKeepalive(this.keepaliveTime),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Created subchannel or used existing subchannel",R.getChannelzRef());let P=new ChannelSubchannelWrapper(R,this);return this.wrappedSubchannels.add(P),P},updateState:(S,T)=>{this.currentPicker=T;let R=this.pickQueue.slice();for(let S of(this.pickQueue=[],R.length>0&&this.callRefTimerUnref(),R))S.doPick();this.updateState(S)},requestReresolution:()=>{throw Error("Resolving load balancer should never call requestReresolution")},addChannelzChild:S=>{this.channelzEnabled&&this.childrenTracker.refChild(S)},removeChannelzChild:S=>{this.channelzEnabled&&this.childrenTracker.unrefChild(S)}};this.resolvingLoadBalancer=new O.ResolvingLoadBalancer(this.target,eS,R,(S,T)=>{S.retryThrottling?ec.set(this.getTarget(),new ei.RetryThrottler(S.retryThrottling.maxTokens,S.retryThrottling.tokenRatio,ec.get(this.getTarget()))):ec.delete(this.getTarget()),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Address resolution succeeded"),this.configSelector=T,this.currentResolutionError=null,process.nextTick(()=>{let S=this.configSelectionQueue;for(let T of(this.configSelectionQueue=[],S.length>0&&this.callRefTimerUnref(),S))T.getConfig()})},S=>{this.channelzEnabled&&this.channelzTrace.addTrace("CT_WARNING","Address resolution failed with code "+S.code+' and details "'+S.details+'"'),this.configSelectionQueue.length>0&&this.trace("Name resolution failed with calls queued for config selection"),null===this.configSelector&&(this.currentResolutionError=Object.assign(Object.assign({},(0,en.restrictControlPlaneStatusCode)(S.code,S.details)),{metadata:S.metadata}));let T=this.configSelectionQueue;for(let R of(this.configSelectionQueue=[],T.length>0&&this.callRefTimerUnref(),T))R.reportResolverError(S)}),this.filterStackFactory=new V.FilterStackFactory([new U.CompressionFilterFactory(this,this.options)]),this.trace("Channel constructed with options "+JSON.stringify(R,void 0,2));let eb=Error();(0,K.trace)(L.LogVerbosity.DEBUG,"channel_stacktrace","("+this.channelzRef.id+") Channel constructed \n"+(null===(em=eb.stack)||void 0===em?void 0:em.substring(eb.stack.indexOf("\n")+1))),this.lastActivityTimestamp=new Date}getChannelzInfo(){return{target:this.originalTarget,state:this.connectivityState,trace:this.channelzTrace,callTracker:this.callTracker,children:this.childrenTracker.getChildLists()}}trace(S,T){(0,K.trace)(null!=T?T:L.LogVerbosity.DEBUG,"channel","("+this.channelzRef.id+") "+(0,$.uriToString)(this.target)+" "+S)}callRefTimerRef(){var S,T,R,P;(null===(T=(S=this.callRefTimer).hasRef)||void 0===T?void 0:T.call(S))||(this.trace("callRefTimer.ref | configSelectionQueue.length="+this.configSelectionQueue.length+" pickQueue.length="+this.pickQueue.length),null===(P=(R=this.callRefTimer).ref)||void 0===P||P.call(R))}callRefTimerUnref(){var S,T;(!this.callRefTimer.hasRef||this.callRefTimer.hasRef())&&(this.trace("callRefTimer.unref | configSelectionQueue.length="+this.configSelectionQueue.length+" pickQueue.length="+this.pickQueue.length),null===(T=(S=this.callRefTimer).unref)||void 0===T||T.call(S))}removeConnectivityStateWatcher(S){let T=this.connectivityStateWatchers.findIndex(T=>T===S);T>=0&&this.connectivityStateWatchers.splice(T,1)}updateState(S){(0,K.trace)(L.LogVerbosity.DEBUG,"connectivity_state","("+this.channelzRef.id+") "+(0,$.uriToString)(this.target)+" "+Y.ConnectivityState[this.connectivityState]+" -> "+Y.ConnectivityState[S]),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Connectivity state change to "+Y.ConnectivityState[S]),this.connectivityState=S;let T=this.connectivityStateWatchers.slice();for(let R of T)S!==R.currentState&&(R.timer&&clearTimeout(R.timer),this.removeConnectivityStateWatcher(R),R.callback());S!==Y.ConnectivityState.TRANSIENT_FAILURE&&(this.currentResolutionError=null)}throttleKeepalive(S){if(S>this.keepaliveTime)for(let T of(this.keepaliveTime=S,this.wrappedSubchannels))T.throttleKeepalive(S)}removeWrappedSubchannel(S){this.wrappedSubchannels.delete(S)}doPick(S,T){return this.currentPicker.pick({metadata:S,extraPickInfo:T})}queueCallForPick(S){this.pickQueue.push(S),this.callRefTimerRef()}getConfig(S,T){return(this.resolvingLoadBalancer.exitIdle(),this.configSelector)?{type:"SUCCESS",config:this.configSelector(S,T)}:this.currentResolutionError?{type:"ERROR",error:this.currentResolutionError}:{type:"NONE"}}queueCallForConfig(S){this.configSelectionQueue.push(S),this.callRefTimerRef()}enterIdle(){this.resolvingLoadBalancer.destroy(),this.updateState(Y.ConnectivityState.IDLE),this.currentPicker=new M.QueuePicker(this.resolvingLoadBalancer),this.idleTimer&&(clearTimeout(this.idleTimer),this.idleTimer=null)}startIdleTimeout(S){var T,R;this.idleTimer=setTimeout(()=>{if(this.callCount>0){this.startIdleTimeout(this.idleTimeoutMs);return}let S=new Date,T=S.valueOf()-this.lastActivityTimestamp.valueOf();T>=this.idleTimeoutMs?(this.trace("Idle timer triggered after "+this.idleTimeoutMs+"ms of inactivity"),this.enterIdle()):this.startIdleTimeout(this.idleTimeoutMs-T)},S),null===(R=(T=this.idleTimer).unref)||void 0===R||R.call(T)}maybeStartIdleTimer(){this.connectivityState===Y.ConnectivityState.SHUTDOWN||this.idleTimer||this.startIdleTimeout(this.idleTimeoutMs)}onCallStart(){this.channelzEnabled&&this.callTracker.addCallStarted(),this.callCount+=1}onCallEnd(S){this.channelzEnabled&&(S.code===L.Status.OK?this.callTracker.addCallSucceeded():this.callTracker.addCallFailed()),this.callCount-=1,this.lastActivityTimestamp=new Date,this.maybeStartIdleTimer()}createLoadBalancingCall(S,T,R,P,O){let N=(0,er.getNextCallNumber)();return this.trace("createLoadBalancingCall ["+N+'] method="'+T+'"'),new Z.LoadBalancingCall(this,S,T,R,P,O,N)}createRetryingCall(S,T,R,P,O){let N=(0,er.getNextCallNumber)();return this.trace("createRetryingCall ["+N+'] method="'+T+'"'),new ei.RetryingCall(this,S,T,R,P,O,N,this.retryBufferTracker,ec.get(this.getTarget()))}createInnerCall(S,T,R,P,O){return 0===this.options["grpc.enable_retries"]?this.createLoadBalancingCall(S,T,R,P,O):this.createRetryingCall(S,T,R,P,O)}createResolvingCall(S,T,R,P,O){let N=(0,er.getNextCallNumber)();this.trace("createResolvingCall ["+N+'] method="'+S+'", deadline='+(0,ee.deadlineToString)(T));let M={deadline:T,flags:null!=O?O:L.Propagate.DEFAULTS,host:null!=R?R:this.defaultAuthority,parentCall:P},V=new et.ResolvingCall(this,S,M,this.filterStackFactory.clone(),this.credentials._getCallCredentials(),N);return this.onCallStart(),V.addStatusWatcher(S=>{this.onCallEnd(S)}),V}close(){this.resolvingLoadBalancer.destroy(),this.updateState(Y.ConnectivityState.SHUTDOWN),clearInterval(this.callRefTimer),this.idleTimer&&clearTimeout(this.idleTimer),this.channelzEnabled&&(0,X.unregisterChannelzRef)(this.channelzRef),this.subchannelPool.unrefUnusedSubchannels()}getTarget(){return(0,$.uriToString)(this.target)}getConnectivityState(S){let T=this.connectivityState;return S&&(this.resolvingLoadBalancer.exitIdle(),this.lastActivityTimestamp=new Date,this.maybeStartIdleTimer()),T}watchConnectivityState(S,T,R){if(this.connectivityState===Y.ConnectivityState.SHUTDOWN)throw Error("Channel has been shut down");let P=null;if(T!==1/0){let S=T instanceof Date?T:new Date(T),N=new Date;if(T===-1/0||S<=N){process.nextTick(R,Error("Deadline passed without connectivity state change"));return}P=setTimeout(()=>{this.removeConnectivityStateWatcher(O),R(Error("Deadline passed without connectivity state change"))},S.getTime()-N.getTime())}let O={currentState:S,callback:R,timer:P};this.connectivityStateWatchers.push(O)}getChannelzRef(){return this.channelzRef}createCall(S,T,R,P,O){if("string"!=typeof S)throw TypeError("Channel#createCall: method must be a string");if(!("number"==typeof T||T instanceof Date))throw TypeError("Channel#createCall: deadline must be a number or Date");if(this.connectivityState===Y.ConnectivityState.SHUTDOWN)throw Error("Channel has been shut down");return this.createResolvingCall(S,T,R,P,O)}};T.InternalChannel=InternalChannel},38390:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ChildLoadBalancerHandler=void 0;let P=R(77203),O=R(91360),N="child_load_balancer_helper";let ChildLoadBalancerHandler=class ChildLoadBalancerHandler{constructor(S){this.channelControlHelper=S,this.currentChild=null,this.pendingChild=null,this.latestConfig=null,this.ChildPolicyHelper=class{constructor(S){this.parent=S,this.child=null}createSubchannel(S,T){return this.parent.channelControlHelper.createSubchannel(S,T)}updateState(S,T){var R;if(this.calledByPendingChild()){if(S===O.ConnectivityState.CONNECTING)return;null===(R=this.parent.currentChild)||void 0===R||R.destroy(),this.parent.currentChild=this.parent.pendingChild,this.parent.pendingChild=null}else if(!this.calledByCurrentChild())return;this.parent.channelControlHelper.updateState(S,T)}requestReresolution(){var S;let T=null!==(S=this.parent.pendingChild)&&void 0!==S?S:this.parent.currentChild;this.child===T&&this.parent.channelControlHelper.requestReresolution()}setChild(S){this.child=S}addChannelzChild(S){this.parent.channelControlHelper.addChannelzChild(S)}removeChannelzChild(S){this.parent.channelControlHelper.removeChannelzChild(S)}calledByPendingChild(){return this.child===this.parent.pendingChild}calledByCurrentChild(){return this.child===this.parent.currentChild}}}configUpdateRequiresNewPolicyInstance(S,T){return S.getLoadBalancerName()!==T.getLoadBalancerName()}updateAddressList(S,T,R){let O;if(null===this.currentChild||null===this.latestConfig||this.configUpdateRequiresNewPolicyInstance(this.latestConfig,T)){let S=new this.ChildPolicyHelper(this),R=(0,P.createLoadBalancer)(T,S);S.setChild(R),null===this.currentChild?(this.currentChild=R,O=this.currentChild):(this.pendingChild&&this.pendingChild.destroy(),this.pendingChild=R,O=this.pendingChild)}else O=null===this.pendingChild?this.currentChild:this.pendingChild;this.latestConfig=T,O.updateAddressList(S,T,R)}exitIdle(){this.currentChild&&(this.currentChild.exitIdle(),this.pendingChild&&this.pendingChild.exitIdle())}resetBackoff(){this.currentChild&&(this.currentChild.resetBackoff(),this.pendingChild&&this.pendingChild.resetBackoff())}destroy(){this.currentChild&&(this.currentChild.destroy(),this.currentChild=null),this.pendingChild&&(this.pendingChild.destroy(),this.pendingChild=null)}getTypeName(){return N}};T.ChildLoadBalancerHandler=ChildLoadBalancerHandler},35683:(S,T,R)=>{"use strict";var P;Object.defineProperty(T,"__esModule",{value:!0}),T.setup=T.OutlierDetectionLoadBalancer=T.OutlierDetectionLoadBalancingConfig=void 0;let O=R(91360),N=R(69238),M=R(89589),L=R(86868),V=R(77203),U=R(38390),W=R(32939),K=R(72782),Q=R(69609),$=R(68200),Y="outlier_detection";function trace(S){$.trace(N.LogVerbosity.DEBUG,Y,S)}let X="outlier_detection",Z=(null!==(P=process.env.GRPC_EXPERIMENTAL_ENABLE_OUTLIER_DETECTION)&&void 0!==P?P:"true")==="true",ee={stdev_factor:1900,enforcement_percentage:100,minimum_hosts:5,request_volume:100},et={threshold:85,enforcement_percentage:100,minimum_hosts:5,request_volume:50};function validateFieldType(S,T,R,P){if(T in S&&typeof S[T]!==R){let O=P?`${P}.${T}`:T;throw Error(`outlier detection config ${O} parse error: expected ${R}, got ${typeof S[T]}`)}}function validatePositiveDuration(S,T,R){let P=R?`${R}.${T}`:T;if(T in S){if(!(0,M.isDuration)(S[T]))throw Error(`outlier detection config ${P} parse error: expected Duration, got ${typeof S[T]}`);if(!(S[T].seconds>=0&&S[T].seconds<=315576e6&&S[T].nanos>=0&&S[T].nanos<=999999999))throw Error(`outlier detection config ${P} parse error: values out of range for non-negative Duaration`)}}function validatePercentage(S,T,R){let P=R?`${R}.${T}`:T;if(validateFieldType(S,T,"number",R),T in S&&!(S[T]>=0&&S[T]<=100))throw Error(`outlier detection config ${P} parse error: value out of range for percentage (0-100)`)}let OutlierDetectionLoadBalancingConfig=class OutlierDetectionLoadBalancingConfig{constructor(S,T,R,P,O,N,M){if(this.childPolicy=M,M.length>0&&"pick_first"===M[0].getLoadBalancerName())throw Error("outlier_detection LB policy cannot have a pick_first child policy");this.intervalMs=null!=S?S:1e4,this.baseEjectionTimeMs=null!=T?T:3e4,this.maxEjectionTimeMs=null!=R?R:3e5,this.maxEjectionPercent=null!=P?P:10,this.successRateEjection=O?Object.assign(Object.assign({},ee),O):null,this.failurePercentageEjection=N?Object.assign(Object.assign({},et),N):null}getLoadBalancerName(){return X}toJsonObject(){return{interval:(0,M.msToDuration)(this.intervalMs),base_ejection_time:(0,M.msToDuration)(this.baseEjectionTimeMs),max_ejection_time:(0,M.msToDuration)(this.maxEjectionTimeMs),max_ejection_percent:this.maxEjectionPercent,success_rate_ejection:this.successRateEjection,failure_percentage_ejection:this.failurePercentageEjection,child_policy:this.childPolicy.map(S=>S.toJsonObject())}}getIntervalMs(){return this.intervalMs}getBaseEjectionTimeMs(){return this.baseEjectionTimeMs}getMaxEjectionTimeMs(){return this.maxEjectionTimeMs}getMaxEjectionPercent(){return this.maxEjectionPercent}getSuccessRateEjectionConfig(){return this.successRateEjection}getFailurePercentageEjectionConfig(){return this.failurePercentageEjection}getChildPolicy(){return this.childPolicy}copyWithChildPolicy(S){return new OutlierDetectionLoadBalancingConfig(this.intervalMs,this.baseEjectionTimeMs,this.maxEjectionTimeMs,this.maxEjectionPercent,this.successRateEjection,this.failurePercentageEjection,S)}static createFromJson(S){var T;if(validatePositiveDuration(S,"interval"),validatePositiveDuration(S,"base_ejection_time"),validatePositiveDuration(S,"max_ejection_time"),validatePercentage(S,"max_ejection_percent"),"success_rate_ejection"in S){if("object"!=typeof S.success_rate_ejection)throw Error("outlier detection config success_rate_ejection must be an object");validateFieldType(S.success_rate_ejection,"stdev_factor","number","success_rate_ejection"),validatePercentage(S.success_rate_ejection,"enforcement_percentage","success_rate_ejection"),validateFieldType(S.success_rate_ejection,"minimum_hosts","number","success_rate_ejection"),validateFieldType(S.success_rate_ejection,"request_volume","number","success_rate_ejection")}if("failure_percentage_ejection"in S){if("object"!=typeof S.failure_percentage_ejection)throw Error("outlier detection config failure_percentage_ejection must be an object");validatePercentage(S.failure_percentage_ejection,"threshold","failure_percentage_ejection"),validatePercentage(S.failure_percentage_ejection,"enforcement_percentage","failure_percentage_ejection"),validateFieldType(S.failure_percentage_ejection,"minimum_hosts","number","failure_percentage_ejection"),validateFieldType(S.failure_percentage_ejection,"request_volume","number","failure_percentage_ejection")}return new OutlierDetectionLoadBalancingConfig(S.interval?(0,M.durationToMs)(S.interval):null,S.base_ejection_time?(0,M.durationToMs)(S.base_ejection_time):null,S.max_ejection_time?(0,M.durationToMs)(S.max_ejection_time):null,null!==(T=S.max_ejection_percent)&&void 0!==T?T:null,S.success_rate_ejection,S.failure_percentage_ejection,S.child_policy.map(V.validateLoadBalancingConfig))}};T.OutlierDetectionLoadBalancingConfig=OutlierDetectionLoadBalancingConfig;let OutlierDetectionSubchannelWrapper=class OutlierDetectionSubchannelWrapper extends Q.BaseSubchannelWrapper{constructor(S,T){super(S),this.mapEntry=T,this.stateListeners=[],this.ejected=!1,this.refCount=0,this.childSubchannelState=S.getConnectivityState(),S.addConnectivityStateListener((S,T,R,P)=>{if(this.childSubchannelState=R,!this.ejected)for(let S of this.stateListeners)S(this,T,R,P)})}getConnectivityState(){return this.ejected?O.ConnectivityState.TRANSIENT_FAILURE:this.childSubchannelState}addConnectivityStateListener(S){this.stateListeners.push(S)}removeConnectivityStateListener(S){let T=this.stateListeners.indexOf(S);T>-1&&this.stateListeners.splice(T,1)}ref(){this.child.ref(),this.refCount+=1}unref(){if(this.child.unref(),this.refCount-=1,this.refCount<=0&&this.mapEntry){let S=this.mapEntry.subchannelWrappers.indexOf(this);S>=0&&this.mapEntry.subchannelWrappers.splice(S,1)}}eject(){for(let S of(this.ejected=!0,this.stateListeners))S(this,this.childSubchannelState,O.ConnectivityState.TRANSIENT_FAILURE,-1)}uneject(){for(let S of(this.ejected=!1,this.stateListeners))S(this,O.ConnectivityState.TRANSIENT_FAILURE,this.childSubchannelState,-1)}getMapEntry(){return this.mapEntry}getWrappedSubchannel(){return this.child}};function createEmptyBucket(){return{success:0,failure:0}}let CallCounter=class CallCounter{constructor(){this.activeBucket=createEmptyBucket(),this.inactiveBucket=createEmptyBucket()}addSuccess(){this.activeBucket.success+=1}addFailure(){this.activeBucket.failure+=1}switchBuckets(){this.inactiveBucket=this.activeBucket,this.activeBucket=createEmptyBucket()}getLastSuccesses(){return this.inactiveBucket.success}getLastFailures(){return this.inactiveBucket.failure}};let OutlierDetectionPicker=class OutlierDetectionPicker{constructor(S,T){this.wrappedPicker=S,this.countCalls=T}pick(S){let T=this.wrappedPicker.pick(S);if(T.pickResultType!==W.PickResultType.COMPLETE)return T;{let S=T.subchannel,R=S.getMapEntry();if(!R)return Object.assign(Object.assign({},T),{subchannel:S.getWrappedSubchannel()});{let P=T.onCallEnded;return this.countCalls&&(P=S=>{var P;S===N.Status.OK?R.counter.addSuccess():R.counter.addFailure(),null===(P=T.onCallEnded)||void 0===P||P.call(T,S)}),Object.assign(Object.assign({},T),{subchannel:S.getWrappedSubchannel(),onCallEnded:P})}}}};let OutlierDetectionLoadBalancer=class OutlierDetectionLoadBalancer{constructor(S){this.addressMap=new Map,this.latestConfig=null,this.timerStartTime=null,this.childBalancer=new U.ChildLoadBalancerHandler((0,L.createChildChannelControlHelper)(S,{createSubchannel:(T,R)=>{let P=S.createSubchannel(T,R),O=this.addressMap.get((0,K.subchannelAddressToString)(T)),N=new OutlierDetectionSubchannelWrapper(P,O);return(null==O?void 0:O.currentEjectionTimestamp)!==null&&N.eject(),null==O||O.subchannelWrappers.push(N),N},updateState:(T,R)=>{T===O.ConnectivityState.READY?S.updateState(T,new OutlierDetectionPicker(R,this.isCountingEnabled())):S.updateState(T,R)}})),this.ejectionTimer=setInterval(()=>{},0),clearInterval(this.ejectionTimer)}isCountingEnabled(){return null!==this.latestConfig&&(null!==this.latestConfig.getSuccessRateEjectionConfig()||null!==this.latestConfig.getFailurePercentageEjectionConfig())}getCurrentEjectionPercent(){let S=0;for(let T of this.addressMap.values())null!==T.currentEjectionTimestamp&&(S+=1);return 100*S/this.addressMap.size}runSuccessRateCheck(S){if(!this.latestConfig)return;let T=this.latestConfig.getSuccessRateEjectionConfig();if(!T)return;trace("Running success rate check");let R=T.request_volume,P=0,O=[];for(let[S,T]of this.addressMap){let N=T.counter.getLastSuccesses(),M=T.counter.getLastFailures();trace("Stats for "+S+": successes="+N+" failures="+M+" targetRequestVolume="+R),N+M>=R&&(P+=1,O.push(N/(N+M)))}if(trace("Found "+P+" success rate candidates; currentEjectionPercent="+this.getCurrentEjectionPercent()+" successRates=["+O+"]"),P<T.minimum_hosts)return;let N=O.reduce((S,T)=>S+T)/O.length,M=0;for(let S of O){let T=S-N;M+=T*T}let L=M/O.length,V=Math.sqrt(L),U=N-V*(T.stdev_factor/1e3);for(let[P,O]of(trace("stdev="+V+" ejectionThreshold="+U),this.addressMap.entries())){if(this.getCurrentEjectionPercent()>=this.latestConfig.getMaxEjectionPercent())break;let N=O.counter.getLastSuccesses(),M=O.counter.getLastFailures();if(N+M<R)continue;let L=N/(N+M);if(trace("Checking candidate "+P+" successRate="+L),L<U){let R=100*Math.random();trace("Candidate "+P+" randomNumber="+R+" enforcement_percentage="+T.enforcement_percentage),R<T.enforcement_percentage&&(trace("Ejecting candidate "+P),this.eject(O,S))}}}runFailurePercentageCheck(S){if(!this.latestConfig)return;let T=this.latestConfig.getFailurePercentageEjectionConfig();if(!T)return;trace("Running failure percentage check. threshold="+T.threshold+" request volume threshold="+T.request_volume);let R=0;for(let S of this.addressMap.values()){let P=S.counter.getLastSuccesses(),O=S.counter.getLastFailures();P+O>=T.request_volume&&(R+=1)}if(!(R<T.minimum_hosts))for(let[R,P]of this.addressMap.entries()){if(this.getCurrentEjectionPercent()>=this.latestConfig.getMaxEjectionPercent())break;let O=P.counter.getLastSuccesses(),N=P.counter.getLastFailures();if(trace("Candidate successes="+O+" failures="+N),O+N<T.request_volume)continue;let M=100*N/(N+O);if(M>T.threshold){let O=100*Math.random();trace("Candidate "+R+" randomNumber="+O+" enforcement_percentage="+T.enforcement_percentage),O<T.enforcement_percentage&&(trace("Ejecting candidate "+R),this.eject(P,S))}}}eject(S,T){for(let T of(S.currentEjectionTimestamp=new Date,S.ejectionTimeMultiplier+=1,S.subchannelWrappers))T.eject()}uneject(S){for(let T of(S.currentEjectionTimestamp=null,S.subchannelWrappers))T.uneject()}switchAllBuckets(){for(let S of this.addressMap.values())S.counter.switchBuckets()}startTimer(S){var T,R;this.ejectionTimer=setTimeout(()=>this.runChecks(),S),null===(R=(T=this.ejectionTimer).unref)||void 0===R||R.call(T)}runChecks(){let S=new Date;if(trace("Ejection timer running"),this.switchAllBuckets(),this.latestConfig)for(let[T,R]of(this.timerStartTime=S,this.startTimer(this.latestConfig.getIntervalMs()),this.runSuccessRateCheck(S),this.runFailurePercentageCheck(S),this.addressMap.entries()))if(null===R.currentEjectionTimestamp)R.ejectionTimeMultiplier>0&&(R.ejectionTimeMultiplier-=1);else{let S=this.latestConfig.getBaseEjectionTimeMs(),P=this.latestConfig.getMaxEjectionTimeMs(),O=new Date(R.currentEjectionTimestamp.getTime());O.setMilliseconds(O.getMilliseconds()+Math.min(S*R.ejectionTimeMultiplier,Math.max(S,P))),O<new Date&&(trace("Unejecting "+T),this.uneject(R))}}updateAddressList(S,T,R){if(!(T instanceof OutlierDetectionLoadBalancingConfig))return;let P=new Set;for(let T of S)P.add((0,K.subchannelAddressToString)(T));for(let S of P)this.addressMap.has(S)||(trace("Adding map entry for "+S),this.addressMap.set(S,{counter:new CallCounter,currentEjectionTimestamp:null,ejectionTimeMultiplier:0,subchannelWrappers:[]}));for(let S of this.addressMap.keys())P.has(S)||(trace("Removing map entry for "+S),this.addressMap.delete(S));let O=(0,V.getFirstUsableConfig)(T.getChildPolicy(),!0);if(this.childBalancer.updateAddressList(S,O,R),T.getSuccessRateEjectionConfig()||T.getFailurePercentageEjectionConfig()){if(this.timerStartTime){trace("Previous timer existed. Replacing timer"),clearTimeout(this.ejectionTimer);let S=T.getIntervalMs()-(new Date().getTime()-this.timerStartTime.getTime());this.startTimer(S)}else trace("Starting new timer"),this.timerStartTime=new Date,this.startTimer(T.getIntervalMs()),this.switchAllBuckets()}else for(let S of(trace("Counting disabled. Cancelling timer."),this.timerStartTime=null,clearTimeout(this.ejectionTimer),this.addressMap.values()))this.uneject(S),S.ejectionTimeMultiplier=0;this.latestConfig=T}exitIdle(){this.childBalancer.exitIdle()}resetBackoff(){this.childBalancer.resetBackoff()}destroy(){clearTimeout(this.ejectionTimer),this.childBalancer.destroy()}getTypeName(){return X}};function setup(){Z&&(0,L.registerLoadBalancerType)(X,OutlierDetectionLoadBalancer,OutlierDetectionLoadBalancingConfig)}T.OutlierDetectionLoadBalancer=OutlierDetectionLoadBalancer,T.setup=setup},72190:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=T.PickFirstLoadBalancer=T.shuffled=T.PickFirstLoadBalancingConfig=void 0;let P=R(77203),O=R(91360),N=R(32939),M=R(68200),L=R(69238),V="pick_first";function trace(S){M.trace(L.LogVerbosity.DEBUG,V,S)}let U="pick_first",W=250;let PickFirstLoadBalancingConfig=class PickFirstLoadBalancingConfig{constructor(S){this.shuffleAddressList=S}getLoadBalancerName(){return U}toJsonObject(){return{[U]:{shuffleAddressList:this.shuffleAddressList}}}getShuffleAddressList(){return this.shuffleAddressList}static createFromJson(S){if("shuffleAddressList"in S&&"boolean"!=typeof S.shuffleAddressList)throw Error("pick_first config field shuffleAddressList must be a boolean if provided");return new PickFirstLoadBalancingConfig(!0===S.shuffleAddressList)}};T.PickFirstLoadBalancingConfig=PickFirstLoadBalancingConfig;let PickFirstPicker=class PickFirstPicker{constructor(S){this.subchannel=S}pick(S){return{pickResultType:N.PickResultType.COMPLETE,subchannel:this.subchannel,status:null,onCallStarted:null,onCallEnded:null}}};function shuffled(S){let T=S.slice();for(let S=T.length-1;S>1;S--){let R=Math.floor(Math.random()*(S+1)),P=T[S];T[S]=T[R],T[R]=P}return T}T.shuffled=shuffled;let PickFirstLoadBalancer=class PickFirstLoadBalancer{constructor(S){this.channelControlHelper=S,this.children=[],this.currentState=O.ConnectivityState.IDLE,this.currentSubchannelIndex=0,this.currentPick=null,this.subchannelStateListener=(S,T,R,P,O)=>{this.onSubchannelStateUpdate(S,T,R,O)},this.triedAllSubchannels=!1,this.stickyTransientFailureMode=!1,this.requestedResolutionSinceLastUpdate=!1,this.lastError=null,this.latestAddressList=null,this.connectionDelayTimeout=setTimeout(()=>{},0),clearTimeout(this.connectionDelayTimeout)}allChildrenHaveReportedTF(){return this.children.every(S=>S.hasReportedTransientFailure)}calculateAndReportNewState(){this.currentPick?this.updateState(O.ConnectivityState.READY,new PickFirstPicker(this.currentPick)):0===this.children.length?this.updateState(O.ConnectivityState.IDLE,new N.QueuePicker(this)):this.stickyTransientFailureMode?this.updateState(O.ConnectivityState.TRANSIENT_FAILURE,new N.UnavailablePicker({details:`No connection established. Last error: ${this.lastError}`})):this.updateState(O.ConnectivityState.CONNECTING,new N.QueuePicker(this))}requestReresolution(){this.requestedResolutionSinceLastUpdate=!0,this.channelControlHelper.requestReresolution()}maybeEnterStickyTransientFailureMode(){if(this.allChildrenHaveReportedTF()&&(this.requestedResolutionSinceLastUpdate||this.requestReresolution(),!this.stickyTransientFailureMode)){for(let{subchannel:S}of(this.stickyTransientFailureMode=!0,this.children))S.startConnecting();this.calculateAndReportNewState()}}removeCurrentPick(){if(null!==this.currentPick){let S=this.currentPick;this.currentPick=null,S.unref(),S.removeConnectivityStateListener(this.subchannelStateListener),this.channelControlHelper.removeChannelzChild(S.getChannelzRef())}}onSubchannelStateUpdate(S,T,R,P){var N;if(null===(N=this.currentPick)||void 0===N?void 0:N.realSubchannelEquals(S)){R!==O.ConnectivityState.READY&&(this.removeCurrentPick(),this.calculateAndReportNewState(),this.requestReresolution());return}for(let[T,N]of this.children.entries())if(S.realSubchannelEquals(N.subchannel)){R===O.ConnectivityState.READY&&this.pickSubchannel(N.subchannel),R===O.ConnectivityState.TRANSIENT_FAILURE&&(N.hasReportedTransientFailure=!0,P&&(this.lastError=P),this.maybeEnterStickyTransientFailureMode(),T===this.currentSubchannelIndex&&this.startNextSubchannelConnecting(T+1)),N.subchannel.startConnecting();return}}startNextSubchannelConnecting(S){if(clearTimeout(this.connectionDelayTimeout),!this.triedAllSubchannels){for(let[T,R]of this.children.entries())if(T>=S){let S=R.subchannel.getConnectivityState();if(S===O.ConnectivityState.IDLE||S===O.ConnectivityState.CONNECTING){this.startConnecting(T);return}}this.triedAllSubchannels=!0,this.maybeEnterStickyTransientFailureMode()}}startConnecting(S){var T,R;clearTimeout(this.connectionDelayTimeout),this.currentSubchannelIndex=S,this.children[S].subchannel.getConnectivityState()===O.ConnectivityState.IDLE&&(trace("Start connecting to subchannel with address "+this.children[S].subchannel.getAddress()),process.nextTick(()=>{var T;null===(T=this.children[S])||void 0===T||T.subchannel.startConnecting()})),this.connectionDelayTimeout=null===(R=(T=setTimeout(()=>{this.startNextSubchannelConnecting(S+1)},W)).unref)||void 0===R?void 0:R.call(T)}pickSubchannel(S){this.currentPick&&S.realSubchannelEquals(this.currentPick)||(trace("Pick subchannel with address "+S.getAddress()),this.stickyTransientFailureMode=!1,null!==this.currentPick&&(this.currentPick.unref(),this.channelControlHelper.removeChannelzChild(this.currentPick.getChannelzRef()),this.currentPick.removeConnectivityStateListener(this.subchannelStateListener)),this.currentPick=S,S.ref(),this.channelControlHelper.addChannelzChild(S.getChannelzRef()),this.resetSubchannelList(),clearTimeout(this.connectionDelayTimeout),this.calculateAndReportNewState())}updateState(S,T){trace(O.ConnectivityState[this.currentState]+" -> "+O.ConnectivityState[S]),this.currentState=S,this.channelControlHelper.updateState(S,T)}resetSubchannelList(){for(let S of this.children)this.currentPick&&S.subchannel.realSubchannelEquals(this.currentPick)||S.subchannel.removeConnectivityStateListener(this.subchannelStateListener),S.subchannel.unref(),this.channelControlHelper.removeChannelzChild(S.subchannel.getChannelzRef());this.currentSubchannelIndex=0,this.children=[],this.triedAllSubchannels=!1,this.requestedResolutionSinceLastUpdate=!1}connectToAddressList(S){let T=S.map(S=>({subchannel:this.channelControlHelper.createSubchannel(S,{}),hasReportedTransientFailure:!1}));for(let{subchannel:S}of T)S.ref(),this.channelControlHelper.addChannelzChild(S.getChannelzRef());for(let{subchannel:S}of(this.resetSubchannelList(),this.children=T,this.children))if(S.addConnectivityStateListener(this.subchannelStateListener),S.getConnectivityState()===O.ConnectivityState.READY){this.pickSubchannel(S);return}for(let S of this.children)S.subchannel.getConnectivityState()===O.ConnectivityState.TRANSIENT_FAILURE&&(S.hasReportedTransientFailure=!0);this.startNextSubchannelConnecting(0),this.calculateAndReportNewState()}updateAddressList(S,T){T instanceof PickFirstLoadBalancingConfig&&(T.getShuffleAddressList()&&(S=shuffled(S)),this.latestAddressList=S,this.connectToAddressList(S))}exitIdle(){this.currentState===O.ConnectivityState.IDLE&&this.latestAddressList&&this.connectToAddressList(this.latestAddressList)}resetBackoff(){}destroy(){this.resetSubchannelList(),this.removeCurrentPick()}getTypeName(){return U}};function setup(){(0,P.registerLoadBalancerType)(U,PickFirstLoadBalancer,PickFirstLoadBalancingConfig),(0,P.registerDefaultLoadBalancerType)(U)}T.PickFirstLoadBalancer=PickFirstLoadBalancer,T.setup=setup},19580:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=T.RoundRobinLoadBalancer=void 0;let P=R(77203),O=R(91360),N=R(32939),M=R(72782),L=R(68200),V=R(69238),U="round_robin";function trace(S){L.trace(V.LogVerbosity.DEBUG,U,S)}let W="round_robin";let RoundRobinLoadBalancingConfig=class RoundRobinLoadBalancingConfig{getLoadBalancerName(){return W}constructor(){}toJsonObject(){return{[W]:{}}}static createFromJson(S){return new RoundRobinLoadBalancingConfig}};let RoundRobinPicker=class RoundRobinPicker{constructor(S,T=0){this.subchannelList=S,this.nextIndex=T}pick(S){let T=this.subchannelList[this.nextIndex];return this.nextIndex=(this.nextIndex+1)%this.subchannelList.length,{pickResultType:N.PickResultType.COMPLETE,subchannel:T,status:null,onCallStarted:null,onCallEnded:null}}peekNextSubchannel(){return this.subchannelList[this.nextIndex]}};let RoundRobinLoadBalancer=class RoundRobinLoadBalancer{constructor(S){this.channelControlHelper=S,this.subchannels=[],this.currentState=O.ConnectivityState.IDLE,this.currentReadyPicker=null,this.lastError=null,this.subchannelStateListener=(S,T,R,P,N)=>{this.calculateAndUpdateState(),(R===O.ConnectivityState.TRANSIENT_FAILURE||R===O.ConnectivityState.IDLE)&&(N&&(this.lastError=N),this.channelControlHelper.requestReresolution(),S.startConnecting())}}countSubchannelsWithState(S){return this.subchannels.filter(T=>T.getConnectivityState()===S).length}calculateAndUpdateState(){if(this.countSubchannelsWithState(O.ConnectivityState.READY)>0){let S=this.subchannels.filter(S=>S.getConnectivityState()===O.ConnectivityState.READY),T=0;null!==this.currentReadyPicker&&(T=S.indexOf(this.currentReadyPicker.peekNextSubchannel()))<0&&(T=0),this.updateState(O.ConnectivityState.READY,new RoundRobinPicker(S,T))}else this.countSubchannelsWithState(O.ConnectivityState.CONNECTING)>0?this.updateState(O.ConnectivityState.CONNECTING,new N.QueuePicker(this)):this.countSubchannelsWithState(O.ConnectivityState.TRANSIENT_FAILURE)>0?this.updateState(O.ConnectivityState.TRANSIENT_FAILURE,new N.UnavailablePicker({details:`No connection established. Last error: ${this.lastError}`})):this.updateState(O.ConnectivityState.IDLE,new N.QueuePicker(this))}updateState(S,T){trace(O.ConnectivityState[this.currentState]+" -> "+O.ConnectivityState[S]),S===O.ConnectivityState.READY?this.currentReadyPicker=T:this.currentReadyPicker=null,this.currentState=S,this.channelControlHelper.updateState(S,T)}resetSubchannelList(){for(let S of this.subchannels)S.removeConnectivityStateListener(this.subchannelStateListener),S.unref(),this.channelControlHelper.removeChannelzChild(S.getChannelzRef());this.subchannels=[]}updateAddressList(S,T){for(let T of(this.resetSubchannelList(),trace("Connect to address list "+S.map(S=>(0,M.subchannelAddressToString)(S))),this.subchannels=S.map(S=>this.channelControlHelper.createSubchannel(S,{})),this.subchannels)){T.ref(),T.addConnectivityStateListener(this.subchannelStateListener),this.channelControlHelper.addChannelzChild(T.getChannelzRef());let S=T.getConnectivityState();(S===O.ConnectivityState.IDLE||S===O.ConnectivityState.TRANSIENT_FAILURE)&&T.startConnecting()}this.calculateAndUpdateState()}exitIdle(){for(let S of this.subchannels)S.startConnecting()}resetBackoff(){}destroy(){this.resetSubchannelList()}getTypeName(){return W}};function setup(){(0,P.registerLoadBalancerType)(W,RoundRobinLoadBalancer,RoundRobinLoadBalancingConfig)}T.RoundRobinLoadBalancer=RoundRobinLoadBalancer,T.setup=setup},77203:(S,T)=>{"use strict";function createChildChannelControlHelper(S,T){var R,P,O,N,M,L,V,U,W,K;return{createSubchannel:null!==(P=null===(R=T.createSubchannel)||void 0===R?void 0:R.bind(T))&&void 0!==P?P:S.createSubchannel.bind(S),updateState:null!==(N=null===(O=T.updateState)||void 0===O?void 0:O.bind(T))&&void 0!==N?N:S.updateState.bind(S),requestReresolution:null!==(L=null===(M=T.requestReresolution)||void 0===M?void 0:M.bind(T))&&void 0!==L?L:S.requestReresolution.bind(S),addChannelzChild:null!==(U=null===(V=T.addChannelzChild)||void 0===V?void 0:V.bind(T))&&void 0!==U?U:S.addChannelzChild.bind(S),removeChannelzChild:null!==(K=null===(W=T.removeChannelzChild)||void 0===W?void 0:W.bind(T))&&void 0!==K?K:S.removeChannelzChild.bind(S)}}Object.defineProperty(T,"__esModule",{value:!0}),T.validateLoadBalancingConfig=T.getFirstUsableConfig=T.isLoadBalancerNameRegistered=T.createLoadBalancer=T.registerDefaultLoadBalancerType=T.registerLoadBalancerType=T.createChildChannelControlHelper=void 0,T.createChildChannelControlHelper=createChildChannelControlHelper;let R={},P=null;function registerLoadBalancerType(S,T,P){R[S]={LoadBalancer:T,LoadBalancingConfig:P}}function registerDefaultLoadBalancerType(S){P=S}function createLoadBalancer(S,T){let P=S.getLoadBalancerName();return P in R?new R[P].LoadBalancer(T):null}function isLoadBalancerNameRegistered(S){return S in R}function getFirstUsableConfig(S,T=!1){for(let T of S)if(T.getLoadBalancerName() in R)return T;return T&&P?new R[P].LoadBalancingConfig:null}function validateLoadBalancingConfig(S){if(!(null!==S&&"object"==typeof S))throw Error("Load balancing config must be an object");let T=Object.keys(S);if(1!==T.length)throw Error("Provided load balancing config has multiple conflicting entries");let P=T[0];if(P in R)return R[P].LoadBalancingConfig.createFromJson(S[P]);throw Error(`Unrecognized load balancing config name ${P}`)}T.registerLoadBalancerType=registerLoadBalancerType,T.registerDefaultLoadBalancerType=registerDefaultLoadBalancerType,T.createLoadBalancer=createLoadBalancer,T.isLoadBalancerNameRegistered=isLoadBalancerNameRegistered,T.getFirstUsableConfig=getFirstUsableConfig,T.validateLoadBalancingConfig=validateLoadBalancingConfig},80439:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.LoadBalancingCall=void 0;let P=R(91360),O=R(69238),N=R(50823),M=R(32908),L=R(32939),V=R(14717),U=R(68200),W=R(6614),K=R(85158),Q="load_balancing_call";let LoadBalancingCall=class LoadBalancingCall{constructor(S,T,R,P,O,N,M){var L,U;this.channel=S,this.callConfig=T,this.methodName=R,this.host=P,this.credentials=O,this.deadline=N,this.callNumber=M,this.child=null,this.readPending=!1,this.pendingMessage=null,this.pendingHalfClose=!1,this.ended=!1,this.metadata=null,this.listener=null,this.onCallEnded=null;let W=this.methodName.split("/"),K="";W.length>=2&&(K=W[1]);let Q=null!==(U=null===(L=(0,V.splitHostPort)(this.host))||void 0===L?void 0:L.host)&&void 0!==U?U:"localhost";this.serviceUrl=`https://${Q}/${K}`}trace(S){U.trace(O.LogVerbosity.DEBUG,Q,"["+this.callNumber+"] "+S)}outputStatus(S,T){var R,P;if(!this.ended){this.ended=!0,this.trace("ended with status: code="+S.code+' details="'+S.details+'"');let O=Object.assign(Object.assign({},S),{progress:T});null===(R=this.listener)||void 0===R||R.onReceiveStatus(O),null===(P=this.onCallEnded)||void 0===P||P.call(this,O.code)}}doPick(){var S,T;if(this.ended)return;if(!this.metadata)throw Error("doPick called before start");this.trace("Pick called");let R=this.channel.doPick(this.metadata,this.callConfig.pickInformation),V=R.subchannel?"("+R.subchannel.getChannelzRef().id+") "+R.subchannel.getAddress():""+R.subchannel;switch(this.trace("Pick result: "+L.PickResultType[R.pickResultType]+" subchannel: "+V+" status: "+(null===(S=R.status)||void 0===S?void 0:S.code)+" "+(null===(T=R.status)||void 0===T?void 0:T.details)),R.pickResultType){case L.PickResultType.COMPLETE:this.credentials.generateMetadata({service_url:this.serviceUrl}).then(S=>{var T,L,U;if(this.ended){this.trace("Credentials metadata generation finished after call ended");return}let W=this.metadata.clone();if(W.merge(S),W.get("authorization").length>1&&this.outputStatus({code:O.Status.INTERNAL,details:'"authorization" metadata cannot have multiple values',metadata:new M.Metadata},"PROCESSED"),R.subchannel.getConnectivityState()!==P.ConnectivityState.READY){this.trace("Picked subchannel "+V+" has state "+P.ConnectivityState[R.subchannel.getConnectivityState()]+" after getting credentials metadata. Retrying pick"),this.doPick();return}this.deadline!==1/0&&W.set("grpc-timeout",(0,N.getDeadlineTimeoutString)(this.deadline));try{this.child=R.subchannel.getRealSubchannel().createCall(W,this.host,this.methodName,{onReceiveMetadata:S=>{this.trace("Received metadata"),this.listener.onReceiveMetadata(S)},onReceiveMessage:S=>{this.trace("Received message"),this.listener.onReceiveMessage(S)},onReceiveStatus:S=>{this.trace("Received status"),S.rstCode===K.constants.NGHTTP2_REFUSED_STREAM?this.outputStatus(S,"REFUSED"):this.outputStatus(S,"PROCESSED")}})}catch(S){this.trace("Failed to start call on picked subchannel "+V+" with error "+S.message),this.outputStatus({code:O.Status.INTERNAL,details:"Failed to start HTTP/2 stream with error "+S.message,metadata:new M.Metadata},"NOT_STARTED");return}null===(L=(T=this.callConfig).onCommitted)||void 0===L||L.call(T),null===(U=R.onCallStarted)||void 0===U||U.call(R),this.onCallEnded=R.onCallEnded,this.trace("Created child call ["+this.child.getCallNumber()+"]"),this.readPending&&this.child.startRead(),this.pendingMessage&&this.child.sendMessageWithContext(this.pendingMessage.context,this.pendingMessage.message),this.pendingHalfClose&&this.child.halfClose()},S=>{let{code:T,details:R}=(0,W.restrictControlPlaneStatusCode)("number"==typeof S.code?S.code:O.Status.UNKNOWN,`Getting metadata from plugin failed with error: ${S.message}`);this.outputStatus({code:T,details:R,metadata:new M.Metadata},"PROCESSED")});break;case L.PickResultType.DROP:let{code:U,details:Q}=(0,W.restrictControlPlaneStatusCode)(R.status.code,R.status.details);setImmediate(()=>{this.outputStatus({code:U,details:Q,metadata:R.status.metadata},"DROP")});break;case L.PickResultType.TRANSIENT_FAILURE:if(this.metadata.getOptions().waitForReady)this.channel.queueCallForPick(this);else{let{code:S,details:T}=(0,W.restrictControlPlaneStatusCode)(R.status.code,R.status.details);setImmediate(()=>{this.outputStatus({code:S,details:T,metadata:R.status.metadata},"PROCESSED")})}break;case L.PickResultType.QUEUE:this.channel.queueCallForPick(this)}}cancelWithStatus(S,T){var R;this.trace("cancelWithStatus code: "+S+' details: "'+T+'"'),null===(R=this.child)||void 0===R||R.cancelWithStatus(S,T),this.outputStatus({code:S,details:T,metadata:new M.Metadata},"PROCESSED")}getPeer(){var S,T;return null!==(T=null===(S=this.child)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:this.channel.getTarget()}start(S,T){this.trace("start called"),this.listener=T,this.metadata=S,this.doPick()}sendMessageWithContext(S,T){this.trace("write() called with message of length "+T.length),this.child?this.child.sendMessageWithContext(S,T):this.pendingMessage={context:S,message:T}}startRead(){this.trace("startRead called"),this.child?this.child.startRead():this.readPending=!0}halfClose(){this.trace("halfClose called"),this.child?this.child.halfClose():this.pendingHalfClose=!0}setCredentials(S){throw Error("Method not implemented.")}getCallNumber(){return this.callNumber}};T.LoadBalancingCall=LoadBalancingCall},68200:(S,T,R)=>{"use strict";var P,O,N,M;Object.defineProperty(T,"__esModule",{value:!0}),T.isTracerEnabled=T.trace=T.log=T.setLoggerVerbosity=T.setLogger=T.getLogger=void 0;let L=R(69238),V=R(77282),U=R(81513).i8,W={error:(S,...T)=>{console.error("E "+S,...T)},info:(S,...T)=>{console.error("I "+S,...T)},debug:(S,...T)=>{console.error("D "+S,...T)}},K=W,Q=L.LogVerbosity.ERROR,$=null!==(O=null!==(P=process.env.GRPC_NODE_VERBOSITY)&&void 0!==P?P:process.env.GRPC_VERBOSITY)&&void 0!==O?O:"";switch($.toUpperCase()){case"DEBUG":Q=L.LogVerbosity.DEBUG;break;case"INFO":Q=L.LogVerbosity.INFO;break;case"ERROR":Q=L.LogVerbosity.ERROR;break;case"NONE":Q=L.LogVerbosity.NONE}let getLogger=()=>K;T.getLogger=getLogger;let setLogger=S=>{K=S};T.setLogger=setLogger;let setLoggerVerbosity=S=>{Q=S};T.setLoggerVerbosity=setLoggerVerbosity;let log=(S,...T)=>{let R;if(S>=Q){switch(S){case L.LogVerbosity.DEBUG:R=K.debug;break;case L.LogVerbosity.INFO:R=K.info;break;case L.LogVerbosity.ERROR:R=K.error}R||(R=K.error),R&&R.bind(K)(...T)}};T.log=log;let Y=null!==(M=null!==(N=process.env.GRPC_NODE_TRACE)&&void 0!==N?N:process.env.GRPC_TRACE)&&void 0!==M?M:"",X=new Set,Z=new Set;for(let S of Y.split(","))S.startsWith("-")?Z.add(S.substring(1)):X.add(S);let ee=X.has("all");function trace(S,R,P){isTracerEnabled(R)&&(0,T.log)(S,new Date().toISOString()+" | v"+U+" "+V.pid+" | "+R+" | "+P)}function isTracerEnabled(S){return!Z.has(S)&&(ee||X.has(S))}T.trace=trace,T.isTracerEnabled=isTracerEnabled},47697:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.loadPackageDefinition=T.makeClientConstructor=void 0;let P=R(47307),O={unary:P.Client.prototype.makeUnaryRequest,server_stream:P.Client.prototype.makeServerStreamRequest,client_stream:P.Client.prototype.makeClientStreamRequest,bidi:P.Client.prototype.makeBidiStreamRequest};function isPrototypePolluted(S){return["__proto__","prototype","constructor"].includes(S)}function makeClientConstructor(S,T,R){R||(R={});let ServiceClientImpl=class ServiceClientImpl extends P.Client{};return Object.keys(S).forEach(T=>{let R;if(isPrototypePolluted(T))return;let P=S[T];if("string"==typeof T&&"$"===T.charAt(0))throw Error("Method names cannot start with $");R=P.requestStream?P.responseStream?"bidi":"client_stream":P.responseStream?"server_stream":"unary";let N=P.requestSerialize,M=P.responseDeserialize,L=partial(O[R],P.path,N,M);ServiceClientImpl.prototype[T]=L,Object.assign(ServiceClientImpl.prototype[T],P),P.originalName&&!isPrototypePolluted(P.originalName)&&(ServiceClientImpl.prototype[P.originalName]=ServiceClientImpl.prototype[T])}),ServiceClientImpl.service=S,ServiceClientImpl.serviceName=T,ServiceClientImpl}function partial(S,T,R,P){return function(...O){return S.call(this,T,R,P,...O)}}function isProtobufTypeDefinition(S){return"format"in S}function loadPackageDefinition(S){let T={};for(let R in S)if(Object.prototype.hasOwnProperty.call(S,R)){let P=S[R],O=R.split(".");if(O.some(S=>isPrototypePolluted(S)))continue;let N=O[O.length-1],M=T;for(let S of O.slice(0,-1))M[S]||(M[S]={}),M=M[S];isProtobufTypeDefinition(P)?M[N]=P:M[N]=makeClientConstructor(P,N,{})}return T}T.makeClientConstructor=makeClientConstructor,T.loadPackageDefinition=loadPackageDefinition},32908:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Metadata=void 0;let P=R(68200),O=R(69238),N=R(9006),M=/^[0-9a-z_.-]+$/,L=/^[ -~]*$/;function isLegalKey(S){return M.test(S)}function isLegalNonBinaryValue(S){return L.test(S)}function isBinaryKey(S){return S.endsWith("-bin")}function isCustomMetadata(S){return!S.startsWith("grpc-")}function normalizeKey(S){return S.toLowerCase()}function validate(S,T){if(!isLegalKey(S))throw Error('Metadata key "'+S+'" contains illegal characters');if(null!=T){if(isBinaryKey(S)){if(!Buffer.isBuffer(T))throw Error("keys that end with '-bin' must have Buffer values")}else{if(Buffer.isBuffer(T))throw Error("keys that don't end with '-bin' must have String values");if(!isLegalNonBinaryValue(T))throw Error('Metadata string value "'+T+'" contains illegal characters')}}}let Metadata=class Metadata{constructor(S={}){this.internalRepr=new Map,this.options=S}set(S,T){validate(S=normalizeKey(S),T),this.internalRepr.set(S,[T])}add(S,T){validate(S=normalizeKey(S),T);let R=this.internalRepr.get(S);void 0===R?this.internalRepr.set(S,[T]):R.push(T)}remove(S){S=normalizeKey(S),this.internalRepr.delete(S)}get(S){return S=normalizeKey(S),this.internalRepr.get(S)||[]}getMap(){let S={};for(let[T,R]of this.internalRepr)if(R.length>0){let P=R[0];S[T]=Buffer.isBuffer(P)?Buffer.from(P):P}return S}clone(){let S=new Metadata(this.options),T=S.internalRepr;for(let[S,R]of this.internalRepr){let P=R.map(S=>Buffer.isBuffer(S)?Buffer.from(S):S);T.set(S,P)}return S}merge(S){for(let[T,R]of S.internalRepr){let S=(this.internalRepr.get(T)||[]).concat(R);this.internalRepr.set(T,S)}}setOptions(S){this.options=S}getOptions(){return this.options}toHttp2Headers(){let S={};for(let[T,R]of this.internalRepr)S[T]=R.map(bufToString);return S}toJSON(){let S={};for(let[T,R]of this.internalRepr)S[T]=R;return S}static fromHttp2Headers(S){let T=new Metadata;for(let R of Object.keys(S)){if(":"===R.charAt(0))continue;let M=S[R];try{isBinaryKey(R)?Array.isArray(M)?M.forEach(S=>{T.add(R,Buffer.from(S,"base64"))}):void 0!==M&&(isCustomMetadata(R)?M.split(",").forEach(S=>{T.add(R,Buffer.from(S.trim(),"base64"))}):T.add(R,Buffer.from(M,"base64"))):Array.isArray(M)?M.forEach(S=>{T.add(R,S)}):void 0!==M&&T.add(R,M)}catch(T){let S=`Failed to add metadata entry ${R}: ${M}. ${(0,N.getErrorMessage)(T)}. For more information see https://github.com/grpc/grpc-node/issues/1173`;(0,P.log)(O.LogVerbosity.ERROR,S)}}return T}};T.Metadata=Metadata;let bufToString=S=>Buffer.isBuffer(S)?S.toString("base64"):S},32939:(S,T,R)=>{"use strict";var P;Object.defineProperty(T,"__esModule",{value:!0}),T.QueuePicker=T.UnavailablePicker=T.PickResultType=void 0;let O=R(32908),N=R(69238);!function(S){S[S.COMPLETE=0]="COMPLETE",S[S.QUEUE=1]="QUEUE",S[S.TRANSIENT_FAILURE=2]="TRANSIENT_FAILURE",S[S.DROP=3]="DROP"}(P||(T.PickResultType=P={}));let UnavailablePicker=class UnavailablePicker{constructor(S){this.status=Object.assign({code:N.Status.UNAVAILABLE,details:"No connection established",metadata:new O.Metadata},S)}pick(S){return{pickResultType:P.TRANSIENT_FAILURE,subchannel:null,status:this.status,onCallStarted:null,onCallEnded:null}}};T.UnavailablePicker=UnavailablePicker;let QueuePicker=class QueuePicker{constructor(S){this.loadBalancer=S,this.calledExitIdle=!1}pick(S){return this.calledExitIdle||(process.nextTick(()=>{this.loadBalancer.exitIdle()}),this.calledExitIdle=!0),{pickResultType:P.QUEUE,subchannel:null,status:null,onCallStarted:null,onCallEnded:null}}};T.QueuePicker=QueuePicker},84988:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=T.DEFAULT_PORT=void 0;let P=R(14755),O=R(9523),N=R(73837),M=R(45914),L=R(69238),V=R(32908),U=R(68200),W=R(69238),K=R(14717),Q=R(41808),$=R(77257),Y="dns_resolver";function trace(S){U.trace(W.LogVerbosity.DEBUG,Y,S)}T.DEFAULT_PORT=443;let X=3e4,Z=N.promisify(O.resolveTxt),ee=N.promisify(O.lookup);function mergeArrays(...S){let T=[];for(let R=0;R<Math.max.apply(null,S.map(S=>S.length));R++)for(let P of S)R<P.length&&T.push(P[R]);return T}let DnsResolver=class DnsResolver{constructor(S,R,P){var O,N,M;this.target=S,this.listener=R,this.pendingLookupPromise=null,this.pendingTxtPromise=null,this.latestLookupResult=null,this.latestServiceConfig=null,this.latestServiceConfigError=null,this.continueResolving=!1,this.isNextResolutionTimerRunning=!1,this.isServiceConfigEnabled=!0,this.returnedIpResult=!1,trace("Resolver constructed for target "+(0,K.uriToString)(S));let U=(0,K.splitHostPort)(S.path);null===U?(this.ipResult=null,this.dnsHostname=null,this.port=null):(0,Q.isIPv4)(U.host)||(0,Q.isIPv6)(U.host)?(this.ipResult=[{host:U.host,port:null!==(O=U.port)&&void 0!==O?O:T.DEFAULT_PORT}],this.dnsHostname=null,this.port=null):(this.ipResult=null,this.dnsHostname=U.host,this.port=null!==(N=U.port)&&void 0!==N?N:T.DEFAULT_PORT),this.percentage=100*Math.random(),1===P["grpc.service_config_disable_resolution"]&&(this.isServiceConfigEnabled=!1),this.defaultResolutionError={code:L.Status.UNAVAILABLE,details:`Name resolution failed for target ${(0,K.uriToString)(this.target)}`,metadata:new V.Metadata};let W={initialDelay:P["grpc.initial_reconnect_backoff_ms"],maxDelay:P["grpc.max_reconnect_backoff_ms"]};this.backoff=new $.BackoffTimeout(()=>{this.continueResolving&&this.startResolutionWithBackoff()},W),this.backoff.unref(),this.minTimeBetweenResolutionsMs=null!==(M=P["grpc.dns_min_time_between_resolutions_ms"])&&void 0!==M?M:X,this.nextResolutionTimer=setTimeout(()=>{},0),clearTimeout(this.nextResolutionTimer)}startResolution(){if(null!==this.ipResult){this.returnedIpResult||(trace("Returning IP address for target "+(0,K.uriToString)(this.target)),setImmediate(()=>{this.listener.onSuccessfulResolution(this.ipResult,null,null,null,{})}),this.returnedIpResult=!0),this.backoff.stop(),this.backoff.reset(),this.stopNextResolutionTimer();return}if(null===this.dnsHostname)trace("Failed to parse DNS address "+(0,K.uriToString)(this.target)),setImmediate(()=>{this.listener.onError({code:L.Status.UNAVAILABLE,details:`Failed to parse DNS address ${(0,K.uriToString)(this.target)}`,metadata:new V.Metadata})}),this.stopNextResolutionTimer();else{if(null!==this.pendingLookupPromise)return;trace("Looking up DNS hostname "+this.dnsHostname),this.latestLookupResult=null;let S=this.dnsHostname;this.pendingLookupPromise=ee(S,{all:!0}),this.pendingLookupPromise.then(S=>{if(null===this.pendingLookupPromise)return;this.pendingLookupPromise=null,this.backoff.reset(),this.backoff.stop();let T=S.filter(S=>4===S.family),R=S.filter(S=>6===S.family);this.latestLookupResult=mergeArrays(R,T).map(S=>({host:S.address,port:+this.port}));let P="["+this.latestLookupResult.map(S=>S.host+":"+S.port).join(",")+"]";if(trace("Resolved addresses for target "+(0,K.uriToString)(this.target)+": "+P),0===this.latestLookupResult.length){this.listener.onError(this.defaultResolutionError);return}this.listener.onSuccessfulResolution(this.latestLookupResult,this.latestServiceConfig,this.latestServiceConfigError,null,{})},S=>{null!==this.pendingLookupPromise&&(trace("Resolution error for target "+(0,K.uriToString)(this.target)+": "+S.message),this.pendingLookupPromise=null,this.stopNextResolutionTimer(),this.listener.onError(this.defaultResolutionError))}),this.isServiceConfigEnabled&&null===this.pendingTxtPromise&&(this.pendingTxtPromise=Z(S),this.pendingTxtPromise.then(S=>{if(null!==this.pendingTxtPromise){this.pendingTxtPromise=null;try{this.latestServiceConfig=(0,M.extractAndSelectServiceConfig)(S,this.percentage)}catch(S){this.latestServiceConfigError={code:L.Status.UNAVAILABLE,details:`Parsing service config failed with error ${S.message}`,metadata:new V.Metadata}}null!==this.latestLookupResult&&this.listener.onSuccessfulResolution(this.latestLookupResult,this.latestServiceConfig,this.latestServiceConfigError,null,{})}},S=>{}))}}startNextResolutionTimer(){var S,T;clearTimeout(this.nextResolutionTimer),this.nextResolutionTimer=null===(T=(S=setTimeout(()=>{this.stopNextResolutionTimer(),this.continueResolving&&this.startResolutionWithBackoff()},this.minTimeBetweenResolutionsMs)).unref)||void 0===T?void 0:T.call(S),this.isNextResolutionTimerRunning=!0}stopNextResolutionTimer(){clearTimeout(this.nextResolutionTimer),this.isNextResolutionTimerRunning=!1}startResolutionWithBackoff(){null===this.pendingLookupPromise&&(this.continueResolving=!1,this.backoff.runOnce(),this.startNextResolutionTimer(),this.startResolution())}updateResolution(){null===this.pendingLookupPromise&&(this.isNextResolutionTimerRunning||this.backoff.isRunning()?(this.isNextResolutionTimerRunning?trace('resolution update delayed by "min time between resolutions" rate limit'):trace("resolution update delayed by backoff timer until "+this.backoff.getEndTime().toISOString()),this.continueResolving=!0):this.startResolutionWithBackoff())}destroy(){this.continueResolving=!1,this.backoff.reset(),this.backoff.stop(),this.stopNextResolutionTimer(),this.pendingLookupPromise=null,this.pendingTxtPromise=null,this.latestLookupResult=null,this.latestServiceConfig=null,this.latestServiceConfigError=null,this.returnedIpResult=!1}static getDefaultAuthority(S){return S.path}};function setup(){(0,P.registerResolver)("dns",DnsResolver),(0,P.registerDefaultScheme)("dns")}T.setup=setup},6443:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=void 0;let P=R(41808),O=R(69238),N=R(32908),M=R(14755),L=R(14717),V=R(68200),U="ip_resolver";function trace(S){V.trace(O.LogVerbosity.DEBUG,U,S)}let W="ipv4",K="ipv6",Q=443;let IpResolver=class IpResolver{constructor(S,T,R){var M;this.listener=T,this.addresses=[],this.error=null,this.hasReturnedResult=!1,trace("Resolver constructed for target "+(0,L.uriToString)(S));let V=[];if(!(S.scheme===W||S.scheme===K)){this.error={code:O.Status.UNAVAILABLE,details:`Unrecognized scheme ${S.scheme} in IP resolver`,metadata:new N.Metadata};return}let U=S.path.split(",");for(let T of U){let R=(0,L.splitHostPort)(T);if(null===R||S.scheme===W&&!(0,P.isIPv4)(R.host)||S.scheme===K&&!(0,P.isIPv6)(R.host)){this.error={code:O.Status.UNAVAILABLE,details:`Failed to parse ${S.scheme} address ${T}`,metadata:new N.Metadata};return}V.push({host:R.host,port:null!==(M=R.port)&&void 0!==M?M:Q})}this.addresses=V,trace("Parsed "+S.scheme+" address list "+this.addresses)}updateResolution(){this.hasReturnedResult||(this.hasReturnedResult=!0,process.nextTick(()=>{this.error?this.listener.onError(this.error):this.listener.onSuccessfulResolution(this.addresses,null,null,null,{})}))}destroy(){this.hasReturnedResult=!1}static getDefaultAuthority(S){return S.path.split(",")[0]}};function setup(){(0,M.registerResolver)(W,IpResolver),(0,M.registerResolver)(K,IpResolver)}T.setup=setup},50864:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.setup=void 0;let P=R(14755);let UdsResolver=class UdsResolver{constructor(S,T,R){let P;this.listener=T,this.addresses=[],this.hasReturnedResult=!1,P=""===S.authority?"/"+S.path:S.path,this.addresses=[{path:P}]}updateResolution(){this.hasReturnedResult||(this.hasReturnedResult=!0,process.nextTick(this.listener.onSuccessfulResolution,this.addresses,null,null,null,{}))}destroy(){}static getDefaultAuthority(S){return"localhost"}};function setup(){(0,P.registerResolver)("unix",UdsResolver)}T.setup=setup},14755:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.mapUriDefaultScheme=T.getDefaultAuthority=T.createResolver=T.registerDefaultScheme=T.registerResolver=void 0;let P=R(14717),O={},N=null;function registerResolver(S,T){O[S]=T}function registerDefaultScheme(S){N=S}function createResolver(S,T,R){if(void 0!==S.scheme&&S.scheme in O)return new O[S.scheme](S,T,R);throw Error(`No resolver could be created for target ${(0,P.uriToString)(S)}`)}function getDefaultAuthority(S){if(void 0!==S.scheme&&S.scheme in O)return O[S.scheme].getDefaultAuthority(S);throw Error(`Invalid target ${(0,P.uriToString)(S)}`)}function mapUriDefaultScheme(S){return void 0!==S.scheme&&S.scheme in O?S:null!==N?{scheme:N,authority:void 0,path:(0,P.uriToString)(S)}:null}T.registerResolver=registerResolver,T.registerDefaultScheme=registerDefaultScheme,T.createResolver=createResolver,T.getDefaultAuthority=getDefaultAuthority,T.mapUriDefaultScheme=mapUriDefaultScheme},65700:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ResolvingCall=void 0;let P=R(69238),O=R(50823),N=R(32908),M=R(68200),L=R(6614),V="resolving_call";let ResolvingCall=class ResolvingCall{constructor(S,T,R,N,M,L){this.channel=S,this.method=T,this.filterStackFactory=N,this.credentials=M,this.callNumber=L,this.child=null,this.readPending=!1,this.pendingMessage=null,this.pendingHalfClose=!1,this.ended=!1,this.readFilterPending=!1,this.writeFilterPending=!1,this.pendingChildStatus=null,this.metadata=null,this.listener=null,this.statusWatchers=[],this.deadlineTimer=setTimeout(()=>{},0),this.filterStack=null,this.deadline=R.deadline,this.host=R.host,R.parentCall&&(R.flags&P.Propagate.CANCELLATION&&R.parentCall.on("cancelled",()=>{this.cancelWithStatus(P.Status.CANCELLED,"Cancelled by parent call")}),R.flags&P.Propagate.DEADLINE&&(this.trace("Propagating deadline from parent: "+R.parentCall.getDeadline()),this.deadline=(0,O.minDeadline)(this.deadline,R.parentCall.getDeadline()))),this.trace("Created"),this.runDeadlineTimer()}trace(S){M.trace(P.LogVerbosity.DEBUG,V,"["+this.callNumber+"] "+S)}runDeadlineTimer(){clearTimeout(this.deadlineTimer),this.trace("Deadline: "+(0,O.deadlineToString)(this.deadline));let S=(0,O.getRelativeTimeout)(this.deadline);if(S!==1/0){this.trace("Deadline will be reached in "+S+"ms");let handleDeadline=()=>{this.cancelWithStatus(P.Status.DEADLINE_EXCEEDED,"Deadline exceeded")};S<=0?process.nextTick(handleDeadline):this.deadlineTimer=setTimeout(handleDeadline,S)}}outputStatus(S){if(!this.ended){this.ended=!0,this.filterStack||(this.filterStack=this.filterStackFactory.createFilter()),clearTimeout(this.deadlineTimer);let T=this.filterStack.receiveTrailers(S);this.trace("ended with status: code="+T.code+' details="'+T.details+'"'),this.statusWatchers.forEach(S=>S(T)),process.nextTick(()=>{var S;null===(S=this.listener)||void 0===S||S.onReceiveStatus(T)})}}sendMessageOnChild(S,T){if(!this.child)throw Error("sendMessageonChild called with child not populated");let R=this.child;this.writeFilterPending=!0,this.filterStack.sendMessage(Promise.resolve({message:T,flags:S.flags})).then(T=>{this.writeFilterPending=!1,R.sendMessageWithContext(S,T.message),this.pendingHalfClose&&R.halfClose()},S=>{this.cancelWithStatus(S.code,S.details)})}getConfig(){if(this.ended)return;if(!this.metadata||!this.listener)throw Error("getConfig called before start");let S=this.channel.getConfig(this.method,this.metadata);if("NONE"===S.type){this.channel.queueCallForConfig(this);return}if("ERROR"===S.type){this.metadata.getOptions().waitForReady?this.channel.queueCallForConfig(this):this.outputStatus(S.error);return}let T=S.config;if(T.status!==P.Status.OK){let{code:S,details:R}=(0,L.restrictControlPlaneStatusCode)(T.status,"Failed to route call to method "+this.method);this.outputStatus({code:S,details:R,metadata:new N.Metadata});return}if(T.methodConfig.timeout){let S=new Date;S.setSeconds(S.getSeconds()+T.methodConfig.timeout.seconds),S.setMilliseconds(S.getMilliseconds()+T.methodConfig.timeout.nanos/1e6),this.deadline=(0,O.minDeadline)(this.deadline,S),this.runDeadlineTimer()}this.filterStackFactory.push(T.dynamicFilterFactories),this.filterStack=this.filterStackFactory.createFilter(),this.filterStack.sendMetadata(Promise.resolve(this.metadata)).then(S=>{this.child=this.channel.createInnerCall(T,this.method,this.host,this.credentials,this.deadline),this.trace("Created child ["+this.child.getCallNumber()+"]"),this.child.start(S,{onReceiveMetadata:S=>{this.trace("Received metadata"),this.listener.onReceiveMetadata(this.filterStack.receiveMetadata(S))},onReceiveMessage:S=>{this.trace("Received message"),this.readFilterPending=!0,this.filterStack.receiveMessage(S).then(S=>{this.trace("Finished filtering received message"),this.readFilterPending=!1,this.listener.onReceiveMessage(S),this.pendingChildStatus&&this.outputStatus(this.pendingChildStatus)},S=>{this.cancelWithStatus(S.code,S.details)})},onReceiveStatus:S=>{this.trace("Received status"),this.readFilterPending?this.pendingChildStatus=S:this.outputStatus(S)}}),this.readPending&&this.child.startRead(),this.pendingMessage?this.sendMessageOnChild(this.pendingMessage.context,this.pendingMessage.message):this.pendingHalfClose&&this.child.halfClose()},S=>{this.outputStatus(S)})}reportResolverError(S){var T;(null===(T=this.metadata)||void 0===T?void 0:T.getOptions().waitForReady)?this.channel.queueCallForConfig(this):this.outputStatus(S)}cancelWithStatus(S,T){var R;this.trace("cancelWithStatus code: "+S+' details: "'+T+'"'),null===(R=this.child)||void 0===R||R.cancelWithStatus(S,T),this.outputStatus({code:S,details:T,metadata:new N.Metadata})}getPeer(){var S,T;return null!==(T=null===(S=this.child)||void 0===S?void 0:S.getPeer())&&void 0!==T?T:this.channel.getTarget()}start(S,T){this.trace("start called"),this.metadata=S.clone(),this.listener=T,this.getConfig()}sendMessageWithContext(S,T){this.trace("write() called with message of length "+T.length),this.child?this.sendMessageOnChild(S,T):this.pendingMessage={context:S,message:T}}startRead(){this.trace("startRead called"),this.child?this.child.startRead():this.readPending=!0}halfClose(){this.trace("halfClose called"),this.child&&!this.writeFilterPending?this.child.halfClose():this.pendingHalfClose=!0}setCredentials(S){this.credentials=this.credentials.compose(S)}addStatusWatcher(S){this.statusWatchers.push(S)}getCallNumber(){return this.callNumber}};T.ResolvingCall=ResolvingCall},61839:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ResolvingLoadBalancer=void 0;let P=R(77203),O=R(45914),N=R(91360),M=R(14755),L=R(32939),V=R(77257),U=R(69238),W=R(32908),K=R(68200),Q=R(69238),$=R(14717),Y=R(38390),X="resolving_load_balancer";function trace(S){K.trace(Q.LogVerbosity.DEBUG,X,S)}let Z=["SERVICE_AND_METHOD","SERVICE","EMPTY"];function hasMatchingName(S,T,R,P){for(let O of R.name)switch(P){case"EMPTY":if(!O.service&&!O.method)return!0;break;case"SERVICE":if(O.service===S&&!O.method)return!0;break;case"SERVICE_AND_METHOD":if(O.service===S&&O.method===T)return!0}return!1}function findMatchingConfig(S,T,R,P){for(let O of R)if(hasMatchingName(S,T,O,P))return O;return null}function getDefaultConfigSelector(S){return function(T,R){var P,O;let N=T.split("/").filter(S=>S.length>0),M=null!==(P=N[0])&&void 0!==P?P:"",L=null!==(O=N[1])&&void 0!==O?O:"";if(S&&S.methodConfig)for(let T of Z){let R=findMatchingConfig(M,L,S.methodConfig,T);if(R)return{methodConfig:R,pickInformation:{},status:U.Status.OK,dynamicFilterFactories:[]}}return{methodConfig:{name:[]},pickInformation:{},status:U.Status.OK,dynamicFilterFactories:[]}}}let ResolvingLoadBalancer=class ResolvingLoadBalancer{constructor(S,T,R,K,Q){this.target=S,this.channelControlHelper=T,this.onSuccessfulResolution=K,this.onFailedResolution=Q,this.latestChildState=N.ConnectivityState.IDLE,this.latestChildPicker=new L.QueuePicker(this),this.currentState=N.ConnectivityState.IDLE,this.previousServiceConfig=null,this.continueResolving=!1,R["grpc.service_config"]?this.defaultServiceConfig=(0,O.validateServiceConfig)(JSON.parse(R["grpc.service_config"])):this.defaultServiceConfig={loadBalancingConfig:[],methodConfig:[]},this.updateState(N.ConnectivityState.IDLE,new L.QueuePicker(this)),this.childLoadBalancer=new Y.ChildLoadBalancerHandler({createSubchannel:T.createSubchannel.bind(T),requestReresolution:()=>{this.backoffTimeout.isRunning()?(trace("requestReresolution delayed by backoff timer until "+this.backoffTimeout.getEndTime().toISOString()),this.continueResolving=!0):this.updateResolution()},updateState:(S,T)=>{this.latestChildState=S,this.latestChildPicker=T,this.updateState(S,T)},addChannelzChild:T.addChannelzChild.bind(T),removeChannelzChild:T.removeChannelzChild.bind(T)}),this.innerResolver=(0,M.createResolver)(S,{onSuccessfulResolution:(S,T,R,O,N)=>{var M;this.backoffTimeout.stop(),this.backoffTimeout.reset();let L=null;null===T?null===R?(this.previousServiceConfig=null,L=this.defaultServiceConfig):null===this.previousServiceConfig?this.handleResolutionFailure(R):L=this.previousServiceConfig:(L=T,this.previousServiceConfig=T);let V=null!==(M=null==L?void 0:L.loadBalancingConfig)&&void 0!==M?M:[],K=(0,P.getFirstUsableConfig)(V,!0);if(null===K){this.handleResolutionFailure({code:U.Status.UNAVAILABLE,details:"All load balancer options in service config are not compatible",metadata:new W.Metadata});return}this.childLoadBalancer.updateAddressList(S,K,N);let Q=null!=L?L:this.defaultServiceConfig;this.onSuccessfulResolution(Q,null!=O?O:getDefaultConfigSelector(Q))},onError:S=>{this.handleResolutionFailure(S)}},R);let $={initialDelay:R["grpc.initial_reconnect_backoff_ms"],maxDelay:R["grpc.max_reconnect_backoff_ms"]};this.backoffTimeout=new V.BackoffTimeout(()=>{this.continueResolving?(this.updateResolution(),this.continueResolving=!1):this.updateState(this.latestChildState,this.latestChildPicker)},$),this.backoffTimeout.unref()}updateResolution(){this.innerResolver.updateResolution(),this.currentState===N.ConnectivityState.IDLE&&this.updateState(N.ConnectivityState.CONNECTING,new L.QueuePicker(this)),this.backoffTimeout.runOnce()}updateState(S,T){trace((0,$.uriToString)(this.target)+" "+N.ConnectivityState[this.currentState]+" -> "+N.ConnectivityState[S]),S===N.ConnectivityState.IDLE&&(T=new L.QueuePicker(this)),this.currentState=S,this.channelControlHelper.updateState(S,T)}handleResolutionFailure(S){this.latestChildState===N.ConnectivityState.IDLE&&(this.updateState(N.ConnectivityState.TRANSIENT_FAILURE,new L.UnavailablePicker(S)),this.onFailedResolution(S))}exitIdle(){(this.currentState===N.ConnectivityState.IDLE||this.currentState===N.ConnectivityState.TRANSIENT_FAILURE)&&(this.backoffTimeout.isRunning()?this.continueResolving=!0:this.updateResolution()),this.childLoadBalancer.exitIdle()}updateAddressList(S,T){throw Error("updateAddressList not supported on ResolvingLoadBalancer")}resetBackoff(){this.backoffTimeout.reset(),this.childLoadBalancer.resetBackoff()}destroy(){this.childLoadBalancer.destroy(),this.innerResolver.destroy(),this.backoffTimeout.reset(),this.backoffTimeout.stop(),this.latestChildState=N.ConnectivityState.IDLE,this.latestChildPicker=new L.QueuePicker(this),this.currentState=N.ConnectivityState.IDLE,this.previousServiceConfig=null,this.continueResolving=!1}getTypeName(){return"resolving_load_balancer"}};T.ResolvingLoadBalancer=ResolvingLoadBalancer},97564:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.RetryingCall=T.MessageBufferTracker=T.RetryThrottler=void 0;let P=R(69238),O=R(32908),N=R(68200),M="retrying_call";let RetryThrottler=class RetryThrottler{constructor(S,T,R){this.maxTokens=S,this.tokenRatio=T,R?this.tokens=R.tokens*(S/R.maxTokens):this.tokens=S}addCallSucceeded(){this.tokens=Math.max(this.tokens+this.tokenRatio,this.maxTokens)}addCallFailed(){this.tokens=Math.min(this.tokens-1,0)}canRetryCall(){return this.tokens>this.maxTokens/2}};T.RetryThrottler=RetryThrottler;let MessageBufferTracker=class MessageBufferTracker{constructor(S,T){this.totalLimit=S,this.limitPerCall=T,this.totalAllocated=0,this.allocatedPerCall=new Map}allocate(S,T){var R;let P=null!==(R=this.allocatedPerCall.get(T))&&void 0!==R?R:0;return!(this.limitPerCall-P<S)&&!(this.totalLimit-this.totalAllocated<S)&&(this.allocatedPerCall.set(T,P+S),this.totalAllocated+=S,!0)}free(S,T){var R;if(this.totalAllocated<S)throw Error(`Invalid buffer allocation state: call ${T} freed ${S} > total allocated ${this.totalAllocated}`);this.totalAllocated-=S;let P=null!==(R=this.allocatedPerCall.get(T))&&void 0!==R?R:0;if(P<S)throw Error(`Invalid buffer allocation state: call ${T} freed ${S} > allocated for call ${P}`);this.allocatedPerCall.set(T,P-S)}freeAll(S){var T;let R=null!==(T=this.allocatedPerCall.get(S))&&void 0!==T?T:0;if(this.totalAllocated<R)throw Error(`Invalid buffer allocation state: call ${S} allocated ${R} > total allocated ${this.totalAllocated}`);this.totalAllocated-=R,this.allocatedPerCall.delete(S)}};T.MessageBufferTracker=MessageBufferTracker;let L="grpc-previous-rpc-attempts";let RetryingCall=class RetryingCall{constructor(S,T,R,P,O,N,M,L,V){if(this.channel=S,this.callConfig=T,this.methodName=R,this.host=P,this.credentials=O,this.deadline=N,this.callNumber=M,this.bufferTracker=L,this.retryThrottler=V,this.listener=null,this.initialMetadata=null,this.underlyingCalls=[],this.writeBuffer=[],this.writeBufferOffset=0,this.readStarted=!1,this.transparentRetryUsed=!1,this.attempts=0,this.hedgingTimer=null,this.committedCallIndex=null,this.initialRetryBackoffSec=0,this.nextRetryBackoffSec=0,T.methodConfig.retryPolicy){this.state="RETRY";let S=T.methodConfig.retryPolicy;this.nextRetryBackoffSec=this.initialRetryBackoffSec=Number(S.initialBackoff.substring(0,S.initialBackoff.length-1))}else T.methodConfig.hedgingPolicy?this.state="HEDGING":this.state="TRANSPARENT_ONLY"}getCallNumber(){return this.callNumber}trace(S){N.trace(P.LogVerbosity.DEBUG,M,"["+this.callNumber+"] "+S)}reportStatus(S){this.trace("ended with status: code="+S.code+' details="'+S.details+'"'),this.bufferTracker.freeAll(this.callNumber),this.writeBufferOffset=this.writeBufferOffset+this.writeBuffer.length,this.writeBuffer=[],process.nextTick(()=>{var T;null===(T=this.listener)||void 0===T||T.onReceiveStatus({code:S.code,details:S.details,metadata:S.metadata})})}cancelWithStatus(S,T){for(let{call:R}of(this.trace("cancelWithStatus code: "+S+' details: "'+T+'"'),this.reportStatus({code:S,details:T,metadata:new O.Metadata}),this.underlyingCalls))R.cancelWithStatus(S,T)}getPeer(){return null!==this.committedCallIndex?this.underlyingCalls[this.committedCallIndex].call.getPeer():"unknown"}getBufferEntry(S){var T;return null!==(T=this.writeBuffer[S-this.writeBufferOffset])&&void 0!==T?T:{entryType:"FREED",allocated:!1}}getNextBufferIndex(){return this.writeBufferOffset+this.writeBuffer.length}clearSentMessages(){if("COMMITTED"!==this.state)return;let S=this.underlyingCalls[this.committedCallIndex].nextMessageToSend;for(let T=this.writeBufferOffset;T<S;T++){let S=this.getBufferEntry(T);S.allocated&&this.bufferTracker.free(S.message.message.length,this.callNumber)}this.writeBuffer=this.writeBuffer.slice(S-this.writeBufferOffset),this.writeBufferOffset=S}commitCall(S){if("COMMITTED"!==this.state&&"COMPLETED"!==this.underlyingCalls[S].state){this.trace("Committing call ["+this.underlyingCalls[S].call.getCallNumber()+"] at index "+S),this.state="COMMITTED",this.committedCallIndex=S;for(let T=0;T<this.underlyingCalls.length;T++)T!==S&&"COMPLETED"!==this.underlyingCalls[T].state&&(this.underlyingCalls[T].state="COMPLETED",this.underlyingCalls[T].call.cancelWithStatus(P.Status.CANCELLED,"Discarded in favor of other hedged attempt"));this.clearSentMessages()}}commitCallWithMostMessages(){if("COMMITTED"===this.state)return;let S=-1,T=-1;for(let[R,P]of this.underlyingCalls.entries())"ACTIVE"===P.state&&P.nextMessageToSend>S&&(S=P.nextMessageToSend,T=R);-1===T?this.state="TRANSPARENT_ONLY":this.commitCall(T)}isStatusCodeInList(S,T){return S.some(S=>S===T||S.toString().toLowerCase()===P.Status[T].toLowerCase())}getNextRetryBackoffMs(){var S;let T=null===(S=this.callConfig)||void 0===S?void 0:S.methodConfig.retryPolicy;if(!T)return 0;let R=Math.random()*this.nextRetryBackoffSec*1e3,P=Number(T.maxBackoff.substring(0,T.maxBackoff.length-1));return this.nextRetryBackoffSec=Math.min(this.nextRetryBackoffSec*T.backoffMultiplier,P),R}maybeRetryCall(S,T){let R;if("RETRY"!==this.state){T(!1);return}let P=this.callConfig.methodConfig.retryPolicy;if(this.attempts>=Math.min(P.maxAttempts,5)){T(!1);return}if(null===S)R=this.getNextRetryBackoffMs();else if(S<0){this.state="TRANSPARENT_ONLY",T(!1);return}else R=S,this.nextRetryBackoffSec=this.initialRetryBackoffSec;setTimeout(()=>{var S,R;if("RETRY"!==this.state){T(!1);return}(null===(R=null===(S=this.retryThrottler)||void 0===S?void 0:S.canRetryCall())||void 0===R||R)&&(T(!0),this.attempts+=1,this.startNewAttempt())},R)}countActiveCalls(){let S=0;for(let T of this.underlyingCalls)(null==T?void 0:T.state)==="ACTIVE"&&(S+=1);return S}handleProcessedStatus(S,T,R){var P,O,N;switch(this.state){case"COMMITTED":case"TRANSPARENT_ONLY":this.commitCall(T),this.reportStatus(S);break;case"HEDGING":if(this.isStatusCodeInList(null!==(P=this.callConfig.methodConfig.hedgingPolicy.nonFatalStatusCodes)&&void 0!==P?P:[],S.code)){let P;if(null===(O=this.retryThrottler)||void 0===O||O.addCallFailed(),null===R)P=0;else if(R<0){this.state="TRANSPARENT_ONLY",this.commitCall(T),this.reportStatus(S);return}else P=R;setTimeout(()=>{this.maybeStartHedgingAttempt(),0===this.countActiveCalls()&&(this.commitCall(T),this.reportStatus(S))},P)}else this.commitCall(T),this.reportStatus(S);break;case"RETRY":this.isStatusCodeInList(this.callConfig.methodConfig.retryPolicy.retryableStatusCodes,S.code)?(null===(N=this.retryThrottler)||void 0===N||N.addCallFailed(),this.maybeRetryCall(R,R=>{R||(this.commitCall(T),this.reportStatus(S))})):(this.commitCall(T),this.reportStatus(S))}}getPushback(S){let T=S.get("grpc-retry-pushback-ms");if(0===T.length)return null;try{return parseInt(T[0])}catch(S){return -1}}handleChildStatus(S,T){var R;if("COMPLETED"===this.underlyingCalls[T].state)return;if(this.trace("state="+this.state+" handling status with progress "+S.progress+" from child ["+this.underlyingCalls[T].call.getCallNumber()+"] in state "+this.underlyingCalls[T].state),this.underlyingCalls[T].state="COMPLETED",S.code===P.Status.OK){null===(R=this.retryThrottler)||void 0===R||R.addCallSucceeded(),this.commitCall(T),this.reportStatus(S);return}if("COMMITTED"===this.state){this.reportStatus(S);return}let O=this.getPushback(S.metadata);switch(S.progress){case"NOT_STARTED":this.startNewAttempt();break;case"REFUSED":this.transparentRetryUsed?this.handleProcessedStatus(S,T,O):(this.transparentRetryUsed=!0,this.startNewAttempt());break;case"DROP":this.commitCall(T),this.reportStatus(S);break;case"PROCESSED":this.handleProcessedStatus(S,T,O)}}maybeStartHedgingAttempt(){if("HEDGING"!==this.state||!this.callConfig.methodConfig.hedgingPolicy)return;let S=this.callConfig.methodConfig.hedgingPolicy;this.attempts>=Math.min(S.maxAttempts,5)||(this.attempts+=1,this.startNewAttempt(),this.maybeStartHedgingTimer())}maybeStartHedgingTimer(){var S,T,R;if(this.hedgingTimer&&clearTimeout(this.hedgingTimer),"HEDGING"!==this.state||!this.callConfig.methodConfig.hedgingPolicy)return;let P=this.callConfig.methodConfig.hedgingPolicy;if(this.attempts>=Math.min(P.maxAttempts,5))return;let O=null!==(S=P.hedgingDelay)&&void 0!==S?S:"0s",N=Number(O.substring(0,O.length-1));this.hedgingTimer=setTimeout(()=>{this.maybeStartHedgingAttempt()},1e3*N),null===(R=(T=this.hedgingTimer).unref)||void 0===R||R.call(T)}startNewAttempt(){let S=this.channel.createLoadBalancingCall(this.callConfig,this.methodName,this.host,this.credentials,this.deadline);this.trace("Created child call ["+S.getCallNumber()+"] for attempt "+this.attempts);let T=this.underlyingCalls.length;this.underlyingCalls.push({state:"ACTIVE",call:S,nextMessageToSend:0});let R=this.attempts-1,P=this.initialMetadata.clone();R>0&&P.set(L,`${R}`);let O=!1;S.start(P,{onReceiveMetadata:P=>{this.trace("Received metadata from child ["+S.getCallNumber()+"]"),this.commitCall(T),O=!0,R>0&&P.set(L,`${R}`),"ACTIVE"===this.underlyingCalls[T].state&&this.listener.onReceiveMetadata(P)},onReceiveMessage:R=>{this.trace("Received message from child ["+S.getCallNumber()+"]"),this.commitCall(T),"ACTIVE"===this.underlyingCalls[T].state&&this.listener.onReceiveMessage(R)},onReceiveStatus:P=>{this.trace("Received status from child ["+S.getCallNumber()+"]"),!O&&R>0&&P.metadata.set(L,`${R}`),this.handleChildStatus(P,T)}}),this.sendNextChildMessage(T),this.readStarted&&S.startRead()}start(S,T){this.trace("start called"),this.listener=T,this.initialMetadata=S,this.attempts+=1,this.startNewAttempt(),this.maybeStartHedgingTimer()}handleChildWriteCompleted(S){var T,R;let P=this.underlyingCalls[S],O=P.nextMessageToSend;null===(R=(T=this.getBufferEntry(O)).callback)||void 0===R||R.call(T),this.clearSentMessages(),P.nextMessageToSend+=1,this.sendNextChildMessage(S)}sendNextChildMessage(S){let T=this.underlyingCalls[S];if("COMPLETED"!==T.state&&this.getBufferEntry(T.nextMessageToSend)){let R=this.getBufferEntry(T.nextMessageToSend);switch(R.entryType){case"MESSAGE":T.call.sendMessageWithContext({callback:T=>{this.handleChildWriteCompleted(S)}},R.message.message);break;case"HALF_CLOSE":T.nextMessageToSend+=1,T.call.halfClose()}}}sendMessageWithContext(S,T){var R;this.trace("write() called with message of length "+T.length);let P={message:T,flags:S.flags},O=this.getNextBufferIndex(),N={entryType:"MESSAGE",message:P,allocated:this.bufferTracker.allocate(T.length,this.callNumber)};if(this.writeBuffer.push(N),N.allocated)for(let[P,N]of(null===(R=S.callback)||void 0===R||R.call(S),this.underlyingCalls.entries()))"ACTIVE"===N.state&&N.nextMessageToSend===O&&N.call.sendMessageWithContext({callback:S=>{this.handleChildWriteCompleted(P)}},T);else{if(this.commitCallWithMostMessages(),null===this.committedCallIndex)return;let R=this.underlyingCalls[this.committedCallIndex];N.callback=S.callback,"ACTIVE"===R.state&&R.nextMessageToSend===O&&R.call.sendMessageWithContext({callback:S=>{this.handleChildWriteCompleted(this.committedCallIndex)}},T)}}startRead(){for(let S of(this.trace("startRead called"),this.readStarted=!0,this.underlyingCalls))(null==S?void 0:S.state)==="ACTIVE"&&S.call.startRead()}halfClose(){this.trace("halfClose called");let S=this.getNextBufferIndex();for(let T of(this.writeBuffer.push({entryType:"HALF_CLOSE",allocated:!1}),this.underlyingCalls))(null==T?void 0:T.state)==="ACTIVE"&&T.nextMessageToSend===S&&(T.nextMessageToSend+=1,T.call.halfClose())}setCredentials(S){throw Error("Method not implemented.")}getMethod(){return this.methodName}getHost(){return this.host}};T.RetryingCall=RetryingCall},17574:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Http2ServerCallStream=T.ServerDuplexStreamImpl=T.ServerWritableStreamImpl=T.ServerReadableStreamImpl=T.ServerUnaryCallImpl=void 0;let P=R(82361),O=R(85158),N=R(12781),M=R(59796),L=R(69238),V=R(32908),U=R(80272),W=R(68200),K=R(9006),Q="server_call";function trace(S){W.trace(L.LogVerbosity.DEBUG,Q,S)}let $="grpc-accept-encoding",Y="grpc-encoding",X="grpc-message",Z="grpc-status",ee="grpc-timeout",et=/(\d{1,8})\s*([HMSmun])/,er={H:36e5,M:6e4,S:1e3,m:1,u:.001,n:1e-6},en={[$]:"identity,deflate,gzip",[Y]:"identity"},ei={[O.constants.HTTP2_HEADER_STATUS]:O.constants.HTTP_STATUS_OK,[O.constants.HTTP2_HEADER_CONTENT_TYPE]:"application/grpc+proto"},es={waitForTrailers:!0};let ServerUnaryCallImpl=class ServerUnaryCallImpl extends P.EventEmitter{constructor(S,T,R){super(),this.call=S,this.metadata=T,this.request=R,this.cancelled=!1,this.call.setupSurfaceCall(this)}getPeer(){return this.call.getPeer()}sendMetadata(S){this.call.sendMetadata(S)}getDeadline(){return this.call.getDeadline()}getPath(){return this.call.getPath()}};T.ServerUnaryCallImpl=ServerUnaryCallImpl;let ServerReadableStreamImpl=class ServerReadableStreamImpl extends N.Readable{constructor(S,T,R,P){super({objectMode:!0}),this.call=S,this.metadata=T,this.deserialize=R,this.cancelled=!1,this.call.setupSurfaceCall(this),this.call.setupReadable(this,P)}_read(S){this.call.consumeUnpushedMessages(this)&&this.call.resume()}getPeer(){return this.call.getPeer()}sendMetadata(S){this.call.sendMetadata(S)}getDeadline(){return this.call.getDeadline()}getPath(){return this.call.getPath()}};T.ServerReadableStreamImpl=ServerReadableStreamImpl;let ServerWritableStreamImpl=class ServerWritableStreamImpl extends N.Writable{constructor(S,T,R,P){super({objectMode:!0}),this.call=S,this.metadata=T,this.serialize=R,this.request=P,this.cancelled=!1,this.trailingMetadata=new V.Metadata,this.call.setupSurfaceCall(this),this.on("error",S=>{this.call.sendError(S),this.end()})}getPeer(){return this.call.getPeer()}sendMetadata(S){this.call.sendMetadata(S)}getDeadline(){return this.call.getDeadline()}getPath(){return this.call.getPath()}_write(S,T,R){try{let T=this.call.serializeMessage(S);if(!this.call.write(T)){this.call.once("drain",R);return}}catch(S){this.emit("error",{details:(0,K.getErrorMessage)(S),code:L.Status.INTERNAL})}R()}_final(S){this.call.sendStatus({code:L.Status.OK,details:"OK",metadata:this.trailingMetadata}),S(null)}end(S){return S&&(this.trailingMetadata=S),super.end()}};T.ServerWritableStreamImpl=ServerWritableStreamImpl;let ServerDuplexStreamImpl=class ServerDuplexStreamImpl extends N.Duplex{constructor(S,T,R,P,O){super({objectMode:!0}),this.call=S,this.metadata=T,this.serialize=R,this.deserialize=P,this.cancelled=!1,this.trailingMetadata=new V.Metadata,this.call.setupSurfaceCall(this),this.call.setupReadable(this,O),this.on("error",S=>{this.call.sendError(S),this.end()})}getPeer(){return this.call.getPeer()}sendMetadata(S){this.call.sendMetadata(S)}getDeadline(){return this.call.getDeadline()}getPath(){return this.call.getPath()}end(S){return S&&(this.trailingMetadata=S),super.end()}};T.ServerDuplexStreamImpl=ServerDuplexStreamImpl,ServerDuplexStreamImpl.prototype._read=ServerReadableStreamImpl.prototype._read,ServerDuplexStreamImpl.prototype._write=ServerWritableStreamImpl.prototype._write,ServerDuplexStreamImpl.prototype._final=ServerWritableStreamImpl.prototype._final;let Http2ServerCallStream=class Http2ServerCallStream extends P.EventEmitter{constructor(S,T,R){super(),this.stream=S,this.handler=T,this.cancelled=!1,this.deadlineTimer=null,this.statusSent=!1,this.deadline=1/0,this.wantTrailers=!1,this.metadataSent=!1,this.canPush=!1,this.isPushPending=!1,this.bufferedMessages=[],this.messagesToPush=[],this.maxSendMessageSize=L.DEFAULT_MAX_SEND_MESSAGE_LENGTH,this.maxReceiveMessageSize=L.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH,this.stream.once("error",S=>{}),this.stream.once("close",()=>{var S;trace("Request to method "+(null===(S=this.handler)||void 0===S?void 0:S.path)+" stream closed with rstCode "+this.stream.rstCode),!this.statusSent&&(this.cancelled=!0,this.emit("cancelled","cancelled"),this.emit("streamEnd",!1),this.sendStatus({code:L.Status.CANCELLED,details:"Cancelled by client",metadata:null}),this.deadlineTimer&&clearTimeout(this.deadlineTimer))}),this.stream.on("drain",()=>{this.emit("drain")}),"grpc.max_send_message_length"in R&&(this.maxSendMessageSize=R["grpc.max_send_message_length"]),"grpc.max_receive_message_length"in R&&(this.maxReceiveMessageSize=R["grpc.max_receive_message_length"])}checkCancelled(){return(this.stream.destroyed||this.stream.closed)&&(this.cancelled=!0),this.cancelled}getDecompressedMessage(S,T){let R=S.subarray(5);if("identity"===T)return R;if("deflate"!==T&&"gzip"!==T)return Promise.reject({code:L.Status.UNIMPLEMENTED,details:`Received message compressed with unsupported encoding "${T}"`});{let S;return S="deflate"===T?M.createInflate():M.createGunzip(),new Promise((T,P)=>{let O=0,N=[];S.on("data",T=>{N.push(T),O+=T.byteLength,-1!==this.maxReceiveMessageSize&&O>this.maxReceiveMessageSize&&(S.destroy(),P({code:L.Status.RESOURCE_EXHAUSTED,details:`Received message that decompresses to a size larger than ${this.maxReceiveMessageSize}`}))}),S.on("end",()=>{T(Buffer.concat(N))}),S.write(R),S.end()})}}sendMetadata(S){if(this.checkCancelled()||this.metadataSent)return;this.metadataSent=!0;let T=S?S.toHttp2Headers():null,R=Object.assign(Object.assign(Object.assign({},ei),en),T);this.stream.respond(R,es)}receiveMetadata(S){let T=V.Metadata.fromHttp2Headers(S);W.isTracerEnabled(Q)&&trace("Request to "+this.handler.path+" received headers "+JSON.stringify(T.toJSON()));let R=T.get(ee);if(R.length>0){let S=R[0].toString().match(et);if(null===S){let S=Error("Invalid deadline");return S.code=L.Status.OUT_OF_RANGE,this.sendError(S),T}let P=+S[1]*er[S[2]]|0,O=new Date;this.deadline=O.setMilliseconds(O.getMilliseconds()+P),this.deadlineTimer=setTimeout(handleExpiredDeadline,P,this),T.remove(ee)}return T.remove(O.constants.HTTP2_HEADER_ACCEPT_ENCODING),T.remove(O.constants.HTTP2_HEADER_TE),T.remove(O.constants.HTTP2_HEADER_CONTENT_TYPE),T.remove("grpc-accept-encoding"),T}receiveUnaryMessage(S){return new Promise((T,R)=>{let{stream:P}=this,O=0,N=this,M=[],V=this.maxReceiveMessageSize;function onData(S){if(O+=S.byteLength,-1!==V&&O>V){P.removeListener("data",onData),P.removeListener("end",onEnd),P.removeListener("error",onEnd),R({code:L.Status.RESOURCE_EXHAUSTED,details:`Received message larger than max (${O} vs. ${V})`});return}M.push(S)}function onEnd(V){if(P.removeListener("data",onData),P.removeListener("end",onEnd),P.removeListener("error",onEnd),void 0!==V){R({code:L.Status.INTERNAL,details:V.message});return}if(0===O){R({code:L.Status.INTERNAL,details:"received empty unary message"});return}N.emit("receiveMessage");let U=Buffer.concat(M,O),W=1===U.readUInt8(0),K=W?S:"identity",Q=N.getDecompressedMessage(U,K);if(Buffer.isBuffer(Q)){T(N.deserializeMessageWithInternalError(Q));return}Q.then(S=>T(N.deserializeMessageWithInternalError(S)),T=>R(T.code?T:{code:L.Status.INTERNAL,details:`Received "grpc-encoding" header "${S}" but ${S} decompression failed`}))}this.stream.on("data",onData),this.stream.on("end",onEnd),this.stream.on("error",onEnd)})}async deserializeMessageWithInternalError(S){try{return this.deserializeMessage(S)}catch(S){throw{details:(0,K.getErrorMessage)(S),code:L.Status.INTERNAL}}}serializeMessage(S){let T=this.handler.serialize(S),R=T.byteLength,P=Buffer.allocUnsafe(R+5);return P.writeUInt8(0,0),P.writeUInt32BE(R,1),T.copy(P,5),P}deserializeMessage(S){return this.handler.deserialize(S)}async sendUnaryMessage(S,T,R,P){if(!this.checkCancelled()){if(void 0===R&&(R=null),S){!Object.prototype.hasOwnProperty.call(S,"metadata")&&R&&(S.metadata=R),this.sendError(S);return}try{let S=this.serializeMessage(T);this.write(S),this.sendStatus({code:L.Status.OK,details:"OK",metadata:R})}catch(S){this.sendError({details:(0,K.getErrorMessage)(S),code:L.Status.INTERNAL})}}}sendStatus(S){var T,R;if(this.emit("callEnd",S.code),this.emit("streamEnd",S.code===L.Status.OK),!this.checkCancelled()){if(trace("Request to method "+(null===(T=this.handler)||void 0===T?void 0:T.path)+" ended with status code: "+L.Status[S.code]+" details: "+S.details),this.deadlineTimer&&clearTimeout(this.deadlineTimer),this.stream.headersSent)this.wantTrailers||(this.wantTrailers=!0,this.stream.once("wantTrailers",()=>{var T;let R=Object.assign({[Z]:S.code,[X]:encodeURI(S.details)},null===(T=S.metadata)||void 0===T?void 0:T.toHttp2Headers());this.stream.sendTrailers(R),this.statusSent=!0}),this.stream.end());else{let T=Object.assign(Object.assign({[Z]:S.code,[X]:encodeURI(S.details)},ei),null===(R=S.metadata)||void 0===R?void 0:R.toHttp2Headers());this.stream.respond(T,{endStream:!0}),this.statusSent=!0}}}sendError(S){let T={code:L.Status.UNKNOWN,details:"message"in S?S.message:"Unknown Error",metadata:"metadata"in S&&void 0!==S.metadata?S.metadata:null};"code"in S&&"number"==typeof S.code&&Number.isInteger(S.code)&&(T.code=S.code,"details"in S&&"string"==typeof S.details&&(T.details=S.details)),this.sendStatus(T)}write(S){if(!this.checkCancelled()){if(-1!==this.maxSendMessageSize&&S.length>this.maxSendMessageSize){this.sendError({code:L.Status.RESOURCE_EXHAUSTED,details:`Sent message larger than max (${S.length} vs. ${this.maxSendMessageSize})`});return}return this.sendMetadata(),this.emit("sendMessage"),this.stream.write(S)}}resume(){this.stream.resume()}setupSurfaceCall(S){this.once("cancelled",T=>{S.cancelled=!0,S.emit("cancelled",T)}),this.once("callEnd",T=>S.emit("callEnd",T))}setupReadable(S,T){let R=new U.StreamDecoder(this.maxReceiveMessageSize),P=!1,O=!1,N=!1,maybePushEnd=async()=>{N||!P||O||(N=!0,await this.pushOrBufferMessage(S,null))};this.stream.on("data",async P=>{let N;try{N=R.write(P)}catch(S){this.sendError({code:L.Status.RESOURCE_EXHAUSTED,details:S.message});return}for(let R of(O=!0,this.stream.pause(),N)){let P;this.emit("receiveMessage");let O=1===R.readUInt8(0),N=O?T:"identity";try{P=await this.getDecompressedMessage(R,N)}catch(S){this.sendError(S);return}if(!P)return;await this.pushOrBufferMessage(S,P)}O=!1,this.stream.resume(),await maybePushEnd()}),this.stream.once("end",async()=>{P=!0,await maybePushEnd()})}consumeUnpushedMessages(S){for(this.canPush=!0;this.messagesToPush.length>0;){let T=this.messagesToPush.shift(),R=S.push(T);if(null===T||!1===R){this.canPush=!1;break}}return this.canPush}async pushOrBufferMessage(S,T){this.isPushPending?this.bufferedMessages.push(T):await this.pushMessage(S,T)}async pushMessage(S,T){if(null===T){trace("Received end of stream"),this.canPush?S.push(null):this.messagesToPush.push(null);return}trace("Received message of length "+T.length),this.isPushPending=!0;try{let R=await this.deserializeMessage(T);this.canPush?S.push(R)||(this.canPush=!1,this.stream.pause()):this.messagesToPush.push(R)}catch(R){this.bufferedMessages.length=0;let T=(0,K.getErrorCode)(R);(null===T||T<L.Status.OK||T>L.Status.UNAUTHENTICATED)&&(T=L.Status.INTERNAL),S.emit("error",{details:(0,K.getErrorMessage)(R),code:T})}this.isPushPending=!1,this.bufferedMessages.length>0&&await this.pushMessage(S,this.bufferedMessages.shift())}getPeer(){var S;let T=null===(S=this.stream.session)||void 0===S?void 0:S.socket;return null!=T&&T.remoteAddress?T.remotePort?`${T.remoteAddress}:${T.remotePort}`:T.remoteAddress:"unknown"}getDeadline(){return this.deadline}getPath(){return this.handler.path}};function handleExpiredDeadline(S){let T=Error("Deadline exceeded");T.code=L.Status.DEADLINE_EXCEEDED,S.sendError(T),S.cancelled=!0,S.emit("cancelled","deadline")}T.Http2ServerCallStream=Http2ServerCallStream},62501:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.ServerCredentials=void 0;let P=R(66801);let ServerCredentials=class ServerCredentials{static createInsecure(){return new InsecureServerCredentials}static createSsl(S,T,R=!1){if(null!==S&&!Buffer.isBuffer(S))throw TypeError("rootCerts must be null or a Buffer");if(!Array.isArray(T))throw TypeError("keyCertPairs must be an array");if("boolean"!=typeof R)throw TypeError("checkClientCertificate must be a boolean");let O=[],N=[];for(let S=0;S<T.length;S++){let R=T[S];if(null===R||"object"!=typeof R)throw TypeError(`keyCertPair[${S}] must be an object`);if(!Buffer.isBuffer(R.private_key))throw TypeError(`keyCertPair[${S}].private_key must be a Buffer`);if(!Buffer.isBuffer(R.cert_chain))throw TypeError(`keyCertPair[${S}].cert_chain must be a Buffer`);O.push(R.cert_chain),N.push(R.private_key)}return new SecureServerCredentials({ca:S||(0,P.getDefaultRootsData)()||void 0,cert:O,key:N,requestCert:R,ciphers:P.CIPHER_SUITES})}};T.ServerCredentials=ServerCredentials;let InsecureServerCredentials=class InsecureServerCredentials extends ServerCredentials{_isSecure(){return!1}_getSettings(){return null}};let SecureServerCredentials=class SecureServerCredentials extends ServerCredentials{constructor(S){super(),this.options=S}_isSecure(){return!0}_getSettings(){return this.options}}},92903:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Server=void 0;let P=R(85158),O=R(69238),N=R(17574),M=R(62501),L=R(14755),V=R(68200),U=R(72782),W=R(14717),K=R(83316),Q=2147483647,$=2147483647,Y=2e4,{HTTP2_HEADER_PATH:X}=P.constants,Z="server";function noop(){}function getUnimplementedStatusResponse(S){return{code:O.Status.UNIMPLEMENTED,details:`The server does not implement the method ${S}`}}function getDefaultHandler(S,T){let R=getUnimplementedStatusResponse(T);switch(S){case"unary":return(S,T)=>{T(R,null)};case"clientStream":return(S,T)=>{T(R,null)};case"serverStream":return S=>{S.emit("error",R)};case"bidi":return S=>{S.emit("error",R)};default:throw Error(`Invalid handlerType ${S}`)}}let Server=class Server{constructor(S){var T,R,P,O;this.http2ServerList=[],this.handlers=new Map,this.sessions=new Map,this.started=!1,this.shutdown=!1,this.serverAddressString="null",this.channelzEnabled=!0,this.channelzTrace=new K.ChannelzTrace,this.callTracker=new K.ChannelzCallTracker,this.listenerChildrenTracker=new K.ChannelzChildrenTracker,this.sessionChildrenTracker=new K.ChannelzChildrenTracker,this.options=null!=S?S:{},0===this.options["grpc.enable_channelz"]&&(this.channelzEnabled=!1),this.channelzRef=(0,K.registerChannelzServer)(()=>this.getChannelzInfo(),this.channelzEnabled),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Server created"),this.maxConnectionAgeMs=null!==(T=this.options["grpc.max_connection_age_ms"])&&void 0!==T?T:Q,this.maxConnectionAgeGraceMs=null!==(R=this.options["grpc.max_connection_age_grace_ms"])&&void 0!==R?R:Q,this.keepaliveTimeMs=null!==(P=this.options["grpc.keepalive_time_ms"])&&void 0!==P?P:$,this.keepaliveTimeoutMs=null!==(O=this.options["grpc.keepalive_timeout_ms"])&&void 0!==O?O:Y,this.trace("Server constructed")}getChannelzInfo(){return{trace:this.channelzTrace,callTracker:this.callTracker,listenerChildren:this.listenerChildrenTracker.getChildLists(),sessionChildren:this.sessionChildrenTracker.getChildLists()}}getChannelzSessionInfoGetter(S){return()=>{var T,R,P;let O;let N=this.sessions.get(S),M=S.socket,L=M.remoteAddress?(0,U.stringToSubchannelAddress)(M.remoteAddress,M.remotePort):null,V=M.localAddress?(0,U.stringToSubchannelAddress)(M.localAddress,M.localPort):null;if(S.encrypted){let S=M,R=S.getCipher(),P=S.getCertificate(),N=S.getPeerCertificate();O={cipherSuiteStandardName:null!==(T=R.standardName)&&void 0!==T?T:null,cipherSuiteOtherName:R.standardName?null:R.name,localCertificate:P&&"raw"in P?P.raw:null,remoteCertificate:N&&"raw"in N?N.raw:null}}else O=null;let W={remoteAddress:L,localAddress:V,security:O,remoteName:null,streamsStarted:N.streamTracker.callsStarted,streamsSucceeded:N.streamTracker.callsSucceeded,streamsFailed:N.streamTracker.callsFailed,messagesSent:N.messagesSent,messagesReceived:N.messagesReceived,keepAlivesSent:0,lastLocalStreamCreatedTimestamp:null,lastRemoteStreamCreatedTimestamp:N.streamTracker.lastCallStartedTimestamp,lastMessageSentTimestamp:N.lastMessageSentTimestamp,lastMessageReceivedTimestamp:N.lastMessageReceivedTimestamp,localFlowControlWindow:null!==(R=S.state.localWindowSize)&&void 0!==R?R:null,remoteFlowControlWindow:null!==(P=S.state.remoteWindowSize)&&void 0!==P?P:null};return W}}trace(S){V.trace(O.LogVerbosity.DEBUG,Z,"("+this.channelzRef.id+") "+S)}addProtoService(){throw Error("Not implemented. Use addService() instead")}addService(S,T){if(null===S||"object"!=typeof S||null===T||"object"!=typeof T)throw Error("addService() requires two objects as arguments");let R=Object.keys(S);if(0===R.length)throw Error("Cannot add an empty service to a server");R.forEach(R=>{let P,O;let N=S[R];P=N.requestStream?N.responseStream?"bidi":"clientStream":N.responseStream?"serverStream":"unary";let M=T[R];void 0===M&&"string"==typeof N.originalName&&(M=T[N.originalName]),O=void 0!==M?M.bind(T):getDefaultHandler(P,R);let L=this.register(N.path,O,N.responseSerialize,N.requestDeserialize,P);if(!1===L)throw Error(`Method handler for ${N.path} already provided.`)})}removeService(S){if(null===S||"object"!=typeof S)throw Error("removeService() requires object as argument");let T=Object.keys(S);T.forEach(T=>{let R=S[T];this.unregister(R.path)})}bind(S,T){throw Error("Not implemented. Use bindAsync() instead")}bindAsync(S,T,R){if(!0===this.started)throw Error("server is already started");if(this.shutdown)throw Error("bindAsync called after shutdown");if("string"!=typeof S)throw TypeError("port must be a string");if(null===T||!(T instanceof M.ServerCredentials))throw TypeError("creds must be a ServerCredentials object");if("function"!=typeof R)throw TypeError("callback must be a function");let N=(0,W.parseUri)(S);if(null===N)throw Error(`Could not parse port "${S}"`);let Q=(0,L.mapUriDefaultScheme)(N);if(null===Q)throw Error(`Could not get a default scheme for port "${S}"`);let $={maxSendHeaderBlockLength:Number.MAX_SAFE_INTEGER};"grpc-node.max_session_memory"in this.options?$.maxSessionMemory=this.options["grpc-node.max_session_memory"]:$.maxSessionMemory=Number.MAX_SAFE_INTEGER,"grpc.max_concurrent_streams"in this.options&&($.settings={maxConcurrentStreams:this.options["grpc.max_concurrent_streams"]});let deferredCallback=(S,T)=>{process.nextTick(()=>R(S,T))},setupServer=()=>{let S;if(T._isSecure()){let R=Object.assign($,T._getSettings());R.enableTrace=1===this.options["grpc-node.tls_enable_trace"],(S=P.createSecureServer(R)).on("secureConnection",S=>{S.on("error",S=>{this.trace("An incoming TLS connection closed with error: "+S.message)})})}else S=P.createServer($);return S.setTimeout(0,noop),this._setupHandlers(S),S},bindSpecificPort=(S,T,R)=>0===S.length?Promise.resolve({port:T,count:R}):Promise.all(S.map(S=>{let R;this.trace("Attempting to bind "+(0,U.subchannelAddressToString)(S)),R=(0,U.isTcpSubchannelAddress)(S)?{host:S.host,port:T}:S;let P=setupServer();return new Promise((O,N)=>{let onError=T=>{this.trace("Failed to bind "+(0,U.subchannelAddressToString)(S)+" with error "+T.message),O(T)};P.once("error",onError),P.listen(R,()=>{let S;if(this.shutdown){P.close(),O(Error("bindAsync failed because server is shutdown"));return}let R=P.address();S="string"==typeof R?{path:R}:{host:R.address,port:R.port};let N=(0,K.registerChannelzSocket)((0,U.subchannelAddressToString)(S),()=>({localAddress:S,remoteAddress:null,security:null,remoteName:null,streamsStarted:0,streamsSucceeded:0,streamsFailed:0,messagesSent:0,messagesReceived:0,keepAlivesSent:0,lastLocalStreamCreatedTimestamp:null,lastRemoteStreamCreatedTimestamp:null,lastMessageSentTimestamp:null,lastMessageReceivedTimestamp:null,localFlowControlWindow:null,remoteFlowControlWindow:null}),this.channelzEnabled);this.channelzEnabled&&this.listenerChildrenTracker.refChild(N),this.http2ServerList.push({server:P,channelzRef:N}),this.trace("Successfully bound "+(0,U.subchannelAddressToString)(S)),O("port"in S?S.port:T),P.removeListener("error",onError)})})})).then(S=>{let P=0;for(let R of S)if("number"==typeof R&&(P+=1,R!==T))throw Error("Invalid state: multiple port numbers added from single address");return{port:T,count:P+R}}),bindWildcardPort=S=>{if(0===S.length)return Promise.resolve({port:0,count:0});let T=S[0],R=setupServer();return new Promise((P,O)=>{let onError=R=>{this.trace("Failed to bind "+(0,U.subchannelAddressToString)(T)+" with error "+R.message),P(bindWildcardPort(S.slice(1)))};R.once("error",onError),R.listen(T,()=>{if(this.shutdown){R.close(),P({port:0,count:0});return}let T=R.address(),O={host:T.address,port:T.port},N=(0,K.registerChannelzSocket)((0,U.subchannelAddressToString)(O),()=>({localAddress:O,remoteAddress:null,security:null,remoteName:null,streamsStarted:0,streamsSucceeded:0,streamsFailed:0,messagesSent:0,messagesReceived:0,keepAlivesSent:0,lastLocalStreamCreatedTimestamp:null,lastRemoteStreamCreatedTimestamp:null,lastMessageSentTimestamp:null,lastMessageReceivedTimestamp:null,localFlowControlWindow:null,remoteFlowControlWindow:null}),this.channelzEnabled);this.channelzEnabled&&this.listenerChildrenTracker.refChild(N),this.http2ServerList.push({server:R,channelzRef:N}),this.trace("Successfully bound "+(0,U.subchannelAddressToString)(O)),P(bindSpecificPort(S.slice(1),T.port,1)),R.removeListener("error",onError)})})},Y={onSuccessfulResolution:(T,R,P)=>{let N;if(Y.onSuccessfulResolution=()=>{},this.shutdown&&deferredCallback(Error("bindAsync failed because server is shutdown"),0),0===T.length){deferredCallback(Error(`No addresses resolved for port ${S}`),0);return}(N=(0,U.isTcpSubchannelAddress)(T[0])?0===T[0].port?bindWildcardPort(T):bindSpecificPort(T,T[0].port,0):bindSpecificPort(T,1,0)).then(S=>{if(0===S.count){let S=`No address added out of total ${T.length} resolved`;V.log(O.LogVerbosity.ERROR,S),deferredCallback(Error(S),0)}else S.count<T.length&&V.log(O.LogVerbosity.INFO,`WARNING Only ${S.count} addresses added out of total ${T.length} resolved`),deferredCallback(null,S.port)},S=>{let R=`No address added out of total ${T.length} resolved`;V.log(O.LogVerbosity.ERROR,R),deferredCallback(Error(R),0)})},onError:S=>{deferredCallback(Error(S.details),0)}},X=(0,L.createResolver)(Q,Y,this.options);X.updateResolution()}forceShutdown(){for(let{server:S,channelzRef:T}of this.http2ServerList)S.listening&&S.close(()=>{this.channelzEnabled&&(this.listenerChildrenTracker.unrefChild(T),(0,K.unregisterChannelzRef)(T))});this.started=!1,this.shutdown=!0,this.sessions.forEach((S,T)=>{T.destroy(P.constants.NGHTTP2_CANCEL)}),this.sessions.clear(),this.channelzEnabled&&(0,K.unregisterChannelzRef)(this.channelzRef)}register(S,T,R,P,O){return!this.handlers.has(S)&&(this.handlers.set(S,{func:T,serialize:R,deserialize:P,type:O,path:S}),!0)}unregister(S){return this.handlers.delete(S)}start(){if(0===this.http2ServerList.length||this.http2ServerList.every(({server:S})=>!0!==S.listening))throw Error("server must be bound in order to start");if(!0===this.started)throw Error("server is already started");this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Starting"),this.started=!0}tryShutdown(S){let wrappedCallback=T=>{this.channelzEnabled&&(0,K.unregisterChannelzRef)(this.channelzRef),S(T)},T=0;function maybeCallback(){0==--T&&wrappedCallback()}for(let{server:S,channelzRef:R}of(this.started=!1,this.shutdown=!0,this.http2ServerList))S.listening&&(T++,S.close(()=>{this.channelzEnabled&&(this.listenerChildrenTracker.unrefChild(R),(0,K.unregisterChannelzRef)(R)),maybeCallback()}));this.sessions.forEach((S,R)=>{R.closed||(T+=1,R.close(maybeCallback))}),0===T&&wrappedCallback()}addHttp2Port(){throw Error("Not yet implemented")}getChannelzRef(){return this.channelzRef}_verifyContentType(S,T){let R=T[P.constants.HTTP2_HEADER_CONTENT_TYPE];return!!("string"==typeof R&&R.startsWith("application/grpc"))||(S.respond({[P.constants.HTTP2_HEADER_STATUS]:P.constants.HTTP_STATUS_UNSUPPORTED_MEDIA_TYPE},{endStream:!0}),!1)}_retrieveHandler(S){this.trace("Received call to method "+S+" at address "+this.serverAddressString);let T=this.handlers.get(S);return void 0===T?(this.trace("No handler registered for method "+S+". Sending UNIMPLEMENTED status."),null):T}_respondWithError(S,T,R=null){let P=new N.Http2ServerCallStream(T,null,this.options);void 0===S.code&&(S.code=O.Status.INTERNAL),this.channelzEnabled&&(this.callTracker.addCallFailed(),null==R||R.streamTracker.addCallFailed()),P.sendError(S)}_channelzHandler(S,T){let R=this.sessions.get(S.session);if(this.callTracker.addCallStarted(),null==R||R.streamTracker.addCallStarted(),!this._verifyContentType(S,T)){this.callTracker.addCallFailed(),null==R||R.streamTracker.addCallFailed();return}let P=T[X],M=this._retrieveHandler(P);if(!M){this._respondWithError(getUnimplementedStatusResponse(P),S,R);return}let L=new N.Http2ServerCallStream(S,M,this.options);L.once("callEnd",S=>{S===O.Status.OK?this.callTracker.addCallSucceeded():this.callTracker.addCallFailed()}),R&&(L.once("streamEnd",S=>{S?R.streamTracker.addCallSucceeded():R.streamTracker.addCallFailed()}),L.on("sendMessage",()=>{R.messagesSent+=1,R.lastMessageSentTimestamp=new Date}),L.on("receiveMessage",()=>{R.messagesReceived+=1,R.lastMessageReceivedTimestamp=new Date})),this._runHandlerForCall(L,M,T)||(this.callTracker.addCallFailed(),null==R||R.streamTracker.addCallFailed(),L.sendError({code:O.Status.INTERNAL,details:`Unknown handler type: ${M.type}`}))}_streamHandler(S,T){if(!0!==this._verifyContentType(S,T))return;let R=T[X],P=this._retrieveHandler(R);if(!P){this._respondWithError(getUnimplementedStatusResponse(R),S,null);return}let M=new N.Http2ServerCallStream(S,P,this.options);this._runHandlerForCall(M,P,T)||M.sendError({code:O.Status.INTERNAL,details:`Unknown handler type: ${P.type}`})}_runHandlerForCall(S,T,R){var P;let O=S.receiveMetadata(R),N=null!==(P=O.get("grpc-encoding")[0])&&void 0!==P?P:"identity";O.remove("grpc-encoding");let{type:M}=T;if("unary"===M)handleUnary(S,T,O,N);else if("clientStream"===M)handleClientStreaming(S,T,O,N);else if("serverStream"===M)handleServerStreaming(S,T,O,N);else{if("bidi"!==M)return!1;handleBidiStreaming(S,T,O,N)}return!0}_setupHandlers(S){if(null===S)return;let T=S.address(),R="null";T&&(R="string"==typeof T?T:T.address+":"+T.port),this.serverAddressString=R;let O=this.channelzEnabled?this._channelzHandler:this._streamHandler;S.on("stream",O.bind(this)),S.on("session",S=>{var T,R,O,N,M;if(!this.started){S.destroy();return}let L=(0,K.registerChannelzSocket)(null!==(T=S.socket.remoteAddress)&&void 0!==T?T:"unknown",this.getChannelzSessionInfoGetter(S),this.channelzEnabled),V={ref:L,streamTracker:new K.ChannelzCallTracker,messagesSent:0,messagesReceived:0,lastMessageSentTimestamp:null,lastMessageReceivedTimestamp:null};this.sessions.set(S,V);let U=S.socket.remoteAddress;this.channelzEnabled&&(this.channelzTrace.addTrace("CT_INFO","Connection established by client "+U),this.sessionChildrenTracker.refChild(L));let W=null,$=null,Y=!1;if(this.maxConnectionAgeMs!==Q){let T=this.maxConnectionAgeMs/10,N=Math.random()*T*2-T;W=null===(O=(R=setTimeout(()=>{var T,R;Y=!0,this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Connection dropped by max connection age from "+U);try{S.goaway(P.constants.NGHTTP2_NO_ERROR,2147483647,Buffer.from("max_age"))}catch(T){S.destroy();return}S.close(),this.maxConnectionAgeGraceMs!==Q&&($=null===(R=(T=setTimeout(()=>{S.destroy()},this.maxConnectionAgeGraceMs)).unref)||void 0===R?void 0:R.call(T))},this.maxConnectionAgeMs+N)).unref)||void 0===O?void 0:O.call(R)}let X=null===(M=(N=setInterval(()=>{var T,R;let P=null===(R=(T=setTimeout(()=>{Y=!0,this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Connection dropped by keepalive timeout from "+U),S.close()},this.keepaliveTimeoutMs)).unref)||void 0===R?void 0:R.call(T);try{S.ping((S,T,R)=>{clearTimeout(P)})}catch(T){S.destroy()}},this.keepaliveTimeMs)).unref)||void 0===M?void 0:M.call(N);S.on("close",()=>{this.channelzEnabled&&(Y||this.channelzTrace.addTrace("CT_INFO","Connection dropped by client "+U),this.sessionChildrenTracker.unrefChild(L),(0,K.unregisterChannelzRef)(L)),W&&clearTimeout(W),$&&clearTimeout($),X&&clearTimeout(X),this.sessions.delete(S)})})}};async function handleUnary(S,T,R,P){try{let O=await S.receiveUnaryMessage(P);if(void 0===O||S.cancelled)return;let M=new N.ServerUnaryCallImpl(S,R,O);T.func(M,(T,R,P,O)=>{S.sendUnaryMessage(T,R,P,O)})}catch(T){S.sendError(T)}}function handleClientStreaming(S,T,R,P){let O=new N.ServerReadableStreamImpl(S,R,T.deserialize,P);function respond(T,R,P,N){O.destroy(),S.sendUnaryMessage(T,R,P,N)}S.cancelled||(O.on("error",respond),T.func(O,respond))}async function handleServerStreaming(S,T,R,P){try{let O=await S.receiveUnaryMessage(P);if(void 0===O||S.cancelled)return;let M=new N.ServerWritableStreamImpl(S,R,T.serialize,O);T.func(M)}catch(T){S.sendError(T)}}function handleBidiStreaming(S,T,R,P){let O=new N.ServerDuplexStreamImpl(S,R,T.serialize,T.deserialize,P);S.cancelled||T.func(O)}T.Server=Server},45914:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.extractAndSelectServiceConfig=T.validateServiceConfig=T.validateRetryThrottling=void 0;let P=R(22037),O=R(69238),N=R(77203),M=/^\d+(\.\d{1,9})?s$/,L="node";function validateName(S){if("service"in S&&""!==S.service){if("string"!=typeof S.service)throw Error(`Invalid method config name: invalid service: expected type string, got ${typeof S.service}`);if(!("method"in S)||""===S.method)return{service:S.service};if("string"!=typeof S.method)throw Error(`Invalid method config name: invalid method: expected type string, got ${typeof S.service}`);return{service:S.service,method:S.method}}if("method"in S&&void 0!==S.method)throw Error("Invalid method config name: method set with empty or unset service");return{}}function validateRetryPolicy(S){if(!("maxAttempts"in S)||!Number.isInteger(S.maxAttempts)||S.maxAttempts<2)throw Error("Invalid method config retry policy: maxAttempts must be an integer at least 2");if(!("initialBackoff"in S)||"string"!=typeof S.initialBackoff||!M.test(S.initialBackoff))throw Error("Invalid method config retry policy: initialBackoff must be a string consisting of a positive integer followed by s");if(!("maxBackoff"in S)||"string"!=typeof S.maxBackoff||!M.test(S.maxBackoff))throw Error("Invalid method config retry policy: maxBackoff must be a string consisting of a positive integer followed by s");if(!("backoffMultiplier"in S)||"number"!=typeof S.backoffMultiplier||S.backoffMultiplier<=0)throw Error("Invalid method config retry policy: backoffMultiplier must be a number greater than 0");if(!("retryableStatusCodes"in S&&Array.isArray(S.retryableStatusCodes)))throw Error("Invalid method config retry policy: retryableStatusCodes is required");if(0===S.retryableStatusCodes.length)throw Error("Invalid method config retry policy: retryableStatusCodes must be non-empty");for(let T of S.retryableStatusCodes)if("number"==typeof T){if(!Object.values(O.Status).includes(T))throw Error("Invalid method config retry policy: retryableStatusCodes value not in status code range")}else if("string"==typeof T){if(!Object.values(O.Status).includes(T.toUpperCase()))throw Error("Invalid method config retry policy: retryableStatusCodes value not a status code name")}else throw Error("Invalid method config retry policy: retryableStatusCodes value must be a string or number");return{maxAttempts:S.maxAttempts,initialBackoff:S.initialBackoff,maxBackoff:S.maxBackoff,backoffMultiplier:S.backoffMultiplier,retryableStatusCodes:S.retryableStatusCodes}}function validateHedgingPolicy(S){if(!("maxAttempts"in S)||!Number.isInteger(S.maxAttempts)||S.maxAttempts<2)throw Error("Invalid method config hedging policy: maxAttempts must be an integer at least 2");if("hedgingDelay"in S&&("string"!=typeof S.hedgingDelay||!M.test(S.hedgingDelay)))throw Error("Invalid method config hedging policy: hedgingDelay must be a string consisting of a positive integer followed by s");if("nonFatalStatusCodes"in S&&Array.isArray(S.nonFatalStatusCodes))for(let T of S.nonFatalStatusCodes)if("number"==typeof T){if(!Object.values(O.Status).includes(T))throw Error("Invlid method config hedging policy: nonFatalStatusCodes value not in status code range")}else if("string"==typeof T){if(!Object.values(O.Status).includes(T.toUpperCase()))throw Error("Invlid method config hedging policy: nonFatalStatusCodes value not a status code name")}else throw Error("Invlid method config hedging policy: nonFatalStatusCodes value must be a string or number");let T={maxAttempts:S.maxAttempts};return S.hedgingDelay&&(T.hedgingDelay=S.hedgingDelay),S.nonFatalStatusCodes&&(T.nonFatalStatusCodes=S.nonFatalStatusCodes),T}function validateMethodConfig(S){var T;let R={name:[]};if(!("name"in S)||!Array.isArray(S.name))throw Error("Invalid method config: invalid name array");for(let T of S.name)R.name.push(validateName(T));if("waitForReady"in S){if("boolean"!=typeof S.waitForReady)throw Error("Invalid method config: invalid waitForReady");R.waitForReady=S.waitForReady}if("timeout"in S){if("object"==typeof S.timeout){if(!("seconds"in S.timeout)||"number"!=typeof S.timeout.seconds)throw Error("Invalid method config: invalid timeout.seconds");if(!("nanos"in S.timeout)||"number"!=typeof S.timeout.nanos)throw Error("Invalid method config: invalid timeout.nanos");R.timeout=S.timeout}else if("string"==typeof S.timeout&&M.test(S.timeout)){let P=S.timeout.substring(0,S.timeout.length-1).split(".");R.timeout={seconds:0|P[0],nanos:(null!==(T=P[1])&&void 0!==T?T:0)|0}}else throw Error("Invalid method config: invalid timeout")}if("maxRequestBytes"in S){if("number"!=typeof S.maxRequestBytes)throw Error("Invalid method config: invalid maxRequestBytes");R.maxRequestBytes=S.maxRequestBytes}if("maxResponseBytes"in S){if("number"!=typeof S.maxResponseBytes)throw Error("Invalid method config: invalid maxRequestBytes");R.maxResponseBytes=S.maxResponseBytes}if("retryPolicy"in S){if("hedgingPolicy"in S)throw Error("Invalid method config: retryPolicy and hedgingPolicy cannot both be specified");R.retryPolicy=validateRetryPolicy(S.retryPolicy)}else"hedgingPolicy"in S&&(R.hedgingPolicy=validateHedgingPolicy(S.hedgingPolicy));return R}function validateRetryThrottling(S){if(!("maxTokens"in S)||"number"!=typeof S.maxTokens||S.maxTokens<=0||S.maxTokens>1e3)throw Error("Invalid retryThrottling: maxTokens must be a number in (0, 1000]");if(!("tokenRatio"in S)||"number"!=typeof S.tokenRatio||S.tokenRatio<=0)throw Error("Invalid retryThrottling: tokenRatio must be a number greater than 0");return{maxTokens:+S.maxTokens.toFixed(3),tokenRatio:+S.tokenRatio.toFixed(3)}}function validateServiceConfig(S){let T={loadBalancingConfig:[],methodConfig:[]};if("loadBalancingPolicy"in S){if("string"==typeof S.loadBalancingPolicy)T.loadBalancingPolicy=S.loadBalancingPolicy;else throw Error("Invalid service config: invalid loadBalancingPolicy")}if("loadBalancingConfig"in S){if(Array.isArray(S.loadBalancingConfig))for(let R of S.loadBalancingConfig)T.loadBalancingConfig.push((0,N.validateLoadBalancingConfig)(R));else throw Error("Invalid service config: invalid loadBalancingConfig")}if("methodConfig"in S&&Array.isArray(S.methodConfig))for(let R of S.methodConfig)T.methodConfig.push(validateMethodConfig(R));"retryThrottling"in S&&(T.retryThrottling=validateRetryThrottling(S.retryThrottling));let R=[];for(let S of T.methodConfig)for(let T of S.name){for(let S of R)if(T.service===S.service&&T.method===S.method)throw Error(`Invalid service config: duplicate name ${T.service}/${T.method}`);R.push(T)}return T}function validateCanaryConfig(S){if(!("serviceConfig"in S))throw Error("Invalid service config choice: missing service config");let T={serviceConfig:validateServiceConfig(S.serviceConfig)};if("clientLanguage"in S){if(Array.isArray(S.clientLanguage))for(let R of(T.clientLanguage=[],S.clientLanguage))if("string"==typeof R)T.clientLanguage.push(R);else throw Error("Invalid service config choice: invalid clientLanguage");else throw Error("Invalid service config choice: invalid clientLanguage")}if("clientHostname"in S){if(Array.isArray(S.clientHostname))for(let R of(T.clientHostname=[],S.clientHostname))if("string"==typeof R)T.clientHostname.push(R);else throw Error("Invalid service config choice: invalid clientHostname");else throw Error("Invalid service config choice: invalid clientHostname")}if("percentage"in S){if("number"==typeof S.percentage&&0<=S.percentage&&S.percentage<=100)T.percentage=S.percentage;else throw Error("Invalid service config choice: invalid percentage")}let R=["clientLanguage","percentage","clientHostname","serviceConfig"];for(let T in S)if(!R.includes(T))throw Error(`Invalid service config choice: unexpected field ${T}`);return T}function validateAndSelectCanaryConfig(S,T){if(!Array.isArray(S))throw Error("Invalid service config list");for(let R of S){let S=validateCanaryConfig(R);if("number"!=typeof S.percentage||!(T>S.percentage)){if(Array.isArray(S.clientHostname)){let T=!1;for(let R of S.clientHostname)R===P.hostname()&&(T=!0);if(!T)continue}if(Array.isArray(S.clientLanguage)){let T=!1;for(let R of S.clientLanguage)R===L&&(T=!0);if(!T)continue}return S.serviceConfig}}throw Error("No matching service config found")}function extractAndSelectServiceConfig(S,T){for(let R of S)if(R.length>0&&R[0].startsWith("grpc_config=")){let S=R.join("").substring(12),P=JSON.parse(S);return validateAndSelectCanaryConfig(P,T)}return null}T.validateRetryThrottling=validateRetryThrottling,T.validateServiceConfig=validateServiceConfig,T.extractAndSelectServiceConfig=extractAndSelectServiceConfig},9929:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.StatusBuilder=void 0;let StatusBuilder=class StatusBuilder{constructor(){this.code=null,this.details=null,this.metadata=null}withCode(S){return this.code=S,this}withDetails(S){return this.details=S,this}withMetadata(S){return this.metadata=S,this}build(){let S={};return null!==this.code&&(S.code=this.code),null!==this.details&&(S.details=this.details),null!==this.metadata&&(S.metadata=this.metadata),S}};T.StatusBuilder=StatusBuilder},80272:(S,T)=>{"use strict";var R;Object.defineProperty(T,"__esModule",{value:!0}),T.StreamDecoder=void 0,function(S){S[S.NO_DATA=0]="NO_DATA",S[S.READING_SIZE=1]="READING_SIZE",S[S.READING_MESSAGE=2]="READING_MESSAGE"}(R||(R={}));let StreamDecoder=class StreamDecoder{constructor(S){this.maxReadMessageLength=S,this.readState=R.NO_DATA,this.readCompressFlag=Buffer.alloc(1),this.readPartialSize=Buffer.alloc(4),this.readSizeRemaining=4,this.readMessageSize=0,this.readPartialMessage=[],this.readMessageRemaining=0}write(S){let T,P=0,O=[];for(;P<S.length;)switch(this.readState){case R.NO_DATA:this.readCompressFlag=S.slice(P,P+1),P+=1,this.readState=R.READING_SIZE,this.readPartialSize.fill(0),this.readSizeRemaining=4,this.readMessageSize=0,this.readMessageRemaining=0,this.readPartialMessage=[];break;case R.READING_SIZE:if(T=Math.min(S.length-P,this.readSizeRemaining),S.copy(this.readPartialSize,4-this.readSizeRemaining,P,P+T),this.readSizeRemaining-=T,P+=T,0===this.readSizeRemaining){if(this.readMessageSize=this.readPartialSize.readUInt32BE(0),-1!==this.maxReadMessageLength&&this.readMessageSize>this.maxReadMessageLength)throw Error(`Received message larger than max (${this.readMessageSize} vs ${this.maxReadMessageLength})`);if(this.readMessageRemaining=this.readMessageSize,this.readMessageRemaining>0)this.readState=R.READING_MESSAGE;else{let S=Buffer.concat([this.readCompressFlag,this.readPartialSize],5);this.readState=R.NO_DATA,O.push(S)}}break;case R.READING_MESSAGE:if(T=Math.min(S.length-P,this.readMessageRemaining),this.readPartialMessage.push(S.slice(P,P+T)),this.readMessageRemaining-=T,P+=T,0===this.readMessageRemaining){let S=[this.readCompressFlag,this.readPartialSize].concat(this.readPartialMessage),T=Buffer.concat(S,this.readMessageSize+5);this.readState=R.NO_DATA,O.push(T)}break;default:throw Error("Unexpected read state")}return O}};T.StreamDecoder=StreamDecoder},72782:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.stringToSubchannelAddress=T.subchannelAddressToString=T.subchannelAddressEqual=T.isTcpSubchannelAddress=void 0;let P=R(41808);function isTcpSubchannelAddress(S){return"port"in S}function subchannelAddressEqual(S,T){return!S&&!T||!!S&&!!T&&(isTcpSubchannelAddress(S)?isTcpSubchannelAddress(T)&&S.host===T.host&&S.port===T.port:!isTcpSubchannelAddress(T)&&S.path===T.path)}function subchannelAddressToString(S){return isTcpSubchannelAddress(S)?S.host+":"+S.port:S.path}T.isTcpSubchannelAddress=isTcpSubchannelAddress,T.subchannelAddressEqual=subchannelAddressEqual,T.subchannelAddressToString=subchannelAddressToString;let O=443;function stringToSubchannelAddress(S,T){return(0,P.isIP)(S)?{host:S,port:null!=T?T:O}:{path:S}}T.stringToSubchannelAddress=stringToSubchannelAddress},32210:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Http2SubchannelCall=void 0;let P=R(85158),O=R(22037),N=R(69238),M=R(32908),L=R(80272),V=R(68200),U=R(69238),W="subchannel_call";function getSystemErrorName(S){for(let[T,R]of Object.entries(O.constants.errno))if(R===S)return T;return"Unknown system error "+S}let Http2SubchannelCall=class Http2SubchannelCall{constructor(S,T,R,O,V){var U;this.http2Stream=S,this.callEventTracker=T,this.listener=R,this.transport=O,this.callId=V,this.isReadFilterPending=!1,this.isPushPending=!1,this.canPush=!1,this.readsClosed=!1,this.statusOutput=!1,this.unpushedReadMessages=[],this.mappedStatusCode=N.Status.UNKNOWN,this.finalStatus=null,this.internalError=null;let W=null!==(U=O.getOptions()["grpc.max_receive_message_length"])&&void 0!==U?U:N.DEFAULT_MAX_RECEIVE_MESSAGE_LENGTH;this.decoder=new L.StreamDecoder(W),S.on("response",(S,T)=>{let R="";for(let T of Object.keys(S))R+="		"+T+": "+S[T]+"\n";switch(this.trace("Received server headers:\n"+R),S[":status"]){case 400:this.mappedStatusCode=N.Status.INTERNAL;break;case 401:this.mappedStatusCode=N.Status.UNAUTHENTICATED;break;case 403:this.mappedStatusCode=N.Status.PERMISSION_DENIED;break;case 404:this.mappedStatusCode=N.Status.UNIMPLEMENTED;break;case 429:case 502:case 503:case 504:this.mappedStatusCode=N.Status.UNAVAILABLE;break;default:this.mappedStatusCode=N.Status.UNKNOWN}if(T&P.constants.NGHTTP2_FLAG_END_STREAM)this.handleTrailers(S);else{let T;try{T=M.Metadata.fromHttp2Headers(S)}catch(S){this.endCall({code:N.Status.UNKNOWN,details:S.message,metadata:new M.Metadata});return}this.listener.onReceiveMetadata(T)}}),S.on("trailers",S=>{this.handleTrailers(S)}),S.on("data",S=>{let T;if(!this.statusOutput){this.trace("receive HTTP/2 data frame of length "+S.length);try{T=this.decoder.write(S)}catch(S){this.cancelWithStatus(N.Status.RESOURCE_EXHAUSTED,S.message);return}for(let S of T)this.trace("parsed message of length "+S.length),this.callEventTracker.addMessageReceived(),this.tryPush(S)}}),S.on("end",()=>{this.readsClosed=!0,this.maybeOutputStatus()}),S.on("close",()=>{process.nextTick(()=>{var T;let R;if(this.trace("HTTP/2 stream closed with code "+S.rstCode),(null===(T=this.finalStatus)||void 0===T?void 0:T.code)===N.Status.OK)return;let O="";switch(S.rstCode){case P.constants.NGHTTP2_NO_ERROR:if(null!==this.finalStatus)return;R=N.Status.INTERNAL,O=`Received RST_STREAM with code ${S.rstCode}`;break;case P.constants.NGHTTP2_REFUSED_STREAM:R=N.Status.UNAVAILABLE,O="Stream refused by server";break;case P.constants.NGHTTP2_CANCEL:R=N.Status.CANCELLED,O="Call cancelled";break;case P.constants.NGHTTP2_ENHANCE_YOUR_CALM:R=N.Status.RESOURCE_EXHAUSTED,O="Bandwidth exhausted or memory limit exceeded";break;case P.constants.NGHTTP2_INADEQUATE_SECURITY:R=N.Status.PERMISSION_DENIED,O="Protocol not secure enough";break;case P.constants.NGHTTP2_INTERNAL_ERROR:R=N.Status.INTERNAL,null===this.internalError?O=`Received RST_STREAM with code ${S.rstCode} (Internal server error)`:"ECONNRESET"===this.internalError.code||"ETIMEDOUT"===this.internalError.code?(R=N.Status.UNAVAILABLE,O=this.internalError.message):O=`Received RST_STREAM with code ${S.rstCode} triggered by internal client error: ${this.internalError.message}`;break;default:R=N.Status.INTERNAL,O=`Received RST_STREAM with code ${S.rstCode}`}this.endCall({code:R,details:O,metadata:new M.Metadata,rstCode:S.rstCode})})}),S.on("error",S=>{"ERR_HTTP2_STREAM_ERROR"!==S.code&&(this.trace("Node error event: message="+S.message+" code="+S.code+" errno="+getSystemErrorName(S.errno)+" syscall="+S.syscall),this.internalError=S),this.callEventTracker.onStreamEnd(!1)})}onDisconnect(){this.endCall({code:N.Status.UNAVAILABLE,details:"Connection dropped",metadata:new M.Metadata})}outputStatus(){this.statusOutput||(this.statusOutput=!0,this.trace("ended with status: code="+this.finalStatus.code+' details="'+this.finalStatus.details+'"'),this.callEventTracker.onCallEnd(this.finalStatus),process.nextTick(()=>{this.listener.onReceiveStatus(this.finalStatus)}),this.http2Stream.resume())}trace(S){V.trace(U.LogVerbosity.DEBUG,W,"["+this.callId+"] "+S)}endCall(S){(null===this.finalStatus||this.finalStatus.code===N.Status.OK)&&(this.finalStatus=S,this.maybeOutputStatus()),this.destroyHttp2Stream()}maybeOutputStatus(){null===this.finalStatus||this.finalStatus.code===N.Status.OK&&(!this.readsClosed||0!==this.unpushedReadMessages.length||this.isReadFilterPending||this.isPushPending)||this.outputStatus()}push(S){this.trace("pushing to reader message of length "+(S instanceof Buffer?S.length:null)),this.canPush=!1,this.isPushPending=!0,process.nextTick(()=>{this.isPushPending=!1,this.statusOutput||(this.listener.onReceiveMessage(S),this.maybeOutputStatus())})}tryPush(S){this.canPush?(this.http2Stream.pause(),this.push(S)):(this.trace("unpushedReadMessages.push message of length "+S.length),this.unpushedReadMessages.push(S))}handleTrailers(S){let T;this.callEventTracker.onStreamEnd(!0);let R="";for(let T of Object.keys(S))R+="		"+T+": "+S[T]+"\n";this.trace("Received server trailers:\n"+R);try{T=M.Metadata.fromHttp2Headers(S)}catch(S){T=new M.Metadata}let P=T.getMap(),O=this.mappedStatusCode;if(O===N.Status.UNKNOWN&&"string"==typeof P["grpc-status"]){let S=Number(P["grpc-status"]);S in N.Status&&(O=S,this.trace("received status code "+S+" from server")),T.remove("grpc-status")}let L="";if("string"==typeof P["grpc-message"]){try{L=decodeURI(P["grpc-message"])}catch(S){L=P["grpc-message"]}T.remove("grpc-message"),this.trace('received status details string "'+L+'" from server')}let V={code:O,details:L,metadata:T};this.endCall(V)}destroyHttp2Stream(){var S;if(!this.http2Stream.destroyed){let T;T=(null===(S=this.finalStatus)||void 0===S?void 0:S.code)===N.Status.OK?P.constants.NGHTTP2_NO_ERROR:P.constants.NGHTTP2_CANCEL,this.trace("close http2 stream with code "+T),this.http2Stream.close(T)}}cancelWithStatus(S,T){this.trace("cancelWithStatus code: "+S+' details: "'+T+'"'),this.endCall({code:S,details:T,metadata:new M.Metadata})}getStatus(){return this.finalStatus}getPeer(){return this.transport.getPeerName()}getCallNumber(){return this.callId}startRead(){if(null!==this.finalStatus&&this.finalStatus.code!==N.Status.OK){this.readsClosed=!0,this.maybeOutputStatus();return}if(this.canPush=!0,this.unpushedReadMessages.length>0){let S=this.unpushedReadMessages.shift();this.push(S);return}this.http2Stream.resume()}sendMessageWithContext(S,T){this.trace("write() called with message of length "+T.length);let cb=T=>{process.nextTick(()=>{var R;let P=N.Status.UNAVAILABLE;(null==T?void 0:T.code)==="ERR_STREAM_WRITE_AFTER_END"&&(P=N.Status.INTERNAL),T&&this.cancelWithStatus(P,`Write error: ${T.message}`),null===(R=S.callback)||void 0===R||R.call(S)})};this.trace("sending data chunk of length "+T.length),this.callEventTracker.addMessageSent();try{this.http2Stream.write(T,cb)}catch(S){this.endCall({code:N.Status.UNAVAILABLE,details:`Write failed with error ${S.message}`,metadata:new M.Metadata})}}halfClose(){this.trace("end() called"),this.trace("calling end() on HTTP/2 stream"),this.http2Stream.end()}};T.Http2SubchannelCall=Http2SubchannelCall},69609:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.BaseSubchannelWrapper=void 0;let BaseSubchannelWrapper=class BaseSubchannelWrapper{constructor(S){this.child=S}getConnectivityState(){return this.child.getConnectivityState()}addConnectivityStateListener(S){this.child.addConnectivityStateListener(S)}removeConnectivityStateListener(S){this.child.removeConnectivityStateListener(S)}startConnecting(){this.child.startConnecting()}getAddress(){return this.child.getAddress()}throttleKeepalive(S){this.child.throttleKeepalive(S)}ref(){this.child.ref()}unref(){this.child.unref()}getChannelzRef(){return this.child.getChannelzRef()}getRealSubchannel(){return this.child.getRealSubchannel()}realSubchannelEquals(S){return this.getRealSubchannel()===S.getRealSubchannel()}};T.BaseSubchannelWrapper=BaseSubchannelWrapper},88364:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.getSubchannelPool=T.SubchannelPool=void 0;let P=R(70332),O=R(53904),N=R(72782),M=R(14717),L=R(16559),V=1e4;let SubchannelPool=class SubchannelPool{constructor(){this.pool=Object.create(null),this.cleanupTimer=null}unrefUnusedSubchannels(){let S=!0;for(let T in this.pool){let R=this.pool[T],P=R.filter(S=>!S.subchannel.unrefIfOneRef());P.length>0&&(S=!1),this.pool[T]=P}S&&null!==this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=null)}ensureCleanupTask(){var S,T;null===this.cleanupTimer&&(this.cleanupTimer=setInterval(()=>{this.unrefUnusedSubchannels()},V),null===(T=(S=this.cleanupTimer).unref)||void 0===T||T.call(S))}getOrCreateSubchannel(S,T,R,V){this.ensureCleanupTask();let U=(0,M.uriToString)(S);if(U in this.pool){let S=this.pool[U];for(let O of S)if((0,N.subchannelAddressEqual)(T,O.subchannelAddress)&&(0,P.channelOptionsEqual)(R,O.channelArguments)&&V._equals(O.channelCredentials))return O.subchannel}let W=new O.Subchannel(S,T,R,V,new L.Http2SubchannelConnector(S));return U in this.pool||(this.pool[U]=[]),this.pool[U].push({subchannelAddress:T,channelArguments:R,channelCredentials:V,subchannel:W}),W.ref(),W}};T.SubchannelPool=SubchannelPool;let U=new SubchannelPool;function getSubchannelPool(S){return S?U:new SubchannelPool}T.getSubchannelPool=getSubchannelPool},53904:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Subchannel=void 0;let P=R(91360),O=R(77257),N=R(68200),M=R(69238),L=R(14717),V=R(72782),U=R(83316),W="subchannel",K=2147483647;let Subchannel=class Subchannel{constructor(S,T,R,N,M){var L;this.channelTarget=S,this.subchannelAddress=T,this.options=R,this.credentials=N,this.connector=M,this.connectivityState=P.ConnectivityState.IDLE,this.transport=null,this.continueConnecting=!1,this.stateListeners=new Set,this.refcount=0,this.channelzEnabled=!0,this.callTracker=new U.ChannelzCallTracker,this.childrenTracker=new U.ChannelzChildrenTracker,this.streamTracker=new U.ChannelzCallTracker;let W={initialDelay:R["grpc.initial_reconnect_backoff_ms"],maxDelay:R["grpc.max_reconnect_backoff_ms"]};this.backoffTimeout=new O.BackoffTimeout(()=>{this.handleBackoffTimer()},W),this.backoffTimeout.unref(),this.subchannelAddressString=(0,V.subchannelAddressToString)(T),this.keepaliveTime=null!==(L=R["grpc.keepalive_time_ms"])&&void 0!==L?L:-1,0===R["grpc.enable_channelz"]&&(this.channelzEnabled=!1),this.channelzTrace=new U.ChannelzTrace,this.channelzRef=(0,U.registerChannelzSubchannel)(this.subchannelAddressString,()=>this.getChannelzInfo(),this.channelzEnabled),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Subchannel created"),this.trace("Subchannel constructed with options "+JSON.stringify(R,void 0,2))}getChannelzInfo(){return{state:this.connectivityState,trace:this.channelzTrace,callTracker:this.callTracker,children:this.childrenTracker.getChildLists(),target:this.subchannelAddressString}}trace(S){N.trace(M.LogVerbosity.DEBUG,W,"("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}refTrace(S){N.trace(M.LogVerbosity.DEBUG,"subchannel_refcount","("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}handleBackoffTimer(){this.continueConnecting?this.transitionToState([P.ConnectivityState.TRANSIENT_FAILURE],P.ConnectivityState.CONNECTING):this.transitionToState([P.ConnectivityState.TRANSIENT_FAILURE],P.ConnectivityState.IDLE)}startBackoff(){this.backoffTimeout.runOnce()}stopBackoff(){this.backoffTimeout.stop(),this.backoffTimeout.reset()}startConnectingInternal(){let S=this.options;if(S["grpc.keepalive_time_ms"]){let T=Math.min(this.keepaliveTime,K);S=Object.assign(Object.assign({},S),{"grpc.keepalive_time_ms":T})}this.connector.connect(this.subchannelAddress,this.credentials,S).then(S=>{this.transitionToState([P.ConnectivityState.CONNECTING],P.ConnectivityState.READY)?(this.transport=S,this.channelzEnabled&&this.childrenTracker.refChild(S.getChannelzRef()),S.addDisconnectListener(S=>{this.transitionToState([P.ConnectivityState.READY],P.ConnectivityState.IDLE),S&&this.keepaliveTime>0&&(this.keepaliveTime*=2,N.log(M.LogVerbosity.ERROR,`Connection to ${(0,L.uriToString)(this.channelTarget)} at ${this.subchannelAddressString} rejected by server because of excess pings. Increasing ping interval to ${this.keepaliveTime} ms`))})):S.shutdown()},S=>{this.transitionToState([P.ConnectivityState.CONNECTING],P.ConnectivityState.TRANSIENT_FAILURE,`${S}`)})}transitionToState(S,T,R){var O,N;if(-1===S.indexOf(this.connectivityState))return!1;this.trace(P.ConnectivityState[this.connectivityState]+" -> "+P.ConnectivityState[T]),this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Connectivity state change to "+P.ConnectivityState[T]);let M=this.connectivityState;switch(this.connectivityState=T,T){case P.ConnectivityState.READY:this.stopBackoff();break;case P.ConnectivityState.CONNECTING:this.startBackoff(),this.startConnectingInternal(),this.continueConnecting=!1;break;case P.ConnectivityState.TRANSIENT_FAILURE:this.channelzEnabled&&this.transport&&this.childrenTracker.unrefChild(this.transport.getChannelzRef()),null===(O=this.transport)||void 0===O||O.shutdown(),this.transport=null,this.backoffTimeout.isRunning()||process.nextTick(()=>{this.handleBackoffTimer()});break;case P.ConnectivityState.IDLE:this.channelzEnabled&&this.transport&&this.childrenTracker.unrefChild(this.transport.getChannelzRef()),null===(N=this.transport)||void 0===N||N.shutdown(),this.transport=null;break;default:throw Error(`Invalid state: unknown ConnectivityState ${T}`)}for(let S of this.stateListeners)S(this,M,T,this.keepaliveTime,R);return!0}ref(){this.refTrace("refcount "+this.refcount+" -> "+(this.refcount+1)),this.refcount+=1}unref(){this.refTrace("refcount "+this.refcount+" -> "+(this.refcount-1)),this.refcount-=1,0===this.refcount&&(this.channelzEnabled&&this.channelzTrace.addTrace("CT_INFO","Shutting down"),this.channelzEnabled&&(0,U.unregisterChannelzRef)(this.channelzRef),process.nextTick(()=>{this.transitionToState([P.ConnectivityState.CONNECTING,P.ConnectivityState.READY],P.ConnectivityState.IDLE)}))}unrefIfOneRef(){return 1===this.refcount&&(this.unref(),!0)}createCall(S,T,R,P){let O;if(!this.transport)throw Error("Cannot create call, subchannel not READY");return this.channelzEnabled?(this.callTracker.addCallStarted(),this.streamTracker.addCallStarted(),O={onCallEnd:S=>{S.code===M.Status.OK?this.callTracker.addCallSucceeded():this.callTracker.addCallFailed()}}):O={},this.transport.createCall(S,T,R,P,O)}startConnecting(){process.nextTick(()=>{this.transitionToState([P.ConnectivityState.IDLE],P.ConnectivityState.CONNECTING)||this.connectivityState!==P.ConnectivityState.TRANSIENT_FAILURE||(this.continueConnecting=!0)})}getConnectivityState(){return this.connectivityState}addConnectivityStateListener(S){this.stateListeners.add(S)}removeConnectivityStateListener(S){this.stateListeners.delete(S)}resetBackoff(){process.nextTick(()=>{this.backoffTimeout.reset(),this.transitionToState([P.ConnectivityState.TRANSIENT_FAILURE],P.ConnectivityState.CONNECTING)})}getAddress(){return this.subchannelAddressString}getChannelzRef(){return this.channelzRef}getRealSubchannel(){return this}realSubchannelEquals(S){return S.getRealSubchannel()===this}throttleKeepalive(S){S>this.keepaliveTime&&(this.keepaliveTime=S)}};T.Subchannel=Subchannel},66801:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.getDefaultRootsData=T.CIPHER_SUITES=void 0;let P=R(57147);T.CIPHER_SUITES=process.env.GRPC_SSL_CIPHER_SUITES;let O=process.env.GRPC_DEFAULT_SSL_ROOTS_FILE_PATH,N=null;function getDefaultRootsData(){return O?(null===N&&(N=P.readFileSync(O)),N):null}T.getDefaultRootsData=getDefaultRootsData},16559:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.Http2SubchannelConnector=void 0;let P=R(85158),O=R(24404),N=R(83316),M=R(69238),L=R(18304),V=R(68200),U=R(14755),W=R(72782),K=R(14717),Q=R(41808),$=R(32210),Y=R(60060),X="transport",Z="transport_flowctrl",ee=R(81513).i8,{HTTP2_HEADER_AUTHORITY:et,HTTP2_HEADER_CONTENT_TYPE:er,HTTP2_HEADER_METHOD:en,HTTP2_HEADER_PATH:ei,HTTP2_HEADER_TE:es,HTTP2_HEADER_USER_AGENT:ea}=P.constants,eo=2e4,eu=Buffer.from("too_many_pings","ascii");let Http2Transport=class Http2Transport{constructor(S,T,R,O){this.session=S,this.options=R,this.remoteName=O,this.keepaliveTimeMs=-1,this.keepaliveTimeoutMs=eo,this.keepaliveTimerId=null,this.pendingSendKeepalivePing=!1,this.keepaliveTimeoutId=null,this.keepaliveWithoutCalls=!1,this.activeCalls=new Set,this.disconnectListeners=[],this.disconnectHandled=!1,this.channelzEnabled=!0,this.streamTracker=new N.ChannelzCallTracker,this.keepalivesSent=0,this.messagesSent=0,this.messagesReceived=0,this.lastMessageSentTimestamp=null,this.lastMessageReceivedTimestamp=null,this.subchannelAddressString=(0,W.subchannelAddressToString)(T),0===R["grpc.enable_channelz"]&&(this.channelzEnabled=!1),this.channelzRef=(0,N.registerChannelzSocket)(this.subchannelAddressString,()=>this.getChannelzInfo(),this.channelzEnabled),this.userAgent=[R["grpc.primary_user_agent"],`grpc-node-js/${ee}`,R["grpc.secondary_user_agent"]].filter(S=>S).join(" "),"grpc.keepalive_time_ms"in R&&(this.keepaliveTimeMs=R["grpc.keepalive_time_ms"]),"grpc.keepalive_timeout_ms"in R&&(this.keepaliveTimeoutMs=R["grpc.keepalive_timeout_ms"]),"grpc.keepalive_permit_without_calls"in R?this.keepaliveWithoutCalls=1===R["grpc.keepalive_permit_without_calls"]:this.keepaliveWithoutCalls=!1,S.once("close",()=>{this.trace("session closed"),this.stopKeepalivePings(),this.handleDisconnect()}),S.once("goaway",(S,T,R)=>{let O=!1;S===P.constants.NGHTTP2_ENHANCE_YOUR_CALM&&R&&R.equals(eu)&&(O=!0),this.trace("connection closed by GOAWAY with code "+S+" and data "+(null==R?void 0:R.toString())),this.reportDisconnectToOwner(O)}),S.once("error",S=>{this.trace("connection closed with error "+S.message)}),V.isTracerEnabled(X)&&(S.on("remoteSettings",T=>{this.trace("new settings received"+(this.session!==S?" on the old connection":"")+": "+JSON.stringify(T))}),S.on("localSettings",T=>{this.trace("local settings acknowledged by remote"+(this.session!==S?" on the old connection":"")+": "+JSON.stringify(T))})),this.keepaliveWithoutCalls&&this.maybeStartKeepalivePingTimer()}getChannelzInfo(){var S,T,R;let P;let O=this.session.socket,N=O.remoteAddress?(0,W.stringToSubchannelAddress)(O.remoteAddress,O.remotePort):null,M=O.localAddress?(0,W.stringToSubchannelAddress)(O.localAddress,O.localPort):null;if(this.session.encrypted){let T=O,R=T.getCipher(),N=T.getCertificate(),M=T.getPeerCertificate();P={cipherSuiteStandardName:null!==(S=R.standardName)&&void 0!==S?S:null,cipherSuiteOtherName:R.standardName?null:R.name,localCertificate:N&&"raw"in N?N.raw:null,remoteCertificate:M&&"raw"in M?M.raw:null}}else P=null;let L={remoteAddress:N,localAddress:M,security:P,remoteName:this.remoteName,streamsStarted:this.streamTracker.callsStarted,streamsSucceeded:this.streamTracker.callsSucceeded,streamsFailed:this.streamTracker.callsFailed,messagesSent:this.messagesSent,messagesReceived:this.messagesReceived,keepAlivesSent:this.keepalivesSent,lastLocalStreamCreatedTimestamp:this.streamTracker.lastCallStartedTimestamp,lastRemoteStreamCreatedTimestamp:null,lastMessageSentTimestamp:this.lastMessageSentTimestamp,lastMessageReceivedTimestamp:this.lastMessageReceivedTimestamp,localFlowControlWindow:null!==(T=this.session.state.localWindowSize)&&void 0!==T?T:null,remoteFlowControlWindow:null!==(R=this.session.state.remoteWindowSize)&&void 0!==R?R:null};return L}trace(S){V.trace(M.LogVerbosity.DEBUG,X,"("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}keepaliveTrace(S){V.trace(M.LogVerbosity.DEBUG,"keepalive","("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}flowControlTrace(S){V.trace(M.LogVerbosity.DEBUG,Z,"("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}internalsTrace(S){V.trace(M.LogVerbosity.DEBUG,"transport_internals","("+this.channelzRef.id+") "+this.subchannelAddressString+" "+S)}reportDisconnectToOwner(S){this.disconnectHandled||(this.disconnectHandled=!0,this.disconnectListeners.forEach(T=>T(S)))}handleDisconnect(){this.reportDisconnectToOwner(!1),setImmediate(()=>{for(let S of this.activeCalls)S.onDisconnect()})}addDisconnectListener(S){this.disconnectListeners.push(S)}clearKeepaliveTimer(){this.keepaliveTimerId&&(clearTimeout(this.keepaliveTimerId),this.keepaliveTimerId=null)}clearKeepaliveTimeout(){this.keepaliveTimeoutId&&(clearTimeout(this.keepaliveTimeoutId),this.keepaliveTimeoutId=null)}canSendPing(){return this.keepaliveTimeMs>0&&(this.keepaliveWithoutCalls||this.activeCalls.size>0)}maybeSendPing(){var S,T;if(this.clearKeepaliveTimer(),!this.canSendPing()){this.pendingSendKeepalivePing=!0;return}this.channelzEnabled&&(this.keepalivesSent+=1),this.keepaliveTrace("Sending ping with timeout "+this.keepaliveTimeoutMs+"ms"),this.keepaliveTimeoutId||(this.keepaliveTimeoutId=setTimeout(()=>{this.keepaliveTrace("Ping timeout passed without response"),this.handleDisconnect()},this.keepaliveTimeoutMs),null===(T=(S=this.keepaliveTimeoutId).unref)||void 0===T||T.call(S));try{this.session.ping((S,T,R)=>{S&&(this.keepaliveTrace("Ping failed with error "+S.message),this.handleDisconnect()),this.keepaliveTrace("Received ping response"),this.clearKeepaliveTimeout(),this.maybeStartKeepalivePingTimer()})}catch(S){this.handleDisconnect()}}maybeStartKeepalivePingTimer(){var S,T;this.canSendPing()&&(this.pendingSendKeepalivePing?(this.pendingSendKeepalivePing=!1,this.maybeSendPing()):this.keepaliveTimerId||this.keepaliveTimeoutId||(this.keepaliveTrace("Starting keepalive timer for "+this.keepaliveTimeMs+"ms"),this.keepaliveTimerId=null===(T=(S=setTimeout(()=>{this.maybeSendPing()},this.keepaliveTimeMs)).unref)||void 0===T?void 0:T.call(S)))}stopKeepalivePings(){this.keepaliveTimerId&&(clearTimeout(this.keepaliveTimerId),this.keepaliveTimerId=null),this.clearKeepaliveTimeout()}removeActiveCall(S){this.activeCalls.delete(S),0===this.activeCalls.size&&this.session.unref()}addActiveCall(S){this.activeCalls.add(S),1!==this.activeCalls.size||(this.session.ref(),this.keepaliveWithoutCalls||this.maybeStartKeepalivePingTimer())}createCall(S,T,R,P,O){let N,M,L;let V=S.toHttp2Headers();V[et]=T,V[ea]=this.userAgent,V[er]="application/grpc",V[en]="POST",V[ei]=R,V[es]="trailers";try{N=this.session.request(V)}catch(S){throw this.handleDisconnect(),S}return this.flowControlTrace("local window size: "+this.session.state.localWindowSize+" remote window size: "+this.session.state.remoteWindowSize),this.internalsTrace("session.closed="+this.session.closed+" session.destroyed="+this.session.destroyed+" session.socket.destroyed="+this.session.socket.destroyed),this.channelzEnabled?(this.streamTracker.addCallStarted(),M={addMessageSent:()=>{var S;this.messagesSent+=1,this.lastMessageSentTimestamp=new Date,null===(S=O.addMessageSent)||void 0===S||S.call(O)},addMessageReceived:()=>{var S;this.messagesReceived+=1,this.lastMessageReceivedTimestamp=new Date,null===(S=O.addMessageReceived)||void 0===S||S.call(O)},onCallEnd:S=>{var T;null===(T=O.onCallEnd)||void 0===T||T.call(O,S),this.removeActiveCall(L)},onStreamEnd:S=>{var T;S?this.streamTracker.addCallSucceeded():this.streamTracker.addCallFailed(),null===(T=O.onStreamEnd)||void 0===T||T.call(O,S)}}):M={addMessageSent:()=>{var S;null===(S=O.addMessageSent)||void 0===S||S.call(O)},addMessageReceived:()=>{var S;null===(S=O.addMessageReceived)||void 0===S||S.call(O)},onCallEnd:S=>{var T;null===(T=O.onCallEnd)||void 0===T||T.call(O,S),this.removeActiveCall(L)},onStreamEnd:S=>{var T;null===(T=O.onStreamEnd)||void 0===T||T.call(O,S)}},L=new $.Http2SubchannelCall(N,M,P,this,(0,Y.getNextCallNumber)()),this.addActiveCall(L),L}getChannelzRef(){return this.channelzRef}getPeerName(){return this.subchannelAddressString}getOptions(){return this.options}shutdown(){this.session.close(),(0,N.unregisterChannelzRef)(this.channelzRef)}};let Http2SubchannelConnector=class Http2SubchannelConnector{constructor(S){this.channelTarget=S,this.session=null,this.isShutdown=!1}trace(S){V.trace(M.LogVerbosity.DEBUG,X,(0,K.uriToString)(this.channelTarget)+" "+S)}createSession(S,T,R,N){return this.isShutdown?Promise.reject():new Promise((M,L)=>{var V,$,Y;let X;N.realTarget?(X=(0,K.uriToString)(N.realTarget),this.trace("creating HTTP/2 session through proxy to "+(0,K.uriToString)(N.realTarget))):(X=null,this.trace("creating HTTP/2 session to "+(0,W.subchannelAddressToString)(S)));let Z=(0,U.getDefaultAuthority)(null!==(V=N.realTarget)&&void 0!==V?V:this.channelTarget),ee=T._getConnectionOptions()||{};ee.maxSendHeaderBlockLength=Number.MAX_SAFE_INTEGER,"grpc-node.max_session_memory"in R?ee.maxSessionMemory=R["grpc-node.max_session_memory"]:ee.maxSessionMemory=Number.MAX_SAFE_INTEGER;let et="http://";if("secureContext"in ee){if(et="https://",R["grpc.ssl_target_name_override"]){let S=R["grpc.ssl_target_name_override"];ee.checkServerIdentity=(T,R)=>(0,O.checkServerIdentity)(S,R),ee.servername=S}else{let S=null!==(Y=null===($=(0,K.splitHostPort)(Z))||void 0===$?void 0:$.host)&&void 0!==Y?Y:"localhost";ee.servername=S}N.socket&&(ee.createConnection=(S,T)=>N.socket)}else ee.createConnection=(T,R)=>N.socket?N.socket:Q.connect(S);ee=Object.assign(Object.assign(Object.assign({},ee),S),{enableTrace:1===R["grpc-node.tls_enable_trace"]});let er=P.connect(et+Z,ee);this.session=er;let en="Failed to connect";er.unref(),er.once("connect",()=>{er.removeAllListeners(),M(new Http2Transport(er,S,R,X)),this.session=null}),er.once("close",()=>{this.session=null,setImmediate(()=>{L(`${en} (${new Date().toISOString()})`)})}),er.once("error",S=>{en=S.message,this.trace("connection failed with error "+en)})})}connect(S,T,R){var P,N;if(this.isShutdown)return Promise.reject();let M=T._getConnectionOptions()||{};if("secureContext"in M){if(M.ALPNProtocols=["h2"],R["grpc.ssl_target_name_override"]){let S=R["grpc.ssl_target_name_override"];M.checkServerIdentity=(T,R)=>(0,O.checkServerIdentity)(S,R),M.servername=S}else if("grpc.http_connect_target"in R){let S=(0,U.getDefaultAuthority)(null!==(P=(0,K.parseUri)(R["grpc.http_connect_target"]))&&void 0!==P?P:{path:"localhost"}),T=(0,K.splitHostPort)(S);M.servername=null!==(N=null==T?void 0:T.host)&&void 0!==N?N:S}R["grpc-node.tls_enable_trace"]&&(M.enableTrace=!0)}return(0,L.getProxiedConnection)(S,R,M).then(P=>this.createSession(S,T,R,P))}shutdown(){var S;this.isShutdown=!0,null===(S=this.session)||void 0===S||S.close(),this.session=null}};T.Http2SubchannelConnector=Http2SubchannelConnector},14717:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),T.uriToString=T.splitHostPort=T.parseUri=void 0;let R=/^(?:([A-Za-z0-9+.-]+):)?(?:\/\/([^/]*)\/)?(.+)$/;function parseUri(S){let T=R.exec(S);return null===T?null:{scheme:T[1],authority:T[2],path:T[3]}}T.parseUri=parseUri;let P=/^\d+$/;function splitHostPort(S){if(S.startsWith("[")){let T=S.indexOf("]");if(-1===T)return null;let R=S.substring(1,T);if(-1===R.indexOf(":"))return null;if(!(S.length>T+1))return{host:R};if(":"!==S[T+1])return null;{let O=S.substring(T+2);return P.test(O)?{host:R,port:+O}:null}}{let T=S.split(":");return 2!==T.length?{host:S}:P.test(T[1])?{host:T[0],port:+T[1]}:null}}function uriToString(S){let T="";return void 0!==S.scheme&&(T+=S.scheme+":"),void 0!==S.authority&&(T+="//"+S.authority+"/"),T+=S.path}T.splitHostPort=splitHostPort,T.uriToString=uriToString},18196:(S,T,R)=>{"use strict";var P,O;/**
 * @license
 * Copyright 2018 gRPC authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */P={value:!0},P=P=T.im=T.J_=P=T.Cp=P=P=void 0;let N=R(19977),M=R(75962),L=R(95307),V=R(9234),U=R(16933);P=U,P=function(S){return"@type"in S&&"string"==typeof S["@type"]},function(S){S.IDEMPOTENCY_UNKNOWN="IDEMPOTENCY_UNKNOWN",S.NO_SIDE_EFFECTS="NO_SIDE_EFFECTS",S.IDEMPOTENT="IDEMPOTENT"}(O=T.Cp||(T.Cp={}));let W={longs:String,enums:String,bytes:String,defaults:!0,oneofs:!0,json:!0};function joinName(S,T){return""===S?T:S+"."+T}function isHandledReflectionObject(S){return S instanceof M.Service||S instanceof M.Type||S instanceof M.Enum}function isNamespaceBase(S){return S instanceof M.Namespace||S instanceof M.Root}function getAllHandledReflectionObjects(S,T){let R=joinName(T,S.name);return isHandledReflectionObject(S)?[[R,S]]:isNamespaceBase(S)&&void 0!==S.nested?Object.keys(S.nested).map(T=>getAllHandledReflectionObjects(S.nested[T],R)).reduce((S,T)=>S.concat(T),[]):[]}function createDeserializer(S,T){return function(R){return S.toObject(S.decode(R),T)}}function createSerializer(S){return function(T){if(Array.isArray(T))throw Error(`Failed to serialize message: expected object with ${S.name} structure, got array instead`);let R=S.fromObject(T);return S.encode(R).finish()}}function mapMethodOptions(S){return(S||[]).reduce((S,T)=>{for(let[R,P]of Object.entries(T))"uninterpreted_option"===R?S.uninterpreted_option.push(T.uninterpreted_option):S[R]=P;return S},{deprecated:!1,idempotency_level:O.IDEMPOTENCY_UNKNOWN,uninterpreted_option:[]})}function createMethodDefinition(S,T,R,P){let O=S.resolvedRequestType,M=S.resolvedResponseType;return{path:"/"+T+"/"+S.name,requestStream:!!S.requestStream,responseStream:!!S.responseStream,requestSerialize:createSerializer(O),requestDeserialize:createDeserializer(O,R),responseSerialize:createSerializer(M),responseDeserialize:createDeserializer(M,R),originalName:N(S.name),requestType:createMessageDefinition(O,P),responseType:createMessageDefinition(M,P),options:mapMethodOptions(S.parsedOptions)}}function createServiceDefinition(S,T,R,P){let O={};for(let N of S.methodsArray)O[N.name]=createMethodDefinition(N,T,R,P);return O}function createMessageDefinition(S,T){let R=S.toDescriptor("proto3");return{format:"Protocol Buffer 3 DescriptorProto",type:R.$type.toObject(R,W),fileDescriptorProtos:T}}function createEnumDefinition(S,T){let R=S.toDescriptor("proto3");return{format:"Protocol Buffer 3 EnumDescriptorProto",type:R.$type.toObject(R,W),fileDescriptorProtos:T}}function createDefinition(S,T,R,P){if(S instanceof M.Service)return createServiceDefinition(S,T,R,P);if(S instanceof M.Type)return createMessageDefinition(S,P);if(S instanceof M.Enum)return createEnumDefinition(S,P);throw Error("Type mismatch in reflection object handling")}function createPackageDefinition(S,T){let R={};S.resolveAll();let P=S.toDescriptor("proto3").file,O=P.map(S=>Buffer.from(L.FileDescriptorProto.encode(S).finish()));for(let[P,N]of getAllHandledReflectionObjects(S,""))R[P]=createDefinition(N,P,T,O);return R}function createPackageDefinitionFromDescriptorSet(S,T){T=T||{};let R=M.Root.fromDescriptor(S);return R.resolveAll(),createPackageDefinition(R,T)}function loadSync(S,T){let R=(0,V.loadProtosWithOptionsSync)(S,T);return createPackageDefinition(R,T)}function fromJSON(S,T){T=T||{};let R=M.Root.fromJSON(S);return R.resolveAll(),createPackageDefinition(R,T)}P=function(S,T){return(0,V.loadProtosWithOptions)(S,T).then(S=>createPackageDefinition(S,T))},T.J_=loadSync,T.im=fromJSON,P=function(S,T){let R=L.FileDescriptorSet.decode(S);return createPackageDefinitionFromDescriptorSet(R,T)},P=function(S,T){let R=L.FileDescriptorSet.fromObject(S);return createPackageDefinitionFromDescriptorSet(R,T)},(0,V.addCommonProtos)()},9234:(S,T,R)=>{"use strict";/**
 * @license
 * Copyright 2018 gRPC authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */Object.defineProperty(T,"__esModule",{value:!0}),T.addCommonProtos=T.loadProtosWithOptionsSync=T.loadProtosWithOptions=void 0;let P=R(57147),O=R(71017),N=R(75962);function addIncludePathResolver(S,T){let R=S.resolvePath;S.resolvePath=(S,N)=>{if(O.isAbsolute(N))return N;for(let S of T){let T=O.join(S,N);try{return P.accessSync(T,P.constants.R_OK),T}catch(S){continue}}return process.emitWarning(`${N} not found in any of the include paths ${T}`),R(S,N)}}async function loadProtosWithOptions(S,T){let R=new N.Root;if((T=T||{}).includeDirs){if(!Array.isArray(T.includeDirs))return Promise.reject(Error("The includeDirs option must be an array"));addIncludePathResolver(R,T.includeDirs)}let P=await R.load(S,T);return P.resolveAll(),P}function loadProtosWithOptionsSync(S,T){let R=new N.Root;if((T=T||{}).includeDirs){if(!Array.isArray(T.includeDirs))throw Error("The includeDirs option must be an array");addIncludePathResolver(R,T.includeDirs)}let P=R.loadSync(S,T);return P.resolveAll(),P}function addCommonProtos(){let S=R(56541),T=R(89987),P=R(57674),O=R(73795);N.common("api",S.nested.google.nested.protobuf.nested),N.common("descriptor",T.nested.google.nested.protobuf.nested),N.common("source_context",P.nested.google.nested.protobuf.nested),N.common("type",O.nested.google.nested.protobuf.nested)}T.loadProtosWithOptions=loadProtosWithOptions,T.loadProtosWithOptionsSync=loadProtosWithOptionsSync,T.addCommonProtos=addCommonProtos},18670:S=>{"use strict";function asPromise(S,T){for(var R=Array(arguments.length-1),P=0,O=2,N=!0;O<arguments.length;)R[P++]=arguments[O++];return new Promise(function(O,M){R[P]=function(S){if(N){if(N=!1,S)M(S);else{for(var T=Array(arguments.length-1),R=0;R<T.length;)T[R++]=arguments[R];O.apply(null,T)}}};try{S.apply(T||null,R)}catch(S){N&&(N=!1,M(S))}})}S.exports=asPromise},36009:(S,T)=>{"use strict";var R=T;R.length=function(S){var T=S.length;if(!T)return 0;for(var R=0;--T%4>1&&"="===S.charAt(T);)++R;return Math.ceil(3*S.length)/4-R};for(var P=Array(64),O=Array(123),N=0;N<64;)O[P[N]=N<26?N+65:N<52?N+71:N<62?N-4:N-59|43]=N++;R.encode=function(S,T,R){for(var O,N=null,M=[],L=0,V=0;T<R;){var U=S[T++];switch(V){case 0:M[L++]=P[U>>2],O=(3&U)<<4,V=1;break;case 1:M[L++]=P[O|U>>4],O=(15&U)<<2,V=2;break;case 2:M[L++]=P[O|U>>6],M[L++]=P[63&U],V=0}L>8191&&((N||(N=[])).push(String.fromCharCode.apply(String,M)),L=0)}return(V&&(M[L++]=P[O],M[L++]=61,1===V&&(M[L++]=61)),N)?(L&&N.push(String.fromCharCode.apply(String,M.slice(0,L))),N.join("")):String.fromCharCode.apply(String,M.slice(0,L))};var M="invalid encoding";R.decode=function(S,T,R){for(var P,N=R,L=0,V=0;V<S.length;){var U=S.charCodeAt(V++);if(61===U&&L>1)break;if(void 0===(U=O[U]))throw Error(M);switch(L){case 0:P=U,L=1;break;case 1:T[R++]=P<<2|(48&U)>>4,P=U,L=2;break;case 2:T[R++]=(15&P)<<4|(60&U)>>2,P=U,L=3;break;case 3:T[R++]=(3&P)<<6|U,L=0}}if(1===L)throw Error(M);return R-N},R.test=function(S){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(S)}},57311:S=>{"use strict";function codegen(S,T){"string"==typeof S&&(T=S,S=void 0);var R=[];function Codegen(S){if("string"!=typeof S){var T=toString();if(codegen.verbose&&console.log("codegen: "+T),T="return "+T,S){for(var P=Object.keys(S),O=Array(P.length+1),N=Array(P.length),M=0;M<P.length;)O[M]=P[M],N[M]=S[P[M++]];return O[M]=T,Function.apply(null,O).apply(null,N)}return Function(T)()}for(var L=Array(arguments.length-1),V=0;V<L.length;)L[V]=arguments[++V];if(V=0,S=S.replace(/%([%dfijs])/g,function(S,T){var R=L[V++];switch(T){case"d":case"f":return String(Number(R));case"i":return String(Math.floor(R));case"j":return JSON.stringify(R);case"s":return String(R)}return"%"}),V!==L.length)throw Error("parameter count mismatch");return R.push(S),Codegen}function toString(P){return"function "+(P||T||"")+"("+(S&&S.join(",")||"")+"){\n  "+R.join("\n  ")+"\n}"}return Codegen.toString=toString,Codegen}S.exports=codegen,codegen.verbose=!1},50107:S=>{"use strict";function EventEmitter(){this._listeners={}}S.exports=EventEmitter,EventEmitter.prototype.on=function(S,T,R){return(this._listeners[S]||(this._listeners[S]=[])).push({fn:T,ctx:R||this}),this},EventEmitter.prototype.off=function(S,T){if(void 0===S)this._listeners={};else if(void 0===T)this._listeners[S]=[];else for(var R=this._listeners[S],P=0;P<R.length;)R[P].fn===T?R.splice(P,1):++P;return this},EventEmitter.prototype.emit=function(S){var T=this._listeners[S];if(T){for(var R=[],P=1;P<arguments.length;)R.push(arguments[P++]);for(P=0;P<T.length;)T[P].fn.apply(T[P++].ctx,R)}return this}},82651:(S,T,R)=>{"use strict";S.exports=fetch;var P=R(18670),O=R(28031)("fs");function fetch(S,T,R){return("function"==typeof T?(R=T,T={}):T||(T={}),R)?!T.xhr&&O&&O.readFile?O.readFile(S,function(P,O){return P&&"undefined"!=typeof XMLHttpRequest?fetch.xhr(S,T,R):P?R(P):R(null,T.binary?O:O.toString("utf8"))}):fetch.xhr(S,T,R):P(fetch,this,S,T)}fetch.xhr=function(S,T,R){var P=new XMLHttpRequest;P.onreadystatechange=function(){if(4===P.readyState){if(0!==P.status&&200!==P.status)return R(Error("status "+P.status));if(T.binary){var S=P.response;if(!S){S=[];for(var O=0;O<P.responseText.length;++O)S.push(255&P.responseText.charCodeAt(O))}return R(null,"undefined"!=typeof Uint8Array?new Uint8Array(S):S)}return R(null,P.responseText)}},T.binary&&("overrideMimeType"in P&&P.overrideMimeType("text/plain; charset=x-user-defined"),P.responseType="arraybuffer"),P.open("GET",S),P.send()}},71188:S=>{"use strict";function factory(S){return"undefined"!=typeof Float32Array?function(){var T=new Float32Array([-0]),R=new Uint8Array(T.buffer),P=128===R[3];function writeFloat_f32_cpy(S,P,O){T[0]=S,P[O]=R[0],P[O+1]=R[1],P[O+2]=R[2],P[O+3]=R[3]}function writeFloat_f32_rev(S,P,O){T[0]=S,P[O]=R[3],P[O+1]=R[2],P[O+2]=R[1],P[O+3]=R[0]}function readFloat_f32_cpy(S,P){return R[0]=S[P],R[1]=S[P+1],R[2]=S[P+2],R[3]=S[P+3],T[0]}function readFloat_f32_rev(S,P){return R[3]=S[P],R[2]=S[P+1],R[1]=S[P+2],R[0]=S[P+3],T[0]}S.writeFloatLE=P?writeFloat_f32_cpy:writeFloat_f32_rev,S.writeFloatBE=P?writeFloat_f32_rev:writeFloat_f32_cpy,S.readFloatLE=P?readFloat_f32_cpy:readFloat_f32_rev,S.readFloatBE=P?readFloat_f32_rev:readFloat_f32_cpy}():function(){function writeFloat_ieee754(S,T,R,P){var O=T<0?1:0;if(O&&(T=-T),0===T)S(1/T>0?0:2147483648,R,P);else if(isNaN(T))S(2143289344,R,P);else if(T>34028234663852886e22)S((O<<31|2139095040)>>>0,R,P);else if(T<11754943508222875e-54)S((O<<31|Math.round(T/1401298464324817e-60))>>>0,R,P);else{var N=Math.floor(Math.log(T)/Math.LN2),M=8388607&Math.round(T*Math.pow(2,-N)*8388608);S((O<<31|N+127<<23|M)>>>0,R,P)}}function readFloat_ieee754(S,T,R){var P=S(T,R),O=(P>>31)*2+1,N=P>>>23&255,M=8388607&P;return 255===N?M?NaN:O*(1/0):0===N?1401298464324817e-60*O*M:O*Math.pow(2,N-150)*(M+8388608)}S.writeFloatLE=writeFloat_ieee754.bind(null,writeUintLE),S.writeFloatBE=writeFloat_ieee754.bind(null,writeUintBE),S.readFloatLE=readFloat_ieee754.bind(null,readUintLE),S.readFloatBE=readFloat_ieee754.bind(null,readUintBE)}(),"undefined"!=typeof Float64Array?function(){var T=new Float64Array([-0]),R=new Uint8Array(T.buffer),P=128===R[7];function writeDouble_f64_cpy(S,P,O){T[0]=S,P[O]=R[0],P[O+1]=R[1],P[O+2]=R[2],P[O+3]=R[3],P[O+4]=R[4],P[O+5]=R[5],P[O+6]=R[6],P[O+7]=R[7]}function writeDouble_f64_rev(S,P,O){T[0]=S,P[O]=R[7],P[O+1]=R[6],P[O+2]=R[5],P[O+3]=R[4],P[O+4]=R[3],P[O+5]=R[2],P[O+6]=R[1],P[O+7]=R[0]}function readDouble_f64_cpy(S,P){return R[0]=S[P],R[1]=S[P+1],R[2]=S[P+2],R[3]=S[P+3],R[4]=S[P+4],R[5]=S[P+5],R[6]=S[P+6],R[7]=S[P+7],T[0]}function readDouble_f64_rev(S,P){return R[7]=S[P],R[6]=S[P+1],R[5]=S[P+2],R[4]=S[P+3],R[3]=S[P+4],R[2]=S[P+5],R[1]=S[P+6],R[0]=S[P+7],T[0]}S.writeDoubleLE=P?writeDouble_f64_cpy:writeDouble_f64_rev,S.writeDoubleBE=P?writeDouble_f64_rev:writeDouble_f64_cpy,S.readDoubleLE=P?readDouble_f64_cpy:readDouble_f64_rev,S.readDoubleBE=P?readDouble_f64_rev:readDouble_f64_cpy}():function(){function writeDouble_ieee754(S,T,R,P,O,N){var M,L=P<0?1:0;if(L&&(P=-P),0===P)S(0,O,N+T),S(1/P>0?0:2147483648,O,N+R);else if(isNaN(P))S(0,O,N+T),S(2146959360,O,N+R);else if(P>17976931348623157e292)S(0,O,N+T),S((L<<31|2146435072)>>>0,O,N+R);else if(P<22250738585072014e-324)S((M=P/5e-324)>>>0,O,N+T),S((L<<31|M/4294967296)>>>0,O,N+R);else{var V=Math.floor(Math.log(P)/Math.LN2);1024===V&&(V=1023),S(4503599627370496*(M=P*Math.pow(2,-V))>>>0,O,N+T),S((L<<31|V+1023<<20|1048576*M&1048575)>>>0,O,N+R)}}function readDouble_ieee754(S,T,R,P,O){var N=S(P,O+T),M=S(P,O+R),L=(M>>31)*2+1,V=M>>>20&2047,U=4294967296*(1048575&M)+N;return 2047===V?U?NaN:L*(1/0):0===V?5e-324*L*U:L*Math.pow(2,V-1075)*(U+4503599627370496)}S.writeDoubleLE=writeDouble_ieee754.bind(null,writeUintLE,0,4),S.writeDoubleBE=writeDouble_ieee754.bind(null,writeUintBE,4,0),S.readDoubleLE=readDouble_ieee754.bind(null,readUintLE,0,4),S.readDoubleBE=readDouble_ieee754.bind(null,readUintBE,4,0)}(),S}function writeUintLE(S,T,R){T[R]=255&S,T[R+1]=S>>>8&255,T[R+2]=S>>>16&255,T[R+3]=S>>>24}function writeUintBE(S,T,R){T[R]=S>>>24,T[R+1]=S>>>16&255,T[R+2]=S>>>8&255,T[R+3]=255&S}function readUintLE(S,T){return(S[T]|S[T+1]<<8|S[T+2]<<16|S[T+3]<<24)>>>0}function readUintBE(S,T){return(S[T]<<24|S[T+1]<<16|S[T+2]<<8|S[T+3])>>>0}S.exports=factory(factory)},28031:module=>{"use strict";function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(e){}return null}module.exports=inquire},52768:(S,T)=>{"use strict";var R=T,P=R.isAbsolute=function(S){return/^(?:\/|\w+:)/.test(S)},O=R.normalize=function(S){var T=(S=S.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),R=P(S),O="";R&&(O=T.shift()+"/");for(var N=0;N<T.length;)".."===T[N]?N>0&&".."!==T[N-1]?T.splice(--N,2):R?T.splice(N,1):++N:"."===T[N]?T.splice(N,1):++N;return O+T.join("/")};R.resolve=function(S,T,R){return(R||(T=O(T)),P(T))?T:(R||(S=O(S)),(S=S.replace(/(?:\/|^)[^/]+$/,"")).length?O(S+"/"+T):T)}},14314:S=>{"use strict";function pool(S,T,R){var P=R||8192,O=P>>>1,N=null,M=P;return function(R){if(R<1||R>O)return S(R);M+R>P&&(N=S(P),M=0);var L=T.call(N,M,M+=R);return 7&M&&(M=(7|M)+1),L}}S.exports=pool},67148:(S,T)=>{"use strict";var R=T;R.length=function(S){for(var T=0,R=0,P=0;P<S.length;++P)(R=S.charCodeAt(P))<128?T+=1:R<2048?T+=2:(64512&R)==55296&&(64512&S.charCodeAt(P+1))==56320?(++P,T+=4):T+=3;return T},R.read=function(S,T,R){if(R-T<1)return"";for(var P,O=null,N=[],M=0;T<R;)(P=S[T++])<128?N[M++]=P:P>191&&P<224?N[M++]=(31&P)<<6|63&S[T++]:P>239&&P<365?(P=((7&P)<<18|(63&S[T++])<<12|(63&S[T++])<<6|63&S[T++])-65536,N[M++]=55296+(P>>10),N[M++]=56320+(1023&P)):N[M++]=(15&P)<<12|(63&S[T++])<<6|63&S[T++],M>8191&&((O||(O=[])).push(String.fromCharCode.apply(String,N)),M=0);return O?(M&&O.push(String.fromCharCode.apply(String,N.slice(0,M))),O.join("")):String.fromCharCode.apply(String,N.slice(0,M))},R.write=function(S,T,R){for(var P,O,N=R,M=0;M<S.length;++M)(P=S.charCodeAt(M))<128?T[R++]=P:(P<2048?T[R++]=P>>6|192:((64512&P)==55296&&(64512&(O=S.charCodeAt(M+1)))==56320?(P=65536+((1023&P)<<10)+(1023&O),++M,T[R++]=P>>18|240,T[R++]=P>>12&63|128):T[R++]=P>>12|224,T[R++]=P>>6&63|128),T[R++]=63&P|128);return R-N}},19977:S=>{var T=1/0,R="[object Symbol]",P=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,O=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,N="\ud800-\udfff",M="\\u0300-\\u036f\\ufe20-\\ufe23",L="\\u20d0-\\u20f0",V="\\u2700-\\u27bf",U="a-z\\xdf-\\xf6\\xf8-\\xff",W="A-Z\\xc0-\\xd6\\xd8-\\xde",K="\\ufe0e\\ufe0f",Q="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",$="[']",Y="["+N+"]",X="["+Q+"]",Z="["+M+L+"]",ee="\\d+",et="["+V+"]",er="["+U+"]",en="[^"+N+Q+ee+V+U+W+"]",ei="\ud83c[\udffb-\udfff]",es="[^"+N+"]",ea="(?:\ud83c[\udde6-\uddff]){2}",eo="[\ud800-\udbff][\udc00-\udfff]",eu="["+W+"]",ec="\\u200d",ed="(?:"+er+"|"+en+")",eh="(?:"+eu+"|"+en+")",ep="(?:"+$+"(?:d|ll|m|re|s|t|ve))?",ef="(?:"+$+"(?:D|LL|M|RE|S|T|VE))?",em="(?:"+Z+"|"+ei+")?",eg="["+K+"]?",ey="(?:"+ec+"(?:"+[es,ea,eo].join("|")+")"+eg+em+")*",ev=eg+em+ey,eS="(?:"+[et,ea,eo].join("|")+")"+ev,eb="(?:"+[es+Z+"?",Z,ea,eo,Y].join("|")+")",eC=RegExp($,"g"),eT=RegExp(Z,"g"),eE=RegExp(ei+"(?="+ei+")|"+eb+ev,"g"),ew=RegExp([eu+"?"+er+"+"+ep+"(?="+[X,eu,"$"].join("|")+")",eh+"+"+ef+"(?="+[X,eu+ed,"$"].join("|")+")",eu+"?"+ed+"+"+ep,eu+"+"+ef,ee,eS].join("|"),"g"),eD=RegExp("["+ec+N+M+L+K+"]"),eI=/[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,eR={:"A",:"A",:"A",:"A",:"A",:"A",:"a",:"a",:"a",:"a",:"a",:"a",:"C",:"c",:"D",:"d",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"N",:"n",:"O",:"O",:"O",:"O",:"O",:"O",:"o",:"o",:"o",:"o",:"o",:"o",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"Y",:"y",:"y",:"Ae",:"ae",:"Th",:"th",:"ss",:"A",:"A",:"A",:"a",:"a",:"a",:"C",:"C",:"C",:"C",:"c",:"c",:"c",:"c",:"D",:"D",:"d",:"d",:"E",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"e",:"G",:"G",:"G",:"G",:"g",:"g",:"g",:"g",:"H",:"H",:"h",:"h",:"I",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"i",:"J",:"j",:"K",:"k",:"k",:"L",:"L",:"L",:"L",:"L",:"l",:"l",:"l",:"l",:"l",:"N",:"N",:"N",:"N",:"n",:"n",:"n",:"n",:"O",:"O",:"O",:"o",:"o",:"o",:"R",:"R",:"R",:"r",:"r",:"r",:"S",:"S",:"S",:"S",:"s",:"s",:"s",:"s",:"T",:"T",:"T",:"t",:"t",:"t",:"U",:"U",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"u",:"u",:"W",:"w",:"Y",:"y",:"Y",:"Z",:"Z",:"Z",:"z",:"z",:"z",:"IJ",:"ij",:"Oe",:"oe",:"'n",:"ss"},e_="object"==typeof global&&global&&global.Object===Object&&global,eP="object"==typeof self&&self&&self.Object===Object&&self,eA=e_||eP||Function("return this")();function arrayReduce(S,T,R,P){var O=-1,N=S?S.length:0;for(P&&N&&(R=S[++O]);++O<N;)R=T(R,S[O],O,S);return R}function asciiToArray(S){return S.split("")}function asciiWords(S){return S.match(P)||[]}var eO=function(S){return function(T){return null==S?void 0:S[T]}}(eR);function hasUnicode(S){return eD.test(S)}function hasUnicodeWord(S){return eI.test(S)}function stringToArray(S){return hasUnicode(S)?unicodeToArray(S):asciiToArray(S)}function unicodeToArray(S){return S.match(eE)||[]}function unicodeWords(S){return S.match(ew)||[]}var eN=Object.prototype.toString,ek=eA.Symbol,ex=ek?ek.prototype:void 0,eM=ex?ex.toString:void 0;function baseSlice(S,T,R){var P=-1,O=S.length;T<0&&(T=-T>O?0:O+T),(R=R>O?O:R)<0&&(R+=O),O=T>R?0:R-T>>>0,T>>>=0;for(var N=Array(O);++P<O;)N[P]=S[P+T];return N}function baseToString(S){if("string"==typeof S)return S;if(isSymbol(S))return eM?eM.call(S):"";var R=S+"";return"0"==R&&1/S==-T?"-0":R}function castSlice(S,T,R){var P=S.length;return R=void 0===R?P:R,!T&&R>=P?S:baseSlice(S,T,R)}function createCaseFirst(S){return function(T){var R=hasUnicode(T=toString(T))?stringToArray(T):void 0,P=R?R[0]:T.charAt(0),O=R?castSlice(R,1).join(""):T.slice(1);return P[S]()+O}}function isObjectLike(S){return!!S&&"object"==typeof S}function isSymbol(S){return"symbol"==typeof S||isObjectLike(S)&&eN.call(S)==R}function toString(S){return null==S?"":baseToString(S)}var eF=function(S){return function(T){return arrayReduce(words(deburr(T).replace(eC,"")),S,"")}}(function(S,T,R){return T=T.toLowerCase(),S+(R?capitalize(T):T)});function capitalize(S){return eL(toString(S).toLowerCase())}function deburr(S){return(S=toString(S))&&S.replace(O,eO).replace(eT,"")}var eL=createCaseFirst("toUpperCase");function words(S,T,R){return(S=toString(S),void 0===(T=R?void 0:T))?hasUnicodeWord(S)?unicodeWords(S):asciiWords(S):S.match(T)||[]}S.exports=eF},39546:(S,T,R)=>{"use strict";R.d(T,{Z:()=>O});var P=R(3528);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let O=(0,P.Z)("FileText",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["line",{x1:"16",x2:"8",y1:"13",y2:"13",key:"14keom"}],["line",{x1:"16",x2:"8",y1:"17",y2:"17",key:"17nazh"}],["line",{x1:"10",x2:"8",y1:"9",y2:"9",key:"1a5vjj"}]])},11210:(S,T,R)=>{"use strict";R.d(T,{Z:()=>O});var P=R(3528);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let O=(0,P.Z)("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]])},37004:(S,T,R)=>{"use strict";R.d(T,{Z:()=>O});var P=R(3528);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let O=(0,P.Z)("Package",[["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["path",{d:"M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",key:"hh9hay"}],["path",{d:"m3.3 7 8.7 5 8.7-5",key:"g66t2b"}],["path",{d:"M12 22V12",key:"d0xqtd"}]])},71163:(S,T,R)=>{"use strict";R.d(T,{Z:()=>O});var P=R(3528);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let O=(0,P.Z)("Wallet",[["path",{d:"M21 12V7H5a2 2 0 0 1 0-4h14v4",key:"195gfw"}],["path",{d:"M3 5v14a2 2 0 0 0 2 2h16v-5",key:"195n9w"}],["path",{d:"M18 12a2 2 0 0 0 0 4h4v-4Z",key:"vllfpd"}]])},54401:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"addLocale",{enumerable:!0,get:function(){return addLocale}}),R(76945);let addLocale=function(S){for(var T=arguments.length,R=Array(T>1?T-1:0),P=1;P<T;P++)R[P-1]=arguments[P];return S};("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},66670:(S,T,R)=>{"use strict";function getDomainLocale(S,T,R,P){return!1}Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"getDomainLocale",{enumerable:!0,get:function(){return getDomainLocale}}),R(76945),("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},30614:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"default",{enumerable:!0,get:function(){return ee}});let P=R(82147),O=P._(R(9885)),N=R(62861),M=R(20058),L=R(30602),V=R(84679),U=R(54401),W=R(10713),K=R(82428),Q=R(32229),$=R(66670),Y=R(16879),X=R(3678);function isModifiedEvent(S){let T=S.currentTarget,R=T.getAttribute("target");return R&&"_self"!==R||S.metaKey||S.ctrlKey||S.shiftKey||S.altKey||S.nativeEvent&&2===S.nativeEvent.which}function linkClicked(S,T,R,P,N,L,V,U,W,K){let{nodeName:Q}=S.currentTarget,$="A"===Q.toUpperCase();if($&&(isModifiedEvent(S)||!W&&!(0,M.isLocalURL)(R)))return;S.preventDefault();let navigate=()=>{let S=null==V||V;"beforePopState"in T?T[N?"replace":"push"](R,P,{shallow:L,locale:U,scroll:S}):T[N?"replace":"push"](P||R,{forceOptimisticNavigation:!K,scroll:S})};W?O.default.startTransition(navigate):navigate()}function formatStringOrUrl(S){return"string"==typeof S?S:(0,L.formatUrl)(S)}let Z=O.default.forwardRef(function(S,T){let R,P;let{href:M,as:L,children:Z,prefetch:ee=null,passHref:et,replace:er,shallow:en,scroll:ei,locale:es,onClick:ea,onMouseEnter:eo,onTouchStart:eu,legacyBehavior:ec=!1,...ed}=S;R=Z,ec&&("string"==typeof R||"number"==typeof R)&&(R=O.default.createElement("a",null,R));let eh=O.default.useContext(W.RouterContext),ep=O.default.useContext(K.AppRouterContext),ef=null!=eh?eh:ep,em=!eh,eg=!1!==ee,ey=null===ee?X.PrefetchKind.AUTO:X.PrefetchKind.FULL,{href:ev,as:eS}=O.default.useMemo(()=>{if(!eh){let S=formatStringOrUrl(M);return{href:S,as:L?formatStringOrUrl(L):S}}let[S,T]=(0,N.resolveHref)(eh,M,!0);return{href:S,as:L?(0,N.resolveHref)(eh,L):T||S}},[eh,M,L]),eb=O.default.useRef(ev),eC=O.default.useRef(eS);ec&&(P=O.default.Children.only(R));let eT=ec?P&&"object"==typeof P&&P.ref:T,[eE,ew,eD]=(0,Q.useIntersection)({rootMargin:"200px"}),eI=O.default.useCallback(S=>{(eC.current!==eS||eb.current!==ev)&&(eD(),eC.current=eS,eb.current=ev),eE(S),eT&&("function"==typeof eT?eT(S):"object"==typeof eT&&(eT.current=S))},[eS,eT,ev,eD,eE]);O.default.useEffect(()=>{},[eS,ev,ew,es,eg,null==eh?void 0:eh.locale,ef,em,ey]);let eR={ref:eI,onClick(S){ec||"function"!=typeof ea||ea(S),ec&&P.props&&"function"==typeof P.props.onClick&&P.props.onClick(S),ef&&!S.defaultPrevented&&linkClicked(S,ef,ev,eS,er,en,ei,es,em,eg)},onMouseEnter(S){ec||"function"!=typeof eo||eo(S),ec&&P.props&&"function"==typeof P.props.onMouseEnter&&P.props.onMouseEnter(S)},onTouchStart(S){ec||"function"!=typeof eu||eu(S),ec&&P.props&&"function"==typeof P.props.onTouchStart&&P.props.onTouchStart(S)}};if((0,V.isAbsoluteUrl)(eS))eR.href=eS;else if(!ec||et||"a"===P.type&&!("href"in P.props)){let S=void 0!==es?es:null==eh?void 0:eh.locale,T=(null==eh?void 0:eh.isLocaleDomain)&&(0,$.getDomainLocale)(eS,S,null==eh?void 0:eh.locales,null==eh?void 0:eh.domainLocales);eR.href=T||(0,Y.addBasePath)((0,U.addLocale)(eS,S,null==eh?void 0:eh.defaultLocale))}return ec?O.default.cloneElement(P,eR):O.default.createElement("a",{...ed,...eR},R)}),ee=Z;("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},14149:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{requestIdleCallback:function(){return R},cancelIdleCallback:function(){return P}});let R="undefined"!=typeof self&&self.requestIdleCallback&&self.requestIdleCallback.bind(window)||function(S){let T=Date.now();return self.setTimeout(function(){S({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-T))}})},1)},P="undefined"!=typeof self&&self.cancelIdleCallback&&self.cancelIdleCallback.bind(window)||function(S){return clearTimeout(S)};("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},62861:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"resolveHref",{enumerable:!0,get:function(){return resolveHref}});let P=R(56141),O=R(30602),N=R(37739),M=R(84679),L=R(76945),V=R(20058),U=R(33751),W=R(44006);function resolveHref(S,T,R){let K;let Q="string"==typeof T?T:(0,O.formatWithValidation)(T),$=Q.match(/^[a-zA-Z]{1,}:\/\//),Y=$?Q.slice($[0].length):Q,X=Y.split("?");if((X[0]||"").match(/(\/\/|\\)/)){console.error("Invalid href '"+Q+"' passed to next/router in page: '"+S.pathname+"'. Repeated forward-slashes (//) or backslashes \\ are not valid in the href.");let T=(0,M.normalizeRepeatedSlashes)(Y);Q=($?$[0]:"")+T}if(!(0,V.isLocalURL)(Q))return R?[Q]:Q;try{K=new URL(Q.startsWith("#")?S.asPath:S.pathname,"http://n")}catch(S){K=new URL("/","http://n")}try{let S=new URL(Q,K);S.pathname=(0,L.normalizePathTrailingSlash)(S.pathname);let T="";if((0,U.isDynamicRoute)(S.pathname)&&S.searchParams&&R){let R=(0,P.searchParamsToUrlQuery)(S.searchParams),{result:M,params:L}=(0,W.interpolateAs)(S.pathname,S.pathname,R);M&&(T=(0,O.formatWithValidation)({pathname:M,hash:S.hash,query:(0,N.omit)(R,L)}))}let M=S.origin===K.origin?S.href.slice(S.origin.length):S.href;return R?[M,T||M]:M}catch(S){return R?[Q]:Q}}("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},32229:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"useIntersection",{enumerable:!0,get:function(){return useIntersection}});let P=R(9885),O=R(14149),N="function"==typeof IntersectionObserver,M=new Map,L=[];function createObserver(S){let T;let R={root:S.root||null,margin:S.rootMargin||""},P=L.find(S=>S.root===R.root&&S.margin===R.margin);if(P&&(T=M.get(P)))return T;let O=new Map,N=new IntersectionObserver(S=>{S.forEach(S=>{let T=O.get(S.target),R=S.isIntersecting||S.intersectionRatio>0;T&&R&&T(R)})},S);return T={id:R,observer:N,elements:O},L.push(R),M.set(R,T),T}function observe(S,T,R){let{id:P,observer:O,elements:N}=createObserver(R);return N.set(S,T),O.observe(S),function(){if(N.delete(S),O.unobserve(S),0===N.size){O.disconnect(),M.delete(P);let S=L.findIndex(S=>S.root===P.root&&S.margin===P.margin);S>-1&&L.splice(S,1)}}}function useIntersection(S){let{rootRef:T,rootMargin:R,disabled:M}=S,L=M||!N,[V,U]=(0,P.useState)(!1),W=(0,P.useRef)(null),K=(0,P.useCallback)(S=>{W.current=S},[]);(0,P.useEffect)(()=>{if(N){if(L||V)return;let S=W.current;if(S&&S.tagName){let P=observe(S,S=>S&&U(S),{root:null==T?void 0:T.current,rootMargin:R});return P}}else if(!V){let S=(0,O.requestIdleCallback)(()=>U(!0));return()=>(0,O.cancelIdleCallback)(S)}},[L,R,T,V,W.current]);let Q=(0,P.useCallback)(()=>{U(!1)},[]);return[K,V,Q]}("function"==typeof T.default||"object"==typeof T.default&&null!==T.default)&&void 0===T.default.__esModule&&(Object.defineProperty(T.default,"__esModule",{value:!0}),Object.assign(T.default,T),S.exports=T.default)},50821:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"escapeStringRegexp",{enumerable:!0,get:function(){return escapeStringRegexp}});let R=/[|\\{}()[\]^$+*?.-]/,P=/[|\\{}()[\]^$+*?.-]/g;function escapeStringRegexp(S){return R.test(S)?S.replace(P,"\\$&"):S}},30602:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{formatUrl:function(){return formatUrl},urlObjectKeys:function(){return M},formatWithValidation:function(){return formatWithValidation}});let P=R(4009),O=P._(R(56141)),N=/https?|ftp|gopher|file/;function formatUrl(S){let{auth:T,hostname:R}=S,P=S.protocol||"",M=S.pathname||"",L=S.hash||"",V=S.query||"",U=!1;T=T?encodeURIComponent(T).replace(/%3A/i,":")+"@":"",S.host?U=T+S.host:R&&(U=T+(~R.indexOf(":")?"["+R+"]":R),S.port&&(U+=":"+S.port)),V&&"object"==typeof V&&(V=String(O.urlQueryToSearchParams(V)));let W=S.search||V&&"?"+V||"";return P&&!P.endsWith(":")&&(P+=":"),S.slashes||(!P||N.test(P))&&!1!==U?(U="//"+(U||""),M&&"/"!==M[0]&&(M="/"+M)):U||(U=""),L&&"#"!==L[0]&&(L="#"+L),W&&"?"!==W[0]&&(W="?"+W),""+P+U+(M=M.replace(/[?#]/g,encodeURIComponent))+(W=W.replace("#","%23"))+L}let M=["auth","hash","host","hostname","href","path","pathname","port","protocol","query","search","slashes"];function formatWithValidation(S){return formatUrl(S)}},33751:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{getSortedRoutes:function(){return P.getSortedRoutes},isDynamicRoute:function(){return O.isDynamicRoute}});let P=R(72861),O=R(21534)},44006:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"interpolateAs",{enumerable:!0,get:function(){return interpolateAs}});let P=R(43630),O=R(80680);function interpolateAs(S,T,R){let N="",M=(0,O.getRouteRegex)(S),L=M.groups,V=(T!==S?(0,P.getRouteMatcher)(M)(T):"")||R;N=S;let U=Object.keys(L);return U.every(S=>{let T=V[S]||"",{repeat:R,optional:P}=L[S],O="["+(R?"...":"")+S+"]";return P&&(O=(T?"":"/")+"["+O+"]"),R&&!Array.isArray(T)&&(T=[T]),(P||S in V)&&(N=N.replace(O,R?T.map(S=>encodeURIComponent(S)).join("/"):encodeURIComponent(T))||"/")})||(N=""),{params:U,result:N}}},21534:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"isDynamicRoute",{enumerable:!0,get:function(){return isDynamicRoute}});let R=/\/\[[^/]+?\](?=\/|$)/;function isDynamicRoute(S){return R.test(S)}},20058:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"isLocalURL",{enumerable:!0,get:function(){return isLocalURL}});let P=R(84679),O=R(99760);function isLocalURL(S){if(!(0,P.isAbsoluteUrl)(S))return!0;try{let T=(0,P.getLocationOrigin)(),R=new URL(S,T);return R.origin===T&&(0,O.hasBasePath)(R.pathname)}catch(S){return!1}}},37739:(S,T)=>{"use strict";function omit(S,T){let R={};return Object.keys(S).forEach(P=>{T.includes(P)||(R[P]=S[P])}),R}Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"omit",{enumerable:!0,get:function(){return omit}})},56141:(S,T)=>{"use strict";function searchParamsToUrlQuery(S){let T={};return S.forEach((S,R)=>{void 0===T[R]?T[R]=S:Array.isArray(T[R])?T[R].push(S):T[R]=[T[R],S]}),T}function stringifyUrlQueryParam(S){return"string"!=typeof S&&("number"!=typeof S||isNaN(S))&&"boolean"!=typeof S?"":String(S)}function urlQueryToSearchParams(S){let T=new URLSearchParams;return Object.entries(S).forEach(S=>{let[R,P]=S;Array.isArray(P)?P.forEach(S=>T.append(R,stringifyUrlQueryParam(S))):T.set(R,stringifyUrlQueryParam(P))}),T}function assign(S){for(var T=arguments.length,R=Array(T>1?T-1:0),P=1;P<T;P++)R[P-1]=arguments[P];return R.forEach(T=>{Array.from(T.keys()).forEach(T=>S.delete(T)),T.forEach((T,R)=>S.append(R,T))}),S}Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{searchParamsToUrlQuery:function(){return searchParamsToUrlQuery},urlQueryToSearchParams:function(){return urlQueryToSearchParams},assign:function(){return assign}})},43630:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"getRouteMatcher",{enumerable:!0,get:function(){return getRouteMatcher}});let P=R(84679);function getRouteMatcher(S){let{re:T,groups:R}=S;return S=>{let O=T.exec(S);if(!O)return!1;let decode=S=>{try{return decodeURIComponent(S)}catch(S){throw new P.DecodeError("failed to decode param")}},N={};return Object.keys(R).forEach(S=>{let T=R[S],P=O[T.pos];void 0!==P&&(N[S]=~P.indexOf("/")?P.split("/").map(S=>decode(S)):T.repeat?[decode(P)]:decode(P))}),N}}},80680:(S,T,R)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{getRouteRegex:function(){return getRouteRegex},getNamedRouteRegex:function(){return getNamedRouteRegex},getNamedMiddlewareRegex:function(){return getNamedMiddlewareRegex}});let P=R(84265),O=R(50821),N=R(96923),M="nxtP",L="nxtI";function parseParameter(S){let T=S.startsWith("[")&&S.endsWith("]");T&&(S=S.slice(1,-1));let R=S.startsWith("...");return R&&(S=S.slice(3)),{key:S,repeat:R,optional:T}}function getParametrizedRoute(S){let T=(0,N.removeTrailingSlash)(S).slice(1).split("/"),R={},M=1;return{parameterizedRoute:T.map(S=>{let T=P.INTERCEPTION_ROUTE_MARKERS.find(T=>S.startsWith(T)),N=S.match(/\[((?:\[.*\])|.+)\]/);if(T&&N){let{key:S,optional:P,repeat:L}=parseParameter(N[1]);return R[S]={pos:M++,repeat:L,optional:P},"/"+(0,O.escapeStringRegexp)(T)+"([^/]+?)"}if(!N)return"/"+(0,O.escapeStringRegexp)(S);{let{key:S,repeat:T,optional:P}=parseParameter(N[1]);return R[S]={pos:M++,repeat:T,optional:P},T?P?"(?:/(.+?))?":"/(.+?)":"/([^/]+?)"}}).join(""),groups:R}}function getRouteRegex(S){let{parameterizedRoute:T,groups:R}=getParametrizedRoute(S);return{re:RegExp("^"+T+"(?:/)?$"),groups:R}}function buildGetSafeRouteKey(){let S=0;return()=>{let T="",R=++S;for(;R>0;)T+=String.fromCharCode(97+(R-1)%26),R=Math.floor((R-1)/26);return T}}function getSafeKeyFromSegment(S){let{getSafeRouteKey:T,segment:R,routeKeys:P,keyPrefix:O}=S,{key:N,optional:M,repeat:L}=parseParameter(R),V=N.replace(/\W/g,"");O&&(V=""+O+V);let U=!1;return(0===V.length||V.length>30)&&(U=!0),isNaN(parseInt(V.slice(0,1)))||(U=!0),U&&(V=T()),O?P[V]=""+O+N:P[V]=""+N,L?M?"(?:/(?<"+V+">.+?))?":"/(?<"+V+">.+?)":"/(?<"+V+">[^/]+?)"}function getNamedParametrizedRoute(S,T){let R=(0,N.removeTrailingSlash)(S).slice(1).split("/"),V=buildGetSafeRouteKey(),U={};return{namedParameterizedRoute:R.map(S=>{let R=P.INTERCEPTION_ROUTE_MARKERS.some(T=>S.startsWith(T)),N=S.match(/\[((?:\[.*\])|.+)\]/);return R&&N?getSafeKeyFromSegment({getSafeRouteKey:V,segment:N[1],routeKeys:U,keyPrefix:T?L:void 0}):N?getSafeKeyFromSegment({getSafeRouteKey:V,segment:N[1],routeKeys:U,keyPrefix:T?M:void 0}):"/"+(0,O.escapeStringRegexp)(S)}).join(""),routeKeys:U}}function getNamedRouteRegex(S,T){let R=getNamedParametrizedRoute(S,T);return{...getRouteRegex(S),namedRegex:"^"+R.namedParameterizedRoute+"(?:/)?$",routeKeys:R.routeKeys}}function getNamedMiddlewareRegex(S,T){let{parameterizedRoute:R}=getParametrizedRoute(S),{catchAll:P=!0}=T;if("/"===R)return{namedRegex:"^/"+(P?".*":"")+"$"};let{namedParameterizedRoute:O}=getNamedParametrizedRoute(S,!1);return{namedRegex:"^"+O+(P?"(?:(/.*)?)":"")+"$"}}},72861:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),Object.defineProperty(T,"getSortedRoutes",{enumerable:!0,get:function(){return getSortedRoutes}});let UrlNode=class UrlNode{insert(S){this._insert(S.split("/").filter(Boolean),[],!1)}smoosh(){return this._smoosh()}_smoosh(S){void 0===S&&(S="/");let T=[...this.children.keys()].sort();null!==this.slugName&&T.splice(T.indexOf("[]"),1),null!==this.restSlugName&&T.splice(T.indexOf("[...]"),1),null!==this.optionalRestSlugName&&T.splice(T.indexOf("[[...]]"),1);let R=T.map(T=>this.children.get(T)._smoosh(""+S+T+"/")).reduce((S,T)=>[...S,...T],[]);if(null!==this.slugName&&R.push(...this.children.get("[]")._smoosh(S+"["+this.slugName+"]/")),!this.placeholder){let T="/"===S?"/":S.slice(0,-1);if(null!=this.optionalRestSlugName)throw Error('You cannot define a route with the same specificity as a optional catch-all route ("'+T+'" and "'+T+"[[..."+this.optionalRestSlugName+']]").');R.unshift(T)}return null!==this.restSlugName&&R.push(...this.children.get("[...]")._smoosh(S+"[..."+this.restSlugName+"]/")),null!==this.optionalRestSlugName&&R.push(...this.children.get("[[...]]")._smoosh(S+"[[..."+this.optionalRestSlugName+"]]/")),R}_insert(S,T,R){if(0===S.length){this.placeholder=!1;return}if(R)throw Error("Catch-all must be the last part of the URL.");let P=S[0];if(P.startsWith("[")&&P.endsWith("]")){let O=P.slice(1,-1),N=!1;if(O.startsWith("[")&&O.endsWith("]")&&(O=O.slice(1,-1),N=!0),O.startsWith("...")&&(O=O.substring(3),R=!0),O.startsWith("[")||O.endsWith("]"))throw Error("Segment names may not start or end with extra brackets ('"+O+"').");if(O.startsWith("."))throw Error("Segment names may not start with erroneous periods ('"+O+"').");function handleSlug(S,R){if(null!==S&&S!==R)throw Error("You cannot use different slug names for the same dynamic path ('"+S+"' !== '"+R+"').");T.forEach(S=>{if(S===R)throw Error('You cannot have the same slug name "'+R+'" repeat within a single dynamic path');if(S.replace(/\W/g,"")===P.replace(/\W/g,""))throw Error('You cannot have the slug names "'+S+'" and "'+R+'" differ only by non-word symbols within a single dynamic path')}),T.push(R)}if(R){if(N){if(null!=this.restSlugName)throw Error('You cannot use both an required and optional catch-all route at the same level ("[...'+this.restSlugName+']" and "'+S[0]+'" ).');handleSlug(this.optionalRestSlugName,O),this.optionalRestSlugName=O,P="[[...]]"}else{if(null!=this.optionalRestSlugName)throw Error('You cannot use both an optional and required catch-all route at the same level ("[[...'+this.optionalRestSlugName+']]" and "'+S[0]+'").');handleSlug(this.restSlugName,O),this.restSlugName=O,P="[...]"}}else{if(N)throw Error('Optional route parameters are not yet supported ("'+S[0]+'").');handleSlug(this.slugName,O),this.slugName=O,P="[]"}}this.children.has(P)||this.children.set(P,new UrlNode),this.children.get(P)._insert(S.slice(1),T,R)}constructor(){this.placeholder=!0,this.children=new Map,this.slugName=null,this.restSlugName=null,this.optionalRestSlugName=null}};function getSortedRoutes(S){let T=new UrlNode;return S.forEach(S=>T.insert(S)),T.smoosh()}},84679:(S,T)=>{"use strict";Object.defineProperty(T,"__esModule",{value:!0}),function(S,T){for(var R in T)Object.defineProperty(S,R,{enumerable:!0,get:T[R]})}(T,{WEB_VITALS:function(){return R},execOnce:function(){return execOnce},isAbsoluteUrl:function(){return isAbsoluteUrl},getLocationOrigin:function(){return getLocationOrigin},getURL:function(){return getURL},getDisplayName:function(){return getDisplayName},isResSent:function(){return isResSent},normalizeRepeatedSlashes:function(){return normalizeRepeatedSlashes},loadGetInitialProps:function(){return loadGetInitialProps},SP:function(){return O},ST:function(){return N},DecodeError:function(){return DecodeError},NormalizeError:function(){return NormalizeError},PageNotFoundError:function(){return PageNotFoundError},MissingStaticPage:function(){return MissingStaticPage},MiddlewareNotFoundError:function(){return MiddlewareNotFoundError},stringifyError:function(){return stringifyError}});let R=["CLS","FCP","FID","INP","LCP","TTFB"];function execOnce(S){let T,R=!1;return function(){for(var P=arguments.length,O=Array(P),N=0;N<P;N++)O[N]=arguments[N];return R||(R=!0,T=S(...O)),T}}let P=/^[a-zA-Z][a-zA-Z\d+\-.]*?:/,isAbsoluteUrl=S=>P.test(S);function getLocationOrigin(){let{protocol:S,hostname:T,port:R}=window.location;return S+"//"+T+(R?":"+R:"")}function getURL(){let{href:S}=window.location,T=getLocationOrigin();return S.substring(T.length)}function getDisplayName(S){return"string"==typeof S?S:S.displayName||S.name||"Unknown"}function isResSent(S){return S.finished||S.headersSent}function normalizeRepeatedSlashes(S){let T=S.split("?"),R=T[0];return R.replace(/\\/g,"/").replace(/\/\/+/g,"/")+(T[1]?"?"+T.slice(1).join("?"):"")}async function loadGetInitialProps(S,T){let R=T.res||T.ctx&&T.ctx.res;if(!S.getInitialProps)return T.ctx&&T.Component?{pageProps:await loadGetInitialProps(T.Component,T.ctx)}:{};let P=await S.getInitialProps(T);if(R&&isResSent(R))return P;if(!P){let T='"'+getDisplayName(S)+'.getInitialProps()" should resolve to an object. But found "'+P+'" instead.';throw Error(T)}return P}let O="undefined"!=typeof performance,N=O&&["mark","measure","getEntriesByName"].every(S=>"function"==typeof performance[S]);let DecodeError=class DecodeError extends Error{};let NormalizeError=class NormalizeError extends Error{};let PageNotFoundError=class PageNotFoundError extends Error{constructor(S){super(),this.code="ENOENT",this.name="PageNotFoundError",this.message="Cannot find module for page: "+S}};let MissingStaticPage=class MissingStaticPage extends Error{constructor(S,T){super(),this.message="Failed to load static file for page: "+S+" "+T}};let MiddlewareNotFoundError=class MiddlewareNotFoundError extends Error{constructor(){super(),this.code="ENOENT",this.message="Cannot find the middleware module"}};function stringifyError(S){return JSON.stringify({message:S.message,stack:S.stack})}},10713:(S,T,R)=>{"use strict";S.exports=R(10316).vendored.contexts.RouterContext},11440:(S,T,R)=>{S.exports=R(30614)},57114:(S,T,R)=>{S.exports=R(4979)},95307:(S,T,R)=>{"use strict";var P=R(75962);S.exports=T=P.descriptor=P.Root.fromJSON(R(89987)).lookup(".google.protobuf");var O=P.Namespace,N=P.Root,M=P.Enum,L=P.Type,V=P.Field,U=P.MapField,W=P.OneOf,K=P.Service,Q=P.Method;function Root_toDescriptorRecursive(S,R,P){var U=T.FileDescriptorProto.create({name:S.filename||(S.fullName.substring(1).replace(/\./g,"_")||"root")+".proto"});editionToDescriptor(P,U),S instanceof N||(U.package=S.fullName.substring(1));for(var W,Q=0;Q<S.nestedArray.length;++Q)(W=S._nestedArray[Q])instanceof L?U.messageType.push(W.toDescriptor(P)):W instanceof M?U.enumType.push(W.toDescriptor()):W instanceof V?U.extension.push(W.toDescriptor(P)):W instanceof K?U.service.push(W.toDescriptor()):W instanceof O&&Root_toDescriptorRecursive(W,R,P);U.options=toDescriptorOptions(S.options,T.FileOptions),U.messageType.length+U.enumType.length+U.extension.length+U.service.length&&R.push(U)}N.fromDescriptor=function(S){"number"==typeof S.length&&(S=T.FileDescriptorSet.decode(S));var R=new N;if(S.file)for(var P,O,U,W=0;W<S.file.length;++W){O=R,(P=S.file[W]).package&&P.package.length&&(O=R.define(P.package));var Q=editionFromDescriptor(P);if(P.name&&P.name.length&&R.files.push(O.filename=P.name),P.messageType)for(U=0;U<P.messageType.length;++U)O.add(L.fromDescriptor(P.messageType[U],Q));if(P.enumType)for(U=0;U<P.enumType.length;++U)O.add(M.fromDescriptor(P.enumType[U],Q));if(P.extension)for(U=0;U<P.extension.length;++U)O.add(V.fromDescriptor(P.extension[U],Q));if(P.service)for(U=0;U<P.service.length;++U)O.add(K.fromDescriptor(P.service[U],Q));var $=fromDescriptorOptions(P.options,T.FileOptions);if($){var Y=Object.keys($);for(U=0;U<Y.length;++U)O.setOption(Y[U],$[Y[U]])}}return R.resolveAll()},N.prototype.toDescriptor=function(S){var R=T.FileDescriptorSet.create();return Root_toDescriptorRecursive(this,R.file,S),R};var $=0;L.fromDescriptor=function(S,R,P){"number"==typeof S.length&&(S=T.DescriptorProto.decode(S));var O,N=new L(S.name.length?S.name:"Type"+$++,fromDescriptorOptions(S.options,T.MessageOptions));if(P||(N._edition=R),S.oneofDecl)for(O=0;O<S.oneofDecl.length;++O)N.add(W.fromDescriptor(S.oneofDecl[O]));if(S.field)for(O=0;O<S.field.length;++O){var U=V.fromDescriptor(S.field[O],R,!0);N.add(U),S.field[O].hasOwnProperty("oneofIndex")&&N.oneofsArray[S.field[O].oneofIndex].add(U)}if(S.extension)for(O=0;O<S.extension.length;++O)N.add(V.fromDescriptor(S.extension[O],R,!0));if(S.nestedType)for(O=0;O<S.nestedType.length;++O)N.add(L.fromDescriptor(S.nestedType[O],R,!0)),S.nestedType[O].options&&S.nestedType[O].options.mapEntry&&N.setOption("map_entry",!0);if(S.enumType)for(O=0;O<S.enumType.length;++O)N.add(M.fromDescriptor(S.enumType[O],R,!0));if(S.extensionRange&&S.extensionRange.length)for(O=0,N.extensions=[];O<S.extensionRange.length;++O)N.extensions.push([S.extensionRange[O].start,S.extensionRange[O].end]);if(S.reservedRange&&S.reservedRange.length||S.reservedName&&S.reservedName.length){if(N.reserved=[],S.reservedRange)for(O=0;O<S.reservedRange.length;++O)N.reserved.push([S.reservedRange[O].start,S.reservedRange[O].end]);if(S.reservedName)for(O=0;O<S.reservedName.length;++O)N.reserved.push(S.reservedName[O])}return N},L.prototype.toDescriptor=function(S){var R,P,O=T.DescriptorProto.create({name:this.name});for(P=0;P<this.fieldsArray.length;++P)if(O.field.push(R=this._fieldsArray[P].toDescriptor(S)),this._fieldsArray[P]instanceof U){var N=toDescriptorType(this._fieldsArray[P].keyType,this._fieldsArray[P].resolvedKeyType,!1),W=toDescriptorType(this._fieldsArray[P].type,this._fieldsArray[P].resolvedType,!1),K=11===W||14===W?this._fieldsArray[P].resolvedType&&shortname(this.parent,this._fieldsArray[P].resolvedType)||this._fieldsArray[P].type:void 0;O.nestedType.push(T.DescriptorProto.create({name:R.typeName,field:[T.FieldDescriptorProto.create({name:"key",number:1,label:1,type:N}),T.FieldDescriptorProto.create({name:"value",number:2,label:1,type:W,typeName:K})],options:T.MessageOptions.create({mapEntry:!0})}))}for(P=0;P<this.oneofsArray.length;++P)O.oneofDecl.push(this._oneofsArray[P].toDescriptor());for(P=0;P<this.nestedArray.length;++P)this._nestedArray[P]instanceof V?O.field.push(this._nestedArray[P].toDescriptor(S)):this._nestedArray[P]instanceof L?O.nestedType.push(this._nestedArray[P].toDescriptor(S)):this._nestedArray[P]instanceof M&&O.enumType.push(this._nestedArray[P].toDescriptor());if(this.extensions)for(P=0;P<this.extensions.length;++P)O.extensionRange.push(T.DescriptorProto.ExtensionRange.create({start:this.extensions[P][0],end:this.extensions[P][1]}));if(this.reserved)for(P=0;P<this.reserved.length;++P)"string"==typeof this.reserved[P]?O.reservedName.push(this.reserved[P]):O.reservedRange.push(T.DescriptorProto.ReservedRange.create({start:this.reserved[P][0],end:this.reserved[P][1]}));return O.options=toDescriptorOptions(this.options,T.MessageOptions),O};var Y=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/;V.fromDescriptor=function(S,R,P){if("number"==typeof S.length&&(S=T.DescriptorProto.decode(S)),"number"!=typeof S.number)throw Error("missing field id");switch(O=S.typeName&&S.typeName.length?S.typeName:fromDescriptorType(S.type),S.label){case 1:N=void 0;break;case 2:N="required";break;case 3:N="repeated";break;default:throw Error("illegal label: "+S.label)}var O,N,M=S.extendee;void 0!==S.extendee&&(M=M.length?M:void 0);var L=new V(S.name.length?S.name:"field"+S.number,S.number,O,N,M);if(P||(L._edition=R),L.options=fromDescriptorOptions(S.options,T.FieldOptions),S.proto3_optional&&(L.options.proto3_optional=!0),S.defaultValue&&S.defaultValue.length){var U=S.defaultValue;switch(U){case"true":case"TRUE":U=!0;break;case"false":case"FALSE":U=!1;break;default:Y.exec(U)&&(U=parseInt(U))}L.setOption("default",U)}return packableDescriptorType(S.type)&&("proto3"===R?S.options&&!S.options.packed&&L.setOption("packed",!1):(!R||"proto2"===R)&&S.options&&S.options.packed&&L.setOption("packed",!0)),L},V.prototype.toDescriptor=function(S){var R=T.FieldDescriptorProto.create({name:this.name,number:this.id});if(this.map)R.type=11,R.typeName=P.util.ucFirst(this.name),R.label=3;else{switch(R.type=toDescriptorType(this.type,this.resolve().resolvedType,this.delimited)){case 10:case 11:case 14:R.typeName=this.resolvedType?shortname(this.parent,this.resolvedType):this.type}"repeated"===this.rule?R.label=3:this.required&&"proto2"===S?R.label=2:R.label=1}if(R.extendee=this.extensionField?this.extensionField.parent.fullName:this.extend,this.partOf&&(R.oneofIndex=this.parent.oneofsArray.indexOf(this.partOf))<0)throw Error("missing oneof");return this.options&&(R.options=toDescriptorOptions(this.options,T.FieldOptions),null!=this.options.default&&(R.defaultValue=String(this.options.default)),this.options.proto3_optional&&(R.proto3_optional=!0)),"proto3"===S?this.packed||((R.options||(R.options=T.FieldOptions.create())).packed=!1):(!S||"proto2"===S)&&this.packed&&((R.options||(R.options=T.FieldOptions.create())).packed=!0),R};var X=0;M.fromDescriptor=function(S,R,P){"number"==typeof S.length&&(S=T.EnumDescriptorProto.decode(S));var O={};if(S.value)for(var N=0;N<S.value.length;++N){var L=S.value[N].name,V=S.value[N].number||0;O[L&&L.length?L:"NAME"+V]=V}var U=new M(S.name&&S.name.length?S.name:"Enum"+X++,O,fromDescriptorOptions(S.options,T.EnumOptions));return P||(U._edition=R),U},M.prototype.toDescriptor=function(){for(var S=[],R=0,P=Object.keys(this.values);R<P.length;++R)S.push(T.EnumValueDescriptorProto.create({name:P[R],number:this.values[P[R]]}));return T.EnumDescriptorProto.create({name:this.name,value:S,options:toDescriptorOptions(this.options,T.EnumOptions)})};var Z=0;W.fromDescriptor=function(S){return"number"==typeof S.length&&(S=T.OneofDescriptorProto.decode(S)),new W(S.name&&S.name.length?S.name:"oneof"+Z++)},W.prototype.toDescriptor=function(){return T.OneofDescriptorProto.create({name:this.name})};var ee=0;K.fromDescriptor=function(S,R,P){"number"==typeof S.length&&(S=T.ServiceDescriptorProto.decode(S));var O=new K(S.name&&S.name.length?S.name:"Service"+ee++,fromDescriptorOptions(S.options,T.ServiceOptions));if(P||(O._edition=R),S.method)for(var N=0;N<S.method.length;++N)O.add(Q.fromDescriptor(S.method[N]));return O},K.prototype.toDescriptor=function(){for(var S=[],R=0;R<this.methodsArray.length;++R)S.push(this._methodsArray[R].toDescriptor());return T.ServiceDescriptorProto.create({name:this.name,method:S,options:toDescriptorOptions(this.options,T.ServiceOptions)})};var et=0;function fromDescriptorType(S){switch(S){case 1:return"double";case 2:return"float";case 3:return"int64";case 4:return"uint64";case 5:return"int32";case 6:return"fixed64";case 7:return"fixed32";case 8:return"bool";case 9:return"string";case 12:return"bytes";case 13:return"uint32";case 15:return"sfixed32";case 16:return"sfixed64";case 17:return"sint32";case 18:return"sint64"}throw Error("illegal type: "+S)}function packableDescriptorType(S){switch(S){case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 13:case 14:case 15:case 16:case 17:case 18:return!0}return!1}function toDescriptorType(S,T,R){switch(S){case"double":return 1;case"float":return 2;case"int64":return 3;case"uint64":return 4;case"int32":return 5;case"fixed64":return 6;case"fixed32":return 7;case"bool":return 8;case"string":return 9;case"bytes":return 12;case"uint32":return 13;case"sfixed32":return 15;case"sfixed64":return 16;case"sint32":return 17;case"sint64":return 18}if(T instanceof M)return 14;if(T instanceof L)return R?10:11;throw Error("illegal type: "+S)}function fromDescriptorOptionsRecursive(S,T){for(var R,P,O={},N=0;N<T.fieldsArray.length;++N)if("uninterpretedOption"!==(P=(R=T._fieldsArray[N]).name)&&Object.prototype.hasOwnProperty.call(S,P)){var V=underScore(P);R.resolvedType instanceof L?O[V]=fromDescriptorOptionsRecursive(S[P],R.resolvedType):R.resolvedType instanceof M?O[V]=R.resolvedType.valuesById[S[P]]:O[V]=S[P]}return O}function fromDescriptorOptions(S,T){if(S)return fromDescriptorOptionsRecursive(T.toObject(S),T)}function toDescriptorOptionsRecursive(S,T){for(var R={},O=Object.keys(S),N=0;N<O.length;++N){var M=O[N],V=P.util.camelCase(M);if(Object.prototype.hasOwnProperty.call(T.fields,V)){var U=T.fields[V];U.resolvedType instanceof L?R[V]=toDescriptorOptionsRecursive(S[M],U.resolvedType):R[V]=S[M],U.repeated&&!Array.isArray(R[V])&&(R[V]=[R[V]])}}return R}function toDescriptorOptions(S,T){if(S)return T.fromObject(toDescriptorOptionsRecursive(S,T))}function shortname(S,T){var R=S.fullName.split("."),P=T.fullName.split("."),M=0,L=0,V=P.length-1;if(!(S instanceof N)&&T instanceof O)for(;M<R.length&&L<V&&R[M]===P[L];){var U=T.lookup(R[M++],!0);if(null!==U&&U!==T)break;++L}else for(;M<R.length&&L<V&&R[M]===P[L];++M,++L);return P.slice(L).join(".")}function underScore(S){return S.substring(0,1)+S.substring(1).replace(/([A-Z])(?=[a-z]|$)/g,function(S,T){return"_"+T.toLowerCase()})}function editionFromDescriptor(S){if("editions"===S.syntax){if(S.edition===T.Edition.EDITION_2023)return"2023";throw Error("Unsupported edition "+S.edition)}return"proto3"===S.syntax?"proto3":"proto2"}function editionToDescriptor(S,R){if(S){if("proto2"===S||"proto3"===S)R.syntax=S;else if(R.syntax="editions","2023"===S)R.edition=T.Edition.EDITION_2023;else throw Error("Unsupported edition "+S)}}Q.fromDescriptor=function(S){return"number"==typeof S.length&&(S=T.MethodDescriptorProto.decode(S)),new Q(S.name&&S.name.length?S.name:"Method"+et++,"rpc",S.inputType,S.outputType,!!S.clientStreaming,!!S.serverStreaming,fromDescriptorOptions(S.options,T.MethodOptions))},Q.prototype.toDescriptor=function(){return T.MethodDescriptorProto.create({name:this.name,inputType:this.resolvedRequestType?this.resolvedRequestType.fullName:this.requestType,outputType:this.resolvedResponseType?this.resolvedResponseType.fullName:this.responseType,clientStreaming:this.requestStream,serverStreaming:this.responseStream,options:toDescriptorOptions(this.options,T.MethodOptions)})}},75962:(S,T,R)=>{"use strict";S.exports=R(23517)},79760:S=>{"use strict";S.exports=common;var T,R=/\/|\./;function common(S,T){R.test(S)||(S="google/protobuf/"+S+".proto",T={nested:{google:{nested:{protobuf:{nested:T}}}}}),common[S]=T}common("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}}),common("duration",{Duration:T={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),common("timestamp",{Timestamp:T}),common("empty",{Empty:{fields:{}}}),common("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),common("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),common("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),common.get=function(S){return common[S]||null}},84144:(S,T,R)=>{"use strict";var P=T,O=R(59246),N=R(66738);function genValuePartial_fromObject(S,T,R,P){var N=!1;if(T.resolvedType){if(T.resolvedType instanceof O){S("switch(d%s){",P);for(var M=T.resolvedType.values,L=Object.keys(M),V=0;V<L.length;++V)M[L[V]]!==T.typeDefault||N||(S("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',P,P,P),T.repeated||S("break"),N=!0),S("case%j:",L[V])("case %i:",M[L[V]])("m%s=%j",P,M[L[V]])("break");S("}")}else S('if(typeof d%s!=="object")',P)("throw TypeError(%j)",T.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",P,R,P)}else{var U=!1;switch(T.type){case"double":case"float":S("m%s=Number(d%s)",P,P);break;case"uint32":case"fixed32":S("m%s=d%s>>>0",P,P);break;case"int32":case"sint32":case"sfixed32":S("m%s=d%s|0",P,P);break;case"uint64":U=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":S("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",P,P,U)('else if(typeof d%s==="string")',P)("m%s=parseInt(d%s,10)",P,P)('else if(typeof d%s==="number")',P)("m%s=d%s",P,P)('else if(typeof d%s==="object")',P)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",P,P,P,U?"true":"");break;case"bytes":S('if(typeof d%s==="string")',P)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",P,P,P)("else if(d%s.length >= 0)",P)("m%s=d%s",P,P);break;case"string":S("m%s=String(d%s)",P,P);break;case"bool":S("m%s=Boolean(d%s)",P,P)}}return S}function genValuePartial_toObject(S,T,R,P){if(T.resolvedType)T.resolvedType instanceof O?S("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",P,R,P,P,R,P,P):S("d%s=types[%i].toObject(m%s,o)",P,R,P);else{var N=!1;switch(T.type){case"double":case"float":S("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",P,P,P,P);break;case"uint64":N=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":S('if(typeof m%s==="number")',P)("d%s=o.longs===String?String(m%s):m%s",P,P,P)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",P,P,P,P,N?"true":"",P);break;case"bytes":S("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",P,P,P,P,P);break;default:S("d%s=m%s",P,P)}}return S}P.fromObject=function(S){var T=S.fieldsArray,R=N.codegen(["d"],S.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!T.length)return R("return new this.ctor");R("var m=new this.ctor");for(var P=0;P<T.length;++P){var M=T[P].resolve(),L=N.safeProp(M.name);M.map?(R("if(d%s){",L)('if(typeof d%s!=="object")',L)("throw TypeError(%j)",M.fullName+": object expected")("m%s={}",L)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",L),genValuePartial_fromObject(R,M,P,L+"[ks[i]]")("}")("}")):M.repeated?(R("if(d%s){",L)("if(!Array.isArray(d%s))",L)("throw TypeError(%j)",M.fullName+": array expected")("m%s=[]",L)("for(var i=0;i<d%s.length;++i){",L),genValuePartial_fromObject(R,M,P,L+"[i]")("}")("}")):(M.resolvedType instanceof O||R("if(d%s!=null){",L),genValuePartial_fromObject(R,M,P,L),M.resolvedType instanceof O||R("}"))}return R("return m")},P.toObject=function(S){var T=S.fieldsArray.slice().sort(N.compareFieldsById);if(!T.length)return N.codegen()("return {}");for(var R=N.codegen(["m","o"],S.name+"$toObject")("if(!o)")("o={}")("var d={}"),P=[],M=[],L=[],V=0;V<T.length;++V)T[V].partOf||(T[V].resolve().repeated?P:T[V].map?M:L).push(T[V]);if(P.length){for(R("if(o.arrays||o.defaults){"),V=0;V<P.length;++V)R("d%s=[]",N.safeProp(P[V].name));R("}")}if(M.length){for(R("if(o.objects||o.defaults){"),V=0;V<M.length;++V)R("d%s={}",N.safeProp(M[V].name));R("}")}if(L.length){for(R("if(o.defaults){"),V=0;V<L.length;++V){var U=L[V],W=N.safeProp(U.name);if(U.resolvedType instanceof O)R("d%s=o.enums===String?%j:%j",W,U.resolvedType.valuesById[U.typeDefault],U.typeDefault);else if(U.long)R("if(util.Long){")("var n=new util.Long(%i,%i,%j)",U.typeDefault.low,U.typeDefault.high,U.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",W)("}else")("d%s=o.longs===String?%j:%i",W,U.typeDefault.toString(),U.typeDefault.toNumber());else if(U.bytes){var K="["+Array.prototype.slice.call(U.typeDefault).join(",")+"]";R("if(o.bytes===String)d%s=%j",W,String.fromCharCode.apply(String,U.typeDefault))("else{")("d%s=%s",W,K)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",W,W)("}")}else R("d%s=%j",W,U.typeDefault)}R("}")}var Q=!1;for(V=0;V<T.length;++V){var U=T[V],$=S._fieldsArray.indexOf(U),W=N.safeProp(U.name);U.map?(Q||(Q=!0,R("var ks2")),R("if(m%s&&(ks2=Object.keys(m%s)).length){",W,W)("d%s={}",W)("for(var j=0;j<ks2.length;++j){"),genValuePartial_toObject(R,U,$,W+"[ks2[j]]")("}")):U.repeated?(R("if(m%s&&m%s.length){",W,W)("d%s=[]",W)("for(var j=0;j<m%s.length;++j){",W),genValuePartial_toObject(R,U,$,W+"[j]")("}")):(R("if(m%s!=null&&m.hasOwnProperty(%j)){",W,U.name),genValuePartial_toObject(R,U,$,W),U.partOf&&R("if(o.oneofs)")("d%s=%j",N.safeProp(U.partOf.name),U.name)),R("}")}return R("return d")}},87317:(S,T,R)=>{"use strict";S.exports=decoder;var P=R(59246),O=R(91708),N=R(66738);function missing(S){return"missing required '"+S.name+"'"}function decoder(S){for(var T=N.codegen(["r","l","e"],S.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(S.fieldsArray.filter(function(S){return S.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()")("if(t===e)")("break")("switch(t>>>3){"),R=0;R<S.fieldsArray.length;++R){var M=S._fieldsArray[R].resolve(),L=M.resolvedType instanceof P?"int32":M.type,V="m"+N.safeProp(M.name);T("case %i: {",M.id),M.map?(T("if(%s===util.emptyObject)",V)("%s={}",V)("var c2 = r.uint32()+r.pos"),void 0!==O.defaults[M.keyType]?T("k=%j",O.defaults[M.keyType]):T("k=null"),void 0!==O.defaults[L]?T("value=%j",O.defaults[L]):T("value=null"),T("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",M.keyType)("case 2:"),void 0===O.basic[L]?T("value=types[%i].decode(r,r.uint32())",R):T("value=r.%s()",L),T("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),T(void 0!==O.long[M.keyType]?'%s[typeof k==="object"?util.longToHash(k):k]=value':"%s[k]=value",V)):M.repeated?(T("if(!(%s&&%s.length))",V,V)("%s=[]",V),void 0!==O.packed[L]&&T("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",V,L)("}else"),void 0===O.basic[L]?T(M.delimited?"%s.push(types[%i].decode(r,undefined,((t&~7)|4)))":"%s.push(types[%i].decode(r,r.uint32()))",V,R):T("%s.push(r.%s())",V,L)):void 0===O.basic[L]?T(M.delimited?"%s=types[%i].decode(r,undefined,((t&~7)|4))":"%s=types[%i].decode(r,r.uint32())",V,R):T("%s=r.%s()",V,L),T("break")("}")}for(T("default:")("r.skipType(t&7)")("break")("}")("}"),R=0;R<S._fieldsArray.length;++R){var U=S._fieldsArray[R];U.required&&T("if(!m.hasOwnProperty(%j))",U.name)("throw util.ProtocolError(%j,{instance:m})",missing(U))}return T("return m")}},49561:(S,T,R)=>{"use strict";S.exports=encoder;var P=R(59246),O=R(91708),N=R(66738);function genTypePartial(S,T,R,P){return T.delimited?S("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",R,P,(T.id<<3|3)>>>0,(T.id<<3|4)>>>0):S("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",R,P,(T.id<<3|2)>>>0)}function encoder(S){for(var T,R,M=N.codegen(["m","w"],S.name+"$encode")("if(!w)")("w=Writer.create()"),L=S.fieldsArray.slice().sort(N.compareFieldsById),T=0;T<L.length;++T){var V=L[T].resolve(),U=S._fieldsArray.indexOf(V),W=V.resolvedType instanceof P?"int32":V.type,K=O.basic[W];R="m"+N.safeProp(V.name),V.map?(M("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",R,V.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",R)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(V.id<<3|2)>>>0,8|O.mapKey[V.keyType],V.keyType),void 0===K?M("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",U,R):M(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|K,W,R),M("}")("}")):V.repeated?(M("if(%s!=null&&%s.length){",R,R),V.packed&&void 0!==O.packed[W]?M("w.uint32(%i).fork()",(V.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",R)("w.%s(%s[i])",W,R)("w.ldelim()"):(M("for(var i=0;i<%s.length;++i)",R),void 0===K?genTypePartial(M,V,U,R+"[i]"):M("w.uint32(%i).%s(%s[i])",(V.id<<3|K)>>>0,W,R)),M("}")):(V.optional&&M("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",R,V.name),void 0===K?genTypePartial(M,V,U,R):M("w.uint32(%i).%s(%s)",(V.id<<3|K)>>>0,W,R))}return M("return w")}},59246:(S,T,R)=>{"use strict";S.exports=Enum;var P=R(61862);((Enum.prototype=Object.create(P.prototype)).constructor=Enum).className="Enum";var O=R(97540),N=R(66738);function Enum(S,T,R,O,N,M){if(P.call(this,S,R),T&&"object"!=typeof T)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=O,this.comments=N||{},this.valuesOptions=M,this._valuesFeatures={},this.reserved=void 0,T)for(var L=Object.keys(T),V=0;V<L.length;++V)"number"==typeof T[L[V]]&&(this.valuesById[this.values[L[V]]=T[L[V]]]=L[V])}Enum.prototype._resolveFeatures=function(S){return S=this._edition||S,P.prototype._resolveFeatures.call(this,S),Object.keys(this.values).forEach(S=>{var T=Object.assign({},this._features);this._valuesFeatures[S]=Object.assign(T,this.valuesOptions&&this.valuesOptions[S]&&this.valuesOptions[S].features)}),this},Enum.fromJSON=function(S,T){var R=new Enum(S,T.values,T.options,T.comment,T.comments);return R.reserved=T.reserved,T.edition&&(R._edition=T.edition),R._defaultEdition="proto3",R},Enum.prototype.toJSON=function(S){var T=!!S&&!!S.keepComments;return N.toObject(["edition",this._editionToJSON(),"options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",T?this.comment:void 0,"comments",T?this.comments:void 0])},Enum.prototype.add=function(S,T,R,P){if(!N.isString(S))throw TypeError("name must be a string");if(!N.isInteger(T))throw TypeError("id must be an integer");if(void 0!==this.values[S])throw Error("duplicate name '"+S+"' in "+this);if(this.isReservedId(T))throw Error("id "+T+" is reserved in "+this);if(this.isReservedName(S))throw Error("name '"+S+"' is reserved in "+this);if(void 0!==this.valuesById[T]){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+T+" in "+this);this.values[S]=T}else this.valuesById[this.values[S]=T]=S;return P&&(void 0===this.valuesOptions&&(this.valuesOptions={}),this.valuesOptions[S]=P||null),this.comments[S]=R||null,this},Enum.prototype.remove=function(S){if(!N.isString(S))throw TypeError("name must be a string");var T=this.values[S];if(null==T)throw Error("name '"+S+"' does not exist in "+this);return delete this.valuesById[T],delete this.values[S],delete this.comments[S],this.valuesOptions&&delete this.valuesOptions[S],this},Enum.prototype.isReservedId=function(S){return O.isReservedId(this.reserved,S)},Enum.prototype.isReservedName=function(S){return O.isReservedName(this.reserved,S)}},23980:(S,T,R)=>{"use strict";S.exports=Field;var P,O=R(61862);((Field.prototype=Object.create(O.prototype)).constructor=Field).className="Field";var N=R(59246),M=R(91708),L=R(66738),V=/^required|optional|repeated$/;function Field(S,T,R,P,N,U,W){if(L.isObject(P)?(W=N,U=P,P=N=void 0):L.isObject(N)&&(W=U,U=N,N=void 0),O.call(this,S,U),!L.isInteger(T)||T<0)throw TypeError("id must be a non-negative integer");if(!L.isString(R))throw TypeError("type must be a string");if(void 0!==P&&!V.test(P=P.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==N&&!L.isString(N))throw TypeError("extend must be a string");"proto3_optional"===P&&(P="optional"),this.rule=P&&"optional"!==P?P:void 0,this.type=R,this.id=T,this.extend=N||void 0,this.repeated="repeated"===P,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!L.Long&&void 0!==M.long[R],this.bytes="bytes"===R,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.comment=W}Field.fromJSON=function(S,T){var R=new Field(S,T.id,T.type,T.rule,T.extend,T.options,T.comment);return T.edition&&(R._edition=T.edition),R._defaultEdition="proto3",R},Object.defineProperty(Field.prototype,"required",{get:function(){return"LEGACY_REQUIRED"===this._features.field_presence}}),Object.defineProperty(Field.prototype,"optional",{get:function(){return!this.required}}),Object.defineProperty(Field.prototype,"delimited",{get:function(){return this.resolvedType instanceof P&&"DELIMITED"===this._features.message_encoding}}),Object.defineProperty(Field.prototype,"packed",{get:function(){return"PACKED"===this._features.repeated_field_encoding}}),Object.defineProperty(Field.prototype,"hasPresence",{get:function(){return!this.repeated&&!this.map&&(this.partOf||this.declaringField||this.extensionField||"IMPLICIT"!==this._features.field_presence)}}),Field.prototype.setOption=function(S,T,R){return O.prototype.setOption.call(this,S,T,R)},Field.prototype.toJSON=function(S){var T=!!S&&!!S.keepComments;return L.toObject(["edition",this._editionToJSON(),"rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",T?this.comment:void 0])},Field.prototype.resolve=function(){if(this.resolved)return this;if(void 0===(this.typeDefault=M.defaults[this.type])?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof P?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof N&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof N||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=L.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&"string"==typeof this.typeDefault){var S;L.base64.test(this.typeDefault)?L.base64.decode(this.typeDefault,S=L.newBuffer(L.base64.length(this.typeDefault)),0):L.utf8.write(this.typeDefault,S=L.newBuffer(L.utf8.length(this.typeDefault)),0),this.typeDefault=S}return this.map?this.defaultValue=L.emptyObject:this.repeated?this.defaultValue=L.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof P&&(this.parent.ctor.prototype[this.name]=this.defaultValue),O.prototype.resolve.call(this)},Field.prototype._inferLegacyProtoFeatures=function(S){if("proto2"!==S&&"proto3"!==S)return{};var T={};if("required"===this.rule&&(T.field_presence="LEGACY_REQUIRED"),this.parent&&void 0===M.defaults[this.type]){var R=this.parent.get(this.type.split(".").pop());R&&R instanceof P&&R.group&&(T.message_encoding="DELIMITED")}return!0===this.getOption("packed")?T.repeated_field_encoding="PACKED":!1===this.getOption("packed")&&(T.repeated_field_encoding="EXPANDED"),T},Field.prototype._resolveFeatures=function(S){return O.prototype._resolveFeatures.call(this,this._edition||S)},Field.d=function(S,T,R,P){return"function"==typeof T?T=L.decorateType(T).name:T&&"object"==typeof T&&(T=L.decorateEnum(T).name),function(O,N){L.decorateType(O.constructor).add(new Field(N,S,T,R,{default:P}))}},Field._configure=function(S){P=S}},62982:(S,T,R)=>{"use strict";var P=S.exports=R(82985);function load(S,T,R){return"function"==typeof T?(R=T,T=new P.Root):T||(T=new P.Root),T.load(S,R)}function loadSync(S,T){return T||(T=new P.Root),T.loadSync(S)}P.build="light",P.load=load,P.loadSync=loadSync,P.encoder=R(49561),P.decoder=R(87317),P.verifier=R(17585),P.converter=R(84144),P.ReflectionObject=R(61862),P.Namespace=R(97540),P.Root=R(98373),P.Enum=R(59246),P.Type=R(59340),P.Field=R(23980),P.OneOf=R(32866),P.MapField=R(67597),P.Service=R(82791),P.Method=R(28909),P.Message=R(34294),P.wrappers=R(34038),P.types=R(91708),P.util=R(66738),P.ReflectionObject._configure(P.Root),P.Namespace._configure(P.Type,P.Service,P.Enum),P.Root._configure(P.Type),P.Field._configure(P.Type)},82985:(S,T,R)=>{"use strict";var P=T;function configure(){P.util._configure(),P.Writer._configure(P.BufferWriter),P.Reader._configure(P.BufferReader)}P.build="minimal",P.Writer=R(84353),P.BufferWriter=R(81978),P.Reader=R(95199),P.BufferReader=R(15213),P.util=R(18932),P.rpc=R(69226),P.roots=R(10182),P.configure=configure,configure()},23517:(S,T,R)=>{"use strict";var P=S.exports=R(62982);P.build="full",P.tokenize=R(86116),P.parse=R(87897),P.common=R(79760),P.Root._configure(P.Type,P.parse,P.common)},67597:(S,T,R)=>{"use strict";S.exports=MapField;var P=R(23980);((MapField.prototype=Object.create(P.prototype)).constructor=MapField).className="MapField";var O=R(91708),N=R(66738);function MapField(S,T,R,O,M,L){if(P.call(this,S,T,O,void 0,void 0,M,L),!N.isString(R))throw TypeError("keyType must be a string");this.keyType=R,this.resolvedKeyType=null,this.map=!0}MapField.fromJSON=function(S,T){return new MapField(S,T.id,T.keyType,T.type,T.options,T.comment)},MapField.prototype.toJSON=function(S){var T=!!S&&!!S.keepComments;return N.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",T?this.comment:void 0])},MapField.prototype.resolve=function(){if(this.resolved)return this;if(void 0===O.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return P.prototype.resolve.call(this)},MapField.d=function(S,T,R){return"function"==typeof R?R=N.decorateType(R).name:R&&"object"==typeof R&&(R=N.decorateEnum(R).name),function(P,O){N.decorateType(P.constructor).add(new MapField(O,S,T,R))}}},34294:(S,T,R)=>{"use strict";S.exports=Message;var P=R(18932);function Message(S){if(S)for(var T=Object.keys(S),R=0;R<T.length;++R)this[T[R]]=S[T[R]]}Message.create=function(S){return this.$type.create(S)},Message.encode=function(S,T){return this.$type.encode(S,T)},Message.encodeDelimited=function(S,T){return this.$type.encodeDelimited(S,T)},Message.decode=function(S){return this.$type.decode(S)},Message.decodeDelimited=function(S){return this.$type.decodeDelimited(S)},Message.verify=function(S){return this.$type.verify(S)},Message.fromObject=function(S){return this.$type.fromObject(S)},Message.toObject=function(S,T){return this.$type.toObject(S,T)},Message.prototype.toJSON=function(){return this.$type.toObject(this,P.toJSONOptions)}},28909:(S,T,R)=>{"use strict";S.exports=Method;var P=R(61862);((Method.prototype=Object.create(P.prototype)).constructor=Method).className="Method";var O=R(66738);function Method(S,T,R,N,M,L,V,U,W){if(O.isObject(M)?(V=M,M=L=void 0):O.isObject(L)&&(V=L,L=void 0),!(void 0===T||O.isString(T)))throw TypeError("type must be a string");if(!O.isString(R))throw TypeError("requestType must be a string");if(!O.isString(N))throw TypeError("responseType must be a string");P.call(this,S,V),this.type=T||"rpc",this.requestType=R,this.requestStream=!!M||void 0,this.responseType=N,this.responseStream=!!L||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=U,this.parsedOptions=W}Method.fromJSON=function(S,T){return new Method(S,T.type,T.requestType,T.responseType,T.requestStream,T.responseStream,T.options,T.comment,T.parsedOptions)},Method.prototype.toJSON=function(S){var T=!!S&&!!S.keepComments;return O.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",T?this.comment:void 0,"parsedOptions",this.parsedOptions])},Method.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),P.prototype.resolve.call(this))}},97540:(S,T,R)=>{"use strict";S.exports=Namespace;var P,O,N,M=R(61862);((Namespace.prototype=Object.create(M.prototype)).constructor=Namespace).className="Namespace";var L=R(23980),V=R(66738),U=R(32866);function arrayToJSON(S,T){if(S&&S.length){for(var R={},P=0;P<S.length;++P)R[S[P].name]=S[P].toJSON(T);return R}}function Namespace(S,T){M.call(this,S,T),this.nested=void 0,this._nestedArray=null,this._lookupCache={},this._needsRecursiveFeatureResolution=!0,this._needsRecursiveResolve=!0}function clearCache(S){S._nestedArray=null,S._lookupCache={};for(var T=S;T=T.parent;)T._lookupCache={};return S}Namespace.fromJSON=function(S,T){return new Namespace(S,T.options).addJSON(T.nested)},Namespace.arrayToJSON=arrayToJSON,Namespace.isReservedId=function(S,T){if(S){for(var R=0;R<S.length;++R)if("string"!=typeof S[R]&&S[R][0]<=T&&S[R][1]>T)return!0}return!1},Namespace.isReservedName=function(S,T){if(S){for(var R=0;R<S.length;++R)if(S[R]===T)return!0}return!1},Object.defineProperty(Namespace.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=V.toArray(this.nested))}}),Namespace.prototype.toJSON=function(S){return V.toObject(["options",this.options,"nested",arrayToJSON(this.nestedArray,S)])},Namespace.prototype.addJSON=function(S){var T=this;if(S)for(var R,M=Object.keys(S),V=0;V<M.length;++V)R=S[M[V]],T.add((void 0!==R.fields?P.fromJSON:void 0!==R.values?N.fromJSON:void 0!==R.methods?O.fromJSON:void 0!==R.id?L.fromJSON:Namespace.fromJSON)(M[V],R));return this},Namespace.prototype.get=function(S){return this.nested&&this.nested[S]||null},Namespace.prototype.getEnum=function(S){if(this.nested&&this.nested[S]instanceof N)return this.nested[S].values;throw Error("no such enum: "+S)},Namespace.prototype.add=function(S){if(!(S instanceof L&&void 0!==S.extend||S instanceof P||S instanceof U||S instanceof N||S instanceof O||S instanceof Namespace))throw TypeError("object must be a valid nested object");if(this.nested){var T=this.get(S.name);if(T){if(T instanceof Namespace&&S instanceof Namespace&&!(T instanceof P||T instanceof O)){for(var R=T.nestedArray,M=0;M<R.length;++M)S.add(R[M]);this.remove(T),this.nested||(this.nested={}),S.setOptions(T.options,!0)}else throw Error("duplicate name '"+S.name+"' in "+this)}}else this.nested={};this.nested[S.name]=S,this instanceof P||this instanceof O||this instanceof N||this instanceof L||S._edition||(S._edition=S._defaultEdition),this._needsRecursiveFeatureResolution=!0,this._needsRecursiveResolve=!0;for(var V=this;V=V.parent;)V._needsRecursiveFeatureResolution=!0,V._needsRecursiveResolve=!0;return S.onAdd(this),clearCache(this)},Namespace.prototype.remove=function(S){if(!(S instanceof M))throw TypeError("object must be a ReflectionObject");if(S.parent!==this)throw Error(S+" is not a member of "+this);return delete this.nested[S.name],Object.keys(this.nested).length||(this.nested=void 0),S.onRemove(this),clearCache(this)},Namespace.prototype.define=function(S,T){if(V.isString(S))S=S.split(".");else if(!Array.isArray(S))throw TypeError("illegal path");if(S&&S.length&&""===S[0])throw Error("path must be relative");for(var R=this;S.length>0;){var P=S.shift();if(R.nested&&R.nested[P]){if(!((R=R.nested[P])instanceof Namespace))throw Error("path conflicts with non-namespace objects")}else R.add(R=new Namespace(P))}return T&&R.addJSON(T),R},Namespace.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;this._resolveFeaturesRecursive(this._edition);var S=this.nestedArray,T=0;for(this.resolve();T<S.length;)S[T]instanceof Namespace?S[T++].resolveAll():S[T++].resolve();return this._needsRecursiveResolve=!1,this},Namespace.prototype._resolveFeaturesRecursive=function(S){return this._needsRecursiveFeatureResolution&&(this._needsRecursiveFeatureResolution=!1,S=this._edition||S,M.prototype._resolveFeaturesRecursive.call(this,S),this.nestedArray.forEach(T=>{T._resolveFeaturesRecursive(S)})),this},Namespace.prototype.lookup=function(S,T,R){if("boolean"==typeof T?(R=T,T=void 0):T&&!Array.isArray(T)&&(T=[T]),V.isString(S)&&S.length){if("."===S)return this.root;S=S.split(".")}else if(!S.length)return this;var P=S.join(".");if(""===S[0])return this.root.lookup(S.slice(1),T);var O=this.root._fullyQualifiedObjects&&this.root._fullyQualifiedObjects["."+P];if(O&&(!T||T.indexOf(O.constructor)>-1)||(O=this._lookupImpl(S,P))&&(!T||T.indexOf(O.constructor)>-1))return O;if(R)return null;for(var N=this;N.parent;){if((O=N.parent._lookupImpl(S,P))&&(!T||T.indexOf(O.constructor)>-1))return O;N=N.parent}return null},Namespace.prototype._lookupImpl=function(S,T){if(Object.prototype.hasOwnProperty.call(this._lookupCache,T))return this._lookupCache[T];var R=this.get(S[0]),P=null;if(R)1===S.length?P=R:R instanceof Namespace&&(S=S.slice(1),P=R._lookupImpl(S,S.join(".")));else for(var O=0;O<this.nestedArray.length;++O)this._nestedArray[O]instanceof Namespace&&(R=this._nestedArray[O]._lookupImpl(S,T))&&(P=R);return this._lookupCache[T]=P,P},Namespace.prototype.lookupType=function(S){var T=this.lookup(S,[P]);if(!T)throw Error("no such type: "+S);return T},Namespace.prototype.lookupEnum=function(S){var T=this.lookup(S,[N]);if(!T)throw Error("no such Enum '"+S+"' in "+this);return T},Namespace.prototype.lookupTypeOrEnum=function(S){var T=this.lookup(S,[P,N]);if(!T)throw Error("no such Type or Enum '"+S+"' in "+this);return T},Namespace.prototype.lookupService=function(S){var T=this.lookup(S,[O]);if(!T)throw Error("no such Service '"+S+"' in "+this);return T},Namespace._configure=function(S,T,R){P=S,O=T,N=R}},61862:(S,T,R)=>{"use strict";S.exports=ReflectionObject,ReflectionObject.className="ReflectionObject";let P=R(32866);var O,N=R(66738),M={enum_type:"OPEN",field_presence:"EXPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"},L={enum_type:"CLOSED",field_presence:"EXPLICIT",json_format:"LEGACY_BEST_EFFORT",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"EXPANDED",utf8_validation:"NONE"},V={enum_type:"OPEN",field_presence:"IMPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"};function ReflectionObject(S,T){if(!N.isString(S))throw TypeError("name must be a string");if(T&&!N.isObject(T))throw TypeError("options must be an object");this.options=T,this.parsedOptions=null,this.name=S,this._edition=null,this._defaultEdition="proto2",this._features={},this._featuresResolved=!1,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(ReflectionObject.prototype,{root:{get:function(){for(var S=this;null!==S.parent;)S=S.parent;return S}},fullName:{get:function(){for(var S=[this.name],T=this.parent;T;)S.unshift(T.name),T=T.parent;return S.join(".")}}}),ReflectionObject.prototype.toJSON=function(){throw Error()},ReflectionObject.prototype.onAdd=function(S){this.parent&&this.parent!==S&&this.parent.remove(this),this.parent=S,this.resolved=!1;var T=S.root;T instanceof O&&T._handleAdd(this)},ReflectionObject.prototype.onRemove=function(S){var T=S.root;T instanceof O&&T._handleRemove(this),this.parent=null,this.resolved=!1},ReflectionObject.prototype.resolve=function(){return this.resolved||this.root instanceof O&&(this.resolved=!0),this},ReflectionObject.prototype._resolveFeaturesRecursive=function(S){return this._resolveFeatures(this._edition||S)},ReflectionObject.prototype._resolveFeatures=function(S){if(!this._featuresResolved){var T={};if(!S)throw Error("Unknown edition for "+this.fullName);var R=Object.assign(this.options?Object.assign({},this.options.features):{},this._inferLegacyProtoFeatures(S));if(this._edition){if("proto2"===S)T=Object.assign({},L);else if("proto3"===S)T=Object.assign({},V);else if("2023"===S)T=Object.assign({},M);else throw Error("Unknown edition: "+S);this._features=Object.assign(T,R||{}),this._featuresResolved=!0;return}if(this.partOf instanceof P){var O=Object.assign({},this.partOf._features);this._features=Object.assign(O,R||{})}else if(this.declaringField);else if(this.parent){var N=Object.assign({},this.parent._features);this._features=Object.assign(N,R||{})}else throw Error("Unable to find a parent for "+this.fullName);this.extensionField&&(this.extensionField._features=this._features),this._featuresResolved=!0}},ReflectionObject.prototype._inferLegacyProtoFeatures=function(){return{}},ReflectionObject.prototype.getOption=function(S){if(this.options)return this.options[S]},ReflectionObject.prototype.setOption=function(S,T,R){return this.options||(this.options={}),/^features\./.test(S)?N.setProperty(this.options,S,T,R):R&&void 0!==this.options[S]||(this.getOption(S)!==T&&(this.resolved=!1),this.options[S]=T),this},ReflectionObject.prototype.setParsedOption=function(S,T,R){this.parsedOptions||(this.parsedOptions=[]);var P=this.parsedOptions;if(R){var O=P.find(function(T){return Object.prototype.hasOwnProperty.call(T,S)});if(O){var M=O[S];N.setProperty(M,R,T)}else(O={})[S]=N.setProperty({},R,T),P.push(O)}else{var L={};L[S]=T,P.push(L)}return this},ReflectionObject.prototype.setOptions=function(S,T){if(S)for(var R=Object.keys(S),P=0;P<R.length;++P)this.setOption(R[P],S[R[P]],T);return this},ReflectionObject.prototype.toString=function(){var S=this.constructor.className,T=this.fullName;return T.length?S+" "+T:S},ReflectionObject.prototype._editionToJSON=function(){if(this._edition&&"proto3"!==this._edition)return this._edition},ReflectionObject._configure=function(S){O=S}},32866:(S,T,R)=>{"use strict";S.exports=OneOf;var P=R(61862);((OneOf.prototype=Object.create(P.prototype)).constructor=OneOf).className="OneOf";var O=R(23980),N=R(66738);function OneOf(S,T,R,O){if(Array.isArray(T)||(R=T,T=void 0),P.call(this,S,R),!(void 0===T||Array.isArray(T)))throw TypeError("fieldNames must be an Array");this.oneof=T||[],this.fieldsArray=[],this.comment=O}function addFieldsToParent(S){if(S.parent)for(var T=0;T<S.fieldsArray.length;++T)S.fieldsArray[T].parent||S.parent.add(S.fieldsArray[T])}OneOf.fromJSON=function(S,T){return new OneOf(S,T.oneof,T.options,T.comment)},OneOf.prototype.toJSON=function(S){var T=!!S&&!!S.keepComments;return N.toObject(["options",this.options,"oneof",this.oneof,"comment",T?this.comment:void 0])},OneOf.prototype.add=function(S){if(!(S instanceof O))throw TypeError("field must be a Field");return S.parent&&S.parent!==this.parent&&S.parent.remove(S),this.oneof.push(S.name),this.fieldsArray.push(S),S.partOf=this,addFieldsToParent(this),this},OneOf.prototype.remove=function(S){if(!(S instanceof O))throw TypeError("field must be a Field");var T=this.fieldsArray.indexOf(S);if(T<0)throw Error(S+" is not a member of "+this);return this.fieldsArray.splice(T,1),(T=this.oneof.indexOf(S.name))>-1&&this.oneof.splice(T,1),S.partOf=null,this},OneOf.prototype.onAdd=function(S){P.prototype.onAdd.call(this,S);for(var T=this,R=0;R<this.oneof.length;++R){var O=S.get(this.oneof[R]);O&&!O.partOf&&(O.partOf=T,T.fieldsArray.push(O))}addFieldsToParent(this)},OneOf.prototype.onRemove=function(S){for(var T,R=0;R<this.fieldsArray.length;++R)(T=this.fieldsArray[R]).parent&&T.parent.remove(T);P.prototype.onRemove.call(this,S)},Object.defineProperty(OneOf.prototype,"isProto3Optional",{get:function(){if(null==this.fieldsArray||1!==this.fieldsArray.length)return!1;var S=this.fieldsArray[0];return null!=S.options&&!0===S.options.proto3_optional}}),OneOf.d=function(){for(var S=Array(arguments.length),T=0;T<arguments.length;)S[T]=arguments[T++];return function(T,R){N.decorateType(T.constructor).add(new OneOf(R,S)),Object.defineProperty(T,R,{get:N.oneOfGetter(S),set:N.oneOfSetter(S)})}}},87897:(S,T,R)=>{"use strict";S.exports=parse,parse.filename=null,parse.defaults={keepCase:!1};var P=R(86116),O=R(98373),N=R(59340),M=R(23980),L=R(67597),V=R(32866),U=R(59246),W=R(82791),K=R(28909),Q=R(61862),$=R(91708),Y=R(66738),X=/^[1-9][0-9]*$/,Z=/^-?[1-9][0-9]*$/,ee=/^0[x][0-9a-fA-F]+$/,et=/^-?0[x][0-9a-fA-F]+$/,er=/^0[0-7]+$/,en=/^-?0[0-7]+$/,ei=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,es=/^[a-zA-Z_][a-zA-Z_0-9]*$/,ea=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/;function parse(S,T,R){T instanceof O||(R=T,T=new O),R||(R=parse.defaults);var eo,eu,ec,ed,eh=R.preferTrailingComment||!1,ep=P(S,R.alternateCommentMode||!1),ef=ep.next,em=ep.push,eg=ep.peek,ey=ep.skip,ev=ep.cmnt,eS=!0,eb="proto2",eC=T,eT=[],eE={},ew=R.keepCase?function(S){return S}:Y.camelCase;function resolveFileFeatures(){eT.forEach(S=>{S._edition=eb,Object.keys(eE).forEach(T=>{void 0===S.getOption(T)&&S.setOption(T,eE[T],!0)})})}function illegal(S,T,R){var P=parse.filename;return R||(parse.filename=null),Error("illegal "+(T||"token")+" '"+S+"' ("+(P?P+", ":"")+"line "+ep.line+")")}function readString(){var S,T=[];do{if('"'!==(S=ef())&&"'"!==S)throw illegal(S);T.push(ef()),ey(S),S=eg()}while('"'===S||"'"===S);return T.join("")}function readValue(S){var T=ef();switch(T){case"'":case'"':return em(T),readString();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return parseNumber(T,!0)}catch(R){if(S&&ea.test(T))return T;throw illegal(T,"value")}}function readRanges(S,T){do if(T&&('"'===(R=eg())||"'"===R)){var R,P,O=readString();if(S.push(O),eb>=2023)throw illegal(O,"id")}else try{S.push([P=parseId(ef()),ey("to",!0)?parseId(ef()):P])}catch(P){if(T&&ea.test(R)&&eb>=2023)S.push(R);else throw P}while(ey(",",!0));var N={options:void 0};N.setOption=function(S,T){void 0===this.options&&(this.options={}),this.options[S]=T},ifBlock(N,function(S){if("option"===S)parseOption(N,S),ey(";");else throw illegal(S)},function(){parseInlineOptions(N)})}function parseNumber(S,T){var R=1;switch("-"===S.charAt(0)&&(R=-1,S=S.substring(1)),S){case"inf":case"INF":case"Inf":return R*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(X.test(S))return R*parseInt(S,10);if(ee.test(S))return R*parseInt(S,16);if(er.test(S))return R*parseInt(S,8);if(ei.test(S))return R*parseFloat(S);throw illegal(S,"number",T)}function parseId(S,T){switch(S){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!T&&"-"===S.charAt(0))throw illegal(S,"id");if(Z.test(S))return parseInt(S,10);if(et.test(S))return parseInt(S,16);if(en.test(S))return parseInt(S,8);throw illegal(S,"id")}function parsePackage(){if(void 0!==eu)throw illegal("package");if(eu=ef(),!ea.test(eu))throw illegal(eu,"name");eC=eC.define(eu),ey(";")}function parseImport(){var S,T=eg();switch(T){case"weak":S=ed||(ed=[]),ef();break;case"public":ef();default:S=ec||(ec=[])}T=readString(),ey(";"),S.push(T)}function parseSyntax(){if(ey("="),(eb=readString())<2023)throw illegal(eb,"syntax");ey(";")}function parseEdition(){ey("="),eb=readString();let S=["2023"];if(!S.includes(eb))throw illegal(eb,"edition");ey(";")}function parseCommon(S,T){switch(T){case"option":return parseOption(S,T),ey(";"),!0;case"message":return parseType(S,T),!0;case"enum":return parseEnum(S,T),!0;case"service":return parseService(S,T),!0;case"extend":return parseExtension(S,T),!0}return!1}function ifBlock(S,T,R){var P,O=ep.line;if(S&&("string"!=typeof S.comment&&(S.comment=ev()),S.filename=parse.filename),ey("{",!0)){for(;"}"!==(P=ef());)T(P);ey(";",!0)}else R&&R(),ey(";"),S&&("string"!=typeof S.comment||eh)&&(S.comment=ev(O)||S.comment)}function parseType(S,T){if(!es.test(T=ef()))throw illegal(T,"type name");var R=new N(T);ifBlock(R,function(S){if(!parseCommon(R,S))switch(S){case"map":parseMapField(R,S);break;case"required":if("proto2"!==eb)throw illegal(S);case"repeated":parseField(R,S);break;case"optional":if("proto3"===eb)parseField(R,"proto3_optional");else if("proto2"!==eb)throw illegal(S);else parseField(R,"optional");break;case"oneof":parseOneOf(R,S);break;case"extensions":readRanges(R.extensions||(R.extensions=[]));break;case"reserved":readRanges(R.reserved||(R.reserved=[]),!0);break;default:if("proto2"===eb||!ea.test(S))throw illegal(S);em(S),parseField(R,"optional")}}),S.add(R),S===eC&&eT.push(R)}function parseField(S,T,R){var P=ef();if("group"===P){parseGroup(S,T);return}for(;P.endsWith(".")||eg().startsWith(".");)P+=ef();if(!ea.test(P))throw illegal(P,"type");var O=ef();if(!es.test(O))throw illegal(O,"name");O=ew(O),ey("=");var N=new M(O,parseId(ef()),P,T,R);if(ifBlock(N,function(S){if("option"===S)parseOption(N,S),ey(";");else throw illegal(S)},function(){parseInlineOptions(N)}),"proto3_optional"===T){var L=new V("_"+O);N.setOption("proto3_optional",!0),L.add(N),S.add(L)}else S.add(N);S===eC&&eT.push(N)}function parseGroup(S,T){if(eb>=2023)throw illegal("group");var R=ef();if(!es.test(R))throw illegal(R,"name");var P=Y.lcFirst(R);R===P&&(R=Y.ucFirst(R)),ey("=");var O=parseId(ef()),L=new N(R);L.group=!0;var V=new M(P,O,R,T);V.filename=parse.filename,ifBlock(L,function(S){switch(S){case"option":parseOption(L,S),ey(";");break;case"required":case"repeated":parseField(L,S);break;case"optional":"proto3"===eb?parseField(L,"proto3_optional"):parseField(L,"optional");break;case"message":parseType(L,S);break;case"enum":parseEnum(L,S);break;case"reserved":readRanges(L.reserved||(L.reserved=[]),!0);break;default:throw illegal(S)}}),S.add(L).add(V)}function parseMapField(S){ey("<");var T=ef();if(void 0===$.mapKey[T])throw illegal(T,"type");ey(",");var R=ef();if(!ea.test(R))throw illegal(R,"type");ey(">");var P=ef();if(!es.test(P))throw illegal(P,"name");ey("=");var O=new L(ew(P),parseId(ef()),T,R);ifBlock(O,function(S){if("option"===S)parseOption(O,S),ey(";");else throw illegal(S)},function(){parseInlineOptions(O)}),S.add(O)}function parseOneOf(S,T){if(!es.test(T=ef()))throw illegal(T,"name");var R=new V(ew(T));ifBlock(R,function(S){"option"===S?(parseOption(R,S),ey(";")):(em(S),parseField(R,"optional"))}),S.add(R)}function parseEnum(S,T){if(!es.test(T=ef()))throw illegal(T,"name");var R=new U(T);ifBlock(R,function(S){switch(S){case"option":parseOption(R,S),ey(";");break;case"reserved":readRanges(R.reserved||(R.reserved=[]),!0),void 0===R.reserved&&(R.reserved=[]);break;default:parseEnumValue(R,S)}}),S.add(R),S===eC&&eT.push(R)}function parseEnumValue(S,T){if(!es.test(T))throw illegal(T,"name");ey("=");var R=parseId(ef(),!0),P={options:void 0};P.getOption=function(S){return this.options[S]},P.setOption=function(S,T){Q.prototype.setOption.call(P,S,T)},P.setParsedOption=function(){},ifBlock(P,function(S){if("option"===S)parseOption(P,S),ey(";");else throw illegal(S)},function(){parseInlineOptions(P)}),S.add(T,R,P.comment,P.parsedOptions||P.options)}function parseOption(S,T){var R,P,O=!0;for("option"===T&&(T=ef());"="!==T;){if("("===T){var N=ef();ey(")"),T="("+N+")"}if(O){if(O=!1,T.includes(".")&&!T.includes("(")){var M=T.split(".");R=M[0]+".",T=M[1];continue}R=T}else P=P?P+=T:T;T=ef()}var L=parseOptionValue(S,P?R.concat(P):R);P=P&&"."===P[0]?P.slice(1):P,setParsedOption(S,R=R&&"."===R[R.length-1]?R.slice(0,-1):R,L,P)}function parseOptionValue(S,T){if(ey("{",!0)){for(var R={};!ey("}",!0);){if(!es.test(eo=ef()))throw illegal(eo,"name");if(null===eo)throw illegal(eo,"end of input");var P,O,N=eo;if(ey(":",!0),"{"===eg())P=parseOptionValue(S,T+"."+eo);else if("["===eg()){if(P=[],ey("[",!0)){do O=readValue(!0),P.push(O);while(ey(",",!0));ey("]"),void 0!==O&&setOption(S,T+"."+eo,O)}}else P=readValue(!0),setOption(S,T+"."+eo,P);var M=R[N];M&&(P=[].concat(M).concat(P)),R[N]=P,ey(",",!0),ey(";",!0)}return R}var L=readValue(!0);return setOption(S,T,L),L}function setOption(S,T,R){if(eC===S&&/^features\./.test(T)){eE[T]=R;return}S.setOption&&S.setOption(T,R)}function setParsedOption(S,T,R,P){S.setParsedOption&&S.setParsedOption(T,R,P)}function parseInlineOptions(S){if(ey("[",!0)){do parseOption(S,"option");while(ey(",",!0));ey("]")}return S}function parseService(S,T){if(!es.test(T=ef()))throw illegal(T,"service name");var R=new W(T);ifBlock(R,function(S){if(!parseCommon(R,S)){if("rpc"===S)parseMethod(R,S);else throw illegal(S)}}),S.add(R),S===eC&&eT.push(R)}function parseMethod(S,T){var R=ev(),P=T;if(!es.test(T=ef()))throw illegal(T,"name");var O,N,M,L,V=T;if(ey("("),ey("stream",!0)&&(N=!0),!ea.test(T=ef())||(O=T,ey(")"),ey("returns"),ey("("),ey("stream",!0)&&(L=!0),!ea.test(T=ef())))throw illegal(T);M=T,ey(")");var U=new K(V,P,O,M,N,L);U.comment=R,ifBlock(U,function(S){if("option"===S)parseOption(U,S),ey(";");else throw illegal(S)}),S.add(U)}function parseExtension(S,T){if(!ea.test(T=ef()))throw illegal(T,"reference");var R=T;ifBlock(null,function(T){switch(T){case"required":case"repeated":parseField(S,T,R);break;case"optional":"proto3"===eb?parseField(S,"proto3_optional",R):parseField(S,"optional",R);break;default:if("proto2"===eb||!ea.test(T))throw illegal(T);em(T),parseField(S,"optional",R)}})}for(;null!==(eo=ef());)switch(eo){case"package":if(!eS)throw illegal(eo);parsePackage();break;case"import":if(!eS)throw illegal(eo);parseImport();break;case"syntax":if(!eS)throw illegal(eo);parseSyntax();break;case"edition":if(!eS)throw illegal(eo);parseEdition();break;case"option":parseOption(eC,eo),ey(";",!0);break;default:if(parseCommon(eC,eo)){eS=!1;continue}throw illegal(eo)}return resolveFileFeatures(),parse.filename=null,{package:eu,imports:ec,weakImports:ed,root:T}}},95199:(S,T,R)=>{"use strict";S.exports=Reader;var P,O=R(18932),N=O.LongBits,M=O.utf8;function indexOutOfRange(S,T){return RangeError("index out of range: "+S.pos+" + "+(T||1)+" > "+S.len)}function Reader(S){this.buf=S,this.pos=0,this.len=S.length}var L="undefined"!=typeof Uint8Array?function(S){if(S instanceof Uint8Array||Array.isArray(S))return new Reader(S);throw Error("illegal buffer")}:function(S){if(Array.isArray(S))return new Reader(S);throw Error("illegal buffer")},create=function(){return O.Buffer?function(S){return(Reader.create=function(S){return O.Buffer.isBuffer(S)?new P(S):L(S)})(S)}:L};function readLongVarint(){var S=new N(0,0),T=0;if(this.len-this.pos>4){for(;T<4;++T)if(S.lo=(S.lo|(127&this.buf[this.pos])<<7*T)>>>0,this.buf[this.pos++]<128)return S;if(S.lo=(S.lo|(127&this.buf[this.pos])<<28)>>>0,S.hi=(S.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return S;T=0}else{for(;T<3;++T){if(this.pos>=this.len)throw indexOutOfRange(this);if(S.lo=(S.lo|(127&this.buf[this.pos])<<7*T)>>>0,this.buf[this.pos++]<128)return S}return S.lo=(S.lo|(127&this.buf[this.pos++])<<7*T)>>>0,S}if(this.len-this.pos>4){for(;T<5;++T)if(S.hi=(S.hi|(127&this.buf[this.pos])<<7*T+3)>>>0,this.buf[this.pos++]<128)return S}else for(;T<5;++T){if(this.pos>=this.len)throw indexOutOfRange(this);if(S.hi=(S.hi|(127&this.buf[this.pos])<<7*T+3)>>>0,this.buf[this.pos++]<128)return S}throw Error("invalid varint encoding")}function readFixed32_end(S,T){return(S[T-4]|S[T-3]<<8|S[T-2]<<16|S[T-1]<<24)>>>0}function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new N(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader.create=create(),Reader.prototype._slice=O.Array.prototype.subarray||O.Array.prototype.slice,Reader.prototype.uint32=function(){var S=4294967295;return function(){if(S=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128||(S=(S|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)||(S=(S|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)||(S=(S|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)||(S=(S|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128))return S;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return S}}(),Reader.prototype.int32=function(){return 0|this.uint32()},Reader.prototype.sint32=function(){var S=this.uint32();return S>>>1^-(1&S)|0},Reader.prototype.bool=function(){return 0!==this.uint32()},Reader.prototype.fixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.sfixed32=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return 0|readFixed32_end(this.buf,this.pos+=4)},Reader.prototype.float=function(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var S=O.float.readFloatLE(this.buf,this.pos);return this.pos+=4,S},Reader.prototype.double=function(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var S=O.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,S},Reader.prototype.bytes=function(){var S=this.uint32(),T=this.pos,R=this.pos+S;if(R>this.len)throw indexOutOfRange(this,S);if(this.pos+=S,Array.isArray(this.buf))return this.buf.slice(T,R);if(T===R){var P=O.Buffer;return P?P.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,T,R)},Reader.prototype.string=function(){var S=this.bytes();return M.read(S,0,S.length)},Reader.prototype.skip=function(S){if("number"==typeof S){if(this.pos+S>this.len)throw indexOutOfRange(this,S);this.pos+=S}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(128&this.buf[this.pos++]);return this},Reader.prototype.skipType=function(S){switch(S){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(S=7&this.uint32());)this.skipType(S);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+S+" at offset "+this.pos)}return this},Reader._configure=function(S){P=S,Reader.create=create(),P._configure();var T=O.Long?"toLong":"toNumber";O.merge(Reader.prototype,{int64:function(){return readLongVarint.call(this)[T](!1)},uint64:function(){return readLongVarint.call(this)[T](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[T](!1)},fixed64:function(){return readFixed64.call(this)[T](!0)},sfixed64:function(){return readFixed64.call(this)[T](!1)}})}},15213:(S,T,R)=>{"use strict";S.exports=BufferReader;var P=R(95199);(BufferReader.prototype=Object.create(P.prototype)).constructor=BufferReader;var O=R(18932);function BufferReader(S){P.call(this,S)}BufferReader._configure=function(){O.Buffer&&(BufferReader.prototype._slice=O.Buffer.prototype.slice)},BufferReader.prototype.string=function(){var S=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+S,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+S,this.len))},BufferReader._configure()},98373:(S,T,R)=>{"use strict";S.exports=Root;var P,O,N,M=R(97540);((Root.prototype=Object.create(M.prototype)).constructor=Root).className="Root";var L=R(23980),V=R(59246),U=R(32866),W=R(66738);function Root(S){M.call(this,"",S),this.deferred=[],this.files=[],this._edition="proto2",this._fullyQualifiedObjects={}}function SYNC(){}Root.fromJSON=function(S,T){return T||(T=new Root),S.options&&T.setOptions(S.options),T.addJSON(S.nested).resolveAll()},Root.prototype.resolvePath=W.path.resolve,Root.prototype.fetch=W.fetch,Root.prototype.load=function load(S,T,R){"function"==typeof T&&(R=T,T=void 0);var P=this;if(!R)return W.asPromise(load,P,S,T);var M=R===SYNC;function finish(S,T){if(R){if(M)throw S;T&&T.resolveAll();var P=R;R=null,P(S,T)}}function getBundledFileName(S){var T=S.lastIndexOf("google/protobuf/");if(T>-1){var R=S.substring(T);if(R in N)return R}return null}function process(S,R){try{if(W.isString(R)&&"{"===R.charAt(0)&&(R=JSON.parse(R)),W.isString(R)){O.filename=S;var N,V=O(R,P,T),U=0;if(V.imports)for(;U<V.imports.length;++U)(N=getBundledFileName(V.imports[U])||P.resolvePath(S,V.imports[U]))&&fetch(N);if(V.weakImports)for(U=0;U<V.weakImports.length;++U)(N=getBundledFileName(V.weakImports[U])||P.resolvePath(S,V.weakImports[U]))&&fetch(N,!0)}else P.setOptions(R.options).addJSON(R.nested)}catch(S){finish(S)}M||L||finish(null,P)}function fetch(S,T){if(S=getBundledFileName(S)||S,!(P.files.indexOf(S)>-1)){if(P.files.push(S),S in N){M?process(S,N[S]):(++L,setTimeout(function(){--L,process(S,N[S])}));return}if(M){var O;try{O=W.fs.readFileSync(S).toString("utf8")}catch(S){T||finish(S);return}process(S,O)}else++L,P.fetch(S,function(O,N){if(--L,R){if(O){T?L||finish(null,P):finish(O);return}process(S,N)}})}}var L=0;W.isString(S)&&(S=[S]);for(var V,U=0;U<S.length;++U)(V=P.resolvePath("",S[U]))&&fetch(V);return M?P.resolveAll():L||finish(null,P),P},Root.prototype.loadSync=function(S,T){if(!W.isNode)throw Error("not supported");return this.load(S,T,SYNC)},Root.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(S){return"'extend "+S.extend+"' in "+S.parent.fullName}).join(", "));return M.prototype.resolveAll.call(this)};var K=/^[A-Z]/;function tryHandleExtension(S,T){var R=T.parent.lookup(T.extend);if(R){var P=new L(T.fullName,T.id,T.type,T.rule,void 0,T.options);return!!R.get(P.name)||(P.declaringField=T,T.extensionField=P,R.add(P),!0)}return!1}Root.prototype._handleAdd=function(S){if(S instanceof L)void 0===S.extend||S.extensionField||tryHandleExtension(this,S)||this.deferred.push(S);else if(S instanceof V)K.test(S.name)&&(S.parent[S.name]=S.values);else if(!(S instanceof U)){if(S instanceof P)for(var T=0;T<this.deferred.length;)tryHandleExtension(this,this.deferred[T])?this.deferred.splice(T,1):++T;for(var R=0;R<S.nestedArray.length;++R)this._handleAdd(S._nestedArray[R]);K.test(S.name)&&(S.parent[S.name]=S)}(S instanceof P||S instanceof V||S instanceof L)&&(this._fullyQualifiedObjects[S.fullName]=S)},Root.prototype._handleRemove=function(S){if(S instanceof L){if(void 0!==S.extend){if(S.extensionField)S.extensionField.parent.remove(S.extensionField),S.extensionField=null;else{var T=this.deferred.indexOf(S);T>-1&&this.deferred.splice(T,1)}}}else if(S instanceof V)K.test(S.name)&&delete S.parent[S.name];else if(S instanceof M){for(var R=0;R<S.nestedArray.length;++R)this._handleRemove(S._nestedArray[R]);K.test(S.name)&&delete S.parent[S.name]}delete this._fullyQualifiedObjects[S.fullName]},Root._configure=function(S,T,R){P=S,O=T,N=R}},10182:S=>{"use strict";S.exports={}},69226:(S,T,R)=>{"use strict";T.Service=R(12741)},12741:(S,T,R)=>{"use strict";S.exports=Service;var P=R(18932);function Service(S,T,R){if("function"!=typeof S)throw TypeError("rpcImpl must be a function");P.EventEmitter.call(this),this.rpcImpl=S,this.requestDelimited=!!T,this.responseDelimited=!!R}(Service.prototype=Object.create(P.EventEmitter.prototype)).constructor=Service,Service.prototype.rpcCall=function rpcCall(S,T,R,O,N){if(!O)throw TypeError("request must be specified");var M=this;if(!N)return P.asPromise(rpcCall,M,S,T,R,O);if(!M.rpcImpl){setTimeout(function(){N(Error("already ended"))},0);return}try{return M.rpcImpl(S,T[M.requestDelimited?"encodeDelimited":"encode"](O).finish(),function(T,P){if(T)return M.emit("error",T,S),N(T);if(null===P){M.end(!0);return}if(!(P instanceof R))try{P=R[M.responseDelimited?"decodeDelimited":"decode"](P)}catch(T){return M.emit("error",T,S),N(T)}return M.emit("data",P,S),N(null,P)})}catch(T){M.emit("error",T,S),setTimeout(function(){N(T)},0);return}},Service.prototype.end=function(S){return this.rpcImpl&&(S||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},82791:(S,T,R)=>{"use strict";S.exports=Service;var P=R(97540);((Service.prototype=Object.create(P.prototype)).constructor=Service).className="Service";var O=R(28909),N=R(66738),M=R(69226);function Service(S,T){P.call(this,S,T),this.methods={},this._methodsArray=null}function clearCache(S){return S._methodsArray=null,S}Service.fromJSON=function(S,T){var R=new Service(S,T.options);if(T.methods)for(var P=Object.keys(T.methods),N=0;N<P.length;++N)R.add(O.fromJSON(P[N],T.methods[P[N]]));return T.nested&&R.addJSON(T.nested),T.edition&&(R._edition=T.edition),R.comment=T.comment,R._defaultEdition="proto3",R},Service.prototype.toJSON=function(S){var T=P.prototype.toJSON.call(this,S),R=!!S&&!!S.keepComments;return N.toObject(["edition",this._editionToJSON(),"options",T&&T.options||void 0,"methods",P.arrayToJSON(this.methodsArray,S)||{},"nested",T&&T.nested||void 0,"comment",R?this.comment:void 0])},Object.defineProperty(Service.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=N.toArray(this.methods))}}),Service.prototype.get=function(S){return this.methods[S]||P.prototype.get.call(this,S)},Service.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;P.prototype.resolve.call(this);for(var S=this.methodsArray,T=0;T<S.length;++T)S[T].resolve();return this},Service.prototype._resolveFeaturesRecursive=function(S){return this._needsRecursiveFeatureResolution&&(S=this._edition||S,P.prototype._resolveFeaturesRecursive.call(this,S),this.methodsArray.forEach(T=>{T._resolveFeaturesRecursive(S)})),this},Service.prototype.add=function(S){if(this.get(S.name))throw Error("duplicate name '"+S.name+"' in "+this);return S instanceof O?(this.methods[S.name]=S,S.parent=this,clearCache(this)):P.prototype.add.call(this,S)},Service.prototype.remove=function(S){if(S instanceof O){if(this.methods[S.name]!==S)throw Error(S+" is not a member of "+this);return delete this.methods[S.name],S.parent=null,clearCache(this)}return P.prototype.remove.call(this,S)},Service.prototype.create=function(S,T,R){for(var P,O=new M.Service(S,T,R),L=0;L<this.methodsArray.length;++L){var V=N.lcFirst((P=this._methodsArray[L]).resolve().name).replace(/[^$\w_]/g,"");O[V]=N.codegen(["r","c"],N.isReserved(V)?V+"_":V)("return this.rpcCall(m,q,s,r,c)")({m:P,q:P.resolvedRequestType.ctor,s:P.resolvedResponseType.ctor})}return O}},86116:S=>{"use strict";S.exports=tokenize;var T=/[\s{}=;:[\],'"()<>]/g,R=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,P=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,O=/^ *[*/]+ */,N=/^\s*\*?\/*/,M=/\n/g,L=/\s/,V=/\\(.?)/g,U={0:"\x00",r:"\r",n:"\n",t:"	"};function unescape(S){return S.replace(V,function(S,T){switch(T){case"\\":case"":return T;default:return U[T]||""}})}function tokenize(S,V){S=S.toString();var U=0,W=S.length,K=1,Q=0,$={},Y=[],X=null;function illegal(S){return Error("illegal "+S+" (line "+K+")")}function readString(){var T="'"===X?P:R;T.lastIndex=U-1;var O=T.exec(S);if(!O)throw illegal("string");return U=T.lastIndex,push(X),X=null,unescape(O[1])}function charAt(T){return S.charAt(T)}function setComment(T,R,P){var L,U,W={type:S.charAt(T++),lineEmpty:!1,leading:P},Y=T-(L=V?2:3);do if(--Y<0||"\n"===(U=S.charAt(Y))){W.lineEmpty=!0;break}while(" "===U||"	"===U);for(var X=S.substring(T,R).split(M),Z=0;Z<X.length;++Z)X[Z]=X[Z].replace(V?N:O,"").trim();W.text=X.join("\n").trim(),$[K]=W,Q=K}function isDoubleSlashCommentLine(T){var R=findEndOfLine(T),P=S.substring(T,R);return/^\s*\/\//.test(P)}function findEndOfLine(S){for(var T=S;T<W&&"\n"!==charAt(T);)T++;return T}function next(){if(Y.length>0)return Y.shift();if(X)return readString();var R,P,O,N,M,Q=0===U;do{if(U===W)return null;for(R=!1;L.test(O=charAt(U));)if("\n"===O&&(Q=!0,++K),++U===W)return null;if("/"===charAt(U)){if(++U===W)throw illegal("comment");if("/"===charAt(U)){if(V){if(N=U,M=!1,isDoubleSlashCommentLine(U-1)){M=!0;do if((U=findEndOfLine(U))===W||(U++,!Q))break;while(isDoubleSlashCommentLine(U))}else U=Math.min(W,findEndOfLine(U)+1);M&&(setComment(N,U,Q),Q=!0),K++,R=!0}else{for(M="/"===charAt(N=U+1);"\n"!==charAt(++U);)if(U===W)return null;++U,M&&(setComment(N,U-1,Q),Q=!0),++K,R=!0}}else{if("*"!==(O=charAt(U)))return"/";N=U+1,M=V||"*"===charAt(N);do{if("\n"===O&&++K,++U===W)throw illegal("comment");P=O,O=charAt(U)}while("*"!==P||"/"!==O);++U,M&&(setComment(N,U-2,Q),Q=!0),R=!0}}}while(R);var $=U;if(T.lastIndex=0,!T.test(charAt($++)))for(;$<W&&!T.test(charAt($));)++$;var Z=S.substring(U,U=$);return('"'===Z||"'"===Z)&&(X=Z),Z}function push(S){Y.push(S)}function peek(){if(!Y.length){var S=next();if(null===S)return null;push(S)}return Y[0]}function skip(S,T){var R=peek();if(R===S)return next(),!0;if(!T)throw illegal("token '"+R+"', '"+S+"' expected");return!1}function cmnt(S){var T,R=null;return void 0===S?(T=$[K-1],delete $[K-1],T&&(V||"*"===T.type||T.lineEmpty)&&(R=T.leading?T.text:null)):(Q<S&&peek(),T=$[S],delete $[S],T&&!T.lineEmpty&&(V||"/"===T.type)&&(R=T.leading?null:T.text)),R}return Object.defineProperty({next:next,peek:peek,push:push,skip:skip,cmnt:cmnt},"line",{get:function(){return K}})}tokenize.unescape=unescape},59340:(S,T,R)=>{"use strict";S.exports=Type;var P=R(97540);((Type.prototype=Object.create(P.prototype)).constructor=Type).className="Type";var O=R(59246),N=R(32866),M=R(23980),L=R(67597),V=R(82791),U=R(34294),W=R(95199),K=R(84353),Q=R(66738),$=R(49561),Y=R(87317),X=R(17585),Z=R(84144),ee=R(34038);function Type(S,T){P.call(this,S,T),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}function clearCache(S){return S._fieldsById=S._fieldsArray=S._oneofsArray=null,delete S.encode,delete S.decode,delete S.verify,S}Object.defineProperties(Type.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var S=Object.keys(this.fields),T=0;T<S.length;++T){var R=this.fields[S[T]],P=R.id;if(this._fieldsById[P])throw Error("duplicate id "+P+" in "+this);this._fieldsById[P]=R}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=Q.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=Q.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=Type.generateConstructor(this)())},set:function(S){var T=S.prototype;T instanceof U||((S.prototype=new U).constructor=S,Q.merge(S.prototype,T)),S.$type=S.prototype.$type=this,Q.merge(S,U,!0),this._ctor=S;for(var R=0;R<this.fieldsArray.length;++R)this._fieldsArray[R].resolve();var P={};for(R=0;R<this.oneofsArray.length;++R)P[this._oneofsArray[R].resolve().name]={get:Q.oneOfGetter(this._oneofsArray[R].oneof),set:Q.oneOfSetter(this._oneofsArray[R].oneof)};R&&Object.defineProperties(S.prototype,P)}}}),Type.generateConstructor=function(S){for(var T,R=Q.codegen(["p"],S.name),P=0;P<S.fieldsArray.length;++P)(T=S._fieldsArray[P]).map?R("this%s={}",Q.safeProp(T.name)):T.repeated&&R("this%s=[]",Q.safeProp(T.name));return R("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},Type.fromJSON=function(S,T){var R=new Type(S,T.options);R.extensions=T.extensions,R.reserved=T.reserved;for(var U=Object.keys(T.fields),W=0;W<U.length;++W)R.add((void 0!==T.fields[U[W]].keyType?L.fromJSON:M.fromJSON)(U[W],T.fields[U[W]]));if(T.oneofs)for(U=Object.keys(T.oneofs),W=0;W<U.length;++W)R.add(N.fromJSON(U[W],T.oneofs[U[W]]));if(T.nested)for(U=Object.keys(T.nested),W=0;W<U.length;++W){var K=T.nested[U[W]];R.add((void 0!==K.id?M.fromJSON:void 0!==K.fields?Type.fromJSON:void 0!==K.values?O.fromJSON:void 0!==K.methods?V.fromJSON:P.fromJSON)(U[W],K))}return T.extensions&&T.extensions.length&&(R.extensions=T.extensions),T.reserved&&T.reserved.length&&(R.reserved=T.reserved),T.group&&(R.group=!0),T.comment&&(R.comment=T.comment),T.edition&&(R._edition=T.edition),R._defaultEdition="proto3",R},Type.prototype.toJSON=function(S){var T=P.prototype.toJSON.call(this,S),R=!!S&&!!S.keepComments;return Q.toObject(["edition",this._editionToJSON(),"options",T&&T.options||void 0,"oneofs",P.arrayToJSON(this.oneofsArray,S),"fields",P.arrayToJSON(this.fieldsArray.filter(function(S){return!S.declaringField}),S)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",T&&T.nested||void 0,"comment",R?this.comment:void 0])},Type.prototype.resolveAll=function(){if(!this._needsRecursiveResolve)return this;P.prototype.resolveAll.call(this);var S=this.oneofsArray;for(R=0;R<S.length;)S[R++].resolve();for(var T=this.fieldsArray,R=0;R<T.length;)T[R++].resolve();return this},Type.prototype._resolveFeaturesRecursive=function(S){return this._needsRecursiveFeatureResolution&&(S=this._edition||S,P.prototype._resolveFeaturesRecursive.call(this,S),this.oneofsArray.forEach(T=>{T._resolveFeatures(S)}),this.fieldsArray.forEach(T=>{T._resolveFeatures(S)})),this},Type.prototype.get=function(S){return this.fields[S]||this.oneofs&&this.oneofs[S]||this.nested&&this.nested[S]||null},Type.prototype.add=function(S){if(this.get(S.name))throw Error("duplicate name '"+S.name+"' in "+this);if(S instanceof M&&void 0===S.extend){if(this._fieldsById?this._fieldsById[S.id]:this.fieldsById[S.id])throw Error("duplicate id "+S.id+" in "+this);if(this.isReservedId(S.id))throw Error("id "+S.id+" is reserved in "+this);if(this.isReservedName(S.name))throw Error("name '"+S.name+"' is reserved in "+this);return S.parent&&S.parent.remove(S),this.fields[S.name]=S,S.message=this,S.onAdd(this),clearCache(this)}return S instanceof N?(this.oneofs||(this.oneofs={}),this.oneofs[S.name]=S,S.onAdd(this),clearCache(this)):P.prototype.add.call(this,S)},Type.prototype.remove=function(S){if(S instanceof M&&void 0===S.extend){if(!this.fields||this.fields[S.name]!==S)throw Error(S+" is not a member of "+this);return delete this.fields[S.name],S.parent=null,S.onRemove(this),clearCache(this)}if(S instanceof N){if(!this.oneofs||this.oneofs[S.name]!==S)throw Error(S+" is not a member of "+this);return delete this.oneofs[S.name],S.parent=null,S.onRemove(this),clearCache(this)}return P.prototype.remove.call(this,S)},Type.prototype.isReservedId=function(S){return P.isReservedId(this.reserved,S)},Type.prototype.isReservedName=function(S){return P.isReservedName(this.reserved,S)},Type.prototype.create=function(S){return new this.ctor(S)},Type.prototype.setup=function(){for(var S=this.fullName,T=[],R=0;R<this.fieldsArray.length;++R)T.push(this._fieldsArray[R].resolve().resolvedType);this.encode=$(this)({Writer:K,types:T,util:Q}),this.decode=Y(this)({Reader:W,types:T,util:Q}),this.verify=X(this)({types:T,util:Q}),this.fromObject=Z.fromObject(this)({types:T,util:Q}),this.toObject=Z.toObject(this)({types:T,util:Q});var P=ee[S];if(P){var O=Object.create(this);O.fromObject=this.fromObject,this.fromObject=P.fromObject.bind(O),O.toObject=this.toObject,this.toObject=P.toObject.bind(O)}return this},Type.prototype.encode=function(S,T){return this.setup().encode(S,T)},Type.prototype.encodeDelimited=function(S,T){return this.encode(S,T&&T.len?T.fork():T).ldelim()},Type.prototype.decode=function(S,T){return this.setup().decode(S,T)},Type.prototype.decodeDelimited=function(S){return S instanceof W||(S=W.create(S)),this.decode(S,S.uint32())},Type.prototype.verify=function(S){return this.setup().verify(S)},Type.prototype.fromObject=function(S){return this.setup().fromObject(S)},Type.prototype.toObject=function(S,T){return this.setup().toObject(S,T)},Type.d=function(S){return function(T){Q.decorateType(T,S)}}},91708:(S,T,R)=>{"use strict";var P=T,O=R(66738),N=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function bake(S,T){var R=0,P={};for(T|=0;R<S.length;)P[N[R+T]]=S[R++];return P}P.basic=bake([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),P.defaults=bake([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",O.emptyArray,null]),P.long=bake([0,0,0,1,1],7),P.mapKey=bake([0,0,0,5,5,0,0,0,1,1,0,2],2),P.packed=bake([1,5,0,0,0,5,5,0,0,0,1,1,0])},66738:(S,T,R)=>{"use strict";var P,O,N=S.exports=R(18932),M=R(10182);N.codegen=R(57311),N.fetch=R(82651),N.path=R(52768),N.fs=N.inquire("fs"),N.toArray=function(S){if(S){for(var T=Object.keys(S),R=Array(T.length),P=0;P<T.length;)R[P]=S[T[P++]];return R}return[]},N.toObject=function(S){for(var T={},R=0;R<S.length;){var P=S[R++],O=S[R++];void 0!==O&&(T[P]=O)}return T};var L=/\\/g,V=/"/g;N.isReserved=function(S){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(S)},N.safeProp=function(S){return!/^[$\w_]+$/.test(S)||N.isReserved(S)?'["'+S.replace(L,"\\\\").replace(V,'\\"')+'"]':"."+S},N.ucFirst=function(S){return S.charAt(0).toUpperCase()+S.substring(1)};var U=/_([a-z])/g;N.camelCase=function(S){return S.substring(0,1)+S.substring(1).replace(U,function(S,T){return T.toUpperCase()})},N.compareFieldsById=function(S,T){return S.id-T.id},N.decorateType=function(S,T){if(S.$type)return T&&S.$type.name!==T&&(N.decorateRoot.remove(S.$type),S.$type.name=T,N.decorateRoot.add(S.$type)),S.$type;P||(P=R(59340));var O=new P(T||S.name);return N.decorateRoot.add(O),O.ctor=S,Object.defineProperty(S,"$type",{value:O,enumerable:!1}),Object.defineProperty(S.prototype,"$type",{value:O,enumerable:!1}),O};var W=0;N.decorateEnum=function(S){if(S.$type)return S.$type;O||(O=R(59246));var T=new O("Enum"+W++,S);return N.decorateRoot.add(T),Object.defineProperty(S,"$type",{value:T,enumerable:!1}),T},N.setProperty=function(S,T,R,P){function setProp(S,T,R){var O=T.shift();if("__proto__"===O||"prototype"===O)return S;if(T.length>0)S[O]=setProp(S[O]||{},T,R);else{var N=S[O];if(N&&P)return S;N&&(R=[].concat(N).concat(R)),S[O]=R}return S}if("object"!=typeof S)throw TypeError("dst must be an object");if(!T)throw TypeError("path must be specified");return setProp(S,T=T.split("."),R)},Object.defineProperty(N,"decorateRoot",{get:function(){return M.decorated||(M.decorated=new(R(98373)))}})},41168:(S,T,R)=>{"use strict";S.exports=LongBits;var P=R(18932);function LongBits(S,T){this.lo=S>>>0,this.hi=T>>>0}var O=LongBits.zero=new LongBits(0,0);O.toNumber=function(){return 0},O.zzEncode=O.zzDecode=function(){return this},O.length=function(){return 1};var N=LongBits.zeroHash="\x00\x00\x00\x00\x00\x00\x00\x00";LongBits.fromNumber=function(S){if(0===S)return O;var T=S<0;T&&(S=-S);var R=S>>>0,P=(S-R)/4294967296>>>0;return T&&(P=~P>>>0,R=~R>>>0,++R>4294967295&&(R=0,++P>4294967295&&(P=0))),new LongBits(R,P)},LongBits.from=function(S){if("number"==typeof S)return LongBits.fromNumber(S);if(P.isString(S)){if(!P.Long)return LongBits.fromNumber(parseInt(S,10));S=P.Long.fromString(S)}return S.low||S.high?new LongBits(S.low>>>0,S.high>>>0):O},LongBits.prototype.toNumber=function(S){if(!S&&this.hi>>>31){var T=~this.lo+1>>>0,R=~this.hi>>>0;return T||(R=R+1>>>0),-(T+4294967296*R)}return this.lo+4294967296*this.hi},LongBits.prototype.toLong=function(S){return P.Long?new P.Long(0|this.lo,0|this.hi,!!S):{low:0|this.lo,high:0|this.hi,unsigned:!!S}};var M=String.prototype.charCodeAt;LongBits.fromHash=function(S){return S===N?O:new LongBits((M.call(S,0)|M.call(S,1)<<8|M.call(S,2)<<16|M.call(S,3)<<24)>>>0,(M.call(S,4)|M.call(S,5)<<8|M.call(S,6)<<16|M.call(S,7)<<24)>>>0)},LongBits.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},LongBits.prototype.zzEncode=function(){var S=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^S)>>>0,this.lo=(this.lo<<1^S)>>>0,this},LongBits.prototype.zzDecode=function(){var S=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^S)>>>0,this.hi=(this.hi>>>1^S)>>>0,this},LongBits.prototype.length=function(){var S=this.lo,T=(this.lo>>>28|this.hi<<4)>>>0,R=this.hi>>>24;return 0===R?0===T?S<16384?S<128?1:2:S<2097152?3:4:T<16384?T<128?5:6:T<2097152?7:8:R<128?9:10}},18932:function(S,T,R){"use strict";var P=T;function merge(S,T,R){for(var P=Object.keys(T),O=0;O<P.length;++O)void 0!==S[P[O]]&&R||(S[P[O]]=T[P[O]]);return S}function newError(S){function CustomError(S,T){if(!(this instanceof CustomError))return new CustomError(S,T);Object.defineProperty(this,"message",{get:function(){return S}}),Error.captureStackTrace?Error.captureStackTrace(this,CustomError):Object.defineProperty(this,"stack",{value:Error().stack||""}),T&&merge(this,T)}return CustomError.prototype=Object.create(Error.prototype,{constructor:{value:CustomError,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return S},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),CustomError}P.asPromise=R(18670),P.base64=R(36009),P.EventEmitter=R(50107),P.float=R(71188),P.inquire=R(28031),P.utf8=R(67148),P.pool=R(14314),P.LongBits=R(41168),P.isNode=!!("undefined"!=typeof global&&global&&global.process&&global.process.versions&&global.process.versions.node),P.global=P.isNode&&global||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,P.emptyArray=Object.freeze?Object.freeze([]):[],P.emptyObject=Object.freeze?Object.freeze({}):{},P.isInteger=Number.isInteger||function(S){return"number"==typeof S&&isFinite(S)&&Math.floor(S)===S},P.isString=function(S){return"string"==typeof S||S instanceof String},P.isObject=function(S){return S&&"object"==typeof S},P.isset=P.isSet=function(S,T){var R=S[T];return!!(null!=R&&S.hasOwnProperty(T))&&("object"!=typeof R||(Array.isArray(R)?R.length:Object.keys(R).length)>0)},P.Buffer=function(){try{var S=P.inquire("buffer").Buffer;return S.prototype.utf8Write?S:null}catch(S){return null}}(),P._Buffer_from=null,P._Buffer_allocUnsafe=null,P.newBuffer=function(S){return"number"==typeof S?P.Buffer?P._Buffer_allocUnsafe(S):new P.Array(S):P.Buffer?P._Buffer_from(S):"undefined"==typeof Uint8Array?S:new Uint8Array(S)},P.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,P.Long=P.global.dcodeIO&&P.global.dcodeIO.Long||P.global.Long||P.inquire("long"),P.key2Re=/^true|false|0|1$/,P.key32Re=/^-?(?:0|[1-9][0-9]*)$/,P.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,P.longToHash=function(S){return S?P.LongBits.from(S).toHash():P.LongBits.zeroHash},P.longFromHash=function(S,T){var R=P.LongBits.fromHash(S);return P.Long?P.Long.fromBits(R.lo,R.hi,T):R.toNumber(!!T)},P.merge=merge,P.lcFirst=function(S){return S.charAt(0).toLowerCase()+S.substring(1)},P.newError=newError,P.ProtocolError=newError("ProtocolError"),P.oneOfGetter=function(S){for(var T={},R=0;R<S.length;++R)T[S[R]]=1;return function(){for(var S=Object.keys(this),R=S.length-1;R>-1;--R)if(1===T[S[R]]&&void 0!==this[S[R]]&&null!==this[S[R]])return S[R]}},P.oneOfSetter=function(S){return function(T){for(var R=0;R<S.length;++R)S[R]!==T&&delete this[S[R]]}},P.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},P._configure=function(){var S=P.Buffer;if(!S){P._Buffer_from=P._Buffer_allocUnsafe=null;return}P._Buffer_from=S.from!==Uint8Array.from&&S.from||function(T,R){return new S(T,R)},P._Buffer_allocUnsafe=S.allocUnsafe||function(T){return new S(T)}}},17585:(S,T,R)=>{"use strict";S.exports=verifier;var P=R(59246),O=R(66738);function invalid(S,T){return S.name+": "+T+(S.repeated&&"array"!==T?"[]":S.map&&"object"!==T?"{k:"+S.keyType+"}":"")+" expected"}function genVerifyValue(S,T,R,O){if(T.resolvedType){if(T.resolvedType instanceof P){S("switch(%s){",O)("default:")("return%j",invalid(T,"enum value"));for(var N=Object.keys(T.resolvedType.values),M=0;M<N.length;++M)S("case %i:",T.resolvedType.values[N[M]]);S("break")("}")}else S("{")("var e=types[%i].verify(%s);",R,O)("if(e)")("return%j+e",T.name+".")("}")}else switch(T.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":S("if(!util.isInteger(%s))",O)("return%j",invalid(T,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":S("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",O,O,O,O)("return%j",invalid(T,"integer|Long"));break;case"float":case"double":S('if(typeof %s!=="number")',O)("return%j",invalid(T,"number"));break;case"bool":S('if(typeof %s!=="boolean")',O)("return%j",invalid(T,"boolean"));break;case"string":S("if(!util.isString(%s))",O)("return%j",invalid(T,"string"));break;case"bytes":S('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',O,O,O)("return%j",invalid(T,"buffer"))}return S}function genVerifyKey(S,T,R){switch(T.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":S("if(!util.key32Re.test(%s))",R)("return%j",invalid(T,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":S("if(!util.key64Re.test(%s))",R)("return%j",invalid(T,"integer|Long key"));break;case"bool":S("if(!util.key2Re.test(%s))",R)("return%j",invalid(T,"boolean key"))}return S}function verifier(S){var T=O.codegen(["m"],S.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),R=S.oneofsArray,P={};R.length&&T("var p={}");for(var N=0;N<S.fieldsArray.length;++N){var M=S._fieldsArray[N].resolve(),L="m"+O.safeProp(M.name);if(M.optional&&T("if(%s!=null&&m.hasOwnProperty(%j)){",L,M.name),M.map)T("if(!util.isObject(%s))",L)("return%j",invalid(M,"object"))("var k=Object.keys(%s)",L)("for(var i=0;i<k.length;++i){"),genVerifyKey(T,M,"k[i]"),genVerifyValue(T,M,N,L+"[k[i]]")("}");else if(M.repeated)T("if(!Array.isArray(%s))",L)("return%j",invalid(M,"array"))("for(var i=0;i<%s.length;++i){",L),genVerifyValue(T,M,N,L+"[i]")("}");else{if(M.partOf){var V=O.safeProp(M.partOf.name);1===P[M.partOf.name]&&T("if(p%s===1)",V)("return%j",M.partOf.name+": multiple values"),P[M.partOf.name]=1,T("p%s=1",V)}genVerifyValue(T,M,N,L)}M.optional&&T("}")}return T("return null")}},34038:(S,T,R)=>{"use strict";var P=T,O=R(34294);P[".google.protobuf.Any"]={fromObject:function(S){if(S&&S["@type"]){var T=S["@type"].substring(S["@type"].lastIndexOf("/")+1),R=this.lookup(T);if(R){var P="."===S["@type"].charAt(0)?S["@type"].slice(1):S["@type"];return -1===P.indexOf("/")&&(P="/"+P),this.create({type_url:P,value:R.encode(R.fromObject(S)).finish()})}}return this.fromObject(S)},toObject:function(S,T){var R="type.googleapis.com/",P="",N="";if(T&&T.json&&S.type_url&&S.value){N=S.type_url.substring(S.type_url.lastIndexOf("/")+1),P=S.type_url.substring(0,S.type_url.lastIndexOf("/")+1);var M=this.lookup(N);M&&(S=M.decode(S.value))}if(!(S instanceof this.ctor)&&S instanceof O){var L=S.$type.toObject(S,T),V="."===S.$type.fullName[0]?S.$type.fullName.slice(1):S.$type.fullName;return""===P&&(P=R),N=P+V,L["@type"]=N,L}return this.toObject(S,T)}}},84353:(S,T,R)=>{"use strict";S.exports=Writer;var P,O=R(18932),N=O.LongBits,M=O.base64,L=O.utf8;function Op(S,T,R){this.fn=S,this.len=T,this.next=void 0,this.val=R}function noop(){}function State(S){this.head=S.head,this.tail=S.tail,this.len=S.len,this.next=S.states}function Writer(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create=function(){return O.Buffer?function(){return(Writer.create=function(){return new P})()}:function(){return new Writer}};function writeByte(S,T,R){T[R]=255&S}function writeVarint32(S,T,R){for(;S>127;)T[R++]=127&S|128,S>>>=7;T[R]=S}function VarintOp(S,T){this.len=S,this.next=void 0,this.val=T}function writeVarint64(S,T,R){for(;S.hi;)T[R++]=127&S.lo|128,S.lo=(S.lo>>>7|S.hi<<25)>>>0,S.hi>>>=7;for(;S.lo>127;)T[R++]=127&S.lo|128,S.lo=S.lo>>>7;T[R++]=S.lo}function writeFixed32(S,T,R){T[R]=255&S,T[R+1]=S>>>8&255,T[R+2]=S>>>16&255,T[R+3]=S>>>24}Writer.create=create(),Writer.alloc=function(S){return new O.Array(S)},O.Array!==Array&&(Writer.alloc=O.pool(Writer.alloc,O.Array.prototype.subarray)),Writer.prototype._push=function(S,T,R){return this.tail=this.tail.next=new Op(S,T,R),this.len+=T,this},VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=writeVarint32,Writer.prototype.uint32=function(S){return this.len+=(this.tail=this.tail.next=new VarintOp((S>>>=0)<128?1:S<16384?2:S<2097152?3:S<268435456?4:5,S)).len,this},Writer.prototype.int32=function(S){return S<0?this._push(writeVarint64,10,N.fromNumber(S)):this.uint32(S)},Writer.prototype.sint32=function(S){return this.uint32((S<<1^S>>31)>>>0)},Writer.prototype.uint64=function(S){var T=N.from(S);return this._push(writeVarint64,T.length(),T)},Writer.prototype.int64=Writer.prototype.uint64,Writer.prototype.sint64=function(S){var T=N.from(S).zzEncode();return this._push(writeVarint64,T.length(),T)},Writer.prototype.bool=function(S){return this._push(writeByte,1,S?1:0)},Writer.prototype.fixed32=function(S){return this._push(writeFixed32,4,S>>>0)},Writer.prototype.sfixed32=Writer.prototype.fixed32,Writer.prototype.fixed64=function(S){var T=N.from(S);return this._push(writeFixed32,4,T.lo)._push(writeFixed32,4,T.hi)},Writer.prototype.sfixed64=Writer.prototype.fixed64,Writer.prototype.float=function(S){return this._push(O.float.writeFloatLE,4,S)},Writer.prototype.double=function(S){return this._push(O.float.writeDoubleLE,8,S)};var V=O.Array.prototype.set?function(S,T,R){T.set(S,R)}:function(S,T,R){for(var P=0;P<S.length;++P)T[R+P]=S[P]};Writer.prototype.bytes=function(S){var T=S.length>>>0;if(!T)return this._push(writeByte,1,0);if(O.isString(S)){var R=Writer.alloc(T=M.length(S));M.decode(S,R,0),S=R}return this.uint32(T)._push(V,T,S)},Writer.prototype.string=function(S){var T=L.length(S);return T?this.uint32(T)._push(L.write,T,S):this._push(writeByte,1,0)},Writer.prototype.fork=function(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this},Writer.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this},Writer.prototype.ldelim=function(){var S=this.head,T=this.tail,R=this.len;return this.reset().uint32(R),R&&(this.tail.next=S.next,this.tail=T,this.len+=R),this},Writer.prototype.finish=function(){for(var S=this.head.next,T=this.constructor.alloc(this.len),R=0;S;)S.fn(S.val,T,R),R+=S.len,S=S.next;return T},Writer._configure=function(S){P=S,Writer.create=create(),P._configure()}},81978:(S,T,R)=>{"use strict";S.exports=BufferWriter;var P=R(84353);(BufferWriter.prototype=Object.create(P.prototype)).constructor=BufferWriter;var O=R(18932);function BufferWriter(){P.call(this)}function writeStringBuffer(S,T,R){S.length<40?O.utf8.write(S,T,R):T.utf8Write?T.utf8Write(S,R):T.write(S,R)}BufferWriter._configure=function(){BufferWriter.alloc=O._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=O.Buffer&&O.Buffer.prototype instanceof Uint8Array&&"set"===O.Buffer.prototype.set.name?function(S,T,R){T.set(S,R)}:function(S,T,R){if(S.copy)S.copy(T,R,0,S.length);else for(var P=0;P<S.length;)T[R++]=S[P++]}},BufferWriter.prototype.bytes=function(S){O.isString(S)&&(S=O._Buffer_from(S,"base64"));var T=S.length>>>0;return this.uint32(T),T&&this._push(BufferWriter.writeBytesBuffer,T,S),this},BufferWriter.prototype.string=function(S){var T=O.Buffer.byteLength(S);return this.uint32(T),T&&this._push(writeStringBuffer,T,S),this},BufferWriter._configure()},16933:function(S,T){var R;!function(P,O){function preferDefault(S){return S.default||S}void 0!==(R=(function(){var S={};return O(S),preferDefault(S)}).apply(T,[]))&&(S.exports=R)}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,function(S){"use strict";Object.defineProperty(S,"__esModule",{value:!0}),S.default=void 0;/**
     * @license
     * Copyright 2009 The Closure Library Authors
     * Copyright 2020 Daniel Wirtz / The long.js Authors.
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *     http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     *
     * SPDX-License-Identifier: Apache-2.0
     */var T=null;try{T=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch{}function Long(S,T,R){this.low=0|S,this.high=0|T,this.unsigned=!!R}function isLong(S){return!0===(S&&S.__isLong__)}function ctz32(S){var T=Math.clz32(S&-S);return S?31-T:T}Long.prototype.__isLong__,Object.defineProperty(Long.prototype,"__isLong__",{value:!0}),Long.isLong=isLong;var R={},P={};function fromInt(S,T){var O,N,M;return T?(S>>>=0,(M=0<=S&&S<256)&&(N=P[S]))?N:(O=fromBits(S,0,!0),M&&(P[S]=O),O):(S|=0,(M=-128<=S&&S<128)&&(N=R[S]))?N:(O=fromBits(S,S<0?-1:0,!1),M&&(R[S]=O),O)}function fromNumber(S,T){if(isNaN(S))return T?W:U;if(T){if(S<0)return W;if(S>=M)return X}else{if(S<=-L)return Z;if(S+1>=L)return Y}return S<0?fromNumber(-S,T).neg():fromBits(S%N|0,S/N|0,T)}function fromBits(S,T,R){return new Long(S,T,R)}Long.fromInt=fromInt,Long.fromNumber=fromNumber,Long.fromBits=fromBits;var O=Math.pow;function fromString(S,T,R){if(0===S.length)throw Error("empty string");if("number"==typeof T?(R=T,T=!1):T=!!T,"NaN"===S||"Infinity"===S||"+Infinity"===S||"-Infinity"===S)return T?W:U;if((R=R||10)<2||36<R)throw RangeError("radix");if((P=S.indexOf("-"))>0)throw Error("interior hyphen");if(0===P)return fromString(S.substring(1),T,R).neg();for(var P,N=fromNumber(O(R,8)),M=U,L=0;L<S.length;L+=8){var V=Math.min(8,S.length-L),K=parseInt(S.substring(L,L+V),R);if(V<8){var Q=fromNumber(O(R,V));M=M.mul(Q).add(fromNumber(K))}else M=(M=M.mul(N)).add(fromNumber(K))}return M.unsigned=T,M}function fromValue(S,T){return"number"==typeof S?fromNumber(S,T):"string"==typeof S?fromString(S,T):fromBits(S.low,S.high,"boolean"==typeof T?T:S.unsigned)}Long.fromString=fromString,Long.fromValue=fromValue;var N=4294967296,M=18446744073709552e3,L=0x7fffffffffffffff,V=fromInt(16777216),U=fromInt(0);Long.ZERO=U;var W=fromInt(0,!0);Long.UZERO=W;var K=fromInt(1);Long.ONE=K;var Q=fromInt(1,!0);Long.UONE=Q;var $=fromInt(-1);Long.NEG_ONE=$;var Y=fromBits(-1,2147483647,!1);Long.MAX_VALUE=Y;var X=fromBits(-1,-1,!0);Long.MAX_UNSIGNED_VALUE=X;var Z=fromBits(0,-2147483648,!1);Long.MIN_VALUE=Z;var ee=Long.prototype;ee.toInt=function(){return this.unsigned?this.low>>>0:this.low},ee.toNumber=function(){return this.unsigned?(this.high>>>0)*N+(this.low>>>0):this.high*N+(this.low>>>0)},ee.toString=function(S){if((S=S||10)<2||36<S)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(!this.eq(Z))return"-"+this.neg().toString(S);var T=fromNumber(S),R=this.div(T),P=R.mul(T).sub(this);return R.toString(S)+P.toInt().toString(S)}for(var N=fromNumber(O(S,6),this.unsigned),M=this,L="";;){var V=M.div(N),U=(M.sub(V.mul(N)).toInt()>>>0).toString(S);if((M=V).isZero())return U+L;for(;U.length<6;)U="0"+U;L=""+U+L}},ee.getHighBits=function(){return this.high},ee.getHighBitsUnsigned=function(){return this.high>>>0},ee.getLowBits=function(){return this.low},ee.getLowBitsUnsigned=function(){return this.low>>>0},ee.getNumBitsAbs=function(){if(this.isNegative())return this.eq(Z)?64:this.neg().getNumBitsAbs();for(var S=0!=this.high?this.high:this.low,T=31;T>0&&(S&1<<T)==0;T--);return 0!=this.high?T+33:T+1},ee.isSafeInteger=function(){var S=this.high>>21;return!S||!this.unsigned&&-1===S&&!(0===this.low&&-2097152===this.high)},ee.isZero=function(){return 0===this.high&&0===this.low},ee.eqz=ee.isZero,ee.isNegative=function(){return!this.unsigned&&this.high<0},ee.isPositive=function(){return this.unsigned||this.high>=0},ee.isOdd=function(){return(1&this.low)==1},ee.isEven=function(){return(1&this.low)==0},ee.equals=function(S){return isLong(S)||(S=fromValue(S)),(this.unsigned===S.unsigned||this.high>>>31!=1||S.high>>>31!=1)&&this.high===S.high&&this.low===S.low},ee.eq=ee.equals,ee.notEquals=function(S){return!this.eq(S)},ee.neq=ee.notEquals,ee.ne=ee.notEquals,ee.lessThan=function(S){return 0>this.comp(S)},ee.lt=ee.lessThan,ee.lessThanOrEqual=function(S){return 0>=this.comp(S)},ee.lte=ee.lessThanOrEqual,ee.le=ee.lessThanOrEqual,ee.greaterThan=function(S){return this.comp(S)>0},ee.gt=ee.greaterThan,ee.greaterThanOrEqual=function(S){return this.comp(S)>=0},ee.gte=ee.greaterThanOrEqual,ee.ge=ee.greaterThanOrEqual,ee.compare=function(S){if(isLong(S)||(S=fromValue(S)),this.eq(S))return 0;var T=this.isNegative(),R=S.isNegative();return T&&!R?-1:!T&&R?1:this.unsigned?S.high>>>0>this.high>>>0||S.high===this.high&&S.low>>>0>this.low>>>0?-1:1:this.sub(S).isNegative()?-1:1},ee.comp=ee.compare,ee.negate=function(){return!this.unsigned&&this.eq(Z)?Z:this.not().add(K)},ee.neg=ee.negate,ee.add=function(S){isLong(S)||(S=fromValue(S));var T,R,P=this.high>>>16,O=65535&this.high,N=this.low>>>16,M=65535&this.low,L=S.high>>>16,V=65535&S.high,U=S.low>>>16,W=65535&S.low,K=0,Q=0;return T=0+((R=0+(M+W))>>>16),R&=65535,T+=N+U,Q+=T>>>16,T&=65535,Q+=O+V,K+=Q>>>16,Q&=65535,K+=P+L,fromBits(T<<16|R,(K&=65535)<<16|Q,this.unsigned)},ee.subtract=function(S){return isLong(S)||(S=fromValue(S)),this.add(S.neg())},ee.sub=ee.subtract,ee.multiply=function(S){if(this.isZero())return this;if(isLong(S)||(S=fromValue(S)),T)return fromBits(T.mul(this.low,this.high,S.low,S.high),T.get_high(),this.unsigned);if(S.isZero())return this.unsigned?W:U;if(this.eq(Z))return S.isOdd()?Z:U;if(S.eq(Z))return this.isOdd()?Z:U;if(this.isNegative())return S.isNegative()?this.neg().mul(S.neg()):this.neg().mul(S).neg();if(S.isNegative())return this.mul(S.neg()).neg();if(this.lt(V)&&S.lt(V))return fromNumber(this.toNumber()*S.toNumber(),this.unsigned);var R,P,O=this.high>>>16,N=65535&this.high,M=this.low>>>16,L=65535&this.low,K=S.high>>>16,Q=65535&S.high,$=S.low>>>16,Y=65535&S.low,X=0,ee=0;return R=0+((P=0+L*Y)>>>16),P&=65535,R+=M*Y,ee+=R>>>16,R&=65535,R+=L*$,ee+=R>>>16,R&=65535,ee+=N*Y,X+=ee>>>16,ee&=65535,ee+=M*$,X+=ee>>>16,ee&=65535,ee+=L*Q,X+=ee>>>16,ee&=65535,X+=O*Y+N*$+M*Q+L*K,fromBits(R<<16|P,(X&=65535)<<16|ee,this.unsigned)},ee.mul=ee.multiply,ee.divide=function(S){if(isLong(S)||(S=fromValue(S)),S.isZero())throw Error("division by zero");if(T){var R,P,N;return this.unsigned||-2147483648!==this.high||-1!==S.low||-1!==S.high?fromBits((this.unsigned?T.div_u:T.div_s)(this.low,this.high,S.low,S.high),T.get_high(),this.unsigned):this}if(this.isZero())return this.unsigned?W:U;if(this.unsigned){if(S.unsigned||(S=S.toUnsigned()),S.gt(this))return W;if(S.gt(this.shru(1)))return Q;N=W}else{if(this.eq(Z))return S.eq(K)||S.eq($)?Z:S.eq(Z)?K:(R=this.shr(1).div(S).shl(1)).eq(U)?S.isNegative()?K:$:(P=this.sub(S.mul(R)),N=R.add(P.div(S)));if(S.eq(Z))return this.unsigned?W:U;if(this.isNegative())return S.isNegative()?this.neg().div(S.neg()):this.neg().div(S).neg();if(S.isNegative())return this.div(S.neg()).neg();N=U}for(P=this;P.gte(S);){for(var M=Math.ceil(Math.log(R=Math.max(1,Math.floor(P.toNumber()/S.toNumber())))/Math.LN2),L=M<=48?1:O(2,M-48),V=fromNumber(R),Y=V.mul(S);Y.isNegative()||Y.gt(P);)R-=L,Y=(V=fromNumber(R,this.unsigned)).mul(S);V.isZero()&&(V=K),N=N.add(V),P=P.sub(Y)}return N},ee.div=ee.divide,ee.modulo=function(S){return(isLong(S)||(S=fromValue(S)),T)?fromBits((this.unsigned?T.rem_u:T.rem_s)(this.low,this.high,S.low,S.high),T.get_high(),this.unsigned):this.sub(this.div(S).mul(S))},ee.mod=ee.modulo,ee.rem=ee.modulo,ee.not=function(){return fromBits(~this.low,~this.high,this.unsigned)},ee.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},ee.clz=ee.countLeadingZeros,ee.countTrailingZeros=function(){return this.low?ctz32(this.low):ctz32(this.high)+32},ee.ctz=ee.countTrailingZeros,ee.and=function(S){return isLong(S)||(S=fromValue(S)),fromBits(this.low&S.low,this.high&S.high,this.unsigned)},ee.or=function(S){return isLong(S)||(S=fromValue(S)),fromBits(this.low|S.low,this.high|S.high,this.unsigned)},ee.xor=function(S){return isLong(S)||(S=fromValue(S)),fromBits(this.low^S.low,this.high^S.high,this.unsigned)},ee.shiftLeft=function(S){return(isLong(S)&&(S=S.toInt()),0==(S&=63))?this:S<32?fromBits(this.low<<S,this.high<<S|this.low>>>32-S,this.unsigned):fromBits(0,this.low<<S-32,this.unsigned)},ee.shl=ee.shiftLeft,ee.shiftRight=function(S){return(isLong(S)&&(S=S.toInt()),0==(S&=63))?this:S<32?fromBits(this.low>>>S|this.high<<32-S,this.high>>S,this.unsigned):fromBits(this.high>>S-32,this.high>=0?0:-1,this.unsigned)},ee.shr=ee.shiftRight,ee.shiftRightUnsigned=function(S){return(isLong(S)&&(S=S.toInt()),0==(S&=63))?this:S<32?fromBits(this.low>>>S|this.high<<32-S,this.high>>>S,this.unsigned):32===S?fromBits(this.high,0,this.unsigned):fromBits(this.high>>>S-32,0,this.unsigned)},ee.shru=ee.shiftRightUnsigned,ee.shr_u=ee.shiftRightUnsigned,ee.rotateLeft=function(S){var T;return(isLong(S)&&(S=S.toInt()),0==(S&=63))?this:32===S?fromBits(this.high,this.low,this.unsigned):S<32?(T=32-S,fromBits(this.low<<S|this.high>>>T,this.high<<S|this.low>>>T,this.unsigned)):(S-=32,T=32-S,fromBits(this.high<<S|this.low>>>T,this.low<<S|this.high>>>T,this.unsigned))},ee.rotl=ee.rotateLeft,ee.rotateRight=function(S){var T;return(isLong(S)&&(S=S.toInt()),0==(S&=63))?this:32===S?fromBits(this.high,this.low,this.unsigned):S<32?(T=32-S,fromBits(this.high<<T|this.low>>>S,this.low<<T|this.high>>>S,this.unsigned)):(S-=32,T=32-S,fromBits(this.low<<T|this.high>>>S,this.high<<T|this.low>>>S,this.unsigned))},ee.rotr=ee.rotateRight,ee.toSigned=function(){return this.unsigned?fromBits(this.low,this.high,!1):this},ee.toUnsigned=function(){return this.unsigned?this:fromBits(this.low,this.high,!0)},ee.toBytes=function(S){return S?this.toBytesLE():this.toBytesBE()},ee.toBytesLE=function(){var S=this.high,T=this.low;return[255&T,T>>>8&255,T>>>16&255,T>>>24,255&S,S>>>8&255,S>>>16&255,S>>>24]},ee.toBytesBE=function(){var S=this.high,T=this.low;return[S>>>24,S>>>16&255,S>>>8&255,255&S,T>>>24,T>>>16&255,T>>>8&255,255&T]},Long.fromBytes=function(S,T,R){return R?Long.fromBytesLE(S,T):Long.fromBytesBE(S,T)},Long.fromBytesLE=function(S,T){return new Long(S[0]|S[1]<<8|S[2]<<16|S[3]<<24,S[4]|S[5]<<8|S[6]<<16|S[7]<<24,T)},Long.fromBytesBE=function(S,T){return new Long(S[4]<<24|S[5]<<16|S[6]<<8|S[7],S[0]<<24|S[1]<<16|S[2]<<8|S[3],T)},"function"==typeof BigInt&&(Long.fromBigInt=function(S,T){return fromBits(Number(BigInt.asIntN(32,S)),Number(BigInt.asIntN(32,S>>BigInt(32))),T)},Long.fromValue=function(S,T){return"bigint"==typeof S?Long.fromBigInt(S,T):fromValue(S,T)},ee.toBigInt=function(){var S=BigInt(this.low>>>0);return BigInt(this.unsigned?this.high>>>0:this.high)<<BigInt(32)|S}),S.default=Long})},55087:(S,T,R)=>{"use strict";let P,O;R.d(T,{Jn:()=>eB,qX:()=>_getProvider,Xd:()=>_registerComponent,Mq:()=>getApp,C6:()=>getApps,ZF:()=>initializeApp,KN:()=>registerVersion});var N=R(77345),M=R(9292),L=R(51780);let instanceOfAny=(S,T)=>T.some(T=>S instanceof T);function getIdbProxyableTypes(){return P||(P=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return O||(O=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}let V=new WeakMap,U=new WeakMap,W=new WeakMap,K=new WeakMap,Q=new WeakMap;function promisifyRequest(S){let T=new Promise((T,R)=>{let unlisten=()=>{S.removeEventListener("success",success),S.removeEventListener("error",error)},success=()=>{T(wrap_idb_value_wrap(S.result)),unlisten()},error=()=>{R(S.error),unlisten()};S.addEventListener("success",success),S.addEventListener("error",error)});return T.then(T=>{T instanceof IDBCursor&&V.set(T,S)}).catch(()=>{}),Q.set(T,S),T}function cacheDonePromiseForTransaction(S){if(U.has(S))return;let T=new Promise((T,R)=>{let unlisten=()=>{S.removeEventListener("complete",complete),S.removeEventListener("error",error),S.removeEventListener("abort",error)},complete=()=>{T(),unlisten()},error=()=>{R(S.error||new DOMException("AbortError","AbortError")),unlisten()};S.addEventListener("complete",complete),S.addEventListener("error",error),S.addEventListener("abort",error)});U.set(S,T)}let $={get(S,T,R){if(S instanceof IDBTransaction){if("done"===T)return U.get(S);if("objectStoreNames"===T)return S.objectStoreNames||W.get(S);if("store"===T)return R.objectStoreNames[1]?void 0:R.objectStore(R.objectStoreNames[0])}return wrap_idb_value_wrap(S[T])},set:(S,T,R)=>(S[T]=R,!0),has:(S,T)=>S instanceof IDBTransaction&&("done"===T||"store"===T)||T in S};function replaceTraps(S){$=S($)}function wrapFunction(S){return S!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(S)?function(...T){return S.apply(unwrap(this),T),wrap_idb_value_wrap(V.get(this))}:function(...T){return wrap_idb_value_wrap(S.apply(unwrap(this),T))}:function(T,...R){let P=S.call(unwrap(this),T,...R);return W.set(P,T.sort?T.sort():[T]),wrap_idb_value_wrap(P)}}function transformCachableValue(S){return"function"==typeof S?wrapFunction(S):(S instanceof IDBTransaction&&cacheDonePromiseForTransaction(S),instanceOfAny(S,getIdbProxyableTypes()))?new Proxy(S,$):S}function wrap_idb_value_wrap(S){if(S instanceof IDBRequest)return promisifyRequest(S);if(K.has(S))return K.get(S);let T=transformCachableValue(S);return T!==S&&(K.set(S,T),Q.set(T,S)),T}let unwrap=S=>Q.get(S);function openDB(S,T,{blocked:R,upgrade:P,blocking:O,terminated:N}={}){let M=indexedDB.open(S,T),L=wrap_idb_value_wrap(M);return P&&M.addEventListener("upgradeneeded",S=>{P(wrap_idb_value_wrap(M.result),S.oldVersion,S.newVersion,wrap_idb_value_wrap(M.transaction),S)}),R&&M.addEventListener("blocked",S=>R(S.oldVersion,S.newVersion,S)),L.then(S=>{N&&S.addEventListener("close",()=>N()),O&&S.addEventListener("versionchange",S=>O(S.oldVersion,S.newVersion,S))}).catch(()=>{}),L}let Y=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],Z=new Map;function getMethod(S,T){if(!(S instanceof IDBDatabase&&!(T in S)&&"string"==typeof T))return;if(Z.get(T))return Z.get(T);let R=T.replace(/FromIndex$/,""),P=T!==R,O=X.includes(R);if(!(R in(P?IDBIndex:IDBObjectStore).prototype)||!(O||Y.includes(R)))return;let method=async function(S,...T){let N=this.transaction(S,O?"readwrite":"readonly"),M=N.store;return P&&(M=M.index(T.shift())),(await Promise.all([M[R](...T),O&&N.done]))[0]};return Z.set(T,method),method}replaceTraps(S=>({...S,get:(T,R,P)=>getMethod(T,R)||S.get(T,R,P),has:(T,R)=>!!getMethod(T,R)||S.has(T,R)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let PlatformLoggerServiceImpl=class PlatformLoggerServiceImpl{constructor(S){this.container=S}getPlatformInfoString(){let S=this.container.getProviders();return S.map(S=>{if(!isVersionServiceProvider(S))return null;{let T=S.getImmediate();return`${T.library}/${T.version}`}}).filter(S=>S).join(" ")}};function isVersionServiceProvider(S){let T=S.getComponent();return(null==T?void 0:T.type)==="VERSION"}let ee="@firebase/app",et="0.10.13",er=new M.Yd("@firebase/app"),en="@firebase/app-compat",ei="@firebase/analytics-compat",es="@firebase/analytics",ea="@firebase/app-check-compat",eo="@firebase/app-check",eu="@firebase/auth",ec="@firebase/auth-compat",ed="@firebase/database",eh="@firebase/data-connect",ep="@firebase/database-compat",ef="@firebase/functions",em="@firebase/functions-compat",eg="@firebase/installations",ey="@firebase/installations-compat",ev="@firebase/messaging",eS="@firebase/messaging-compat",eb="@firebase/performance",eC="@firebase/performance-compat",eT="@firebase/remote-config",eE="@firebase/remote-config-compat",ew="@firebase/storage",eD="@firebase/storage-compat",eI="@firebase/firestore",eR="@firebase/vertexai-preview",e_="@firebase/firestore-compat",eP="firebase",eA="10.14.1",eO="[DEFAULT]",eN={[ee]:"fire-core",[en]:"fire-core-compat",[es]:"fire-analytics",[ei]:"fire-analytics-compat",[eo]:"fire-app-check",[ea]:"fire-app-check-compat",[eu]:"fire-auth",[ec]:"fire-auth-compat",[ed]:"fire-rtdb",[eh]:"fire-data-connect",[ep]:"fire-rtdb-compat",[ef]:"fire-fn",[em]:"fire-fn-compat",[eg]:"fire-iid",[ey]:"fire-iid-compat",[ev]:"fire-fcm",[eS]:"fire-fcm-compat",[eb]:"fire-perf",[eC]:"fire-perf-compat",[eT]:"fire-rc",[eE]:"fire-rc-compat",[ew]:"fire-gcs",[eD]:"fire-gcs-compat",[eI]:"fire-fst",[e_]:"fire-fst-compat",[eR]:"fire-vertex","fire-js":"fire-js",[eP]:"fire-js-all"},ek=new Map,ex=new Map,eM=new Map;function _addComponent(S,T){try{S.container.addComponent(T)}catch(R){er.debug(`Component ${T.name} failed to register with FirebaseApp ${S.name}`,R)}}function _registerComponent(S){let T=S.name;if(eM.has(T))return er.debug(`There were multiple attempts to register component ${T}.`),!1;for(let R of(eM.set(T,S),ek.values()))_addComponent(R,S);for(let T of ex.values())_addComponent(T,S);return!0}function _getProvider(S,T){let R=S.container.getProvider("heartbeat").getImmediate({optional:!0});return R&&R.triggerHeartbeat(),S.container.getProvider(T)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eF={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},eL=new L.LL("app","Firebase",eF);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let FirebaseAppImpl=class FirebaseAppImpl{constructor(S,T,R){this._isDeleted=!1,this._options=Object.assign({},S),this._config=Object.assign({},T),this._name=T.name,this._automaticDataCollectionEnabled=T.automaticDataCollectionEnabled,this._container=R,this.container.addComponent(new N.wA("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(S){this.checkDestroyed(),this._automaticDataCollectionEnabled=S}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(S){this._isDeleted=S}checkDestroyed(){if(this.isDeleted)throw eL.create("app-deleted",{appName:this._name})}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eB=eA;function initializeApp(S,T={}){let R=S;if("object"!=typeof T){let S=T;T={name:S}}let P=Object.assign({name:eO,automaticDataCollectionEnabled:!1},T),O=P.name;if("string"!=typeof O||!O)throw eL.create("bad-app-name",{appName:String(O)});if(R||(R=(0,L.aH)()),!R)throw eL.create("no-options");let M=ek.get(O);if(M){if((0,L.vZ)(R,M.options)&&(0,L.vZ)(P,M.config))return M;throw eL.create("duplicate-app",{appName:O})}let V=new N.H0(O);for(let S of eM.values())V.addComponent(S);let U=new FirebaseAppImpl(R,P,V);return ek.set(O,U),U}function getApp(S=eO){let T=ek.get(S);if(!T&&S===eO&&(0,L.aH)())return initializeApp();if(!T)throw eL.create("no-app",{appName:S});return T}function getApps(){return Array.from(ek.values())}function registerVersion(S,T,R){var P;let O=null!==(P=eN[S])&&void 0!==P?P:S;R&&(O+=`-${R}`);let M=O.match(/\s|\//),L=T.match(/\s|\//);if(M||L){let S=[`Unable to register library "${O}" with version "${T}":`];M&&S.push(`library name "${O}" contains illegal characters (whitespace or "/")`),M&&L&&S.push("and"),L&&S.push(`version name "${T}" contains illegal characters (whitespace or "/")`),er.warn(S.join(" "));return}_registerComponent(new N.wA(`${O}-version`,()=>({library:O,version:T}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eV="firebase-heartbeat-database",eU=1,ej="firebase-heartbeat-store",eq=null;function getDbPromise(){return eq||(eq=openDB(eV,eU,{upgrade:(S,T)=>{if(0===T)try{S.createObjectStore(ej)}catch(S){console.warn(S)}}}).catch(S=>{throw eL.create("idb-open",{originalErrorMessage:S.message})})),eq}async function readHeartbeatsFromIndexedDB(S){try{let T=await getDbPromise(),R=T.transaction(ej),P=await R.objectStore(ej).get(computeKey(S));return await R.done,P}catch(S){if(S instanceof L.ZR)er.warn(S.message);else{let T=eL.create("idb-get",{originalErrorMessage:null==S?void 0:S.message});er.warn(T.message)}}}async function writeHeartbeatsToIndexedDB(S,T){try{let R=await getDbPromise(),P=R.transaction(ej,"readwrite"),O=P.objectStore(ej);await O.put(T,computeKey(S)),await P.done}catch(S){if(S instanceof L.ZR)er.warn(S.message);else{let T=eL.create("idb-set",{originalErrorMessage:null==S?void 0:S.message});er.warn(T.message)}}}function computeKey(S){return`${S.name}!${S.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ez=1024,eW=2592e6;let HeartbeatServiceImpl=class HeartbeatServiceImpl{constructor(S){this.container=S,this._heartbeatsCache=null;let T=this.container.getProvider("app").getImmediate();this._storage=new HeartbeatStorageImpl(T),this._heartbeatsCachePromise=this._storage.read().then(S=>(this._heartbeatsCache=S,S))}async triggerHeartbeat(){var S,T;try{let R=this.container.getProvider("platform-logger").getImmediate(),P=R.getPlatformInfoString(),O=getUTCDateString();if((null===(S=this._heartbeatsCache)||void 0===S?void 0:S.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,(null===(T=this._heartbeatsCache)||void 0===T?void 0:T.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===O||this._heartbeatsCache.heartbeats.some(S=>S.date===O))return;return this._heartbeatsCache.heartbeats.push({date:O,agent:P}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(S=>{let T=new Date(S.date).valueOf(),R=Date.now();return R-T<=eW}),this._storage.overwrite(this._heartbeatsCache)}catch(S){er.warn(S)}}async getHeartbeatsHeader(){var S;try{if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,(null===(S=this._heartbeatsCache)||void 0===S?void 0:S.heartbeats)==null||0===this._heartbeatsCache.heartbeats.length)return"";let T=getUTCDateString(),{heartbeatsToSend:R,unsentEntries:P}=extractHeartbeatsForHeader(this._heartbeatsCache.heartbeats),O=(0,L.L)(JSON.stringify({version:2,heartbeats:R}));return this._heartbeatsCache.lastSentHeartbeatDate=T,P.length>0?(this._heartbeatsCache.heartbeats=P,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),O}catch(S){return er.warn(S),""}}};function getUTCDateString(){let S=new Date;return S.toISOString().substring(0,10)}function extractHeartbeatsForHeader(S,T=ez){let R=[],P=S.slice();for(let O of S){let S=R.find(S=>S.agent===O.agent);if(S){if(S.dates.push(O.date),countBytes(R)>T){S.dates.pop();break}}else if(R.push({agent:O.agent,dates:[O.date]}),countBytes(R)>T){R.pop();break}P=P.slice(1)}return{heartbeatsToSend:R,unsentEntries:P}}let HeartbeatStorageImpl=class HeartbeatStorageImpl{constructor(S){this.app=S,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!(0,L.hl)()&&(0,L.eu)().then(()=>!0).catch(()=>!1)}async read(){let S=await this._canUseIndexedDBPromise;if(!S)return{heartbeats:[]};{let S=await readHeartbeatsFromIndexedDB(this.app);return(null==S?void 0:S.heartbeats)?S:{heartbeats:[]}}}async overwrite(S){var T;let R=await this._canUseIndexedDBPromise;if(R){let R=await this.read();return writeHeartbeatsToIndexedDB(this.app,{lastSentHeartbeatDate:null!==(T=S.lastSentHeartbeatDate)&&void 0!==T?T:R.lastSentHeartbeatDate,heartbeats:S.heartbeats})}}async add(S){var T;let R=await this._canUseIndexedDBPromise;if(R){let R=await this.read();return writeHeartbeatsToIndexedDB(this.app,{lastSentHeartbeatDate:null!==(T=S.lastSentHeartbeatDate)&&void 0!==T?T:R.lastSentHeartbeatDate,heartbeats:[...R.heartbeats,...S.heartbeats]})}}};function countBytes(S){return(0,L.L)(JSON.stringify({version:2,heartbeats:S})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(function(S){_registerComponent(new N.wA("platform-logger",S=>new PlatformLoggerServiceImpl(S),"PRIVATE")),_registerComponent(new N.wA("heartbeat",S=>new HeartbeatServiceImpl(S),"PRIVATE")),registerVersion(ee,et,""),registerVersion(ee,et,"esm2017"),registerVersion("fire-js","")})(0)},77345:(S,T,R)=>{"use strict";R.d(T,{H0:()=>ComponentContainer,wA:()=>Component});var P=R(51780);let Component=class Component{constructor(S,T,R){this.name=S,this.instanceFactory=T,this.type=R,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(S){return this.instantiationMode=S,this}setMultipleInstances(S){return this.multipleInstances=S,this}setServiceProps(S){return this.serviceProps=S,this}setInstanceCreatedCallback(S){return this.onInstanceCreated=S,this}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let O="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Provider=class Provider{constructor(S,T){this.name=S,this.container=T,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(S){let T=this.normalizeInstanceIdentifier(S);if(!this.instancesDeferred.has(T)){let S=new P.BH;if(this.instancesDeferred.set(T,S),this.isInitialized(T)||this.shouldAutoInitialize())try{let R=this.getOrInitializeService({instanceIdentifier:T});R&&S.resolve(R)}catch(S){}}return this.instancesDeferred.get(T).promise}getImmediate(S){var T;let R=this.normalizeInstanceIdentifier(null==S?void 0:S.identifier),P=null!==(T=null==S?void 0:S.optional)&&void 0!==T&&T;if(this.isInitialized(R)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:R})}catch(S){if(P)return null;throw S}else{if(P)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(S){if(S.name!==this.name)throw Error(`Mismatching Component ${S.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=S,this.shouldAutoInitialize()){if(isComponentEager(S))try{this.getOrInitializeService({instanceIdentifier:O})}catch(S){}for(let[S,T]of this.instancesDeferred.entries()){let R=this.normalizeInstanceIdentifier(S);try{let S=this.getOrInitializeService({instanceIdentifier:R});T.resolve(S)}catch(S){}}}}clearInstance(S=O){this.instancesDeferred.delete(S),this.instancesOptions.delete(S),this.instances.delete(S)}async delete(){let S=Array.from(this.instances.values());await Promise.all([...S.filter(S=>"INTERNAL"in S).map(S=>S.INTERNAL.delete()),...S.filter(S=>"_delete"in S).map(S=>S._delete())])}isComponentSet(){return null!=this.component}isInitialized(S=O){return this.instances.has(S)}getOptions(S=O){return this.instancesOptions.get(S)||{}}initialize(S={}){let{options:T={}}=S,R=this.normalizeInstanceIdentifier(S.instanceIdentifier);if(this.isInitialized(R))throw Error(`${this.name}(${R}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);let P=this.getOrInitializeService({instanceIdentifier:R,options:T});for(let[S,T]of this.instancesDeferred.entries()){let O=this.normalizeInstanceIdentifier(S);R===O&&T.resolve(P)}return P}onInit(S,T){var R;let P=this.normalizeInstanceIdentifier(T),O=null!==(R=this.onInitCallbacks.get(P))&&void 0!==R?R:new Set;O.add(S),this.onInitCallbacks.set(P,O);let N=this.instances.get(P);return N&&S(N,P),()=>{O.delete(S)}}invokeOnInitCallbacks(S,T){let R=this.onInitCallbacks.get(T);if(R)for(let P of R)try{P(S,T)}catch(S){}}getOrInitializeService({instanceIdentifier:S,options:T={}}){let R=this.instances.get(S);if(!R&&this.component&&(R=this.component.instanceFactory(this.container,{instanceIdentifier:normalizeIdentifierForFactory(S),options:T}),this.instances.set(S,R),this.instancesOptions.set(S,T),this.invokeOnInitCallbacks(R,S),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,S,R)}catch(S){}return R||null}normalizeInstanceIdentifier(S=O){return this.component?this.component.multipleInstances?S:O:S}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}};function normalizeIdentifierForFactory(S){return S===O?void 0:S}function isComponentEager(S){return"EAGER"===S.instantiationMode}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ComponentContainer=class ComponentContainer{constructor(S){this.name=S,this.providers=new Map}addComponent(S){let T=this.getProvider(S.name);if(T.isComponentSet())throw Error(`Component ${S.name} has already been registered with ${this.name}`);T.setComponent(S)}addOrOverwriteComponent(S){let T=this.getProvider(S.name);T.isComponentSet()&&this.providers.delete(S.name),this.addComponent(S)}getProvider(S){if(this.providers.has(S))return this.providers.get(S);let T=new Provider(S,this);return this.providers.set(S,T),T}getProviders(){return Array.from(this.providers.values())}}},9292:(S,T,R)=>{"use strict";var P;R.d(T,{Yd:()=>Logger,in:()=>P});/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let O=[];!function(S){S[S.DEBUG=0]="DEBUG",S[S.VERBOSE=1]="VERBOSE",S[S.INFO=2]="INFO",S[S.WARN=3]="WARN",S[S.ERROR=4]="ERROR",S[S.SILENT=5]="SILENT"}(P||(P={}));let N={debug:P.DEBUG,verbose:P.VERBOSE,info:P.INFO,warn:P.WARN,error:P.ERROR,silent:P.SILENT},M=P.INFO,L={[P.DEBUG]:"log",[P.VERBOSE]:"log",[P.INFO]:"info",[P.WARN]:"warn",[P.ERROR]:"error"},defaultLogHandler=(S,T,...R)=>{if(T<S.logLevel)return;let P=new Date().toISOString(),O=L[T];if(O)console[O](`[${P}]  ${S.name}:`,...R);else throw Error(`Attempted to log a message with an invalid logType (value: ${T})`)};let Logger=class Logger{constructor(S){this.name=S,this._logLevel=M,this._logHandler=defaultLogHandler,this._userLogHandler=null,O.push(this)}get logLevel(){return this._logLevel}set logLevel(S){if(!(S in P))throw TypeError(`Invalid value "${S}" assigned to \`logLevel\``);this._logLevel=S}setLogLevel(S){this._logLevel="string"==typeof S?N[S]:S}get logHandler(){return this._logHandler}set logHandler(S){if("function"!=typeof S)throw TypeError("Value assigned to `logHandler` must be a function");this._logHandler=S}get userLogHandler(){return this._userLogHandler}set userLogHandler(S){this._userLogHandler=S}debug(...S){this._userLogHandler&&this._userLogHandler(this,P.DEBUG,...S),this._logHandler(this,P.DEBUG,...S)}log(...S){this._userLogHandler&&this._userLogHandler(this,P.VERBOSE,...S),this._logHandler(this,P.VERBOSE,...S)}info(...S){this._userLogHandler&&this._userLogHandler(this,P.INFO,...S),this._logHandler(this,P.INFO,...S)}warn(...S){this._userLogHandler&&this._userLogHandler(this,P.WARN,...S),this._logHandler(this,P.WARN,...S)}error(...S){this._userLogHandler&&this._userLogHandler(this,P.ERROR,...S),this._logHandler(this,P.ERROR,...S)}}},51780:(S,T,R)=>{"use strict";R.d(T,{BH:()=>Deferred,G6:()=>isSafari,L:()=>base64urlEncodeWithoutPadding,LL:()=>ErrorFactory,P0:()=>getDefaultEmulatorHostnameAndPort,Sg:()=>createMockUserToken,ZR:()=>FirebaseError,aH:()=>getDefaultAppConfig,eu:()=>validateIndexedDBOpenable,hl:()=>isIndexedDBAvailable,m9:()=>getModularInstance,vZ:()=>deepEqual,z$:()=>getUA});/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let P={NODE_CLIENT:!1},stringToByteArray$1=function(S){let T=[],R=0;for(let P=0;P<S.length;P++){let O=S.charCodeAt(P);O<128?T[R++]=O:(O<2048?T[R++]=O>>6|192:((64512&O)==55296&&P+1<S.length&&(64512&S.charCodeAt(P+1))==56320?(O=65536+((1023&O)<<10)+(1023&S.charCodeAt(++P)),T[R++]=O>>18|240,T[R++]=O>>12&63|128):T[R++]=O>>12|224,T[R++]=O>>6&63|128),T[R++]=63&O|128)}return T},byteArrayToString=function(S){let T=[],R=0,P=0;for(;R<S.length;){let O=S[R++];if(O<128)T[P++]=String.fromCharCode(O);else if(O>191&&O<224){let N=S[R++];T[P++]=String.fromCharCode((31&O)<<6|63&N)}else if(O>239&&O<365){let N=S[R++],M=S[R++],L=S[R++],V=((7&O)<<18|(63&N)<<12|(63&M)<<6|63&L)-65536;T[P++]=String.fromCharCode(55296+(V>>10)),T[P++]=String.fromCharCode(56320+(1023&V))}else{let N=S[R++],M=S[R++];T[P++]=String.fromCharCode((15&O)<<12|(63&N)<<6|63&M)}}return T.join("")},O={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(S,T){if(!Array.isArray(S))throw Error("encodeByteArray takes an array as a parameter");this.init_();let R=T?this.byteToCharMapWebSafe_:this.byteToCharMap_,P=[];for(let T=0;T<S.length;T+=3){let O=S[T],N=T+1<S.length,M=N?S[T+1]:0,L=T+2<S.length,V=L?S[T+2]:0,U=O>>2,W=(3&O)<<4|M>>4,K=(15&M)<<2|V>>6,Q=63&V;L||(Q=64,N||(K=64)),P.push(R[U],R[W],R[K],R[Q])}return P.join("")},encodeString(S,T){return this.HAS_NATIVE_SUPPORT&&!T?btoa(S):this.encodeByteArray(stringToByteArray$1(S),T)},decodeString(S,T){return this.HAS_NATIVE_SUPPORT&&!T?atob(S):byteArrayToString(this.decodeStringToByteArray(S,T))},decodeStringToByteArray(S,T){this.init_();let R=T?this.charToByteMapWebSafe_:this.charToByteMap_,P=[];for(let T=0;T<S.length;){let O=R[S.charAt(T++)],N=T<S.length,M=N?R[S.charAt(T)]:0;++T;let L=T<S.length,V=L?R[S.charAt(T)]:64;++T;let U=T<S.length,W=U?R[S.charAt(T)]:64;if(++T,null==O||null==M||null==V||null==W)throw new DecodeBase64StringError;let K=O<<2|M>>4;if(P.push(K),64!==V){let S=M<<4&240|V>>2;if(P.push(S),64!==W){let S=V<<6&192|W;P.push(S)}}}return P},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let S=0;S<this.ENCODED_VALS.length;S++)this.byteToCharMap_[S]=this.ENCODED_VALS.charAt(S),this.charToByteMap_[this.byteToCharMap_[S]]=S,this.byteToCharMapWebSafe_[S]=this.ENCODED_VALS_WEBSAFE.charAt(S),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[S]]=S,S>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(S)]=S,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(S)]=S)}}};let DecodeBase64StringError=class DecodeBase64StringError extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}};let base64Encode=function(S){let T=stringToByteArray$1(S);return O.encodeByteArray(T,!0)},base64urlEncodeWithoutPadding=function(S){return base64Encode(S).replace(/\./g,"")},base64Decode=function(S){try{return O.decodeString(S,!0)}catch(S){console.error("base64Decode failed: ",S)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getGlobal(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let getDefaultsFromGlobal=()=>getGlobal().__FIREBASE_DEFAULTS__,getDefaultsFromEnvVariable=()=>{if("undefined"==typeof process||void 0===process.env)return;let S=process.env.__FIREBASE_DEFAULTS__;if(S)return JSON.parse(S)},getDefaultsFromCookie=()=>{let S;if("undefined"==typeof document)return;try{S=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(S){return}let T=S&&base64Decode(S[1]);return T&&JSON.parse(T)},getDefaults=()=>{try{return getDefaultsFromGlobal()||getDefaultsFromEnvVariable()||getDefaultsFromCookie()}catch(S){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${S}`);return}},getDefaultEmulatorHost=S=>{var T,R;return null===(R=null===(T=getDefaults())||void 0===T?void 0:T.emulatorHosts)||void 0===R?void 0:R[S]},getDefaultEmulatorHostnameAndPort=S=>{let T=getDefaultEmulatorHost(S);if(!T)return;let R=T.lastIndexOf(":");if(R<=0||R+1===T.length)throw Error(`Invalid host ${T} with no separate hostname and port!`);let P=parseInt(T.substring(R+1),10);return"["===T[0]?[T.substring(1,R-1),P]:[T.substring(0,R),P]},getDefaultAppConfig=()=>{var S;return null===(S=getDefaults())||void 0===S?void 0:S.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Deferred=class Deferred{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((S,T)=>{this.resolve=S,this.reject=T})}wrapCallback(S){return(T,R)=>{T?this.reject(T):this.resolve(R),"function"==typeof S&&(this.promise.catch(()=>{}),1===S.length?S(T):S(T,R))}}};/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function createMockUserToken(S,T){if(S.uid)throw Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');let R={alg:"none",type:"JWT"},P=T||"demo-project",O=S.iat||0,N=S.sub||S.user_id;if(!N)throw Error("mockUserToken must contain 'sub' or 'user_id' field!");let M=Object.assign({iss:`https://securetoken.google.com/${P}`,aud:P,iat:O,exp:O+3600,auth_time:O,sub:N,user_id:N,firebase:{sign_in_provider:"custom",identities:{}}},S),L="";return[base64urlEncodeWithoutPadding(JSON.stringify(R)),base64urlEncodeWithoutPadding(JSON.stringify(M)),L].join(".")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getUA(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function isNode(){var S;let T=null===(S=getDefaults())||void 0===S?void 0:S.forceEnvironment;if("node"===T)return!0;if("browser"===T)return!1;try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(S){return!1}}function isSafari(){return!isNode()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function isIndexedDBAvailable(){try{return"object"==typeof indexedDB}catch(S){return!1}}function validateIndexedDBOpenable(){return new Promise((S,T)=>{try{let R=!0,P="validate-browser-context-for-indexeddb-analytics-module",O=self.indexedDB.open(P);O.onsuccess=()=>{O.result.close(),R||self.indexedDB.deleteDatabase(P),S(!0)},O.onupgradeneeded=()=>{R=!1},O.onerror=()=>{var S;T((null===(S=O.error)||void 0===S?void 0:S.message)||"")}}catch(S){T(S)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let N="FirebaseError";let FirebaseError=class FirebaseError extends Error{constructor(S,T,R){super(T),this.code=S,this.customData=R,this.name=N,Object.setPrototypeOf(this,FirebaseError.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ErrorFactory.prototype.create)}};let ErrorFactory=class ErrorFactory{constructor(S,T,R){this.service=S,this.serviceName=T,this.errors=R}create(S,...T){let R=T[0]||{},P=`${this.service}/${S}`,O=this.errors[S],N=O?replaceTemplate(O,R):"Error",M=`${this.serviceName}: ${N} (${P}).`,L=new FirebaseError(P,M,R);return L}};function replaceTemplate(S,T){return S.replace(M,(S,R)=>{let P=T[R];return null!=P?String(P):`<${R}?>`})}let M=/\{\$([^}]+)}/g;function deepEqual(S,T){if(S===T)return!0;let R=Object.keys(S),P=Object.keys(T);for(let O of R){if(!P.includes(O))return!1;let R=S[O],N=T[O];if(isObject(R)&&isObject(N)){if(!deepEqual(R,N))return!1}else if(R!==N)return!1}for(let S of P)if(!R.includes(S))return!1;return!0}function isObject(S){return null!==S&&"object"==typeof S}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getModularInstance(S){return S&&S._delegate?S._delegate:S}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */P.NODE_CLIENT=!0},72856:(S,T,R)=>{"use strict";R.d(T,{C6:()=>P.C6,ZF:()=>P.ZF});var P=R(55087),O="firebase",N="10.14.1";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(0,P.KN)(O,N,"app")},29904:(S,T,R)=>{"use strict";R.d(T,{EK:()=>Timestamp,ET:()=>addDoc,hJ:()=>collection,oe:()=>deleteDoc,AK:()=>deleteField,JU:()=>doc,QT:()=>getDoc,PL:()=>getDocs,ad:()=>getFirestore,cf:()=>onSnapshot,Xo:()=>orderBy,IO:()=>query,Bt:()=>serverTimestamp,r7:()=>updateDoc,ar:()=>where,qs:()=>writeBatch});var P,O,N,M,L=R(55087),V=R(77345),U=R(9292),W=R(73837),K=R(51780),Q=R(6113),$="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Y={};(function(){function m(){this.blockSize=-1,this.blockSize=64,this.g=[,,,,],this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function n(S,T,R){R||(R=0);var P=Array(16);if("string"==typeof T)for(var O=0;16>O;++O)P[O]=T.charCodeAt(R++)|T.charCodeAt(R++)<<8|T.charCodeAt(R++)<<16|T.charCodeAt(R++)<<24;else for(O=0;16>O;++O)P[O]=T[R++]|T[R++]<<8|T[R++]<<16|T[R++]<<24;T=S.g[0],R=S.g[1],O=S.g[2];var N=S.g[3],M=T+(N^R&(O^N))+P[0]+3614090360&4294967295;M=N+(O^(T=R+(M<<7&4294967295|M>>>25))&(R^O))+P[1]+3905402710&4294967295,M=O+(R^(N=T+(M<<12&4294967295|M>>>20))&(T^R))+P[2]+606105819&4294967295,M=R+(T^(O=N+(M<<17&4294967295|M>>>15))&(N^T))+P[3]+3250441966&4294967295,M=T+(N^(R=O+(M<<22&4294967295|M>>>10))&(O^N))+P[4]+4118548399&4294967295,M=N+(O^(T=R+(M<<7&4294967295|M>>>25))&(R^O))+P[5]+1200080426&4294967295,M=O+(R^(N=T+(M<<12&4294967295|M>>>20))&(T^R))+P[6]+2821735955&4294967295,M=R+(T^(O=N+(M<<17&4294967295|M>>>15))&(N^T))+P[7]+4249261313&4294967295,M=T+(N^(R=O+(M<<22&4294967295|M>>>10))&(O^N))+P[8]+1770035416&4294967295,M=N+(O^(T=R+(M<<7&4294967295|M>>>25))&(R^O))+P[9]+2336552879&4294967295,M=O+(R^(N=T+(M<<12&4294967295|M>>>20))&(T^R))+P[10]+4294925233&4294967295,M=R+(T^(O=N+(M<<17&4294967295|M>>>15))&(N^T))+P[11]+2304563134&4294967295,M=T+(N^(R=O+(M<<22&4294967295|M>>>10))&(O^N))+P[12]+1804603682&4294967295,M=N+(O^(T=R+(M<<7&4294967295|M>>>25))&(R^O))+P[13]+4254626195&4294967295,M=O+(R^(N=T+(M<<12&4294967295|M>>>20))&(T^R))+P[14]+2792965006&4294967295,M=R+(T^(O=N+(M<<17&4294967295|M>>>15))&(N^T))+P[15]+1236535329&4294967295,R=O+(M<<22&4294967295|M>>>10),M=T+(O^N&(R^O))+P[1]+4129170786&4294967295,T=R+(M<<5&4294967295|M>>>27),M=N+(R^O&(T^R))+P[6]+3225465664&4294967295,N=T+(M<<9&4294967295|M>>>23),M=O+(T^R&(N^T))+P[11]+643717713&4294967295,O=N+(M<<14&4294967295|M>>>18),M=R+(N^T&(O^N))+P[0]+3921069994&4294967295,R=O+(M<<20&4294967295|M>>>12),M=T+(O^N&(R^O))+P[5]+3593408605&4294967295,T=R+(M<<5&4294967295|M>>>27),M=N+(R^O&(T^R))+P[10]+38016083&4294967295,N=T+(M<<9&4294967295|M>>>23),M=O+(T^R&(N^T))+P[15]+3634488961&4294967295,O=N+(M<<14&4294967295|M>>>18),M=R+(N^T&(O^N))+P[4]+3889429448&4294967295,R=O+(M<<20&4294967295|M>>>12),M=T+(O^N&(R^O))+P[9]+568446438&4294967295,T=R+(M<<5&4294967295|M>>>27),M=N+(R^O&(T^R))+P[14]+3275163606&4294967295,N=T+(M<<9&4294967295|M>>>23),M=O+(T^R&(N^T))+P[3]+4107603335&4294967295,O=N+(M<<14&4294967295|M>>>18),M=R+(N^T&(O^N))+P[8]+1163531501&4294967295,R=O+(M<<20&4294967295|M>>>12),M=T+(O^N&(R^O))+P[13]+2850285829&4294967295,T=R+(M<<5&4294967295|M>>>27),M=N+(R^O&(T^R))+P[2]+4243563512&4294967295,N=T+(M<<9&4294967295|M>>>23),M=O+(T^R&(N^T))+P[7]+1735328473&4294967295,O=N+(M<<14&4294967295|M>>>18),M=R+(N^T&(O^N))+P[12]+2368359562&4294967295,M=T+((R=O+(M<<20&4294967295|M>>>12))^O^N)+P[5]+4294588738&4294967295,M=N+((T=R+(M<<4&4294967295|M>>>28))^R^O)+P[8]+2272392833&4294967295,M=O+((N=T+(M<<11&4294967295|M>>>21))^T^R)+P[11]+1839030562&4294967295,M=R+((O=N+(M<<16&4294967295|M>>>16))^N^T)+P[14]+4259657740&4294967295,M=T+((R=O+(M<<23&4294967295|M>>>9))^O^N)+P[1]+2763975236&4294967295,M=N+((T=R+(M<<4&4294967295|M>>>28))^R^O)+P[4]+1272893353&4294967295,M=O+((N=T+(M<<11&4294967295|M>>>21))^T^R)+P[7]+4139469664&4294967295,M=R+((O=N+(M<<16&4294967295|M>>>16))^N^T)+P[10]+3200236656&4294967295,M=T+((R=O+(M<<23&4294967295|M>>>9))^O^N)+P[13]+681279174&4294967295,M=N+((T=R+(M<<4&4294967295|M>>>28))^R^O)+P[0]+3936430074&4294967295,M=O+((N=T+(M<<11&4294967295|M>>>21))^T^R)+P[3]+3572445317&4294967295,M=R+((O=N+(M<<16&4294967295|M>>>16))^N^T)+P[6]+76029189&4294967295,M=T+((R=O+(M<<23&4294967295|M>>>9))^O^N)+P[9]+3654602809&4294967295,M=N+((T=R+(M<<4&4294967295|M>>>28))^R^O)+P[12]+3873151461&4294967295,M=O+((N=T+(M<<11&4294967295|M>>>21))^T^R)+P[15]+530742520&4294967295,M=R+((O=N+(M<<16&4294967295|M>>>16))^N^T)+P[2]+3299628645&4294967295,R=O+(M<<23&4294967295|M>>>9),M=T+(O^(R|~N))+P[0]+4096336452&4294967295,T=R+(M<<6&4294967295|M>>>26),M=N+(R^(T|~O))+P[7]+1126891415&4294967295,N=T+(M<<10&4294967295|M>>>22),M=O+(T^(N|~R))+P[14]+2878612391&4294967295,O=N+(M<<15&4294967295|M>>>17),M=R+(N^(O|~T))+P[5]+4237533241&4294967295,R=O+(M<<21&4294967295|M>>>11),M=T+(O^(R|~N))+P[12]+1700485571&4294967295,T=R+(M<<6&4294967295|M>>>26),M=N+(R^(T|~O))+P[3]+2399980690&4294967295,N=T+(M<<10&4294967295|M>>>22),M=O+(T^(N|~R))+P[10]+4293915773&4294967295,O=N+(M<<15&4294967295|M>>>17),M=R+(N^(O|~T))+P[1]+2240044497&4294967295,R=O+(M<<21&4294967295|M>>>11),M=T+(O^(R|~N))+P[8]+1873313359&4294967295,T=R+(M<<6&4294967295|M>>>26),M=N+(R^(T|~O))+P[15]+4264355552&4294967295,N=T+(M<<10&4294967295|M>>>22),M=O+(T^(N|~R))+P[6]+2734768916&4294967295,O=N+(M<<15&4294967295|M>>>17),M=R+(N^(O|~T))+P[13]+1309151649&4294967295,R=O+(M<<21&4294967295|M>>>11),M=T+(O^(R|~N))+P[4]+4149444226&4294967295,T=R+(M<<6&4294967295|M>>>26),M=N+(R^(T|~O))+P[11]+3174756917&4294967295,N=T+(M<<10&4294967295|M>>>22),M=O+(T^(N|~R))+P[2]+718787259&4294967295,O=N+(M<<15&4294967295|M>>>17),M=R+(N^(O|~T))+P[9]+3951481745&4294967295,S.g[0]=S.g[0]+T&4294967295,S.g[1]=S.g[1]+(O+(M<<21&4294967295|M>>>11))&4294967295,S.g[2]=S.g[2]+O&4294967295,S.g[3]=S.g[3]+N&4294967295}function p(S,R){var P=T;return Object.prototype.hasOwnProperty.call(P,S)?P[S]:P[S]=R(S)}function t(S,T){this.h=T;for(var R=[],P=!0,O=S.length-1;0<=O;O--){var N=0|S[O];P&&N==T||(R[O]=N,P=!1)}this.g=R}(function(S,T){function c(){}c.prototype=T.prototype,S.D=T.prototype,S.prototype=new c,S.prototype.constructor=S,S.C=function(S,R,P){for(var O=Array(arguments.length-2),N=2;N<arguments.length;N++)O[N-2]=arguments[N];return T.prototype[R].apply(S,O)}})(m,function(){this.blockSize=-1}),m.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},m.prototype.u=function(S,T){void 0===T&&(T=S.length);for(var R=T-this.blockSize,P=this.B,O=this.h,N=0;N<T;){if(0==O)for(;N<=R;)n(this,S,N),N+=this.blockSize;if("string"==typeof S){for(;N<T;)if(P[O++]=S.charCodeAt(N++),O==this.blockSize){n(this,P),O=0;break}}else for(;N<T;)if(P[O++]=S[N++],O==this.blockSize){n(this,P),O=0;break}}this.h=O,this.o+=T},m.prototype.v=function(){var S=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);S[0]=128;for(var T=1;T<S.length-8;++T)S[T]=0;var R=8*this.o;for(T=S.length-8;T<S.length;++T)S[T]=255&R,R/=256;for(this.u(S),S=Array(16),T=R=0;4>T;++T)for(var P=0;32>P;P+=8)S[R++]=this.g[T]>>>P&255;return S};var S,T={};function u(S){return -128<=S&&128>S?p(S,function(S){return new t([0|S],0>S?-1:0)}):new t([0|S],0>S?-1:0)}function v(S){if(isNaN(S)||!isFinite(S))return R;if(0>S)return x(v(-S));for(var T=[],P=1,O=0;S>=P;O++)T[O]=S/P|0,P*=4294967296;return new t(T,0)}function y(S,T){if(0==S.length)throw Error("number format error: empty string");if(2>(T=T||10)||36<T)throw Error("radix out of range: "+T);if("-"==S.charAt(0))return x(y(S.substring(1),T));if(0<=S.indexOf("-"))throw Error('number format error: interior "-" character');for(var P=v(Math.pow(T,8)),O=R,N=0;N<S.length;N+=8){var M=Math.min(8,S.length-N),L=parseInt(S.substring(N,N+M),T);8>M?(M=v(Math.pow(T,M)),O=O.j(M).add(v(L))):O=(O=O.j(P)).add(v(L))}return O}var R=u(0),N=u(1),M=u(16777216);function C(S){if(0!=S.h)return!1;for(var T=0;T<S.g.length;T++)if(0!=S.g[T])return!1;return!0}function B(S){return -1==S.h}function x(S){for(var T=S.g.length,R=[],P=0;P<T;P++)R[P]=~S.g[P];return new t(R,~S.h).add(N)}function F(S,T){return S.add(x(T))}function G(S,T){for(;(65535&S[T])!=S[T];)S[T+1]+=S[T]>>>16,S[T]&=65535,T++}function H(S,T){this.g=S,this.h=T}function D(S,T){if(C(T))throw Error("division by zero");if(C(S))return new H(R,R);if(B(S))return T=D(x(S),T),new H(x(T.g),x(T.h));if(B(T))return T=D(S,x(T)),new H(x(T.g),T.h);if(30<S.g.length){if(B(S)||B(T))throw Error("slowDivide_ only works with positive integers.");for(var P=N,O=T;0>=O.l(S);)P=I(P),O=I(O);var M=J(P,1),L=J(O,1);for(O=J(O,2),P=J(P,2);!C(O);){var V=L.add(O);0>=V.l(S)&&(M=M.add(P),L=V),O=J(O,1),P=J(P,1)}return T=F(S,M.j(T)),new H(M,T)}for(M=R;0<=S.l(T);){for(O=48>=(O=Math.ceil(Math.log(P=Math.max(1,Math.floor(S.m()/T.m())))/Math.LN2))?1:Math.pow(2,O-48),V=(L=v(P)).j(T);B(V)||0<V.l(S);)P-=O,V=(L=v(P)).j(T);C(L)&&(L=N),M=M.add(L),S=F(S,V)}return new H(M,S)}function I(S){for(var T=S.g.length+1,R=[],P=0;P<T;P++)R[P]=S.i(P)<<1|S.i(P-1)>>>31;return new t(R,S.h)}function J(S,T){var R=T>>5;T%=32;for(var P=S.g.length-R,O=[],N=0;N<P;N++)O[N]=0<T?S.i(N+R)>>>T|S.i(N+R+1)<<32-T:S.i(N+R);return new t(O,S.h)}(S=t.prototype).m=function(){if(B(this))return-x(this).m();for(var S=0,T=1,R=0;R<this.g.length;R++){var P=this.i(R);S+=(0<=P?P:4294967296+P)*T,T*=4294967296}return S},S.toString=function(S){if(2>(S=S||10)||36<S)throw Error("radix out of range: "+S);if(C(this))return"0";if(B(this))return"-"+x(this).toString(S);for(var T=v(Math.pow(S,6)),R=this,P="";;){var O=D(R,T).g,N=((0<(R=F(R,O.j(T))).g.length?R.g[0]:R.h)>>>0).toString(S);if(C(R=O))return N+P;for(;6>N.length;)N="0"+N;P=N+P}},S.i=function(S){return 0>S?0:S<this.g.length?this.g[S]:this.h},S.l=function(S){return B(S=F(this,S))?-1:C(S)?0:1},S.abs=function(){return B(this)?x(this):this},S.add=function(S){for(var T=Math.max(this.g.length,S.g.length),R=[],P=0,O=0;O<=T;O++){var N=P+(65535&this.i(O))+(65535&S.i(O)),M=(N>>>16)+(this.i(O)>>>16)+(S.i(O)>>>16);P=M>>>16,N&=65535,M&=65535,R[O]=M<<16|N}return new t(R,-2147483648&R[R.length-1]?-1:0)},S.j=function(S){if(C(this)||C(S))return R;if(B(this))return B(S)?x(this).j(x(S)):x(x(this).j(S));if(B(S))return x(this.j(x(S)));if(0>this.l(M)&&0>S.l(M))return v(this.m()*S.m());for(var T=this.g.length+S.g.length,P=[],O=0;O<2*T;O++)P[O]=0;for(O=0;O<this.g.length;O++)for(var N=0;N<S.g.length;N++){var L=this.i(O)>>>16,V=65535&this.i(O),U=S.i(N)>>>16,W=65535&S.i(N);P[2*O+2*N]+=V*W,G(P,2*O+2*N),P[2*O+2*N+1]+=L*W,G(P,2*O+2*N+1),P[2*O+2*N+1]+=V*U,G(P,2*O+2*N+1),P[2*O+2*N+2]+=L*U,G(P,2*O+2*N+2)}for(O=0;O<T;O++)P[O]=P[2*O+1]<<16|P[2*O];for(O=T;O<2*T;O++)P[O]=0;return new t(P,0)},S.A=function(S){return D(this,S).h},S.and=function(S){for(var T=Math.max(this.g.length,S.g.length),R=[],P=0;P<T;P++)R[P]=this.i(P)&S.i(P);return new t(R,this.h&S.h)},S.or=function(S){for(var T=Math.max(this.g.length,S.g.length),R=[],P=0;P<T;P++)R[P]=this.i(P)|S.i(P);return new t(R,this.h|S.h)},S.xor=function(S){for(var T=Math.max(this.g.length,S.g.length),R=[],P=0;P<T;P++)R[P]=this.i(P)^S.i(P);return new t(R,this.h^S.h)},m.prototype.digest=m.prototype.v,m.prototype.reset=m.prototype.s,m.prototype.update=m.prototype.u,O=Y.Md5=m,t.prototype.add=t.prototype.add,t.prototype.multiply=t.prototype.j,t.prototype.modulo=t.prototype.A,t.prototype.compare=t.prototype.l,t.prototype.toNumber=t.prototype.m,t.prototype.toString=t.prototype.toString,t.prototype.getBits=t.prototype.i,t.fromNumber=v,t.fromString=y,P=Y.Integer=t}).apply(void 0!==$?$:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});var X=R(16063),Z=R(18196);let ee="@firebase/firestore",et="4.7.3";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let User=class User{constructor(S){this.uid=S}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(S){return S.uid===this.uid}};User.UNAUTHENTICATED=new User(null),User.GOOGLE_CREDENTIALS=new User("google-credentials-uid"),User.FIRST_PARTY=new User("first-party-uid"),User.MOCK_USER=new User("mock-user");let er="10.14.0",en=er;function setSDKVersion(S){en=S}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function formatJSON(S){return(0,W.inspect)(S,{depth:100})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ei=new U.Yd("@firebase/firestore");function getLogLevel(){return ei.logLevel}function logDebug(S,...T){if(ei.logLevel<=U.in.DEBUG){let R=T.map(argToString);ei.debug(`Firestore (${en}): ${S}`,...R)}}function logError(S,...T){if(ei.logLevel<=U.in.ERROR){let R=T.map(argToString);ei.error(`Firestore (${en}): ${S}`,...R)}}function logWarn(S,...T){if(ei.logLevel<=U.in.WARN){let R=T.map(argToString);ei.warn(`Firestore (${en}): ${S}`,...R)}}function argToString(S){if("string"==typeof S)return S;try{return formatJSON(S)}catch(T){return S}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fail(S="Unexpected state"){let T=`FIRESTORE (${en}) INTERNAL ASSERTION FAILED: `+S;throw logError(T),Error(T)}function hardAssert(S,T){S||fail()}function debugCast(S,T){return S}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let es={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};let FirestoreError=class FirestoreError extends K.ZR{constructor(S,T){super(S,T),this.code=S,this.message=T,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Deferred=class Deferred{constructor(){this.promise=new Promise((S,T)=>{this.resolve=S,this.reject=T})}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let OAuthToken=class OAuthToken{constructor(S,T){this.user=T,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${S}`)}};let EmptyAuthCredentialsProvider=class EmptyAuthCredentialsProvider{getToken(){return Promise.resolve(null)}invalidateToken(){}start(S,T){S.enqueueRetryable(()=>T(User.UNAUTHENTICATED))}shutdown(){}};let EmulatorAuthCredentialsProvider=class EmulatorAuthCredentialsProvider{constructor(S){this.token=S,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(S,T){this.changeListener=T,S.enqueueRetryable(()=>T(this.token.user))}shutdown(){this.changeListener=null}};let FirebaseAuthCredentialsProvider=class FirebaseAuthCredentialsProvider{constructor(S){this.authProvider=S,this.currentUser=User.UNAUTHENTICATED,this.tokenCounter=0,this.forceRefresh=!1,this.auth=null}start(S,T){hardAssert(void 0===this.tokenListener);let R=this.tokenCounter,guardedChangeListener=S=>this.tokenCounter!==R?(R=this.tokenCounter,T(S)):Promise.resolve(),P=new Deferred;this.tokenListener=()=>{this.tokenCounter++,this.currentUser=this.getUser(),P.resolve(),P=new Deferred,S.enqueueRetryable(()=>guardedChangeListener(this.currentUser))};let awaitNextToken=()=>{let T=P;S.enqueueRetryable(async()=>{await T.promise,await guardedChangeListener(this.currentUser)})},registerAuth=S=>{logDebug("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=S,this.tokenListener&&(this.auth.addAuthTokenListener(this.tokenListener),awaitNextToken())};this.authProvider.onInit(S=>registerAuth(S)),setTimeout(()=>{if(!this.auth){let S=this.authProvider.getImmediate({optional:!0});S?registerAuth(S):(logDebug("FirebaseAuthCredentialsProvider","Auth not yet detected"),P.resolve(),P=new Deferred)}},0),awaitNextToken()}getToken(){let S=this.tokenCounter,T=this.forceRefresh;return(this.forceRefresh=!1,this.auth)?this.auth.getToken(T).then(T=>this.tokenCounter!==S?(logDebug("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):T?(hardAssert("string"==typeof T.accessToken),new OAuthToken(T.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.tokenListener&&this.auth.removeAuthTokenListener(this.tokenListener),this.tokenListener=void 0}getUser(){let S=this.auth&&this.auth.getUid();return hardAssert(null===S||"string"==typeof S),new User(S)}};let FirstPartyToken=class FirstPartyToken{constructor(S,T,R){this.sessionIndex=S,this.iamToken=T,this.authTokenFactory=R,this.type="FirstParty",this.user=User.FIRST_PARTY,this._headers=new Map}getAuthToken(){return this.authTokenFactory?this.authTokenFactory():null}get headers(){this._headers.set("X-Goog-AuthUser",this.sessionIndex);let S=this.getAuthToken();return S&&this._headers.set("Authorization",S),this.iamToken&&this._headers.set("X-Goog-Iam-Authorization-Token",this.iamToken),this._headers}};let FirstPartyAuthCredentialsProvider=class FirstPartyAuthCredentialsProvider{constructor(S,T,R){this.sessionIndex=S,this.iamToken=T,this.authTokenFactory=R}getToken(){return Promise.resolve(new FirstPartyToken(this.sessionIndex,this.iamToken,this.authTokenFactory))}start(S,T){S.enqueueRetryable(()=>T(User.FIRST_PARTY))}shutdown(){}invalidateToken(){}};let AppCheckToken=class AppCheckToken{constructor(S){this.value=S,this.type="AppCheck",this.headers=new Map,S&&S.length>0&&this.headers.set("x-firebase-appcheck",this.value)}};let FirebaseAppCheckTokenProvider=class FirebaseAppCheckTokenProvider{constructor(S){this.appCheckProvider=S,this.forceRefresh=!1,this.appCheck=null,this.latestAppCheckToken=null}start(S,T){hardAssert(void 0===this.tokenListener);let onTokenChanged=S=>{null!=S.error&&logDebug("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${S.error.message}`);let R=S.token!==this.latestAppCheckToken;return this.latestAppCheckToken=S.token,logDebug("FirebaseAppCheckTokenProvider",`Received ${R?"new":"existing"} token.`),R?T(S.token):Promise.resolve()};this.tokenListener=T=>{S.enqueueRetryable(()=>onTokenChanged(T))};let registerAppCheck=S=>{logDebug("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=S,this.tokenListener&&this.appCheck.addTokenListener(this.tokenListener)};this.appCheckProvider.onInit(S=>registerAppCheck(S)),setTimeout(()=>{if(!this.appCheck){let S=this.appCheckProvider.getImmediate({optional:!0});S?registerAppCheck(S):logDebug("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let S=this.forceRefresh;return(this.forceRefresh=!1,this.appCheck)?this.appCheck.getToken(S).then(S=>S?(hardAssert("string"==typeof S.token),this.latestAppCheckToken=S.token,new AppCheckToken(S.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.tokenListener&&this.appCheck.removeTokenListener(this.tokenListener),this.tokenListener=void 0}};function makeAuthCredentialsProvider(S){if(!S)return new EmptyAuthCredentialsProvider;switch(S.type){case"firstParty":return new FirstPartyAuthCredentialsProvider(S.sessionIndex||"0",S.iamToken||null,S.authTokenFactory||null);case"provider":return S.client;default:throw new FirestoreError(es.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function randomBytes(S){return(0,Q.randomBytes)(S)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let AutoId=class AutoId{static newId(){let S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",T=Math.floor(256/S.length)*S.length,R="",P=20;for(;R.length<P;){let O=randomBytes(40);for(let N=0;N<O.length;++N)R.length<P&&O[N]<T&&(R+=S.charAt(O[N]%S.length))}return R}};function primitiveComparator(S,T){return S<T?-1:S>T?1:0}function arrayEquals(S,T,R){return S.length===T.length&&S.every((S,P)=>R(S,T[P]))}function immediateSuccessor(S){return S+"\x00"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ea=-62135596800,eo=1e6;let Timestamp=class Timestamp{constructor(S,T){if(this.seconds=S,this.nanoseconds=T,T<0||T>=1e9)throw new FirestoreError(es.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+T);if(S<ea||S>=253402300800)throw new FirestoreError(es.INVALID_ARGUMENT,"Timestamp seconds out of range: "+S)}static now(){return Timestamp.fromMillis(Date.now())}static fromDate(S){return Timestamp.fromMillis(S.getTime())}static fromMillis(S){let T=Math.floor(S/1e3),R=Math.floor((S-1e3*T)*eo);return new Timestamp(T,R)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/eo}_compareTo(S){return this.seconds===S.seconds?primitiveComparator(this.nanoseconds,S.nanoseconds):primitiveComparator(this.seconds,S.seconds)}isEqual(S){return S.seconds===this.seconds&&S.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let S=this.seconds-ea,T=String(S).padStart(12,"0"),R=String(this.nanoseconds).padStart(9,"0");return T+"."+R}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SnapshotVersion=class SnapshotVersion{constructor(S){this.timestamp=S}static fromTimestamp(S){return new SnapshotVersion(S)}static min(){return new SnapshotVersion(new Timestamp(0,0))}static max(){return new SnapshotVersion(new Timestamp(253402300799,1e9-1))}compareTo(S){return this.timestamp._compareTo(S.timestamp)}isEqual(S){return this.timestamp.isEqual(S.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eu="__name__";let BasePath=class BasePath{constructor(S,T,R){void 0===T?T=0:T>S.length&&fail(),void 0===R?R=S.length-T:R>S.length-T&&fail(),this.segments=S,this.offset=T,this.len=R}get length(){return this.len}isEqual(S){return 0===BasePath.comparator(this,S)}child(S){let T=this.segments.slice(this.offset,this.limit());return S instanceof BasePath?S.forEach(S=>{T.push(S)}):T.push(S),this.construct(T)}limit(){return this.offset+this.length}popFirst(S){return S=void 0===S?1:S,this.construct(this.segments,this.offset+S,this.length-S)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(S){return this.segments[this.offset+S]}isEmpty(){return 0===this.length}isPrefixOf(S){if(S.length<this.length)return!1;for(let T=0;T<this.length;T++)if(this.get(T)!==S.get(T))return!1;return!0}isImmediateParentOf(S){if(this.length+1!==S.length)return!1;for(let T=0;T<this.length;T++)if(this.get(T)!==S.get(T))return!1;return!0}forEach(S){for(let T=this.offset,R=this.limit();T<R;T++)S(this.segments[T])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(S,T){let R=Math.min(S.length,T.length);for(let P=0;P<R;P++){let R=S.get(P),O=T.get(P);if(R<O)return -1;if(R>O)return 1}return S.length<T.length?-1:S.length>T.length?1:0}};let ResourcePath=class ResourcePath extends BasePath{construct(S,T,R){return new ResourcePath(S,T,R)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...S){let T=[];for(let R of S){if(R.indexOf("//")>=0)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid segment (${R}). Paths must not contain // in them.`);T.push(...R.split("/").filter(S=>S.length>0))}return new ResourcePath(T)}static emptyPath(){return new ResourcePath([])}};let ec=/^[_a-zA-Z][_a-zA-Z0-9]*$/;let FieldPath$1=class FieldPath$1 extends BasePath{construct(S,T,R){return new FieldPath$1(S,T,R)}static isValidIdentifier(S){return ec.test(S)}canonicalString(){return this.toArray().map(S=>(S=S.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),FieldPath$1.isValidIdentifier(S)||(S="`"+S+"`"),S)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===eu}static keyField(){return new FieldPath$1([eu])}static fromServerFormat(S){let T=[],R="",P=0,addCurrentSegment=()=>{if(0===R.length)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid field path (${S}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);T.push(R),R=""},O=!1;for(;P<S.length;){let T=S[P];if("\\"===T){if(P+1===S.length)throw new FirestoreError(es.INVALID_ARGUMENT,"Path has trailing escape character: "+S);let T=S[P+1];if(!("\\"===T||"."===T||"`"===T))throw new FirestoreError(es.INVALID_ARGUMENT,"Path has invalid escape sequence: "+S);R+=T,P+=2}else"`"===T?O=!O:"."!==T||O?R+=T:addCurrentSegment(),P++}if(addCurrentSegment(),O)throw new FirestoreError(es.INVALID_ARGUMENT,"Unterminated ` in path: "+S);return new FieldPath$1(T)}static emptyPath(){return new FieldPath$1([])}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DocumentKey=class DocumentKey{constructor(S){this.path=S}static fromPath(S){return new DocumentKey(ResourcePath.fromString(S))}static fromName(S){return new DocumentKey(ResourcePath.fromString(S).popFirst(5))}static empty(){return new DocumentKey(ResourcePath.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(S){return this.path.length>=2&&this.path.get(this.path.length-2)===S}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(S){return null!==S&&0===ResourcePath.comparator(this.path,S.path)}toString(){return this.path.toString()}static comparator(S,T){return ResourcePath.comparator(S.path,T.path)}static isDocumentKey(S){return S.length%2==0}static fromSegments(S){return new DocumentKey(new ResourcePath(S.slice()))}};/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ed=-1,eh=0;let FieldIndex=class FieldIndex{constructor(S,T,R,P){this.indexId=S,this.collectionGroup=T,this.fields=R,this.indexState=P}};function fieldIndexGetArraySegment(S){return S.fields.find(S=>2===S.kind)}function fieldIndexGetDirectionalSegments(S){return S.fields.filter(S=>2!==S.kind)}function fieldIndexGetKeyOrder(S){let T=fieldIndexGetDirectionalSegments(S);return 0===T.length?0:T[T.length-1].kind}function fieldIndexSemanticComparator(S,T){let R=primitiveComparator(S.collectionGroup,T.collectionGroup);if(0!==R)return R;for(let P=0;P<Math.min(S.fields.length,T.fields.length);++P)if(0!==(R=indexSegmentComparator(S.fields[P],T.fields[P])))return R;return primitiveComparator(S.fields.length,T.fields.length)}function fieldIndexToString(S){return`id=${S.indexId}|cg=${S.collectionGroup}|f=${S.fields.map(S=>`${S.fieldPath}:${S.kind}`).join(",")}`}FieldIndex.UNKNOWN_ID=-1;let IndexSegment=class IndexSegment{constructor(S,T){this.fieldPath=S,this.kind=T}};function indexSegmentComparator(S,T){let R=FieldPath$1.comparator(S.fieldPath,T.fieldPath);return 0!==R?R:primitiveComparator(S.kind,T.kind)}let IndexState=class IndexState{constructor(S,T){this.sequenceNumber=S,this.offset=T}static empty(){return new IndexState(eh,IndexOffset.min())}};function newIndexOffsetSuccessorFromReadTime(S,T){let R=S.toTimestamp().seconds,P=S.toTimestamp().nanoseconds+1,O=SnapshotVersion.fromTimestamp(1e9===P?new Timestamp(R+1,0):new Timestamp(R,P));return new IndexOffset(O,DocumentKey.empty(),T)}function newIndexOffsetFromDocument(S){return new IndexOffset(S.readTime,S.key,ed)}let IndexOffset=class IndexOffset{constructor(S,T,R){this.readTime=S,this.documentKey=T,this.largestBatchId=R}static min(){return new IndexOffset(SnapshotVersion.min(),DocumentKey.empty(),ed)}static max(){return new IndexOffset(SnapshotVersion.max(),DocumentKey.empty(),ed)}};function indexOffsetComparator(S,T){let R=S.readTime.compareTo(T.readTime);return 0!==R||0!==(R=DocumentKey.comparator(S.documentKey,T.documentKey))?R:primitiveComparator(S.largestBatchId,T.largestBatchId)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ep="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";let PersistenceTransaction=class PersistenceTransaction{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(S){this.onCommittedListeners.push(S)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(S=>S())}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function ignoreIfPrimaryLeaseLoss(S){if(S.code===es.FAILED_PRECONDITION&&S.message===ep)logDebug("LocalStore","Unexpectedly lost primary lease");else throw S}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let PersistencePromise=class PersistencePromise{constructor(S){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,S(S=>{this.isDone=!0,this.result=S,this.nextCallback&&this.nextCallback(S)},S=>{this.isDone=!0,this.error=S,this.catchCallback&&this.catchCallback(S)})}catch(S){return this.next(void 0,S)}next(S,T){return(this.callbackAttached&&fail(),this.callbackAttached=!0,this.isDone)?this.error?this.wrapFailure(T,this.error):this.wrapSuccess(S,this.result):new PersistencePromise((R,P)=>{this.nextCallback=T=>{this.wrapSuccess(S,T).next(R,P)},this.catchCallback=S=>{this.wrapFailure(T,S).next(R,P)}})}toPromise(){return new Promise((S,T)=>{this.next(S,T)})}wrapUserFunction(S){try{let T=S();if(T instanceof PersistencePromise)return T;return PersistencePromise.resolve(T)}catch(S){return PersistencePromise.reject(S)}}wrapSuccess(S,T){return S?this.wrapUserFunction(()=>S(T)):PersistencePromise.resolve(T)}wrapFailure(S,T){return S?this.wrapUserFunction(()=>S(T)):PersistencePromise.reject(T)}static resolve(S){return new PersistencePromise((T,R)=>{T(S)})}static reject(S){return new PersistencePromise((T,R)=>{R(S)})}static waitFor(S){return new PersistencePromise((T,R)=>{let P=0,O=0,N=!1;S.forEach(S=>{++P,S.next(()=>{++O,N&&O===P&&T()},S=>R(S))}),N=!0,O===P&&T()})}static or(S){let T=PersistencePromise.resolve(!1);for(let R of S)T=T.next(S=>S?PersistencePromise.resolve(S):R());return T}static forEach(S,T){let R=[];return S.forEach((S,P)=>{R.push(T.call(this,S,P))}),this.waitFor(R)}static mapArray(S,T){return new PersistencePromise((R,P)=>{let O=S.length,N=Array(O),M=0;for(let L=0;L<O;L++){let V=L;T(S[V]).next(S=>{N[V]=S,++M===O&&R(N)},S=>P(S))}})}static doWhile(S,T){return new PersistencePromise((R,P)=>{let process=()=>{!0===S()?T().next(()=>{process()},P):R()};process()})}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ef="SimpleDb",em=3;let SimpleDbTransaction=class SimpleDbTransaction{constructor(S,T){this.action=S,this.transaction=T,this.aborted=!1,this.completionDeferred=new Deferred,this.transaction.oncomplete=()=>{this.completionDeferred.resolve()},this.transaction.onabort=()=>{T.error?this.completionDeferred.reject(new IndexedDbTransactionError(S,T.error)):this.completionDeferred.resolve()},this.transaction.onerror=T=>{let R=checkForAndReportiOSError(T.target.error);this.completionDeferred.reject(new IndexedDbTransactionError(S,R))}}static open(S,T,R,P){try{return new SimpleDbTransaction(T,S.transaction(P,R))}catch(S){throw new IndexedDbTransactionError(T,S)}}get completionPromise(){return this.completionDeferred.promise}abort(S){S&&this.completionDeferred.reject(S),this.aborted||(logDebug(ef,"Aborting transaction:",S?S.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}maybeCommit(){let S=this.transaction;this.aborted||"function"!=typeof S.commit||S.commit()}store(S){let T=this.transaction.objectStore(S);return new SimpleDbStore(T)}};let SimpleDb=class SimpleDb{constructor(S,T,R){this.name=S,this.version=T,this.schemaConverter=R;let P=SimpleDb.getIOSVersion(getUA());12.2===P&&logError("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(S){return logDebug(ef,"Removing database:",S),wrapRequest(window.indexedDB.deleteDatabase(S)).toPromise()}static isAvailable(){if(!isIndexedDBAvailable())return!1;if(SimpleDb.isMockPersistence())return!0;let S=getUA(),T=SimpleDb.getIOSVersion(S),R=0<T&&T<10,P=getAndroidVersion(S),O=0<P&&P<4.5;return!(S.indexOf("MSIE ")>0||S.indexOf("Trident/")>0||S.indexOf("Edge/")>0)&&!R&&!O}static isMockPersistence(){var S;return"undefined"!=typeof process&&(null===(S=process.env)||void 0===S?void 0:S.USE_MOCK_PERSISTENCE)==="YES"}static getStore(S,T){return S.store(T)}static getIOSVersion(S){let T=S.match(/i(?:phone|pad|pod) os ([\d_]+)/i),R=T?T[1].split("_").slice(0,2).join("."):"-1";return Number(R)}async ensureDb(S){return this.db||(logDebug(ef,"Opening database:",this.name),this.db=await new Promise((T,R)=>{let P=indexedDB.open(this.name,this.version);P.onsuccess=S=>{let R=S.target.result;T(R)},P.onblocked=()=>{R(new IndexedDbTransactionError(S,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},P.onerror=T=>{let P=T.target.error;"VersionError"===P.name?R(new FirestoreError(es.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===P.name?R(new FirestoreError(es.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+P)):R(new IndexedDbTransactionError(S,P))},P.onupgradeneeded=S=>{logDebug(ef,'Database "'+this.name+'" requires upgrade from version:',S.oldVersion);let T=S.target.result;this.schemaConverter.createOrUpgrade(T,P.transaction,S.oldVersion,this.version).next(()=>{logDebug(ef,"Database upgrade to version "+this.version+" complete")})}})),this.versionchangelistener&&(this.db.onversionchange=S=>this.versionchangelistener(S)),this.db}setVersionChangeListener(S){this.versionchangelistener=S,this.db&&(this.db.onversionchange=T=>S(T))}async runTransaction(S,T,R,P){let O="readonly"===T,N=0;for(;;){++N;try{this.db=await this.ensureDb(S);let T=SimpleDbTransaction.open(this.db,S,O?"readonly":"readwrite",R),N=P(T).next(S=>(T.maybeCommit(),S)).catch(S=>(T.abort(S),PersistencePromise.reject(S))).toPromise();return N.catch(()=>{}),await T.completionPromise,N}catch(R){let S=R,T="FirebaseError"!==S.name&&N<em;if(logDebug(ef,"Transaction failed with error:",S.message,"Retrying:",T),this.close(),!T)return Promise.reject(S)}}}close(){this.db&&this.db.close(),this.db=void 0}};function getAndroidVersion(S){let T=S.match(/Android ([\d.]+)/i),R=T?T[1].split(".").slice(0,2).join("."):"-1";return Number(R)}let IterationController=class IterationController{constructor(S){this.dbCursor=S,this.shouldStop=!1,this.nextKey=null}get isDone(){return this.shouldStop}get skipToKey(){return this.nextKey}set cursor(S){this.dbCursor=S}done(){this.shouldStop=!0}skip(S){this.nextKey=S}delete(){return wrapRequest(this.dbCursor.delete())}};let IndexedDbTransactionError=class IndexedDbTransactionError extends null{constructor(S,T){super(es.UNAVAILABLE,`IndexedDB transaction '${S}' failed: ${T}`),this.name="IndexedDbTransactionError"}};function isIndexedDbTransactionError(S){return"IndexedDbTransactionError"===S.name}let SimpleDbStore=class SimpleDbStore{constructor(S){this.store=S}put(S,T){let R;return void 0!==T?(logDebug(ef,"PUT",this.store.name,S,T),R=this.store.put(T,S)):(logDebug(ef,"PUT",this.store.name,"<auto-key>",S),R=this.store.put(S)),wrapRequest(R)}add(S){logDebug(ef,"ADD",this.store.name,S,S);let T=this.store.add(S);return wrapRequest(T)}get(S){let T=this.store.get(S);return wrapRequest(T).next(T=>(void 0===T&&(T=null),logDebug(ef,"GET",this.store.name,S,T),T))}delete(S){logDebug(ef,"DELETE",this.store.name,S);let T=this.store.delete(S);return wrapRequest(T)}count(){logDebug(ef,"COUNT",this.store.name);let S=this.store.count();return wrapRequest(S)}loadAll(S,T){let R=this.options(S,T),P=R.index?this.store.index(R.index):this.store;if("function"==typeof P.getAll){let S=P.getAll(R.range);return new PersistencePromise((T,R)=>{S.onerror=S=>{R(S.target.error)},S.onsuccess=S=>{T(S.target.result)}})}{let S=this.cursor(R),T=[];return this.iterateCursor(S,(S,R)=>{T.push(R)}).next(()=>T)}}loadFirst(S,T){let R=this.store.getAll(S,null===T?void 0:T);return new PersistencePromise((S,T)=>{R.onerror=S=>{T(S.target.error)},R.onsuccess=T=>{S(T.target.result)}})}deleteAll(S,T){logDebug(ef,"DELETE ALL",this.store.name);let R=this.options(S,T);R.keysOnly=!1;let P=this.cursor(R);return this.iterateCursor(P,(S,T,R)=>R.delete())}iterate(S,T){let R;T?R=S:(R={},T=S);let P=this.cursor(R);return this.iterateCursor(P,T)}iterateSerial(S){let T=this.cursor({});return new PersistencePromise((R,P)=>{T.onerror=S=>{let T=checkForAndReportiOSError(S.target.error);P(T)},T.onsuccess=T=>{let P=T.target.result;if(!P){R();return}S(P.primaryKey,P.value).next(S=>{S?P.continue():R()})}})}iterateCursor(S,T){let R=[];return new PersistencePromise((P,O)=>{S.onerror=S=>{O(S.target.error)},S.onsuccess=S=>{let O=S.target.result;if(!O){P();return}let N=new IterationController(O),M=T(O.primaryKey,O.value,N);if(M instanceof PersistencePromise){let S=M.catch(S=>(N.done(),PersistencePromise.reject(S)));R.push(S)}N.isDone?P():null===N.skipToKey?O.continue():O.continue(N.skipToKey)}}).next(()=>PersistencePromise.waitFor(R))}options(S,T){let R;return void 0!==S&&("string"==typeof S?R=S:T=S),{index:R,range:T}}cursor(S){let T="next";if(S.reverse&&(T="prev"),!S.index)return this.store.openCursor(S.range,T);{let R=this.store.index(S.index);return S.keysOnly?R.openKeyCursor(S.range,T):R.openCursor(S.range,T)}}};function wrapRequest(S){return new PersistencePromise((T,R)=>{S.onsuccess=S=>{let R=S.target.result;T(R)},S.onerror=S=>{let T=checkForAndReportiOSError(S.target.error);R(T)}})}let eg=!1;function checkForAndReportiOSError(S){let T=SimpleDb.getIOSVersion(getUA());if(T>=12.2&&T<13){let T="An internal error was encountered in the Indexed Database server";if(S.message.indexOf(T)>=0){let S=new FirestoreError("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${T}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eg||(eg=!0,setTimeout(()=>{throw S},0)),S}}return S}let ey="IndexBackfiller",ev=null,eS=null,eb=50;let IndexBackfillerScheduler=class IndexBackfillerScheduler{constructor(S,T){this.asyncQueue=S,this.backfiller=T,this.task=null}start(){this.schedule(ev)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}schedule(S){logDebug(ey,`Scheduled in ${S}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",S,async()=>{this.task=null;try{let S=await this.backfiller.backfill();logDebug(ey,`Documents written: ${S}`)}catch(S){isIndexedDbTransactionError(S)?logDebug(ey,"Ignoring IndexedDB error during index backfill: ",S):await ignoreIfPrimaryLeaseLoss(S)}await this.schedule(eS)})}};let IndexBackfiller=class IndexBackfiller{constructor(S,T){this.localStore=S,this.persistence=T}async backfill(S=eb){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",T=>this.writeIndexEntries(T,S))}writeIndexEntries(S,T){let R=new Set,P=T,O=!0;return PersistencePromise.doWhile(()=>!0===O&&P>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(S).next(T=>{if(!(null===T||R.has(T)))return logDebug(ey,`Processing collection: ${T}`),this.writeEntriesForCollectionGroup(S,T,P).next(S=>{P-=S,R.add(T)});O=!1})).next(()=>T-P)}writeEntriesForCollectionGroup(S,T,R){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(S,T).next(P=>this.localStore.localDocuments.getNextDocuments(S,T,P,R).next(R=>{let O=R.changes;return this.localStore.indexManager.updateIndexEntries(S,O).next(()=>this.getNewOffset(P,R)).next(R=>(logDebug(ey,`Updating offset: ${R}`),this.localStore.indexManager.updateCollectionGroup(S,T,R))).next(()=>O.size)}))}getNewOffset(S,T){let R=S;return T.changes.forEach((S,T)=>{let P=newIndexOffsetFromDocument(T);indexOffsetComparator(P,R)>0&&(R=P)}),new IndexOffset(R.readTime,R.documentKey,Math.max(T.batchId,S.largestBatchId))}};/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ListenSequence=class ListenSequence{constructor(S,T){this.previousValue=S,T&&(T.sequenceNumberHandler=S=>this.setPreviousValue(S),this.writeNewSequenceNumber=S=>T.writeSequenceNumber(S))}setPreviousValue(S){return this.previousValue=Math.max(S,this.previousValue),this.previousValue}next(){let S=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(S),S}};ListenSequence.INVALID=-1;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eC="\x01",eT="\x01",eE="\x10",ew="\x11";function encodeResourcePath(S){let T="";for(let R=0;R<S.length;R++)T.length>0&&(T=encodeSeparator(T)),T=encodeSegment(S.get(R),T);return encodeSeparator(T)}function encodeSegment(S,T){let R=T,P=S.length;for(let T=0;T<P;T++){let P=S.charAt(T);switch(P){case"\x00":R+=eC+eE;break;case eC:R+=eC+ew;break;default:R+=P}}return R}function encodeSeparator(S){return S+eC+eT}function decodeResourcePath(S){let T=S.length;if(hardAssert(T>=2),2===T)return hardAssert(S.charAt(0)===eC&&S.charAt(1)===eT),ResourcePath.emptyPath();let R=T-2,P=[],O="";for(let N=0;N<T;){let T=S.indexOf(eC,N);(T<0||T>R)&&fail();let M=S.charAt(T+1);switch(M){case eT:let L;let V=S.substring(N,T);0===O.length?L=V:(O+=V,L=O,O=""),P.push(L);break;case eE:O+=S.substring(N,T)+"\x00";break;case ew:O+=S.substring(N,T+1);break;default:fail()}N=T+2}return new ResourcePath(P)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let eD="remoteDocuments",eI="owner",eR="owner",e_="mutationQueues",eP="userId",eA="mutations",eO="batchId",eN="userMutationsIndex",ek=null;function newDbDocumentMutationPrefixForUser(S){return[S]}function newDbDocumentMutationPrefixForPath(S,T){return[S,encodeResourcePath(T)]}function newDbDocumentMutationKey(S,T,R){return[S,encodeResourcePath(T),R]}let ex={},eM="documentMutations",eF="remoteDocumentsV14",eL=null,eB="documentKeyIndex",eV=null,eU="collectionGroupIndex",ej=null,eq="remoteDocumentGlobal",ez="remoteDocumentGlobalKey",eW="targets",eK="targetId",eG="queryTargetsIndex",eQ=null,e$="targetDocuments",eH=null,eY="documentTargetsIndex",eJ=null,eX="targetGlobalKey",eZ="targetGlobal",e0="collectionParents",e1=null,e2="clientMetadata",e3="clientId",e6="bundles",e4="bundleId",e9="namedQueries",e5="name",e8="indexConfiguration",e7="indexId",te="collectionGroupIndex",tt="collectionGroup",tr="indexState",ti=null,ts="sequenceNumberIndex",ta=null,tl="indexEntries",tu=null,tc="documentKeyIndex",td=null,th="documentOverlays",tp=null,tf="collectionPathOverlayIndex",tm=null,tg="collectionGroupOverlayIndex",ty=null,tv="globals",tS="name",tb=[e_,eA,eM,eD,eW,eI,eZ,e$],tC=tb,tT=[...tC,e2],tE=[...tT,eq],tw=[...tE,e0],tD=[...tw,e6,e9],tI=[...tD,th],tR=[e_,eA,eM,eF,eW,eI,eZ,e$,e2,eq,e0,e6,e9,th],t_=tR,tP=[...t_,e8,tr,tl],tA=null,tO=[...tP,tv];function getObjectStores(S){return 17===S?tO:16===S?tA:15===S?tP:14===S?t_:13===S?tR:12===S?tI:11===S?tD:void fail()}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbTransaction=class IndexedDbTransaction extends null{constructor(S,T){super(),this.simpleDbTransaction=S,this.currentSequenceNumber=T}};function getStore(S,T){let R=debugCast(S);return SimpleDb.getStore(R.simpleDbTransaction,T)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function objectSize(S){let T=0;for(let R in S)Object.prototype.hasOwnProperty.call(S,R)&&T++;return T}function forEach(S,T){for(let R in S)Object.prototype.hasOwnProperty.call(S,R)&&T(R,S[R])}function isEmpty(S){for(let T in S)if(Object.prototype.hasOwnProperty.call(S,T))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SortedMap=class SortedMap{constructor(S,T){this.comparator=S,this.root=T||LLRBNode.EMPTY}insert(S,T){return new SortedMap(this.comparator,this.root.insert(S,T,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))}remove(S){return new SortedMap(this.comparator,this.root.remove(S,this.comparator).copy(null,null,LLRBNode.BLACK,null,null))}get(S){let T=this.root;for(;!T.isEmpty();){let R=this.comparator(S,T.key);if(0===R)return T.value;R<0?T=T.left:R>0&&(T=T.right)}return null}indexOf(S){let T=0,R=this.root;for(;!R.isEmpty();){let P=this.comparator(S,R.key);if(0===P)return T+R.left.size;P<0?R=R.left:(T+=R.left.size+1,R=R.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(S){return this.root.inorderTraversal(S)}forEach(S){this.inorderTraversal((T,R)=>(S(T,R),!1))}toString(){let S=[];return this.inorderTraversal((T,R)=>(S.push(`${T}:${R}`),!1)),`{${S.join(", ")}}`}reverseTraversal(S){return this.root.reverseTraversal(S)}getIterator(){return new SortedMapIterator(this.root,null,this.comparator,!1)}getIteratorFrom(S){return new SortedMapIterator(this.root,S,this.comparator,!1)}getReverseIterator(){return new SortedMapIterator(this.root,null,this.comparator,!0)}getReverseIteratorFrom(S){return new SortedMapIterator(this.root,S,this.comparator,!0)}};let SortedMapIterator=class SortedMapIterator{constructor(S,T,R,P){this.isReverse=P,this.nodeStack=[];let O=1;for(;!S.isEmpty();)if(O=T?R(S.key,T):1,T&&P&&(O*=-1),O<0)S=this.isReverse?S.left:S.right;else if(0===O){this.nodeStack.push(S);break}else this.nodeStack.push(S),S=this.isReverse?S.right:S.left}getNext(){let S=this.nodeStack.pop(),T={key:S.key,value:S.value};if(this.isReverse)for(S=S.left;!S.isEmpty();)this.nodeStack.push(S),S=S.right;else for(S=S.right;!S.isEmpty();)this.nodeStack.push(S),S=S.left;return T}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let S=this.nodeStack[this.nodeStack.length-1];return{key:S.key,value:S.value}}};let LLRBNode=class LLRBNode{constructor(S,T,R,P,O){this.key=S,this.value=T,this.color=null!=R?R:LLRBNode.RED,this.left=null!=P?P:LLRBNode.EMPTY,this.right=null!=O?O:LLRBNode.EMPTY,this.size=this.left.size+1+this.right.size}copy(S,T,R,P,O){return new LLRBNode(null!=S?S:this.key,null!=T?T:this.value,null!=R?R:this.color,null!=P?P:this.left,null!=O?O:this.right)}isEmpty(){return!1}inorderTraversal(S){return this.left.inorderTraversal(S)||S(this.key,this.value)||this.right.inorderTraversal(S)}reverseTraversal(S){return this.right.reverseTraversal(S)||S(this.key,this.value)||this.left.reverseTraversal(S)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(S,T,R){let P=this,O=R(S,P.key);return(P=O<0?P.copy(null,null,null,P.left.insert(S,T,R),null):0===O?P.copy(null,T,null,null,null):P.copy(null,null,null,null,P.right.insert(S,T,R))).fixUp()}removeMin(){if(this.left.isEmpty())return LLRBNode.EMPTY;let S=this;return S.left.isRed()||S.left.left.isRed()||(S=S.moveRedLeft()),(S=S.copy(null,null,null,S.left.removeMin(),null)).fixUp()}remove(S,T){let R;let P=this;if(0>T(S,P.key))P.left.isEmpty()||P.left.isRed()||P.left.left.isRed()||(P=P.moveRedLeft()),P=P.copy(null,null,null,P.left.remove(S,T),null);else{if(P.left.isRed()&&(P=P.rotateRight()),P.right.isEmpty()||P.right.isRed()||P.right.left.isRed()||(P=P.moveRedRight()),0===T(S,P.key)){if(P.right.isEmpty())return LLRBNode.EMPTY;R=P.right.min(),P=P.copy(R.key,R.value,null,null,P.right.removeMin())}P=P.copy(null,null,null,null,P.right.remove(S,T))}return P.fixUp()}isRed(){return this.color}fixUp(){let S=this;return S.right.isRed()&&!S.left.isRed()&&(S=S.rotateLeft()),S.left.isRed()&&S.left.left.isRed()&&(S=S.rotateRight()),S.left.isRed()&&S.right.isRed()&&(S=S.colorFlip()),S}moveRedLeft(){let S=this.colorFlip();return S.right.left.isRed()&&(S=(S=(S=S.copy(null,null,null,null,S.right.rotateRight())).rotateLeft()).colorFlip()),S}moveRedRight(){let S=this.colorFlip();return S.left.left.isRed()&&(S=(S=S.rotateRight()).colorFlip()),S}rotateLeft(){let S=this.copy(null,null,LLRBNode.RED,null,this.right.left);return this.right.copy(null,null,this.color,S,null)}rotateRight(){let S=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,S)}colorFlip(){let S=this.left.copy(null,null,!this.left.color,null,null),T=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,S,T)}checkMaxDepth(){let S=this.check();return Math.pow(2,S)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw fail();let S=this.left.check();if(S===this.right.check())return S+(this.isRed()?0:1);throw fail()}};LLRBNode.EMPTY=null,LLRBNode.RED=!0,LLRBNode.BLACK=!1;let LLRBEmptyNode=class LLRBEmptyNode{constructor(){this.size=0}get key(){throw fail()}get value(){throw fail()}get color(){throw fail()}get left(){throw fail()}get right(){throw fail()}copy(S,T,R,P,O){return this}insert(S,T,R){return new LLRBNode(S,T)}remove(S,T){return this}isEmpty(){return!0}inorderTraversal(S){return!1}reverseTraversal(S){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};LLRBNode.EMPTY=new LLRBEmptyNode;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SortedSet=class SortedSet{constructor(S){this.comparator=S,this.data=new SortedMap(this.comparator)}has(S){return null!==this.data.get(S)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(S){return this.data.indexOf(S)}forEach(S){this.data.inorderTraversal((T,R)=>(S(T),!1))}forEachInRange(S,T){let R=this.data.getIteratorFrom(S[0]);for(;R.hasNext();){let P=R.getNext();if(this.comparator(P.key,S[1])>=0)return;T(P.key)}}forEachWhile(S,T){let R;for(R=void 0!==T?this.data.getIteratorFrom(T):this.data.getIterator();R.hasNext();){let T=R.getNext(),P=S(T.key);if(!P)return}}firstAfterOrEqual(S){let T=this.data.getIteratorFrom(S);return T.hasNext()?T.getNext().key:null}getIterator(){return new SortedSetIterator(this.data.getIterator())}getIteratorFrom(S){return new SortedSetIterator(this.data.getIteratorFrom(S))}add(S){return this.copy(this.data.remove(S).insert(S,!0))}delete(S){return this.has(S)?this.copy(this.data.remove(S)):this}isEmpty(){return this.data.isEmpty()}unionWith(S){let T=this;return T.size<S.size&&(T=S,S=this),S.forEach(S=>{T=T.add(S)}),T}isEqual(S){if(!(S instanceof SortedSet)||this.size!==S.size)return!1;let T=this.data.getIterator(),R=S.data.getIterator();for(;T.hasNext();){let S=T.getNext().key,P=R.getNext().key;if(0!==this.comparator(S,P))return!1}return!0}toArray(){let S=[];return this.forEach(T=>{S.push(T)}),S}toString(){let S=[];return this.forEach(T=>S.push(T)),"SortedSet("+S.toString()+")"}copy(S){let T=new SortedSet(this.comparator);return T.data=S,T}};let SortedSetIterator=class SortedSetIterator{constructor(S){this.iter=S}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function diffSortedSets(S,T,R,P,O){let N=S.getIterator(),M=T.getIterator(),L=advanceIterator(N),V=advanceIterator(M);for(;L||V;){let S=!1,T=!1;if(L&&V){let P=R(L,V);P<0?T=!0:P>0&&(S=!0)}else null!=L?T=!0:S=!0;S?(P(V),V=advanceIterator(M)):T?(O(L),L=advanceIterator(N)):(L=advanceIterator(N),V=advanceIterator(M))}}function advanceIterator(S){return S.hasNext()?S.getNext():void 0}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let FieldMask=class FieldMask{constructor(S){this.fields=S,S.sort(FieldPath$1.comparator)}static empty(){return new FieldMask([])}unionWith(S){let T=new SortedSet(FieldPath$1.comparator);for(let S of this.fields)T=T.add(S);for(let R of S)T=T.add(R);return new FieldMask(T.toArray())}covers(S){for(let T of this.fields)if(T.isPrefixOf(S))return!0;return!1}isEqual(S){return arrayEquals(this.fields,S.fields,(S,T)=>S.isEqual(T))}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function decodeBase64(S){return Buffer.from(S,"base64").toString("binary")}function encodeBase64(S){return Buffer.from(S,"binary").toString("base64")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ByteString=class ByteString{constructor(S){this.binaryString=S}static fromBase64String(S){let T=decodeBase64(S);return new ByteString(T)}static fromUint8Array(S){let T=binaryStringFromUint8Array(S);return new ByteString(T)}[Symbol.iterator](){let S=0;return{next:()=>S<this.binaryString.length?{value:this.binaryString.charCodeAt(S++),done:!1}:{value:void 0,done:!0}}}toBase64(){return encodeBase64(this.binaryString)}toUint8Array(){return uint8ArrayFromBinaryString(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(S){return primitiveComparator(this.binaryString,S.binaryString)}isEqual(S){return this.binaryString===S.binaryString}};function binaryStringFromUint8Array(S){let T="";for(let R=0;R<S.length;++R)T+=String.fromCharCode(S[R]);return T}function uint8ArrayFromBinaryString(S){let T=new Uint8Array(S.length);for(let R=0;R<S.length;R++)T[R]=S.charCodeAt(R);return T}ByteString.EMPTY_BYTE_STRING=new ByteString("");/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tN=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function normalizeTimestamp(S){if(hardAssert(!!S),"string"==typeof S){let T=0,R=tN.exec(S);if(hardAssert(!!R),R[1]){let S=R[1];T=Number(S=(S+"000000000").substr(0,9))}let P=new Date(S),O=Math.floor(P.getTime()/1e3);return{seconds:O,nanos:T}}{let T=normalizeNumber(S.seconds),R=normalizeNumber(S.nanos);return{seconds:T,nanos:R}}}function normalizeNumber(S){return"number"==typeof S?S:"string"==typeof S?Number(S):0}function normalizeByteString(S){return"string"==typeof S?ByteString.fromBase64String(S):ByteString.fromUint8Array(S)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tk="server_timestamp",tM="__type__",tF="__previous_value__",tL="__local_write_time__";function isServerTimestamp(S){var T,R;let P=null===(R=((null===(T=null==S?void 0:S.mapValue)||void 0===T?void 0:T.fields)||{})[tM])||void 0===R?void 0:R.stringValue;return P===tk}function serverTimestamp$1(S,T){let R={fields:{[tM]:{stringValue:tk},[tL]:{timestampValue:{seconds:S.seconds,nanos:S.nanoseconds}}}};return T&&isServerTimestamp(T)&&(T=getPreviousValue(T)),T&&(R.fields[tF]=T),{mapValue:R}}function getPreviousValue(S){let T=S.mapValue.fields[tF];return isServerTimestamp(T)?getPreviousValue(T):T}function getLocalWriteTime(S){let T=normalizeTimestamp(S.mapValue.fields[tL].timestampValue);return new Timestamp(T.seconds,T.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DatabaseInfo=class DatabaseInfo{constructor(S,T,R,P,O,N,M,L,V){this.databaseId=S,this.appId=T,this.persistenceKey=R,this.host=P,this.ssl=O,this.forceLongPolling=N,this.autoDetectLongPolling=M,this.longPollingOptions=L,this.useFetchStreams=V}};let tB="(default)";let DatabaseId=class DatabaseId{constructor(S,T){this.projectId=S,this.database=T||tB}static empty(){return new DatabaseId("","")}get isDefaultDatabase(){return this.database===tB}isEqual(S){return S instanceof DatabaseId&&S.projectId===this.projectId&&S.database===this.database}};function databaseIdFromApp(S,T){if(!Object.prototype.hasOwnProperty.apply(S.options,["projectId"]))throw new FirestoreError(es.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new DatabaseId(S.options.projectId,T)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tV=-1;function isNullOrUndefined(S){return null==S}function isNegativeZero(S){return 0===S&&1/S==-1/0}function isSafeInteger(S){return"number"==typeof S&&Number.isInteger(S)&&!isNegativeZero(S)&&S<=Number.MAX_SAFE_INTEGER&&S>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tU="__type__",tj="__max__",tq={mapValue:{fields:{__type__:{stringValue:tj}}}},tz="__vector__",tW="value",tK={nullValue:"NULL_VALUE"};function typeOrder(S){return"nullValue"in S?0:"booleanValue"in S?1:"integerValue"in S||"doubleValue"in S?2:"timestampValue"in S?3:"stringValue"in S?5:"bytesValue"in S?6:"referenceValue"in S?7:"geoPointValue"in S?8:"arrayValue"in S?9:"mapValue"in S?isServerTimestamp(S)?4:isMaxValue(S)?9007199254740991:isVectorValue(S)?10:11:fail()}function valueEquals(S,T){if(S===T)return!0;let R=typeOrder(S),P=typeOrder(T);if(R!==P)return!1;switch(R){case 0:case 9007199254740991:return!0;case 1:return S.booleanValue===T.booleanValue;case 4:return getLocalWriteTime(S).isEqual(getLocalWriteTime(T));case 3:return timestampEquals(S,T);case 5:return S.stringValue===T.stringValue;case 6:return blobEquals(S,T);case 7:return S.referenceValue===T.referenceValue;case 8:return geoPointEquals(S,T);case 2:return numberEquals(S,T);case 9:return arrayEquals(S.arrayValue.values||[],T.arrayValue.values||[],valueEquals);case 10:case 11:return objectEquals(S,T);default:return fail()}}function timestampEquals(S,T){if("string"==typeof S.timestampValue&&"string"==typeof T.timestampValue&&S.timestampValue.length===T.timestampValue.length)return S.timestampValue===T.timestampValue;let R=normalizeTimestamp(S.timestampValue),P=normalizeTimestamp(T.timestampValue);return R.seconds===P.seconds&&R.nanos===P.nanos}function geoPointEquals(S,T){return normalizeNumber(S.geoPointValue.latitude)===normalizeNumber(T.geoPointValue.latitude)&&normalizeNumber(S.geoPointValue.longitude)===normalizeNumber(T.geoPointValue.longitude)}function blobEquals(S,T){return normalizeByteString(S.bytesValue).isEqual(normalizeByteString(T.bytesValue))}function numberEquals(S,T){if("integerValue"in S&&"integerValue"in T)return normalizeNumber(S.integerValue)===normalizeNumber(T.integerValue);if("doubleValue"in S&&"doubleValue"in T){let R=normalizeNumber(S.doubleValue),P=normalizeNumber(T.doubleValue);return R===P?isNegativeZero(R)===isNegativeZero(P):isNaN(R)&&isNaN(P)}return!1}function objectEquals(S,T){let R=S.mapValue.fields||{},P=T.mapValue.fields||{};if(objectSize(R)!==objectSize(P))return!1;for(let S in R)if(R.hasOwnProperty(S)&&(void 0===P[S]||!valueEquals(R[S],P[S])))return!1;return!0}function arrayValueContains(S,T){return void 0!==(S.values||[]).find(S=>valueEquals(S,T))}function valueCompare(S,T){if(S===T)return 0;let R=typeOrder(S),P=typeOrder(T);if(R!==P)return primitiveComparator(R,P);switch(R){case 0:case 9007199254740991:return 0;case 1:return primitiveComparator(S.booleanValue,T.booleanValue);case 2:return compareNumbers(S,T);case 3:return compareTimestamps(S.timestampValue,T.timestampValue);case 4:return compareTimestamps(getLocalWriteTime(S),getLocalWriteTime(T));case 5:return primitiveComparator(S.stringValue,T.stringValue);case 6:return compareBlobs(S.bytesValue,T.bytesValue);case 7:return compareReferences(S.referenceValue,T.referenceValue);case 8:return compareGeoPoints(S.geoPointValue,T.geoPointValue);case 9:return compareArrays(S.arrayValue,T.arrayValue);case 10:return compareVectors(S.mapValue,T.mapValue);case 11:return compareMaps(S.mapValue,T.mapValue);default:throw fail()}}function compareNumbers(S,T){let R=normalizeNumber(S.integerValue||S.doubleValue),P=normalizeNumber(T.integerValue||T.doubleValue);return R<P?-1:R>P?1:R===P?0:isNaN(R)?isNaN(P)?0:-1:1}function compareTimestamps(S,T){if("string"==typeof S&&"string"==typeof T&&S.length===T.length)return primitiveComparator(S,T);let R=normalizeTimestamp(S),P=normalizeTimestamp(T),O=primitiveComparator(R.seconds,P.seconds);return 0!==O?O:primitiveComparator(R.nanos,P.nanos)}function compareReferences(S,T){let R=S.split("/"),P=T.split("/");for(let S=0;S<R.length&&S<P.length;S++){let T=primitiveComparator(R[S],P[S]);if(0!==T)return T}return primitiveComparator(R.length,P.length)}function compareGeoPoints(S,T){let R=primitiveComparator(normalizeNumber(S.latitude),normalizeNumber(T.latitude));return 0!==R?R:primitiveComparator(normalizeNumber(S.longitude),normalizeNumber(T.longitude))}function compareBlobs(S,T){let R=normalizeByteString(S),P=normalizeByteString(T);return R.compareTo(P)}function compareArrays(S,T){let R=S.values||[],P=T.values||[];for(let S=0;S<R.length&&S<P.length;++S){let T=valueCompare(R[S],P[S]);if(T)return T}return primitiveComparator(R.length,P.length)}function compareVectors(S,T){var R,P,O,N;let M=S.fields||{},L=T.fields||{},V=null===(R=M[tW])||void 0===R?void 0:R.arrayValue,U=null===(P=L[tW])||void 0===P?void 0:P.arrayValue,W=primitiveComparator((null===(O=null==V?void 0:V.values)||void 0===O?void 0:O.length)||0,(null===(N=null==U?void 0:U.values)||void 0===N?void 0:N.length)||0);return 0!==W?W:compareArrays(V,U)}function compareMaps(S,T){if(S===tq.mapValue&&T===tq.mapValue)return 0;if(S===tq.mapValue)return 1;if(T===tq.mapValue)return -1;let R=S.fields||{},P=Object.keys(R),O=T.fields||{},N=Object.keys(O);P.sort(),N.sort();for(let S=0;S<P.length&&S<N.length;++S){let T=primitiveComparator(P[S],N[S]);if(0!==T)return T;let M=valueCompare(R[P[S]],O[N[S]]);if(0!==M)return M}return primitiveComparator(P.length,N.length)}function canonicalId(S){return canonifyValue(S)}function canonifyValue(S){if("nullValue"in S)return"null";if("booleanValue"in S)return""+S.booleanValue;if("integerValue"in S)return""+S.integerValue;if("doubleValue"in S)return""+S.doubleValue;if("timestampValue"in S)return canonifyTimestamp(S.timestampValue);if("stringValue"in S)return S.stringValue;if("bytesValue"in S)return canonifyByteString(S.bytesValue);else if("referenceValue"in S)return canonifyReference(S.referenceValue);else if("geoPointValue"in S)return canonifyGeoPoint(S.geoPointValue);else if("arrayValue"in S)return canonifyArray(S.arrayValue);else if("mapValue"in S)return canonifyMap(S.mapValue);else return fail()}function canonifyByteString(S){return normalizeByteString(S).toBase64()}function canonifyTimestamp(S){let T=normalizeTimestamp(S);return`time(${T.seconds},${T.nanos})`}function canonifyGeoPoint(S){return`geo(${S.latitude},${S.longitude})`}function canonifyReference(S){return DocumentKey.fromName(S).toString()}function canonifyMap(S){let T=Object.keys(S.fields||{}).sort(),R="{",P=!0;for(let O of T)P?P=!1:R+=",",R+=`${O}:${canonifyValue(S.fields[O])}`;return R+"}"}function canonifyArray(S){let T="[",R=!0;for(let P of S.values||[])R?R=!1:T+=",",T+=canonifyValue(P);return T+"]"}function estimateByteSize(S){switch(typeOrder(S)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let T=getPreviousValue(S);return T?16+estimateByteSize(T):16;case 5:return 2*S.stringValue.length;case 6:return normalizeByteString(S.bytesValue).approximateByteSize();case 7:return S.referenceValue.length;case 9:return estimateArrayByteSize(S.arrayValue);case 10:case 11:return estimateMapByteSize(S.mapValue);default:throw fail()}}function estimateMapByteSize(S){let T=0;return forEach(S.fields,(S,R)=>{T+=S.length+estimateByteSize(R)}),T}function estimateArrayByteSize(S){return(S.values||[]).reduce((S,T)=>S+estimateByteSize(T),0)}function refValue(S,T){return{referenceValue:`projects/${S.projectId}/databases/${S.database}/documents/${T.path.canonicalString()}`}}function isInteger(S){return!!S&&"integerValue"in S}function isDouble(S){return!!S&&"doubleValue"in S}function isNumber(S){return isInteger(S)||isDouble(S)}function isArray(S){return!!S&&"arrayValue"in S}function isNullValue(S){return!!S&&"nullValue"in S}function isNanValue(S){return!!S&&"doubleValue"in S&&isNaN(Number(S.doubleValue))}function isMapValue(S){return!!S&&"mapValue"in S}function isVectorValue(S){var T,R;let P=null===(R=((null===(T=null==S?void 0:S.mapValue)||void 0===T?void 0:T.fields)||{})[tU])||void 0===R?void 0:R.stringValue;return P===tz}function deepClone(S){if(S.geoPointValue)return{geoPointValue:Object.assign({},S.geoPointValue)};if(S.timestampValue&&"object"==typeof S.timestampValue)return{timestampValue:Object.assign({},S.timestampValue)};if(S.mapValue){let T={mapValue:{fields:{}}};return forEach(S.mapValue.fields,(S,R)=>T.mapValue.fields[S]=deepClone(R)),T}{if(!S.arrayValue)return Object.assign({},S);let T={arrayValue:{values:[]}};for(let R=0;R<(S.arrayValue.values||[]).length;++R)T.arrayValue.values[R]=deepClone(S.arrayValue.values[R]);return T}}function isMaxValue(S){return(((S.mapValue||{}).fields||{}).__type__||{}).stringValue===tj}let tG={mapValue:{fields:{[tU]:{stringValue:tz},[tW]:{arrayValue:{}}}}};function valuesGetLowerBound(S){if("nullValue"in S)return tK;if("booleanValue"in S)return{booleanValue:!1};if("integerValue"in S||"doubleValue"in S)return{doubleValue:NaN};if("timestampValue"in S)return{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}};if("stringValue"in S)return{stringValue:""};if("bytesValue"in S)return{bytesValue:""};if("referenceValue"in S)return refValue(DatabaseId.empty(),DocumentKey.empty());else if("geoPointValue"in S)return{geoPointValue:{latitude:-90,longitude:-180}};else if("arrayValue"in S)return{arrayValue:{}};else if(!("mapValue"in S))return fail();else return isVectorValue(S)?tG:{mapValue:{}}}function valuesGetUpperBound(S){if("nullValue"in S)return{booleanValue:!1};if("booleanValue"in S)return{doubleValue:NaN};if("integerValue"in S||"doubleValue"in S)return{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}};if("timestampValue"in S)return{stringValue:""};if("stringValue"in S)return{bytesValue:""};if("bytesValue"in S)return refValue(DatabaseId.empty(),DocumentKey.empty());if("referenceValue"in S)return{geoPointValue:{latitude:-90,longitude:-180}};else if("geoPointValue"in S)return{arrayValue:{}};else if("arrayValue"in S)return tG;else if(!("mapValue"in S))return fail();else return isVectorValue(S)?{mapValue:{}}:tq}function lowerBoundCompare(S,T){let R=valueCompare(S.value,T.value);return 0!==R?R:S.inclusive&&!T.inclusive?-1:!S.inclusive&&T.inclusive?1:0}function upperBoundCompare(S,T){let R=valueCompare(S.value,T.value);return 0!==R?R:S.inclusive&&!T.inclusive?1:!S.inclusive&&T.inclusive?-1:0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ObjectValue=class ObjectValue{constructor(S){this.value=S}static empty(){return new ObjectValue({mapValue:{}})}field(S){if(S.isEmpty())return this.value;{let T=this.value;for(let R=0;R<S.length-1;++R)if(!isMapValue(T=(T.mapValue.fields||{})[S.get(R)]))return null;return(T=(T.mapValue.fields||{})[S.lastSegment()])||null}}set(S,T){let R=this.getFieldsMap(S.popLast());R[S.lastSegment()]=deepClone(T)}setAll(S){let T=FieldPath$1.emptyPath(),R={},P=[];S.forEach((S,O)=>{if(!T.isImmediateParentOf(O)){let S=this.getFieldsMap(T);this.applyChanges(S,R,P),R={},P=[],T=O.popLast()}S?R[O.lastSegment()]=deepClone(S):P.push(O.lastSegment())});let O=this.getFieldsMap(T);this.applyChanges(O,R,P)}delete(S){let T=this.field(S.popLast());isMapValue(T)&&T.mapValue.fields&&delete T.mapValue.fields[S.lastSegment()]}isEqual(S){return valueEquals(this.value,S.value)}getFieldsMap(S){let T=this.value;T.mapValue.fields||(T.mapValue={fields:{}});for(let R=0;R<S.length;++R){let P=T.mapValue.fields[S.get(R)];isMapValue(P)&&P.mapValue.fields||(P={mapValue:{fields:{}}},T.mapValue.fields[S.get(R)]=P),T=P}return T.mapValue.fields}applyChanges(S,T,R){for(let P of(forEach(T,(T,R)=>S[T]=R),R))delete S[P]}clone(){return new ObjectValue(deepClone(this.value))}};function extractFieldMask(S){let T=[];return forEach(S.fields,(S,R)=>{let P=new FieldPath$1([S]);if(isMapValue(R)){let S=extractFieldMask(R.mapValue),O=S.fields;if(0===O.length)T.push(P);else for(let S of O)T.push(P.child(S))}else T.push(P)}),new FieldMask(T)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MutableDocument=class MutableDocument{constructor(S,T,R,P,O,N,M){this.key=S,this.documentType=T,this.version=R,this.readTime=P,this.createTime=O,this.data=N,this.documentState=M}static newInvalidDocument(S){return new MutableDocument(S,0,SnapshotVersion.min(),SnapshotVersion.min(),SnapshotVersion.min(),ObjectValue.empty(),0)}static newFoundDocument(S,T,R,P){return new MutableDocument(S,1,T,SnapshotVersion.min(),R,P,0)}static newNoDocument(S,T){return new MutableDocument(S,2,T,SnapshotVersion.min(),SnapshotVersion.min(),ObjectValue.empty(),0)}static newUnknownDocument(S,T){return new MutableDocument(S,3,T,SnapshotVersion.min(),SnapshotVersion.min(),ObjectValue.empty(),2)}convertToFoundDocument(S,T){return this.createTime.isEqual(SnapshotVersion.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=S),this.version=S,this.documentType=1,this.data=T,this.documentState=0,this}convertToNoDocument(S){return this.version=S,this.documentType=2,this.data=ObjectValue.empty(),this.documentState=0,this}convertToUnknownDocument(S){return this.version=S,this.documentType=3,this.data=ObjectValue.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=SnapshotVersion.min(),this}setReadTime(S){return this.readTime=S,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(S){return S instanceof MutableDocument&&this.key.isEqual(S.key)&&this.version.isEqual(S.version)&&this.documentType===S.documentType&&this.documentState===S.documentState&&this.data.isEqual(S.data)}mutableCopy(){return new MutableDocument(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};function compareDocumentsByField(S,T,R){let P=T.data.field(S),O=R.data.field(S);return null!==P&&null!==O?valueCompare(P,O):fail()}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Bound=class Bound{constructor(S,T){this.position=S,this.inclusive=T}};function boundCompareToDocument(S,T,R){let P=0;for(let O=0;O<S.position.length;O++){let N=T[O],M=S.position[O];if(N.field.isKeyField())P=DocumentKey.comparator(DocumentKey.fromName(M.referenceValue),R.key);else{let S=R.data.field(N.field);P=valueCompare(M,S)}if("desc"===N.dir&&(P*=-1),0!==P)break}return P}function boundSortsAfterDocument(S,T,R){let P=boundCompareToDocument(S,T,R);return S.inclusive?P>=0:P>0}function boundSortsBeforeDocument(S,T,R){let P=boundCompareToDocument(S,T,R);return S.inclusive?P<=0:P<0}function boundEquals(S,T){if(null===S)return null===T;if(null===T||S.inclusive!==T.inclusive||S.position.length!==T.position.length)return!1;for(let R=0;R<S.position.length;R++){let P=S.position[R],O=T.position[R];if(!valueEquals(P,O))return!1}return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let OrderBy=class OrderBy{constructor(S,T="asc"){this.field=S,this.dir=T}};function canonifyOrderBy(S){return S.field.canonicalString()+S.dir}function stringifyOrderBy(S){return`${S.field.canonicalString()} (${S.dir})`}function orderByEquals(S,T){return S.dir===T.dir&&S.field.isEqual(T.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Filter=class Filter{};let FieldFilter=class FieldFilter extends Filter{constructor(S,T,R){super(),this.field=S,this.op=T,this.value=R}static create(S,T,R){return S.isKeyField()?"in"===T||"not-in"===T?this.createKeyFieldInFilter(S,T,R):new KeyFieldFilter(S,T,R):"array-contains"===T?new ArrayContainsFilter(S,R):"in"===T?new InFilter(S,R):"not-in"===T?new NotInFilter(S,R):"array-contains-any"===T?new ArrayContainsAnyFilter(S,R):new FieldFilter(S,T,R)}static createKeyFieldInFilter(S,T,R){return"in"===T?new KeyFieldInFilter(S,R):new KeyFieldNotInFilter(S,R)}matches(S){let T=S.data.field(this.field);return"!="===this.op?null!==T&&this.matchesComparison(valueCompare(T,this.value)):null!==T&&typeOrder(this.value)===typeOrder(T)&&this.matchesComparison(valueCompare(T,this.value))}matchesComparison(S){switch(this.op){case"<":return S<0;case"<=":return S<=0;case"==":return 0===S;case"!=":return 0!==S;case">":return S>0;case">=":return S>=0;default:return fail()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}};let CompositeFilter=class CompositeFilter extends Filter{constructor(S,T){super(),this.filters=S,this.op=T,this.memoizedFlattenedFilters=null}static create(S,T){return new CompositeFilter(S,T)}matches(S){return compositeFilterIsConjunction(this)?void 0===this.filters.find(T=>!T.matches(S)):void 0!==this.filters.find(T=>T.matches(S))}getFlattenedFilters(){return null!==this.memoizedFlattenedFilters||(this.memoizedFlattenedFilters=this.filters.reduce((S,T)=>S.concat(T.getFlattenedFilters()),[])),this.memoizedFlattenedFilters}getFilters(){return Object.assign([],this.filters)}};function compositeFilterIsConjunction(S){return"and"===S.op}function compositeFilterIsDisjunction(S){return"or"===S.op}function compositeFilterIsFlatConjunction(S){return compositeFilterIsFlat(S)&&compositeFilterIsConjunction(S)}function compositeFilterIsFlat(S){for(let T of S.filters)if(T instanceof CompositeFilter)return!1;return!0}function canonifyFilter(S){if(S instanceof FieldFilter)return S.field.canonicalString()+S.op.toString()+canonicalId(S.value);if(compositeFilterIsFlatConjunction(S))return S.filters.map(S=>canonifyFilter(S)).join(",");{let T=S.filters.map(S=>canonifyFilter(S)).join(",");return`${S.op}(${T})`}}function filterEquals(S,T){return S instanceof FieldFilter?fieldFilterEquals(S,T):S instanceof CompositeFilter?compositeFilterEquals(S,T):void fail()}function fieldFilterEquals(S,T){return T instanceof FieldFilter&&S.op===T.op&&S.field.isEqual(T.field)&&valueEquals(S.value,T.value)}function compositeFilterEquals(S,T){if(T instanceof CompositeFilter&&S.op===T.op&&S.filters.length===T.filters.length){let R=S.filters.reduce((S,R,P)=>S&&filterEquals(R,T.filters[P]),!0);return R}return!1}function compositeFilterWithAddedFilters(S,T){let R=S.filters.concat(T);return CompositeFilter.create(R,S.op)}function stringifyFilter(S){return S instanceof FieldFilter?stringifyFieldFilter(S):S instanceof CompositeFilter?stringifyCompositeFilter(S):"Filter"}function stringifyCompositeFilter(S){return S.op.toString()+" {"+S.getFilters().map(stringifyFilter).join(" ,")+"}"}function stringifyFieldFilter(S){return`${S.field.canonicalString()} ${S.op} ${canonicalId(S.value)}`}let KeyFieldFilter=class KeyFieldFilter extends FieldFilter{constructor(S,T,R){super(S,T,R),this.key=DocumentKey.fromName(R.referenceValue)}matches(S){let T=DocumentKey.comparator(S.key,this.key);return this.matchesComparison(T)}};let KeyFieldInFilter=class KeyFieldInFilter extends FieldFilter{constructor(S,T){super(S,"in",T),this.keys=extractDocumentKeysFromArrayValue("in",T)}matches(S){return this.keys.some(T=>T.isEqual(S.key))}};let KeyFieldNotInFilter=class KeyFieldNotInFilter extends FieldFilter{constructor(S,T){super(S,"not-in",T),this.keys=extractDocumentKeysFromArrayValue("not-in",T)}matches(S){return!this.keys.some(T=>T.isEqual(S.key))}};function extractDocumentKeysFromArrayValue(S,T){var R;return((null===(R=T.arrayValue)||void 0===R?void 0:R.values)||[]).map(S=>DocumentKey.fromName(S.referenceValue))}let ArrayContainsFilter=class ArrayContainsFilter extends FieldFilter{constructor(S,T){super(S,"array-contains",T)}matches(S){let T=S.data.field(this.field);return isArray(T)&&arrayValueContains(T.arrayValue,this.value)}};let InFilter=class InFilter extends FieldFilter{constructor(S,T){super(S,"in",T)}matches(S){let T=S.data.field(this.field);return null!==T&&arrayValueContains(this.value.arrayValue,T)}};let NotInFilter=class NotInFilter extends FieldFilter{constructor(S,T){super(S,"not-in",T)}matches(S){if(arrayValueContains(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let T=S.data.field(this.field);return null!==T&&!arrayValueContains(this.value.arrayValue,T)}};let ArrayContainsAnyFilter=class ArrayContainsAnyFilter extends FieldFilter{constructor(S,T){super(S,"array-contains-any",T)}matches(S){let T=S.data.field(this.field);return!!isArray(T)&&!!T.arrayValue.values&&T.arrayValue.values.some(S=>arrayValueContains(this.value.arrayValue,S))}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let TargetImpl=class TargetImpl{constructor(S,T=null,R=[],P=[],O=null,N=null,M=null){this.path=S,this.collectionGroup=T,this.orderBy=R,this.filters=P,this.limit=O,this.startAt=N,this.endAt=M,this.memoizedCanonicalId=null}};function newTarget(S,T=null,R=[],P=[],O=null,N=null,M=null){return new TargetImpl(S,T,R,P,O,N,M)}function canonifyTarget(S){let T=debugCast(S);if(null===T.memoizedCanonicalId){let S=T.path.canonicalString();null!==T.collectionGroup&&(S+="|cg:"+T.collectionGroup),S+="|f:"+T.filters.map(S=>canonifyFilter(S)).join(",")+"|ob:"+T.orderBy.map(S=>canonifyOrderBy(S)).join(","),isNullOrUndefined(T.limit)||(S+="|l:"+T.limit),T.startAt&&(S+="|lb:"+(T.startAt.inclusive?"b:":"a:")+T.startAt.position.map(S=>canonicalId(S)).join(",")),T.endAt&&(S+="|ub:"+(T.endAt.inclusive?"a:":"b:")+T.endAt.position.map(S=>canonicalId(S)).join(",")),T.memoizedCanonicalId=S}return T.memoizedCanonicalId}function stringifyTarget(S){let T=S.path.canonicalString();return null!==S.collectionGroup&&(T+=" collectionGroup="+S.collectionGroup),S.filters.length>0&&(T+=`, filters: [${S.filters.map(S=>stringifyFilter(S)).join(", ")}]`),isNullOrUndefined(S.limit)||(T+=", limit: "+S.limit),S.orderBy.length>0&&(T+=`, orderBy: [${S.orderBy.map(S=>stringifyOrderBy(S)).join(", ")}]`),S.startAt&&(T+=", startAt: "+(S.startAt.inclusive?"b:":"a:")+S.startAt.position.map(S=>canonicalId(S)).join(",")),S.endAt&&(T+=", endAt: "+(S.endAt.inclusive?"a:":"b:")+S.endAt.position.map(S=>canonicalId(S)).join(",")),`Target(${T})`}function targetEquals(S,T){if(S.limit!==T.limit||S.orderBy.length!==T.orderBy.length)return!1;for(let R=0;R<S.orderBy.length;R++)if(!orderByEquals(S.orderBy[R],T.orderBy[R]))return!1;if(S.filters.length!==T.filters.length)return!1;for(let R=0;R<S.filters.length;R++)if(!filterEquals(S.filters[R],T.filters[R]))return!1;return!!(S.collectionGroup===T.collectionGroup&&S.path.isEqual(T.path)&&boundEquals(S.startAt,T.startAt))&&boundEquals(S.endAt,T.endAt)}function targetIsDocumentTarget(S){return DocumentKey.isDocumentKey(S.path)&&null===S.collectionGroup&&0===S.filters.length}function targetGetFieldFiltersForPath(S,T){return S.filters.filter(S=>S instanceof FieldFilter&&S.field.isEqual(T))}function targetGetArrayValues(S,T){let R=fieldIndexGetArraySegment(T);if(void 0===R)return null;for(let T of targetGetFieldFiltersForPath(S,R.fieldPath))switch(T.op){case"array-contains-any":return T.value.arrayValue.values||[];case"array-contains":return[T.value]}return null}function targetGetNotInValues(S,T){let R=new Map;for(let P of fieldIndexGetDirectionalSegments(T))for(let T of targetGetFieldFiltersForPath(S,P.fieldPath))switch(T.op){case"==":case"in":R.set(P.fieldPath.canonicalString(),T.value);break;case"not-in":case"!=":return R.set(P.fieldPath.canonicalString(),T.value),Array.from(R.values())}return null}function targetGetLowerBound(S,T){let R=[],P=!0;for(let O of fieldIndexGetDirectionalSegments(T)){let T=0===O.kind?targetGetAscendingBound(S,O.fieldPath,S.startAt):targetGetDescendingBound(S,O.fieldPath,S.startAt);R.push(T.value),P&&(P=T.inclusive)}return new Bound(R,P)}function targetGetUpperBound(S,T){let R=[],P=!0;for(let O of fieldIndexGetDirectionalSegments(T)){let T=0===O.kind?targetGetDescendingBound(S,O.fieldPath,S.endAt):targetGetAscendingBound(S,O.fieldPath,S.endAt);R.push(T.value),P&&(P=T.inclusive)}return new Bound(R,P)}function targetGetAscendingBound(S,T,R){let P=tK,O=!0;for(let R of targetGetFieldFiltersForPath(S,T)){let S=tK,T=!0;switch(R.op){case"<":case"<=":S=valuesGetLowerBound(R.value);break;case"==":case"in":case">=":S=R.value;break;case">":S=R.value,T=!1;break;case"!=":case"not-in":S=tK}0>lowerBoundCompare({value:P,inclusive:O},{value:S,inclusive:T})&&(P=S,O=T)}if(null!==R)for(let N=0;N<S.orderBy.length;++N){let M=S.orderBy[N];if(M.field.isEqual(T)){let S=R.position[N];0>lowerBoundCompare({value:P,inclusive:O},{value:S,inclusive:R.inclusive})&&(P=S,O=R.inclusive);break}}return{value:P,inclusive:O}}function targetGetDescendingBound(S,T,R){let P=tq,O=!0;for(let R of targetGetFieldFiltersForPath(S,T)){let S=tq,T=!0;switch(R.op){case">=":case">":S=valuesGetUpperBound(R.value),T=!1;break;case"==":case"in":case"<=":S=R.value;break;case"<":S=R.value,T=!1;break;case"!=":case"not-in":S=tq}upperBoundCompare({value:P,inclusive:O},{value:S,inclusive:T})>0&&(P=S,O=T)}if(null!==R)for(let N=0;N<S.orderBy.length;++N){let M=S.orderBy[N];if(M.field.isEqual(T)){let S=R.position[N];upperBoundCompare({value:P,inclusive:O},{value:S,inclusive:R.inclusive})>0&&(P=S,O=R.inclusive);break}}return{value:P,inclusive:O}}function targetGetSegmentCount(S){let T=new SortedSet(FieldPath$1.comparator),R=!1;for(let P of S.filters)for(let S of P.getFlattenedFilters())S.field.isKeyField()||("array-contains"===S.op||"array-contains-any"===S.op?R=!0:T=T.add(S.field));for(let R of S.orderBy)R.field.isKeyField()||(T=T.add(R.field));return T.size+(R?1:0)}function targetHasLimit(S){return null!==S.limit}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let QueryImpl=class QueryImpl{constructor(S,T=null,R=[],P=[],O=null,N="F",M=null,L=null){this.path=S,this.collectionGroup=T,this.explicitOrderBy=R,this.filters=P,this.limit=O,this.limitType=N,this.startAt=M,this.endAt=L,this.memoizedNormalizedOrderBy=null,this.memoizedTarget=null,this.memoizedAggregateTarget=null,this.startAt,this.endAt}};function newQuery(S,T,R,P,O,N,M,L){return new QueryImpl(S,T,R,P,O,N,M,L)}function newQueryForPath(S){return new QueryImpl(S)}function asCollectionQueryAtPath(S,T){return new QueryImpl(T,null,S.explicitOrderBy.slice(),S.filters.slice(),S.limit,S.limitType,S.startAt,S.endAt)}function queryMatchesAllDocuments(S){return 0===S.filters.length&&null===S.limit&&null==S.startAt&&null==S.endAt&&(0===S.explicitOrderBy.length||1===S.explicitOrderBy.length&&S.explicitOrderBy[0].field.isKeyField())}function getInequalityFilterFields(S){let T=new SortedSet(FieldPath$1.comparator);return S.filters.forEach(S=>{let R=S.getFlattenedFilters();R.forEach(S=>{S.isInequality()&&(T=T.add(S.field))})}),T}function isDocumentQuery$1(S){return DocumentKey.isDocumentKey(S.path)&&null===S.collectionGroup&&0===S.filters.length}function isCollectionGroupQuery(S){return null!==S.collectionGroup}function queryNormalizedOrderBy(S){let T=debugCast(S);if(null===T.memoizedNormalizedOrderBy){T.memoizedNormalizedOrderBy=[];let S=new Set;for(let R of T.explicitOrderBy)T.memoizedNormalizedOrderBy.push(R),S.add(R.field.canonicalString());let R=T.explicitOrderBy.length>0?T.explicitOrderBy[T.explicitOrderBy.length-1].dir:"asc",P=getInequalityFilterFields(T);P.forEach(P=>{S.has(P.canonicalString())||P.isKeyField()||T.memoizedNormalizedOrderBy.push(new OrderBy(P,R))}),S.has(FieldPath$1.keyField().canonicalString())||T.memoizedNormalizedOrderBy.push(new OrderBy(FieldPath$1.keyField(),R))}return T.memoizedNormalizedOrderBy}function queryToTarget(S){let T=debugCast(S);return T.memoizedTarget||(T.memoizedTarget=_queryToTarget(T,queryNormalizedOrderBy(S))),T.memoizedTarget}function queryToAggregateTarget(S){let T=debugCast(S);return T.memoizedAggregateTarget||(T.memoizedAggregateTarget=_queryToTarget(T,S.explicitOrderBy)),T.memoizedAggregateTarget}function _queryToTarget(S,T){if("F"===S.limitType)return newTarget(S.path,S.collectionGroup,T,S.filters,S.limit,S.startAt,S.endAt);{T=T.map(S=>{let T="desc"===S.dir?"asc":"desc";return new OrderBy(S.field,T)});let R=S.endAt?new Bound(S.endAt.position,S.endAt.inclusive):null,P=S.startAt?new Bound(S.startAt.position,S.startAt.inclusive):null;return newTarget(S.path,S.collectionGroup,T,S.filters,S.limit,R,P)}}function queryWithAddedFilter(S,T){let R=S.filters.concat([T]);return new QueryImpl(S.path,S.collectionGroup,S.explicitOrderBy.slice(),R,S.limit,S.limitType,S.startAt,S.endAt)}function queryWithAddedOrderBy(S,T){let R=S.explicitOrderBy.concat([T]);return new QueryImpl(S.path,S.collectionGroup,R,S.filters.slice(),S.limit,S.limitType,S.startAt,S.endAt)}function queryWithLimit(S,T,R){return new QueryImpl(S.path,S.collectionGroup,S.explicitOrderBy.slice(),S.filters.slice(),T,R,S.startAt,S.endAt)}function queryWithStartAt(S,T){return new QueryImpl(S.path,S.collectionGroup,S.explicitOrderBy.slice(),S.filters.slice(),S.limit,S.limitType,T,S.endAt)}function queryWithEndAt(S,T){return new QueryImpl(S.path,S.collectionGroup,S.explicitOrderBy.slice(),S.filters.slice(),S.limit,S.limitType,S.startAt,T)}function queryEquals(S,T){return targetEquals(queryToTarget(S),queryToTarget(T))&&S.limitType===T.limitType}function canonifyQuery(S){return`${canonifyTarget(queryToTarget(S))}|lt:${S.limitType}`}function stringifyQuery(S){return`Query(target=${stringifyTarget(queryToTarget(S))}; limitType=${S.limitType})`}function queryMatches(S,T){return T.isFoundDocument()&&queryMatchesPathAndCollectionGroup(S,T)&&queryMatchesOrderBy(S,T)&&queryMatchesFilters(S,T)&&queryMatchesBounds(S,T)}function queryMatchesPathAndCollectionGroup(S,T){let R=T.key.path;return null!==S.collectionGroup?T.key.hasCollectionId(S.collectionGroup)&&S.path.isPrefixOf(R):DocumentKey.isDocumentKey(S.path)?S.path.isEqual(R):S.path.isImmediateParentOf(R)}function queryMatchesOrderBy(S,T){for(let R of queryNormalizedOrderBy(S))if(!R.field.isKeyField()&&null===T.data.field(R.field))return!1;return!0}function queryMatchesFilters(S,T){for(let R of S.filters)if(!R.matches(T))return!1;return!0}function queryMatchesBounds(S,T){return(!S.startAt||!!boundSortsBeforeDocument(S.startAt,queryNormalizedOrderBy(S),T))&&(!S.endAt||!!boundSortsAfterDocument(S.endAt,queryNormalizedOrderBy(S),T))}function queryCollectionGroup(S){return S.collectionGroup||(S.path.length%2==1?S.path.lastSegment():S.path.get(S.path.length-2))}function newQueryComparator(S){return(T,R)=>{let P=!1;for(let O of queryNormalizedOrderBy(S)){let S=compareDocs(O,T,R);if(0!==S)return S;P=P||O.field.isKeyField()}return 0}}function compareDocs(S,T,R){let P=S.field.isKeyField()?DocumentKey.comparator(T.key,R.key):compareDocumentsByField(S.field,T,R);switch(S.dir){case"asc":return P;case"desc":return -1*P;default:return fail()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ObjectMap=class ObjectMap{constructor(S,T){this.mapKeyFn=S,this.equalsFn=T,this.inner={},this.innerSize=0}get(S){let T=this.mapKeyFn(S),R=this.inner[T];if(void 0!==R){for(let[T,P]of R)if(this.equalsFn(T,S))return P}}has(S){return void 0!==this.get(S)}set(S,T){let R=this.mapKeyFn(S),P=this.inner[R];if(void 0===P){this.inner[R]=[[S,T]],this.innerSize++;return}for(let R=0;R<P.length;R++)if(this.equalsFn(P[R][0],S)){P[R]=[S,T];return}P.push([S,T]),this.innerSize++}delete(S){let T=this.mapKeyFn(S),R=this.inner[T];if(void 0===R)return!1;for(let P=0;P<R.length;P++)if(this.equalsFn(R[P][0],S))return 1===R.length?delete this.inner[T]:R.splice(P,1),this.innerSize--,!0;return!1}forEach(S){forEach(this.inner,(T,R)=>{for(let[T,P]of R)S(T,P)})}isEmpty(){return isEmpty(this.inner)}size(){return this.innerSize}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tQ=new SortedMap(DocumentKey.comparator);function mutableDocumentMap(){return tQ}let t$=new SortedMap(DocumentKey.comparator);function documentMap(...S){let T=t$;for(let R of S)T=T.insert(R.key,R);return T}function newOverlayedDocumentMap(){return newDocumentKeyMap()}function convertOverlayedDocumentMapToDocumentMap(S){let T=t$;return S.forEach((S,R)=>T=T.insert(S,R.overlayedDocument)),T}function newOverlayMap(){return newDocumentKeyMap()}function newMutationMap(){return newDocumentKeyMap()}function newDocumentKeyMap(){return new ObjectMap(S=>S.toString(),(S,T)=>S.isEqual(T))}let tH=new SortedMap(DocumentKey.comparator);function documentVersionMap(){return tH}let tY=new SortedSet(DocumentKey.comparator);function documentKeySet(...S){let T=tY;for(let R of S)T=T.add(R);return T}let tJ=new SortedSet(primitiveComparator);function targetIdSet(){return tJ}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function toDouble(S,T){if(S.useProto3Json){if(isNaN(T))return{doubleValue:"NaN"};if(T===1/0)return{doubleValue:"Infinity"};if(T===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:isNegativeZero(T)?"-0":T}}function toInteger(S){return{integerValue:""+S}}function toNumber(S,T){return isSafeInteger(T)?toInteger(T):toDouble(S,T)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let TransformOperation=class TransformOperation{constructor(){this._=void 0}};function applyTransformOperationToLocalView(S,T,R){return S instanceof ServerTimestampTransform?serverTimestamp$1(R,T):S instanceof ArrayUnionTransformOperation?applyArrayUnionTransformOperation(S,T):S instanceof ArrayRemoveTransformOperation?applyArrayRemoveTransformOperation(S,T):applyNumericIncrementTransformOperationToLocalView(S,T)}function applyTransformOperationToRemoteDocument(S,T,R){return S instanceof ArrayUnionTransformOperation?applyArrayUnionTransformOperation(S,T):S instanceof ArrayRemoveTransformOperation?applyArrayRemoveTransformOperation(S,T):R}function computeTransformOperationBaseValue(S,T){return S instanceof NumericIncrementTransformOperation?isNumber(T)?T:{integerValue:0}:null}function transformOperationEquals(S,T){return S instanceof ArrayUnionTransformOperation&&T instanceof ArrayUnionTransformOperation||S instanceof ArrayRemoveTransformOperation&&T instanceof ArrayRemoveTransformOperation?arrayEquals(S.elements,T.elements,valueEquals):S instanceof NumericIncrementTransformOperation&&T instanceof NumericIncrementTransformOperation?valueEquals(S.operand,T.operand):S instanceof ServerTimestampTransform&&T instanceof ServerTimestampTransform}let ServerTimestampTransform=class ServerTimestampTransform extends TransformOperation{};let ArrayUnionTransformOperation=class ArrayUnionTransformOperation extends TransformOperation{constructor(S){super(),this.elements=S}};function applyArrayUnionTransformOperation(S,T){let R=coercedFieldValuesArray(T);for(let T of S.elements)R.some(S=>valueEquals(S,T))||R.push(T);return{arrayValue:{values:R}}}let ArrayRemoveTransformOperation=class ArrayRemoveTransformOperation extends TransformOperation{constructor(S){super(),this.elements=S}};function applyArrayRemoveTransformOperation(S,T){let R=coercedFieldValuesArray(T);for(let T of S.elements)R=R.filter(S=>!valueEquals(S,T));return{arrayValue:{values:R}}}let NumericIncrementTransformOperation=class NumericIncrementTransformOperation extends TransformOperation{constructor(S,T){super(),this.serializer=S,this.operand=T}};function applyNumericIncrementTransformOperationToLocalView(S,T){let R=computeTransformOperationBaseValue(S,T),P=asNumber(R)+asNumber(S.operand);return isInteger(R)&&isInteger(S.operand)?toInteger(P):toDouble(S.serializer,P)}function asNumber(S){return normalizeNumber(S.integerValue||S.doubleValue)}function coercedFieldValuesArray(S){return isArray(S)&&S.arrayValue.values?S.arrayValue.values.slice():[]}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let FieldTransform=class FieldTransform{constructor(S,T){this.field=S,this.transform=T}};function fieldTransformEquals(S,T){return S.field.isEqual(T.field)&&transformOperationEquals(S.transform,T.transform)}function fieldTransformsAreEqual(S,T){return void 0===S&&void 0===T||!!S&&!!T&&arrayEquals(S,T,(S,T)=>fieldTransformEquals(S,T))}let MutationResult=class MutationResult{constructor(S,T){this.version=S,this.transformResults=T}};let Precondition=class Precondition{constructor(S,T){this.updateTime=S,this.exists=T}static none(){return new Precondition}static exists(S){return new Precondition(void 0,S)}static updateTime(S){return new Precondition(S)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(S){return this.exists===S.exists&&(this.updateTime?!!S.updateTime&&this.updateTime.isEqual(S.updateTime):!S.updateTime)}};function preconditionIsValidForDocument(S,T){return void 0!==S.updateTime?T.isFoundDocument()&&T.version.isEqual(S.updateTime):void 0===S.exists||S.exists===T.isFoundDocument()}let Mutation=class Mutation{};function calculateOverlayMutation(S,T){if(!S.hasLocalMutations||T&&0===T.fields.length)return null;if(null===T)return S.isNoDocument()?new DeleteMutation(S.key,Precondition.none()):new SetMutation(S.key,S.data,Precondition.none());{let R=S.data,P=ObjectValue.empty(),O=new SortedSet(FieldPath$1.comparator);for(let S of T.fields)if(!O.has(S)){let T=R.field(S);null===T&&S.length>1&&(S=S.popLast(),T=R.field(S)),null===T?P.delete(S):P.set(S,T),O=O.add(S)}return new PatchMutation(S.key,P,new FieldMask(O.toArray()),Precondition.none())}}function mutationApplyToRemoteDocument(S,T,R){S instanceof SetMutation?setMutationApplyToRemoteDocument(S,T,R):S instanceof PatchMutation?patchMutationApplyToRemoteDocument(S,T,R):deleteMutationApplyToRemoteDocument(S,T,R)}function mutationApplyToLocalView(S,T,R,P){return S instanceof SetMutation?setMutationApplyToLocalView(S,T,R,P):S instanceof PatchMutation?patchMutationApplyToLocalView(S,T,R,P):deleteMutationApplyToLocalView(S,T,R)}function mutationExtractBaseValue(S,T){let R=null;for(let P of S.fieldTransforms){let S=T.data.field(P.field),O=computeTransformOperationBaseValue(P.transform,S||null);null!=O&&(null===R&&(R=ObjectValue.empty()),R.set(P.field,O))}return R||null}function mutationEquals(S,T){return!!(S.type===T.type&&S.key.isEqual(T.key)&&S.precondition.isEqual(T.precondition)&&fieldTransformsAreEqual(S.fieldTransforms,T.fieldTransforms))&&(0===S.type?S.value.isEqual(T.value):1!==S.type||S.data.isEqual(T.data)&&S.fieldMask.isEqual(T.fieldMask))}let SetMutation=class SetMutation extends Mutation{constructor(S,T,R,P=[]){super(),this.key=S,this.value=T,this.precondition=R,this.fieldTransforms=P,this.type=0}getFieldMask(){return null}};function setMutationApplyToRemoteDocument(S,T,R){let P=S.value.clone(),O=serverTransformResults(S.fieldTransforms,T,R.transformResults);P.setAll(O),T.convertToFoundDocument(R.version,P).setHasCommittedMutations()}function setMutationApplyToLocalView(S,T,R,P){if(!preconditionIsValidForDocument(S.precondition,T))return R;let O=S.value.clone(),N=localTransformResults(S.fieldTransforms,P,T);return O.setAll(N),T.convertToFoundDocument(T.version,O).setHasLocalMutations(),null}let PatchMutation=class PatchMutation extends Mutation{constructor(S,T,R,P,O=[]){super(),this.key=S,this.data=T,this.fieldMask=R,this.precondition=P,this.fieldTransforms=O,this.type=1}getFieldMask(){return this.fieldMask}};function patchMutationApplyToRemoteDocument(S,T,R){if(!preconditionIsValidForDocument(S.precondition,T)){T.convertToUnknownDocument(R.version);return}let P=serverTransformResults(S.fieldTransforms,T,R.transformResults),O=T.data;O.setAll(getPatch(S)),O.setAll(P),T.convertToFoundDocument(R.version,O).setHasCommittedMutations()}function patchMutationApplyToLocalView(S,T,R,P){if(!preconditionIsValidForDocument(S.precondition,T))return R;let O=localTransformResults(S.fieldTransforms,P,T),N=T.data;return(N.setAll(getPatch(S)),N.setAll(O),T.convertToFoundDocument(T.version,N).setHasLocalMutations(),null===R)?null:R.unionWith(S.fieldMask.fields).unionWith(S.fieldTransforms.map(S=>S.field))}function getPatch(S){let T=new Map;return S.fieldMask.fields.forEach(R=>{if(!R.isEmpty()){let P=S.data.field(R);T.set(R,P)}}),T}function serverTransformResults(S,T,R){let P=new Map;hardAssert(S.length===R.length);for(let O=0;O<R.length;O++){let N=S[O],M=N.transform,L=T.data.field(N.field);P.set(N.field,applyTransformOperationToRemoteDocument(M,L,R[O]))}return P}function localTransformResults(S,T,R){let P=new Map;for(let O of S){let S=O.transform,N=R.data.field(O.field);P.set(O.field,applyTransformOperationToLocalView(S,N,T))}return P}let DeleteMutation=class DeleteMutation extends Mutation{constructor(S,T){super(),this.key=S,this.precondition=T,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}};function deleteMutationApplyToRemoteDocument(S,T,R){T.convertToNoDocument(R.version).setHasCommittedMutations()}function deleteMutationApplyToLocalView(S,T,R){return preconditionIsValidForDocument(S.precondition,T)?(T.convertToNoDocument(T.version).setHasLocalMutations(),null):R}let VerifyMutation=class VerifyMutation extends Mutation{constructor(S,T){super(),this.key=S,this.precondition=T,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MutationBatch=class MutationBatch{constructor(S,T,R,P){this.batchId=S,this.localWriteTime=T,this.baseMutations=R,this.mutations=P}applyToRemoteDocument(S,T){let R=T.mutationResults;for(let T=0;T<this.mutations.length;T++){let P=this.mutations[T];if(P.key.isEqual(S.key)){let O=R[T];mutationApplyToRemoteDocument(P,S,O)}}}applyToLocalView(S,T){for(let R of this.baseMutations)R.key.isEqual(S.key)&&(T=mutationApplyToLocalView(R,S,T,this.localWriteTime));for(let R of this.mutations)R.key.isEqual(S.key)&&(T=mutationApplyToLocalView(R,S,T,this.localWriteTime));return T}applyToLocalDocumentSet(S,T){let R=newMutationMap();return this.mutations.forEach(P=>{let O=S.get(P.key),N=O.overlayedDocument,M=this.applyToLocalView(N,O.mutatedFields);M=T.has(P.key)?null:M;let L=calculateOverlayMutation(N,M);null!==L&&R.set(P.key,L),N.isValidDocument()||N.convertToNoDocument(SnapshotVersion.min())}),R}keys(){return this.mutations.reduce((S,T)=>S.add(T.key),documentKeySet())}isEqual(S){return this.batchId===S.batchId&&arrayEquals(this.mutations,S.mutations,(S,T)=>mutationEquals(S,T))&&arrayEquals(this.baseMutations,S.baseMutations,(S,T)=>mutationEquals(S,T))}};let MutationBatchResult=class MutationBatchResult{constructor(S,T,R,P){this.batch=S,this.commitVersion=T,this.mutationResults=R,this.docVersions=P}static from(S,T,R){hardAssert(S.mutations.length===R.length);let P=documentVersionMap(),O=S.mutations;for(let S=0;S<O.length;S++)P=P.insert(O[S].key,R[S].version);return new MutationBatchResult(S,T,R,P)}};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Overlay=class Overlay{constructor(S,T){this.largestBatchId=S,this.mutation=T}getKey(){return this.mutation.key}isEqual(S){return null!==S&&this.mutation===S.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ExistenceFilter=class ExistenceFilter{constructor(S,T){this.count=S,this.unchangedNames=T}};function isPermanentError(S){switch(S){case es.OK:return fail();case es.CANCELLED:case es.UNKNOWN:case es.DEADLINE_EXCEEDED:case es.RESOURCE_EXHAUSTED:case es.INTERNAL:case es.UNAVAILABLE:case es.UNAUTHENTICATED:return!1;case es.INVALID_ARGUMENT:case es.NOT_FOUND:case es.ALREADY_EXISTS:case es.PERMISSION_DENIED:case es.FAILED_PRECONDITION:case es.ABORTED:case es.OUT_OF_RANGE:case es.UNIMPLEMENTED:case es.DATA_LOSS:return!0;default:return fail()}}function isPermanentWriteError(S){return isPermanentError(S)&&S!==es.ABORTED}function mapCodeFromRpcCode(S){if(void 0===S)return logError("GRPC error has no .code"),es.UNKNOWN;switch(S){case N.OK:return es.OK;case N.CANCELLED:return es.CANCELLED;case N.UNKNOWN:return es.UNKNOWN;case N.DEADLINE_EXCEEDED:return es.DEADLINE_EXCEEDED;case N.RESOURCE_EXHAUSTED:return es.RESOURCE_EXHAUSTED;case N.INTERNAL:return es.INTERNAL;case N.UNAVAILABLE:return es.UNAVAILABLE;case N.UNAUTHENTICATED:return es.UNAUTHENTICATED;case N.INVALID_ARGUMENT:return es.INVALID_ARGUMENT;case N.NOT_FOUND:return es.NOT_FOUND;case N.ALREADY_EXISTS:return es.ALREADY_EXISTS;case N.PERMISSION_DENIED:return es.PERMISSION_DENIED;case N.FAILED_PRECONDITION:return es.FAILED_PRECONDITION;case N.ABORTED:return es.ABORTED;case N.OUT_OF_RANGE:return es.OUT_OF_RANGE;case N.UNIMPLEMENTED:return es.UNIMPLEMENTED;case N.DATA_LOSS:return es.DATA_LOSS;default:return fail()}}!function(S){S[S.OK=0]="OK",S[S.CANCELLED=1]="CANCELLED",S[S.UNKNOWN=2]="UNKNOWN",S[S.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",S[S.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",S[S.NOT_FOUND=5]="NOT_FOUND",S[S.ALREADY_EXISTS=6]="ALREADY_EXISTS",S[S.PERMISSION_DENIED=7]="PERMISSION_DENIED",S[S.UNAUTHENTICATED=16]="UNAUTHENTICATED",S[S.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",S[S.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",S[S.ABORTED=10]="ABORTED",S[S.OUT_OF_RANGE=11]="OUT_OF_RANGE",S[S.UNIMPLEMENTED=12]="UNIMPLEMENTED",S[S.INTERNAL=13]="INTERNAL",S[S.UNAVAILABLE=14]="UNAVAILABLE",S[S.DATA_LOSS=15]="DATA_LOSS"}(N||(N={}));/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Base64DecodeError=class Base64DecodeError extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tX=null;/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function newTextEncoder(){return new W.TextEncoder}function newTextDecoder(){return new TextDecoder("utf-8")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let tZ=new P([4294967295,4294967295],0);function getMd5HashValue(S){let T=newTextEncoder().encode(S),R=new O;return R.update(T),new Uint8Array(R.digest())}function get64BitUints(S){let T=new DataView(S.buffer),R=T.getUint32(0,!0),O=T.getUint32(4,!0),N=T.getUint32(8,!0),M=T.getUint32(12,!0),L=new P([R,O],0),V=new P([N,M],0);return[L,V]}let BloomFilter=class BloomFilter{constructor(S,T,R){if(this.bitmap=S,this.padding=T,this.hashCount=R,T<0||T>=8)throw new BloomFilterError(`Invalid padding: ${T}`);if(R<0||S.length>0&&0===this.hashCount)throw new BloomFilterError(`Invalid hash count: ${R}`);if(0===S.length&&0!==T)throw new BloomFilterError(`Invalid padding when bitmap length is 0: ${T}`);this.bitCount=8*S.length-T,this.bitCountInInteger=P.fromNumber(this.bitCount)}getBitIndex(S,T,R){let O=S.add(T.multiply(P.fromNumber(R)));return 1===O.compare(tZ)&&(O=new P([O.getBits(0),O.getBits(1)],0)),O.modulo(this.bitCountInInteger).toNumber()}isBitSet(S){let T=this.bitmap[Math.floor(S/8)],R=S%8;return(T&1<<R)!=0}mightContain(S){if(0===this.bitCount)return!1;let T=getMd5HashValue(S),[R,P]=get64BitUints(T);for(let S=0;S<this.hashCount;S++){let T=this.getBitIndex(R,P,S);if(!this.isBitSet(T))return!1}return!0}static create(S,T,R){let P=S%8==0?0:8-S%8,O=new Uint8Array(Math.ceil(S/8)),N=new BloomFilter(O,P,T);return R.forEach(S=>N.insert(S)),N}insert(S){if(0===this.bitCount)return;let T=getMd5HashValue(S),[R,P]=get64BitUints(T);for(let S=0;S<this.hashCount;S++){let T=this.getBitIndex(R,P,S);this.setBit(T)}}setBit(S){let T=Math.floor(S/8),R=S%8;this.bitmap[T]|=1<<R}};let BloomFilterError=class BloomFilterError extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let RemoteEvent=class RemoteEvent{constructor(S,T,R,P,O){this.snapshotVersion=S,this.targetChanges=T,this.targetMismatches=R,this.documentUpdates=P,this.resolvedLimboDocuments=O}static createSynthesizedRemoteEventForCurrentChange(S,T,R){let P=new Map;return P.set(S,TargetChange.createSynthesizedTargetChangeForCurrentChange(S,T,R)),new RemoteEvent(SnapshotVersion.min(),P,new SortedMap(primitiveComparator),mutableDocumentMap(),documentKeySet())}};let TargetChange=class TargetChange{constructor(S,T,R,P,O){this.resumeToken=S,this.current=T,this.addedDocuments=R,this.modifiedDocuments=P,this.removedDocuments=O}static createSynthesizedTargetChangeForCurrentChange(S,T,R){return new TargetChange(R,T,documentKeySet(),documentKeySet(),documentKeySet())}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DocumentWatchChange=class DocumentWatchChange{constructor(S,T,R,P){this.updatedTargetIds=S,this.removedTargetIds=T,this.key=R,this.newDoc=P}};let ExistenceFilterChange=class ExistenceFilterChange{constructor(S,T){this.targetId=S,this.existenceFilter=T}};let WatchTargetChange=class WatchTargetChange{constructor(S,T,R=ByteString.EMPTY_BYTE_STRING,P=null){this.state=S,this.targetIds=T,this.resumeToken=R,this.cause=P}};let TargetState=class TargetState{constructor(){this.pendingResponses=0,this.documentChanges=snapshotChangesMap(),this._resumeToken=ByteString.EMPTY_BYTE_STRING,this._current=!1,this._hasPendingChanges=!0}get current(){return this._current}get resumeToken(){return this._resumeToken}get isPending(){return 0!==this.pendingResponses}get hasPendingChanges(){return this._hasPendingChanges}updateResumeToken(S){S.approximateByteSize()>0&&(this._hasPendingChanges=!0,this._resumeToken=S)}toTargetChange(){let S=documentKeySet(),T=documentKeySet(),R=documentKeySet();return this.documentChanges.forEach((P,O)=>{switch(O){case 0:S=S.add(P);break;case 2:T=T.add(P);break;case 1:R=R.add(P);break;default:fail()}}),new TargetChange(this._resumeToken,this._current,S,T,R)}clearPendingChanges(){this._hasPendingChanges=!1,this.documentChanges=snapshotChangesMap()}addDocumentChange(S,T){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(S,T)}removeDocumentChange(S){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(S)}recordPendingTargetRequest(){this.pendingResponses+=1}recordTargetResponse(){this.pendingResponses-=1,hardAssert(this.pendingResponses>=0)}markCurrent(){this._hasPendingChanges=!0,this._current=!0}};let t0="WatchChangeAggregator";let WatchChangeAggregator=class WatchChangeAggregator{constructor(S){this.metadataProvider=S,this.targetStates=new Map,this.pendingDocumentUpdates=mutableDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new SortedMap(primitiveComparator)}handleDocumentChange(S){for(let T of S.updatedTargetIds)S.newDoc&&S.newDoc.isFoundDocument()?this.addDocumentToTarget(T,S.newDoc):this.removeDocumentFromTarget(T,S.key,S.newDoc);for(let T of S.removedTargetIds)this.removeDocumentFromTarget(T,S.key,S.newDoc)}handleTargetChange(S){this.forEachTarget(S,T=>{let R=this.ensureTargetState(T);switch(S.state){case 0:this.isActiveTarget(T)&&R.updateResumeToken(S.resumeToken);break;case 1:R.recordTargetResponse(),R.isPending||R.clearPendingChanges(),R.updateResumeToken(S.resumeToken);break;case 2:R.recordTargetResponse(),R.isPending||this.removeTarget(T);break;case 3:this.isActiveTarget(T)&&(R.markCurrent(),R.updateResumeToken(S.resumeToken));break;case 4:this.isActiveTarget(T)&&(this.resetTarget(T),R.updateResumeToken(S.resumeToken));break;default:fail()}})}forEachTarget(S,T){S.targetIds.length>0?S.targetIds.forEach(T):this.targetStates.forEach((S,R)=>{this.isActiveTarget(R)&&T(R)})}handleExistenceFilter(S){let T=S.targetId,R=S.existenceFilter.count,P=this.targetDataForActiveTarget(T);if(P){let O=P.target;if(targetIsDocumentTarget(O)){if(0===R){let S=new DocumentKey(O.path);this.removeDocumentFromTarget(T,S,MutableDocument.newNoDocument(S,SnapshotVersion.min()))}else hardAssert(1===R)}else{let P=this.getCurrentDocumentCountForTarget(T);if(P!==R){let R=this.parseBloomFilter(S),O=R?this.applyBloomFilter(R,S,P):1;if(0!==O){this.resetTarget(T);let S=2===O?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.pendingTargetResets=this.pendingTargetResets.insert(T,S)}null==tX||tX.notifyOnExistenceFilterMismatch(createExistenceFilterMismatchInfoForTestingHooks(P,S.existenceFilter,this.metadataProvider.getDatabaseId(),R,O))}}}}parseBloomFilter(S){let T,R;let P=S.existenceFilter.unchangedNames;if(!P||!P.bits)return null;let{bits:{bitmap:O="",padding:N=0},hashCount:M=0}=P;try{T=normalizeByteString(O).toUint8Array()}catch(S){if(S instanceof Base64DecodeError)return logWarn("Decoding the base64 bloom filter in existence filter failed ("+S.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw S}try{R=new BloomFilter(T,N,M)}catch(S){return S instanceof BloomFilterError?logWarn("BloomFilter error: ",S):logWarn("Applying bloom filter failed: ",S),null}return 0===R.bitCount?null:R}applyBloomFilter(S,T,R){let P=T.existenceFilter.count,O=this.filterRemovedDocuments(S,T.targetId);return P===R-O?0:2}filterRemovedDocuments(S,T){let R=this.metadataProvider.getRemoteKeysForTarget(T),P=0;return R.forEach(R=>{let O=this.metadataProvider.getDatabaseId(),N=`projects/${O.projectId}/databases/${O.database}/documents/${R.path.canonicalString()}`;!S.mightContain(N)&&(this.removeDocumentFromTarget(T,R,null),P++)}),P}createRemoteEvent(S){let T=new Map;this.targetStates.forEach((R,P)=>{let O=this.targetDataForActiveTarget(P);if(O){if(R.current&&targetIsDocumentTarget(O.target)){let T=new DocumentKey(O.target.path);null!==this.pendingDocumentUpdates.get(T)||this.targetContainsDocument(P,T)||this.removeDocumentFromTarget(P,T,MutableDocument.newNoDocument(T,S))}R.hasPendingChanges&&(T.set(P,R.toTargetChange()),R.clearPendingChanges())}});let R=documentKeySet();this.pendingDocumentTargetMapping.forEach((S,T)=>{let P=!0;T.forEachWhile(S=>{let T=this.targetDataForActiveTarget(S);return!T||"TargetPurposeLimboResolution"===T.purpose||(P=!1,!1)}),P&&(R=R.add(S))}),this.pendingDocumentUpdates.forEach((T,R)=>R.setReadTime(S));let P=new RemoteEvent(S,T,this.pendingTargetResets,this.pendingDocumentUpdates,R);return this.pendingDocumentUpdates=mutableDocumentMap(),this.pendingDocumentTargetMapping=documentTargetMap(),this.pendingTargetResets=new SortedMap(primitiveComparator),P}addDocumentToTarget(S,T){if(!this.isActiveTarget(S))return;let R=this.targetContainsDocument(S,T.key)?2:0,P=this.ensureTargetState(S);P.addDocumentChange(T.key,R),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(T.key,T),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(T.key,this.ensureDocumentTargetMapping(T.key).add(S))}removeDocumentFromTarget(S,T,R){if(!this.isActiveTarget(S))return;let P=this.ensureTargetState(S);this.targetContainsDocument(S,T)?P.addDocumentChange(T,1):P.removeDocumentChange(T),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(T,this.ensureDocumentTargetMapping(T).delete(S)),R&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(T,R))}removeTarget(S){this.targetStates.delete(S)}getCurrentDocumentCountForTarget(S){let T=this.ensureTargetState(S),R=T.toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(S).size+R.addedDocuments.size-R.removedDocuments.size}recordPendingTargetRequest(S){let T=this.ensureTargetState(S);T.recordPendingTargetRequest()}ensureTargetState(S){let T=this.targetStates.get(S);return T||(T=new TargetState,this.targetStates.set(S,T)),T}ensureDocumentTargetMapping(S){let T=this.pendingDocumentTargetMapping.get(S);return T||(T=new SortedSet(primitiveComparator),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(S,T)),T}isActiveTarget(S){let T=null!==this.targetDataForActiveTarget(S);return T||logDebug(t0,"Detected inactive target",S),T}targetDataForActiveTarget(S){let T=this.targetStates.get(S);return T&&T.isPending?null:this.metadataProvider.getTargetDataForTarget(S)}resetTarget(S){this.targetStates.set(S,new TargetState);let T=this.metadataProvider.getRemoteKeysForTarget(S);T.forEach(T=>{this.removeDocumentFromTarget(S,T,null)})}targetContainsDocument(S,T){let R=this.metadataProvider.getRemoteKeysForTarget(S);return R.has(T)}};function documentTargetMap(){return new SortedMap(DocumentKey.comparator)}function snapshotChangesMap(){return new SortedMap(DocumentKey.comparator)}function createExistenceFilterMismatchInfoForTestingHooks(S,T,R,P,O){var N,M,L,V,U,W;let K={localCacheCount:S,existenceFilterCount:T.count,databaseId:R.database,projectId:R.projectId},Q=T.unchangedNames;return Q&&(K.bloomFilter={applied:0===O,hashCount:null!==(N=null==Q?void 0:Q.hashCount)&&void 0!==N?N:0,bitmapLength:null!==(V=null===(L=null===(M=null==Q?void 0:Q.bits)||void 0===M?void 0:M.bitmap)||void 0===L?void 0:L.length)&&void 0!==V?V:0,padding:null!==(W=null===(U=null==Q?void 0:Q.bits)||void 0===U?void 0:U.padding)&&void 0!==W?W:0,mightContain:S=>{var T;return null!==(T=null==P?void 0:P.mightContain(S))&&void 0!==T&&T}}),K}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let t1=(()=>{let S={};return S.asc="ASCENDING",S.desc="DESCENDING",S})(),t2=(()=>{let S={};return S["<"]="LESS_THAN",S["<="]="LESS_THAN_OR_EQUAL",S[">"]="GREATER_THAN",S[">="]="GREATER_THAN_OR_EQUAL",S["=="]="EQUAL",S["!="]="NOT_EQUAL",S["array-contains"]="ARRAY_CONTAINS",S.in="IN",S["not-in"]="NOT_IN",S["array-contains-any"]="ARRAY_CONTAINS_ANY",S})(),t3=(()=>{let S={};return S.and="AND",S.or="OR",S})();let JsonProtoSerializer=class JsonProtoSerializer{constructor(S,T){this.databaseId=S,this.useProto3Json=T}};function fromRpcStatus(S){let T=void 0===S.code?es.UNKNOWN:mapCodeFromRpcCode(S.code);return new FirestoreError(T,S.message||"")}function toInt32Proto(S,T){return S.useProto3Json||isNullOrUndefined(T)?T:{value:T}}function fromInt32Proto(S){let T;return isNullOrUndefined(T="object"==typeof S?S.value:S)?null:T}function toTimestamp(S,T){if(!S.useProto3Json)return{seconds:""+T.seconds,nanos:T.nanoseconds};{let S=new Date(1e3*T.seconds).toISOString(),R=S.replace(/\.\d*/,"").replace("Z",""),P=("000000000"+T.nanoseconds).slice(-9);return`${R}.${P}Z`}}function fromTimestamp(S){let T=normalizeTimestamp(S);return new Timestamp(T.seconds,T.nanos)}function toBytes(S,T){return S.useProto3Json?T.toBase64():T.toUint8Array()}function fromBytes(S,T){return S.useProto3Json?(hardAssert(void 0===T||"string"==typeof T),ByteString.fromBase64String(T||"")):(hardAssert(void 0===T||T instanceof Buffer||T instanceof Uint8Array),ByteString.fromUint8Array(T||new Uint8Array))}function toVersion(S,T){return toTimestamp(S,T.toTimestamp())}function fromVersion(S){return hardAssert(!!S),SnapshotVersion.fromTimestamp(fromTimestamp(S))}function toResourceName(S,T){return toResourcePath(S,T).canonicalString()}function toResourcePath(S,T){let R=fullyQualifiedPrefixPath(S).child("documents");return void 0===T?R:R.child(T)}function fromResourceName(S){let T=ResourcePath.fromString(S);return hardAssert(isValidResourceName(T)),T}function toName(S,T){return toResourceName(S.databaseId,T.path)}function fromName(S,T){let R=fromResourceName(T);if(R.get(1)!==S.databaseId.projectId)throw new FirestoreError(es.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+R.get(1)+" vs "+S.databaseId.projectId);if(R.get(3)!==S.databaseId.database)throw new FirestoreError(es.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+R.get(3)+" vs "+S.databaseId.database);return new DocumentKey(extractLocalPathFromResourceName(R))}function toQueryPath(S,T){return toResourceName(S.databaseId,T)}function fromQueryPath(S){let T=fromResourceName(S);return 4===T.length?ResourcePath.emptyPath():extractLocalPathFromResourceName(T)}function getEncodedDatabaseId(S){let T=new ResourcePath(["projects",S.databaseId.projectId,"databases",S.databaseId.database]);return T.canonicalString()}function fullyQualifiedPrefixPath(S){return new ResourcePath(["projects",S.projectId,"databases",S.database])}function extractLocalPathFromResourceName(S){return hardAssert(S.length>4&&"documents"===S.get(4)),S.popFirst(5)}function toMutationDocument(S,T,R){return{name:toName(S,T),fields:R.value.mapValue.fields}}function toDocument(S,T){return{name:toName(S,T.key),fields:T.data.value.mapValue.fields,updateTime:toTimestamp(S,T.version.toTimestamp()),createTime:toTimestamp(S,T.createTime.toTimestamp())}}function fromDocument(S,T,R){let P=fromName(S,T.name),O=fromVersion(T.updateTime),N=T.createTime?fromVersion(T.createTime):SnapshotVersion.min(),M=new ObjectValue({mapValue:{fields:T.fields}}),L=MutableDocument.newFoundDocument(P,O,N,M);return R&&L.setHasCommittedMutations(),R?L.setHasCommittedMutations():L}function fromFound(S,T){hardAssert(!!T.found),T.found.name,T.found.updateTime;let R=fromName(S,T.found.name),P=fromVersion(T.found.updateTime),O=T.found.createTime?fromVersion(T.found.createTime):SnapshotVersion.min(),N=new ObjectValue({mapValue:{fields:T.found.fields}});return MutableDocument.newFoundDocument(R,P,O,N)}function fromMissing(S,T){hardAssert(!!T.missing),hardAssert(!!T.readTime);let R=fromName(S,T.missing),P=fromVersion(T.readTime);return MutableDocument.newNoDocument(R,P)}function fromBatchGetDocumentsResponse(S,T){return"found"in T?fromFound(S,T):"missing"in T?fromMissing(S,T):fail()}function fromWatchChange(S,T){let R;if("targetChange"in T){T.targetChange;let P=fromWatchTargetChangeState(T.targetChange.targetChangeType||"NO_CHANGE"),O=T.targetChange.targetIds||[],N=fromBytes(S,T.targetChange.resumeToken),M=T.targetChange.cause,L=M&&fromRpcStatus(M);R=new WatchTargetChange(P,O,N,L||null)}else if("documentChange"in T){T.documentChange;let P=T.documentChange;P.document,P.document.name,P.document.updateTime;let O=fromName(S,P.document.name),N=fromVersion(P.document.updateTime),M=P.document.createTime?fromVersion(P.document.createTime):SnapshotVersion.min(),L=new ObjectValue({mapValue:{fields:P.document.fields}}),V=MutableDocument.newFoundDocument(O,N,M,L),U=P.targetIds||[],W=P.removedTargetIds||[];R=new DocumentWatchChange(U,W,V.key,V)}else if("documentDelete"in T){T.documentDelete;let P=T.documentDelete;P.document;let O=fromName(S,P.document),N=P.readTime?fromVersion(P.readTime):SnapshotVersion.min(),M=MutableDocument.newNoDocument(O,N),L=P.removedTargetIds||[];R=new DocumentWatchChange([],L,M.key,M)}else if("documentRemove"in T){T.documentRemove;let P=T.documentRemove;P.document;let O=fromName(S,P.document),N=P.removedTargetIds||[];R=new DocumentWatchChange([],N,O,null)}else{if(!("filter"in T))return fail();T.filter;let S=T.filter;S.targetId;let{count:P=0,unchangedNames:O}=S,N=new ExistenceFilter(P,O),M=S.targetId;R=new ExistenceFilterChange(M,N)}return R}function fromWatchTargetChangeState(S){return"NO_CHANGE"===S?0:"ADD"===S?1:"REMOVE"===S?2:"CURRENT"===S?3:"RESET"===S?4:fail()}function versionFromListenResponse(S){if(!("targetChange"in S))return SnapshotVersion.min();let T=S.targetChange;return T.targetIds&&T.targetIds.length||!T.readTime?SnapshotVersion.min():fromVersion(T.readTime)}function toMutation(S,T){let R;if(T instanceof SetMutation)R={update:toMutationDocument(S,T.key,T.value)};else if(T instanceof DeleteMutation)R={delete:toName(S,T.key)};else if(T instanceof PatchMutation)R={update:toMutationDocument(S,T.key,T.data),updateMask:toDocumentMask(T.fieldMask)};else{if(!(T instanceof VerifyMutation))return fail();R={verify:toName(S,T.key)}}return T.fieldTransforms.length>0&&(R.updateTransforms=T.fieldTransforms.map(T=>toFieldTransform(S,T))),T.precondition.isNone||(R.currentDocument=toPrecondition(S,T.precondition)),R}function fromMutation(S,T){let R=T.currentDocument?fromPrecondition(T.currentDocument):Precondition.none(),P=T.updateTransforms?T.updateTransforms.map(T=>fromFieldTransform(S,T)):[];if(T.update){T.update.name;let O=fromName(S,T.update.name),N=new ObjectValue({mapValue:{fields:T.update.fields}});if(!T.updateMask)return new SetMutation(O,N,R,P);{let S=fromDocumentMask(T.updateMask);return new PatchMutation(O,N,S,R,P)}}if(T.delete){let P=fromName(S,T.delete);return new DeleteMutation(P,R)}if(!T.verify)return fail();{let P=fromName(S,T.verify);return new VerifyMutation(P,R)}}function toPrecondition(S,T){return void 0!==T.updateTime?{updateTime:toVersion(S,T.updateTime)}:void 0!==T.exists?{exists:T.exists}:fail()}function fromPrecondition(S){return void 0!==S.updateTime?Precondition.updateTime(fromVersion(S.updateTime)):void 0!==S.exists?Precondition.exists(S.exists):Precondition.none()}function fromWriteResult(S,T){let R=S.updateTime?fromVersion(S.updateTime):fromVersion(T);return R.isEqual(SnapshotVersion.min())&&(R=fromVersion(T)),new MutationResult(R,S.transformResults||[])}function fromWriteResults(S,T){return S&&S.length>0?(hardAssert(void 0!==T),S.map(S=>fromWriteResult(S,T))):[]}function toFieldTransform(S,T){let R=T.transform;if(R instanceof ServerTimestampTransform)return{fieldPath:T.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(R instanceof ArrayUnionTransformOperation)return{fieldPath:T.field.canonicalString(),appendMissingElements:{values:R.elements}};if(R instanceof ArrayRemoveTransformOperation)return{fieldPath:T.field.canonicalString(),removeAllFromArray:{values:R.elements}};if(R instanceof NumericIncrementTransformOperation)return{fieldPath:T.field.canonicalString(),increment:R.operand};throw fail()}function fromFieldTransform(S,T){let R=null;if("setToServerValue"in T)hardAssert("REQUEST_TIME"===T.setToServerValue),R=new ServerTimestampTransform;else if("appendMissingElements"in T){let S=T.appendMissingElements.values||[];R=new ArrayUnionTransformOperation(S)}else if("removeAllFromArray"in T){let S=T.removeAllFromArray.values||[];R=new ArrayRemoveTransformOperation(S)}else"increment"in T?R=new NumericIncrementTransformOperation(S,T.increment):fail();let P=FieldPath$1.fromServerFormat(T.fieldPath);return new FieldTransform(P,R)}function toDocumentsTarget(S,T){return{documents:[toQueryPath(S,T.path)]}}function fromDocumentsTarget(S){let T=S.documents.length;hardAssert(1===T);let R=S.documents[0];return queryToTarget(newQueryForPath(fromQueryPath(R)))}function toQueryTarget(S,T){let R;let P={structuredQuery:{}},O=T.path;null!==T.collectionGroup?(R=O,P.structuredQuery.from=[{collectionId:T.collectionGroup,allDescendants:!0}]):(R=O.popLast(),P.structuredQuery.from=[{collectionId:O.lastSegment()}]),P.parent=toQueryPath(S,R);let N=toFilters(T.filters);N&&(P.structuredQuery.where=N);let M=toOrder(T.orderBy);M&&(P.structuredQuery.orderBy=M);let L=toInt32Proto(S,T.limit);return null!==L&&(P.structuredQuery.limit=L),T.startAt&&(P.structuredQuery.startAt=toStartAtCursor(T.startAt)),T.endAt&&(P.structuredQuery.endAt=toEndAtCursor(T.endAt)),{queryTarget:P,parent:R}}function toRunAggregationQueryRequest(S,T,R,P){let{queryTarget:O,parent:N}=toQueryTarget(S,T),M={},L=[],V=0;return R.forEach(S=>{let T=P?S.alias:`aggregate_${V++}`;M[T]=S.alias,"count"===S.aggregateType?L.push({alias:T,count:{}}):"avg"===S.aggregateType?L.push({alias:T,avg:{field:toFieldPathReference(S.fieldPath)}}):"sum"===S.aggregateType&&L.push({alias:T,sum:{field:toFieldPathReference(S.fieldPath)}})}),{request:{structuredAggregationQuery:{aggregations:L,structuredQuery:O.structuredQuery},parent:O.parent},aliasMap:M,parent:N}}function convertQueryTargetToQuery(S){let T=fromQueryPath(S.parent),R=S.structuredQuery,P=R.from?R.from.length:0,O=null;if(P>0){hardAssert(1===P);let S=R.from[0];S.allDescendants?O=S.collectionId:T=T.child(S.collectionId)}let N=[];R.where&&(N=fromFilters(R.where));let M=[];R.orderBy&&(M=fromOrder(R.orderBy));let L=null;R.limit&&(L=fromInt32Proto(R.limit));let V=null;R.startAt&&(V=fromStartAtCursor(R.startAt));let U=null;return R.endAt&&(U=fromEndAtCursor(R.endAt)),newQuery(T,O,M,N,L,"F",V,U)}function fromQueryTarget(S){return queryToTarget(convertQueryTargetToQuery(S))}function toListenRequestLabels(S,T){let R=toLabel(T.purpose);return null==R?null:{"goog-listen-tags":R}}function toLabel(S){switch(S){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return fail()}}function toTarget(S,T){let R;let P=T.target;if((R=targetIsDocumentTarget(P)?{documents:toDocumentsTarget(S,P)}:{query:toQueryTarget(S,P).queryTarget}).targetId=T.targetId,T.resumeToken.approximateByteSize()>0){R.resumeToken=toBytes(S,T.resumeToken);let P=toInt32Proto(S,T.expectedCount);null!==P&&(R.expectedCount=P)}else if(T.snapshotVersion.compareTo(SnapshotVersion.min())>0){R.readTime=toTimestamp(S,T.snapshotVersion.toTimestamp());let P=toInt32Proto(S,T.expectedCount);null!==P&&(R.expectedCount=P)}return R}function toFilters(S){if(0!==S.length)return toFilter(CompositeFilter.create(S,"and"))}function fromFilters(S){let T=fromFilter(S);return T instanceof CompositeFilter&&compositeFilterIsFlatConjunction(T)?T.getFilters():[T]}function fromFilter(S){return void 0!==S.unaryFilter?fromUnaryFilter(S):void 0!==S.fieldFilter?fromFieldFilter(S):void 0!==S.compositeFilter?fromCompositeFilter(S):fail()}function toOrder(S){if(0!==S.length)return S.map(S=>toPropertyOrder(S))}function fromOrder(S){return S.map(S=>fromPropertyOrder(S))}function toStartAtCursor(S){return{before:S.inclusive,values:S.position}}function toEndAtCursor(S){return{before:!S.inclusive,values:S.position}}function fromStartAtCursor(S){let T=!!S.before,R=S.values||[];return new Bound(R,T)}function fromEndAtCursor(S){let T=!S.before,R=S.values||[];return new Bound(R,T)}function toDirection(S){return t1[S]}function fromDirection(S){switch(S){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}function toOperatorName(S){return t2[S]}function toCompositeOperatorName(S){return t3[S]}function fromOperatorName(S){switch(S){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return fail()}}function fromCompositeOperatorName(S){switch(S){case"AND":return"and";case"OR":return"or";default:return fail()}}function toFieldPathReference(S){return{fieldPath:S.canonicalString()}}function fromFieldPathReference(S){return FieldPath$1.fromServerFormat(S.fieldPath)}function toPropertyOrder(S){return{field:toFieldPathReference(S.field),direction:toDirection(S.dir)}}function fromPropertyOrder(S){return new OrderBy(fromFieldPathReference(S.field),fromDirection(S.direction))}function toFilter(S){return S instanceof FieldFilter?toUnaryOrFieldFilter(S):S instanceof CompositeFilter?toCompositeFilter(S):fail()}function toCompositeFilter(S){let T=S.getFilters().map(S=>toFilter(S));return 1===T.length?T[0]:{compositeFilter:{op:toCompositeOperatorName(S.op),filters:T}}}function toUnaryOrFieldFilter(S){if("=="===S.op){if(isNanValue(S.value))return{unaryFilter:{field:toFieldPathReference(S.field),op:"IS_NAN"}};if(isNullValue(S.value))return{unaryFilter:{field:toFieldPathReference(S.field),op:"IS_NULL"}}}else if("!="===S.op){if(isNanValue(S.value))return{unaryFilter:{field:toFieldPathReference(S.field),op:"IS_NOT_NAN"}};if(isNullValue(S.value))return{unaryFilter:{field:toFieldPathReference(S.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:toFieldPathReference(S.field),op:toOperatorName(S.op),value:S.value}}}function fromUnaryFilter(S){switch(S.unaryFilter.op){case"IS_NAN":let T=fromFieldPathReference(S.unaryFilter.field);return FieldFilter.create(T,"==",{doubleValue:NaN});case"IS_NULL":let R=fromFieldPathReference(S.unaryFilter.field);return FieldFilter.create(R,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let P=fromFieldPathReference(S.unaryFilter.field);return FieldFilter.create(P,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let O=fromFieldPathReference(S.unaryFilter.field);return FieldFilter.create(O,"!=",{nullValue:"NULL_VALUE"});default:return fail()}}function fromFieldFilter(S){return FieldFilter.create(fromFieldPathReference(S.fieldFilter.field),fromOperatorName(S.fieldFilter.op),S.fieldFilter.value)}function fromCompositeFilter(S){return CompositeFilter.create(S.compositeFilter.filters.map(S=>fromFilter(S)),fromCompositeOperatorName(S.compositeFilter.op))}function toDocumentMask(S){let T=[];return S.fields.forEach(S=>T.push(S.canonicalString())),{fieldPaths:T}}function fromDocumentMask(S){let T=S.fieldPaths||[];return new FieldMask(T.map(S=>FieldPath$1.fromServerFormat(S)))}function isValidResourceName(S){return S.length>=4&&"projects"===S.get(0)&&"databases"===S.get(2)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let TargetData=class TargetData{constructor(S,T,R,P,O=SnapshotVersion.min(),N=SnapshotVersion.min(),M=ByteString.EMPTY_BYTE_STRING,L=null){this.target=S,this.targetId=T,this.purpose=R,this.sequenceNumber=P,this.snapshotVersion=O,this.lastLimboFreeSnapshotVersion=N,this.resumeToken=M,this.expectedCount=L}withSequenceNumber(S){return new TargetData(this.target,this.targetId,this.purpose,S,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(S,T){return new TargetData(this.target,this.targetId,this.purpose,this.sequenceNumber,T,this.lastLimboFreeSnapshotVersion,S,null)}withExpectedCount(S){return new TargetData(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,S)}withLastLimboFreeSnapshotVersion(S){return new TargetData(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,S,this.resumeToken,this.expectedCount)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let LocalSerializer=class LocalSerializer{constructor(S){this.remoteSerializer=S}};function fromDbRemoteDocument(S,T){let R;if(T.document)R=fromDocument(S.remoteSerializer,T.document,!!T.hasCommittedMutations);else if(T.noDocument){let S=DocumentKey.fromSegments(T.noDocument.path),P=fromDbTimestamp(T.noDocument.readTime);R=MutableDocument.newNoDocument(S,P),T.hasCommittedMutations&&R.setHasCommittedMutations()}else{if(!T.unknownDocument)return fail();let S=DocumentKey.fromSegments(T.unknownDocument.path),P=fromDbTimestamp(T.unknownDocument.version);R=MutableDocument.newUnknownDocument(S,P)}return T.readTime&&R.setReadTime(fromDbTimestampKey(T.readTime)),R}function toDbRemoteDocument(S,T){let R=T.key,P={prefixPath:R.getCollectionPath().popLast().toArray(),collectionGroup:R.collectionGroup,documentId:R.path.lastSegment(),readTime:toDbTimestampKey(T.readTime),hasCommittedMutations:T.hasCommittedMutations};if(T.isFoundDocument())P.document=toDocument(S.remoteSerializer,T);else if(T.isNoDocument())P.noDocument={path:R.path.toArray(),readTime:toDbTimestamp(T.version)};else{if(!T.isUnknownDocument())return fail();P.unknownDocument={path:R.path.toArray(),version:toDbTimestamp(T.version)}}return P}function toDbTimestampKey(S){let T=S.toTimestamp();return[T.seconds,T.nanoseconds]}function fromDbTimestampKey(S){let T=new Timestamp(S[0],S[1]);return SnapshotVersion.fromTimestamp(T)}function toDbTimestamp(S){let T=S.toTimestamp();return{seconds:T.seconds,nanoseconds:T.nanoseconds}}function fromDbTimestamp(S){let T=new Timestamp(S.seconds,S.nanoseconds);return SnapshotVersion.fromTimestamp(T)}function toDbMutationBatch(S,T,R){let P=R.baseMutations.map(T=>toMutation(S.remoteSerializer,T)),O=R.mutations.map(T=>toMutation(S.remoteSerializer,T));return{userId:T,batchId:R.batchId,localWriteTimeMs:R.localWriteTime.toMillis(),baseMutations:P,mutations:O}}function fromDbMutationBatch(S,T){let R=(T.baseMutations||[]).map(T=>fromMutation(S.remoteSerializer,T));for(let S=0;S<T.mutations.length-1;++S){let R=T.mutations[S],P=S+1<T.mutations.length&&void 0!==T.mutations[S+1].transform;if(P){let P=T.mutations[S+1];R.updateTransforms=P.transform.fieldTransforms,T.mutations.splice(S+1,1),++S}}let P=T.mutations.map(T=>fromMutation(S.remoteSerializer,T)),O=Timestamp.fromMillis(T.localWriteTimeMs);return new MutationBatch(T.batchId,O,R,P)}function fromDbTarget(S){let T;let R=fromDbTimestamp(S.readTime),P=void 0!==S.lastLimboFreeSnapshotVersion?fromDbTimestamp(S.lastLimboFreeSnapshotVersion):SnapshotVersion.min();return T=isDocumentQuery(S.query)?fromDocumentsTarget(S.query):fromQueryTarget(S.query),new TargetData(T,S.targetId,"TargetPurposeListen",S.lastListenSequenceNumber,R,P,ByteString.fromBase64String(S.resumeToken))}function toDbTarget(S,T){let R;let P=toDbTimestamp(T.snapshotVersion),O=toDbTimestamp(T.lastLimboFreeSnapshotVersion);R=targetIsDocumentTarget(T.target)?toDocumentsTarget(S.remoteSerializer,T.target):toQueryTarget(S.remoteSerializer,T.target).queryTarget;let N=T.resumeToken.toBase64();return{targetId:T.targetId,canonicalId:canonifyTarget(T.target),readTime:P,resumeToken:N,lastListenSequenceNumber:T.sequenceNumber,lastLimboFreeSnapshotVersion:O,query:R}}function isDocumentQuery(S){return void 0!==S.documents}function fromDbBundle(S){return{id:S.bundleId,createTime:fromDbTimestamp(S.createTime),version:S.version}}function toDbBundle(S){return{bundleId:S.id,createTime:toDbTimestamp(fromVersion(S.createTime)),version:S.version}}function fromDbNamedQuery(S){return{name:S.name,query:fromBundledQuery(S.bundledQuery),readTime:fromDbTimestamp(S.readTime)}}function toDbNamedQuery(S){return{name:S.name,readTime:toDbTimestamp(fromVersion(S.readTime)),bundledQuery:S.bundledQuery}}function fromBundledQuery(S){let T=convertQueryTargetToQuery({parent:S.parent,structuredQuery:S.structuredQuery});return"LAST"===S.limitType?queryWithLimit(T,T.limit,"L"):T}function fromProtoNamedQuery(S){return{name:S.name,query:fromBundledQuery(S.bundledQuery),readTime:fromVersion(S.readTime)}}function fromBundleMetadata(S){return{id:S.id,version:S.version,createTime:fromVersion(S.createTime)}}function fromDbDocumentOverlay(S,T){return new Overlay(T.largestBatchId,fromMutation(S.remoteSerializer,T.overlayMutation))}function toDbDocumentOverlay(S,T,R){let[P,O,N]=toDbDocumentOverlayKey(T,R.mutation.key);return{userId:T,collectionPath:O,documentId:N,collectionGroup:R.mutation.key.getCollectionGroup(),largestBatchId:R.largestBatchId,overlayMutation:toMutation(S.remoteSerializer,R.mutation)}}function toDbDocumentOverlayKey(S,T){let R=T.path.lastSegment(),P=encodeResourcePath(T.path.popLast());return[S,P,R]}function toDbIndexConfiguration(S){return{indexId:S.indexId,collectionGroup:S.collectionGroup,fields:S.fields.map(S=>[S.fieldPath.canonicalString(),S.kind])}}function fromDbIndexConfiguration(S,T){let R=T?new IndexState(T.sequenceNumber,new IndexOffset(fromDbTimestamp(T.readTime),new DocumentKey(decodeResourcePath(T.documentKey)),T.largestBatchId)):IndexState.empty(),P=S.fields.map(([S,T])=>new IndexSegment(FieldPath$1.fromServerFormat(S),T));return new FieldIndex(S.indexId,S.collectionGroup,P,R)}function toDbIndexState(S,T,R,P){return{indexId:S,uid:T,sequenceNumber:R,readTime:toDbTimestamp(P.readTime),documentKey:encodeResourcePath(P.documentKey.path),largestBatchId:P.largestBatchId}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbBundleCache=class IndexedDbBundleCache{getBundleMetadata(S,T){return bundlesStore(S).get(T).next(S=>{if(S)return fromDbBundle(S)})}saveBundleMetadata(S,T){return bundlesStore(S).put(toDbBundle(T))}getNamedQuery(S,T){return namedQueriesStore(S).get(T).next(S=>{if(S)return fromDbNamedQuery(S)})}saveNamedQuery(S,T){return namedQueriesStore(S).put(toDbNamedQuery(T))}};function bundlesStore(S){return getStore(S,e6)}function namedQueriesStore(S){return getStore(S,e9)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbDocumentOverlayCache=class IndexedDbDocumentOverlayCache{constructor(S,T){this.serializer=S,this.userId=T}static forUser(S,T){let R=T.uid||"";return new IndexedDbDocumentOverlayCache(S,R)}getOverlay(S,T){return documentOverlayStore(S).get(toDbDocumentOverlayKey(this.userId,T)).next(S=>S?fromDbDocumentOverlay(this.serializer,S):null)}getOverlays(S,T){let R=newOverlayMap();return PersistencePromise.forEach(T,T=>this.getOverlay(S,T).next(S=>{null!==S&&R.set(T,S)})).next(()=>R)}saveOverlays(S,T,R){let P=[];return R.forEach((R,O)=>{let N=new Overlay(T,O);P.push(this.saveOverlay(S,N))}),PersistencePromise.waitFor(P)}removeOverlaysForBatchId(S,T,R){let P=new Set;T.forEach(S=>P.add(encodeResourcePath(S.getCollectionPath())));let O=[];return P.forEach(T=>{let P=IDBKeyRange.bound([this.userId,T,R],[this.userId,T,R+1],!1,!0);O.push(documentOverlayStore(S).deleteAll(tf,P))}),PersistencePromise.waitFor(O)}getOverlaysForCollection(S,T,R){let P=newOverlayMap(),O=encodeResourcePath(T),N=IDBKeyRange.bound([this.userId,O,R],[this.userId,O,Number.POSITIVE_INFINITY],!0);return documentOverlayStore(S).loadAll(tf,N).next(S=>{for(let T of S){let S=fromDbDocumentOverlay(this.serializer,T);P.set(S.getKey(),S)}return P})}getOverlaysForCollectionGroup(S,T,R,P){let O;let N=newOverlayMap(),M=IDBKeyRange.bound([this.userId,T,R],[this.userId,T,Number.POSITIVE_INFINITY],!0);return documentOverlayStore(S).iterate({index:tg,range:M},(S,T,R)=>{let M=fromDbDocumentOverlay(this.serializer,T);N.size()<P||M.largestBatchId===O?(N.set(M.getKey(),M),O=M.largestBatchId):R.done()}).next(()=>N)}saveOverlay(S,T){return documentOverlayStore(S).put(toDbDocumentOverlay(this.serializer,this.userId,T))}};function documentOverlayStore(S){return getStore(S,th)}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbGlobalsCache=class IndexedDbGlobalsCache{globalsStore(S){return getStore(S,tv)}getSessionToken(S){let T=this.globalsStore(S);return T.get("sessionToken").next(S=>{let T=null==S?void 0:S.value;return T?ByteString.fromUint8Array(T):ByteString.EMPTY_BYTE_STRING})}setSessionToken(S,T){let R=this.globalsStore(S);return R.put({name:"sessionToken",value:T.toUint8Array()})}};/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let t6=5,t4=10,t9=13,t5=15,t8=20,t7=25,rt=30,rr=37,rn=45,ri=50,rs=53,ra=55,ro=60,rl=2;let FirestoreIndexValueWriter=class FirestoreIndexValueWriter{constructor(){}writeIndexValue(S,T){this.writeIndexValueAux(S,T),T.writeInfinity()}writeIndexValueAux(S,T){if("nullValue"in S)this.writeValueTypeLabel(T,t6);else if("booleanValue"in S)this.writeValueTypeLabel(T,t4),T.writeNumber(S.booleanValue?1:0);else if("integerValue"in S)this.writeValueTypeLabel(T,t5),T.writeNumber(normalizeNumber(S.integerValue));else if("doubleValue"in S){let R=normalizeNumber(S.doubleValue);isNaN(R)?this.writeValueTypeLabel(T,t9):(this.writeValueTypeLabel(T,t5),isNegativeZero(R)?T.writeNumber(0):T.writeNumber(R))}else if("timestampValue"in S){let R=S.timestampValue;this.writeValueTypeLabel(T,t8),"string"==typeof R&&(R=normalizeTimestamp(R)),T.writeString(`${R.seconds||""}`),T.writeNumber(R.nanos||0)}else if("stringValue"in S)this.writeIndexString(S.stringValue,T),this.writeTruncationMarker(T);else if("bytesValue"in S)this.writeValueTypeLabel(T,rt),T.writeBytes(normalizeByteString(S.bytesValue)),this.writeTruncationMarker(T);else if("referenceValue"in S)this.writeIndexEntityRef(S.referenceValue,T);else if("geoPointValue"in S){let R=S.geoPointValue;this.writeValueTypeLabel(T,rn),T.writeNumber(R.latitude||0),T.writeNumber(R.longitude||0)}else"mapValue"in S?isMaxValue(S)?this.writeValueTypeLabel(T,Number.MAX_SAFE_INTEGER):isVectorValue(S)?this.writeIndexVector(S.mapValue,T):(this.writeIndexMap(S.mapValue,T),this.writeTruncationMarker(T)):"arrayValue"in S?(this.writeIndexArray(S.arrayValue,T),this.writeTruncationMarker(T)):fail()}writeIndexString(S,T){this.writeValueTypeLabel(T,t7),this.writeUnlabeledIndexString(S,T)}writeUnlabeledIndexString(S,T){T.writeString(S)}writeIndexMap(S,T){let R=S.fields||{};for(let S of(this.writeValueTypeLabel(T,ra),Object.keys(R)))this.writeIndexString(S,T),this.writeIndexValueAux(R[S],T)}writeIndexVector(S,T){var R,P;let O=S.fields||{};this.writeValueTypeLabel(T,rs);let N=tW,M=(null===(P=null===(R=O[N].arrayValue)||void 0===R?void 0:R.values)||void 0===P?void 0:P.length)||0;this.writeValueTypeLabel(T,t5),T.writeNumber(normalizeNumber(M)),this.writeIndexString(N,T),this.writeIndexValueAux(O[N],T)}writeIndexArray(S,T){let R=S.values||[];for(let S of(this.writeValueTypeLabel(T,ri),R))this.writeIndexValueAux(S,T)}writeIndexEntityRef(S,T){this.writeValueTypeLabel(T,rr);let R=DocumentKey.fromName(S).path;R.forEach(S=>{this.writeValueTypeLabel(T,ro),this.writeUnlabeledIndexString(S,T)})}writeValueTypeLabel(S,T){S.writeNumber(T)}writeTruncationMarker(S){S.writeNumber(rl)}};FirestoreIndexValueWriter.INSTANCE=new FirestoreIndexValueWriter;/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law | agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES | CONDITIONS OF ANY KIND, either express | implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ru="\uD800",rc="\uDBFF",rd=0,rh=255,rp=1,rf=255,rm=255,rg=0,ry=64,rv=8,rS=1024;function doubleToLongBits(S){let T=new DataView(new ArrayBuffer(8));return T.setFloat64(0,S,!1),new Uint8Array(T.buffer)}function numberOfLeadingZerosInByte(S){if(0===S)return 8;let T=0;return S>>4==0&&(T+=4,S<<=4),S>>6==0&&(T+=2,S<<=2),S>>7==0&&(T+=1),T}function numberOfLeadingZeros(S){let T=0;for(let R=0;R<8;++R){let P=numberOfLeadingZerosInByte(255&S[R]);if(T+=P,8!==P)break}return T}function unsignedNumLength(S){let T=ry-numberOfLeadingZeros(S);return Math.ceil(T/rv)}let OrderedCodeWriter=class OrderedCodeWriter{constructor(){this.buffer=new Uint8Array(rS),this.position=0}writeBytesAscending(S){let T=S[Symbol.iterator](),R=T.next();for(;!R.done;)this.writeByteAscending(R.value),R=T.next();this.writeSeparatorAscending()}writeBytesDescending(S){let T=S[Symbol.iterator](),R=T.next();for(;!R.done;)this.writeByteDescending(R.value),R=T.next();this.writeSeparatorDescending()}writeUtf8Ascending(S){for(let T of S){let S=T.charCodeAt(0);if(S<128)this.writeByteAscending(S);else if(S<2048)this.writeByteAscending(960|S>>>6),this.writeByteAscending(128|63&S);else if(T<ru||rc<T)this.writeByteAscending(480|S>>>12),this.writeByteAscending(128|63&S>>>6),this.writeByteAscending(128|63&S);else{let S=T.codePointAt(0);this.writeByteAscending(240|S>>>18),this.writeByteAscending(128|63&S>>>12),this.writeByteAscending(128|63&S>>>6),this.writeByteAscending(128|63&S)}}this.writeSeparatorAscending()}writeUtf8Descending(S){for(let T of S){let S=T.charCodeAt(0);if(S<128)this.writeByteDescending(S);else if(S<2048)this.writeByteDescending(960|S>>>6),this.writeByteDescending(128|63&S);else if(T<ru||rc<T)this.writeByteDescending(480|S>>>12),this.writeByteDescending(128|63&S>>>6),this.writeByteDescending(128|63&S);else{let S=T.codePointAt(0);this.writeByteDescending(240|S>>>18),this.writeByteDescending(128|63&S>>>12),this.writeByteDescending(128|63&S>>>6),this.writeByteDescending(128|63&S)}}this.writeSeparatorDescending()}writeNumberAscending(S){let T=this.toOrderedBits(S),R=unsignedNumLength(T);this.ensureAvailable(1+R),this.buffer[this.position++]=255&R;for(let S=T.length-R;S<T.length;++S)this.buffer[this.position++]=255&T[S]}writeNumberDescending(S){let T=this.toOrderedBits(S),R=unsignedNumLength(T);this.ensureAvailable(1+R),this.buffer[this.position++]=~(255&R);for(let S=T.length-R;S<T.length;++S)this.buffer[this.position++]=~(255&T[S])}writeInfinityAscending(){this.writeEscapedByteAscending(rf),this.writeEscapedByteAscending(rm)}writeInfinityDescending(){this.writeEscapedByteDescending(rf),this.writeEscapedByteDescending(rm)}reset(){this.position=0}seed(S){this.ensureAvailable(S.length),this.buffer.set(S,this.position),this.position+=S.length}encodedBytes(){return this.buffer.slice(0,this.position)}toOrderedBits(S){let T=doubleToLongBits(S),R=(128&T[0])!=0;T[0]^=R?255:128;for(let S=1;S<T.length;++S)T[S]^=R?255:0;return T}writeByteAscending(S){let T=255&S;T===rd?(this.writeEscapedByteAscending(rd),this.writeEscapedByteAscending(rh)):T===rf?(this.writeEscapedByteAscending(rf),this.writeEscapedByteAscending(rg)):this.writeEscapedByteAscending(T)}writeByteDescending(S){let T=255&S;T===rd?(this.writeEscapedByteDescending(rd),this.writeEscapedByteDescending(rh)):T===rf?(this.writeEscapedByteDescending(rf),this.writeEscapedByteDescending(rg)):this.writeEscapedByteDescending(S)}writeSeparatorAscending(){this.writeEscapedByteAscending(rd),this.writeEscapedByteAscending(rp)}writeSeparatorDescending(){this.writeEscapedByteDescending(rd),this.writeEscapedByteDescending(rp)}writeEscapedByteAscending(S){this.ensureAvailable(1),this.buffer[this.position++]=S}writeEscapedByteDescending(S){this.ensureAvailable(1),this.buffer[this.position++]=~S}ensureAvailable(S){let T=S+this.position;if(T<=this.buffer.length)return;let R=2*this.buffer.length;R<T&&(R=T);let P=new Uint8Array(R);P.set(this.buffer),this.buffer=P}};let AscendingIndexByteEncoder=class AscendingIndexByteEncoder{constructor(S){this.orderedCode=S}writeBytes(S){this.orderedCode.writeBytesAscending(S)}writeString(S){this.orderedCode.writeUtf8Ascending(S)}writeNumber(S){this.orderedCode.writeNumberAscending(S)}writeInfinity(){this.orderedCode.writeInfinityAscending()}};let DescendingIndexByteEncoder=class DescendingIndexByteEncoder{constructor(S){this.orderedCode=S}writeBytes(S){this.orderedCode.writeBytesDescending(S)}writeString(S){this.orderedCode.writeUtf8Descending(S)}writeNumber(S){this.orderedCode.writeNumberDescending(S)}writeInfinity(){this.orderedCode.writeInfinityDescending()}};let IndexByteEncoder=class IndexByteEncoder{constructor(){this.orderedCode=new OrderedCodeWriter,this.ascending=new AscendingIndexByteEncoder(this.orderedCode),this.descending=new DescendingIndexByteEncoder(this.orderedCode)}seed(S){this.orderedCode.seed(S)}forKind(S){return 0===S?this.ascending:this.descending}encodedBytes(){return this.orderedCode.encodedBytes()}reset(){this.orderedCode.reset()}};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexEntry=class IndexEntry{constructor(S,T,R,P){this.indexId=S,this.documentKey=T,this.arrayValue=R,this.directionalValue=P}successor(){let S=this.directionalValue.length,T=0===S||255===this.directionalValue[S-1]?S+1:S,R=new Uint8Array(T);return R.set(this.directionalValue,0),T!==S?R.set([0],this.directionalValue.length):++R[R.length-1],new IndexEntry(this.indexId,this.documentKey,this.arrayValue,R)}};function indexEntryComparator(S,T){let R=S.indexId-T.indexId;return 0!==R||0!==(R=compareByteArrays(S.arrayValue,T.arrayValue))||0!==(R=compareByteArrays(S.directionalValue,T.directionalValue))?R:DocumentKey.comparator(S.documentKey,T.documentKey)}function compareByteArrays(S,T){for(let R=0;R<S.length&&R<T.length;++R){let P=S[R]-T[R];if(0!==P)return P}return S.length-T.length}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let TargetIndexMatcher=class TargetIndexMatcher{constructor(S){for(let T of(this.inequalityFilters=new SortedSet((S,T)=>FieldPath$1.comparator(S.field,T.field)),this.collectionId=null!=S.collectionGroup?S.collectionGroup:S.path.lastSegment(),this.orderBys=S.orderBy,this.equalityFilters=[],S.filters)){let S=T;S.isInequality()?this.inequalityFilters=this.inequalityFilters.add(S):this.equalityFilters.push(S)}}get hasMultipleInequality(){return this.inequalityFilters.size>1}servedByIndex(S){if(hardAssert(S.collectionGroup===this.collectionId),this.hasMultipleInequality)return!1;let T=fieldIndexGetArraySegment(S);if(void 0!==T&&!this.hasMatchingEqualityFilter(T))return!1;let R=fieldIndexGetDirectionalSegments(S),P=new Set,O=0,N=0;for(;O<R.length;++O)if(this.hasMatchingEqualityFilter(R[O]))P=P.add(R[O].fieldPath.canonicalString());else break;if(O===R.length)return!0;if(this.inequalityFilters.size>0){let S=this.inequalityFilters.getIterator().getNext();if(!P.has(S.field.canonicalString())){let T=R[O];if(!this.matchesFilter(S,T)||!this.matchesOrderBy(this.orderBys[N++],T))return!1}++O}for(;O<R.length;++O){let S=R[O];if(N>=this.orderBys.length||!this.matchesOrderBy(this.orderBys[N++],S))return!1}return!0}buildTargetIndex(){if(this.hasMultipleInequality)return null;let S=new SortedSet(FieldPath$1.comparator),T=[];for(let R of this.equalityFilters){if(R.field.isKeyField())continue;let P="array-contains"===R.op||"array-contains-any"===R.op;if(P)T.push(new IndexSegment(R.field,2));else{if(S.has(R.field))continue;S=S.add(R.field),T.push(new IndexSegment(R.field,0))}}for(let R of this.orderBys)R.field.isKeyField()||S.has(R.field)||(S=S.add(R.field),T.push(new IndexSegment(R.field,"asc"===R.dir?0:1)));return new FieldIndex(FieldIndex.UNKNOWN_ID,this.collectionId,T,IndexState.empty())}hasMatchingEqualityFilter(S){for(let T of this.equalityFilters)if(this.matchesFilter(T,S))return!0;return!1}matchesFilter(S,T){if(void 0===S||!S.field.isEqual(T.fieldPath))return!1;let R="array-contains"===S.op||"array-contains-any"===S.op;return 2===T.kind===R}matchesOrderBy(S,T){return!!S.field.isEqual(T.fieldPath)&&(0===T.kind&&"asc"===S.dir||1===T.kind&&"desc"===S.dir)}};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function computeInExpansion(S){var T,R;if(hardAssert(S instanceof FieldFilter||S instanceof CompositeFilter),S instanceof FieldFilter){if(!(S instanceof InFilter))return S;{let P=(null===(R=null===(T=S.value.arrayValue)||void 0===T?void 0:T.values)||void 0===R?void 0:R.map(T=>FieldFilter.create(S.field,"==",T)))||[];return CompositeFilter.create(P,"or")}}let P=S.filters.map(S=>computeInExpansion(S));return CompositeFilter.create(P,S.op)}function getDnfTerms(S){if(0===S.getFilters().length)return[];let T=computeDistributedNormalForm(computeInExpansion(S));return(hardAssert(isDisjunctiveNormalForm(T)),isSingleFieldFilter(T)||isFlatConjunction(T))?[T]:T.getFilters()}function isSingleFieldFilter(S){return S instanceof FieldFilter}function isFlatConjunction(S){return S instanceof CompositeFilter&&compositeFilterIsFlatConjunction(S)}function isDisjunctiveNormalForm(S){return isSingleFieldFilter(S)||isFlatConjunction(S)||isDisjunctionOfFieldFiltersAndFlatConjunctions(S)}function isDisjunctionOfFieldFiltersAndFlatConjunctions(S){if(S instanceof CompositeFilter&&compositeFilterIsDisjunction(S)){for(let T of S.getFilters())if(!isSingleFieldFilter(T)&&!isFlatConjunction(T))return!1;return!0}return!1}function computeDistributedNormalForm(S){if(hardAssert(S instanceof FieldFilter||S instanceof CompositeFilter),S instanceof FieldFilter)return S;if(1===S.filters.length)return computeDistributedNormalForm(S.filters[0]);let T=S.filters.map(S=>computeDistributedNormalForm(S)),R=CompositeFilter.create(T,S.op);return isDisjunctiveNormalForm(R=applyAssociation(R))?R:(hardAssert(R instanceof CompositeFilter),hardAssert(compositeFilterIsConjunction(R)),hardAssert(R.filters.length>1),R.filters.reduce((S,T)=>applyDistribution(S,T)))}function applyDistribution(S,T){let R;return hardAssert(S instanceof FieldFilter||S instanceof CompositeFilter),hardAssert(T instanceof FieldFilter||T instanceof CompositeFilter),applyAssociation(R=S instanceof FieldFilter?T instanceof FieldFilter?applyDistributionFieldFilters(S,T):applyDistributionFieldAndCompositeFilters(S,T):T instanceof FieldFilter?applyDistributionFieldAndCompositeFilters(T,S):applyDistributionCompositeFilters(S,T))}function applyDistributionFieldFilters(S,T){return CompositeFilter.create([S,T],"and")}function applyDistributionCompositeFilters(S,T){if(hardAssert(S.filters.length>0&&T.filters.length>0),compositeFilterIsConjunction(S)&&compositeFilterIsConjunction(T))return compositeFilterWithAddedFilters(S,T.getFilters());let R=compositeFilterIsDisjunction(S)?S:T,P=compositeFilterIsDisjunction(S)?T:S,O=R.filters.map(S=>applyDistribution(S,P));return CompositeFilter.create(O,"or")}function applyDistributionFieldAndCompositeFilters(S,T){if(compositeFilterIsConjunction(T))return compositeFilterWithAddedFilters(T,S.getFilters());{let R=T.filters.map(T=>applyDistribution(S,T));return CompositeFilter.create(R,"or")}}function applyAssociation(S){if(hardAssert(S instanceof FieldFilter||S instanceof CompositeFilter),S instanceof FieldFilter)return S;let T=S.getFilters();if(1===T.length)return applyAssociation(T[0]);if(compositeFilterIsFlat(S))return S;let R=T.map(S=>applyAssociation(S)),P=[];return(R.forEach(T=>{T instanceof FieldFilter?P.push(T):T instanceof CompositeFilter&&(T.op===S.op?P.push(...T.filters):P.push(T))}),1===P.length)?P[0]:CompositeFilter.create(P,S.op)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryIndexManager=class MemoryIndexManager{constructor(){this.collectionParentIndex=new MemoryCollectionParentIndex}addToCollectionParentIndex(S,T){return this.collectionParentIndex.add(T),PersistencePromise.resolve()}getCollectionParents(S,T){return PersistencePromise.resolve(this.collectionParentIndex.getEntries(T))}addFieldIndex(S,T){return PersistencePromise.resolve()}deleteFieldIndex(S,T){return PersistencePromise.resolve()}deleteAllFieldIndexes(S){return PersistencePromise.resolve()}createTargetIndexes(S,T){return PersistencePromise.resolve()}getDocumentsMatchingTarget(S,T){return PersistencePromise.resolve(null)}getIndexType(S,T){return PersistencePromise.resolve(0)}getFieldIndexes(S,T){return PersistencePromise.resolve([])}getNextCollectionGroupToUpdate(S){return PersistencePromise.resolve(null)}getMinOffset(S,T){return PersistencePromise.resolve(IndexOffset.min())}getMinOffsetFromCollectionGroup(S,T){return PersistencePromise.resolve(IndexOffset.min())}updateCollectionGroup(S,T,R){return PersistencePromise.resolve()}updateIndexEntries(S,T){return PersistencePromise.resolve()}};let MemoryCollectionParentIndex=class MemoryCollectionParentIndex{constructor(){this.index={}}add(S){let T=S.lastSegment(),R=S.popLast(),P=this.index[T]||new SortedSet(ResourcePath.comparator),O=!P.has(R);return this.index[T]=P.add(R),O}has(S){let T=S.lastSegment(),R=S.popLast(),P=this.index[T];return P&&P.has(R)}getEntries(S){let T=this.index[S]||new SortedSet(ResourcePath.comparator);return T.toArray()}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rb="IndexedDbIndexManager",rC=new Uint8Array(0);let IndexedDbIndexManager=class IndexedDbIndexManager{constructor(S,T){this.databaseId=T,this.collectionParentsCache=new MemoryCollectionParentIndex,this.targetToDnfSubTargets=new ObjectMap(S=>canonifyTarget(S),(S,T)=>targetEquals(S,T)),this.uid=S.uid||""}addToCollectionParentIndex(S,T){if(!this.collectionParentsCache.has(T)){let R=T.lastSegment(),P=T.popLast();S.addOnCommittedListener(()=>{this.collectionParentsCache.add(T)});let O={collectionId:R,parent:encodeResourcePath(P)};return collectionParentsStore(S).put(O)}return PersistencePromise.resolve()}getCollectionParents(S,T){let R=[],P=IDBKeyRange.bound([T,""],[immediateSuccessor(T),""],!1,!0);return collectionParentsStore(S).loadAll(P).next(S=>{for(let P of S){if(P.collectionId!==T)break;R.push(decodeResourcePath(P.parent))}return R})}addFieldIndex(S,T){let R=indexConfigurationStore(S),P=toDbIndexConfiguration(T);delete P.indexId;let O=R.add(P);if(!T.indexState)return O.next();{let R=indexStateStore(S);return O.next(S=>{R.put(toDbIndexState(S,this.uid,T.indexState.sequenceNumber,T.indexState.offset))})}}deleteFieldIndex(S,T){let R=indexConfigurationStore(S),P=indexStateStore(S),O=indexEntriesStore(S);return R.delete(T.indexId).next(()=>P.delete(IDBKeyRange.bound([T.indexId],[T.indexId+1],!1,!0))).next(()=>O.delete(IDBKeyRange.bound([T.indexId],[T.indexId+1],!1,!0)))}deleteAllFieldIndexes(S){let T=indexConfigurationStore(S),R=indexEntriesStore(S),P=indexStateStore(S);return T.deleteAll().next(()=>R.deleteAll()).next(()=>P.deleteAll())}createTargetIndexes(S,T){return PersistencePromise.forEach(this.getSubTargets(T),T=>this.getIndexType(S,T).next(R=>{if(0===R||1===R){let R=new TargetIndexMatcher(T),P=R.buildTargetIndex();if(null!=P)return this.addFieldIndex(S,P)}}))}getDocumentsMatchingTarget(S,T){let R=indexEntriesStore(S),P=!0,O=new Map;return PersistencePromise.forEach(this.getSubTargets(T),T=>this.getFieldIndex(S,T).next(S=>{P&&(P=!!S),O.set(T,S)})).next(()=>{if(!P)return PersistencePromise.resolve(null);{let S=documentKeySet(),P=[];return PersistencePromise.forEach(O,(O,N)=>{logDebug(rb,`Using index ${fieldIndexToString(O)} to execute ${canonifyTarget(T)}`);let M=targetGetArrayValues(N,O),L=targetGetNotInValues(N,O),V=targetGetLowerBound(N,O),U=targetGetUpperBound(N,O),W=this.encodeBound(O,N,V),K=this.encodeBound(O,N,U),Q=this.encodeValues(O,N,L),$=this.generateIndexRanges(O.indexId,M,W,V.inclusive,K,U.inclusive,Q);return PersistencePromise.forEach($,O=>R.loadFirst(O,T.limit).next(T=>{T.forEach(T=>{let R=DocumentKey.fromSegments(T.documentKey);S.has(R)||(S=S.add(R),P.push(R))})}))}).next(()=>P)}})}getSubTargets(S){let T=this.targetToDnfSubTargets.get(S);if(T)return T;if(0===S.filters.length)T=[S];else{let R=getDnfTerms(CompositeFilter.create(S.filters,"and"));T=R.map(T=>newTarget(S.path,S.collectionGroup,S.orderBy,T.getFilters(),S.limit,S.startAt,S.endAt))}return this.targetToDnfSubTargets.set(S,T),T}generateIndexRanges(S,T,R,P,O,N,M){let L=(null!=T?T.length:1)*Math.max(R.length,O.length),V=L/(null!=T?T.length:1),U=[];for(let W=0;W<L;++W){let L=T?this.encodeSingleElement(T[W/V]):rC,K=this.generateLowerBound(S,L,R[W%V],P),Q=this.generateUpperBound(S,L,O[W%V],N),$=M.map(T=>this.generateLowerBound(S,L,T,!0));U.push(...this.createRange(K,Q,$))}return U}generateLowerBound(S,T,R,P){let O=new IndexEntry(S,DocumentKey.empty(),T,R);return P?O:O.successor()}generateUpperBound(S,T,R,P){let O=new IndexEntry(S,DocumentKey.empty(),T,R);return P?O.successor():O}getFieldIndex(S,T){let R=new TargetIndexMatcher(T),P=null!=T.collectionGroup?T.collectionGroup:T.path.lastSegment();return this.getFieldIndexes(S,P).next(S=>{let T=null;for(let P of S){let S=R.servedByIndex(P);S&&(!T||P.fields.length>T.fields.length)&&(T=P)}return T})}getIndexType(S,T){let R=2,P=this.getSubTargets(T);return PersistencePromise.forEach(P,T=>this.getFieldIndex(S,T).next(S=>{S?0!==R&&S.fields.length<targetGetSegmentCount(T)&&(R=1):R=0})).next(()=>targetHasLimit(T)&&P.length>1&&2===R?1:R)}encodeDirectionalElements(S,T){let R=new IndexByteEncoder;for(let P of fieldIndexGetDirectionalSegments(S)){let S=T.data.field(P.fieldPath);if(null==S)return null;let O=R.forKind(P.kind);FirestoreIndexValueWriter.INSTANCE.writeIndexValue(S,O)}return R.encodedBytes()}encodeSingleElement(S){let T=new IndexByteEncoder;return FirestoreIndexValueWriter.INSTANCE.writeIndexValue(S,T.forKind(0)),T.encodedBytes()}encodeDirectionalKey(S,T){let R=new IndexByteEncoder;return FirestoreIndexValueWriter.INSTANCE.writeIndexValue(refValue(this.databaseId,T),R.forKind(fieldIndexGetKeyOrder(S))),R.encodedBytes()}encodeValues(S,T,R){if(null===R)return[];let P=[];P.push(new IndexByteEncoder);let O=0;for(let N of fieldIndexGetDirectionalSegments(S)){let S=R[O++];for(let R of P)if(this.isInFilter(T,N.fieldPath)&&isArray(S))P=this.expandIndexValues(P,N,S);else{let T=R.forKind(N.kind);FirestoreIndexValueWriter.INSTANCE.writeIndexValue(S,T)}}return this.getEncodedBytes(P)}encodeBound(S,T,R){return this.encodeValues(S,T,R.position)}getEncodedBytes(S){let T=[];for(let R=0;R<S.length;++R)T[R]=S[R].encodedBytes();return T}expandIndexValues(S,T,R){let P=[...S],O=[];for(let S of R.arrayValue.values||[])for(let R of P){let P=new IndexByteEncoder;P.seed(R.encodedBytes()),FirestoreIndexValueWriter.INSTANCE.writeIndexValue(S,P.forKind(T.kind)),O.push(P)}return O}isInFilter(S,T){return!!S.filters.find(S=>S instanceof FieldFilter&&S.field.isEqual(T)&&("in"===S.op||"not-in"===S.op))}getFieldIndexes(S,T){let R=indexConfigurationStore(S),P=indexStateStore(S);return(T?R.loadAll(te,IDBKeyRange.bound(T,T)):R.loadAll()).next(S=>{let T=[];return PersistencePromise.forEach(S,S=>P.get([S.indexId,this.uid]).next(R=>{T.push(fromDbIndexConfiguration(S,R))})).next(()=>T)})}getNextCollectionGroupToUpdate(S){return this.getFieldIndexes(S).next(S=>0===S.length?null:(S.sort((S,T)=>{let R=S.indexState.sequenceNumber-T.indexState.sequenceNumber;return 0!==R?R:primitiveComparator(S.collectionGroup,T.collectionGroup)}),S[0].collectionGroup))}updateCollectionGroup(S,T,R){let P=indexConfigurationStore(S),O=indexStateStore(S);return this.getNextSequenceNumber(S).next(S=>P.loadAll(te,IDBKeyRange.bound(T,T)).next(T=>PersistencePromise.forEach(T,T=>O.put(toDbIndexState(T.indexId,this.uid,S,R)))))}updateIndexEntries(S,T){let R=new Map;return PersistencePromise.forEach(T,(T,P)=>{let O=R.get(T.collectionGroup),N=O?PersistencePromise.resolve(O):this.getFieldIndexes(S,T.collectionGroup);return N.next(O=>(R.set(T.collectionGroup,O),PersistencePromise.forEach(O,R=>this.getExistingIndexEntries(S,T,R).next(T=>{let O=this.computeIndexEntries(P,R);return T.isEqual(O)?PersistencePromise.resolve():this.updateEntries(S,P,R,T,O)}))))})}addIndexEntry(S,T,R,P){let O=indexEntriesStore(S);return O.put({indexId:P.indexId,uid:this.uid,arrayValue:P.arrayValue,directionalValue:P.directionalValue,orderedDocumentKey:this.encodeDirectionalKey(R,T.key),documentKey:T.key.path.toArray()})}deleteIndexEntry(S,T,R,P){let O=indexEntriesStore(S);return O.delete([P.indexId,this.uid,P.arrayValue,P.directionalValue,this.encodeDirectionalKey(R,T.key),T.key.path.toArray()])}getExistingIndexEntries(S,T,R){let P=indexEntriesStore(S),O=new SortedSet(indexEntryComparator);return P.iterate({index:tc,range:IDBKeyRange.only([R.indexId,this.uid,this.encodeDirectionalKey(R,T)])},(S,P)=>{O=O.add(new IndexEntry(R.indexId,T,P.arrayValue,P.directionalValue))}).next(()=>O)}computeIndexEntries(S,T){let R=new SortedSet(indexEntryComparator),P=this.encodeDirectionalElements(T,S);if(null==P)return R;let O=fieldIndexGetArraySegment(T);if(null!=O){let N=S.data.field(O.fieldPath);if(isArray(N))for(let O of N.arrayValue.values||[])R=R.add(new IndexEntry(T.indexId,S.key,this.encodeSingleElement(O),P))}else R=R.add(new IndexEntry(T.indexId,S.key,rC,P));return R}updateEntries(S,T,R,P,O){logDebug(rb,"Updating index entries for document '%s'",T.key);let N=[];return diffSortedSets(P,O,indexEntryComparator,P=>{N.push(this.addIndexEntry(S,T,R,P))},P=>{N.push(this.deleteIndexEntry(S,T,R,P))}),PersistencePromise.waitFor(N)}getNextSequenceNumber(S){let T=1,R=indexStateStore(S);return R.iterate({index:ts,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(S,R,P)=>{P.done(),T=R.sequenceNumber+1}).next(()=>T)}createRange(S,T,R){R=R.sort((S,T)=>indexEntryComparator(S,T)).filter((S,T,R)=>!T||0!==indexEntryComparator(S,R[T-1]));let P=[];for(let O of(P.push(S),R)){let R=indexEntryComparator(O,S),N=indexEntryComparator(O,T);if(0===R)P[0]=S.successor();else if(R>0&&N<0)P.push(O),P.push(O.successor());else if(N>0)break}P.push(T);let O=[];for(let S=0;S<P.length;S+=2){if(this.isRangeMatchable(P[S],P[S+1]))return[];let T=[P[S].indexId,this.uid,P[S].arrayValue,P[S].directionalValue,rC,[]],R=[P[S+1].indexId,this.uid,P[S+1].arrayValue,P[S+1].directionalValue,rC,[]];O.push(IDBKeyRange.bound(T,R))}return O}isRangeMatchable(S,T){return indexEntryComparator(S,T)>0}getMinOffsetFromCollectionGroup(S,T){return this.getFieldIndexes(S,T).next(getMinOffsetFromFieldIndexes)}getMinOffset(S,T){return PersistencePromise.mapArray(this.getSubTargets(T),T=>this.getFieldIndex(S,T).next(S=>S||fail())).next(getMinOffsetFromFieldIndexes)}};function collectionParentsStore(S){return getStore(S,e0)}function indexEntriesStore(S){return getStore(S,tl)}function indexConfigurationStore(S){return getStore(S,e8)}function indexStateStore(S){return getStore(S,tr)}function getMinOffsetFromFieldIndexes(S){hardAssert(0!==S.length);let T=S[0].indexState.offset,R=T.largestBatchId;for(let P=1;P<S.length;P++){let O=S[P].indexState.offset;0>indexOffsetComparator(O,T)&&(T=O),R<O.largestBatchId&&(R=O.largestBatchId)}return new IndexOffset(T.readTime,T.documentKey,R)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function removeMutationBatch(S,T,R){let P=S.store(eA),O=S.store(eM),N=[],M=IDBKeyRange.only(R.batchId),L=0,V=P.iterate({range:M},(S,T,R)=>(L++,R.delete()));N.push(V.next(()=>{hardAssert(1===L)}));let U=[];for(let S of R.mutations){let P=newDbDocumentMutationKey(T,S.key.path,R.batchId);N.push(O.delete(P)),U.push(S.key)}return PersistencePromise.waitFor(N).next(()=>U)}function dbDocumentSize(S){let T;if(!S)return 0;if(S.document)T=S.document;else if(S.unknownDocument)T=S.unknownDocument;else if(S.noDocument)T=S.noDocument;else throw fail();return JSON.stringify(T).length}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbMutationQueue=class IndexedDbMutationQueue{constructor(S,T,R,P){this.userId=S,this.serializer=T,this.indexManager=R,this.referenceDelegate=P,this.documentKeysByBatchId={}}static forUser(S,T,R,P){hardAssert(""!==S.uid);let O=S.isAuthenticated()?S.uid:"";return new IndexedDbMutationQueue(O,T,R,P)}checkEmpty(S){let T=!0,R=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(S).iterate({index:eN,range:R},(S,R,P)=>{T=!1,P.done()}).next(()=>T)}addMutationBatch(S,T,R,P){let O=documentMutationsStore(S),N=mutationsStore(S);return N.add({}).next(M=>{hardAssert("number"==typeof M);let L=new MutationBatch(M,T,R,P),V=toDbMutationBatch(this.serializer,this.userId,L),U=[],W=new SortedSet((S,T)=>primitiveComparator(S.canonicalString(),T.canonicalString()));for(let S of P){let T=newDbDocumentMutationKey(this.userId,S.key.path,M);W=W.add(S.key.path.popLast()),U.push(N.put(V)),U.push(O.put(T,ex))}return W.forEach(T=>{U.push(this.indexManager.addToCollectionParentIndex(S,T))}),S.addOnCommittedListener(()=>{this.documentKeysByBatchId[M]=L.keys()}),PersistencePromise.waitFor(U).next(()=>L)})}lookupMutationBatch(S,T){return mutationsStore(S).get(T).next(S=>S?(hardAssert(S.userId===this.userId),fromDbMutationBatch(this.serializer,S)):null)}lookupMutationKeys(S,T){return this.documentKeysByBatchId[T]?PersistencePromise.resolve(this.documentKeysByBatchId[T]):this.lookupMutationBatch(S,T).next(S=>{if(!S)return null;{let R=S.keys();return this.documentKeysByBatchId[T]=R,R}})}getNextMutationBatchAfterBatchId(S,T){let R=T+1,P=IDBKeyRange.lowerBound([this.userId,R]),O=null;return mutationsStore(S).iterate({index:eN,range:P},(S,T,P)=>{T.userId===this.userId&&(hardAssert(T.batchId>=R),O=fromDbMutationBatch(this.serializer,T)),P.done()}).next(()=>O)}getHighestUnacknowledgedBatchId(S){let T=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),R=tV;return mutationsStore(S).iterate({index:eN,range:T,reverse:!0},(S,T,P)=>{R=T.batchId,P.done()}).next(()=>R)}getAllMutationBatches(S){let T=IDBKeyRange.bound([this.userId,tV],[this.userId,Number.POSITIVE_INFINITY]);return mutationsStore(S).loadAll(eN,T).next(S=>S.map(S=>fromDbMutationBatch(this.serializer,S)))}getAllMutationBatchesAffectingDocumentKey(S,T){let R=newDbDocumentMutationPrefixForPath(this.userId,T.path),P=IDBKeyRange.lowerBound(R),O=[];return documentMutationsStore(S).iterate({range:P},(R,P,N)=>{let[M,L,V]=R,U=decodeResourcePath(L);if(M!==this.userId||!T.path.isEqual(U)){N.done();return}return mutationsStore(S).get(V).next(S=>{if(!S)throw fail();hardAssert(S.userId===this.userId),O.push(fromDbMutationBatch(this.serializer,S))})}).next(()=>O)}getAllMutationBatchesAffectingDocumentKeys(S,T){let R=new SortedSet(primitiveComparator),P=[];return T.forEach(T=>{let O=newDbDocumentMutationPrefixForPath(this.userId,T.path),N=IDBKeyRange.lowerBound(O),M=documentMutationsStore(S).iterate({range:N},(S,P,O)=>{let[N,M,L]=S,V=decodeResourcePath(M);if(N!==this.userId||!T.path.isEqual(V)){O.done();return}R=R.add(L)});P.push(M)}),PersistencePromise.waitFor(P).next(()=>this.lookupMutationBatches(S,R))}getAllMutationBatchesAffectingQuery(S,T){let R=T.path,P=R.length+1,O=newDbDocumentMutationPrefixForPath(this.userId,R),N=IDBKeyRange.lowerBound(O),M=new SortedSet(primitiveComparator);return documentMutationsStore(S).iterate({range:N},(S,T,O)=>{let[N,L,V]=S,U=decodeResourcePath(L);if(N!==this.userId||!R.isPrefixOf(U)){O.done();return}U.length===P&&(M=M.add(V))}).next(()=>this.lookupMutationBatches(S,M))}lookupMutationBatches(S,T){let R=[],P=[];return T.forEach(T=>{P.push(mutationsStore(S).get(T).next(S=>{if(null===S)throw fail();hardAssert(S.userId===this.userId),R.push(fromDbMutationBatch(this.serializer,S))}))}),PersistencePromise.waitFor(P).next(()=>R)}removeMutationBatch(S,T){return removeMutationBatch(S.simpleDbTransaction,this.userId,T).next(R=>(S.addOnCommittedListener(()=>{this.removeCachedMutationKeys(T.batchId)}),PersistencePromise.forEach(R,T=>this.referenceDelegate.markPotentiallyOrphaned(S,T))))}removeCachedMutationKeys(S){delete this.documentKeysByBatchId[S]}performConsistencyCheck(S){return this.checkEmpty(S).next(T=>{if(!T)return PersistencePromise.resolve();let R=IDBKeyRange.lowerBound(newDbDocumentMutationPrefixForUser(this.userId)),P=[];return documentMutationsStore(S).iterate({range:R},(S,T,R)=>{let O=S[0];if(O!==this.userId){R.done();return}{let T=decodeResourcePath(S[1]);P.push(T)}}).next(()=>{hardAssert(0===P.length)})})}containsKey(S,T){return mutationQueueContainsKey(S,this.userId,T)}getMutationQueueMetadata(S){return mutationQueuesStore(S).get(this.userId).next(S=>S||{userId:this.userId,lastAcknowledgedBatchId:tV,lastStreamToken:""})}};function mutationQueueContainsKey(S,T,R){let P=newDbDocumentMutationPrefixForPath(T,R.path),O=P[1],N=IDBKeyRange.lowerBound(P),M=!1;return documentMutationsStore(S).iterate({range:N,keysOnly:!0},(S,R,P)=>{let[N,L,V]=S;N===T&&L===O&&(M=!0),P.done()}).next(()=>M)}function mutationQueuesContainKey(S,T){let R=!1;return mutationQueuesStore(S).iterateSerial(P=>mutationQueueContainsKey(S,P,T).next(S=>(S&&(R=!0),PersistencePromise.resolve(!S)))).next(()=>R)}function mutationsStore(S){return getStore(S,eA)}function documentMutationsStore(S){return getStore(S,eM)}function mutationQueuesStore(S){return getStore(S,e_)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rT=2;let TargetIdGenerator=class TargetIdGenerator{constructor(S){this.lastId=S}next(){return this.lastId+=rT,this.lastId}static forTargetCache(){return new TargetIdGenerator(2-rT)}static forSyncEngine(){return new TargetIdGenerator(1-rT)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbTargetCache=class IndexedDbTargetCache{constructor(S,T){this.referenceDelegate=S,this.serializer=T}allocateTargetId(S){return this.retrieveMetadata(S).next(T=>{let R=new TargetIdGenerator(T.highestTargetId);return T.highestTargetId=R.next(),this.saveMetadata(S,T).next(()=>T.highestTargetId)})}getLastRemoteSnapshotVersion(S){return this.retrieveMetadata(S).next(S=>SnapshotVersion.fromTimestamp(new Timestamp(S.lastRemoteSnapshotVersion.seconds,S.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(S){return this.retrieveMetadata(S).next(S=>S.highestListenSequenceNumber)}setTargetsMetadata(S,T,R){return this.retrieveMetadata(S).next(P=>(P.highestListenSequenceNumber=T,R&&(P.lastRemoteSnapshotVersion=R.toTimestamp()),T>P.highestListenSequenceNumber&&(P.highestListenSequenceNumber=T),this.saveMetadata(S,P)))}addTargetData(S,T){return this.saveTargetData(S,T).next(()=>this.retrieveMetadata(S).next(R=>(R.targetCount+=1,this.updateMetadataFromTargetData(T,R),this.saveMetadata(S,R))))}updateTargetData(S,T){return this.saveTargetData(S,T)}removeTargetData(S,T){return this.removeMatchingKeysForTargetId(S,T.targetId).next(()=>targetsStore(S).delete(T.targetId)).next(()=>this.retrieveMetadata(S)).next(T=>(hardAssert(T.targetCount>0),T.targetCount-=1,this.saveMetadata(S,T)))}removeTargets(S,T,R){let P=0,O=[];return targetsStore(S).iterate((N,M)=>{let L=fromDbTarget(M);L.sequenceNumber<=T&&null===R.get(L.targetId)&&(P++,O.push(this.removeTargetData(S,L)))}).next(()=>PersistencePromise.waitFor(O)).next(()=>P)}forEachTarget(S,T){return targetsStore(S).iterate((S,R)=>{let P=fromDbTarget(R);T(P)})}retrieveMetadata(S){return globalTargetStore(S).get(eX).next(S=>(hardAssert(null!==S),S))}saveMetadata(S,T){return globalTargetStore(S).put(eX,T)}saveTargetData(S,T){return targetsStore(S).put(toDbTarget(this.serializer,T))}updateMetadataFromTargetData(S,T){let R=!1;return S.targetId>T.highestTargetId&&(T.highestTargetId=S.targetId,R=!0),S.sequenceNumber>T.highestListenSequenceNumber&&(T.highestListenSequenceNumber=S.sequenceNumber,R=!0),R}getTargetCount(S){return this.retrieveMetadata(S).next(S=>S.targetCount)}getTargetData(S,T){let R=canonifyTarget(T),P=IDBKeyRange.bound([R,Number.NEGATIVE_INFINITY],[R,Number.POSITIVE_INFINITY]),O=null;return targetsStore(S).iterate({range:P,index:eG},(S,R,P)=>{let N=fromDbTarget(R);targetEquals(T,N.target)&&(O=N,P.done())}).next(()=>O)}addMatchingKeys(S,T,R){let P=[],O=documentTargetStore(S);return T.forEach(T=>{let N=encodeResourcePath(T.path);P.push(O.put({targetId:R,path:N})),P.push(this.referenceDelegate.addReference(S,R,T))}),PersistencePromise.waitFor(P)}removeMatchingKeys(S,T,R){let P=documentTargetStore(S);return PersistencePromise.forEach(T,T=>{let O=encodeResourcePath(T.path);return PersistencePromise.waitFor([P.delete([R,O]),this.referenceDelegate.removeReference(S,R,T)])})}removeMatchingKeysForTargetId(S,T){let R=documentTargetStore(S),P=IDBKeyRange.bound([T],[T+1],!1,!0);return R.delete(P)}getMatchingKeysForTargetId(S,T){let R=IDBKeyRange.bound([T],[T+1],!1,!0),P=documentTargetStore(S),O=documentKeySet();return P.iterate({range:R,keysOnly:!0},(S,T,R)=>{let P=decodeResourcePath(S[1]),N=new DocumentKey(P);O=O.add(N)}).next(()=>O)}containsKey(S,T){let R=encodeResourcePath(T.path),P=IDBKeyRange.bound([R],[immediateSuccessor(R)],!1,!0),O=0;return documentTargetStore(S).iterate({index:eY,keysOnly:!0,range:P},([S,T],R,P)=>{0!==S&&(O++,P.done())}).next(()=>O>0)}getTargetDataForTarget(S,T){return targetsStore(S).get(T).next(S=>S?fromDbTarget(S):null)}};function targetsStore(S){return getStore(S,eW)}function globalTargetStore(S){return getStore(S,eZ)}function documentTargetStore(S){return getStore(S,e$)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rE={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},rw=-1,rD=41943040;let LruParams=class LruParams{constructor(S,T,R){this.cacheSizeCollectionThreshold=S,this.percentileToCollect=T,this.maximumSequenceNumbersToCollect=R}static withCacheSize(S){return new LruParams(S,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};LruParams.DEFAULT_COLLECTION_PERCENTILE=10,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,LruParams.DEFAULT=new LruParams(rD,LruParams.DEFAULT_COLLECTION_PERCENTILE,LruParams.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),LruParams.DISABLED=new LruParams(rw,0,0);/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rI="LruGarbageCollector",rR=1048576,r_=null,rP=null;function bufferEntryComparator([S,T],[R,P]){let O=primitiveComparator(S,R);return 0===O?primitiveComparator(T,P):O}let RollingSequenceNumberBuffer=class RollingSequenceNumberBuffer{constructor(S){this.maxElements=S,this.buffer=new SortedSet(bufferEntryComparator),this.previousIndex=0}nextIndex(){return++this.previousIndex}addElement(S){let T=[S,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(T);else{let S=this.buffer.last();0>bufferEntryComparator(T,S)&&(this.buffer=this.buffer.delete(S).add(T))}}get maxValue(){return this.buffer.last()[0]}};let LruScheduler=class LruScheduler{constructor(S,T,R){this.garbageCollector=S,this.asyncQueue=T,this.localStore=R,this.gcTask=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==rw&&this.scheduleGC(r_)}stop(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)}get started(){return null!==this.gcTask}scheduleGC(S){logDebug(rI,`Garbage collection scheduled in ${S}ms`),this.gcTask=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",S,async()=>{this.gcTask=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(S){isIndexedDbTransactionError(S)?logDebug(rI,"Ignoring IndexedDB error during garbage collection: ",S):await ignoreIfPrimaryLeaseLoss(S)}await this.scheduleGC(rP)})}};let LruGarbageCollectorImpl=class LruGarbageCollectorImpl{constructor(S,T){this.delegate=S,this.params=T}calculateTargetCount(S,T){return this.delegate.getSequenceNumberCount(S).next(S=>Math.floor(T/100*S))}nthSequenceNumber(S,T){if(0===T)return PersistencePromise.resolve(ListenSequence.INVALID);let R=new RollingSequenceNumberBuffer(T);return this.delegate.forEachTarget(S,S=>R.addElement(S.sequenceNumber)).next(()=>this.delegate.forEachOrphanedDocumentSequenceNumber(S,S=>R.addElement(S))).next(()=>R.maxValue)}removeTargets(S,T,R){return this.delegate.removeTargets(S,T,R)}removeOrphanedDocuments(S,T){return this.delegate.removeOrphanedDocuments(S,T)}collect(S,T){return this.params.cacheSizeCollectionThreshold===rw?(logDebug("LruGarbageCollector","Garbage collection skipped; disabled"),PersistencePromise.resolve(rE)):this.getCacheSize(S).next(R=>R<this.params.cacheSizeCollectionThreshold?(logDebug("LruGarbageCollector",`Garbage collection skipped; Cache size ${R} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),rE):this.runGarbageCollection(S,T))}getCacheSize(S){return this.delegate.getCacheSize(S)}runGarbageCollection(S,T){let R,P,O,N,M,L,V;let U=Date.now();return this.calculateTargetCount(S,this.params.percentileToCollect).next(T=>(T>this.params.maximumSequenceNumbersToCollect?(logDebug("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${T}`),P=this.params.maximumSequenceNumbersToCollect):P=T,N=Date.now(),this.nthSequenceNumber(S,P))).next(P=>(R=P,M=Date.now(),this.removeTargets(S,R,T))).next(T=>(O=T,L=Date.now(),this.removeOrphanedDocuments(S,R))).next(S=>{if(V=Date.now(),getLogLevel()<=LogLevel.DEBUG){let T=`LRU Garbage Collection
	Counted targets in ${N-U}ms
	Determined least recently used ${P} in ${M-N}ms
	Removed ${O} targets in ${L-M}ms
	Removed ${S} documents in ${V-L}ms
Total Duration: ${V-U}ms`;logDebug("LruGarbageCollector",T)}return PersistencePromise.resolve({didRun:!0,sequenceNumbersCollected:P,targetsRemoved:O,documentsRemoved:S})})}};function newLruGarbageCollector(S,T){return new LruGarbageCollectorImpl(S,T)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbLruDelegateImpl=class IndexedDbLruDelegateImpl{constructor(S,T){this.db=S,this.garbageCollector=newLruGarbageCollector(this,T)}getSequenceNumberCount(S){let T=this.orphanedDocumentCount(S),R=this.db.getTargetCache().getTargetCount(S);return R.next(S=>T.next(T=>S+T))}orphanedDocumentCount(S){let T=0;return this.forEachOrphanedDocumentSequenceNumber(S,S=>{T++}).next(()=>T)}forEachTarget(S,T){return this.db.getTargetCache().forEachTarget(S,T)}forEachOrphanedDocumentSequenceNumber(S,T){return this.forEachOrphanedDocument(S,(S,R)=>T(R))}addReference(S,T,R){return writeSentinelKey(S,R)}removeReference(S,T,R){return writeSentinelKey(S,R)}removeTargets(S,T,R){return this.db.getTargetCache().removeTargets(S,T,R)}markPotentiallyOrphaned(S,T){return writeSentinelKey(S,T)}isPinned(S,T){return mutationQueuesContainKey(S,T)}removeOrphanedDocuments(S,T){let R=this.db.getRemoteDocumentCache(),P=R.newChangeBuffer(),O=[],N=0,M=this.forEachOrphanedDocument(S,(R,M)=>{if(M<=T){let T=this.isPinned(S,R).next(T=>{if(!T)return N++,P.getEntry(S,R).next(()=>(P.removeEntry(R,SnapshotVersion.min()),documentTargetStore(S).delete(sentinelKey$1(R))))});O.push(T)}});return M.next(()=>PersistencePromise.waitFor(O)).next(()=>P.apply(S)).next(()=>N)}removeTarget(S,T){let R=T.withSequenceNumber(S.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(S,R)}updateLimboDocument(S,T){return writeSentinelKey(S,T)}forEachOrphanedDocument(S,T){let R;let P=documentTargetStore(S),O=ListenSequence.INVALID;return P.iterate({index:eY},([S,P],{path:N,sequenceNumber:M})=>{0===S?(O!==ListenSequence.INVALID&&T(new DocumentKey(decodeResourcePath(R)),O),O=M,R=N):O=ListenSequence.INVALID}).next(()=>{O!==ListenSequence.INVALID&&T(new DocumentKey(decodeResourcePath(R)),O)})}getCacheSize(S){return this.db.getRemoteDocumentCache().getSize(S)}};function sentinelKey$1(S){return[0,encodeResourcePath(S.path)]}function sentinelRow(S,T){return{targetId:0,path:encodeResourcePath(S.path),sequenceNumber:T}}function writeSentinelKey(S,T){return documentTargetStore(S).put(sentinelRow(T,S.currentSequenceNumber))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let RemoteDocumentChangeBuffer=class RemoteDocumentChangeBuffer{constructor(){this.changes=new ObjectMap(S=>S.toString(),(S,T)=>S.isEqual(T)),this.changesApplied=!1}addEntry(S){this.assertNotApplied(),this.changes.set(S.key,S)}removeEntry(S,T){this.assertNotApplied(),this.changes.set(S,MutableDocument.newInvalidDocument(S).setReadTime(T))}getEntry(S,T){this.assertNotApplied();let R=this.changes.get(T);return void 0!==R?PersistencePromise.resolve(R):this.getFromCache(S,T)}getEntries(S,T){return this.getAllFromCache(S,T)}apply(S){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(S)}assertNotApplied(){}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let IndexedDbRemoteDocumentCacheImpl=class IndexedDbRemoteDocumentCacheImpl{constructor(S){this.serializer=S}setIndexManager(S){this.indexManager=S}addEntry(S,T,R){let P=remoteDocumentsStore(S);return P.put(R)}removeEntry(S,T,R){let P=remoteDocumentsStore(S);return P.delete(dbReadTimeKey(T,R))}updateMetadata(S,T){return this.getMetadata(S).next(R=>(R.byteSize+=T,this.setMetadata(S,R)))}getEntry(S,T){let R=MutableDocument.newInvalidDocument(T);return remoteDocumentsStore(S).iterate({index:eB,range:IDBKeyRange.only(dbKey(T))},(S,P)=>{R=this.maybeDecodeDocument(T,P)}).next(()=>R)}getSizedEntry(S,T){let R={size:0,document:MutableDocument.newInvalidDocument(T)};return remoteDocumentsStore(S).iterate({index:eB,range:IDBKeyRange.only(dbKey(T))},(S,P)=>{R={document:this.maybeDecodeDocument(T,P),size:dbDocumentSize(P)}}).next(()=>R)}getEntries(S,T){let R=mutableDocumentMap();return this.forEachDbEntry(S,T,(S,T)=>{let P=this.maybeDecodeDocument(S,T);R=R.insert(S,P)}).next(()=>R)}getSizedEntries(S,T){let R=mutableDocumentMap(),P=new SortedMap(DocumentKey.comparator);return this.forEachDbEntry(S,T,(S,T)=>{let O=this.maybeDecodeDocument(S,T);R=R.insert(S,O),P=P.insert(S,dbDocumentSize(T))}).next(()=>({documents:R,sizeMap:P}))}forEachDbEntry(S,T,R){if(T.isEmpty())return PersistencePromise.resolve();let P=new SortedSet(dbKeyComparator);T.forEach(S=>P=P.add(S));let O=IDBKeyRange.bound(dbKey(P.first()),dbKey(P.last())),N=P.getIterator(),M=N.getNext();return remoteDocumentsStore(S).iterate({index:eB,range:O},(S,T,P)=>{let O=DocumentKey.fromSegments([...T.prefixPath,T.collectionGroup,T.documentId]);for(;M&&0>dbKeyComparator(M,O);)R(M,null),M=N.getNext();M&&M.isEqual(O)&&(R(M,T),M=N.hasNext()?N.getNext():null),M?P.skip(dbKey(M)):P.done()}).next(()=>{for(;M;)R(M,null),M=N.hasNext()?N.getNext():null})}getDocumentsMatchingQuery(S,T,R,P,O){let N=T.path,M=[N.popLast().toArray(),N.lastSegment(),toDbTimestampKey(R.readTime),R.documentKey.path.isEmpty()?"":R.documentKey.path.lastSegment()],L=[N.popLast().toArray(),N.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return remoteDocumentsStore(S).loadAll(IDBKeyRange.bound(M,L,!0)).next(S=>{null==O||O.incrementDocumentReadCount(S.length);let R=mutableDocumentMap();for(let O of S){let S=this.maybeDecodeDocument(DocumentKey.fromSegments(O.prefixPath.concat(O.collectionGroup,O.documentId)),O);S.isFoundDocument()&&(queryMatches(T,S)||P.has(S.key))&&(R=R.insert(S.key,S))}return R})}getAllFromCollectionGroup(S,T,R,P){let O=mutableDocumentMap(),N=dbCollectionGroupKey(T,R),M=dbCollectionGroupKey(T,IndexOffset.max());return remoteDocumentsStore(S).iterate({index:eU,range:IDBKeyRange.bound(N,M,!0)},(S,T,R)=>{let N=this.maybeDecodeDocument(DocumentKey.fromSegments(T.prefixPath.concat(T.collectionGroup,T.documentId)),T);(O=O.insert(N.key,N)).size===P&&R.done()}).next(()=>O)}newChangeBuffer(S){return new IndexedDbRemoteDocumentChangeBuffer(this,!!S&&S.trackRemovals)}getSize(S){return this.getMetadata(S).next(S=>S.byteSize)}getMetadata(S){return documentGlobalStore(S).get(ez).next(S=>(hardAssert(!!S),S))}setMetadata(S,T){return documentGlobalStore(S).put(ez,T)}maybeDecodeDocument(S,T){if(T){let S=fromDbRemoteDocument(this.serializer,T),R=S.isNoDocument()&&S.version.isEqual(SnapshotVersion.min());if(!R)return S}return MutableDocument.newInvalidDocument(S)}};function newIndexedDbRemoteDocumentCache(S){return new IndexedDbRemoteDocumentCacheImpl(S)}let IndexedDbRemoteDocumentChangeBuffer=class IndexedDbRemoteDocumentChangeBuffer extends null{constructor(S,T){super(),this.documentCache=S,this.trackRemovals=T,this.documentStates=new ObjectMap(S=>S.toString(),(S,T)=>S.isEqual(T))}applyChanges(S){let T=[],R=0,P=new SortedSet((S,T)=>primitiveComparator(S.canonicalString(),T.canonicalString()));return this.changes.forEach((O,N)=>{let M=this.documentStates.get(O);if(T.push(this.documentCache.removeEntry(S,O,M.readTime)),N.isValidDocument()){let L=toDbRemoteDocument(this.documentCache.serializer,N);P=P.add(O.path.popLast());let V=dbDocumentSize(L);R+=V-M.size,T.push(this.documentCache.addEntry(S,O,L))}else if(R-=M.size,this.trackRemovals){let R=toDbRemoteDocument(this.documentCache.serializer,N.convertToNoDocument(SnapshotVersion.min()));T.push(this.documentCache.addEntry(S,O,R))}}),P.forEach(R=>{T.push(this.documentCache.indexManager.addToCollectionParentIndex(S,R))}),T.push(this.documentCache.updateMetadata(S,R)),PersistencePromise.waitFor(T)}getFromCache(S,T){return this.documentCache.getSizedEntry(S,T).next(S=>(this.documentStates.set(T,{size:S.size,readTime:S.document.readTime}),S.document))}getAllFromCache(S,T){return this.documentCache.getSizedEntries(S,T).next(({documents:S,sizeMap:T})=>(T.forEach((T,R)=>{this.documentStates.set(T,{size:R,readTime:S.get(T).readTime})}),S))}};function documentGlobalStore(S){return getStore(S,eq)}function remoteDocumentsStore(S){return getStore(S,eF)}function dbKey(S){let T=S.path.toArray();return[T.slice(0,T.length-2),T[T.length-2],T[T.length-1]]}function dbReadTimeKey(S,T){let R=S.path.toArray();return[R.slice(0,R.length-2),R[R.length-2],toDbTimestampKey(T),R[R.length-1]]}function dbCollectionGroupKey(S,T){let R=T.documentKey.path.toArray();return[S,toDbTimestampKey(T.readTime),R.slice(0,R.length-2),R.length>0?R[R.length-1]:""]}function dbKeyComparator(S,T){let R=S.path.toArray(),P=T.path.toArray(),O=0;for(let S=0;S<R.length-2&&S<P.length-2;++S)if(O=primitiveComparator(R[S],P[S]))return O;return(O=primitiveComparator(R.length,P.length))||(O=primitiveComparator(R[R.length-2],P[P.length-2]))?O:primitiveComparator(R[R.length-1],P[P.length-1])}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rA=17;/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let OverlayedDocument=class OverlayedDocument{constructor(S,T){this.overlayedDocument=S,this.mutatedFields=T}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let LocalDocumentsView=class LocalDocumentsView{constructor(S,T,R,P){this.remoteDocumentCache=S,this.mutationQueue=T,this.documentOverlayCache=R,this.indexManager=P}getDocument(S,T){let R=null;return this.documentOverlayCache.getOverlay(S,T).next(P=>(R=P,this.remoteDocumentCache.getEntry(S,T))).next(S=>(null!==R&&mutationApplyToLocalView(R.mutation,S,FieldMask.empty(),Timestamp.now()),S))}getDocuments(S,T){return this.remoteDocumentCache.getEntries(S,T).next(T=>this.getLocalViewOfDocuments(S,T,documentKeySet()).next(()=>T))}getLocalViewOfDocuments(S,T,R=documentKeySet()){let P=newOverlayMap();return this.populateOverlays(S,P,T).next(()=>this.computeViews(S,T,P,R).next(S=>{let T=documentMap();return S.forEach((S,R)=>{T=T.insert(S,R.overlayedDocument)}),T}))}getOverlayedDocuments(S,T){let R=newOverlayMap();return this.populateOverlays(S,R,T).next(()=>this.computeViews(S,T,R,documentKeySet()))}populateOverlays(S,T,R){let P=[];return R.forEach(S=>{T.has(S)||P.push(S)}),this.documentOverlayCache.getOverlays(S,P).next(S=>{S.forEach((S,R)=>{T.set(S,R)})})}computeViews(S,T,R,P){let O=mutableDocumentMap(),N=newDocumentKeyMap(),M=newOverlayedDocumentMap();return T.forEach((S,T)=>{let M=R.get(T.key);P.has(T.key)&&(void 0===M||M.mutation instanceof PatchMutation)?O=O.insert(T.key,T):void 0!==M?(N.set(T.key,M.mutation.getFieldMask()),mutationApplyToLocalView(M.mutation,T,M.mutation.getFieldMask(),Timestamp.now())):N.set(T.key,FieldMask.empty())}),this.recalculateAndSaveOverlays(S,O).next(S=>(S.forEach((S,T)=>N.set(S,T)),T.forEach((S,T)=>{var R;return M.set(S,new OverlayedDocument(T,null!==(R=N.get(S))&&void 0!==R?R:null))}),M))}recalculateAndSaveOverlays(S,T){let R=newDocumentKeyMap(),P=new SortedMap((S,T)=>S-T),O=documentKeySet();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(S,T).next(S=>{for(let O of S)O.keys().forEach(S=>{let N=T.get(S);if(null===N)return;let M=R.get(S)||FieldMask.empty();M=O.applyToLocalView(N,M),R.set(S,M);let L=(P.get(O.batchId)||documentKeySet()).add(S);P=P.insert(O.batchId,L)})}).next(()=>{let N=[],M=P.getReverseIterator();for(;M.hasNext();){let P=M.getNext(),L=P.key,V=P.value,U=newMutationMap();V.forEach(S=>{if(!O.has(S)){let P=calculateOverlayMutation(T.get(S),R.get(S));null!==P&&U.set(S,P),O=O.add(S)}}),N.push(this.documentOverlayCache.saveOverlays(S,L,U))}return PersistencePromise.waitFor(N)}).next(()=>R)}recalculateAndSaveOverlaysForDocumentKeys(S,T){return this.remoteDocumentCache.getEntries(S,T).next(T=>this.recalculateAndSaveOverlays(S,T))}getDocumentsMatchingQuery(S,T,R,P){return isDocumentQuery$1(T)?this.getDocumentsMatchingDocumentQuery(S,T.path):isCollectionGroupQuery(T)?this.getDocumentsMatchingCollectionGroupQuery(S,T,R,P):this.getDocumentsMatchingCollectionQuery(S,T,R,P)}getNextDocuments(S,T,R,P){return this.remoteDocumentCache.getAllFromCollectionGroup(S,T,R,P).next(O=>{let N=P-O.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(S,T,R.largestBatchId,P-O.size):PersistencePromise.resolve(newOverlayMap()),M=ed,L=O;return N.next(T=>PersistencePromise.forEach(T,(T,R)=>(M<R.largestBatchId&&(M=R.largestBatchId),O.get(T))?PersistencePromise.resolve():this.remoteDocumentCache.getEntry(S,T).next(S=>{L=L.insert(T,S)})).next(()=>this.populateOverlays(S,T,O)).next(()=>this.computeViews(S,L,T,documentKeySet())).next(S=>({batchId:M,changes:convertOverlayedDocumentMapToDocumentMap(S)})))})}getDocumentsMatchingDocumentQuery(S,T){return this.getDocument(S,new DocumentKey(T)).next(S=>{let T=documentMap();return S.isFoundDocument()&&(T=T.insert(S.key,S)),T})}getDocumentsMatchingCollectionGroupQuery(S,T,R,P){let O=T.collectionGroup,N=documentMap();return this.indexManager.getCollectionParents(S,O).next(M=>PersistencePromise.forEach(M,M=>{let L=asCollectionQueryAtPath(T,M.child(O));return this.getDocumentsMatchingCollectionQuery(S,L,R,P).next(S=>{S.forEach((S,T)=>{N=N.insert(S,T)})})}).next(()=>N))}getDocumentsMatchingCollectionQuery(S,T,R,P){let O;return this.documentOverlayCache.getOverlaysForCollection(S,T.path,R.largestBatchId).next(N=>(O=N,this.remoteDocumentCache.getDocumentsMatchingQuery(S,T,R,O,P))).next(S=>{O.forEach((T,R)=>{let P=R.getKey();null===S.get(P)&&(S=S.insert(P,MutableDocument.newInvalidDocument(P)))});let R=documentMap();return S.forEach((S,P)=>{let N=O.get(S);void 0!==N&&mutationApplyToLocalView(N.mutation,P,FieldMask.empty(),Timestamp.now()),queryMatches(T,P)&&(R=R.insert(S,P))}),R})}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryBundleCache=class MemoryBundleCache{constructor(S){this.serializer=S,this.bundles=new Map,this.namedQueries=new Map}getBundleMetadata(S,T){return PersistencePromise.resolve(this.bundles.get(T))}saveBundleMetadata(S,T){return this.bundles.set(T.id,fromBundleMetadata(T)),PersistencePromise.resolve()}getNamedQuery(S,T){return PersistencePromise.resolve(this.namedQueries.get(T))}saveNamedQuery(S,T){return this.namedQueries.set(T.name,fromProtoNamedQuery(T)),PersistencePromise.resolve()}};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryDocumentOverlayCache=class MemoryDocumentOverlayCache{constructor(){this.overlays=new SortedMap(DocumentKey.comparator),this.overlayByBatchId=new Map}getOverlay(S,T){return PersistencePromise.resolve(this.overlays.get(T))}getOverlays(S,T){let R=newOverlayMap();return PersistencePromise.forEach(T,T=>this.getOverlay(S,T).next(S=>{null!==S&&R.set(T,S)})).next(()=>R)}saveOverlays(S,T,R){return R.forEach((R,P)=>{this.saveOverlay(S,T,P)}),PersistencePromise.resolve()}removeOverlaysForBatchId(S,T,R){let P=this.overlayByBatchId.get(R);return void 0!==P&&(P.forEach(S=>this.overlays=this.overlays.remove(S)),this.overlayByBatchId.delete(R)),PersistencePromise.resolve()}getOverlaysForCollection(S,T,R){let P=newOverlayMap(),O=T.length+1,N=new DocumentKey(T.child("")),M=this.overlays.getIteratorFrom(N);for(;M.hasNext();){let S=M.getNext(),N=S.value,L=N.getKey();if(!T.isPrefixOf(L.path))break;L.path.length===O&&N.largestBatchId>R&&P.set(N.getKey(),N)}return PersistencePromise.resolve(P)}getOverlaysForCollectionGroup(S,T,R,P){let O=new SortedMap((S,T)=>S-T),N=this.overlays.getIterator();for(;N.hasNext();){let S=N.getNext(),P=S.value,M=P.getKey();if(M.getCollectionGroup()===T&&P.largestBatchId>R){let S=O.get(P.largestBatchId);null===S&&(S=newOverlayMap(),O=O.insert(P.largestBatchId,S)),S.set(P.getKey(),P)}}let M=newOverlayMap(),L=O.getIterator();for(;L.hasNext();){let S=L.getNext(),T=S.value;if(T.forEach((S,T)=>M.set(S,T)),M.size()>=P)break}return PersistencePromise.resolve(M)}saveOverlay(S,T,R){let P=this.overlays.get(R.key);if(null!==P){let S=this.overlayByBatchId.get(P.largestBatchId).delete(R.key);this.overlayByBatchId.set(P.largestBatchId,S)}this.overlays=this.overlays.insert(R.key,new Overlay(T,R));let O=this.overlayByBatchId.get(T);void 0===O&&(O=documentKeySet(),this.overlayByBatchId.set(T,O)),this.overlayByBatchId.set(T,O.add(R.key))}};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryGlobalsCache=class MemoryGlobalsCache{constructor(){this.sessionToken=ByteString.EMPTY_BYTE_STRING}getSessionToken(S){return PersistencePromise.resolve(this.sessionToken)}setSessionToken(S,T){return this.sessionToken=T,PersistencePromise.resolve()}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ReferenceSet=class ReferenceSet{constructor(){this.refsByKey=new SortedSet(DocReference.compareByKey),this.refsByTarget=new SortedSet(DocReference.compareByTargetId)}isEmpty(){return this.refsByKey.isEmpty()}addReference(S,T){let R=new DocReference(S,T);this.refsByKey=this.refsByKey.add(R),this.refsByTarget=this.refsByTarget.add(R)}addReferences(S,T){S.forEach(S=>this.addReference(S,T))}removeReference(S,T){this.removeRef(new DocReference(S,T))}removeReferences(S,T){S.forEach(S=>this.removeReference(S,T))}removeReferencesForId(S){let T=new DocumentKey(new ResourcePath([])),R=new DocReference(T,S),P=new DocReference(T,S+1),O=[];return this.refsByTarget.forEachInRange([R,P],S=>{this.removeRef(S),O.push(S.key)}),O}removeAllReferences(){this.refsByKey.forEach(S=>this.removeRef(S))}removeRef(S){this.refsByKey=this.refsByKey.delete(S),this.refsByTarget=this.refsByTarget.delete(S)}referencesForId(S){let T=new DocumentKey(new ResourcePath([])),R=new DocReference(T,S),P=new DocReference(T,S+1),O=documentKeySet();return this.refsByTarget.forEachInRange([R,P],S=>{O=O.add(S.key)}),O}containsKey(S){let T=new DocReference(S,0),R=this.refsByKey.firstAfterOrEqual(T);return null!==R&&S.isEqual(R.key)}};let DocReference=class DocReference{constructor(S,T){this.key=S,this.targetOrBatchId=T}static compareByKey(S,T){return DocumentKey.comparator(S.key,T.key)||primitiveComparator(S.targetOrBatchId,T.targetOrBatchId)}static compareByTargetId(S,T){return primitiveComparator(S.targetOrBatchId,T.targetOrBatchId)||DocumentKey.comparator(S.key,T.key)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryMutationQueue=class MemoryMutationQueue{constructor(S,T){this.indexManager=S,this.referenceDelegate=T,this.mutationQueue=[],this.nextBatchId=1,this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}checkEmpty(S){return PersistencePromise.resolve(0===this.mutationQueue.length)}addMutationBatch(S,T,R,P){let O=this.nextBatchId;this.nextBatchId++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let N=new MutationBatch(O,T,R,P);for(let T of(this.mutationQueue.push(N),P))this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(T.key,O)),this.indexManager.addToCollectionParentIndex(S,T.key.path.popLast());return PersistencePromise.resolve(N)}lookupMutationBatch(S,T){return PersistencePromise.resolve(this.findMutationBatch(T))}getNextMutationBatchAfterBatchId(S,T){let R=T+1,P=this.indexOfBatchId(R),O=P<0?0:P;return PersistencePromise.resolve(this.mutationQueue.length>O?this.mutationQueue[O]:null)}getHighestUnacknowledgedBatchId(){return PersistencePromise.resolve(0===this.mutationQueue.length?tV:this.nextBatchId-1)}getAllMutationBatches(S){return PersistencePromise.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(S,T){let R=new DocReference(T,0),P=new DocReference(T,Number.POSITIVE_INFINITY),O=[];return this.batchesByDocumentKey.forEachInRange([R,P],S=>{let T=this.findMutationBatch(S.targetOrBatchId);O.push(T)}),PersistencePromise.resolve(O)}getAllMutationBatchesAffectingDocumentKeys(S,T){let R=new SortedSet(primitiveComparator);return T.forEach(S=>{let T=new DocReference(S,0),P=new DocReference(S,Number.POSITIVE_INFINITY);this.batchesByDocumentKey.forEachInRange([T,P],S=>{R=R.add(S.targetOrBatchId)})}),PersistencePromise.resolve(this.findMutationBatches(R))}getAllMutationBatchesAffectingQuery(S,T){let R=T.path,P=R.length+1,O=R;DocumentKey.isDocumentKey(O)||(O=O.child(""));let N=new DocReference(new DocumentKey(O),0),M=new SortedSet(primitiveComparator);return this.batchesByDocumentKey.forEachWhile(S=>{let T=S.key.path;return!!R.isPrefixOf(T)&&(T.length===P&&(M=M.add(S.targetOrBatchId)),!0)},N),PersistencePromise.resolve(this.findMutationBatches(M))}findMutationBatches(S){let T=[];return S.forEach(S=>{let R=this.findMutationBatch(S);null!==R&&T.push(R)}),T}removeMutationBatch(S,T){let R=this.indexOfExistingBatchId(T.batchId,"removed");hardAssert(0===R),this.mutationQueue.shift();let P=this.batchesByDocumentKey;return PersistencePromise.forEach(T.mutations,R=>{let O=new DocReference(R.key,T.batchId);return P=P.delete(O),this.referenceDelegate.markPotentiallyOrphaned(S,R.key)}).next(()=>{this.batchesByDocumentKey=P})}removeCachedMutationKeys(S){}containsKey(S,T){let R=new DocReference(T,0),P=this.batchesByDocumentKey.firstAfterOrEqual(R);return PersistencePromise.resolve(T.isEqual(P&&P.key))}performConsistencyCheck(S){return this.mutationQueue.length,PersistencePromise.resolve()}indexOfExistingBatchId(S,T){let R=this.indexOfBatchId(S);return R}indexOfBatchId(S){if(0===this.mutationQueue.length)return 0;let T=this.mutationQueue[0].batchId;return S-T}findMutationBatch(S){let T=this.indexOfBatchId(S);if(T<0||T>=this.mutationQueue.length)return null;let R=this.mutationQueue[T];return R}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function documentEntryMap(){return new SortedMap(DocumentKey.comparator)}let MemoryRemoteDocumentCacheImpl=class MemoryRemoteDocumentCacheImpl{constructor(S){this.sizer=S,this.docs=documentEntryMap(),this.size=0}setIndexManager(S){this.indexManager=S}addEntry(S,T){let R=T.key,P=this.docs.get(R),O=P?P.size:0,N=this.sizer(T);return this.docs=this.docs.insert(R,{document:T.mutableCopy(),size:N}),this.size+=N-O,this.indexManager.addToCollectionParentIndex(S,R.path.popLast())}removeEntry(S){let T=this.docs.get(S);T&&(this.docs=this.docs.remove(S),this.size-=T.size)}getEntry(S,T){let R=this.docs.get(T);return PersistencePromise.resolve(R?R.document.mutableCopy():MutableDocument.newInvalidDocument(T))}getEntries(S,T){let R=mutableDocumentMap();return T.forEach(S=>{let T=this.docs.get(S);R=R.insert(S,T?T.document.mutableCopy():MutableDocument.newInvalidDocument(S))}),PersistencePromise.resolve(R)}getDocumentsMatchingQuery(S,T,R,P){let O=mutableDocumentMap(),N=T.path,M=new DocumentKey(N.child("")),L=this.docs.getIteratorFrom(M);for(;L.hasNext();){let{key:S,value:{document:M}}=L.getNext();if(!N.isPrefixOf(S.path))break;!(S.path.length>N.length+1||0>=indexOffsetComparator(newIndexOffsetFromDocument(M),R))&&(P.has(M.key)||queryMatches(T,M))&&(O=O.insert(M.key,M.mutableCopy()))}return PersistencePromise.resolve(O)}getAllFromCollectionGroup(S,T,R,P){fail()}forEachDocumentKey(S,T){return PersistencePromise.forEach(this.docs,S=>T(S))}newChangeBuffer(S){return new MemoryRemoteDocumentChangeBuffer(this)}getSize(S){return PersistencePromise.resolve(this.size)}};function newMemoryRemoteDocumentCache(S){return new MemoryRemoteDocumentCacheImpl(S)}let MemoryRemoteDocumentChangeBuffer=class MemoryRemoteDocumentChangeBuffer extends RemoteDocumentChangeBuffer{constructor(S){super(),this.documentCache=S}applyChanges(S){let T=[];return this.changes.forEach((R,P)=>{P.isValidDocument()?T.push(this.documentCache.addEntry(S,P)):this.documentCache.removeEntry(R)}),PersistencePromise.waitFor(T)}getFromCache(S,T){return this.documentCache.getEntry(S,T)}getAllFromCache(S,T){return this.documentCache.getEntries(S,T)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryTargetCache=class MemoryTargetCache{constructor(S){this.persistence=S,this.targets=new ObjectMap(S=>canonifyTarget(S),targetEquals),this.lastRemoteSnapshotVersion=SnapshotVersion.min(),this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new ReferenceSet,this.targetCount=0,this.targetIdGenerator=TargetIdGenerator.forTargetCache()}forEachTarget(S,T){return this.targets.forEach((S,R)=>T(R)),PersistencePromise.resolve()}getLastRemoteSnapshotVersion(S){return PersistencePromise.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(S){return PersistencePromise.resolve(this.highestSequenceNumber)}allocateTargetId(S){return this.highestTargetId=this.targetIdGenerator.next(),PersistencePromise.resolve(this.highestTargetId)}setTargetsMetadata(S,T,R){return R&&(this.lastRemoteSnapshotVersion=R),T>this.highestSequenceNumber&&(this.highestSequenceNumber=T),PersistencePromise.resolve()}saveTargetData(S){this.targets.set(S.target,S);let T=S.targetId;T>this.highestTargetId&&(this.targetIdGenerator=new TargetIdGenerator(T),this.highestTargetId=T),S.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=S.sequenceNumber)}addTargetData(S,T){return this.saveTargetData(T),this.targetCount+=1,PersistencePromise.resolve()}updateTargetData(S,T){return this.saveTargetData(T),PersistencePromise.resolve()}removeTargetData(S,T){return this.targets.delete(T.target),this.references.removeReferencesForId(T.targetId),this.targetCount-=1,PersistencePromise.resolve()}removeTargets(S,T,R){let P=0,O=[];return this.targets.forEach((N,M)=>{M.sequenceNumber<=T&&null===R.get(M.targetId)&&(this.targets.delete(N),O.push(this.removeMatchingKeysForTargetId(S,M.targetId)),P++)}),PersistencePromise.waitFor(O).next(()=>P)}getTargetCount(S){return PersistencePromise.resolve(this.targetCount)}getTargetData(S,T){let R=this.targets.get(T)||null;return PersistencePromise.resolve(R)}addMatchingKeys(S,T,R){return this.references.addReferences(T,R),PersistencePromise.resolve()}removeMatchingKeys(S,T,R){this.references.removeReferences(T,R);let P=this.persistence.referenceDelegate,O=[];return P&&T.forEach(T=>{O.push(P.markPotentiallyOrphaned(S,T))}),PersistencePromise.waitFor(O)}removeMatchingKeysForTargetId(S,T){return this.references.removeReferencesForId(T),PersistencePromise.resolve()}getMatchingKeysForTargetId(S,T){let R=this.references.referencesForId(T);return PersistencePromise.resolve(R)}containsKey(S,T){return PersistencePromise.resolve(this.references.containsKey(T))}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rO="MemoryPersistence";let MemoryPersistence=class MemoryPersistence{constructor(S,T){this.mutationQueues={},this.overlays={},this.listenSequence=new ListenSequence(0),this._started=!1,this._started=!0,this.globalsCache=new MemoryGlobalsCache,this.referenceDelegate=S(this),this.targetCache=new MemoryTargetCache(this);let sizer=S=>this.referenceDelegate.documentSize(S);this.indexManager=new MemoryIndexManager,this.remoteDocumentCache=newMemoryRemoteDocumentCache(sizer),this.serializer=new LocalSerializer(T),this.bundleCache=new MemoryBundleCache(this.serializer)}start(){return Promise.resolve()}shutdown(){return this._started=!1,Promise.resolve()}get started(){return this._started}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(S){return this.indexManager}getDocumentOverlayCache(S){let T=this.overlays[S.toKey()];return T||(T=new MemoryDocumentOverlayCache,this.overlays[S.toKey()]=T),T}getMutationQueue(S,T){let R=this.mutationQueues[S.toKey()];return R||(R=new MemoryMutationQueue(T,this.referenceDelegate),this.mutationQueues[S.toKey()]=R),R}getGlobalsCache(){return this.globalsCache}getTargetCache(){return this.targetCache}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.bundleCache}runTransaction(S,T,R){logDebug(rO,"Starting transaction:",S);let P=new MemoryTransaction(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),R(P).next(S=>this.referenceDelegate.onTransactionCommitted(P).next(()=>S)).toPromise().then(S=>(P.raiseOnCommittedEvent(),S))}mutationQueuesContainKey(S,T){return PersistencePromise.or(Object.values(this.mutationQueues).map(R=>()=>R.containsKey(S,T)))}};let MemoryTransaction=class MemoryTransaction extends PersistenceTransaction{constructor(S){super(),this.currentSequenceNumber=S}};let MemoryEagerDelegate=class MemoryEagerDelegate{constructor(S){this.persistence=S,this.localViewReferences=new ReferenceSet,this._orphanedDocuments=null}static factory(S){return new MemoryEagerDelegate(S)}get orphanedDocuments(){if(this._orphanedDocuments)return this._orphanedDocuments;throw fail()}addReference(S,T,R){return this.localViewReferences.addReference(R,T),this.orphanedDocuments.delete(R.toString()),PersistencePromise.resolve()}removeReference(S,T,R){return this.localViewReferences.removeReference(R,T),this.orphanedDocuments.add(R.toString()),PersistencePromise.resolve()}markPotentiallyOrphaned(S,T){return this.orphanedDocuments.add(T.toString()),PersistencePromise.resolve()}removeTarget(S,T){let R=this.localViewReferences.removeReferencesForId(T.targetId);R.forEach(S=>this.orphanedDocuments.add(S.toString()));let P=this.persistence.getTargetCache();return P.getMatchingKeysForTargetId(S,T.targetId).next(S=>{S.forEach(S=>this.orphanedDocuments.add(S.toString()))}).next(()=>P.removeTargetData(S,T))}onTransactionStarted(){this._orphanedDocuments=new Set}onTransactionCommitted(S){let T=this.persistence.getRemoteDocumentCache(),R=T.newChangeBuffer();return PersistencePromise.forEach(this.orphanedDocuments,T=>{let P=DocumentKey.fromPath(T);return this.isReferenced(S,P).next(S=>{S||R.removeEntry(P,SnapshotVersion.min())})}).next(()=>(this._orphanedDocuments=null,R.apply(S)))}updateLimboDocument(S,T){return this.isReferenced(S,T).next(S=>{S?this.orphanedDocuments.delete(T.toString()):this.orphanedDocuments.add(T.toString())})}documentSize(S){return 0}isReferenced(S,T){return PersistencePromise.or([()=>PersistencePromise.resolve(this.localViewReferences.containsKey(T)),()=>this.persistence.getTargetCache().containsKey(S,T),()=>this.persistence.mutationQueuesContainKey(S,T)])}};let MemoryLruDelegate=class MemoryLruDelegate{constructor(S,T){this.persistence=S,this.orphanedSequenceNumbers=new ObjectMap(S=>encodeResourcePath(S.path),(S,T)=>S.isEqual(T)),this.garbageCollector=newLruGarbageCollector(this,T)}static factory(S,T){return new MemoryLruDelegate(S,T)}onTransactionStarted(){}onTransactionCommitted(S){return PersistencePromise.resolve()}forEachTarget(S,T){return this.persistence.getTargetCache().forEachTarget(S,T)}getSequenceNumberCount(S){let T=this.orphanedDocumentCount(S),R=this.persistence.getTargetCache().getTargetCount(S);return R.next(S=>T.next(T=>S+T))}orphanedDocumentCount(S){let T=0;return this.forEachOrphanedDocumentSequenceNumber(S,S=>{T++}).next(()=>T)}forEachOrphanedDocumentSequenceNumber(S,T){return PersistencePromise.forEach(this.orphanedSequenceNumbers,(R,P)=>this.isPinned(S,R,P).next(S=>S?PersistencePromise.resolve():T(P)))}removeTargets(S,T,R){return this.persistence.getTargetCache().removeTargets(S,T,R)}removeOrphanedDocuments(S,T){let R=0,P=this.persistence.getRemoteDocumentCache(),O=P.newChangeBuffer(),N=P.forEachDocumentKey(S,P=>this.isPinned(S,P,T).next(S=>{S||(R++,O.removeEntry(P,SnapshotVersion.min()))}));return N.next(()=>O.apply(S)).next(()=>R)}markPotentiallyOrphaned(S,T){return this.orphanedSequenceNumbers.set(T,S.currentSequenceNumber),PersistencePromise.resolve()}removeTarget(S,T){let R=T.withSequenceNumber(S.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(S,R)}addReference(S,T,R){return this.orphanedSequenceNumbers.set(R,S.currentSequenceNumber),PersistencePromise.resolve()}removeReference(S,T,R){return this.orphanedSequenceNumbers.set(R,S.currentSequenceNumber),PersistencePromise.resolve()}updateLimboDocument(S,T){return this.orphanedSequenceNumbers.set(T,S.currentSequenceNumber),PersistencePromise.resolve()}documentSize(S){let T=S.key.toString().length;return S.isFoundDocument()&&(T+=estimateByteSize(S.data.value)),T}isPinned(S,T,R){return PersistencePromise.or([()=>this.persistence.mutationQueuesContainKey(S,T),()=>this.persistence.getTargetCache().containsKey(S,T),()=>{let S=this.orphanedSequenceNumbers.get(T);return PersistencePromise.resolve(void 0!==S&&S>R)}])}getCacheSize(S){return this.persistence.getRemoteDocumentCache().getSize(S)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SchemaConverter=class SchemaConverter{constructor(S){this.serializer=S}createOrUpgrade(S,T,R,P){let O=new SimpleDbTransaction("createOrUpgrade",T);R<1&&P>=1&&(createPrimaryClientStore(S),createMutationQueue(S),createQueryCache(S),createLegacyRemoteDocumentCache(S));let N=PersistencePromise.resolve();return R<3&&P>=3&&(0!==R&&(dropQueryCache(S),createQueryCache(S)),N=N.next(()=>writeEmptyTargetGlobalEntry(O))),R<4&&P>=4&&(0!==R&&(N=N.next(()=>upgradeMutationBatchSchemaAndMigrateData(S,O))),N=N.next(()=>{createClientMetadataStore(S)})),R<5&&P>=5&&(N=N.next(()=>this.removeAcknowledgedMutations(O))),R<6&&P>=6&&(N=N.next(()=>(createDocumentGlobalStore(S),this.addDocumentGlobal(O)))),R<7&&P>=7&&(N=N.next(()=>this.ensureSequenceNumbers(O))),R<8&&P>=8&&(N=N.next(()=>this.createCollectionParentIndex(S,O))),R<9&&P>=9&&(N=N.next(()=>{dropRemoteDocumentChangesStore(S)})),R<10&&P>=10&&(N=N.next(()=>this.rewriteCanonicalIds(O))),R<11&&P>=11&&(N=N.next(()=>{createBundlesStore(S),createNamedQueriesStore(S)})),R<12&&P>=12&&(N=N.next(()=>{createDocumentOverlayStore(S)})),R<13&&P>=13&&(N=N.next(()=>createRemoteDocumentCache(S)).next(()=>this.rewriteRemoteDocumentCache(S,O)).next(()=>S.deleteObjectStore(eD))),R<14&&P>=14&&(N=N.next(()=>this.runOverlayMigration(S,O))),R<15&&P>=15&&(N=N.next(()=>createFieldIndex(S))),R<16&&P>=16&&(N=N.next(()=>{let S=T.objectStore(tr);S.clear()}).next(()=>{let S=T.objectStore(tl);S.clear()})),R<17&&P>=17&&(N=N.next(()=>{createGlobalsStore(S)})),N}addDocumentGlobal(S){let T=0;return S.store(eD).iterate((S,R)=>{T+=dbDocumentSize(R)}).next(()=>{let R={byteSize:T};return S.store(eq).put(ez,R)})}removeAcknowledgedMutations(S){let T=S.store(e_),R=S.store(eA);return T.loadAll().next(T=>PersistencePromise.forEach(T,T=>{let P=IDBKeyRange.bound([T.userId,tV],[T.userId,T.lastAcknowledgedBatchId]);return R.loadAll(eN,P).next(R=>PersistencePromise.forEach(R,R=>{hardAssert(R.userId===T.userId);let P=fromDbMutationBatch(this.serializer,R);return removeMutationBatch(S,T.userId,P).next(()=>{})}))}))}ensureSequenceNumbers(S){let T=S.store(e$),R=S.store(eD),P=S.store(eZ);return P.get(eX).next(S=>{let writeSentinelKey=R=>T.put({targetId:0,path:encodeResourcePath(R),sequenceNumber:S.highestListenSequenceNumber}),P=[];return R.iterate((S,R)=>{let O=new ResourcePath(S),N=sentinelKey(O);P.push(T.get(N).next(S=>S?PersistencePromise.resolve():writeSentinelKey(O)))}).next(()=>PersistencePromise.waitFor(P))})}createCollectionParentIndex(S,T){S.createObjectStore(e0,{keyPath:e1});let R=T.store(e0),P=new MemoryCollectionParentIndex,addEntry=S=>{if(P.add(S)){let T=S.lastSegment(),P=S.popLast();return R.put({collectionId:T,parent:encodeResourcePath(P)})}};return T.store(eD).iterate({keysOnly:!0},(S,T)=>{let R=new ResourcePath(S);return addEntry(R.popLast())}).next(()=>T.store(eM).iterate({keysOnly:!0},([S,T,R],P)=>{let O=decodeResourcePath(T);return addEntry(O.popLast())}))}rewriteCanonicalIds(S){let T=S.store(eW);return T.iterate((S,R)=>{let P=fromDbTarget(R),O=toDbTarget(this.serializer,P);return T.put(O)})}rewriteRemoteDocumentCache(S,T){let R=T.store(eD),P=[];return R.iterate((S,R)=>{let O=T.store(eF),N=extractKey(R).path.toArray(),M={prefixPath:N.slice(0,N.length-2),collectionGroup:N[N.length-2],documentId:N[N.length-1],readTime:R.readTime||[0,0],unknownDocument:R.unknownDocument,noDocument:R.noDocument,document:R.document,hasCommittedMutations:!!R.hasCommittedMutations};P.push(O.put(M))}).next(()=>PersistencePromise.waitFor(P))}runOverlayMigration(S,T){let R=T.store(eA),P=newIndexedDbRemoteDocumentCache(this.serializer),O=new MemoryPersistence(MemoryEagerDelegate.factory,this.serializer.remoteSerializer);return R.loadAll().next(S=>{let R=new Map;return S.forEach(S=>{var T;let P=null!==(T=R.get(S.userId))&&void 0!==T?T:documentKeySet(),O=fromDbMutationBatch(this.serializer,S);O.keys().forEach(S=>P=P.add(S)),R.set(S.userId,P)}),PersistencePromise.forEach(R,(S,R)=>{let N=new User(R),M=IndexedDbDocumentOverlayCache.forUser(this.serializer,N),L=O.getIndexManager(N),V=IndexedDbMutationQueue.forUser(N,this.serializer,L,O.referenceDelegate),U=new LocalDocumentsView(P,V,M,L);return U.recalculateAndSaveOverlaysForDocumentKeys(new IndexedDbTransaction(T,ListenSequence.INVALID),S).next()})})}};function sentinelKey(S){return[0,encodeResourcePath(S)]}function createPrimaryClientStore(S){S.createObjectStore(eI)}function createMutationQueue(S){S.createObjectStore(e_,{keyPath:eP});let T=S.createObjectStore(eA,{keyPath:eO,autoIncrement:!0});T.createIndex(eN,ek,{unique:!0}),S.createObjectStore(eM)}function upgradeMutationBatchSchemaAndMigrateData(S,T){let R=T.store(eA);return R.loadAll().next(R=>{S.deleteObjectStore(eA);let P=S.createObjectStore(eA,{keyPath:eO,autoIncrement:!0});P.createIndex(eN,ek,{unique:!0});let O=T.store(eA),N=R.map(S=>O.put(S));return PersistencePromise.waitFor(N)})}function createLegacyRemoteDocumentCache(S){S.createObjectStore(eD)}function createRemoteDocumentCache(S){let T=S.createObjectStore(eF,{keyPath:eL});T.createIndex(eB,eV),T.createIndex(eU,ej)}function createDocumentGlobalStore(S){S.createObjectStore(eq)}function createQueryCache(S){let T=S.createObjectStore(e$,{keyPath:eH});T.createIndex(eY,eJ,{unique:!0});let R=S.createObjectStore(eW,{keyPath:eK});R.createIndex(eG,eQ,{unique:!0}),S.createObjectStore(eZ)}function dropQueryCache(S){S.deleteObjectStore(e$),S.deleteObjectStore(eW),S.deleteObjectStore(eZ)}function dropRemoteDocumentChangesStore(S){S.objectStoreNames.contains("remoteDocumentChanges")&&S.deleteObjectStore("remoteDocumentChanges")}function writeEmptyTargetGlobalEntry(S){let T=S.store(eZ),R={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:SnapshotVersion.min().toTimestamp(),targetCount:0};return T.put(eX,R)}function createClientMetadataStore(S){S.createObjectStore(e2,{keyPath:e3})}function createBundlesStore(S){S.createObjectStore(e6,{keyPath:e4})}function createNamedQueriesStore(S){S.createObjectStore(e9,{keyPath:e5})}function createFieldIndex(S){let T=S.createObjectStore(e8,{keyPath:e7,autoIncrement:!0});T.createIndex(te,tt,{unique:!1});let R=S.createObjectStore(tr,{keyPath:ti});R.createIndex(ts,ta,{unique:!1});let P=S.createObjectStore(tl,{keyPath:tu});P.createIndex(tc,td,{unique:!1})}function createDocumentOverlayStore(S){let T=S.createObjectStore(th,{keyPath:tp});T.createIndex(tf,tm,{unique:!1}),T.createIndex(tg,ty,{unique:!1})}function createGlobalsStore(S){S.createObjectStore(tv,{keyPath:tS})}function extractKey(S){return S.document?new DocumentKey(ResourcePath.fromString(S.document.name).popFirst(5)):S.noDocument?DocumentKey.fromSegments(S.noDocument.path):S.unknownDocument?DocumentKey.fromSegments(S.unknownDocument.path):fail()}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rN="IndexedDbPersistence",rk=null,rx=5e3,rM=4e3,rF=null,rL=null,rB="firestore_zombie",rV="main";let IndexedDbPersistence=class IndexedDbPersistence{constructor(S,T,R,P,O,N,M,L,V,U,W=rA){if(this.allowTabSynchronization=S,this.persistenceKey=T,this.clientId=R,this.queue=O,this.window=N,this.document=M,this.sequenceNumberSyncer=V,this.forceOwningTab=U,this.schemaVersion=W,this.listenSequence=null,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.windowUnloadHandler=null,this.inForeground=!1,this.documentVisibilityHandler=null,this.clientMetadataRefresher=null,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=S=>Promise.resolve(),!IndexedDbPersistence.isAvailable())throw new FirestoreError(es.UNIMPLEMENTED,rL);this.referenceDelegate=new IndexedDbLruDelegateImpl(this,P),this.dbName=T+rV,this.serializer=new LocalSerializer(L),this.simpleDb=new SimpleDb(this.dbName,this.schemaVersion,new SchemaConverter(this.serializer)),this.globalsCache=new IndexedDbGlobalsCache,this.targetCache=new IndexedDbTargetCache(this.referenceDelegate,this.serializer),this.remoteDocumentCache=newIndexedDbRemoteDocumentCache(this.serializer),this.bundleCache=new IndexedDbBundleCache,this.window&&this.window.localStorage?this.webStorage=this.window.localStorage:(this.webStorage=null,!1===U&&logError(rN,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.updateClientMetadataAndTryBecomePrimary().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new FirestoreError(es.FAILED_PRECONDITION,rF);return this.attachVisibilityHandler(),this.attachWindowUnloadHook(),this.scheduleClientMetadataAndPrimaryLeaseRefreshes(),this.runTransaction("getHighestListenSequenceNumber","readonly",S=>this.targetCache.getHighestSequenceNumber(S))}).then(S=>{this.listenSequence=new ListenSequence(S,this.sequenceNumberSyncer)}).then(()=>{this._started=!0}).catch(S=>(this.simpleDb&&this.simpleDb.close(),Promise.reject(S)))}setPrimaryStateListener(S){return this.primaryStateListener=async T=>{if(this.started)return S(T)},S(this.isPrimary)}setDatabaseDeletedListener(S){this.simpleDb.setVersionChangeListener(async T=>{null===T.newVersion&&await S()})}setNetworkEnabled(S){this.networkEnabled!==S&&(this.networkEnabled=S,this.queue.enqueueAndForget(async()=>{this.started&&await this.updateClientMetadataAndTryBecomePrimary()}))}updateClientMetadataAndTryBecomePrimary(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",S=>{let T=clientMetadataStore(S);return T.put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.verifyPrimaryLease(S).next(S=>{S||(this.isPrimary=!1,this.queue.enqueueRetryable(()=>this.primaryStateListener(!1)))})}).next(()=>this.canActAsPrimary(S)).next(T=>this.isPrimary&&!T?this.releasePrimaryLeaseIfHeld(S).next(()=>!1):!!T&&this.acquireOrExtendPrimaryLease(S).next(()=>!0))}).catch(S=>{if(isIndexedDbTransactionError(S))return logDebug(rN,"Failed to extend owner lease: ",S),this.isPrimary;if(!this.allowTabSynchronization)throw S;return logDebug(rN,"Releasing owner lease after error during lease refresh",S),!1}).then(S=>{this.isPrimary!==S&&this.queue.enqueueRetryable(()=>this.primaryStateListener(S)),this.isPrimary=S})}verifyPrimaryLease(S){let T=primaryClientStore(S);return T.get(eR).next(S=>PersistencePromise.resolve(this.isLocalClient(S)))}removeClientMetadata(S){let T=clientMetadataStore(S);return T.delete(this.clientId)}async maybeGarbageCollectMultiClientState(){if(this.isPrimary&&!this.isWithinAge(this.lastGarbageCollectionTime,rk)){this.lastGarbageCollectionTime=Date.now();let S=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",S=>{let T=getStore(S,e2);return T.loadAll().next(S=>{let R=this.filterActiveClients(S,rk),P=S.filter(S=>-1===R.indexOf(S));return PersistencePromise.forEach(P,S=>T.delete(S.clientId)).next(()=>P)})}).catch(()=>[]);if(this.webStorage)for(let T of S)this.webStorage.removeItem(this.zombiedClientLocalStorageKey(T.clientId))}}scheduleClientMetadataAndPrimaryLeaseRefreshes(){this.clientMetadataRefresher=this.queue.enqueueAfterDelay("client_metadata_refresh",rM,()=>this.updateClientMetadataAndTryBecomePrimary().then(()=>this.maybeGarbageCollectMultiClientState()).then(()=>this.scheduleClientMetadataAndPrimaryLeaseRefreshes()))}isLocalClient(S){return!!S&&S.ownerId===this.clientId}canActAsPrimary(S){if(this.forceOwningTab)return PersistencePromise.resolve(!0);let T=primaryClientStore(S);return T.get(eR).next(T=>{let R=null!==T&&this.isWithinAge(T.leaseTimestampMs,rx)&&!this.isClientZombied(T.ownerId);if(R){if(this.isLocalClient(T)&&this.networkEnabled)return!0;if(!this.isLocalClient(T)){if(!T.allowTabSynchronization)throw new FirestoreError(es.FAILED_PRECONDITION,rF);return!1}}return!!this.networkEnabled&&!!this.inForeground||clientMetadataStore(S).loadAll().next(S=>{let T=this.filterActiveClients(S,rx).find(S=>{if(this.clientId!==S.clientId){let T=!this.networkEnabled&&S.networkEnabled,R=!this.inForeground&&S.inForeground,P=this.networkEnabled===S.networkEnabled;if(T||R&&P)return!0}return!1});return void 0===T})}).next(S=>(this.isPrimary!==S&&logDebug(rN,`Client ${S?"is":"is not"} eligible for a primary lease.`),S))}async shutdown(){this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&(this.clientMetadataRefresher.cancel(),this.clientMetadataRefresher=null),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),await this.simpleDb.runTransaction("shutdown","readwrite",[eI,e2],S=>{let T=new IndexedDbTransaction(S,ListenSequence.INVALID);return this.releasePrimaryLeaseIfHeld(T).next(()=>this.removeClientMetadata(T))}),this.simpleDb.close(),this.removeClientZombiedEntry()}filterActiveClients(S,T){return S.filter(S=>this.isWithinAge(S.updateTimeMs,T)&&!this.isClientZombied(S.clientId))}getActiveClients(){return this.runTransaction("getActiveClients","readonly",S=>clientMetadataStore(S).loadAll().next(S=>this.filterActiveClients(S,rk).map(S=>S.clientId)))}get started(){return this._started}getGlobalsCache(){return this.globalsCache}getMutationQueue(S,T){return IndexedDbMutationQueue.forUser(S,this.serializer,T,this.referenceDelegate)}getTargetCache(){return this.targetCache}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(S){return new IndexedDbIndexManager(S,this.serializer.remoteSerializer.databaseId)}getDocumentOverlayCache(S){return IndexedDbDocumentOverlayCache.forUser(this.serializer,S)}getBundleCache(){return this.bundleCache}runTransaction(S,T,R){let P;logDebug(rN,"Starting transaction:",S);let O="readonly"===T?"readonly":"readwrite",N=getObjectStores(this.schemaVersion);return this.simpleDb.runTransaction(S,O,N,O=>(P=new IndexedDbTransaction(O,this.listenSequence?this.listenSequence.next():ListenSequence.INVALID),"readwrite-primary"===T)?this.verifyPrimaryLease(P).next(S=>!!S||this.canActAsPrimary(P)).next(T=>{if(!T)throw logError(`Failed to obtain primary lease for action '${S}'.`),this.isPrimary=!1,this.queue.enqueueRetryable(()=>this.primaryStateListener(!1)),new FirestoreError(es.FAILED_PRECONDITION,ep);return R(P)}).next(S=>this.acquireOrExtendPrimaryLease(P).next(()=>S)):this.verifyAllowTabSynchronization(P).next(()=>R(P))).then(S=>(P.raiseOnCommittedEvent(),S))}verifyAllowTabSynchronization(S){let T=primaryClientStore(S);return T.get(eR).next(S=>{let T=null!==S&&this.isWithinAge(S.leaseTimestampMs,rx)&&!this.isClientZombied(S.ownerId);if(T&&!this.isLocalClient(S)&&!this.forceOwningTab&&(!this.allowTabSynchronization||!S.allowTabSynchronization))throw new FirestoreError(es.FAILED_PRECONDITION,rF)})}acquireOrExtendPrimaryLease(S){let T={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return primaryClientStore(S).put(eR,T)}static isAvailable(){return SimpleDb.isAvailable()}releasePrimaryLeaseIfHeld(S){let T=primaryClientStore(S);return T.get(eR).next(S=>this.isLocalClient(S)?(logDebug(rN,"Releasing primary lease."),T.delete(eR)):PersistencePromise.resolve())}isWithinAge(S,T){let R=Date.now(),P=R-T,O=R;return!(S<P)&&(!(S>O)||(logError(`Detected an update time that is in the future: ${S} > ${O}`),!1))}attachVisibilityHandler(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=()=>{this.queue.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.updateClientMetadataAndTryBecomePrimary()))},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)}detachVisibilityHandler(){this.documentVisibilityHandler&&(this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)}attachWindowUnloadHook(){var S;"function"==typeof(null===(S=this.window)||void 0===S?void 0:S.addEventListener)&&(this.windowUnloadHandler=()=>{this.markClientZombied();let S=/(?:Version|Mobile)\/1[456]/;isSafari()&&(navigator.appVersion.match(S)||navigator.userAgent.match(S))&&this.queue.enterRestrictedMode(!0),this.queue.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.windowUnloadHandler))}detachWindowUnloadHook(){this.windowUnloadHandler&&(this.window.removeEventListener("pagehide",this.windowUnloadHandler),this.windowUnloadHandler=null)}isClientZombied(S){var T;try{let R=(null===(T=this.webStorage)||void 0===T?void 0:T.getItem(this.zombiedClientLocalStorageKey(S)))!==null;return logDebug(rN,`Client '${S}' ${R?"is":"is not"} zombied in LocalStorage`),R}catch(S){return logError(rN,"Failed to get zombied client id.",S),!1}}markClientZombied(){if(this.webStorage)try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(S){logError("Failed to set zombie client id.",S)}}removeClientZombiedEntry(){if(this.webStorage)try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(S){}}zombiedClientLocalStorageKey(S){return`${rB}_${this.persistenceKey}_${S}`}};function primaryClientStore(S){return getStore(S,eI)}function clientMetadataStore(S){return getStore(S,e2)}function indexedDbStoragePrefix(S,T){let R=S.projectId;return S.isDefaultDatabase||(R+="."+S.database),"firestore/"+T+"/"+R+"/"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function diffArrays(S,T,R,P,O){T=[...T],(S=[...S]).sort(R),T.sort(R);let N=S.length,M=T.length,L=0,V=0;for(;L<M&&V<N;){let N=R(S[V],T[L]);N<0?O(S[V++]):N>0?P(T[L++]):(L++,V++)}for(;L<M;)P(T[L++]);for(;V<N;)O(S[V++])}function isPrimitiveArrayEqual(S,T){if(S.length!==T.length)return!1;for(let R=0;R<S.length;++R)if(S[R]!==T[R])return!1;return!0}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rU="LocalStore",rj=3e8;let LocalStoreImpl=class LocalStoreImpl{constructor(S,T,R,P){this.persistence=S,this.queryEngine=T,this.serializer=P,this.targetDataByTarget=new SortedMap(primitiveComparator),this.targetIdByTarget=new ObjectMap(S=>canonifyTarget(S),targetEquals),this.collectionGroupReadTime=new Map,this.remoteDocuments=S.getRemoteDocumentCache(),this.targetCache=S.getTargetCache(),this.bundleCache=S.getBundleCache(),this.initializeUserComponents(R)}initializeUserComponents(S){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(S),this.indexManager=this.persistence.getIndexManager(S),this.mutationQueue=this.persistence.getMutationQueue(S,this.indexManager),this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.remoteDocuments.setIndexManager(this.indexManager),this.queryEngine.initialize(this.localDocuments,this.indexManager)}collectGarbage(S){return this.persistence.runTransaction("Collect garbage","readwrite-primary",T=>S.collect(T,this.targetDataByTarget))}};function newLocalStore(S,T,R,P){return new LocalStoreImpl(S,T,R,P)}async function localStoreHandleUserChange(S,T){let R=debugCast(S),P=await R.persistence.runTransaction("Handle user change","readonly",S=>{let P;return R.mutationQueue.getAllMutationBatches(S).next(O=>(P=O,R.initializeUserComponents(T),R.mutationQueue.getAllMutationBatches(S))).next(T=>{let O=[],N=[],M=documentKeySet();for(let S of P)for(let T of(O.push(S.batchId),S.mutations))M=M.add(T.key);for(let S of T)for(let T of(N.push(S.batchId),S.mutations))M=M.add(T.key);return R.localDocuments.getDocuments(S,M).next(S=>({affectedDocuments:S,removedBatchIds:O,addedBatchIds:N}))})});return P}function localStoreWriteLocally(S,T){let R,P;let O=debugCast(S),N=Timestamp.now(),M=T.reduce((S,T)=>S.add(T.key),documentKeySet());return O.persistence.runTransaction("Locally write mutations","readwrite",S=>{let L=mutableDocumentMap(),V=documentKeySet();return O.remoteDocuments.getEntries(S,M).next(S=>{(L=S).forEach((S,T)=>{T.isValidDocument()||(V=V.add(S))})}).next(()=>O.localDocuments.getOverlayedDocuments(S,L)).next(P=>{R=P;let M=[];for(let S of T){let T=mutationExtractBaseValue(S,R.get(S.key).overlayedDocument);null!=T&&M.push(new PatchMutation(S.key,T,extractFieldMask(T.value.mapValue),Precondition.exists(!0)))}return O.mutationQueue.addMutationBatch(S,N,M,T)}).next(T=>{P=T;let N=T.applyToLocalDocumentSet(R,V);return O.documentOverlayCache.saveOverlays(S,T.batchId,N)})}).then(()=>({batchId:P.batchId,changes:convertOverlayedDocumentMapToDocumentMap(R)}))}function localStoreAcknowledgeBatch(S,T){let R=debugCast(S);return R.persistence.runTransaction("Acknowledge batch","readwrite-primary",S=>{let P=T.batch.keys(),O=R.remoteDocuments.newChangeBuffer({trackRemovals:!0});return applyWriteToRemoteDocuments(R,S,T,O).next(()=>O.apply(S)).next(()=>R.mutationQueue.performConsistencyCheck(S)).next(()=>R.documentOverlayCache.removeOverlaysForBatchId(S,P,T.batch.batchId)).next(()=>R.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(S,getKeysWithTransformResults(T))).next(()=>R.localDocuments.getDocuments(S,P))})}function getKeysWithTransformResults(S){let T=documentKeySet();for(let R=0;R<S.mutationResults.length;++R){let P=S.mutationResults[R];P.transformResults.length>0&&(T=T.add(S.batch.mutations[R].key))}return T}function localStoreRejectBatch(S,T){let R=debugCast(S);return R.persistence.runTransaction("Reject batch","readwrite-primary",S=>{let P;return R.mutationQueue.lookupMutationBatch(S,T).next(T=>(hardAssert(null!==T),P=T.keys(),R.mutationQueue.removeMutationBatch(S,T))).next(()=>R.mutationQueue.performConsistencyCheck(S)).next(()=>R.documentOverlayCache.removeOverlaysForBatchId(S,P,T)).next(()=>R.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(S,P)).next(()=>R.localDocuments.getDocuments(S,P))})}function localStoreGetHighestUnacknowledgedBatchId(S){let T=debugCast(S);return T.persistence.runTransaction("Get highest unacknowledged batch id","readonly",S=>T.mutationQueue.getHighestUnacknowledgedBatchId(S))}function localStoreGetLastRemoteSnapshotVersion(S){let T=debugCast(S);return T.persistence.runTransaction("Get last remote snapshot version","readonly",S=>T.targetCache.getLastRemoteSnapshotVersion(S))}function localStoreApplyRemoteEventToLocalCache(S,T){let R=debugCast(S),P=T.snapshotVersion,O=R.targetDataByTarget;return R.persistence.runTransaction("Apply remote event","readwrite-primary",S=>{let N=R.remoteDocuments.newChangeBuffer({trackRemovals:!0});O=R.targetDataByTarget;let M=[];T.targetChanges.forEach((N,L)=>{let V=O.get(L);if(!V)return;M.push(R.targetCache.removeMatchingKeys(S,N.removedDocuments,L).next(()=>R.targetCache.addMatchingKeys(S,N.addedDocuments,L)));let U=V.withSequenceNumber(S.currentSequenceNumber);null!==T.targetMismatches.get(L)?U=U.withResumeToken(ByteString.EMPTY_BYTE_STRING,SnapshotVersion.min()).withLastLimboFreeSnapshotVersion(SnapshotVersion.min()):N.resumeToken.approximateByteSize()>0&&(U=U.withResumeToken(N.resumeToken,P)),O=O.insert(L,U),shouldPersistTargetData(V,U,N)&&M.push(R.targetCache.updateTargetData(S,U))});let L=mutableDocumentMap(),V=documentKeySet();if(T.documentUpdates.forEach(P=>{T.resolvedLimboDocuments.has(P)&&M.push(R.persistence.referenceDelegate.updateLimboDocument(S,P))}),M.push(populateDocumentChangeBuffer(S,N,T.documentUpdates).next(S=>{L=S.changedDocuments,V=S.existenceChangedKeys})),!P.isEqual(SnapshotVersion.min())){let T=R.targetCache.getLastRemoteSnapshotVersion(S).next(T=>R.targetCache.setTargetsMetadata(S,S.currentSequenceNumber,P));M.push(T)}return PersistencePromise.waitFor(M).next(()=>N.apply(S)).next(()=>R.localDocuments.getLocalViewOfDocuments(S,L,V)).next(()=>L)}).then(S=>(R.targetDataByTarget=O,S))}function populateDocumentChangeBuffer(S,T,R){let P=documentKeySet(),O=documentKeySet();return R.forEach(S=>P=P.add(S)),T.getEntries(S,P).next(S=>{let P=mutableDocumentMap();return R.forEach((R,N)=>{let M=S.get(R);N.isFoundDocument()!==M.isFoundDocument()&&(O=O.add(R)),N.isNoDocument()&&N.version.isEqual(SnapshotVersion.min())?(T.removeEntry(R,N.readTime),P=P.insert(R,N)):!M.isValidDocument()||N.version.compareTo(M.version)>0||0===N.version.compareTo(M.version)&&M.hasPendingWrites?(T.addEntry(N),P=P.insert(R,N)):logDebug(rU,"Ignoring outdated watch update for ",R,". Current version:",M.version," Watch version:",N.version)}),{changedDocuments:P,existenceChangedKeys:O}})}function shouldPersistTargetData(S,T,R){if(0===S.resumeToken.approximateByteSize())return!0;let P=T.snapshotVersion.toMicroseconds()-S.snapshotVersion.toMicroseconds();if(P>=rj)return!0;let O=R.addedDocuments.size+R.modifiedDocuments.size+R.removedDocuments.size;return O>0}async function localStoreNotifyLocalViewChanges(S,T){let R=debugCast(S);try{await R.persistence.runTransaction("notifyLocalViewChanges","readwrite",S=>PersistencePromise.forEach(T,T=>PersistencePromise.forEach(T.addedKeys,P=>R.persistence.referenceDelegate.addReference(S,T.targetId,P)).next(()=>PersistencePromise.forEach(T.removedKeys,P=>R.persistence.referenceDelegate.removeReference(S,T.targetId,P)))))}catch(S){if(isIndexedDbTransactionError(S))logDebug(rU,"Failed to update sequence numbers: "+S);else throw S}for(let S of T){let T=S.targetId;if(!S.fromCache){let S=R.targetDataByTarget.get(T),P=S.snapshotVersion,O=S.withLastLimboFreeSnapshotVersion(P);R.targetDataByTarget=R.targetDataByTarget.insert(T,O)}}}function localStoreGetNextMutationBatch(S,T){let R=debugCast(S);return R.persistence.runTransaction("Get next mutation batch","readonly",S=>(void 0===T&&(T=tV),R.mutationQueue.getNextMutationBatchAfterBatchId(S,T)))}function localStoreReadDocument(S,T){let R=debugCast(S);return R.persistence.runTransaction("read document","readonly",S=>R.localDocuments.getDocument(S,T))}function localStoreAllocateTarget(S,T){let R=debugCast(S);return R.persistence.runTransaction("Allocate target","readwrite",S=>{let P;return R.targetCache.getTargetData(S,T).next(O=>O?(P=O,PersistencePromise.resolve(P)):R.targetCache.allocateTargetId(S).next(O=>(P=new TargetData(T,O,"TargetPurposeListen",S.currentSequenceNumber),R.targetCache.addTargetData(S,P).next(()=>P))))}).then(S=>{let P=R.targetDataByTarget.get(S.targetId);return(null===P||S.snapshotVersion.compareTo(P.snapshotVersion)>0)&&(R.targetDataByTarget=R.targetDataByTarget.insert(S.targetId,S),R.targetIdByTarget.set(T,S.targetId)),S})}function localStoreGetTargetData(S,T,R){let P=debugCast(S),O=P.targetIdByTarget.get(R);return void 0!==O?PersistencePromise.resolve(P.targetDataByTarget.get(O)):P.targetCache.getTargetData(T,R)}async function localStoreReleaseTarget(S,T,R){let P=debugCast(S),O=P.targetDataByTarget.get(T),N=R?"readwrite":"readwrite-primary";try{R||await P.persistence.runTransaction("Release target",N,S=>P.persistence.referenceDelegate.removeTarget(S,O))}catch(S){if(isIndexedDbTransactionError(S))logDebug(rU,`Failed to update sequence numbers for target ${T}: ${S}`);else throw S}P.targetDataByTarget=P.targetDataByTarget.remove(T),P.targetIdByTarget.delete(O.target)}function localStoreExecuteQuery(S,T,R){let P=debugCast(S),O=SnapshotVersion.min(),N=documentKeySet();return P.persistence.runTransaction("Execute query","readwrite",S=>localStoreGetTargetData(P,S,queryToTarget(T)).next(T=>{if(T)return O=T.lastLimboFreeSnapshotVersion,P.targetCache.getMatchingKeysForTargetId(S,T.targetId).next(S=>{N=S})}).next(()=>P.queryEngine.getDocumentsMatchingQuery(S,T,R?O:SnapshotVersion.min(),R?N:documentKeySet())).next(S=>(setMaxReadTime(P,queryCollectionGroup(T),S),{documents:S,remoteKeys:N})))}function applyWriteToRemoteDocuments(S,T,R,P){let O=R.batch,N=O.keys(),M=PersistencePromise.resolve();return N.forEach(S=>{M=M.next(()=>P.getEntry(T,S)).next(T=>{let N=R.docVersions.get(S);hardAssert(null!==N),0>T.version.compareTo(N)&&(O.applyToRemoteDocument(T,R),T.isValidDocument()&&(T.setReadTime(R.commitVersion),P.addEntry(T)))})}),M.next(()=>S.mutationQueue.removeMutationBatch(T,O))}function localStoreLookupMutationDocuments(S,T){let R=debugCast(S),P=debugCast(R.mutationQueue);return R.persistence.runTransaction("Lookup mutation documents","readonly",S=>P.lookupMutationKeys(S,T).next(T=>T?R.localDocuments.getDocuments(S,T):PersistencePromise.resolve(null)))}function localStoreRemoveCachedMutationBatchMetadata(S,T){let R=debugCast(debugCast(S,LocalStoreImpl).mutationQueue);R.removeCachedMutationKeys(T)}function localStoreGetActiveClients(S){let T=debugCast(debugCast(S,LocalStoreImpl).persistence);return T.getActiveClients()}function localStoreGetCachedTarget(S,T){let R=debugCast(S),P=debugCast(R.targetCache),O=R.targetDataByTarget.get(T);return O?Promise.resolve(O.target):R.persistence.runTransaction("Get target data","readonly",S=>P.getTargetDataForTarget(S,T).next(S=>S?S.target:null))}function localStoreGetNewDocumentChanges(S,T){let R=debugCast(S),P=R.collectionGroupReadTime.get(T)||SnapshotVersion.min();return R.persistence.runTransaction("Get new document changes","readonly",S=>R.remoteDocuments.getAllFromCollectionGroup(S,T,newIndexOffsetSuccessorFromReadTime(P,ed),Number.MAX_SAFE_INTEGER)).then(S=>(setMaxReadTime(R,T,S),S))}function setMaxReadTime(S,T,R){let P=S.collectionGroupReadTime.get(T)||SnapshotVersion.min();R.forEach((S,T)=>{T.readTime.compareTo(P)>0&&(P=T.readTime)}),S.collectionGroupReadTime.set(T,P)}function umbrellaTarget(S){return queryToTarget(newQueryForPath(ResourcePath.fromString(`__bundle__/docs/${S}`)))}async function localStoreApplyBundledDocuments(S,T,R,P){let O=debugCast(S),N=documentKeySet(),M=mutableDocumentMap();for(let S of R){let R=T.toDocumentKey(S.metadata.name);S.document&&(N=N.add(R));let P=T.toMutableDocument(S);P.setReadTime(T.toSnapshotVersion(S.metadata.readTime)),M=M.insert(R,P)}let L=O.remoteDocuments.newChangeBuffer({trackRemovals:!0}),V=await localStoreAllocateTarget(O,umbrellaTarget(P));return O.persistence.runTransaction("Apply bundle documents","readwrite",S=>populateDocumentChangeBuffer(S,L,M).next(T=>(L.apply(S),T)).next(T=>O.targetCache.removeMatchingKeysForTargetId(S,V.targetId).next(()=>O.targetCache.addMatchingKeys(S,N,V.targetId)).next(()=>O.localDocuments.getLocalViewOfDocuments(S,T.changedDocuments,T.existenceChangedKeys)).next(()=>T.changedDocuments)))}function localStoreHasNewerBundle(S,T){let R=debugCast(S),P=fromVersion(T.createTime);return R.persistence.runTransaction("hasNewerBundle","readonly",S=>R.bundleCache.getBundleMetadata(S,T.id)).then(S=>!!S&&S.createTime.compareTo(P)>=0)}function localStoreSaveBundle(S,T){let R=debugCast(S);return R.persistence.runTransaction("Save bundle","readwrite",S=>R.bundleCache.saveBundleMetadata(S,T))}async function localStoreSaveNamedQuery(S,T,R=documentKeySet()){let P=await localStoreAllocateTarget(S,queryToTarget(fromBundledQuery(T.bundledQuery))),O=debugCast(S);return O.persistence.runTransaction("Save named query","readwrite",S=>{let N=fromVersion(T.readTime);if(P.snapshotVersion.compareTo(N)>=0)return O.bundleCache.saveNamedQuery(S,T);let M=P.withResumeToken(ByteString.EMPTY_BYTE_STRING,N);return O.targetDataByTarget=O.targetDataByTarget.insert(M.targetId,M),O.targetCache.updateTargetData(S,M).next(()=>O.targetCache.removeMatchingKeysForTargetId(S,P.targetId)).next(()=>O.targetCache.addMatchingKeys(S,R,P.targetId)).next(()=>O.bundleCache.saveNamedQuery(S,T))})}function localStoreSetIndexAutoCreationEnabled(S,T){let R=debugCast(S);R.queryEngine.indexAutoCreationEnabled=T}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let QueryContext=class QueryContext{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(S){this._documentReadCount+=S}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rq=100;function getDefaultRelativeIndexReadCostPerDocument(){return(0,K.G6)()?8:getAndroidVersion((0,K.z$)())>0?6:4}let QueryEngine=class QueryEngine{constructor(){this.initialized=!1,this.indexAutoCreationEnabled=!1,this.indexAutoCreationMinCollectionSize=rq,this.relativeIndexReadCostPerDocument=getDefaultRelativeIndexReadCostPerDocument()}initialize(S,T){this.localDocumentsView=S,this.indexManager=T,this.initialized=!0}getDocumentsMatchingQuery(S,T,R,P){let O={result:null};return this.performQueryUsingIndex(S,T).next(S=>{O.result=S}).next(()=>{if(!O.result)return this.performQueryUsingRemoteKeys(S,T,P,R).next(S=>{O.result=S})}).next(()=>{if(O.result)return;let R=new QueryContext;return this.executeFullCollectionScan(S,T,R).next(P=>{if(O.result=P,this.indexAutoCreationEnabled)return this.createCacheIndexes(S,T,R,P.size)})}).next(()=>O.result)}createCacheIndexes(S,T,R,P){return R.documentReadCount<this.indexAutoCreationMinCollectionSize?(getLogLevel()<=U.in.DEBUG&&logDebug("QueryEngine","SDK will not create cache indexes for query:",stringifyQuery(T),"since it only creates cache indexes for collection contains","more than or equal to",this.indexAutoCreationMinCollectionSize,"documents"),PersistencePromise.resolve()):(getLogLevel()<=U.in.DEBUG&&logDebug("QueryEngine","Query:",stringifyQuery(T),"scans",R.documentReadCount,"local documents and returns",P,"documents as results."),R.documentReadCount>this.relativeIndexReadCostPerDocument*P)?(getLogLevel()<=U.in.DEBUG&&logDebug("QueryEngine","The SDK decides to create cache indexes for query:",stringifyQuery(T),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(S,queryToTarget(T))):PersistencePromise.resolve()}performQueryUsingIndex(S,T){if(queryMatchesAllDocuments(T))return PersistencePromise.resolve(null);let R=queryToTarget(T);return this.indexManager.getIndexType(S,R).next(P=>0===P?null:(null!==T.limit&&1===P&&(R=queryToTarget(T=queryWithLimit(T,null,"F"))),this.indexManager.getDocumentsMatchingTarget(S,R).next(P=>{let O=documentKeySet(...P);return this.localDocumentsView.getDocuments(S,O).next(P=>this.indexManager.getMinOffset(S,R).next(R=>{let N=this.applyQuery(T,P);return this.needsRefill(T,N,O,R.readTime)?this.performQueryUsingIndex(S,queryWithLimit(T,null,"F")):this.appendRemainingResults(S,N,T,R)}))})))}performQueryUsingRemoteKeys(S,T,R,P){return queryMatchesAllDocuments(T)||P.isEqual(SnapshotVersion.min())?PersistencePromise.resolve(null):this.localDocumentsView.getDocuments(S,R).next(O=>{let N=this.applyQuery(T,O);return this.needsRefill(T,N,R,P)?PersistencePromise.resolve(null):(getLogLevel()<=U.in.DEBUG&&logDebug("QueryEngine","Re-using previous result from %s to execute query: %s",P.toString(),stringifyQuery(T)),this.appendRemainingResults(S,N,T,newIndexOffsetSuccessorFromReadTime(P,ed)).next(S=>S))})}applyQuery(S,T){let R=new SortedSet(newQueryComparator(S));return T.forEach((T,P)=>{queryMatches(S,P)&&(R=R.add(P))}),R}needsRefill(S,T,R,P){if(null===S.limit)return!1;if(R.size!==T.size)return!0;let O="F"===S.limitType?T.last():T.first();return!!O&&(O.hasPendingWrites||O.version.compareTo(P)>0)}executeFullCollectionScan(S,T,R){return getLogLevel()<=U.in.DEBUG&&logDebug("QueryEngine","Using full collection scan to execute query:",stringifyQuery(T)),this.localDocumentsView.getDocumentsMatchingQuery(S,T,IndexOffset.min(),R)}appendRemainingResults(S,T,R,P){return this.localDocumentsView.getDocumentsMatchingQuery(S,R,P).next(S=>(T.forEach(T=>{S=S.insert(T.key,T)}),S))}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rz="firestore_clients";function createWebStorageClientStateKey(S,T){return`${rz}_${S}_${T}`}let rW="firestore_mutations";function createWebStorageMutationBatchKey(S,T,R){let P=`${rW}_${S}_${R}`;return T.isAuthenticated()&&(P+=`_${T.uid}`),P}let rK="firestore_targets";function createWebStorageQueryTargetMetadataKey(S,T){return`${rK}_${S}_${T}`}let rG="firestore_online_state";function createWebStorageOnlineStateKey(S){return`${rG}_${S}`}let rQ="firestore_bundle_loaded_v2";function createBundleLoadedKey(S){return`${rQ}_${S}`}let r$="firestore_sequence_number";function createWebStorageSequenceNumberKey(S){return`${r$}_${S}`}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rH="SharedClientState";let MutationMetadata=class MutationMetadata{constructor(S,T,R,P){this.user=S,this.batchId=T,this.state=R,this.error=P}static fromWebStorageEntry(S,T,R){let P;let O=JSON.parse(R),N="object"==typeof O&&-1!==["pending","acknowledged","rejected"].indexOf(O.state)&&(void 0===O.error||"object"==typeof O.error);return(N&&O.error&&(N="string"==typeof O.error.message&&"string"==typeof O.error.code)&&(P=new FirestoreError(O.error.code,O.error.message)),N)?new MutationMetadata(S,T,O.state,P):(logError(rH,`Failed to parse mutation state for ID '${T}': ${R}`),null)}toWebStorageJSON(){let S={state:this.state,updateTimeMs:Date.now()};return this.error&&(S.error={code:this.error.code,message:this.error.message}),JSON.stringify(S)}};let QueryTargetMetadata=class QueryTargetMetadata{constructor(S,T,R){this.targetId=S,this.state=T,this.error=R}static fromWebStorageEntry(S,T){let R;let P=JSON.parse(T),O="object"==typeof P&&-1!==["not-current","current","rejected"].indexOf(P.state)&&(void 0===P.error||"object"==typeof P.error);return(O&&P.error&&(O="string"==typeof P.error.message&&"string"==typeof P.error.code)&&(R=new FirestoreError(P.error.code,P.error.message)),O)?new QueryTargetMetadata(S,P.state,R):(logError(rH,`Failed to parse target state for ID '${S}': ${T}`),null)}toWebStorageJSON(){let S={state:this.state,updateTimeMs:Date.now()};return this.error&&(S.error={code:this.error.code,message:this.error.message}),JSON.stringify(S)}};let RemoteClientState=class RemoteClientState{constructor(S,T){this.clientId=S,this.activeTargetIds=T}static fromWebStorageEntry(S,T){let R=JSON.parse(T),P="object"==typeof R&&R.activeTargetIds instanceof Array,O=targetIdSet();for(let S=0;P&&S<R.activeTargetIds.length;++S)P=isSafeInteger(R.activeTargetIds[S]),O=O.add(R.activeTargetIds[S]);return P?new RemoteClientState(S,O):(logError(rH,`Failed to parse client data for instance '${S}': ${T}`),null)}};let SharedOnlineState=class SharedOnlineState{constructor(S,T){this.clientId=S,this.onlineState=T}static fromWebStorageEntry(S){let T=JSON.parse(S),R="object"==typeof T&&-1!==["Unknown","Online","Offline"].indexOf(T.onlineState)&&"string"==typeof T.clientId;return R?new SharedOnlineState(T.clientId,T.onlineState):(logError(rH,`Failed to parse online state: ${S}`),null)}};let LocalClientState=class LocalClientState{constructor(){this.activeTargetIds=targetIdSet()}addQueryTarget(S){this.activeTargetIds=this.activeTargetIds.add(S)}removeQueryTarget(S){this.activeTargetIds=this.activeTargetIds.delete(S)}toWebStorageJSON(){let S={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(S)}};let WebStorageSharedClientState=class WebStorageSharedClientState{constructor(S,T,R,P,O){this.window=S,this.queue=T,this.persistenceKey=R,this.localClientId=P,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.storageListener=this.handleWebStorageEvent.bind(this),this.activeClients=new SortedMap(primitiveComparator),this.started=!1,this.earlyEvents=[];let N=R.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=O,this.localClientStorageKey=createWebStorageClientStateKey(this.persistenceKey,this.localClientId),this.sequenceNumberKey=createWebStorageSequenceNumberKey(this.persistenceKey),this.activeClients=this.activeClients.insert(this.localClientId,new LocalClientState),this.clientStateKeyRe=RegExp(`^${rz}_${N}_([^_]*)$`),this.mutationBatchKeyRe=RegExp(`^${rW}_${N}_(\\d+)(?:_(.*))?$`),this.queryTargetKeyRe=RegExp(`^${rK}_${N}_(\\d+)$`),this.onlineStateKey=createWebStorageOnlineStateKey(this.persistenceKey),this.bundleLoadedKey=createBundleLoadedKey(this.persistenceKey),this.window.addEventListener("storage",this.storageListener)}static isAvailable(S){return!!(S&&S.localStorage)}async start(){let S=await this.syncEngine.getActiveClients();for(let T of S){if(T===this.localClientId)continue;let S=this.getItem(createWebStorageClientStateKey(this.persistenceKey,T));if(S){let R=RemoteClientState.fromWebStorageEntry(T,S);R&&(this.activeClients=this.activeClients.insert(R.clientId,R))}}this.persistClientState();let T=this.storage.getItem(this.onlineStateKey);if(T){let S=this.fromWebStorageOnlineState(T);S&&this.handleOnlineStateEvent(S)}for(let S of this.earlyEvents)this.handleWebStorageEvent(S);this.earlyEvents=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(S){this.setItem(this.sequenceNumberKey,JSON.stringify(S))}getAllActiveQueryTargets(){return this.extractActiveQueryTargets(this.activeClients)}isActiveQueryTarget(S){let T=!1;return this.activeClients.forEach((R,P)=>{P.activeTargetIds.has(S)&&(T=!0)}),T}addPendingMutation(S){this.persistMutationState(S,"pending")}updateMutationState(S,T,R){this.persistMutationState(S,T,R),this.removeMutationState(S)}addLocalQueryTarget(S,T=!0){let R="not-current";if(this.isActiveQueryTarget(S)){let T=this.storage.getItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,S));if(T){let P=QueryTargetMetadata.fromWebStorageEntry(S,T);P&&(R=P.state)}}return T&&this.localClientState.addQueryTarget(S),this.persistClientState(),R}removeLocalQueryTarget(S){this.localClientState.removeQueryTarget(S),this.persistClientState()}isLocalQueryTarget(S){return this.localClientState.activeTargetIds.has(S)}clearQueryState(S){this.removeItem(createWebStorageQueryTargetMetadataKey(this.persistenceKey,S))}updateQueryState(S,T,R){this.persistQueryTargetState(S,T,R)}handleUserChange(S,T,R){T.forEach(S=>{this.removeMutationState(S)}),this.currentUser=S,R.forEach(S=>{this.addPendingMutation(S)})}setOnlineState(S){this.persistOnlineState(S)}notifyBundleLoaded(S){this.persistBundleLoadedState(S)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)}getItem(S){let T=this.storage.getItem(S);return logDebug(rH,"READ",S,T),T}setItem(S,T){logDebug(rH,"SET",S,T),this.storage.setItem(S,T)}removeItem(S){logDebug(rH,"REMOVE",S),this.storage.removeItem(S)}handleWebStorageEvent(S){let T=S;if(T.storageArea===this.storage){if(logDebug(rH,"EVENT",T.key,T.newValue),T.key===this.localClientStorageKey){logError("Received WebStorage notification for local change. Another client might have garbage-collected our state");return}this.queue.enqueueRetryable(async()=>{if(!this.started){this.earlyEvents.push(T);return}if(null!==T.key){if(this.clientStateKeyRe.test(T.key)){if(null!=T.newValue){let S=this.fromWebStorageClientState(T.key,T.newValue);if(S)return this.handleClientStateEvent(S.clientId,S)}else{let S=this.fromWebStorageClientStateKey(T.key);return this.handleClientStateEvent(S,null)}}else if(this.mutationBatchKeyRe.test(T.key)){if(null!==T.newValue){let S=this.fromWebStorageMutationMetadata(T.key,T.newValue);if(S)return this.handleMutationBatchEvent(S)}}else if(this.queryTargetKeyRe.test(T.key)){if(null!==T.newValue){let S=this.fromWebStorageQueryTargetMetadata(T.key,T.newValue);if(S)return this.handleQueryTargetEvent(S)}}else if(T.key===this.onlineStateKey){if(null!==T.newValue){let S=this.fromWebStorageOnlineState(T.newValue);if(S)return this.handleOnlineStateEvent(S)}}else if(T.key===this.sequenceNumberKey){let S=fromWebStorageSequenceNumber(T.newValue);S!==ListenSequence.INVALID&&this.sequenceNumberHandler(S)}else if(T.key===this.bundleLoadedKey){let S=this.fromWebStoreBundleLoadedState(T.newValue);await Promise.all(S.map(S=>this.syncEngine.synchronizeWithChangedDocuments(S)))}}})}}get localClientState(){return this.activeClients.get(this.localClientId)}persistClientState(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())}persistMutationState(S,T,R){let P=new MutationMetadata(this.currentUser,S,T,R),O=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,S);this.setItem(O,P.toWebStorageJSON())}removeMutationState(S){let T=createWebStorageMutationBatchKey(this.persistenceKey,this.currentUser,S);this.removeItem(T)}persistOnlineState(S){let T={clientId:this.localClientId,onlineState:S};this.storage.setItem(this.onlineStateKey,JSON.stringify(T))}persistQueryTargetState(S,T,R){let P=createWebStorageQueryTargetMetadataKey(this.persistenceKey,S),O=new QueryTargetMetadata(S,T,R);this.setItem(P,O.toWebStorageJSON())}persistBundleLoadedState(S){let T=JSON.stringify(Array.from(S));this.setItem(this.bundleLoadedKey,T)}fromWebStorageClientStateKey(S){let T=this.clientStateKeyRe.exec(S);return T?T[1]:null}fromWebStorageClientState(S,T){let R=this.fromWebStorageClientStateKey(S);return RemoteClientState.fromWebStorageEntry(R,T)}fromWebStorageMutationMetadata(S,T){let R=this.mutationBatchKeyRe.exec(S),P=Number(R[1]),O=void 0!==R[2]?R[2]:null;return MutationMetadata.fromWebStorageEntry(new User(O),P,T)}fromWebStorageQueryTargetMetadata(S,T){let R=this.queryTargetKeyRe.exec(S),P=Number(R[1]);return QueryTargetMetadata.fromWebStorageEntry(P,T)}fromWebStorageOnlineState(S){return SharedOnlineState.fromWebStorageEntry(S)}fromWebStoreBundleLoadedState(S){return JSON.parse(S)}async handleMutationBatchEvent(S){if(S.user.uid!==this.currentUser.uid){logDebug(rH,`Ignoring mutation for non-active user ${S.user.uid}`);return}return this.syncEngine.applyBatchState(S.batchId,S.state,S.error)}handleQueryTargetEvent(S){return this.syncEngine.applyTargetState(S.targetId,S.state,S.error)}handleClientStateEvent(S,T){let R=T?this.activeClients.insert(S,T):this.activeClients.remove(S),P=this.extractActiveQueryTargets(this.activeClients),O=this.extractActiveQueryTargets(R),N=[],M=[];return O.forEach(S=>{P.has(S)||N.push(S)}),P.forEach(S=>{O.has(S)||M.push(S)}),this.syncEngine.applyActiveTargetsChange(N,M).then(()=>{this.activeClients=R})}handleOnlineStateEvent(S){this.activeClients.get(S.clientId)&&this.onlineStateHandler(S.onlineState)}extractActiveQueryTargets(S){let T=targetIdSet();return S.forEach((S,R)=>{T=T.unionWith(R.activeTargetIds)}),T}};function fromWebStorageSequenceNumber(S){let T=ListenSequence.INVALID;if(null!=S)try{let R=JSON.parse(S);hardAssert("number"==typeof R),T=R}catch(S){logError(rH,"Failed to read sequence number from WebStorage",S)}return T}let MemorySharedClientState=class MemorySharedClientState{constructor(){this.localState=new LocalClientState,this.queryState={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(S){}updateMutationState(S,T,R){}addLocalQueryTarget(S,T=!0){return T&&this.localState.addQueryTarget(S),this.queryState[S]||"not-current"}updateQueryState(S,T,R){this.queryState[S]=T}removeLocalQueryTarget(S){this.localState.removeQueryTarget(S)}isLocalQueryTarget(S){return this.localState.activeTargetIds.has(S)}clearQueryState(S){delete this.queryState[S]}getAllActiveQueryTargets(){return this.localState.activeTargetIds}isActiveQueryTarget(S){return this.localState.activeTargetIds.has(S)}start(){return this.localState=new LocalClientState,Promise.resolve()}handleUserChange(S,T,R){}setOnlineState(S){}shutdown(){}writeSequenceNumber(S){}notifyBundleLoaded(S){}};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let NoopConnectivityMonitor=class NoopConnectivityMonitor{addCallback(S){}shutdown(){}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let StreamBridge=class StreamBridge{constructor(S){this.sendFn=S.sendFn,this.closeFn=S.closeFn}onConnected(S){this.wrappedOnConnected=S}onOpen(S){this.wrappedOnOpen=S}onClose(S){this.wrappedOnClose=S}onMessage(S){this.wrappedOnMessage=S}close(){this.closeFn()}send(S){this.sendFn(S)}callOnConnected(){this.wrappedOnConnected()}callOnOpen(){this.wrappedOnOpen()}callOnClose(S){this.wrappedOnClose(S)}callOnMessage(S){this.wrappedOnMessage(S)}};/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rY=null;function generateInitialUniqueDebugId(){let S=268435456,T=2415919104,R=T-S,P=Math.round(R*Math.random());return S+P}function generateUniqueDebugId(){return null===rY?rY=generateInitialUniqueDebugId():rY++,"0x"+rY.toString(16)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function nodePromise(S){return new Promise((T,R)=>{S((S,P)=>{S?R(S):T(P)})})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let rJ="1.9.1",rX="GrpcConnection",rZ=`gl-node/${process.versions.node} fire/${en} grpc/${rJ}`;function createMetadata(S,T,R,P){hardAssert(null===T||"OAuth"===T.type);let O=new X.SF;return T&&T.headers.forEach((S,T)=>O.set(T,S)),R&&R.headers.forEach((S,T)=>O.set(T,S)),P&&O.set("X-Firebase-GMPID",P),O.set("X-Goog-Api-Client",rZ),O.set("Google-Cloud-Resource-Prefix",S),O.set("x-goog-request-params",S),O}let GrpcConnection=class GrpcConnection{constructor(S,T){this.databaseInfo=T,this.cachedStub=null,this.firestore=S.google.firestore.v1,this.databasePath=`projects/${T.databaseId.projectId}/databases/${T.databaseId.database}`}get shouldResourcePathBeIncludedInRequest(){return!0}ensureActiveStub(){if(!this.cachedStub){logDebug(rX,"Creating Firestore stub.");let S=this.databaseInfo.ssl?X.K9.createSsl():X.K9.createInsecure();this.cachedStub=new this.firestore.Firestore(this.databaseInfo.host,S)}return this.cachedStub}invokeRPC(S,T,R,P,O){let N=generateUniqueDebugId(),M=this.ensureActiveStub(),L=createMetadata(this.databasePath,P,O,this.databaseInfo.appId),V=Object.assign({database:this.databasePath},R);return nodePromise(T=>(logDebug(rX,`RPC '${S}' ${N} invoked with request:`,R),M[S](V,L,(R,P)=>{R?(logDebug(rX,`RPC '${S}' ${N} failed with error:`,R),T(new FirestoreError(mapCodeFromRpcCode(R.code),R.message))):(logDebug(rX,`RPC '${S}' ${N} completed with response:`,P),T(void 0,P))})))}invokeStreamingRPC(S,T,R,P,O,N){let M=generateUniqueDebugId(),L=[],V=new Deferred;logDebug(rX,`RPC '${S}' ${M} invoked (streaming) with request:`,R);let U=this.ensureActiveStub(),W=createMetadata(this.databasePath,P,O,this.databaseInfo.appId),K=Object.assign(Object.assign({},R),{database:this.databasePath}),Q=U[S](K,W),$=!1;return Q.on("data",T=>{logDebug(rX,`RPC ${S} ${M} received result:`,T),L.push(T),void 0!==N&&L.length===N&&($=!0,V.resolve(L))}),Q.on("end",()=>{logDebug(rX,`RPC '${S}' ${M} completed.`),$||($=!0,V.resolve(L))}),Q.on("error",T=>{logDebug(rX,`RPC '${S}' ${M} failed with error:`,T);let R=mapCodeFromRpcCode(T.code);V.reject(new FirestoreError(R,T.message))}),V.promise}openStream(S,T,R){let P=generateUniqueDebugId(),O=this.ensureActiveStub(),N=createMetadata(this.databasePath,T,R,this.databaseInfo.appId),M=O[S](N),L=!1,close=S=>{L||(L=!0,V.callOnClose(S),M.end())},V=new StreamBridge({sendFn:T=>{if(L)logDebug(rX,`RPC '${S}' stream ${P} not sending because gRPC stream is closed:`,T);else{logDebug(rX,`RPC '${S}' stream ${P} sending:`,T);try{M.write(T)}catch(S){throw logError("Failure sending:",T),logError("Error:",S),S}}},closeFn:()=>{logDebug(rX,`RPC '${S}' stream ${P} closed locally via close().`),close()}}),U=!1;return M.on("data",T=>{L||(logDebug(rX,`RPC '${S}' stream ${P} received:`,T),U||(V.callOnConnected(),U=!0),V.callOnMessage(T))}),M.on("end",()=>{logDebug(rX,`RPC '${S}' stream ${P} ended.`),close()}),M.on("error",T=>{if(!L){logWarn(rX,`RPC '${S}' stream ${P} error. Code:`,T.code,"Message:",T.message);let R=mapCodeFromRpcCode(T.code);close(new FirestoreError(R,T.message))}}),logDebug(rX,`Opening RPC '${S}' stream ${P} to ${this.databaseInfo.host}`),setTimeout(()=>{V.callOnOpen()},0),V}terminate(){this.cachedStub&&(this.cachedStub.close(),this.cachedStub=void 0)}};let r0={google:{nested:{protobuf:{options:{csharp_namespace:"Google.Protobuf.WellKnownTypes",go_package:"github.com/golang/protobuf/ptypes/wrappers",java_package:"com.google.protobuf",java_outer_classname:"WrappersProto",java_multiple_files:!0,objc_class_prefix:"GPB",cc_enable_arenas:!0,optimize_for:"SPEED"},nested:{Timestamp:{fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}},FileDescriptorSet:{fields:{file:{rule:"repeated",type:"FileDescriptorProto",id:1}}},FileDescriptorProto:{fields:{name:{type:"string",id:1},package:{type:"string",id:2},dependency:{rule:"repeated",type:"string",id:3},publicDependency:{rule:"repeated",type:"int32",id:10,options:{packed:!1}},weakDependency:{rule:"repeated",type:"int32",id:11,options:{packed:!1}},messageType:{rule:"repeated",type:"DescriptorProto",id:4},enumType:{rule:"repeated",type:"EnumDescriptorProto",id:5},service:{rule:"repeated",type:"ServiceDescriptorProto",id:6},extension:{rule:"repeated",type:"FieldDescriptorProto",id:7},options:{type:"FileOptions",id:8},sourceCodeInfo:{type:"SourceCodeInfo",id:9},syntax:{type:"string",id:12}}},DescriptorProto:{fields:{name:{type:"string",id:1},field:{rule:"repeated",type:"FieldDescriptorProto",id:2},extension:{rule:"repeated",type:"FieldDescriptorProto",id:6},nestedType:{rule:"repeated",type:"DescriptorProto",id:3},enumType:{rule:"repeated",type:"EnumDescriptorProto",id:4},extensionRange:{rule:"repeated",type:"ExtensionRange",id:5},oneofDecl:{rule:"repeated",type:"OneofDescriptorProto",id:8},options:{type:"MessageOptions",id:7},reservedRange:{rule:"repeated",type:"ReservedRange",id:9},reservedName:{rule:"repeated",type:"string",id:10}},nested:{ExtensionRange:{fields:{start:{type:"int32",id:1},end:{type:"int32",id:2}}},ReservedRange:{fields:{start:{type:"int32",id:1},end:{type:"int32",id:2}}}}},FieldDescriptorProto:{fields:{name:{type:"string",id:1},number:{type:"int32",id:3},label:{type:"Label",id:4},type:{type:"Type",id:5},typeName:{type:"string",id:6},extendee:{type:"string",id:2},defaultValue:{type:"string",id:7},oneofIndex:{type:"int32",id:9},jsonName:{type:"string",id:10},options:{type:"FieldOptions",id:8}},nested:{Type:{values:{TYPE_DOUBLE:1,TYPE_FLOAT:2,TYPE_INT64:3,TYPE_UINT64:4,TYPE_INT32:5,TYPE_FIXED64:6,TYPE_FIXED32:7,TYPE_BOOL:8,TYPE_STRING:9,TYPE_GROUP:10,TYPE_MESSAGE:11,TYPE_BYTES:12,TYPE_UINT32:13,TYPE_ENUM:14,TYPE_SFIXED32:15,TYPE_SFIXED64:16,TYPE_SINT32:17,TYPE_SINT64:18}},Label:{values:{LABEL_OPTIONAL:1,LABEL_REQUIRED:2,LABEL_REPEATED:3}}}},OneofDescriptorProto:{fields:{name:{type:"string",id:1},options:{type:"OneofOptions",id:2}}},EnumDescriptorProto:{fields:{name:{type:"string",id:1},value:{rule:"repeated",type:"EnumValueDescriptorProto",id:2},options:{type:"EnumOptions",id:3}}},EnumValueDescriptorProto:{fields:{name:{type:"string",id:1},number:{type:"int32",id:2},options:{type:"EnumValueOptions",id:3}}},ServiceDescriptorProto:{fields:{name:{type:"string",id:1},method:{rule:"repeated",type:"MethodDescriptorProto",id:2},options:{type:"ServiceOptions",id:3}}},MethodDescriptorProto:{fields:{name:{type:"string",id:1},inputType:{type:"string",id:2},outputType:{type:"string",id:3},options:{type:"MethodOptions",id:4},clientStreaming:{type:"bool",id:5},serverStreaming:{type:"bool",id:6}}},FileOptions:{fields:{javaPackage:{type:"string",id:1},javaOuterClassname:{type:"string",id:8},javaMultipleFiles:{type:"bool",id:10},javaGenerateEqualsAndHash:{type:"bool",id:20,options:{deprecated:!0}},javaStringCheckUtf8:{type:"bool",id:27},optimizeFor:{type:"OptimizeMode",id:9,options:{default:"SPEED"}},goPackage:{type:"string",id:11},ccGenericServices:{type:"bool",id:16},javaGenericServices:{type:"bool",id:17},pyGenericServices:{type:"bool",id:18},deprecated:{type:"bool",id:23},ccEnableArenas:{type:"bool",id:31},objcClassPrefix:{type:"string",id:36},csharpNamespace:{type:"string",id:37},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]],reserved:[[38,38]],nested:{OptimizeMode:{values:{SPEED:1,CODE_SIZE:2,LITE_RUNTIME:3}}}},MessageOptions:{fields:{messageSetWireFormat:{type:"bool",id:1},noStandardDescriptorAccessor:{type:"bool",id:2},deprecated:{type:"bool",id:3},mapEntry:{type:"bool",id:7},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]],reserved:[[8,8]]},FieldOptions:{fields:{ctype:{type:"CType",id:1,options:{default:"STRING"}},packed:{type:"bool",id:2},jstype:{type:"JSType",id:6,options:{default:"JS_NORMAL"}},lazy:{type:"bool",id:5},deprecated:{type:"bool",id:3},weak:{type:"bool",id:10},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]],reserved:[[4,4]],nested:{CType:{values:{STRING:0,CORD:1,STRING_PIECE:2}},JSType:{values:{JS_NORMAL:0,JS_STRING:1,JS_NUMBER:2}}}},OneofOptions:{fields:{uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]]},EnumOptions:{fields:{allowAlias:{type:"bool",id:2},deprecated:{type:"bool",id:3},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]]},EnumValueOptions:{fields:{deprecated:{type:"bool",id:1},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]]},ServiceOptions:{fields:{deprecated:{type:"bool",id:33},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]]},MethodOptions:{fields:{deprecated:{type:"bool",id:33},uninterpretedOption:{rule:"repeated",type:"UninterpretedOption",id:999}},extensions:[[1e3,536870911]]},UninterpretedOption:{fields:{name:{rule:"repeated",type:"NamePart",id:2},identifierValue:{type:"string",id:3},positiveIntValue:{type:"uint64",id:4},negativeIntValue:{type:"int64",id:5},doubleValue:{type:"double",id:6},stringValue:{type:"bytes",id:7},aggregateValue:{type:"string",id:8}},nested:{NamePart:{fields:{namePart:{rule:"required",type:"string",id:1},isExtension:{rule:"required",type:"bool",id:2}}}}},SourceCodeInfo:{fields:{location:{rule:"repeated",type:"Location",id:1}},nested:{Location:{fields:{path:{rule:"repeated",type:"int32",id:1},span:{rule:"repeated",type:"int32",id:2},leadingComments:{type:"string",id:3},trailingComments:{type:"string",id:4},leadingDetachedComments:{rule:"repeated",type:"string",id:6}}}}},GeneratedCodeInfo:{fields:{annotation:{rule:"repeated",type:"Annotation",id:1}},nested:{Annotation:{fields:{path:{rule:"repeated",type:"int32",id:1},sourceFile:{type:"string",id:2},begin:{type:"int32",id:3},end:{type:"int32",id:4}}}}},Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}},Empty:{fields:{}},DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}},Any:{fields:{typeUrl:{type:"string",id:1},value:{type:"bytes",id:2}}}}},firestore:{nested:{v1:{options:{csharp_namespace:"Google.Cloud.Firestore.V1",go_package:"google.golang.org/genproto/googleapis/firestore/v1;firestore",java_multiple_files:!0,java_outer_classname:"WriteProto",java_package:"com.google.firestore.v1",objc_class_prefix:"GCFS",php_namespace:"Google\\Cloud\\Firestore\\V1",ruby_package:"Google::Cloud::Firestore::V1"},nested:{AggregationResult:{fields:{aggregateFields:{keyType:"string",type:"Value",id:2}}},BitSequence:{fields:{bitmap:{type:"bytes",id:1},padding:{type:"int32",id:2}}},BloomFilter:{fields:{bits:{type:"BitSequence",id:1},hashCount:{type:"int32",id:2}}},DocumentMask:{fields:{fieldPaths:{rule:"repeated",type:"string",id:1}}},Precondition:{oneofs:{conditionType:{oneof:["exists","updateTime"]}},fields:{exists:{type:"bool",id:1},updateTime:{type:"google.protobuf.Timestamp",id:2}}},TransactionOptions:{oneofs:{mode:{oneof:["readOnly","readWrite"]}},fields:{readOnly:{type:"ReadOnly",id:2},readWrite:{type:"ReadWrite",id:3}},nested:{ReadWrite:{fields:{retryTransaction:{type:"bytes",id:1}}},ReadOnly:{oneofs:{consistencySelector:{oneof:["readTime"]}},fields:{readTime:{type:"google.protobuf.Timestamp",id:2}}}}},Document:{fields:{name:{type:"string",id:1},fields:{keyType:"string",type:"Value",id:2},createTime:{type:"google.protobuf.Timestamp",id:3},updateTime:{type:"google.protobuf.Timestamp",id:4}}},Value:{oneofs:{valueType:{oneof:["nullValue","booleanValue","integerValue","doubleValue","timestampValue","stringValue","bytesValue","referenceValue","geoPointValue","arrayValue","mapValue"]}},fields:{nullValue:{type:"google.protobuf.NullValue",id:11},booleanValue:{type:"bool",id:1},integerValue:{type:"int64",id:2},doubleValue:{type:"double",id:3},timestampValue:{type:"google.protobuf.Timestamp",id:10},stringValue:{type:"string",id:17},bytesValue:{type:"bytes",id:18},referenceValue:{type:"string",id:5},geoPointValue:{type:"google.type.LatLng",id:8},arrayValue:{type:"ArrayValue",id:9},mapValue:{type:"MapValue",id:6}}},ArrayValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}},MapValue:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Firestore:{options:{"(google.api.default_host)":"firestore.googleapis.com","(google.api.oauth_scopes)":"https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/datastore"},methods:{GetDocument:{requestType:"GetDocumentRequest",responseType:"Document",options:{"(google.api.http).get":"/v1/{name=projects/*/databases/*/documents/*/**}"},parsedOptions:[{"(google.api.http)":{get:"/v1/{name=projects/*/databases/*/documents/*/**}"}}]},ListDocuments:{requestType:"ListDocumentsRequest",responseType:"ListDocumentsResponse",options:{"(google.api.http).get":"/v1/{parent=projects/*/databases/*/documents/*/**}/{collection_id}"},parsedOptions:[{"(google.api.http)":{get:"/v1/{parent=projects/*/databases/*/documents/*/**}/{collection_id}"}}]},UpdateDocument:{requestType:"UpdateDocumentRequest",responseType:"Document",options:{"(google.api.http).patch":"/v1/{document.name=projects/*/databases/*/documents/*/**}","(google.api.http).body":"document","(google.api.method_signature)":"document,update_mask"},parsedOptions:[{"(google.api.http)":{patch:"/v1/{document.name=projects/*/databases/*/documents/*/**}",body:"document"}},{"(google.api.method_signature)":"document,update_mask"}]},DeleteDocument:{requestType:"DeleteDocumentRequest",responseType:"google.protobuf.Empty",options:{"(google.api.http).delete":"/v1/{name=projects/*/databases/*/documents/*/**}","(google.api.method_signature)":"name"},parsedOptions:[{"(google.api.http)":{delete:"/v1/{name=projects/*/databases/*/documents/*/**}"}},{"(google.api.method_signature)":"name"}]},BatchGetDocuments:{requestType:"BatchGetDocumentsRequest",responseType:"BatchGetDocumentsResponse",responseStream:!0,options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:batchGet","(google.api.http).body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:batchGet",body:"*"}}]},BeginTransaction:{requestType:"BeginTransactionRequest",responseType:"BeginTransactionResponse",options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:beginTransaction","(google.api.http).body":"*","(google.api.method_signature)":"database"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:beginTransaction",body:"*"}},{"(google.api.method_signature)":"database"}]},Commit:{requestType:"CommitRequest",responseType:"CommitResponse",options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:commit","(google.api.http).body":"*","(google.api.method_signature)":"database,writes"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:commit",body:"*"}},{"(google.api.method_signature)":"database,writes"}]},Rollback:{requestType:"RollbackRequest",responseType:"google.protobuf.Empty",options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:rollback","(google.api.http).body":"*","(google.api.method_signature)":"database,transaction"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:rollback",body:"*"}},{"(google.api.method_signature)":"database,transaction"}]},RunQuery:{requestType:"RunQueryRequest",responseType:"RunQueryResponse",responseStream:!0,options:{"(google.api.http).post":"/v1/{parent=projects/*/databases/*/documents}:runQuery","(google.api.http).body":"*","(google.api.http).additional_bindings.post":"/v1/{parent=projects/*/databases/*/documents/*/**}:runQuery","(google.api.http).additional_bindings.body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{parent=projects/*/databases/*/documents}:runQuery",body:"*",additional_bindings:{post:"/v1/{parent=projects/*/databases/*/documents/*/**}:runQuery",body:"*"}}}]},RunAggregationQuery:{requestType:"RunAggregationQueryRequest",responseType:"RunAggregationQueryResponse",responseStream:!0,options:{"(google.api.http).post":"/v1/{parent=projects/*/databases/*/documents}:runAggregationQuery","(google.api.http).body":"*","(google.api.http).additional_bindings.post":"/v1/{parent=projects/*/databases/*/documents/*/**}:runAggregationQuery","(google.api.http).additional_bindings.body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{parent=projects/*/databases/*/documents}:runAggregationQuery",body:"*",additional_bindings:{post:"/v1/{parent=projects/*/databases/*/documents/*/**}:runAggregationQuery",body:"*"}}}]},PartitionQuery:{requestType:"PartitionQueryRequest",responseType:"PartitionQueryResponse",options:{"(google.api.http).post":"/v1/{parent=projects/*/databases/*/documents}:partitionQuery","(google.api.http).body":"*","(google.api.http).additional_bindings.post":"/v1/{parent=projects/*/databases/*/documents/*/**}:partitionQuery","(google.api.http).additional_bindings.body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{parent=projects/*/databases/*/documents}:partitionQuery",body:"*",additional_bindings:{post:"/v1/{parent=projects/*/databases/*/documents/*/**}:partitionQuery",body:"*"}}}]},Write:{requestType:"WriteRequest",requestStream:!0,responseType:"WriteResponse",responseStream:!0,options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:write","(google.api.http).body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:write",body:"*"}}]},Listen:{requestType:"ListenRequest",requestStream:!0,responseType:"ListenResponse",responseStream:!0,options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:listen","(google.api.http).body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:listen",body:"*"}}]},ListCollectionIds:{requestType:"ListCollectionIdsRequest",responseType:"ListCollectionIdsResponse",options:{"(google.api.http).post":"/v1/{parent=projects/*/databases/*/documents}:listCollectionIds","(google.api.http).body":"*","(google.api.http).additional_bindings.post":"/v1/{parent=projects/*/databases/*/documents/*/**}:listCollectionIds","(google.api.http).additional_bindings.body":"*","(google.api.method_signature)":"parent"},parsedOptions:[{"(google.api.http)":{post:"/v1/{parent=projects/*/databases/*/documents}:listCollectionIds",body:"*",additional_bindings:{post:"/v1/{parent=projects/*/databases/*/documents/*/**}:listCollectionIds",body:"*"}}},{"(google.api.method_signature)":"parent"}]},BatchWrite:{requestType:"BatchWriteRequest",responseType:"BatchWriteResponse",options:{"(google.api.http).post":"/v1/{database=projects/*/databases/*}/documents:batchWrite","(google.api.http).body":"*"},parsedOptions:[{"(google.api.http)":{post:"/v1/{database=projects/*/databases/*}/documents:batchWrite",body:"*"}}]},CreateDocument:{requestType:"CreateDocumentRequest",responseType:"Document",options:{"(google.api.http).post":"/v1/{parent=projects/*/databases/*/documents/**}/{collection_id}","(google.api.http).body":"document"},parsedOptions:[{"(google.api.http)":{post:"/v1/{parent=projects/*/databases/*/documents/**}/{collection_id}",body:"document"}}]}}},GetDocumentRequest:{oneofs:{consistencySelector:{oneof:["transaction","readTime"]}},fields:{name:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},mask:{type:"DocumentMask",id:2},transaction:{type:"bytes",id:3},readTime:{type:"google.protobuf.Timestamp",id:5}}},ListDocumentsRequest:{oneofs:{consistencySelector:{oneof:["transaction","readTime"]}},fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},collectionId:{type:"string",id:2,options:{"(google.api.field_behavior)":"REQUIRED"}},pageSize:{type:"int32",id:3},pageToken:{type:"string",id:4},orderBy:{type:"string",id:6},mask:{type:"DocumentMask",id:7},transaction:{type:"bytes",id:8},readTime:{type:"google.protobuf.Timestamp",id:10},showMissing:{type:"bool",id:12}}},ListDocumentsResponse:{fields:{documents:{rule:"repeated",type:"Document",id:1},nextPageToken:{type:"string",id:2}}},CreateDocumentRequest:{fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},collectionId:{type:"string",id:2,options:{"(google.api.field_behavior)":"REQUIRED"}},documentId:{type:"string",id:3},document:{type:"Document",id:4,options:{"(google.api.field_behavior)":"REQUIRED"}},mask:{type:"DocumentMask",id:5}}},UpdateDocumentRequest:{fields:{document:{type:"Document",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},updateMask:{type:"DocumentMask",id:2},mask:{type:"DocumentMask",id:3},currentDocument:{type:"Precondition",id:4}}},DeleteDocumentRequest:{fields:{name:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},currentDocument:{type:"Precondition",id:2}}},BatchGetDocumentsRequest:{oneofs:{consistencySelector:{oneof:["transaction","newTransaction","readTime"]}},fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},documents:{rule:"repeated",type:"string",id:2},mask:{type:"DocumentMask",id:3},transaction:{type:"bytes",id:4},newTransaction:{type:"TransactionOptions",id:5},readTime:{type:"google.protobuf.Timestamp",id:7}}},BatchGetDocumentsResponse:{oneofs:{result:{oneof:["found","missing"]}},fields:{found:{type:"Document",id:1},missing:{type:"string",id:2},transaction:{type:"bytes",id:3},readTime:{type:"google.protobuf.Timestamp",id:4}}},BeginTransactionRequest:{fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},options:{type:"TransactionOptions",id:2}}},BeginTransactionResponse:{fields:{transaction:{type:"bytes",id:1}}},CommitRequest:{fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},writes:{rule:"repeated",type:"Write",id:2},transaction:{type:"bytes",id:3}}},CommitResponse:{fields:{writeResults:{rule:"repeated",type:"WriteResult",id:1},commitTime:{type:"google.protobuf.Timestamp",id:2}}},RollbackRequest:{fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},transaction:{type:"bytes",id:2,options:{"(google.api.field_behavior)":"REQUIRED"}}}},RunQueryRequest:{oneofs:{queryType:{oneof:["structuredQuery"]},consistencySelector:{oneof:["transaction","newTransaction","readTime"]}},fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},structuredQuery:{type:"StructuredQuery",id:2},transaction:{type:"bytes",id:5},newTransaction:{type:"TransactionOptions",id:6},readTime:{type:"google.protobuf.Timestamp",id:7}}},RunQueryResponse:{fields:{transaction:{type:"bytes",id:2},document:{type:"Document",id:1},readTime:{type:"google.protobuf.Timestamp",id:3},skippedResults:{type:"int32",id:4}}},RunAggregationQueryRequest:{oneofs:{queryType:{oneof:["structuredAggregationQuery"]},consistencySelector:{oneof:["transaction","newTransaction","readTime"]}},fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},structuredAggregationQuery:{type:"StructuredAggregationQuery",id:2},transaction:{type:"bytes",id:4},newTransaction:{type:"TransactionOptions",id:5},readTime:{type:"google.protobuf.Timestamp",id:6}}},RunAggregationQueryResponse:{fields:{result:{type:"AggregationResult",id:1},transaction:{type:"bytes",id:2},readTime:{type:"google.protobuf.Timestamp",id:3}}},PartitionQueryRequest:{oneofs:{queryType:{oneof:["structuredQuery"]}},fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},structuredQuery:{type:"StructuredQuery",id:2},partitionCount:{type:"int64",id:3},pageToken:{type:"string",id:4},pageSize:{type:"int32",id:5}}},PartitionQueryResponse:{fields:{partitions:{rule:"repeated",type:"Cursor",id:1},nextPageToken:{type:"string",id:2}}},WriteRequest:{fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},streamId:{type:"string",id:2},writes:{rule:"repeated",type:"Write",id:3},streamToken:{type:"bytes",id:4},labels:{keyType:"string",type:"string",id:5}}},WriteResponse:{fields:{streamId:{type:"string",id:1},streamToken:{type:"bytes",id:2},writeResults:{rule:"repeated",type:"WriteResult",id:3},commitTime:{type:"google.protobuf.Timestamp",id:4}}},ListenRequest:{oneofs:{targetChange:{oneof:["addTarget","removeTarget"]}},fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},addTarget:{type:"Target",id:2},removeTarget:{type:"int32",id:3},labels:{keyType:"string",type:"string",id:4}}},ListenResponse:{oneofs:{responseType:{oneof:["targetChange","documentChange","documentDelete","documentRemove","filter"]}},fields:{targetChange:{type:"TargetChange",id:2},documentChange:{type:"DocumentChange",id:3},documentDelete:{type:"DocumentDelete",id:4},documentRemove:{type:"DocumentRemove",id:6},filter:{type:"ExistenceFilter",id:5}}},Target:{oneofs:{targetType:{oneof:["query","documents"]},resumeType:{oneof:["resumeToken","readTime"]}},fields:{query:{type:"QueryTarget",id:2},documents:{type:"DocumentsTarget",id:3},resumeToken:{type:"bytes",id:4},readTime:{type:"google.protobuf.Timestamp",id:11},targetId:{type:"int32",id:5},once:{type:"bool",id:6},expectedCount:{type:"google.protobuf.Int32Value",id:12}},nested:{DocumentsTarget:{fields:{documents:{rule:"repeated",type:"string",id:2}}},QueryTarget:{oneofs:{queryType:{oneof:["structuredQuery"]}},fields:{parent:{type:"string",id:1},structuredQuery:{type:"StructuredQuery",id:2}}}}},TargetChange:{fields:{targetChangeType:{type:"TargetChangeType",id:1},targetIds:{rule:"repeated",type:"int32",id:2},cause:{type:"google.rpc.Status",id:3},resumeToken:{type:"bytes",id:4},readTime:{type:"google.protobuf.Timestamp",id:6}},nested:{TargetChangeType:{values:{NO_CHANGE:0,ADD:1,REMOVE:2,CURRENT:3,RESET:4}}}},ListCollectionIdsRequest:{fields:{parent:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},pageSize:{type:"int32",id:2},pageToken:{type:"string",id:3}}},ListCollectionIdsResponse:{fields:{collectionIds:{rule:"repeated",type:"string",id:1},nextPageToken:{type:"string",id:2}}},BatchWriteRequest:{fields:{database:{type:"string",id:1,options:{"(google.api.field_behavior)":"REQUIRED"}},writes:{rule:"repeated",type:"Write",id:2},labels:{keyType:"string",type:"string",id:3}}},BatchWriteResponse:{fields:{writeResults:{rule:"repeated",type:"WriteResult",id:1},status:{rule:"repeated",type:"google.rpc.Status",id:2}}},StructuredQuery:{fields:{select:{type:"Projection",id:1},from:{rule:"repeated",type:"CollectionSelector",id:2},where:{type:"Filter",id:3},orderBy:{rule:"repeated",type:"Order",id:4},startAt:{type:"Cursor",id:7},endAt:{type:"Cursor",id:8},offset:{type:"int32",id:6},limit:{type:"google.protobuf.Int32Value",id:5}},nested:{CollectionSelector:{fields:{collectionId:{type:"string",id:2},allDescendants:{type:"bool",id:3}}},Filter:{oneofs:{filterType:{oneof:["compositeFilter","fieldFilter","unaryFilter"]}},fields:{compositeFilter:{type:"CompositeFilter",id:1},fieldFilter:{type:"FieldFilter",id:2},unaryFilter:{type:"UnaryFilter",id:3}}},CompositeFilter:{fields:{op:{type:"Operator",id:1},filters:{rule:"repeated",type:"Filter",id:2}},nested:{Operator:{values:{OPERATOR_UNSPECIFIED:0,AND:1,OR:2}}}},FieldFilter:{fields:{field:{type:"FieldReference",id:1},op:{type:"Operator",id:2},value:{type:"Value",id:3}},nested:{Operator:{values:{OPERATOR_UNSPECIFIED:0,LESS_THAN:1,LESS_THAN_OR_EQUAL:2,GREATER_THAN:3,GREATER_THAN_OR_EQUAL:4,EQUAL:5,NOT_EQUAL:6,ARRAY_CONTAINS:7,IN:8,ARRAY_CONTAINS_ANY:9,NOT_IN:10}}}},UnaryFilter:{oneofs:{operandType:{oneof:["field"]}},fields:{op:{type:"Operator",id:1},field:{type:"FieldReference",id:2}},nested:{Operator:{values:{OPERATOR_UNSPECIFIED:0,IS_NAN:2,IS_NULL:3,IS_NOT_NAN:4,IS_NOT_NULL:5}}}},Order:{fields:{field:{type:"FieldReference",id:1},direction:{type:"Direction",id:2}}},FieldReference:{fields:{fieldPath:{type:"string",id:2}}},Projection:{fields:{fields:{rule:"repeated",type:"FieldReference",id:2}}},Direction:{values:{DIRECTION_UNSPECIFIED:0,ASCENDING:1,DESCENDING:2}}}},StructuredAggregationQuery:{oneofs:{queryType:{oneof:["structuredQuery"]}},fields:{structuredQuery:{type:"StructuredQuery",id:1},aggregations:{rule:"repeated",type:"Aggregation",id:3}},nested:{Aggregation:{oneofs:{operator:{oneof:["count","sum","avg"]}},fields:{count:{type:"Count",id:1},sum:{type:"Sum",id:2},avg:{type:"Avg",id:3},alias:{type:"string",id:7}},nested:{Count:{fields:{upTo:{type:"google.protobuf.Int64Value",id:1}}},Sum:{fields:{field:{type:"FieldReference",id:1}}},Avg:{fields:{field:{type:"FieldReference",id:1}}}}}}},Cursor:{fields:{values:{rule:"repeated",type:"Value",id:1},before:{type:"bool",id:2}}},Write:{oneofs:{operation:{oneof:["update","delete","verify","transform"]}},fields:{update:{type:"Document",id:1},delete:{type:"string",id:2},verify:{type:"string",id:5},transform:{type:"DocumentTransform",id:6},updateMask:{type:"DocumentMask",id:3},updateTransforms:{rule:"repeated",type:"DocumentTransform.FieldTransform",id:7},currentDocument:{type:"Precondition",id:4}}},DocumentTransform:{fields:{document:{type:"string",id:1},fieldTransforms:{rule:"repeated",type:"FieldTransform",id:2}},nested:{FieldTransform:{oneofs:{transformType:{oneof:["setToServerValue","increment","maximum","minimum","appendMissingElements","removeAllFromArray"]}},fields:{fieldPath:{type:"string",id:1},setToServerValue:{type:"ServerValue",id:2},increment:{type:"Value",id:3},maximum:{type:"Value",id:4},minimum:{type:"Value",id:5},appendMissingElements:{type:"ArrayValue",id:6},removeAllFromArray:{type:"ArrayValue",id:7}},nested:{ServerValue:{values:{SERVER_VALUE_UNSPECIFIED:0,REQUEST_TIME:1}}}}}},WriteResult:{fields:{updateTime:{type:"google.protobuf.Timestamp",id:1},transformResults:{rule:"repeated",type:"Value",id:2}}},DocumentChange:{fields:{document:{type:"Document",id:1},targetIds:{rule:"repeated",type:"int32",id:5},removedTargetIds:{rule:"repeated",type:"int32",id:6}}},DocumentDelete:{fields:{document:{type:"string",id:1},removedTargetIds:{rule:"repeated",type:"int32",id:6},readTime:{type:"google.protobuf.Timestamp",id:4}}},DocumentRemove:{fields:{document:{type:"string",id:1},removedTargetIds:{rule:"repeated",type:"int32",id:2},readTime:{type:"google.protobuf.Timestamp",id:4}}},ExistenceFilter:{fields:{targetId:{type:"int32",id:1},count:{type:"int32",id:2},unchangedNames:{type:"BloomFilter",id:3}}}}}}},api:{options:{go_package:"google.golang.org/genproto/googleapis/api/annotations;annotations",java_multiple_files:!0,java_outer_classname:"HttpProto",java_package:"com.google.api",objc_class_prefix:"GAPI",cc_enable_arenas:!0},nested:{http:{type:"HttpRule",id:72295728,extend:"google.protobuf.MethodOptions"},Http:{fields:{rules:{rule:"repeated",type:"HttpRule",id:1}}},HttpRule:{oneofs:{pattern:{oneof:["get","put","post","delete","patch","custom"]}},fields:{get:{type:"string",id:2},put:{type:"string",id:3},post:{type:"string",id:4},delete:{type:"string",id:5},patch:{type:"string",id:6},custom:{type:"CustomHttpPattern",id:8},selector:{type:"string",id:1},body:{type:"string",id:7},additionalBindings:{rule:"repeated",type:"HttpRule",id:11}}},CustomHttpPattern:{fields:{kind:{type:"string",id:1},path:{type:"string",id:2}}},methodSignature:{rule:"repeated",type:"string",id:1051,extend:"google.protobuf.MethodOptions"},defaultHost:{type:"string",id:1049,extend:"google.protobuf.ServiceOptions"},oauthScopes:{type:"string",id:1050,extend:"google.protobuf.ServiceOptions"},fieldBehavior:{rule:"repeated",type:"google.api.FieldBehavior",id:1052,extend:"google.protobuf.FieldOptions"},FieldBehavior:{values:{FIELD_BEHAVIOR_UNSPECIFIED:0,OPTIONAL:1,REQUIRED:2,OUTPUT_ONLY:3,INPUT_ONLY:4,IMMUTABLE:5,UNORDERED_LIST:6,NON_EMPTY_DEFAULT:7}}}},type:{options:{cc_enable_arenas:!0,go_package:"google.golang.org/genproto/googleapis/type/latlng;latlng",java_multiple_files:!0,java_outer_classname:"LatLngProto",java_package:"com.google.type",objc_class_prefix:"GTP"},nested:{LatLng:{fields:{latitude:{type:"double",id:1},longitude:{type:"double",id:2}}}}},rpc:{options:{cc_enable_arenas:!0,go_package:"google.golang.org/genproto/googleapis/rpc/status;status",java_multiple_files:!0,java_outer_classname:"StatusProto",java_package:"com.google.rpc",objc_class_prefix:"RPC"},nested:{Status:{fields:{code:{type:"int32",id:1},message:{type:"string",id:2},details:{rule:"repeated",type:"google.protobuf.Any",id:3}}}}}}}};var r1={nested:r0},r2=Object.freeze({__proto__:null,nested:r0,default:r1});/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let r3={longs:String,enums:String,defaults:!0,oneofs:!1};function loadProtos(){let S=Z.im(r2,r3);return X.Rz(S)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function newConnection(S){let T=loadProtos();return new GrpcConnection(T,S)}function newConnectivityMonitor(){return new NoopConnectivityMonitor}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getWindow(){return"YES"===process.env.USE_MOCK_PERSISTENCE?window:null}function getDocument(){return null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function newSerializer(S){return new JsonProtoSerializer(S,!1)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let r6="ExponentialBackoff",r4=1e3,r9=1.5,r5=6e4;let ExponentialBackoff=class ExponentialBackoff{constructor(S,T,R=r4,P=r9,O=r5){this.queue=S,this.timerId=T,this.initialDelayMs=R,this.backoffFactor=P,this.maxDelayMs=O,this.currentBaseMs=0,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}reset(){this.currentBaseMs=0}resetToMax(){this.currentBaseMs=this.maxDelayMs}backoffAndRun(S){this.cancel();let T=Math.floor(this.currentBaseMs+this.jitterDelayMs()),R=Math.max(0,Date.now()-this.lastAttemptTime),P=Math.max(0,T-R);P>0&&logDebug(r6,`Backing off for ${P} ms (base delay: ${this.currentBaseMs} ms, delay with jitter: ${T} ms, last attempt: ${R} ms ago)`),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,P,()=>(this.lastAttemptTime=Date.now(),S())),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)}skipBackoff(){null!==this.timerPromise&&(this.timerPromise.skipDelay(),this.timerPromise=null)}cancel(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)}jitterDelayMs(){return(Math.random()-.5)*this.currentBaseMs}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let r8="PersistentStream",r7=6e4,ne=1e4;let PersistentStream=class PersistentStream{constructor(S,T,R,P,O,N,M,L){this.queue=S,this.idleTimerId=R,this.healthTimerId=P,this.connection=O,this.authCredentialsProvider=N,this.appCheckCredentialsProvider=M,this.listener=L,this.state=0,this.closeCount=0,this.idleTimer=null,this.healthCheck=null,this.stream=null,this.responseCount=0,this.backoff=new ExponentialBackoff(S,T)}isStarted(){return 1===this.state||5===this.state||this.isOpen()}isOpen(){return 2===this.state||3===this.state}start(){if(this.responseCount=0,4===this.state){this.performBackoff();return}this.auth()}async stop(){this.isStarted()&&await this.close(0)}inhibitBackoff(){this.state=0,this.backoff.reset()}markIdle(){this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,r7,()=>this.handleIdleCloseTimer()))}sendRequest(S){this.cancelIdleCheck(),this.stream.send(S)}async handleIdleCloseTimer(){if(this.isOpen())return this.close(0)}cancelIdleCheck(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)}cancelHealthCheck(){this.healthCheck&&(this.healthCheck.cancel(),this.healthCheck=null)}async close(S,T){this.cancelIdleCheck(),this.cancelHealthCheck(),this.backoff.cancel(),this.closeCount++,4!==S?this.backoff.reset():T&&T.code===es.RESOURCE_EXHAUSTED?(logError(T.toString()),logError("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):T&&T.code===es.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=S,await this.listener.onClose(T)}tearDown(){}auth(){this.state=1;let S=this.getCloseGuardedDispatcher(this.closeCount),T=this.closeCount;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([S,R])=>{this.closeCount===T&&this.startStream(S,R)},T=>{S(()=>{let S=new FirestoreError(es.UNKNOWN,"Fetching auth token failed: "+T.message);return this.handleStreamClose(S)})})}startStream(S,T){let R=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(S,T),this.stream.onConnected(()=>{R(()=>this.listener.onConnected())}),this.stream.onOpen(()=>{R(()=>(this.state=2,this.healthCheck=this.queue.enqueueAfterDelay(this.healthTimerId,ne,()=>(this.isOpen()&&(this.state=3),Promise.resolve())),this.listener.onOpen()))}),this.stream.onClose(S=>{R(()=>this.handleStreamClose(S))}),this.stream.onMessage(S=>{R(()=>1==++this.responseCount?this.onFirst(S):this.onNext(S))})}performBackoff(){this.state=5,this.backoff.backoffAndRun(async()=>{this.state=0,this.start()})}handleStreamClose(S){return logDebug(r8,`close with error: ${S}`),this.stream=null,this.close(4,S)}getCloseGuardedDispatcher(S){return T=>{this.queue.enqueueAndForget(()=>this.closeCount===S?T():(logDebug(r8,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}};let PersistentListenStream=class PersistentListenStream extends PersistentStream{constructor(S,T,R,P,O,N){super(S,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",T,R,P,N),this.serializer=O}startRpc(S,T){return this.connection.openStream("Listen",S,T)}onFirst(S){return this.onNext(S)}onNext(S){this.backoff.reset();let T=fromWatchChange(this.serializer,S),R=versionFromListenResponse(S);return this.listener.onWatchChange(T,R)}watch(S){let T={};T.database=getEncodedDatabaseId(this.serializer),T.addTarget=toTarget(this.serializer,S);let R=toListenRequestLabels(this.serializer,S);R&&(T.labels=R),this.sendRequest(T)}unwatch(S){let T={};T.database=getEncodedDatabaseId(this.serializer),T.removeTarget=S,this.sendRequest(T)}};let PersistentWriteStream=class PersistentWriteStream extends PersistentStream{constructor(S,T,R,P,O,N){super(S,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",T,R,P,N),this.serializer=O}get handshakeComplete(){return this.responseCount>0}start(){this.lastStreamToken=void 0,super.start()}tearDown(){this.handshakeComplete&&this.writeMutations([])}startRpc(S,T){return this.connection.openStream("Write",S,T)}onFirst(S){return hardAssert(!!S.streamToken),this.lastStreamToken=S.streamToken,hardAssert(!S.writeResults||0===S.writeResults.length),this.listener.onHandshakeComplete()}onNext(S){hardAssert(!!S.streamToken),this.lastStreamToken=S.streamToken,this.backoff.reset();let T=fromWriteResults(S.writeResults,S.commitTime),R=fromVersion(S.commitTime);return this.listener.onMutationResult(R,T)}writeHandshake(){let S={};S.database=getEncodedDatabaseId(this.serializer),this.sendRequest(S)}writeMutations(S){let T={streamToken:this.lastStreamToken,writes:S.map(S=>toMutation(this.serializer,S))};this.sendRequest(T)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Datastore=class Datastore{};let DatastoreImpl=class DatastoreImpl extends Datastore{constructor(S,T,R,P){super(),this.authCredentials=S,this.appCheckCredentials=T,this.connection=R,this.serializer=P,this.terminated=!1}verifyInitialized(){if(this.terminated)throw new FirestoreError(es.FAILED_PRECONDITION,"The client has already been terminated.")}invokeRPC(S,T,R,P){return this.verifyInitialized(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([O,N])=>this.connection.invokeRPC(S,toResourcePath(T,R),P,O,N)).catch(S=>{if("FirebaseError"===S.name)throw S.code===es.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),S;throw new FirestoreError(es.UNKNOWN,S.toString())})}invokeStreamingRPC(S,T,R,P,O){return this.verifyInitialized(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([N,M])=>this.connection.invokeStreamingRPC(S,toResourcePath(T,R),P,N,M,O)).catch(S=>{if("FirebaseError"===S.name)throw S.code===es.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),S;throw new FirestoreError(es.UNKNOWN,S.toString())})}terminate(){this.terminated=!0,this.connection.terminate()}};function newDatastore(S,T,R,P){return new DatastoreImpl(S,T,R,P)}async function invokeCommitRpc(S,T){let R=debugCast(S),P={writes:T.map(S=>toMutation(R.serializer,S))};await R.invokeRPC("Commit",R.serializer.databaseId,ResourcePath.emptyPath(),P)}async function invokeBatchGetDocumentsRpc(S,T){let R=debugCast(S),P={documents:T.map(S=>toName(R.serializer,S))},O=await R.invokeStreamingRPC("BatchGetDocuments",R.serializer.databaseId,ResourcePath.emptyPath(),P,T.length),N=new Map;O.forEach(S=>{let T=fromBatchGetDocumentsResponse(R.serializer,S);N.set(T.key.toString(),T)});let M=[];return T.forEach(S=>{let T=N.get(S.toString());hardAssert(!!T),M.push(T)}),M}async function invokeRunAggregationQueryRpc(S,T,R){var P;let O=debugCast(S),{request:N,aliasMap:M,parent:L}=toRunAggregationQueryRequest(O.serializer,queryToAggregateTarget(T),R);O.connection.shouldResourcePathBeIncludedInRequest||delete N.parent;let V=await O.invokeStreamingRPC("RunAggregationQuery",O.serializer.databaseId,L,N,1),U=V.filter(S=>!!S.result);hardAssert(1===U.length);let W=null===(P=U[0].result)||void 0===P?void 0:P.aggregateFields,K=Object.keys(W).reduce((S,T)=>(S[M[T]]=W[T],S),{});return K}function newPersistentWriteStream(S,T,R){let P=debugCast(S);return P.verifyInitialized(),new PersistentWriteStream(T,P.connection,P.authCredentials,P.appCheckCredentials,P.serializer,R)}function newPersistentWatchStream(S,T,R){let P=debugCast(S);return P.verifyInitialized(),new PersistentListenStream(T,P.connection,P.authCredentials,P.appCheckCredentials,P.serializer,R)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nt="OnlineStateTracker",nn=1,ni=1e4;let OnlineStateTracker=class OnlineStateTracker{constructor(S,T){this.asyncQueue=S,this.onlineStateHandler=T,this.state="Unknown",this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}handleWatchStreamStart(){0===this.watchStreamFailures&&(this.setAndBroadcast("Unknown"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay("online_state_timeout",ni,()=>(this.onlineStateTimer=null,this.logClientOfflineWarningIfNecessary(`Backend didn't respond within ${ni/1e3} seconds.`),this.setAndBroadcast("Offline"),Promise.resolve())))}handleWatchStreamFailure(S){"Online"===this.state?this.setAndBroadcast("Unknown"):(this.watchStreamFailures++,this.watchStreamFailures>=nn&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary(`Connection failed ${nn} times. Most recent error: ${S.toString()}`),this.setAndBroadcast("Offline")))}set(S){this.clearOnlineStateTimer(),this.watchStreamFailures=0,"Online"===S&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(S)}setAndBroadcast(S){S!==this.state&&(this.state=S,this.onlineStateHandler(S))}logClientOfflineWarningIfNecessary(S){let T=`Could not reach Cloud Firestore backend. ${S}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.shouldWarnClientIsOffline?(logError(T),this.shouldWarnClientIsOffline=!1):logDebug(nt,T)}clearOnlineStateTimer(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let na="RemoteStore",no=10;let RemoteStoreImpl=class RemoteStoreImpl{constructor(S,T,R,P,O){this.localStore=S,this.datastore=T,this.asyncQueue=R,this.remoteSyncer={},this.writePipeline=[],this.listenTargets=new Map,this.offlineCauses=new Set,this.onNetworkStatusChange=[],this.connectivityMonitor=O,this.connectivityMonitor.addCallback(S=>{R.enqueueAndForget(async()=>{canUseNetwork(this)&&(logDebug(na,"Restarting streams for network reachability change."),await restartNetwork(this))})}),this.onlineStateTracker=new OnlineStateTracker(R,P)}};function newRemoteStore(S,T,R,P,O){return new RemoteStoreImpl(S,T,R,P,O)}async function enableNetworkInternal(S){if(canUseNetwork(S))for(let T of S.onNetworkStatusChange)await T(!0)}async function disableNetworkInternal(S){for(let T of S.onNetworkStatusChange)await T(!1)}async function remoteStoreShutdown(S){let T=debugCast(S);logDebug(na,"RemoteStore shutting down."),T.offlineCauses.add(5),await disableNetworkInternal(T),T.connectivityMonitor.shutdown(),T.onlineStateTracker.set("Unknown")}function remoteStoreListen(S,T){let R=debugCast(S);!R.listenTargets.has(T.targetId)&&(R.listenTargets.set(T.targetId,T),shouldStartWatchStream(R)?startWatchStream(R):ensureWatchStream(R).isOpen()&&sendWatchRequest(R,T))}function remoteStoreUnlisten(S,T){let R=debugCast(S),P=ensureWatchStream(R);R.listenTargets.delete(T),P.isOpen()&&sendUnwatchRequest(R,T),0===R.listenTargets.size&&(P.isOpen()?P.markIdle():canUseNetwork(R)&&R.onlineStateTracker.set("Unknown"))}function sendWatchRequest(S,T){if(S.watchChangeAggregator.recordPendingTargetRequest(T.targetId),T.resumeToken.approximateByteSize()>0||T.snapshotVersion.compareTo(SnapshotVersion.min())>0){let R=S.remoteSyncer.getRemoteKeysForTarget(T.targetId).size;T=T.withExpectedCount(R)}ensureWatchStream(S).watch(T)}function sendUnwatchRequest(S,T){S.watchChangeAggregator.recordPendingTargetRequest(T),ensureWatchStream(S).unwatch(T)}function startWatchStream(S){S.watchChangeAggregator=new WatchChangeAggregator({getRemoteKeysForTarget:T=>S.remoteSyncer.getRemoteKeysForTarget(T),getTargetDataForTarget:T=>S.listenTargets.get(T)||null,getDatabaseId:()=>S.datastore.serializer.databaseId}),ensureWatchStream(S).start(),S.onlineStateTracker.handleWatchStreamStart()}function shouldStartWatchStream(S){return canUseNetwork(S)&&!ensureWatchStream(S).isStarted()&&S.listenTargets.size>0}function canUseNetwork(S){let T=debugCast(S);return 0===T.offlineCauses.size}function cleanUpWatchStreamState(S){S.watchChangeAggregator=void 0}async function onWatchStreamConnected(S){S.onlineStateTracker.set("Online")}async function onWatchStreamOpen(S){S.listenTargets.forEach((T,R)=>{sendWatchRequest(S,T)})}async function onWatchStreamClose(S,T){cleanUpWatchStreamState(S),shouldStartWatchStream(S)?(S.onlineStateTracker.handleWatchStreamFailure(T),startWatchStream(S)):S.onlineStateTracker.set("Unknown")}async function onWatchStreamChange(S,T,R){if(S.onlineStateTracker.set("Online"),T instanceof WatchTargetChange&&2===T.state&&T.cause){try{await handleTargetError(S,T)}catch(R){logDebug(na,"Failed to remove targets %s: %s ",T.targetIds.join(","),R),await disableNetworkUntilRecovery(S,R)}return}if(T instanceof DocumentWatchChange?S.watchChangeAggregator.handleDocumentChange(T):T instanceof ExistenceFilterChange?S.watchChangeAggregator.handleExistenceFilter(T):S.watchChangeAggregator.handleTargetChange(T),!R.isEqual(SnapshotVersion.min()))try{let T=await localStoreGetLastRemoteSnapshotVersion(S.localStore);R.compareTo(T)>=0&&await raiseWatchSnapshot(S,R)}catch(T){logDebug(na,"Failed to raise snapshot:",T),await disableNetworkUntilRecovery(S,T)}}async function disableNetworkUntilRecovery(S,T,R){if(isIndexedDbTransactionError(T))S.offlineCauses.add(1),await disableNetworkInternal(S),S.onlineStateTracker.set("Offline"),R||(R=()=>localStoreGetLastRemoteSnapshotVersion(S.localStore)),S.asyncQueue.enqueueRetryable(async()=>{logDebug(na,"Retrying IndexedDB access"),await R(),S.offlineCauses.delete(1),await enableNetworkInternal(S)});else throw T}function executeWithRecovery(S,T){return T().catch(R=>disableNetworkUntilRecovery(S,R,T))}function raiseWatchSnapshot(S,T){let R=S.watchChangeAggregator.createRemoteEvent(T);return R.targetChanges.forEach((R,P)=>{if(R.resumeToken.approximateByteSize()>0){let O=S.listenTargets.get(P);O&&S.listenTargets.set(P,O.withResumeToken(R.resumeToken,T))}}),R.targetMismatches.forEach((T,R)=>{let P=S.listenTargets.get(T);if(!P)return;S.listenTargets.set(T,P.withResumeToken(ByteString.EMPTY_BYTE_STRING,P.snapshotVersion)),sendUnwatchRequest(S,T);let O=new TargetData(P.target,T,R,P.sequenceNumber);sendWatchRequest(S,O)}),S.remoteSyncer.applyRemoteEvent(R)}async function handleTargetError(S,T){let R=T.cause;for(let P of T.targetIds)S.listenTargets.has(P)&&(await S.remoteSyncer.rejectListen(P,R),S.listenTargets.delete(P),S.watchChangeAggregator.removeTarget(P))}async function fillWritePipeline(S){let T=debugCast(S),R=ensureWriteStream(T),P=T.writePipeline.length>0?T.writePipeline[T.writePipeline.length-1].batchId:tV;for(;canAddToWritePipeline(T);)try{let S=await localStoreGetNextMutationBatch(T.localStore,P);if(null===S){0===T.writePipeline.length&&R.markIdle();break}P=S.batchId,addToWritePipeline(T,S)}catch(S){await disableNetworkUntilRecovery(T,S)}shouldStartWriteStream(T)&&startWriteStream(T)}function canAddToWritePipeline(S){return canUseNetwork(S)&&S.writePipeline.length<no}function addToWritePipeline(S,T){S.writePipeline.push(T);let R=ensureWriteStream(S);R.isOpen()&&R.handshakeComplete&&R.writeMutations(T.mutations)}function shouldStartWriteStream(S){return canUseNetwork(S)&&!ensureWriteStream(S).isStarted()&&S.writePipeline.length>0}function startWriteStream(S){ensureWriteStream(S).start()}async function onWriteStreamOpen(S){ensureWriteStream(S).writeHandshake()}async function onWriteHandshakeComplete(S){let T=ensureWriteStream(S);for(let R of S.writePipeline)T.writeMutations(R.mutations)}async function onMutationResult(S,T,R){let P=S.writePipeline.shift(),O=MutationBatchResult.from(P,T,R);await executeWithRecovery(S,()=>S.remoteSyncer.applySuccessfulWrite(O)),await fillWritePipeline(S)}async function onWriteStreamClose(S,T){T&&ensureWriteStream(S).handshakeComplete&&await handleWriteError(S,T),shouldStartWriteStream(S)&&startWriteStream(S)}async function handleWriteError(S,T){if(isPermanentWriteError(T.code)){let R=S.writePipeline.shift();ensureWriteStream(S).inhibitBackoff(),await executeWithRecovery(S,()=>S.remoteSyncer.rejectFailedWrite(R.batchId,T)),await fillWritePipeline(S)}}async function restartNetwork(S){let T=debugCast(S);T.offlineCauses.add(4),await disableNetworkInternal(T),T.onlineStateTracker.set("Unknown"),T.offlineCauses.delete(4),await enableNetworkInternal(T)}async function remoteStoreHandleCredentialChange(S,T){let R=debugCast(S);R.asyncQueue.verifyOperationInProgress(),logDebug(na,"RemoteStore received new credentials");let P=canUseNetwork(R);R.offlineCauses.add(3),await disableNetworkInternal(R),P&&R.onlineStateTracker.set("Unknown"),await R.remoteSyncer.handleCredentialChange(T),R.offlineCauses.delete(3),await enableNetworkInternal(R)}async function remoteStoreApplyPrimaryState(S,T){let R=debugCast(S);T?(R.offlineCauses.delete(2),await enableNetworkInternal(R)):T||(R.offlineCauses.add(2),await disableNetworkInternal(R),R.onlineStateTracker.set("Unknown"))}function ensureWatchStream(S){return S.watchStream||(S.watchStream=newPersistentWatchStream(S.datastore,S.asyncQueue,{onConnected:onWatchStreamConnected.bind(null,S),onOpen:onWatchStreamOpen.bind(null,S),onClose:onWatchStreamClose.bind(null,S),onWatchChange:onWatchStreamChange.bind(null,S)}),S.onNetworkStatusChange.push(async T=>{T?(S.watchStream.inhibitBackoff(),shouldStartWatchStream(S)?startWatchStream(S):S.onlineStateTracker.set("Unknown")):(await S.watchStream.stop(),cleanUpWatchStreamState(S))})),S.watchStream}function ensureWriteStream(S){return S.writeStream||(S.writeStream=newPersistentWriteStream(S.datastore,S.asyncQueue,{onConnected:()=>Promise.resolve(),onOpen:onWriteStreamOpen.bind(null,S),onClose:onWriteStreamClose.bind(null,S),onHandshakeComplete:onWriteHandshakeComplete.bind(null,S),onMutationResult:onMutationResult.bind(null,S)}),S.onNetworkStatusChange.push(async T=>{T?(S.writeStream.inhibitBackoff(),await fillWritePipeline(S)):(await S.writeStream.stop(),S.writePipeline.length>0&&(logDebug(na,`Stopping write stream with ${S.writePipeline.length} pending writes`),S.writePipeline=[]))})),S.writeStream}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nu="AsyncQueue";let DelayedOperation=class DelayedOperation{constructor(S,T,R,P,O){this.asyncQueue=S,this.timerId=T,this.targetTimeMs=R,this.op=P,this.removalCallback=O,this.deferred=new Deferred,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(S=>{})}get promise(){return this.deferred.promise}static createAndSchedule(S,T,R,P,O){let N=Date.now()+R,M=new DelayedOperation(S,T,N,P,O);return M.start(R),M}start(S){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),S)}skipDelay(){return this.handleDelayElapsed()}cancel(S){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new FirestoreError(es.CANCELLED,"Operation cancelled"+(S?": "+S:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(S=>this.deferred.resolve(S))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function wrapInUserErrorIfRecoverable(S,T){if(logError(nu,`${T}: ${S}`),isIndexedDbTransactionError(S))return new FirestoreError(es.UNAVAILABLE,`${T}: ${S}`);throw S}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DocumentSet=class DocumentSet{constructor(S){S?this.comparator=(T,R)=>S(T,R)||DocumentKey.comparator(T.key,R.key):this.comparator=(S,T)=>DocumentKey.comparator(S.key,T.key),this.keyedMap=documentMap(),this.sortedSet=new SortedMap(this.comparator)}static emptySet(S){return new DocumentSet(S.comparator)}has(S){return null!=this.keyedMap.get(S)}get(S){return this.keyedMap.get(S)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(S){let T=this.keyedMap.get(S);return T?this.sortedSet.indexOf(T):-1}get size(){return this.sortedSet.size}forEach(S){this.sortedSet.inorderTraversal((T,R)=>(S(T),!1))}add(S){let T=this.delete(S.key);return T.copy(T.keyedMap.insert(S.key,S),T.sortedSet.insert(S,null))}delete(S){let T=this.get(S);return T?this.copy(this.keyedMap.remove(S),this.sortedSet.remove(T)):this}isEqual(S){if(!(S instanceof DocumentSet)||this.size!==S.size)return!1;let T=this.sortedSet.getIterator(),R=S.sortedSet.getIterator();for(;T.hasNext();){let S=T.getNext().key,P=R.getNext().key;if(!S.isEqual(P))return!1}return!0}toString(){let S=[];return(this.forEach(T=>{S.push(T.toString())}),0===S.length)?"DocumentSet ()":"DocumentSet (\n  "+S.join("  \n")+"\n)"}copy(S,T){let R=new DocumentSet;return R.comparator=this.comparator,R.keyedMap=S,R.sortedSet=T,R}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DocumentChangeSet=class DocumentChangeSet{constructor(){this.changeMap=new SortedMap(DocumentKey.comparator)}track(S){let T=S.doc.key,R=this.changeMap.get(T);if(!R){this.changeMap=this.changeMap.insert(T,S);return}0!==S.type&&3===R.type?this.changeMap=this.changeMap.insert(T,S):3===S.type&&1!==R.type?this.changeMap=this.changeMap.insert(T,{type:R.type,doc:S.doc}):2===S.type&&2===R.type?this.changeMap=this.changeMap.insert(T,{type:2,doc:S.doc}):2===S.type&&0===R.type?this.changeMap=this.changeMap.insert(T,{type:0,doc:S.doc}):1===S.type&&0===R.type?this.changeMap=this.changeMap.remove(T):1===S.type&&2===R.type?this.changeMap=this.changeMap.insert(T,{type:1,doc:R.doc}):0===S.type&&1===R.type?this.changeMap=this.changeMap.insert(T,{type:2,doc:S.doc}):fail()}getChanges(){let S=[];return this.changeMap.inorderTraversal((T,R)=>{S.push(R)}),S}};let ViewSnapshot=class ViewSnapshot{constructor(S,T,R,P,O,N,M,L,V){this.query=S,this.docs=T,this.oldDocs=R,this.docChanges=P,this.mutatedKeys=O,this.fromCache=N,this.syncStateChanged=M,this.excludesMetadataChanges=L,this.hasCachedResults=V}static fromInitialDocuments(S,T,R,P,O){let N=[];return T.forEach(S=>{N.push({type:0,doc:S})}),new ViewSnapshot(S,T,DocumentSet.emptySet(T),N,R,P,!0,!1,O)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(S){if(this.fromCache!==S.fromCache||this.hasCachedResults!==S.hasCachedResults||this.syncStateChanged!==S.syncStateChanged||!this.mutatedKeys.isEqual(S.mutatedKeys)||!queryEquals(this.query,S.query)||!this.docs.isEqual(S.docs)||!this.oldDocs.isEqual(S.oldDocs))return!1;let T=this.docChanges,R=S.docChanges;if(T.length!==R.length)return!1;for(let S=0;S<T.length;S++)if(T[S].type!==R[S].type||!T[S].doc.isEqual(R[S].doc))return!1;return!0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let QueryListenersInfo=class QueryListenersInfo{constructor(){this.viewSnap=void 0,this.listeners=[]}hasRemoteListeners(){return this.listeners.some(S=>S.listensToRemoteStore())}};function newEventManager(){return new EventManagerImpl}let EventManagerImpl=class EventManagerImpl{constructor(){this.queries=newQueriesObjectMap(),this.onlineState="Unknown",this.snapshotsInSyncListeners=new Set}terminate(){errorAllTargets(this,new FirestoreError(es.ABORTED,"Firestore shutting down"))}};function newQueriesObjectMap(){return new ObjectMap(S=>canonifyQuery(S),queryEquals)}async function eventManagerListen(S,T){let R=debugCast(S),P=3,O=T.query,N=R.queries.get(O);N?!N.hasRemoteListeners()&&T.listensToRemoteStore()&&(P=2):(N=new QueryListenersInfo,P=T.listensToRemoteStore()?0:1);try{switch(P){case 0:N.viewSnap=await R.onListen(O,!0);break;case 1:N.viewSnap=await R.onListen(O,!1);break;case 2:await R.onFirstRemoteStoreListen(O)}}catch(R){let S=wrapInUserErrorIfRecoverable(R,`Initialization of query '${stringifyQuery(T.query)}' failed`);T.onError(S);return}if(R.queries.set(O,N),N.listeners.push(T),T.applyOnlineStateChange(R.onlineState),N.viewSnap){let S=T.onViewSnapshot(N.viewSnap);S&&raiseSnapshotsInSyncEvent(R)}}async function eventManagerUnlisten(S,T){let R=debugCast(S),P=T.query,O=3,N=R.queries.get(P);if(N){let S=N.listeners.indexOf(T);S>=0&&(N.listeners.splice(S,1),0===N.listeners.length?O=T.listensToRemoteStore()?0:1:!N.hasRemoteListeners()&&T.listensToRemoteStore()&&(O=2))}switch(O){case 0:return R.queries.delete(P),R.onUnlisten(P,!0);case 1:return R.queries.delete(P),R.onUnlisten(P,!1);case 2:return R.onLastRemoteStoreUnlisten(P);default:return}}function eventManagerOnWatchChange(S,T){let R=debugCast(S),P=!1;for(let S of T){let T=S.query,O=R.queries.get(T);if(O){for(let T of O.listeners)T.onViewSnapshot(S)&&(P=!0);O.viewSnap=S}}P&&raiseSnapshotsInSyncEvent(R)}function eventManagerOnWatchError(S,T,R){let P=debugCast(S),O=P.queries.get(T);if(O)for(let S of O.listeners)S.onError(R);P.queries.delete(T)}function eventManagerOnOnlineStateChange(S,T){let R=debugCast(S);R.onlineState=T;let P=!1;R.queries.forEach((S,R)=>{for(let S of R.listeners)S.applyOnlineStateChange(T)&&(P=!0)}),P&&raiseSnapshotsInSyncEvent(R)}function errorAllTargets(S,T){let R=debugCast(S),P=R.queries;R.queries=newQueriesObjectMap(),P.forEach((S,R)=>{for(let S of R.listeners)S.onError(T)})}function raiseSnapshotsInSyncEvent(S){S.snapshotsInSyncListeners.forEach(S=>{S.next()})}!function(S){S.Default="default",S.Cache="cache"}(M||(M={}));let QueryListener=class QueryListener{constructor(S,T,R){this.query=S,this.queryObserver=T,this.raisedInitialEvent=!1,this.snap=null,this.onlineState="Unknown",this.options=R||{}}onViewSnapshot(S){if(!this.options.includeMetadataChanges){let T=[];for(let R of S.docChanges)3!==R.type&&T.push(R);S=new ViewSnapshot(S.query,S.docs,S.oldDocs,T,S.mutatedKeys,S.fromCache,S.syncStateChanged,!0,S.hasCachedResults)}let T=!1;return this.raisedInitialEvent?this.shouldRaiseEvent(S)&&(this.queryObserver.next(S),T=!0):this.shouldRaiseInitialEvent(S,this.onlineState)&&(this.raiseInitialEvent(S),T=!0),this.snap=S,T}onError(S){this.queryObserver.error(S)}applyOnlineStateChange(S){this.onlineState=S;let T=!1;return this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,S)&&(this.raiseInitialEvent(this.snap),T=!0),T}shouldRaiseInitialEvent(S,T){if(!S.fromCache||!this.listensToRemoteStore())return!0;let R="Offline"!==T;return(!this.options.waitForSyncWhenOnline||!R)&&(!S.docs.isEmpty()||S.hasCachedResults||"Offline"===T)}shouldRaiseEvent(S){if(S.docChanges.length>0)return!0;let T=this.snap&&this.snap.hasPendingWrites!==S.hasPendingWrites;return(!!S.syncStateChanged||!!T)&&!0===this.options.includeMetadataChanges}raiseInitialEvent(S){S=ViewSnapshot.fromInitialDocuments(S.query,S.docs,S.mutatedKeys,S.fromCache,S.hasCachedResults),this.raisedInitialEvent=!0,this.queryObserver.next(S)}listensToRemoteStore(){return this.options.source!==M.Cache}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let LocalViewChanges=class LocalViewChanges{constructor(S,T,R,P){this.targetId=S,this.fromCache=T,this.addedKeys=R,this.removedKeys=P}static fromSnapshot(S,T){let R=documentKeySet(),P=documentKeySet();for(let S of T.docChanges)switch(S.type){case 0:R=R.add(S.doc.key);break;case 1:P=P.add(S.doc.key)}return new LocalViewChanges(S,T.fromCache,R,P)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let BundleConverterImpl=class BundleConverterImpl{constructor(S){this.serializer=S}toDocumentKey(S){return fromName(this.serializer,S)}toMutableDocument(S){return S.metadata.exists?fromDocument(this.serializer,S.document,!1):MutableDocument.newNoDocument(this.toDocumentKey(S.metadata.name),this.toSnapshotVersion(S.metadata.readTime))}toSnapshotVersion(S){return fromVersion(S)}};let BundleLoader=class BundleLoader{constructor(S,T,R){this.bundleMetadata=S,this.localStore=T,this.serializer=R,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=bundleInitialProgress(S)}addSizedElement(S){this.progress.bytesLoaded+=S.byteLength;let T=this.progress.documentsLoaded;if(S.payload.namedQuery)this.queries.push(S.payload.namedQuery);else if(S.payload.documentMetadata){this.documents.push({metadata:S.payload.documentMetadata}),!S.payload.documentMetadata.exists&&++T;let R=ResourcePath.fromString(S.payload.documentMetadata.name);this.collectionGroups.add(R.get(R.length-2))}else S.payload.document&&(this.documents[this.documents.length-1].document=S.payload.document,++T);return T!==this.progress.documentsLoaded?(this.progress.documentsLoaded=T,Object.assign({},this.progress)):null}getQueryDocumentMapping(S){let T=new Map,R=new BundleConverterImpl(this.serializer);for(let P of S)if(P.metadata.queries){let S=R.toDocumentKey(P.metadata.name);for(let R of P.metadata.queries){let P=(T.get(R)||documentKeySet()).add(S);T.set(R,P)}}return T}async complete(){let S=await localStoreApplyBundledDocuments(this.localStore,new BundleConverterImpl(this.serializer),this.documents,this.bundleMetadata.id),T=this.getQueryDocumentMapping(this.documents);for(let S of this.queries)await localStoreSaveNamedQuery(this.localStore,S,T.get(S.name));return this.progress.taskState="Success",{progress:this.progress,changedCollectionGroups:this.collectionGroups,changedDocs:S}}};function bundleInitialProgress(S){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:S.totalDocuments,totalBytes:S.totalBytes}}function bundleSuccessProgress(S){return{taskState:"Success",documentsLoaded:S.totalDocuments,bytesLoaded:S.totalBytes,totalDocuments:S.totalDocuments,totalBytes:S.totalBytes}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let AddedLimboDocument=class AddedLimboDocument{constructor(S){this.key=S}};let RemovedLimboDocument=class RemovedLimboDocument{constructor(S){this.key=S}};let View=class View{constructor(S,T){this.query=S,this._syncedDocuments=T,this.syncState=null,this.hasCachedResults=!1,this.current=!1,this.limboDocuments=documentKeySet(),this.mutatedKeys=documentKeySet(),this.docComparator=newQueryComparator(S),this.documentSet=new DocumentSet(this.docComparator)}get syncedDocuments(){return this._syncedDocuments}computeDocChanges(S,T){let R=T?T.changeSet:new DocumentChangeSet,P=T?T.documentSet:this.documentSet,O=T?T.mutatedKeys:this.mutatedKeys,N=P,M=!1,L="F"===this.query.limitType&&P.size===this.query.limit?P.last():null,V="L"===this.query.limitType&&P.size===this.query.limit?P.first():null;if(S.inorderTraversal((S,T)=>{let U=P.get(S),W=queryMatches(this.query,T)?T:null,K=!!U&&this.mutatedKeys.has(U.key),Q=!!W&&(W.hasLocalMutations||this.mutatedKeys.has(W.key)&&W.hasCommittedMutations),$=!1;if(U&&W){let S=U.data.isEqual(W.data);S?K!==Q&&(R.track({type:3,doc:W}),$=!0):!this.shouldWaitForSyncedDocument(U,W)&&(R.track({type:2,doc:W}),$=!0,(L&&this.docComparator(W,L)>0||V&&0>this.docComparator(W,V))&&(M=!0))}else!U&&W?(R.track({type:0,doc:W}),$=!0):U&&!W&&(R.track({type:1,doc:U}),$=!0,(L||V)&&(M=!0));$&&(W?(N=N.add(W),O=Q?O.add(S):O.delete(S)):(N=N.delete(S),O=O.delete(S)))}),null!==this.query.limit)for(;N.size>this.query.limit;){let S="F"===this.query.limitType?N.last():N.first();N=N.delete(S.key),O=O.delete(S.key),R.track({type:1,doc:S})}return{documentSet:N,changeSet:R,needsRefill:M,mutatedKeys:O}}shouldWaitForSyncedDocument(S,T){return S.hasLocalMutations&&T.hasCommittedMutations&&!T.hasLocalMutations}applyChanges(S,T,R,P){let O=this.documentSet;this.documentSet=S.documentSet,this.mutatedKeys=S.mutatedKeys;let N=S.changeSet.getChanges();N.sort((S,T)=>compareChangeType(S.type,T.type)||this.docComparator(S.doc,T.doc)),this.applyTargetChange(R),P=null!=P&&P;let M=T&&!P?this.updateLimboDocuments():[],L=0===this.limboDocuments.size&&this.current&&!P,V=L?1:0,U=V!==this.syncState;if(this.syncState=V,0===N.length&&!U)return{limboChanges:M};{let T=new ViewSnapshot(this.query,S.documentSet,O,N,S.mutatedKeys,0===V,U,!1,!!R&&R.resumeToken.approximateByteSize()>0);return{snapshot:T,limboChanges:M}}}applyOnlineStateChange(S){return this.current&&"Offline"===S?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new DocumentChangeSet,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}}shouldBeInLimbo(S){return!this._syncedDocuments.has(S)&&!!this.documentSet.has(S)&&!this.documentSet.get(S).hasLocalMutations}applyTargetChange(S){S&&(S.addedDocuments.forEach(S=>this._syncedDocuments=this._syncedDocuments.add(S)),S.modifiedDocuments.forEach(S=>{}),S.removedDocuments.forEach(S=>this._syncedDocuments=this._syncedDocuments.delete(S)),this.current=S.current)}updateLimboDocuments(){if(!this.current)return[];let S=this.limboDocuments;this.limboDocuments=documentKeySet(),this.documentSet.forEach(S=>{this.shouldBeInLimbo(S.key)&&(this.limboDocuments=this.limboDocuments.add(S.key))});let T=[];return S.forEach(S=>{this.limboDocuments.has(S)||T.push(new RemovedLimboDocument(S))}),this.limboDocuments.forEach(R=>{S.has(R)||T.push(new AddedLimboDocument(R))}),T}synchronizeWithPersistedState(S){this._syncedDocuments=S.remoteKeys,this.limboDocuments=documentKeySet();let T=this.computeDocChanges(S.documents);return this.applyChanges(T,!0)}computeInitialSnapshot(){return ViewSnapshot.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,0===this.syncState,this.hasCachedResults)}};function compareChangeType(S,T){let order=S=>{switch(S){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return fail()}};return order(S)-order(T)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nc="SyncEngine";let QueryView=class QueryView{constructor(S,T,R){this.query=S,this.targetId=T,this.view=R}};let LimboResolution=class LimboResolution{constructor(S){this.key=S,this.receivedDocument=!1}};let SyncEngineImpl=class SyncEngineImpl{constructor(S,T,R,P,O,N){this.localStore=S,this.remoteStore=T,this.eventManager=R,this.sharedClientState=P,this.currentUser=O,this.maxConcurrentLimboResolutions=N,this.syncEngineListener={},this.queryViewsByQuery=new ObjectMap(S=>canonifyQuery(S),queryEquals),this.queriesByTarget=new Map,this.enqueuedLimboResolutions=new Set,this.activeLimboTargetsByKey=new SortedMap(DocumentKey.comparator),this.activeLimboResolutionsByTarget=new Map,this.limboDocumentRefs=new ReferenceSet,this.mutationUserCallbacks={},this.pendingWritesCallbacks=new Map,this.limboTargetIdGenerator=TargetIdGenerator.forSyncEngine(),this.onlineState="Unknown",this._isPrimaryClient=void 0}get isPrimaryClient(){return!0===this._isPrimaryClient}};function newSyncEngine(S,T,R,P,O,N,M){let L=new SyncEngineImpl(S,T,R,P,O,N);return M&&(L._isPrimaryClient=!0),L}async function syncEngineListen(S,T,R=!0){let P;let O=ensureWatchCallbacks(S),N=O.queryViewsByQuery.get(T);return N?(O.sharedClientState.addLocalQueryTarget(N.targetId),P=N.view.computeInitialSnapshot()):P=await allocateTargetAndMaybeListen(O,T,R,!0),P}async function triggerRemoteStoreListen(S,T){let R=ensureWatchCallbacks(S);await allocateTargetAndMaybeListen(R,T,!0,!1)}async function allocateTargetAndMaybeListen(S,T,R,P){let O;let N=await localStoreAllocateTarget(S.localStore,queryToTarget(T)),M=N.targetId,L=S.sharedClientState.addLocalQueryTarget(M,R);return P&&(O=await initializeViewAndComputeSnapshot(S,T,M,"current"===L,N.resumeToken)),S.isPrimaryClient&&R&&remoteStoreListen(S.remoteStore,N),O}async function initializeViewAndComputeSnapshot(S,T,R,P,O){S.applyDocChanges=(T,R,P)=>applyDocChanges(S,T,R,P);let N=await localStoreExecuteQuery(S.localStore,T,!0),M=new View(T,N.remoteKeys),L=M.computeDocChanges(N.documents),V=TargetChange.createSynthesizedTargetChangeForCurrentChange(R,P&&"Offline"!==S.onlineState,O),U=M.applyChanges(L,S.isPrimaryClient,V);updateTrackedLimbos(S,R,U.limboChanges);let W=new QueryView(T,R,M);return S.queryViewsByQuery.set(T,W),S.queriesByTarget.has(R)?S.queriesByTarget.get(R).push(T):S.queriesByTarget.set(R,[T]),U.snapshot}async function syncEngineUnlisten(S,T,R){let P=debugCast(S),O=P.queryViewsByQuery.get(T),N=P.queriesByTarget.get(O.targetId);if(N.length>1){P.queriesByTarget.set(O.targetId,N.filter(S=>!queryEquals(S,T))),P.queryViewsByQuery.delete(T);return}if(P.isPrimaryClient){P.sharedClientState.removeLocalQueryTarget(O.targetId);let S=P.sharedClientState.isActiveQueryTarget(O.targetId);S||await localStoreReleaseTarget(P.localStore,O.targetId,!1).then(()=>{P.sharedClientState.clearQueryState(O.targetId),R&&remoteStoreUnlisten(P.remoteStore,O.targetId),removeAndCleanupTarget(P,O.targetId)}).catch(ignoreIfPrimaryLeaseLoss)}else removeAndCleanupTarget(P,O.targetId),await localStoreReleaseTarget(P.localStore,O.targetId,!0)}async function triggerRemoteStoreUnlisten(S,T){let R=debugCast(S),P=R.queryViewsByQuery.get(T),O=R.queriesByTarget.get(P.targetId);R.isPrimaryClient&&1===O.length&&(R.sharedClientState.removeLocalQueryTarget(P.targetId),remoteStoreUnlisten(R.remoteStore,P.targetId))}async function syncEngineWrite(S,T,R){let P=syncEngineEnsureWriteCallbacks(S);try{let S=await localStoreWriteLocally(P.localStore,T);P.sharedClientState.addPendingMutation(S.batchId),addMutationCallback(P,S.batchId,R),await syncEngineEmitNewSnapsAndNotifyLocalStore(P,S.changes),await fillWritePipeline(P.remoteStore)}catch(T){let S=wrapInUserErrorIfRecoverable(T,"Failed to persist write");R.reject(S)}}async function syncEngineApplyRemoteEvent(S,T){let R=debugCast(S);try{let S=await localStoreApplyRemoteEventToLocalCache(R.localStore,T);T.targetChanges.forEach((S,T)=>{let P=R.activeLimboResolutionsByTarget.get(T);P&&(hardAssert(S.addedDocuments.size+S.modifiedDocuments.size+S.removedDocuments.size<=1),S.addedDocuments.size>0?P.receivedDocument=!0:S.modifiedDocuments.size>0?hardAssert(P.receivedDocument):S.removedDocuments.size>0&&(hardAssert(P.receivedDocument),P.receivedDocument=!1))}),await syncEngineEmitNewSnapsAndNotifyLocalStore(R,S,T)}catch(S){await ignoreIfPrimaryLeaseLoss(S)}}function syncEngineApplyOnlineStateChange(S,T,R){let P=debugCast(S);if(P.isPrimaryClient&&0===R||!P.isPrimaryClient&&1===R){let S=[];P.queryViewsByQuery.forEach((R,P)=>{let O=P.view.applyOnlineStateChange(T);O.snapshot&&S.push(O.snapshot)}),eventManagerOnOnlineStateChange(P.eventManager,T),S.length&&P.syncEngineListener.onWatchChange(S),P.onlineState=T,P.isPrimaryClient&&P.sharedClientState.setOnlineState(T)}}async function syncEngineRejectListen(S,T,R){let P=debugCast(S);P.sharedClientState.updateQueryState(T,"rejected",R);let O=P.activeLimboResolutionsByTarget.get(T),N=O&&O.key;if(N){let S=new SortedMap(DocumentKey.comparator);S=S.insert(N,MutableDocument.newNoDocument(N,SnapshotVersion.min()));let R=documentKeySet().add(N),O=new RemoteEvent(SnapshotVersion.min(),new Map,new SortedMap(primitiveComparator),S,R);await syncEngineApplyRemoteEvent(P,O),P.activeLimboTargetsByKey=P.activeLimboTargetsByKey.remove(N),P.activeLimboResolutionsByTarget.delete(T),pumpEnqueuedLimboResolutions(P)}else await localStoreReleaseTarget(P.localStore,T,!1).then(()=>removeAndCleanupTarget(P,T,R)).catch(ignoreIfPrimaryLeaseLoss)}async function syncEngineApplySuccessfulWrite(S,T){let R=debugCast(S),P=T.batch.batchId;try{let S=await localStoreAcknowledgeBatch(R.localStore,T);processUserCallback(R,P,null),triggerPendingWritesCallbacks(R,P),R.sharedClientState.updateMutationState(P,"acknowledged"),await syncEngineEmitNewSnapsAndNotifyLocalStore(R,S)}catch(S){await ignoreIfPrimaryLeaseLoss(S)}}async function syncEngineRejectFailedWrite(S,T,R){let P=debugCast(S);try{let S=await localStoreRejectBatch(P.localStore,T);processUserCallback(P,T,R),triggerPendingWritesCallbacks(P,T),P.sharedClientState.updateMutationState(T,"rejected",R),await syncEngineEmitNewSnapsAndNotifyLocalStore(P,S)}catch(S){await ignoreIfPrimaryLeaseLoss(S)}}function triggerPendingWritesCallbacks(S,T){(S.pendingWritesCallbacks.get(T)||[]).forEach(S=>{S.resolve()}),S.pendingWritesCallbacks.delete(T)}function rejectOutstandingPendingWritesCallbacks(S,T){S.pendingWritesCallbacks.forEach(S=>{S.forEach(S=>{S.reject(new FirestoreError(es.CANCELLED,T))})}),S.pendingWritesCallbacks.clear()}function addMutationCallback(S,T,R){let P=S.mutationUserCallbacks[S.currentUser.toKey()];P||(P=new SortedMap(primitiveComparator)),P=P.insert(T,R),S.mutationUserCallbacks[S.currentUser.toKey()]=P}function processUserCallback(S,T,R){let P=debugCast(S),O=P.mutationUserCallbacks[P.currentUser.toKey()];if(O){let S=O.get(T);S&&(R?S.reject(R):S.resolve(),O=O.remove(T)),P.mutationUserCallbacks[P.currentUser.toKey()]=O}}function removeAndCleanupTarget(S,T,R=null){for(let P of(S.sharedClientState.removeLocalQueryTarget(T),S.queriesByTarget.get(T)))S.queryViewsByQuery.delete(P),R&&S.syncEngineListener.onWatchError(P,R);if(S.queriesByTarget.delete(T),S.isPrimaryClient){let R=S.limboDocumentRefs.removeReferencesForId(T);R.forEach(T=>{let R=S.limboDocumentRefs.containsKey(T);R||removeLimboTarget(S,T)})}}function removeLimboTarget(S,T){S.enqueuedLimboResolutions.delete(T.path.canonicalString());let R=S.activeLimboTargetsByKey.get(T);null!==R&&(remoteStoreUnlisten(S.remoteStore,R),S.activeLimboTargetsByKey=S.activeLimboTargetsByKey.remove(T),S.activeLimboResolutionsByTarget.delete(R),pumpEnqueuedLimboResolutions(S))}function updateTrackedLimbos(S,T,R){for(let P of R)if(P instanceof AddedLimboDocument)S.limboDocumentRefs.addReference(P.key,T),trackLimboChange(S,P);else if(P instanceof RemovedLimboDocument){logDebug(nc,"Document no longer in limbo: "+P.key),S.limboDocumentRefs.removeReference(P.key,T);let R=S.limboDocumentRefs.containsKey(P.key);R||removeLimboTarget(S,P.key)}else fail()}function trackLimboChange(S,T){let R=T.key,P=R.path.canonicalString();S.activeLimboTargetsByKey.get(R)||S.enqueuedLimboResolutions.has(P)||(logDebug(nc,"New document in limbo: "+R),S.enqueuedLimboResolutions.add(P),pumpEnqueuedLimboResolutions(S))}function pumpEnqueuedLimboResolutions(S){for(;S.enqueuedLimboResolutions.size>0&&S.activeLimboTargetsByKey.size<S.maxConcurrentLimboResolutions;){let T=S.enqueuedLimboResolutions.values().next().value;S.enqueuedLimboResolutions.delete(T);let R=new DocumentKey(ResourcePath.fromString(T)),P=S.limboTargetIdGenerator.next();S.activeLimboResolutionsByTarget.set(P,new LimboResolution(R)),S.activeLimboTargetsByKey=S.activeLimboTargetsByKey.insert(R,P),remoteStoreListen(S.remoteStore,new TargetData(queryToTarget(newQueryForPath(R.path)),P,"TargetPurposeLimboResolution",ListenSequence.INVALID))}}async function syncEngineEmitNewSnapsAndNotifyLocalStore(S,T,R){let P=debugCast(S),O=[],N=[],M=[];P.queryViewsByQuery.isEmpty()||(P.queryViewsByQuery.forEach((S,L)=>{M.push(P.applyDocChanges(L,T,R).then(S=>{var T;if((S||R)&&P.isPrimaryClient){let O=S?!S.fromCache:null===(T=null==R?void 0:R.targetChanges.get(L.targetId))||void 0===T?void 0:T.current;P.sharedClientState.updateQueryState(L.targetId,O?"current":"not-current")}if(S){O.push(S);let T=LocalViewChanges.fromSnapshot(L.targetId,S);N.push(T)}}))}),await Promise.all(M),P.syncEngineListener.onWatchChange(O),await localStoreNotifyLocalViewChanges(P.localStore,N))}async function applyDocChanges(S,T,R,P){let O=T.view.computeDocChanges(R);O.needsRefill&&(O=await localStoreExecuteQuery(S.localStore,T.query,!1).then(({documents:S})=>T.view.computeDocChanges(S,O)));let N=P&&P.targetChanges.get(T.targetId),M=P&&null!=P.targetMismatches.get(T.targetId),L=T.view.applyChanges(O,S.isPrimaryClient,N,M);return updateTrackedLimbos(S,T.targetId,L.limboChanges),L.snapshot}async function syncEngineHandleCredentialChange(S,T){let R=debugCast(S),P=!R.currentUser.isEqual(T);if(P){logDebug(nc,"User change. New user:",T.toKey());let S=await localStoreHandleUserChange(R.localStore,T);R.currentUser=T,rejectOutstandingPendingWritesCallbacks(R,"'waitForPendingWrites' promise is rejected due to a user change."),R.sharedClientState.handleUserChange(T,S.removedBatchIds,S.addedBatchIds),await syncEngineEmitNewSnapsAndNotifyLocalStore(R,S.affectedDocuments)}}function syncEngineGetRemoteKeysForTarget(S,T){let R=debugCast(S),P=R.activeLimboResolutionsByTarget.get(T);if(P&&P.receivedDocument)return documentKeySet().add(P.key);{let S=documentKeySet(),P=R.queriesByTarget.get(T);if(!P)return S;for(let T of P){let P=R.queryViewsByQuery.get(T);S=S.unionWith(P.view.syncedDocuments)}return S}}async function synchronizeViewAndComputeSnapshot(S,T){let R=debugCast(S),P=await localStoreExecuteQuery(R.localStore,T.query,!0),O=T.view.synchronizeWithPersistedState(P);return R.isPrimaryClient&&updateTrackedLimbos(R,T.targetId,O.limboChanges),O}async function syncEngineSynchronizeWithChangedDocuments(S,T){let R=debugCast(S);return localStoreGetNewDocumentChanges(R.localStore,T).then(S=>syncEngineEmitNewSnapsAndNotifyLocalStore(R,S))}async function syncEngineApplyBatchState(S,T,R,P){let O=debugCast(S),N=await localStoreLookupMutationDocuments(O.localStore,T);if(null===N){logDebug(nc,"Cannot apply mutation batch with id: "+T);return}"pending"===R?await fillWritePipeline(O.remoteStore):"acknowledged"===R||"rejected"===R?(processUserCallback(O,T,P||null),triggerPendingWritesCallbacks(O,T),localStoreRemoveCachedMutationBatchMetadata(O.localStore,T)):fail(),await syncEngineEmitNewSnapsAndNotifyLocalStore(O,N)}async function syncEngineApplyPrimaryState(S,T){let R=debugCast(S);if(ensureWatchCallbacks(R),syncEngineEnsureWriteCallbacks(R),!0===T&&!0!==R._isPrimaryClient){let S=R.sharedClientState.getAllActiveQueryTargets(),T=await synchronizeQueryViewsAndRaiseSnapshots(R,S.toArray());for(let S of(R._isPrimaryClient=!0,await remoteStoreApplyPrimaryState(R.remoteStore,!0),T))remoteStoreListen(R.remoteStore,S)}else if(!1===T&&!1!==R._isPrimaryClient){let S=[],T=Promise.resolve();R.queriesByTarget.forEach((P,O)=>{R.sharedClientState.isLocalQueryTarget(O)?S.push(O):T=T.then(()=>(removeAndCleanupTarget(R,O),localStoreReleaseTarget(R.localStore,O,!0))),remoteStoreUnlisten(R.remoteStore,O)}),await T,await synchronizeQueryViewsAndRaiseSnapshots(R,S),resetLimboDocuments(R),R._isPrimaryClient=!1,await remoteStoreApplyPrimaryState(R.remoteStore,!1)}}function resetLimboDocuments(S){let T=debugCast(S);T.activeLimboResolutionsByTarget.forEach((S,R)=>{remoteStoreUnlisten(T.remoteStore,R)}),T.limboDocumentRefs.removeAllReferences(),T.activeLimboResolutionsByTarget=new Map,T.activeLimboTargetsByKey=new SortedMap(DocumentKey.comparator)}async function synchronizeQueryViewsAndRaiseSnapshots(S,T,R){let P=debugCast(S),O=[],N=[];for(let S of T){let T;let R=P.queriesByTarget.get(S);if(R&&0!==R.length)for(let S of(T=await localStoreAllocateTarget(P.localStore,queryToTarget(R[0])),R)){let T=P.queryViewsByQuery.get(S),R=await synchronizeViewAndComputeSnapshot(P,T);R.snapshot&&N.push(R.snapshot)}else{let R=await localStoreGetCachedTarget(P.localStore,S);T=await localStoreAllocateTarget(P.localStore,R),await initializeViewAndComputeSnapshot(P,synthesizeTargetToQuery(R),S,!1,T.resumeToken)}O.push(T)}return P.syncEngineListener.onWatchChange(N),O}function synthesizeTargetToQuery(S){return newQuery(S.path,S.collectionGroup,S.orderBy,S.filters,S.limit,"F",S.startAt,S.endAt)}function syncEngineGetActiveClients(S){let T=debugCast(S);return localStoreGetActiveClients(T.localStore)}async function syncEngineApplyTargetState(S,T,R,P){let O=debugCast(S);if(O._isPrimaryClient){logDebug(nc,"Ignoring unexpected query state notification.");return}let N=O.queriesByTarget.get(T);if(N&&N.length>0)switch(R){case"current":case"not-current":{let S=await localStoreGetNewDocumentChanges(O.localStore,queryCollectionGroup(N[0])),P=RemoteEvent.createSynthesizedRemoteEventForCurrentChange(T,"current"===R,ByteString.EMPTY_BYTE_STRING);await syncEngineEmitNewSnapsAndNotifyLocalStore(O,S,P);break}case"rejected":await localStoreReleaseTarget(O.localStore,T,!0),removeAndCleanupTarget(O,T,P);break;default:fail()}}async function syncEngineApplyActiveTargetsChange(S,T,R){let P=ensureWatchCallbacks(S);if(P._isPrimaryClient){for(let S of T){let T=P.queriesByTarget.has(S)&&P.sharedClientState.isActiveQueryTarget(S);if(T){logDebug(nc,"Adding an already active target "+S);continue}let R=await localStoreGetCachedTarget(P.localStore,S),O=await localStoreAllocateTarget(P.localStore,R);await initializeViewAndComputeSnapshot(P,synthesizeTargetToQuery(R),O.targetId,!1,O.resumeToken),remoteStoreListen(P.remoteStore,O)}for(let S of R)P.queriesByTarget.has(S)&&await localStoreReleaseTarget(P.localStore,S,!1).then(()=>{remoteStoreUnlisten(P.remoteStore,S),removeAndCleanupTarget(P,S)}).catch(ignoreIfPrimaryLeaseLoss)}}function ensureWatchCallbacks(S){let T=debugCast(S);return T.remoteStore.remoteSyncer.applyRemoteEvent=syncEngineApplyRemoteEvent.bind(null,T),T.remoteStore.remoteSyncer.getRemoteKeysForTarget=syncEngineGetRemoteKeysForTarget.bind(null,T),T.remoteStore.remoteSyncer.rejectListen=syncEngineRejectListen.bind(null,T),T.syncEngineListener.onWatchChange=eventManagerOnWatchChange.bind(null,T.eventManager),T.syncEngineListener.onWatchError=eventManagerOnWatchError.bind(null,T.eventManager),T}function syncEngineEnsureWriteCallbacks(S){let T=debugCast(S);return T.remoteStore.remoteSyncer.applySuccessfulWrite=syncEngineApplySuccessfulWrite.bind(null,T),T.remoteStore.remoteSyncer.rejectFailedWrite=syncEngineRejectFailedWrite.bind(null,T),T}async function loadBundleImpl(S,T,R){try{let P=await T.getMetadata(),O=await localStoreHasNewerBundle(S.localStore,P);if(O)return await T.close(),R._completeWith(bundleSuccessProgress(P)),Promise.resolve(new Set);R._updateProgress(bundleInitialProgress(P));let N=new BundleLoader(P,S.localStore,T.serializer),M=await T.nextElement();for(;M;){let S=await N.addSizedElement(M);S&&R._updateProgress(S),M=await T.nextElement()}let L=await N.complete();return await syncEngineEmitNewSnapsAndNotifyLocalStore(S,L.changedDocs,void 0),await localStoreSaveBundle(S.localStore,P),R._completeWith(L.progress),Promise.resolve(L.changedCollectionGroups)}catch(S){return logWarn(nc,`Loading bundle failed with ${S}`),R._failWith(S),Promise.resolve(new Set)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let MemoryOfflineComponentProvider=class MemoryOfflineComponentProvider{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(S){this.serializer=newSerializer(S.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(S),this.persistence=this.createPersistence(S),await this.persistence.start(),this.localStore=this.createLocalStore(S),this.gcScheduler=this.createGarbageCollectionScheduler(S,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(S,this.localStore)}createGarbageCollectionScheduler(S,T){return null}createIndexBackfillerScheduler(S,T){return null}createLocalStore(S){return newLocalStore(this.persistence,new QueryEngine,S.initialUser,this.serializer)}createPersistence(S){return new MemoryPersistence(MemoryEagerDelegate.factory,this.serializer)}createSharedClientState(S){return new MemorySharedClientState}async terminate(){var S,T;null===(S=this.gcScheduler)||void 0===S||S.stop(),null===(T=this.indexBackfillerScheduler)||void 0===T||T.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}};MemoryOfflineComponentProvider.provider={build:()=>new MemoryOfflineComponentProvider};let IndexedDbOfflineComponentProvider=class IndexedDbOfflineComponentProvider extends null{constructor(S,T,R){super(),this.onlineComponentProvider=S,this.cacheSizeBytes=T,this.forceOwnership=R,this.kind="persistent",this.synchronizeTabs=!1}async initialize(S){await super.initialize(S),await this.onlineComponentProvider.initialize(this,S),await syncEngineEnsureWriteCallbacks(this.onlineComponentProvider.syncEngine),await fillWritePipeline(this.onlineComponentProvider.remoteStore),await this.persistence.setPrimaryStateListener(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(S){return newLocalStore(this.persistence,new QueryEngine,S.initialUser,this.serializer)}createGarbageCollectionScheduler(S,T){let R=this.persistence.referenceDelegate.garbageCollector;return new LruScheduler(R,S.asyncQueue,T)}createIndexBackfillerScheduler(S,T){let R=new IndexBackfiller(T,this.persistence);return new IndexBackfillerScheduler(S.asyncQueue,R)}createPersistence(S){let T=indexedDbStoragePrefix(S.databaseInfo.databaseId,S.databaseInfo.persistenceKey),R=void 0!==this.cacheSizeBytes?LruParams.withCacheSize(this.cacheSizeBytes):LruParams.DEFAULT;return new IndexedDbPersistence(this.synchronizeTabs,T,S.clientId,R,S.asyncQueue,getWindow(),getDocument(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(S){return new MemorySharedClientState}};let OnlineComponentProvider=class OnlineComponentProvider{async initialize(S,T){this.localStore||(this.localStore=S.localStore,this.sharedClientState=S.sharedClientState,this.datastore=this.createDatastore(T),this.remoteStore=this.createRemoteStore(T),this.eventManager=this.createEventManager(T),this.syncEngine=this.createSyncEngine(T,!S.synchronizeTabs),this.sharedClientState.onlineStateHandler=S=>syncEngineApplyOnlineStateChange(this.syncEngine,S,1),this.remoteStore.remoteSyncer.handleCredentialChange=syncEngineHandleCredentialChange.bind(null,this.syncEngine),await remoteStoreApplyPrimaryState(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(S){return newEventManager()}createDatastore(S){let T=newSerializer(S.databaseInfo.databaseId),R=newConnection(S.databaseInfo);return newDatastore(S.authCredentials,S.appCheckCredentials,R,T)}createRemoteStore(S){return newRemoteStore(this.localStore,this.datastore,S.asyncQueue,S=>syncEngineApplyOnlineStateChange(this.syncEngine,S,0),newConnectivityMonitor())}createSyncEngine(S,T){return newSyncEngine(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,S.initialUser,S.maxConcurrentLimboResolutions,T)}async terminate(){var S,T;await remoteStoreShutdown(this.remoteStore),null===(S=this.datastore)||void 0===S||S.terminate(),null===(T=this.eventManager)||void 0===T||T.terminate()}};OnlineComponentProvider.provider={build:()=>new OnlineComponentProvider};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nd=10240;function toByteStreamReaderHelper(S,T=nd){let R=0,P={async read(){if(R<S.byteLength){let P={value:S.slice(R,R+T),done:!1};return R+=T,P}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()};return P}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function validateNonEmptyArgument(S,T,R){if(!R)throw new FirestoreError(es.INVALID_ARGUMENT,`Function ${S}() cannot be called with an empty ${T}.`)}function validateIsNotUsedTogether(S,T,R,P){if(!0===T&&!0===P)throw new FirestoreError(es.INVALID_ARGUMENT,`${S} and ${R} cannot be used together.`)}function validateDocumentPath(S){if(!DocumentKey.isDocumentKey(S))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${S} has ${S.length}.`)}function validateCollectionPath(S){if(DocumentKey.isDocumentKey(S))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${S} has ${S.length}.`)}function isPlainObject(S){return"object"==typeof S&&null!==S&&(Object.getPrototypeOf(S)===Object.prototype||null===Object.getPrototypeOf(S))}function valueDescription(S){if(void 0===S)return"undefined";if(null===S)return"null";if("string"==typeof S)return S.length>20&&(S=`${S.substring(0,20)}...`),JSON.stringify(S);if("number"==typeof S||"boolean"==typeof S)return""+S;if("object"==typeof S){if(S instanceof Array)return"an array";{let T=tryGetCustomObjectType(S);return T?`a custom ${T} object`:"an object"}}if("function"==typeof S)return"a function";return fail()}function tryGetCustomObjectType(S){return S.constructor?S.constructor.name:null}function cast(S,T){if("_delegate"in S&&(S=S._delegate),!(S instanceof T)){if(T.name===S.constructor.name)throw new FirestoreError(es.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let R=valueDescription(S);throw new FirestoreError(es.INVALID_ARGUMENT,`Expected type '${T.name}', but it was: ${R}`)}}return S}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function toByteStreamReader(S,T){if(!(S instanceof Uint8Array))throw new FirestoreError(es.INVALID_ARGUMENT,`NodePlatform.toByteStreamReader expects source to be Uint8Array, got ${valueDescription(S)}`);return toByteStreamReaderHelper(S,T)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let AsyncObserver=class AsyncObserver{constructor(S){this.observer=S,this.muted=!1}next(S){!this.muted&&this.observer.next&&this.scheduleEvent(this.observer.next,S)}error(S){this.muted||(this.observer.error?this.scheduleEvent(this.observer.error,S):logError("Uncaught Error in snapshot listener:",S.toString()))}mute(){this.muted=!0}scheduleEvent(S,T){setTimeout(()=>{this.muted||S(T)},0)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SizedBundleElement=class SizedBundleElement{constructor(S,T){this.payload=S,this.byteLength=T}isBundleMetadata(){return"metadata"in this.payload}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let BundleReaderImpl=class BundleReaderImpl{constructor(S,T){this.reader=S,this.serializer=T,this.metadata=new Deferred,this.buffer=new Uint8Array,this.textDecoder=newTextDecoder(),this.nextElementImpl().then(S=>{S&&S.isBundleMetadata()?this.metadata.resolve(S.payload.metadata):this.metadata.reject(Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(null==S?void 0:S.payload)}`))},S=>this.metadata.reject(S))}close(){return this.reader.cancel()}async getMetadata(){return this.metadata.promise}async nextElement(){return await this.getMetadata(),this.nextElementImpl()}async nextElementImpl(){let S=await this.readLength();if(null===S)return null;let T=this.textDecoder.decode(S),R=Number(T);isNaN(R)&&this.raiseError(`length string (${T}) is not valid number`);let P=await this.readJsonString(R);return new SizedBundleElement(JSON.parse(P),S.length+R)}indexOfOpenBracket(){return this.buffer.findIndex(S=>123===S)}async readLength(){for(;0>this.indexOfOpenBracket();){let S=await this.pullMoreDataToBuffer();if(S)break}if(0===this.buffer.length)return null;let S=this.indexOfOpenBracket();S<0&&this.raiseError("Reached the end of bundle when a length string is expected.");let T=this.buffer.slice(0,S);return this.buffer=this.buffer.slice(S),T}async readJsonString(S){for(;this.buffer.length<S;){let S=await this.pullMoreDataToBuffer();S&&this.raiseError("Reached the end of bundle when more is expected.")}let T=this.textDecoder.decode(this.buffer.slice(0,S));return this.buffer=this.buffer.slice(S),T}raiseError(S){throw this.reader.cancel(),Error(`Invalid bundle format: ${S}`)}async pullMoreDataToBuffer(){let S=await this.reader.read();if(!S.done){let T=new Uint8Array(this.buffer.length+S.value.length);T.set(this.buffer),T.set(S.value,this.buffer.length),this.buffer=T}return S.done}};function newBundleReader(S,T){return new BundleReaderImpl(S,T)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Transaction$2=class Transaction$2{constructor(S){this.datastore=S,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(S){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new FirestoreError(es.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let T=await invokeBatchGetDocumentsRpc(this.datastore,S);return T.forEach(S=>this.recordVersion(S)),T}set(S,T){this.write(T.toMutation(S,this.precondition(S))),this.writtenDocs.add(S.toString())}update(S,T){try{this.write(T.toMutation(S,this.preconditionForUpdate(S)))}catch(S){this.lastTransactionError=S}this.writtenDocs.add(S.toString())}delete(S){this.write(new DeleteMutation(S,this.precondition(S))),this.writtenDocs.add(S.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let S=this.readVersions;this.mutations.forEach(T=>{S.delete(T.key.toString())}),S.forEach((S,T)=>{let R=DocumentKey.fromPath(T);this.mutations.push(new VerifyMutation(R,this.precondition(R)))}),await invokeCommitRpc(this.datastore,this.mutations),this.committed=!0}recordVersion(S){let T;if(S.isFoundDocument())T=S.version;else if(S.isNoDocument())T=SnapshotVersion.min();else throw fail();let R=this.readVersions.get(S.key.toString());if(R){if(!T.isEqual(R))throw new FirestoreError(es.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(S.key.toString(),T)}precondition(S){let T=this.readVersions.get(S.toString());return this.writtenDocs.has(S.toString())||!T?Precondition.none():T.isEqual(SnapshotVersion.min())?Precondition.exists(!1):Precondition.updateTime(T)}preconditionForUpdate(S){let T=this.readVersions.get(S.toString());if(this.writtenDocs.has(S.toString())||!T)return Precondition.exists(!0);if(T.isEqual(SnapshotVersion.min()))throw new FirestoreError(es.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Precondition.updateTime(T)}write(S){this.ensureCommitNotCalled(),this.mutations.push(S)}ensureCommitNotCalled(){}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nh="FirestoreClient",np=100,nf=11,nm=20,ng=22;let FirestoreClient=class FirestoreClient{constructor(S,T,R,P,O){this.authCredentials=S,this.appCheckCredentials=T,this.asyncQueue=R,this.databaseInfo=P,this.user=User.UNAUTHENTICATED,this.clientId=AutoId.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=O,this.authCredentials.start(R,async S=>{logDebug(nh,"Received user=",S.uid),await this.authCredentialListener(S),this.user=S}),this.appCheckCredentials.start(R,S=>(logDebug(nh,"Received new app check token=",S),this.appCheckCredentialListener(S,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:np}}setCredentialChangeListener(S){this.authCredentialListener=S}setAppCheckTokenChangeListener(S){this.appCheckCredentialListener=S}terminate(){this.asyncQueue.enterRestrictedMode();let S=new Deferred;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),S.resolve()}catch(R){let T=wrapInUserErrorIfRecoverable(R,"Failed to shutdown persistence");S.reject(T)}}),S.promise}};async function setOfflineComponentProvider(S,T){S.asyncQueue.verifyOperationInProgress(),logDebug(nh,"Initializing OfflineComponentProvider");let R=S.configuration;await T.initialize(R);let P=R.initialUser;S.setCredentialChangeListener(async S=>{P.isEqual(S)||(await localStoreHandleUserChange(T.localStore,S),P=S)}),T.persistence.setDatabaseDeletedListener(()=>S.terminate()),S._offlineComponents=T}async function setOnlineComponentProvider(S,T){S.asyncQueue.verifyOperationInProgress();let R=await ensureOfflineComponents(S);logDebug(nh,"Initializing OnlineComponentProvider"),await T.initialize(R,S.configuration),S.setCredentialChangeListener(S=>remoteStoreHandleCredentialChange(T.remoteStore,S)),S.setAppCheckTokenChangeListener((S,R)=>remoteStoreHandleCredentialChange(T.remoteStore,R)),S._onlineComponents=T}function canFallbackFromIndexedDbError(S){return"FirebaseError"===S.name?S.code===es.FAILED_PRECONDITION||S.code===es.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&S instanceof DOMException)||S.code===ng||S.code===nm||S.code===nf}async function ensureOfflineComponents(S){if(!S._offlineComponents){if(S._uninitializedComponentsProvider){logDebug(nh,"Using user provided OfflineComponentProvider");try{await setOfflineComponentProvider(S,S._uninitializedComponentsProvider._offline)}catch(R){let T=R;if(!canFallbackFromIndexedDbError(T))throw T;logWarn("Error using user provided cache. Falling back to memory cache: "+T),await setOfflineComponentProvider(S,new MemoryOfflineComponentProvider)}}else logDebug(nh,"Using default OfflineComponentProvider"),await setOfflineComponentProvider(S,new MemoryOfflineComponentProvider)}return S._offlineComponents}async function ensureOnlineComponents(S){return S._onlineComponents||(S._uninitializedComponentsProvider?(logDebug(nh,"Using user provided OnlineComponentProvider"),await setOnlineComponentProvider(S,S._uninitializedComponentsProvider._online)):(logDebug(nh,"Using default OnlineComponentProvider"),await setOnlineComponentProvider(S,new OnlineComponentProvider))),S._onlineComponents}function getLocalStore(S){return ensureOfflineComponents(S).then(S=>S.localStore)}function getSyncEngine(S){return ensureOnlineComponents(S).then(S=>S.syncEngine)}function getDatastore(S){return ensureOnlineComponents(S).then(S=>S.datastore)}async function getEventManager(S){let T=await ensureOnlineComponents(S),R=T.eventManager;return R.onListen=syncEngineListen.bind(null,T.syncEngine),R.onUnlisten=syncEngineUnlisten.bind(null,T.syncEngine),R.onFirstRemoteStoreListen=triggerRemoteStoreListen.bind(null,T.syncEngine),R.onLastRemoteStoreUnlisten=triggerRemoteStoreUnlisten.bind(null,T.syncEngine),R}function firestoreClientListen(S,T,R,P){let O=new AsyncObserver(P),N=new QueryListener(T,O,R);return S.asyncQueue.enqueueAndForget(async()=>{let T=await getEventManager(S);return eventManagerListen(T,N)}),()=>{O.mute(),S.asyncQueue.enqueueAndForget(async()=>{let T=await getEventManager(S);return eventManagerUnlisten(T,N)})}}function firestoreClientGetDocumentViaSnapshotListener(S,T,R={}){let P=new Deferred;return S.asyncQueue.enqueueAndForget(async()=>{let O=await getEventManager(S);return readDocumentViaSnapshotListener(O,S.asyncQueue,T,R,P)}),P.promise}function firestoreClientGetDocumentsViaSnapshotListener(S,T,R={}){let P=new Deferred;return S.asyncQueue.enqueueAndForget(async()=>{let O=await getEventManager(S);return executeQueryViaSnapshotListener(O,S.asyncQueue,T,R,P)}),P.promise}function firestoreClientWrite(S,T){let R=new Deferred;return S.asyncQueue.enqueueAndForget(async()=>{let P=await getSyncEngine(S);return syncEngineWrite(P,T,R)}),R.promise}function readDocumentViaSnapshotListener(S,T,R,P,O){let N=new AsyncObserver({next:L=>{N.mute(),T.enqueueAndForget(()=>eventManagerUnlisten(S,M));let V=L.docs.has(R);!V&&L.fromCache?O.reject(new FirestoreError(es.UNAVAILABLE,"Failed to get document because the client is offline.")):V&&L.fromCache&&P&&"server"===P.source?O.reject(new FirestoreError(es.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):O.resolve(L)},error:S=>O.reject(S)}),M=new QueryListener(newQueryForPath(R.path),N,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0});return eventManagerListen(S,M)}function executeQueryViaSnapshotListener(S,T,R,P,O){let N=new AsyncObserver({next:R=>{N.mute(),T.enqueueAndForget(()=>eventManagerUnlisten(S,M)),R.fromCache&&"server"===P.source?O.reject(new FirestoreError(es.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):O.resolve(R)},error:S=>O.reject(S)}),M=new QueryListener(R,N,{includeMetadataChanges:!0,waitForSyncWhenOnline:!0});return eventManagerListen(S,M)}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function longPollingOptionsEqual(S,T){return S.timeoutSeconds===T.timeoutSeconds}function cloneLongPollingOptions(S){let T={};return void 0!==S.timeoutSeconds&&(T.timeoutSeconds=S.timeoutSeconds),T}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let ny="ComponentProvider",nv=new Map;function removeComponents(S){let T=nv.get(S);T&&(logDebug(ny,"Removing Datastore"),nv.delete(S),T.terminate())}function makeDatabaseInfo(S,T,R,P){return new DatabaseInfo(S,T,R,P.host,P.ssl,P.experimentalForceLongPolling,P.experimentalAutoDetectLongPolling,cloneLongPollingOptions(P.experimentalLongPollingOptions),P.useFetchStreams)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nS="firestore.googleapis.com",nb=!0,nC=5,nT=30,nE=!0;let FirestoreSettingsImpl=class FirestoreSettingsImpl{constructor(S){var T,R;if(void 0===S.host){if(void 0!==S.ssl)throw new FirestoreError(es.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=nS,this.ssl=nb}else this.host=S.host,this.ssl=null!==(T=S.ssl)&&void 0!==T?T:nb;if(this.credentials=S.credentials,this.ignoreUndefinedProperties=!!S.ignoreUndefinedProperties,this.localCache=S.localCache,void 0===S.cacheSizeBytes)this.cacheSizeBytes=rD;else{if(S.cacheSizeBytes!==rw&&S.cacheSizeBytes<rR)throw new FirestoreError(es.INVALID_ARGUMENT,`cacheSizeBytes must be at least ${rR}`);this.cacheSizeBytes=S.cacheSizeBytes}validateIsNotUsedTogether("experimentalForceLongPolling",S.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",S.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!S.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===S.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=nE:this.experimentalAutoDetectLongPolling=!!S.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=cloneLongPollingOptions(null!==(R=S.experimentalLongPollingOptions)&&void 0!==R?R:{}),validateLongPollingOptions(this.experimentalLongPollingOptions),this.useFetchStreams=!!S.useFetchStreams}isEqual(S){return this.host===S.host&&this.ssl===S.ssl&&this.credentials===S.credentials&&this.cacheSizeBytes===S.cacheSizeBytes&&this.experimentalForceLongPolling===S.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===S.experimentalAutoDetectLongPolling&&longPollingOptionsEqual(this.experimentalLongPollingOptions,S.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===S.ignoreUndefinedProperties&&this.useFetchStreams===S.useFetchStreams}};function validateLongPollingOptions(S){if(void 0!==S.timeoutSeconds){if(isNaN(S.timeoutSeconds))throw new FirestoreError(es.INVALID_ARGUMENT,`invalid long polling timeout: ${S.timeoutSeconds} (must not be NaN)`);if(S.timeoutSeconds<nC)throw new FirestoreError(es.INVALID_ARGUMENT,`invalid long polling timeout: ${S.timeoutSeconds} (minimum allowed value is ${nC})`);if(S.timeoutSeconds>nT)throw new FirestoreError(es.INVALID_ARGUMENT,`invalid long polling timeout: ${S.timeoutSeconds} (maximum allowed value is ${nT})`)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Firestore$1=class Firestore$1{constructor(S,T,R,P){this._authCredentials=S,this._appCheckCredentials=T,this._databaseId=R,this._app=P,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new FirestoreSettingsImpl({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new FirestoreError(es.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(S){if(this._settingsFrozen)throw new FirestoreError(es.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new FirestoreSettingsImpl(S),void 0!==S.credentials&&(this._authCredentials=makeAuthCredentialsProvider(S.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return removeComponents(this),Promise.resolve()}};function connectFirestoreEmulator(S,T,R,P={}){var O;S=cast(S,Firestore$1);let N=S._getSettings(),M=`${T}:${R}`;if(N.host!==nS&&N.host!==M&&logWarn("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),S._setSettings(Object.assign(Object.assign({},N),{host:M,ssl:!1})),P.mockUserToken){let T,R;if("string"==typeof P.mockUserToken)T=P.mockUserToken,R=User.MOCK_USER;else{T=(0,K.Sg)(P.mockUserToken,null===(O=S._app)||void 0===O?void 0:O.options.projectId);let N=P.mockUserToken.sub||P.mockUserToken.user_id;if(!N)throw new FirestoreError(es.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");R=new User(N)}S._authCredentials=new EmulatorAuthCredentialsProvider(new OAuthToken(T,R))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Query=class Query{constructor(S,T,R){this.converter=T,this._query=R,this.type="query",this.firestore=S}withConverter(S){return new Query(this.firestore,S,this._query)}};let DocumentReference=class DocumentReference{constructor(S,T,R){this.converter=T,this._key=R,this.type="document",this.firestore=S}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new CollectionReference(this.firestore,this.converter,this._key.path.popLast())}withConverter(S){return new DocumentReference(this.firestore,S,this._key)}};let CollectionReference=class CollectionReference extends Query{constructor(S,T,R){super(S,T,newQueryForPath(R)),this._path=R,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let S=this._path.popLast();return S.isEmpty()?null:new DocumentReference(this.firestore,null,new DocumentKey(S))}withConverter(S){return new CollectionReference(this.firestore,S,this._path)}};function collection(S,T,...R){if(S=(0,K.m9)(S),validateNonEmptyArgument("collection","path",T),S instanceof Firestore$1){let P=ResourcePath.fromString(T,...R);return validateCollectionPath(P),new CollectionReference(S,null,P)}{if(!(S instanceof DocumentReference)&&!(S instanceof CollectionReference))throw new FirestoreError(es.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let P=S._path.child(ResourcePath.fromString(T,...R));return validateCollectionPath(P),new CollectionReference(S.firestore,null,P)}}function doc(S,T,...R){if(S=(0,K.m9)(S),1==arguments.length&&(T=AutoId.newId()),validateNonEmptyArgument("doc","path",T),S instanceof Firestore$1){let P=ResourcePath.fromString(T,...R);return validateDocumentPath(P),new DocumentReference(S,null,new DocumentKey(P))}{if(!(S instanceof DocumentReference)&&!(S instanceof CollectionReference))throw new FirestoreError(es.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let P=S._path.child(ResourcePath.fromString(T,...R));return validateDocumentPath(P),new DocumentReference(S.firestore,S instanceof CollectionReference?S.converter:null,new DocumentKey(P))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nw="AsyncQueue";let AsyncQueueImpl=class AsyncQueueImpl{constructor(S=Promise.resolve()){this.retryableOps=[],this._isShuttingDown=!1,this.delayedOperations=[],this.failure=null,this.operationInProgress=!1,this.skipNonRestrictedTasks=!1,this.timerIdsToSkip=[],this.backoff=new ExponentialBackoff(this,"async_queue_retry"),this.visibilityHandler=()=>{this.backoff.skipBackoff()},this.tail=S}get isShuttingDown(){return this._isShuttingDown}enqueueAndForget(S){this.enqueue(S)}enqueueAndForgetEvenWhileRestricted(S){this.verifyNotFailed(),this.enqueueInternal(S)}enterRestrictedMode(S){this._isShuttingDown||(this._isShuttingDown=!0,this.skipNonRestrictedTasks=S||!1)}enqueue(S){if(this.verifyNotFailed(),this._isShuttingDown)return new Promise(()=>{});let T=new Deferred;return this.enqueueInternal(()=>this._isShuttingDown&&this.skipNonRestrictedTasks?Promise.resolve():(S().then(T.resolve,T.reject),T.promise)).then(()=>T.promise)}enqueueRetryable(S){this.enqueueAndForget(()=>(this.retryableOps.push(S),this.retryNextOp()))}async retryNextOp(){if(0!==this.retryableOps.length){try{await this.retryableOps[0](),this.retryableOps.shift(),this.backoff.reset()}catch(S){if(isIndexedDbTransactionError(S))logDebug(nw,"Operation failed with retryable error: "+S);else throw S}this.retryableOps.length>0&&this.backoff.backoffAndRun(()=>this.retryNextOp())}}enqueueInternal(S){let T=this.tail.then(()=>(this.operationInProgress=!0,S().catch(S=>{this.failure=S,this.operationInProgress=!1;let T=getMessageOrStack(S);throw logError("INTERNAL UNHANDLED ERROR: ",T),S}).then(S=>(this.operationInProgress=!1,S))));return this.tail=T,T}enqueueAfterDelay(S,T,R){this.verifyNotFailed(),this.timerIdsToSkip.indexOf(S)>-1&&(T=0);let P=DelayedOperation.createAndSchedule(this,S,T,R,S=>this.removeDelayedOperation(S));return this.delayedOperations.push(P),P}verifyNotFailed(){this.failure&&fail()}verifyOperationInProgress(){}async drain(){let S;do S=this.tail,await S;while(S!==this.tail)}containsDelayedOperation(S){for(let T of this.delayedOperations)if(T.timerId===S)return!0;return!1}runAllDelayedOperationsUntil(S){return this.drain().then(()=>{for(let T of(this.delayedOperations.sort((S,T)=>S.targetTimeMs-T.targetTimeMs),this.delayedOperations))if(T.skipDelay(),"all"!==S&&T.timerId===S)break;return this.drain()})}skipDelaysForTimerId(S){this.timerIdsToSkip.push(S)}removeDelayedOperation(S){let T=this.delayedOperations.indexOf(S);this.delayedOperations.splice(T,1)}};function getMessageOrStack(S){let T=S.message||"";return S.stack&&(T=S.stack.includes(S.message)?S.stack:S.message+"\n"+S.stack),T}let Firestore=class Firestore extends Firestore$1{constructor(S,T,R,P){super(S,T,R,P),this.type="firestore",this._queue=new AsyncQueueImpl,this._persistenceKey=(null==P?void 0:P.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let S=this._firestoreClient.terminate();this._queue=new AsyncQueueImpl(S),this._firestoreClient=void 0,await S}}};function getFirestore(S,T){let R="object"==typeof S?S:(0,L.Mq)(),P="string"==typeof S?S:T||tB,O=(0,L.qX)(R,"firestore").getImmediate({identifier:P});if(!O._initialized){let S=(0,K.P0)("firestore");S&&connectFirestoreEmulator(O,...S)}return O}function ensureFirestoreConfigured(S){if(S._terminated)throw new FirestoreError(es.FAILED_PRECONDITION,"The client has already been terminated.");return S._firestoreClient||configureFirestore(S),S._firestoreClient}function configureFirestore(S){var T,R,P;let O=S._freezeSettings(),N=makeDatabaseInfo(S._databaseId,(null===(T=S._app)||void 0===T?void 0:T.options.appId)||"",S._persistenceKey,O);!S._componentsProvider&&(null===(R=O.localCache)||void 0===R?void 0:R._offlineComponentProvider)&&(null===(P=O.localCache)||void 0===P?void 0:P._onlineComponentProvider)&&(S._componentsProvider={_offline:O.localCache._offlineComponentProvider,_online:O.localCache._onlineComponentProvider}),S._firestoreClient=new FirestoreClient(S._authCredentials,S._appCheckCredentials,S._queue,N,S._componentsProvider&&buildComponentProvider(S._componentsProvider))}function buildComponentProvider(S){let T=null==S?void 0:S._online.build();return{_offline:null==S?void 0:S._offline.build(T),_online:T}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function registerFirestore(S,T=!0){setSDKVersion(L.Jn),(0,L.Xd)(new V.wA("firestore",(S,{instanceIdentifier:R,options:P})=>{let O=S.getProvider("app").getImmediate(),N=new Firestore(new FirebaseAuthCredentialsProvider(S.getProvider("auth-internal")),new FirebaseAppCheckTokenProvider(S.getProvider("app-check-internal")),databaseIdFromApp(O,R),O);return P=Object.assign({useFetchStreams:T},P),N._setSettings(P),N},"PUBLIC").setMultipleInstances(!0)),(0,L.KN)(ee,et,S),(0,L.KN)(ee,et,"esm2017")}let AggregateQuerySnapshot=class AggregateQuerySnapshot{constructor(S,T,R){this._userDataWriter=T,this._data=R,this.type="AggregateQuerySnapshot",this.query=S}data(){return this._userDataWriter.convertObjectMap(this._data)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Bytes=class Bytes{constructor(S){this._byteString=S}static fromBase64String(S){try{return new Bytes(ByteString.fromBase64String(S))}catch(S){throw new FirestoreError(es.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+S)}}static fromUint8Array(S){return new Bytes(ByteString.fromUint8Array(S))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(S){return this._byteString.isEqual(S._byteString)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let FieldPath=class FieldPath{constructor(...S){for(let T=0;T<S.length;++T)if(0===S[T].length)throw new FirestoreError(es.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new FieldPath$1(S)}isEqual(S){return this._internalPath.isEqual(S._internalPath)}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let FieldValue=class FieldValue{constructor(S){this._methodName=S}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let GeoPoint=class GeoPoint{constructor(S,T){if(!isFinite(S)||S<-90||S>90)throw new FirestoreError(es.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+S);if(!isFinite(T)||T<-180||T>180)throw new FirestoreError(es.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+T);this._lat=S,this._long=T}get latitude(){return this._lat}get longitude(){return this._long}isEqual(S){return this._lat===S._lat&&this._long===S._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(S){return primitiveComparator(this._lat,S._lat)||primitiveComparator(this._long,S._long)}};/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let VectorValue=class VectorValue{constructor(S){this._values=(S||[]).map(S=>S)}toArray(){return this._values.map(S=>S)}isEqual(S){return isPrimitiveArrayEqual(this._values,S._values)}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let nD=/^__.*__$/;let ParsedSetData=class ParsedSetData{constructor(S,T,R){this.data=S,this.fieldMask=T,this.fieldTransforms=R}toMutation(S,T){return null!==this.fieldMask?new PatchMutation(S,this.data,this.fieldMask,T,this.fieldTransforms):new SetMutation(S,this.data,T,this.fieldTransforms)}};let ParsedUpdateData=class ParsedUpdateData{constructor(S,T,R){this.data=S,this.fieldMask=T,this.fieldTransforms=R}toMutation(S,T){return new PatchMutation(S,this.data,this.fieldMask,T,this.fieldTransforms)}};function isWrite(S){switch(S){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw fail()}}let ParseContextImpl=class ParseContextImpl{constructor(S,T,R,P,O,N){this.settings=S,this.databaseId=T,this.serializer=R,this.ignoreUndefinedProperties=P,void 0===O&&this.validatePath(),this.fieldTransforms=O||[],this.fieldMask=N||[]}get path(){return this.settings.path}get dataSource(){return this.settings.dataSource}contextWith(S){return new ParseContextImpl(Object.assign(Object.assign({},this.settings),S),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}childContextForField(S){var T;let R=null===(T=this.path)||void 0===T?void 0:T.child(S),P=this.contextWith({path:R,arrayElement:!1});return P.validatePathSegment(S),P}childContextForFieldPath(S){var T;let R=null===(T=this.path)||void 0===T?void 0:T.child(S),P=this.contextWith({path:R,arrayElement:!1});return P.validatePath(),P}childContextForArray(S){return this.contextWith({path:void 0,arrayElement:!0})}createError(S){return createError(S,this.settings.methodName,this.settings.hasConverter||!1,this.path,this.settings.targetDoc)}contains(S){return void 0!==this.fieldMask.find(T=>S.isPrefixOf(T))||void 0!==this.fieldTransforms.find(T=>S.isPrefixOf(T.field))}validatePath(){if(this.path)for(let S=0;S<this.path.length;S++)this.validatePathSegment(this.path.get(S))}validatePathSegment(S){if(0===S.length)throw this.createError("Document fields must not be empty");if(isWrite(this.dataSource)&&nD.test(S))throw this.createError('Document fields cannot begin and end with "__"')}};let UserDataReader=class UserDataReader{constructor(S,T,R){this.databaseId=S,this.ignoreUndefinedProperties=T,this.serializer=R||newSerializer(S)}createContext(S,T,R,P=!1){return new ParseContextImpl({dataSource:S,methodName:T,targetDoc:R,path:FieldPath$1.emptyPath(),arrayElement:!1,hasConverter:P},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function newUserDataReader(S){let T=S._freezeSettings(),R=newSerializer(S._databaseId);return new UserDataReader(S._databaseId,!!T.ignoreUndefinedProperties,R)}function parseSetData(S,T,R,P,O,N={}){let M,L;let V=S.createContext(N.merge||N.mergeFields?2:0,T,R,O);validatePlainObject("Data must be an object, but it was:",V,P);let U=parseObject(P,V);if(N.merge)M=new FieldMask(V.fieldMask),L=V.fieldTransforms;else if(N.mergeFields){let S=[];for(let P of N.mergeFields){let O=fieldPathFromArgument$1(T,P,R);if(!V.contains(O))throw new FirestoreError(es.INVALID_ARGUMENT,`Field '${O}' is specified in your field mask but missing from your input data.`);fieldMaskContains(S,O)||S.push(O)}M=new FieldMask(S),L=V.fieldTransforms.filter(S=>M.covers(S.field))}else M=null,L=V.fieldTransforms;return new ParsedSetData(new ObjectValue(U),M,L)}let DeleteFieldValueImpl=class DeleteFieldValueImpl extends FieldValue{_toFieldTransform(S){if(2===S.dataSource)S.fieldMask.push(S.path);else if(1===S.dataSource)throw S.createError(`${this._methodName}() can only appear at the top level of your update data`);else throw S.createError(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return null}isEqual(S){return S instanceof DeleteFieldValueImpl}};function createSentinelChildContext(S,T,R){return new ParseContextImpl({dataSource:3,targetDoc:T.settings.targetDoc,methodName:S._methodName,arrayElement:R},T.databaseId,T.serializer,T.ignoreUndefinedProperties)}let ServerTimestampFieldValueImpl=class ServerTimestampFieldValueImpl extends FieldValue{_toFieldTransform(S){return new FieldTransform(S.path,new ServerTimestampTransform)}isEqual(S){return S instanceof ServerTimestampFieldValueImpl}};let ArrayUnionFieldValueImpl=class ArrayUnionFieldValueImpl extends null{constructor(S,T){super(S),this._elements=T}_toFieldTransform(S){let T=createSentinelChildContext(this,S,!0),R=this._elements.map(S=>parseData(S,T)),P=new ArrayUnionTransformOperation(R);return new FieldTransform(S.path,P)}isEqual(S){return S instanceof ArrayUnionFieldValueImpl&&deepEqual(this._elements,S._elements)}};let ArrayRemoveFieldValueImpl=class ArrayRemoveFieldValueImpl extends null{constructor(S,T){super(S),this._elements=T}_toFieldTransform(S){let T=createSentinelChildContext(this,S,!0),R=this._elements.map(S=>parseData(S,T)),P=new ArrayRemoveTransformOperation(R);return new FieldTransform(S.path,P)}isEqual(S){return S instanceof ArrayRemoveFieldValueImpl&&deepEqual(this._elements,S._elements)}};let NumericIncrementFieldValueImpl=class NumericIncrementFieldValueImpl extends null{constructor(S,T){super(S),this._operand=T}_toFieldTransform(S){let T=new NumericIncrementTransformOperation(S.serializer,toNumber(S.serializer,this._operand));return new FieldTransform(S.path,T)}isEqual(S){return S instanceof NumericIncrementFieldValueImpl&&this._operand===S._operand}};function parseUpdateData(S,T,R,P){let O=S.createContext(1,T,R);validatePlainObject("Data must be an object, but it was:",O,P);let N=[],M=ObjectValue.empty();forEach(P,(S,P)=>{let L=fieldPathFromDotSeparatedString(T,S,R);P=(0,K.m9)(P);let V=O.childContextForFieldPath(L);if(P instanceof DeleteFieldValueImpl)N.push(L);else{let S=parseData(P,V);null!=S&&(N.push(L),M.set(L,S))}});let L=new FieldMask(N);return new ParsedUpdateData(M,L,O.fieldTransforms)}function parseUpdateVarargs(S,T,R,P,O,N){let M=S.createContext(1,T,R),L=[fieldPathFromArgument$1(T,P,R)],V=[O];if(N.length%2!=0)throw new FirestoreError(es.INVALID_ARGUMENT,`Function ${T}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let S=0;S<N.length;S+=2)L.push(fieldPathFromArgument$1(T,N[S])),V.push(N[S+1]);let U=[],W=ObjectValue.empty();for(let S=L.length-1;S>=0;--S)if(!fieldMaskContains(U,L[S])){let T=L[S],R=V[S];R=(0,K.m9)(R);let P=M.childContextForFieldPath(T);if(R instanceof DeleteFieldValueImpl)U.push(T);else{let S=parseData(R,P);null!=S&&(U.push(T),W.set(T,S))}}let Q=new FieldMask(U);return new ParsedUpdateData(W,Q,M.fieldTransforms)}function parseQueryValue(S,T,R,P=!1){let O=S.createContext(P?4:3,T),N=parseData(R,O);return N}function parseData(S,T){if(looksLikeJsonObject(S=(0,K.m9)(S)))return validatePlainObject("Unsupported field value:",T,S),parseObject(S,T);if(S instanceof FieldValue)return parseSentinelFieldValue(S,T),null;if(void 0===S&&T.ignoreUndefinedProperties)return null;if(T.path&&T.fieldMask.push(T.path),!(S instanceof Array))return parseScalarValue(S,T);if(T.settings.arrayElement&&4!==T.dataSource)throw T.createError("Nested arrays are not supported");return parseArray(S,T)}function parseObject(S,T){let R={};return isEmpty(S)?T.path&&T.path.length>0&&T.fieldMask.push(T.path):forEach(S,(S,P)=>{let O=parseData(P,T.childContextForField(S));null!=O&&(R[S]=O)}),{mapValue:{fields:R}}}function parseArray(S,T){let R=[],P=0;for(let O of S){let S=parseData(O,T.childContextForArray(P));null==S&&(S={nullValue:"NULL_VALUE"}),R.push(S),P++}return{arrayValue:{values:R}}}function parseSentinelFieldValue(S,T){if(!isWrite(T.dataSource))throw T.createError(`${S._methodName}() can only be used with update() and set()`);if(!T.path)throw T.createError(`${S._methodName}() is not currently supported inside arrays`);let R=S._toFieldTransform(T);R&&T.fieldTransforms.push(R)}function parseScalarValue(S,T){if(null===(S=(0,K.m9)(S)))return{nullValue:"NULL_VALUE"};if("number"==typeof S)return toNumber(T.serializer,S);if("boolean"==typeof S)return{booleanValue:S};if("string"==typeof S)return{stringValue:S};if(S instanceof Date){let R=Timestamp.fromDate(S);return{timestampValue:toTimestamp(T.serializer,R)}}if(S instanceof Timestamp){let R=new Timestamp(S.seconds,1e3*Math.floor(S.nanoseconds/1e3));return{timestampValue:toTimestamp(T.serializer,R)}}if(S instanceof GeoPoint)return{geoPointValue:{latitude:S.latitude,longitude:S.longitude}};else if(S instanceof Bytes)return{bytesValue:toBytes(T.serializer,S._byteString)};else if(S instanceof DocumentReference){let R=T.databaseId,P=S.firestore._databaseId;if(!P.isEqual(R))throw T.createError(`Document reference is for database ${P.projectId}/${P.database} but should be for database ${R.projectId}/${R.database}`);return{referenceValue:toResourceName(S.firestore._databaseId||T.databaseId,S._key.path)}}else if(S instanceof VectorValue)return parseVectorValue(S,T);else throw T.createError(`Unsupported field value: ${valueDescription(S)}`)}function parseVectorValue(S,T){let R={fields:{[tU]:{stringValue:tz},[tW]:{arrayValue:{values:S.toArray().map(S=>{if("number"!=typeof S)throw T.createError("VectorValues must only contain numeric values.");return toDouble(T.serializer,S)})}}}};return{mapValue:R}}function looksLikeJsonObject(S){return"object"==typeof S&&null!==S&&!(S instanceof Array)&&!(S instanceof Date)&&!(S instanceof Timestamp)&&!(S instanceof GeoPoint)&&!(S instanceof Bytes)&&!(S instanceof DocumentReference)&&!(S instanceof FieldValue)&&!(S instanceof VectorValue)}function validatePlainObject(S,T,R){if(!looksLikeJsonObject(R)||!isPlainObject(R)){let P=valueDescription(R);if("an object"===P)throw T.createError(S+" a custom object");throw T.createError(S+" "+P)}}function fieldPathFromArgument$1(S,T,R){if((T=(0,K.m9)(T))instanceof FieldPath)return T._internalPath;if("string"==typeof T)return fieldPathFromDotSeparatedString(S,T);{let T="Field path arguments must be of type string or ";throw createError(T,S,!1,void 0,R)}}let nI=RegExp("[~\\*/\\[\\]]");function fieldPathFromDotSeparatedString(S,T,R){let P=T.search(nI);if(P>=0)throw createError(`Invalid field path (${T}). Paths must not contain '~', '*', '/', '[', or ']'`,S,!1,void 0,R);try{return new FieldPath(...T.split("."))._internalPath}catch(P){throw createError(`Invalid field path (${T}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,S,!1,void 0,R)}}function createError(S,T,R,P,O){let N=P&&!P.isEmpty(),M=void 0!==O,L=`Function ${T}() called with invalid data`;R&&(L+=" (via `toFirestore()`)"),L+=". ";let V="";return(N||M)&&(V+=" (found",N&&(V+=` in field ${P}`),M&&(V+=` in document ${O}`),V+=")"),new FirestoreError(es.INVALID_ARGUMENT,L+S+V)}function fieldMaskContains(S,T){return S.some(S=>S.isEqual(T))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let DocumentSnapshot$1=class DocumentSnapshot$1{constructor(S,T,R,P,O){this._firestore=S,this._userDataWriter=T,this._key=R,this._document=P,this._converter=O}get id(){return this._key.path.lastSegment()}get ref(){return new DocumentReference(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(!this._converter)return this._userDataWriter.convertValue(this._document.data.value);{let S=new QueryDocumentSnapshot$1(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(S)}}}get(S){if(this._document){let T=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",S));if(null!==T)return this._userDataWriter.convertValue(T)}}};let QueryDocumentSnapshot$1=class QueryDocumentSnapshot$1 extends DocumentSnapshot$1{data(){return super.data()}};function fieldPathFromArgument(S,T){return"string"==typeof T?fieldPathFromDotSeparatedString(S,T):T instanceof FieldPath?T._internalPath:T._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function validateHasExplicitOrderByForLimitToLast(S){if("L"===S.limitType&&0===S.explicitOrderBy.length)throw new FirestoreError(es.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}let AppliableConstraint=class AppliableConstraint{};let QueryConstraint=class QueryConstraint extends AppliableConstraint{};function query(S,T,...R){let P=[];for(let O of(T instanceof AppliableConstraint&&P.push(T),validateQueryConstraintArray(P=P.concat(R)),P))S=O._apply(S);return S}let QueryFieldFilterConstraint=class QueryFieldFilterConstraint extends QueryConstraint{constructor(S,T,R){super(),this._field=S,this._op=T,this._value=R,this.type="where"}static _create(S,T,R){return new QueryFieldFilterConstraint(S,T,R)}_apply(S){let T=this._parse(S);return validateNewFieldFilter(S._query,T),new Query(S.firestore,S.converter,queryWithAddedFilter(S._query,T))}_parse(S){let T=newUserDataReader(S.firestore),R=newQueryFilter(S._query,"where",T,S.firestore._databaseId,this._field,this._op,this._value);return R}};function where(S,T,R){let P=T,O=fieldPathFromArgument("where",S);return QueryFieldFilterConstraint._create(O,P,R)}let QueryCompositeFilterConstraint=class QueryCompositeFilterConstraint extends AppliableConstraint{constructor(S,T){super(),this.type=S,this._queryConstraints=T}static _create(S,T){return new QueryCompositeFilterConstraint(S,T)}_parse(S){let T=this._queryConstraints.map(T=>T._parse(S)).filter(S=>S.getFilters().length>0);return 1===T.length?T[0]:CompositeFilter.create(T,this._getOperator())}_apply(S){let T=this._parse(S);return 0===T.getFilters().length?S:(validateNewFilter(S._query,T),new Query(S.firestore,S.converter,queryWithAddedFilter(S._query,T)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}};let QueryOrderByConstraint=class QueryOrderByConstraint extends QueryConstraint{constructor(S,T){super(),this._field=S,this._direction=T,this.type="orderBy"}static _create(S,T){return new QueryOrderByConstraint(S,T)}_apply(S){let T=newQueryOrderBy(S._query,this._field,this._direction);return new Query(S.firestore,S.converter,queryWithAddedOrderBy(S._query,T))}};function orderBy(S,T="asc"){let R=T,P=fieldPathFromArgument("orderBy",S);return QueryOrderByConstraint._create(P,R)}let QueryLimitConstraint=class QueryLimitConstraint extends null{constructor(S,T,R){super(),this.type=S,this._limit=T,this._limitType=R}static _create(S,T,R){return new QueryLimitConstraint(S,T,R)}_apply(S){return new Query(S.firestore,S.converter,queryWithLimit(S._query,this._limit,this._limitType))}};let QueryStartAtConstraint=class QueryStartAtConstraint extends null{constructor(S,T,R){super(),this.type=S,this._docOrFields=T,this._inclusive=R}static _create(S,T,R){return new QueryStartAtConstraint(S,T,R)}_apply(S){let T=newQueryBoundFromDocOrFields(S,this.type,this._docOrFields,this._inclusive);return new Query(S.firestore,S.converter,queryWithStartAt(S._query,T))}};let QueryEndAtConstraint=class QueryEndAtConstraint extends null{constructor(S,T,R){super(),this.type=S,this._docOrFields=T,this._inclusive=R}static _create(S,T,R){return new QueryEndAtConstraint(S,T,R)}_apply(S){let T=newQueryBoundFromDocOrFields(S,this.type,this._docOrFields,this._inclusive);return new Query(S.firestore,S.converter,queryWithEndAt(S._query,T))}};function newQueryBoundFromDocOrFields(S,T,R,P){if(R[0]=getModularInstance(R[0]),R[0]instanceof DocumentSnapshot$1)return newQueryBoundFromDocument(S._query,S.firestore._databaseId,T,R[0]._document,P);{let O=newUserDataReader(S.firestore);return newQueryBoundFromFields(S._query,S.firestore._databaseId,O,T,R,P)}}function newQueryFilter(S,T,R,P,O,N,M){let L;if(O.isKeyField()){if("array-contains"===N||"array-contains-any"===N)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid Query. You can't perform '${N}' queries on documentId().`);if("in"===N||"not-in"===N){validateDisjunctiveFilterElements(M,N);let T=[];for(let R of M)T.push(parseDocumentIdValue(P,S,R));L={arrayValue:{values:T}}}else L=parseDocumentIdValue(P,S,M)}else("in"===N||"not-in"===N||"array-contains-any"===N)&&validateDisjunctiveFilterElements(M,N),L=parseQueryValue(R,T,M,"in"===N||"not-in"===N);let V=FieldFilter.create(O,N,L);return V}function newQueryOrderBy(S,T,R){if(null!==S.startAt)throw new FirestoreError(es.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==S.endAt)throw new FirestoreError(es.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");let P=new OrderBy(T,R);return P}function newQueryBoundFromDocument(S,T,R,P,O){if(!P)throw new FirestoreError(es.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${R}().`);let N=[];for(let R of queryNormalizedOrderBy(S))if(R.field.isKeyField())N.push(refValue(T,P.key));else{let S=P.data.field(R.field);if(isServerTimestamp(S))throw new FirestoreError(es.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+R.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null!==S)N.push(S);else{let S=R.field.canonicalString();throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${S}' (used as the orderBy) does not exist.`)}}return new Bound(N,O)}function newQueryBoundFromFields(S,T,R,P,O,N){let M=S.explicitOrderBy;if(O.length>M.length)throw new FirestoreError(es.INVALID_ARGUMENT,`Too many arguments provided to ${P}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let L=[];for(let N=0;N<O.length;N++){let V=O[N],U=M[N];if(U.field.isKeyField()){if("string"!=typeof V)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${P}(), but got a ${typeof V}`);if(!isCollectionGroupQuery(S)&&-1!==V.indexOf("/"))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${P}() must be a plain document ID, but '${V}' contains a slash.`);let R=S.path.child(ResourcePath.fromString(V));if(!DocumentKey.isDocumentKey(R))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${P}() must result in a valid document path, but '${R}' is not because it contains an odd number of segments.`);let O=new DocumentKey(R);L.push(refValue(T,O))}else{let S=parseQueryValue(R,P,V);L.push(S)}}return new Bound(L,N)}function parseDocumentIdValue(S,T,R){if("string"==typeof(R=(0,K.m9)(R))){if(""===R)throw new FirestoreError(es.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!isCollectionGroupQuery(T)&&-1!==R.indexOf("/"))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${R}' contains a '/' character.`);let P=T.path.child(ResourcePath.fromString(R));if(!DocumentKey.isDocumentKey(P))throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${P}' is not because it has an odd number of segments (${P.length}).`);return refValue(S,new DocumentKey(P))}if(R instanceof DocumentReference)return refValue(S,R._key);throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${valueDescription(R)}.`)}function validateDisjunctiveFilterElements(S,T){if(!Array.isArray(S)||0===S.length)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${T.toString()}' filters.`)}function conflictingOps(S){switch(S){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}function validateNewFieldFilter(S,T){let R=findOpInsideFilters(S.filters,conflictingOps(T.op));if(null!==R){if(R===T.op)throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${T.op.toString()}' filter.`);throw new FirestoreError(es.INVALID_ARGUMENT,`Invalid query. You cannot use '${T.op.toString()}' filters with '${R.toString()}' filters.`)}}function validateNewFilter(S,T){let R=S,P=T.getFlattenedFilters();for(let S of P)validateNewFieldFilter(R,S),R=queryWithAddedFilter(R,S)}function findOpInsideFilters(S,T){for(let R of S)for(let S of R.getFlattenedFilters())if(T.indexOf(S.op)>=0)return S.op;return null}function validateQueryConstraintArray(S){let T=S.filter(S=>S instanceof QueryCompositeFilterConstraint).length,R=S.filter(S=>S instanceof QueryFieldFilterConstraint).length;if(T>1||T>0&&R>0)throw new FirestoreError(es.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let AbstractUserDataWriter=class AbstractUserDataWriter{convertValue(S,T="none"){switch(typeOrder(S)){case 0:return null;case 1:return S.booleanValue;case 2:return normalizeNumber(S.integerValue||S.doubleValue);case 3:return this.convertTimestamp(S.timestampValue);case 4:return this.convertServerTimestamp(S,T);case 5:return S.stringValue;case 6:return this.convertBytes(normalizeByteString(S.bytesValue));case 7:return this.convertReference(S.referenceValue);case 8:return this.convertGeoPoint(S.geoPointValue);case 9:return this.convertArray(S.arrayValue,T);case 11:return this.convertObject(S.mapValue,T);case 10:return this.convertVectorValue(S.mapValue);default:throw fail()}}convertObject(S,T){return this.convertObjectMap(S.fields,T)}convertObjectMap(S,T="none"){let R={};return forEach(S,(S,P)=>{R[S]=this.convertValue(P,T)}),R}convertVectorValue(S){var T,R,P;let O=null===(P=null===(R=null===(T=S.fields)||void 0===T?void 0:T[tW].arrayValue)||void 0===R?void 0:R.values)||void 0===P?void 0:P.map(S=>normalizeNumber(S.doubleValue));return new VectorValue(O)}convertGeoPoint(S){return new GeoPoint(normalizeNumber(S.latitude),normalizeNumber(S.longitude))}convertArray(S,T){return(S.values||[]).map(S=>this.convertValue(S,T))}convertServerTimestamp(S,T){switch(T){case"previous":let R=getPreviousValue(S);if(null==R)return null;return this.convertValue(R,T);case"estimate":return this.convertTimestamp(getLocalWriteTime(S));default:return null}}convertTimestamp(S){let T=normalizeTimestamp(S);return new Timestamp(T.seconds,T.nanos)}convertDocumentKey(S,T){let R=ResourcePath.fromString(S);hardAssert(isValidResourceName(R));let P=new DatabaseId(R.get(1),R.get(3)),O=new DocumentKey(R.popFirst(5));return P.isEqual(T)||logError(`Document ${O} contains a document reference within a different database (${P.projectId}/${P.database}) which is not supported. It will be treated as a reference in the current database (${T.projectId}/${T.database}) instead.`),O}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function applyFirestoreDataConverter(S,T,R){return S?R&&(R.merge||R.mergeFields)?S.toFirestore(T,R):S.toFirestore(T):T}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function isPartialObserver(S){return implementsAnyMethods(S,["next","error","complete"])}function implementsAnyMethods(S,T){if("object"!=typeof S||null===S)return!1;let R=S;for(let S of T)if(S in R&&"function"==typeof R[S])return!0;return!1}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let SnapshotMetadata=class SnapshotMetadata{constructor(S,T){this.hasPendingWrites=S,this.fromCache=T}isEqual(S){return this.hasPendingWrites===S.hasPendingWrites&&this.fromCache===S.fromCache}};let DocumentSnapshot=class DocumentSnapshot extends DocumentSnapshot$1{constructor(S,T,R,P,O,N){super(S,T,R,P,N),this._firestore=S,this._firestoreImpl=S,this.metadata=O}exists(){return super.exists()}data(S={}){if(this._document){if(!this._converter)return this._userDataWriter.convertValue(this._document.data.value,S.serverTimestamps);{let T=new QueryDocumentSnapshot(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(T,S)}}}get(S,T={}){if(this._document){let R=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",S));if(null!==R)return this._userDataWriter.convertValue(R,T.serverTimestamps)}}};let QueryDocumentSnapshot=class QueryDocumentSnapshot extends DocumentSnapshot{data(S={}){return super.data(S)}};let QuerySnapshot=class QuerySnapshot{constructor(S,T,R,P){this._firestore=S,this._userDataWriter=T,this._snapshot=P,this.metadata=new SnapshotMetadata(P.hasPendingWrites,P.fromCache),this.query=R}get docs(){let S=[];return this.forEach(T=>S.push(T)),S}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(S,T){this._snapshot.docs.forEach(R=>{S.call(T,new QueryDocumentSnapshot(this._firestore,this._userDataWriter,R.key,R,new SnapshotMetadata(this._snapshot.mutatedKeys.has(R.key),this._snapshot.fromCache),this.query.converter))})}docChanges(S={}){let T=!!S.includeMetadataChanges;if(T&&this._snapshot.excludesMetadataChanges)throw new FirestoreError(es.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===T||(this._cachedChanges=changesFromSnapshot(this,T),this._cachedChangesIncludeMetadataChanges=T),this._cachedChanges}};function changesFromSnapshot(S,T){if(S._snapshot.oldDocs.isEmpty()){let T=0;return S._snapshot.docChanges.map(R=>{let P=new QueryDocumentSnapshot(S._firestore,S._userDataWriter,R.doc.key,R.doc,new SnapshotMetadata(S._snapshot.mutatedKeys.has(R.doc.key),S._snapshot.fromCache),S.query.converter);return R.doc,{type:"added",doc:P,oldIndex:-1,newIndex:T++}})}{let R=S._snapshot.oldDocs;return S._snapshot.docChanges.filter(S=>T||3!==S.type).map(T=>{let P=new QueryDocumentSnapshot(S._firestore,S._userDataWriter,T.doc.key,T.doc,new SnapshotMetadata(S._snapshot.mutatedKeys.has(T.doc.key),S._snapshot.fromCache),S.query.converter),O=-1,N=-1;return 0!==T.type&&(O=R.indexOf(T.doc.key),R=R.delete(T.doc.key)),1!==T.type&&(N=(R=R.add(T.doc)).indexOf(T.doc.key)),{type:resultChangeType(T.type),doc:P,oldIndex:O,newIndex:N}})}}function resultChangeType(S){switch(S){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return fail()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function getDoc(S){S=cast(S,DocumentReference);let T=cast(S.firestore,Firestore),R=ensureFirestoreConfigured(T);return firestoreClientGetDocumentViaSnapshotListener(R,S._key).then(R=>convertToDocSnapshot(T,S,R))}let ExpUserDataWriter=class ExpUserDataWriter extends AbstractUserDataWriter{constructor(S){super(),this.firestore=S}convertBytes(S){return new Bytes(S)}convertReference(S){let T=this.convertDocumentKey(S,this.firestore._databaseId);return new DocumentReference(this.firestore,null,T)}};function getDocs(S){S=cast(S,Query);let T=cast(S.firestore,Firestore),R=ensureFirestoreConfigured(T),P=new ExpUserDataWriter(T);return validateHasExplicitOrderByForLimitToLast(S._query),firestoreClientGetDocumentsViaSnapshotListener(R,S._query).then(R=>new QuerySnapshot(T,P,S,R))}function updateDoc(S,T,R,...P){let O;S=cast(S,DocumentReference);let N=cast(S.firestore,Firestore),M=newUserDataReader(N);O="string"==typeof(T=(0,K.m9)(T))||T instanceof FieldPath?parseUpdateVarargs(M,"updateDoc",S._key,T,R,P):parseUpdateData(M,"updateDoc",S._key,T);let L=O.toMutation(S._key,Precondition.exists(!0));return executeWrite(N,[L])}function deleteDoc(S){let T=cast(S.firestore,Firestore),R=[new DeleteMutation(S._key,Precondition.none())];return executeWrite(T,R)}function addDoc(S,T){let R=cast(S.firestore,Firestore),P=doc(S),O=applyFirestoreDataConverter(S.converter,T),N=newUserDataReader(S.firestore),M=parseSetData(N,"addDoc",P._key,O,null!==S.converter,{}),L=M.toMutation(P._key,Precondition.exists(!1));return executeWrite(R,[L]).then(()=>P)}function onSnapshot(S,...T){var R,P,O;let N,M,L;S=(0,K.m9)(S);let V={includeMetadataChanges:!1,source:"default"},U=0;"object"==typeof T[0]&&!isPartialObserver(T[U])&&(V=T[U],U++);let W={includeMetadataChanges:V.includeMetadataChanges,source:V.source};if(isPartialObserver(T[U])){let S=T[U];T[U]=null===(R=S.next)||void 0===R?void 0:R.bind(S),T[U+1]=null===(P=S.error)||void 0===P?void 0:P.bind(S),T[U+2]=null===(O=S.complete)||void 0===O?void 0:O.bind(S)}if(S instanceof DocumentReference)M=cast(S.firestore,Firestore),L=newQueryForPath(S._key.path),N={next:R=>{T[U]&&T[U](convertToDocSnapshot(M,S,R))},error:T[U+1],complete:T[U+2]};else{let R=cast(S,Query);M=cast(R.firestore,Firestore),L=R._query;let P=new ExpUserDataWriter(M);N={next:S=>{T[U]&&T[U](new QuerySnapshot(M,P,R,S))},error:T[U+1],complete:T[U+2]},validateHasExplicitOrderByForLimitToLast(S._query)}let Q=ensureFirestoreConfigured(M);return firestoreClientListen(Q,L,W,N)}function executeWrite(S,T){let R=ensureFirestoreConfigured(S);return firestoreClientWrite(R,T)}function convertToDocSnapshot(S,T,R){let P=R.docs.get(T._key),O=new ExpUserDataWriter(S);return new DocumentSnapshot(S,O,T._key,P,new SnapshotMetadata(R.hasPendingWrites,R.fromCache),T.converter)}let SingleTabManagerImpl=class SingleTabManagerImpl{constructor(S){this.forceOwnership=S,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(S){this._onlineComponentProvider=OnlineComponentProvider.provider,this._offlineComponentProvider={build:T=>new IndexedDbOfflineComponentProvider(T,null==S?void 0:S.cacheSizeBytes,this.forceOwnership)}}};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let WriteBatch=class WriteBatch{constructor(S,T){this._firestore=S,this._commitHandler=T,this._mutations=[],this._committed=!1,this._dataReader=newUserDataReader(S)}set(S,T,R){this._verifyNotCommitted();let P=validateReference(S,this._firestore),O=applyFirestoreDataConverter(P.converter,T,R),N=parseSetData(this._dataReader,"WriteBatch.set",P._key,O,null!==P.converter,R);return this._mutations.push(N.toMutation(P._key,Precondition.none())),this}update(S,T,R,...P){let O;this._verifyNotCommitted();let N=validateReference(S,this._firestore);return O="string"==typeof(T=(0,K.m9)(T))||T instanceof FieldPath?parseUpdateVarargs(this._dataReader,"WriteBatch.update",N._key,T,R,P):parseUpdateData(this._dataReader,"WriteBatch.update",N._key,T),this._mutations.push(O.toMutation(N._key,Precondition.exists(!0))),this}delete(S){this._verifyNotCommitted();let T=validateReference(S,this._firestore);return this._mutations=this._mutations.concat(new DeleteMutation(T._key,Precondition.none())),this}commit(){return(this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0)?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new FirestoreError(es.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function validateReference(S,T){if((S=(0,K.m9)(S)).firestore===T)return S;throw new FirestoreError(es.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function deleteField(){return new DeleteFieldValueImpl("deleteField")}function serverTimestamp(){return new ServerTimestampFieldValueImpl("serverTimestamp")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function writeBatch(S){return ensureFirestoreConfigured(S=cast(S,Firestore)),new WriteBatch(S,T=>executeWrite(S,T))}new WeakMap,/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */registerFirestore("node")},81513:S=>{"use strict";S.exports={i8:"1.9.15"}},56541:S=>{"use strict";S.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"Api":{"fields":{"name":{"type":"string","id":1},"methods":{"rule":"repeated","type":"Method","id":2},"options":{"rule":"repeated","type":"Option","id":3},"version":{"type":"string","id":4},"sourceContext":{"type":"SourceContext","id":5},"mixins":{"rule":"repeated","type":"Mixin","id":6},"syntax":{"type":"Syntax","id":7}}},"Method":{"fields":{"name":{"type":"string","id":1},"requestTypeUrl":{"type":"string","id":2},"requestStreaming":{"type":"bool","id":3},"responseTypeUrl":{"type":"string","id":4},"responseStreaming":{"type":"bool","id":5},"options":{"rule":"repeated","type":"Option","id":6},"syntax":{"type":"Syntax","id":7}}},"Mixin":{"fields":{"name":{"type":"string","id":1},"root":{"type":"string","id":2}}},"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}},"Option":{"fields":{"name":{"type":"string","id":1},"value":{"type":"Any","id":2}}},"Syntax":{"values":{"SYNTAX_PROTO2":0,"SYNTAX_PROTO3":1}}}}}}}}')},89987:S=>{"use strict";S.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"options":{"go_package":"google.golang.org/protobuf/types/descriptorpb","java_package":"com.google.protobuf","java_outer_classname":"DescriptorProtos","csharp_namespace":"Google.Protobuf.Reflection","objc_class_prefix":"GPB","cc_enable_arenas":true,"optimize_for":"SPEED"},"nested":{"FileDescriptorSet":{"edition":"proto2","fields":{"file":{"rule":"repeated","type":"FileDescriptorProto","id":1}},"extensions":[[536000000,536000000]]},"Edition":{"edition":"proto2","values":{"EDITION_UNKNOWN":0,"EDITION_LEGACY":900,"EDITION_PROTO2":998,"EDITION_PROTO3":999,"EDITION_2023":1000,"EDITION_2024":1001,"EDITION_1_TEST_ONLY":1,"EDITION_2_TEST_ONLY":2,"EDITION_99997_TEST_ONLY":99997,"EDITION_99998_TEST_ONLY":99998,"EDITION_99999_TEST_ONLY":99999,"EDITION_MAX":2147483647}},"FileDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"package":{"type":"string","id":2},"dependency":{"rule":"repeated","type":"string","id":3},"publicDependency":{"rule":"repeated","type":"int32","id":10},"weakDependency":{"rule":"repeated","type":"int32","id":11},"optionDependency":{"rule":"repeated","type":"string","id":15},"messageType":{"rule":"repeated","type":"DescriptorProto","id":4},"enumType":{"rule":"repeated","type":"EnumDescriptorProto","id":5},"service":{"rule":"repeated","type":"ServiceDescriptorProto","id":6},"extension":{"rule":"repeated","type":"FieldDescriptorProto","id":7},"options":{"type":"FileOptions","id":8},"sourceCodeInfo":{"type":"SourceCodeInfo","id":9},"syntax":{"type":"string","id":12},"edition":{"type":"Edition","id":14}}},"DescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"field":{"rule":"repeated","type":"FieldDescriptorProto","id":2},"extension":{"rule":"repeated","type":"FieldDescriptorProto","id":6},"nestedType":{"rule":"repeated","type":"DescriptorProto","id":3},"enumType":{"rule":"repeated","type":"EnumDescriptorProto","id":4},"extensionRange":{"rule":"repeated","type":"ExtensionRange","id":5},"oneofDecl":{"rule":"repeated","type":"OneofDescriptorProto","id":8},"options":{"type":"MessageOptions","id":7},"reservedRange":{"rule":"repeated","type":"ReservedRange","id":9},"reservedName":{"rule":"repeated","type":"string","id":10},"visibility":{"type":"SymbolVisibility","id":11}},"nested":{"ExtensionRange":{"fields":{"start":{"type":"int32","id":1},"end":{"type":"int32","id":2},"options":{"type":"ExtensionRangeOptions","id":3}}},"ReservedRange":{"fields":{"start":{"type":"int32","id":1},"end":{"type":"int32","id":2}}}}},"ExtensionRangeOptions":{"edition":"proto2","fields":{"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999},"declaration":{"rule":"repeated","type":"Declaration","id":2,"options":{"retention":"RETENTION_SOURCE"}},"features":{"type":"FeatureSet","id":50},"verification":{"type":"VerificationState","id":3,"options":{"default":"UNVERIFIED","retention":"RETENTION_SOURCE"}}},"extensions":[[1000,536870911]],"nested":{"Declaration":{"fields":{"number":{"type":"int32","id":1},"fullName":{"type":"string","id":2},"type":{"type":"string","id":3},"reserved":{"type":"bool","id":5},"repeated":{"type":"bool","id":6}},"reserved":[[4,4]]},"VerificationState":{"values":{"DECLARATION":0,"UNVERIFIED":1}}}},"FieldDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":3},"label":{"type":"Label","id":4},"type":{"type":"Type","id":5},"typeName":{"type":"string","id":6},"extendee":{"type":"string","id":2},"defaultValue":{"type":"string","id":7},"oneofIndex":{"type":"int32","id":9},"jsonName":{"type":"string","id":10},"options":{"type":"FieldOptions","id":8},"proto3Optional":{"type":"bool","id":17}},"nested":{"Type":{"values":{"TYPE_DOUBLE":1,"TYPE_FLOAT":2,"TYPE_INT64":3,"TYPE_UINT64":4,"TYPE_INT32":5,"TYPE_FIXED64":6,"TYPE_FIXED32":7,"TYPE_BOOL":8,"TYPE_STRING":9,"TYPE_GROUP":10,"TYPE_MESSAGE":11,"TYPE_BYTES":12,"TYPE_UINT32":13,"TYPE_ENUM":14,"TYPE_SFIXED32":15,"TYPE_SFIXED64":16,"TYPE_SINT32":17,"TYPE_SINT64":18}},"Label":{"values":{"LABEL_OPTIONAL":1,"LABEL_REPEATED":3,"LABEL_REQUIRED":2}}}},"OneofDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"options":{"type":"OneofOptions","id":2}}},"EnumDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"value":{"rule":"repeated","type":"EnumValueDescriptorProto","id":2},"options":{"type":"EnumOptions","id":3},"reservedRange":{"rule":"repeated","type":"EnumReservedRange","id":4},"reservedName":{"rule":"repeated","type":"string","id":5},"visibility":{"type":"SymbolVisibility","id":6}},"nested":{"EnumReservedRange":{"fields":{"start":{"type":"int32","id":1},"end":{"type":"int32","id":2}}}}},"EnumValueDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":2},"options":{"type":"EnumValueOptions","id":3}}},"ServiceDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"method":{"rule":"repeated","type":"MethodDescriptorProto","id":2},"options":{"type":"ServiceOptions","id":3}}},"MethodDescriptorProto":{"edition":"proto2","fields":{"name":{"type":"string","id":1},"inputType":{"type":"string","id":2},"outputType":{"type":"string","id":3},"options":{"type":"MethodOptions","id":4},"clientStreaming":{"type":"bool","id":5},"serverStreaming":{"type":"bool","id":6}}},"FileOptions":{"edition":"proto2","fields":{"javaPackage":{"type":"string","id":1},"javaOuterClassname":{"type":"string","id":8},"javaMultipleFiles":{"type":"bool","id":10},"javaGenerateEqualsAndHash":{"type":"bool","id":20,"options":{"deprecated":true}},"javaStringCheckUtf8":{"type":"bool","id":27},"optimizeFor":{"type":"OptimizeMode","id":9,"options":{"default":"SPEED"}},"goPackage":{"type":"string","id":11},"ccGenericServices":{"type":"bool","id":16},"javaGenericServices":{"type":"bool","id":17},"pyGenericServices":{"type":"bool","id":18},"deprecated":{"type":"bool","id":23},"ccEnableArenas":{"type":"bool","id":31,"options":{"default":true}},"objcClassPrefix":{"type":"string","id":36},"csharpNamespace":{"type":"string","id":37},"swiftPrefix":{"type":"string","id":39},"phpClassPrefix":{"type":"string","id":40},"phpNamespace":{"type":"string","id":41},"phpMetadataNamespace":{"type":"string","id":44},"rubyPackage":{"type":"string","id":45},"features":{"type":"FeatureSet","id":50},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[42,42],[38,38],"php_generic_services"],"nested":{"OptimizeMode":{"values":{"SPEED":1,"CODE_SIZE":2,"LITE_RUNTIME":3}}}},"MessageOptions":{"edition":"proto2","fields":{"messageSetWireFormat":{"type":"bool","id":1},"noStandardDescriptorAccessor":{"type":"bool","id":2},"deprecated":{"type":"bool","id":3},"mapEntry":{"type":"bool","id":7},"deprecatedLegacyJsonFieldConflicts":{"type":"bool","id":11,"options":{"deprecated":true}},"features":{"type":"FeatureSet","id":12},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[4,4],[5,5],[6,6],[8,8],[9,9]]},"FieldOptions":{"edition":"proto2","fields":{"ctype":{"type":"CType","id":1,"options":{"default":"STRING"}},"packed":{"type":"bool","id":2},"jstype":{"type":"JSType","id":6,"options":{"default":"JS_NORMAL"}},"lazy":{"type":"bool","id":5},"unverifiedLazy":{"type":"bool","id":15},"deprecated":{"type":"bool","id":3},"weak":{"type":"bool","id":10,"options":{"deprecated":true}},"debugRedact":{"type":"bool","id":16},"retention":{"type":"OptionRetention","id":17},"targets":{"rule":"repeated","type":"OptionTargetType","id":19},"editionDefaults":{"rule":"repeated","type":"EditionDefault","id":20},"features":{"type":"FeatureSet","id":21},"featureSupport":{"type":"FeatureSupport","id":22},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[4,4],[18,18]],"nested":{"CType":{"values":{"STRING":0,"CORD":1,"STRING_PIECE":2}},"JSType":{"values":{"JS_NORMAL":0,"JS_STRING":1,"JS_NUMBER":2}},"OptionRetention":{"values":{"RETENTION_UNKNOWN":0,"RETENTION_RUNTIME":1,"RETENTION_SOURCE":2}},"OptionTargetType":{"values":{"TARGET_TYPE_UNKNOWN":0,"TARGET_TYPE_FILE":1,"TARGET_TYPE_EXTENSION_RANGE":2,"TARGET_TYPE_MESSAGE":3,"TARGET_TYPE_FIELD":4,"TARGET_TYPE_ONEOF":5,"TARGET_TYPE_ENUM":6,"TARGET_TYPE_ENUM_ENTRY":7,"TARGET_TYPE_SERVICE":8,"TARGET_TYPE_METHOD":9}},"EditionDefault":{"fields":{"edition":{"type":"Edition","id":3},"value":{"type":"string","id":2}}},"FeatureSupport":{"fields":{"editionIntroduced":{"type":"Edition","id":1},"editionDeprecated":{"type":"Edition","id":2},"deprecationWarning":{"type":"string","id":3},"editionRemoved":{"type":"Edition","id":4}}}}},"OneofOptions":{"edition":"proto2","fields":{"features":{"type":"FeatureSet","id":1},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"EnumOptions":{"edition":"proto2","fields":{"allowAlias":{"type":"bool","id":2},"deprecated":{"type":"bool","id":3},"deprecatedLegacyJsonFieldConflicts":{"type":"bool","id":6,"options":{"deprecated":true}},"features":{"type":"FeatureSet","id":7},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"reserved":[[5,5]]},"EnumValueOptions":{"edition":"proto2","fields":{"deprecated":{"type":"bool","id":1},"features":{"type":"FeatureSet","id":2},"debugRedact":{"type":"bool","id":3},"featureSupport":{"type":"FieldOptions.FeatureSupport","id":4},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"ServiceOptions":{"edition":"proto2","fields":{"features":{"type":"FeatureSet","id":34},"deprecated":{"type":"bool","id":33},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]]},"MethodOptions":{"edition":"proto2","fields":{"deprecated":{"type":"bool","id":33},"idempotencyLevel":{"type":"IdempotencyLevel","id":34,"options":{"default":"IDEMPOTENCY_UNKNOWN"}},"features":{"type":"FeatureSet","id":35},"uninterpretedOption":{"rule":"repeated","type":"UninterpretedOption","id":999}},"extensions":[[1000,536870911]],"nested":{"IdempotencyLevel":{"values":{"IDEMPOTENCY_UNKNOWN":0,"NO_SIDE_EFFECTS":1,"IDEMPOTENT":2}}}},"UninterpretedOption":{"edition":"proto2","fields":{"name":{"rule":"repeated","type":"NamePart","id":2},"identifierValue":{"type":"string","id":3},"positiveIntValue":{"type":"uint64","id":4},"negativeIntValue":{"type":"int64","id":5},"doubleValue":{"type":"double","id":6},"stringValue":{"type":"bytes","id":7},"aggregateValue":{"type":"string","id":8}},"nested":{"NamePart":{"fields":{"namePart":{"rule":"required","type":"string","id":1},"isExtension":{"rule":"required","type":"bool","id":2}}}}},"FeatureSet":{"edition":"proto2","fields":{"fieldPresence":{"type":"FieldPresence","id":1,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_2023","edition_defaults.value":"EXPLICIT"}},"enumType":{"type":"EnumType","id":2,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_PROTO3","edition_defaults.value":"OPEN"}},"repeatedFieldEncoding":{"type":"RepeatedFieldEncoding","id":3,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_PROTO3","edition_defaults.value":"PACKED"}},"utf8Validation":{"type":"Utf8Validation","id":4,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_PROTO3","edition_defaults.value":"VERIFY"}},"messageEncoding":{"type":"MessageEncoding","id":5,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_LEGACY","edition_defaults.value":"LENGTH_PREFIXED"}},"jsonFormat":{"type":"JsonFormat","id":6,"options":{"retention":"RETENTION_RUNTIME","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2023","edition_defaults.edition":"EDITION_PROTO3","edition_defaults.value":"ALLOW"}},"enforceNamingStyle":{"type":"EnforceNamingStyle","id":7,"options":{"retention":"RETENTION_SOURCE","targets":"TARGET_TYPE_METHOD","feature_support.edition_introduced":"EDITION_2024","edition_defaults.edition":"EDITION_2024","edition_defaults.value":"STYLE2024"}},"defaultSymbolVisibility":{"type":"VisibilityFeature.DefaultSymbolVisibility","id":8,"options":{"retention":"RETENTION_SOURCE","targets":"TARGET_TYPE_FILE","feature_support.edition_introduced":"EDITION_2024","edition_defaults.edition":"EDITION_2024","edition_defaults.value":"EXPORT_TOP_LEVEL"}}},"extensions":[[1000,9994],[9995,9999],[10000,10000]],"reserved":[[999,999]],"nested":{"FieldPresence":{"values":{"FIELD_PRESENCE_UNKNOWN":0,"EXPLICIT":1,"IMPLICIT":2,"LEGACY_REQUIRED":3}},"EnumType":{"values":{"ENUM_TYPE_UNKNOWN":0,"OPEN":1,"CLOSED":2}},"RepeatedFieldEncoding":{"values":{"REPEATED_FIELD_ENCODING_UNKNOWN":0,"PACKED":1,"EXPANDED":2}},"Utf8Validation":{"values":{"UTF8_VALIDATION_UNKNOWN":0,"VERIFY":2,"NONE":3}},"MessageEncoding":{"values":{"MESSAGE_ENCODING_UNKNOWN":0,"LENGTH_PREFIXED":1,"DELIMITED":2}},"JsonFormat":{"values":{"JSON_FORMAT_UNKNOWN":0,"ALLOW":1,"LEGACY_BEST_EFFORT":2}},"EnforceNamingStyle":{"values":{"ENFORCE_NAMING_STYLE_UNKNOWN":0,"STYLE2024":1,"STYLE_LEGACY":2}},"VisibilityFeature":{"fields":{},"reserved":[[1,536870911]],"nested":{"DefaultSymbolVisibility":{"values":{"DEFAULT_SYMBOL_VISIBILITY_UNKNOWN":0,"EXPORT_ALL":1,"EXPORT_TOP_LEVEL":2,"LOCAL_ALL":3,"STRICT":4}}}}}},"FeatureSetDefaults":{"edition":"proto2","fields":{"defaults":{"rule":"repeated","type":"FeatureSetEditionDefault","id":1},"minimumEdition":{"type":"Edition","id":4},"maximumEdition":{"type":"Edition","id":5}},"nested":{"FeatureSetEditionDefault":{"fields":{"edition":{"type":"Edition","id":3},"overridableFeatures":{"type":"FeatureSet","id":4},"fixedFeatures":{"type":"FeatureSet","id":5}},"reserved":[[1,1],[2,2],"features"]}}},"SourceCodeInfo":{"edition":"proto2","fields":{"location":{"rule":"repeated","type":"Location","id":1}},"extensions":[[536000000,536000000]],"nested":{"Location":{"fields":{"path":{"rule":"repeated","type":"int32","id":1,"options":{"packed":true}},"span":{"rule":"repeated","type":"int32","id":2,"options":{"packed":true}},"leadingComments":{"type":"string","id":3},"trailingComments":{"type":"string","id":4},"leadingDetachedComments":{"rule":"repeated","type":"string","id":6}}}}},"GeneratedCodeInfo":{"edition":"proto2","fields":{"annotation":{"rule":"repeated","type":"Annotation","id":1}},"nested":{"Annotation":{"fields":{"path":{"rule":"repeated","type":"int32","id":1,"options":{"packed":true}},"sourceFile":{"type":"string","id":2},"begin":{"type":"int32","id":3},"end":{"type":"int32","id":4},"semantic":{"type":"Semantic","id":5}},"nested":{"Semantic":{"values":{"NONE":0,"SET":1,"ALIAS":2}}}}}},"SymbolVisibility":{"edition":"proto2","values":{"VISIBILITY_UNSET":0,"VISIBILITY_LOCAL":1,"VISIBILITY_EXPORT":2}}}}}}}}')},57674:S=>{"use strict";S.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}}}}}}}}')},73795:S=>{"use strict";S.exports=JSON.parse('{"nested":{"google":{"nested":{"protobuf":{"nested":{"Type":{"fields":{"name":{"type":"string","id":1},"fields":{"rule":"repeated","type":"Field","id":2},"oneofs":{"rule":"repeated","type":"string","id":3},"options":{"rule":"repeated","type":"Option","id":4},"sourceContext":{"type":"SourceContext","id":5},"syntax":{"type":"Syntax","id":6}}},"Field":{"fields":{"kind":{"type":"Kind","id":1},"cardinality":{"type":"Cardinality","id":2},"number":{"type":"int32","id":3},"name":{"type":"string","id":4},"typeUrl":{"type":"string","id":6},"oneofIndex":{"type":"int32","id":7},"packed":{"type":"bool","id":8},"options":{"rule":"repeated","type":"Option","id":9},"jsonName":{"type":"string","id":10},"defaultValue":{"type":"string","id":11}},"nested":{"Kind":{"values":{"TYPE_UNKNOWN":0,"TYPE_DOUBLE":1,"TYPE_FLOAT":2,"TYPE_INT64":3,"TYPE_UINT64":4,"TYPE_INT32":5,"TYPE_FIXED64":6,"TYPE_FIXED32":7,"TYPE_BOOL":8,"TYPE_STRING":9,"TYPE_GROUP":10,"TYPE_MESSAGE":11,"TYPE_BYTES":12,"TYPE_UINT32":13,"TYPE_ENUM":14,"TYPE_SFIXED32":15,"TYPE_SFIXED64":16,"TYPE_SINT32":17,"TYPE_SINT64":18}},"Cardinality":{"values":{"CARDINALITY_UNKNOWN":0,"CARDINALITY_OPTIONAL":1,"CARDINALITY_REQUIRED":2,"CARDINALITY_REPEATED":3}}}},"Enum":{"fields":{"name":{"type":"string","id":1},"enumvalue":{"rule":"repeated","type":"EnumValue","id":2},"options":{"rule":"repeated","type":"Option","id":3},"sourceContext":{"type":"SourceContext","id":4},"syntax":{"type":"Syntax","id":5}}},"EnumValue":{"fields":{"name":{"type":"string","id":1},"number":{"type":"int32","id":2},"options":{"rule":"repeated","type":"Option","id":3}}},"Option":{"fields":{"name":{"type":"string","id":1},"value":{"type":"Any","id":2}}},"Syntax":{"values":{"SYNTAX_PROTO2":0,"SYNTAX_PROTO3":1}},"Any":{"fields":{"type_url":{"type":"string","id":1},"value":{"type":"bytes","id":2}}},"SourceContext":{"fields":{"fileName":{"type":"string","id":1}}}}}}}}}')}};