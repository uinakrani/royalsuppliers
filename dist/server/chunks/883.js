"use strict";exports.id=883,exports.ids=[883],exports.modules={32883:(e,t,r)=>{let o,n;r.d(t,{KY:()=>exportAndUploadBackup,oF:()=>getLastBackupTime,Ee:()=>isBackupNeeded});var a=r(70720),s=r(49254);function getServerFirestore(){if(n)return n;let e=function(){let e=process.env.NEXT_PUBLIC_ENVIRONMENT||"production";return"development"===e?{apiKey:"AIzaSyBtdktQETLP05zYNcPc7GKua21dgEgBjaI",authDomain:"orders-38fca-8461e.firebaseapp.com",projectId:"orders-38fca",storageBucket:"orders-38fca.firebasestorage.app",messagingSenderId:"38529807574",appId:"1:38529807574:web:82386c4656d1e75b828577"}:{apiKey:"AIzaSyBtdktQETLP05zYNcPc7GKua21dgEgBjaI",authDomain:"orders-38fca.firebaseapp.com",projectId:"orders-38fca",storageBucket:"orders-38fca.firebasestorage.app",messagingSenderId:"38529807574",appId:"1:38529807574:web:041ccaa44087a14d828577"}}();if(!e.apiKey||!e.projectId||!e.appId)throw Error("Firebase configuration is missing for server-side operations");let t=(0,s.C6)();return o=t.length>0?t[0]:(0,s.ZF)(e),n=(0,a.ad)(o)}let c=["orders","ledgerEntries","invoices","partyPayments"];async function exportAndUploadBackup(e="daily"){try{let t=getServerFirestore(),r={exportDate:new Date().toISOString(),projectId:"orders-38fca",backupType:e};for(let e of(console.log(`ğŸ“¦ Exporting ${c.length} collections...`),c))try{let o=(0,a.hJ)(t,e),n=await (0,a.PL)(o),s=[];n.forEach(e=>{let t=e.data(),r=function processDocument(e){if(null==e)return e;if(e&&"function"==typeof e.toDate)try{return e.toDate().toISOString()}catch(t){if(void 0!==e.seconds){let t=new Date(1e3*e.seconds+(e.nanoseconds||0)/1e6);return t.toISOString()}return e.toString()}if(e&&"object"==typeof e&&"seconds"in e&&"nanoseconds"in e)try{let t=new Date(1e3*e.seconds+(e.nanoseconds||0)/1e6);return t.toISOString()}catch(t){return e.toString()}if(Array.isArray(e))return e.map(e=>processDocument(e));if("object"==typeof e&&!(e instanceof Date)){let t={};for(let r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=processDocument(e[r]));return t}return e instanceof Date?e.toISOString():e}(t);s.push({id:e.id,...r})}),r[e]=s,console.log(`   âœ… Exported ${s.length} ${e}`)}catch(t){console.error(`   âŒ Error exporting ${e}:`,t.message),r[e]=[]}let o=new Date,n=o.toISOString().split("T")[0],s=o.toTimeString().split(" ")[0].replace(/:/g,"-"),i=`backup-${n}-${s}`,l=`backups/daily/db-dump-${n}-${s}.json`,d=(0,a.JU)((0,a.hJ)(t,"backups"),i);console.log(`ğŸ“¤ Storing backup in Firestore: ${i}`),await (0,a.pl)(d,{...r,fileName:l,backupId:i,size:JSON.stringify(r).length,collectionCounts:{orders:r.orders?.length||0,ledgerEntries:r.ledgerEntries?.length||0,invoices:r.invoices?.length||0,partyPayments:r.partyPayments?.length||0},createdAt:new Date().toISOString()}),console.log(`âœ… Backup stored successfully in Firestore!`),console.log(`ğŸ§¹ Starting cleanup of old backups...`);try{let e=await cleanupOldBackups();e.success&&e.deletedCount&&console.log(`âœ… Cleaned up ${e.deletedCount} old backup(s)`)}catch(e){console.warn(`âš ï¸  Cleanup failed (non-fatal):`,e.message)}return{success:!0,backupId:i,fileName:l}}catch(e){return console.error("âŒ Backup failed:",e),{success:!1,error:e.message||"Unknown error"}}}async function getLastBackupTime(){try{let e=getServerFirestore(),t=(0,a.hJ)(e,"backups"),r=(0,a.IO)(t,(0,a.Xo)("createdAt","desc"),(0,a.b9)(1)),o=await (0,a.PL)(r);if(o.empty)return null;let n=o.docs[0].data(),s=n.createdAt;if(s instanceof Date)return s;if("string"==typeof s)return new Date(s);if(s&&"function"==typeof s.toDate)return s.toDate();if(s&&s.seconds)return new Date(1e3*s.seconds);if(n.exportDate)return new Date(n.exportDate);return null}catch(e){return console.error("Error getting last backup time:",e),null}}async function isBackupNeeded(){let e=await getLastBackupTime();if(!e)return!0;let t=new Date,r=(t.getTime()-e.getTime())/36e5;return r>=12}async function cleanupOldBackups(){try{let e=getServerFirestore(),t=(0,a.hJ)(e,"backups"),r=new Date;r.setMonth(r.getMonth()-3),console.log(`ğŸ§¹ Cleaning up backups older than ${r.toISOString()}`);let o=await (0,a.PL)(t),n=0,s=[];return o.forEach(t=>{let o=t.data(),c=null;if(o.createdAt&&(o.createdAt instanceof Date?c=o.createdAt:"string"==typeof o.createdAt?c=new Date(o.createdAt):o.createdAt.toDate?c=o.createdAt.toDate():o.createdAt.seconds&&(c=new Date(1e3*o.createdAt.seconds))),!c&&o.exportDate&&(c=new Date(o.exportDate)),!c||isNaN(c.getTime())){console.warn(`âš ï¸  Could not determine date for backup ${t.id}, skipping`);return}if(c<r){let r=(0,a.oe)((0,a.JU)(e,"backups",t.id));s.push(r.then(()=>{n++,console.log(`   ğŸ—‘ï¸  Deleted old backup: ${t.id} (${c?.toISOString()})`)}))}}),await Promise.all(s),console.log(`âœ… Cleanup completed: ${n} old backup(s) deleted`),{success:!0,deletedCount:n}}catch(e){return console.error("âŒ Cleanup failed:",e),{success:!1,error:e.message||"Unknown error"}}}}};