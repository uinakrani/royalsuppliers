"use strict";exports.id=512,exports.ids=[512],exports.modules={90706:(e,t,r)=>{r.d(t,{u:()=>n});var a=r(60755),i=r(29904);let o="ledgerActivities",n={async logActivity(e){let t=(0,a.z)();if(!t)throw Error("Firebase is not configured.");let r={ledgerEntryId:e.ledgerEntryId,activityType:e.activityType,timestamp:new Date().toISOString(),timestampTs:i.EK.now()};void 0!==e.amount&&(r.amount=e.amount),void 0!==e.previousAmount&&(r.previousAmount=e.previousAmount),void 0!==e.note&&(r.note=e.note||null),void 0!==e.previousNote&&(r.previousNote=e.previousNote||null),void 0!==e.date&&(r.date=e.date||null),void 0!==e.previousDate&&(r.previousDate=e.previousDate||null),void 0!==e.supplier&&(r.supplier=e.supplier||null),void 0!==e.previousSupplier&&(r.previousSupplier=e.previousSupplier||null),void 0!==e.partyName&&(r.partyName=e.partyName||null),void 0!==e.previousPartyName&&(r.previousPartyName=e.previousPartyName||null),void 0!==e.type&&(r.type=e.type||null),void 0!==e.previousType&&(r.previousType=e.previousType||null);let n=await (0,i.ET)((0,i.hJ)(t,o),r);return n.id},async getActivities(e,t){let r=(0,a.z)();if(!r)return[];let n=(0,i.IO)((0,i.hJ)(r,o),(0,i.Xo)("timestampTs","desc")),d=await (0,i.PL)(n),l=[];return d.forEach(r=>{let a=r.data(),i=a.timestamp||a.timestampTs&&a.timestampTs.toDate().toISOString()||new Date().toISOString();if(e){let t=new Date(e);if(t.setHours(0,0,0,0),new Date(i)<t)return}if(t){let e=new Date(t);if(e.setHours(23,59,59,999),new Date(i)>e)return}l.push({id:r.id,ledgerEntryId:a.ledgerEntryId,activityType:a.activityType,timestamp:i,amount:a.amount,previousAmount:a.previousAmount,note:a.note,previousNote:a.previousNote,date:a.date,previousDate:a.previousDate,supplier:a.supplier,previousSupplier:a.previousSupplier,partyName:a.partyName,previousPartyName:a.previousPartyName,type:a.type,previousType:a.previousType})}),l},subscribe(e,t,r){let n=(0,a.z)();if(!n)return()=>{};let d=(0,i.IO)((0,i.hJ)(n,o),(0,i.Xo)("timestampTs","desc"));return(0,i.cf)(d,a=>{let i=[];a.forEach(e=>{let a=e.data(),o=a.timestamp||a.timestampTs&&a.timestampTs.toDate().toISOString()||new Date().toISOString();if(t){let e=new Date(t);if(e.setHours(0,0,0,0),new Date(o)<e)return}if(r){let e=new Date(r);if(e.setHours(23,59,59,999),new Date(o)>e)return}i.push({id:e.id,ledgerEntryId:a.ledgerEntryId,activityType:a.activityType,timestamp:o,amount:a.amount,previousAmount:a.previousAmount,note:a.note,previousNote:a.previousNote,date:a.date,previousDate:a.previousDate,supplier:a.supplier,previousSupplier:a.previousSupplier,partyName:a.partyName,previousPartyName:a.previousPartyName,type:a.type,previousType:a.previousType})}),e(i)},t=>{console.error("Error subscribing to activities:",t),e([])})}}},9909:(e,t,r)=>{r.d(t,{ledgerService:()=>s});var a=r(29904),i=r(60755),o=r(90706),n=r(59233),d=r(37317);let l="ledgerEntries",s={async addEntry(e,t,r,s="manual",u,p,m){let y=(0,i.z)();if(!y)throw Error("Firebase is not configured.");let c=new Date().toISOString(),g=u||c;if(u&&!u.includes("T")){let[e,t,r]=u.split("-").map(Number),a=new Date(e,t-1,r,12,0,0);g=a.toISOString()}let v={type:e,amount:t,date:g,createdAt:c,source:s};r&&r.trim()&&(v.note=r.trim()),p&&p.trim()&&(v.supplier=p.trim()),m&&m.trim()&&(v.partyName=m.trim());let f=await (0,a.ET)((0,a.hJ)(y,l),{...v,createdAtTs:(0,a.Bt)()});if("debit"===e&&p&&p.trim())try{let e=await this.list(),a=e.map(e=>e.id).filter(Boolean);a.push(f.id),await n.XK.reconcileSupplierOrders(p.trim(),a),n.XK.distributePaymentToSupplierOrders(p.trim(),t,f.id,r).catch(e=>console.error("Failed to distribute supplier payment:",e))}catch(e){console.error("Error initiating payment distribution:",e)}if("credit"===e&&m&&m.trim())try{d.s.distributePaymentToPartyOrders(m.trim(),t,f.id,g,r).catch(e=>console.error("Failed to distribute party payment:",e))}catch(e){console.error("Error initiating party payment distribution:",e)}try{await o.u.logActivity({ledgerEntryId:f.id,activityType:"created",amount:t,note:r,date:g,supplier:p,partyName:m,type:e})}catch(e){console.error("Failed to log ledger activity for creation:",e)}return f.id},async list(){let e=(0,i.z)();if(!e)return[];let t=(0,a.IO)((0,a.hJ)(e,l),(0,a.Xo)("date","desc")),r=await (0,a.PL)(t),o=[];return r.forEach(e=>{let t=e.data(),r=t.createdAt??(t.createdAtTs&&t.createdAtTs.toDate().toISOString())??void 0,a=t.date;a&&"function"==typeof a.toDate&&(a=a.toDate().toISOString()),o.push({id:e.id,type:t.type,amount:t.amount,note:t.note,date:a,source:t.source,supplier:t.supplier,partyName:t.partyName,...r?{createdAt:r}:{}})}),o.sort((e,t)=>{let r=e.createdAt?new Date(e.createdAt).getTime():e.date?new Date(e.date).getTime():0,a=t.createdAt?new Date(t.createdAt).getTime():t.date?new Date(t.date).getTime():0;return a-r}),o},subscribe(e){let t=(0,i.z)();if(!t)return()=>{};let r=(0,a.IO)((0,a.hJ)(t,l),(0,a.Xo)("date","desc"));return(0,a.cf)(r,t=>{let r=[];t.forEach(e=>{let t=e.data(),a=t.createdAt??(t.createdAtTs&&t.createdAtTs.toDate().toISOString())??void 0,i=t.date;i&&"function"==typeof i.toDate&&(i=i.toDate().toISOString()),r.push({id:e.id,type:t.type,amount:t.amount,note:t.note,date:i,source:t.source,supplier:t.supplier,partyName:t.partyName,...a?{createdAt:a}:{}})}),r.sort((e,t)=>{let r=e.createdAt?new Date(e.createdAt).getTime():e.date?new Date(e.date).getTime():0,a=t.createdAt?new Date(t.createdAt).getTime():t.date?new Date(t.date).getTime():0;return a-r}),e(r)})},async getBalance(){let e=await this.list();return e.reduce((e,t)=>e+("credit"===t.type?t.amount:-t.amount),0)},async remove(e){let t=(0,i.z)();if(!t)throw Error("Firebase is not configured.");let r=null;try{r=await this.getEntryById(e)}catch(e){console.warn("Failed to get entry before deletion for activity logging:",e)}try{if(console.log("Cleaning up payments for ledger entry:",e),await n.XK.removePaymentsByLedgerEntryId(e),r?.supplier){let t=await this.list(),a=t.map(e=>e.id).filter(t=>t!==e).filter(Boolean);await n.XK.reconcileSupplierOrders(r.supplier,a)}if(r?.partyName){let t=await this.list(),a=t.map(e=>e.id).filter(t=>t!==e).filter(Boolean);await d.s.reconcilePartyPayments(r.partyName,a)}}catch(e){console.error("Failed to cleanup order payments for ledger entry:",e)}await (0,a.oe)((0,a.JU)(t,l,e));try{await o.u.logActivity({ledgerEntryId:e,activityType:"deleted",amount:r?.amount,note:r?.note,date:r?.date,supplier:r?.supplier,partyName:r?.partyName,type:r?.type})}catch(e){console.error("Failed to log ledger activity for deletion:",e)}},async removeLastEntry(){let e=await this.list();if(0===e.length)throw Error("No ledger entries found");let t=e[0];if(!t.id)throw Error("Last entry does not have an ID");await this.remove(t.id)},async getEntryById(e){let t=(0,i.z)();if(!t)return null;try{let r=(0,a.JU)(t,l,e),i=await (0,a.QT)(r);if(!i.exists())return null;let o=i.data(),n=o.createdAt??(o.createdAtTs&&o.createdAtTs.toDate().toISOString())??void 0,d=o.date;return d&&"function"==typeof d.toDate&&(d=d.toDate().toISOString()),{id:i.id,type:o.type,amount:o.amount,note:o.note,date:d,source:o.source,supplier:o.supplier,partyName:o.partyName,...n?{createdAt:n}:{}}}catch(e){return console.error("Error getting ledger entry by ID:",e),null}},async update(e,t,r={}){let s=(0,i.z)();if(!s)throw Error("Firebase is not configured.");let u=await this.getEntryById(e),p=(0,a.JU)(s,l,e),m={},y=new Date().toISOString();if(m.date=y,void 0!==t.amount&&(m.amount=t.amount),void 0!==t.note&&(t.note&&t.note.trim()?m.note=t.note.trim():m.note=null),void 0!==t.supplier&&(t.supplier&&t.supplier.trim()?m.supplier=t.supplier.trim():m.supplier=null),void 0!==t.partyName&&(t.partyName&&t.partyName.trim()?m.partyName=t.partyName.trim():m.partyName=null),await (0,a.r7)(p,m),!r.fromOrder)try{await n.XK.updatePaymentByLedgerEntryId(e,{amount:t.amount,date:m.date})}catch(e){console.error("Failed to sync ledger update to order payment:",e)}let c=u?.type,g=void 0!==m.supplier?m.supplier:u?.supplier;if("debit"===c&&g)try{console.log(`ðŸ”„ Triggering redistribution for updated supplier ledger entry ${e}`),await n.XK.redistributeSupplierPayment(e,m.date)}catch(e){console.error("Redistribution failed",e)}let v=void 0!==m.partyName?m.partyName:u?.partyName;if("credit"===c&&v)try{console.log(`ðŸ”„ Triggering redistribution for updated party payment ledger entry ${e}`);let t=await this.list(),r=t.map(e=>e.id).filter(Boolean);await d.s.reconcilePartyPayments(v,r);let a=t.filter(e=>e.partyName===v&&"credit"===e.type);for(let e of a)e.id&&await d.s.distributePaymentToPartyOrders(v,e.amount,e.id,e.date,e.note)}catch(e){console.error("Party payment redistribution failed",e)}try{let r=(u?.note||"").trim()||void 0,a=void 0!==t.note?(t.note||"").trim()||void 0:r,i=u?.amount,n=void 0!==t.amount?t.amount:i,d=u?.date,l=m.date,s=(u?.supplier||"").trim()||void 0,p=void 0!==t.supplier?t.supplier?.trim()||void 0:s,y=(u?.partyName||"").trim()||void 0,c=void 0!==t.partyName?t.partyName?.trim()||void 0:y,g=i!==n||r!==a||d!==l||s!==p||y!==c;if(!g){console.log("No changes detected for ledger entry update, skipping activity log.");return}let v={ledgerEntryId:e,activityType:"updated",amount:n,previousAmount:i,note:a,previousNote:r,date:l,previousDate:d,supplier:p,previousSupplier:s,partyName:c,previousPartyName:y,type:u?.type};console.log("\uD83D\uDCDD Logging ledger activity for update:",{ledgerEntryId:e,activityType:"updated",hasChanges:g}),await o.u.logActivity(v),console.log("âœ… Activity logged successfully")}catch(e){console.error("âŒ Failed to log ledger activity for update:",e)}}}},37317:(e,t,r)=>{r.d(t,{s:()=>n});var a=r(29904),i=r(60755),o=r(59233);let calculateRevenueAdjustment=(e,t)=>{if(!t||0===t.length)return 0;let r=Number(e||0),a=t.reduce((e,t)=>e+Number(t.amount||0),0),i=a-r;return .01>Math.abs(i)?0:Number(i.toFixed(2))},n={async getAllPayments(){let e=(0,i.z)();if(!e)return[];let t=[],r=(0,a.IO)((0,a.hJ)(e,"partyPayments"),(0,a.Xo)("date","desc")),o=await (0,a.PL)(r);return o.forEach(e=>{let r=e.data(),a=r.date;a&&"function"==typeof a.toDate&&(a=r.date.toDate().toISOString());let i=r.createdAt;i&&"function"==typeof i.toDate&&(i=i.toDate().toISOString());let o=r.updatedAt;o&&"function"==typeof o.toDate&&(o=o.toDate().toISOString()),t.push({id:e.id,partyName:r.partyName,amount:Number(r.amount||0),date:a,ledgerEntryId:r.ledgerEntryId,note:r.note??null,createdAt:i,updatedAt:o})}),t.sort((e,t)=>{let r=e.date?new Date(e.date).getTime():0,a=t.date?new Date(t.date).getTime():0;return a-r}),t},async addPayment(e,t,o){let n=(0,i.z)();if(!n)throw Error("Firebase is not configured.");if(!e?.trim())throw Error("Party name is required");if(!t||t<=0)throw Error("Payment amount must be greater than zero");let d=e.trim(),l=new Date().toISOString(),s=o?.trim(),{ledgerService:u}=await Promise.resolve().then(r.bind(r,9909)),p=await u.addEntry("credit",t,s,"partyPayment",l,void 0,d);await (0,a.ET)((0,a.hJ)(n,"partyPayments"),{partyName:d,amount:t,date:l,note:s||null,ledgerEntryId:p,createdAt:l,updatedAt:l})},async removePayment(e){let t=(0,i.z)();if(!t)throw Error("Firebase is not configured.");if(!e)throw Error("Payment ID is required");let o=(0,a.JU)(t,"partyPayments",e),n=await (0,a.QT)(o);if(!n.exists())throw Error("Payment not found");let d=n.data(),l=d.ledgerEntryId;if(l){let{ledgerService:e}=await Promise.resolve().then(r.bind(r,9909));await e.remove(l)}await (0,a.oe)(o)},async distributePaymentToPartyOrders(e,t,r,n,d){let l=(0,i.z)();if(!l)return;console.log(`ðŸ”„ Distributing income of â‚¹${t} to party: ${e}`);let s=await o.XK.getAllOrders({partyName:e}),u=s.filter(e=>!e.partyPaid);u.sort((e,t)=>new Date(e.date).getTime()-new Date(t.date).getTime()),console.log(`Found ${u.length} unpaid orders for party ${e}`);let p=t,m=(0,a.qs)(l);for(let e of u){if(p<=0)break;if(!e.id)continue;let t=e.total||0,i=e.customerPayments||[],o=i.reduce((e,t)=>e+t.amount,0),s=Math.max(0,t-o);if(s<=0)continue;let u=Math.min(p,s),y=new Date().toISOString(),c={id:Date.now().toString()+Math.random().toString(36).substr(2,9),amount:u,date:n,createdAt:y,ledgerEntryId:r,note:d||"Auto-distributed from party payment"},g=[...i,c],v=o+u,f=v>=t-250,w=(0,a.JU)(l,"orders",e.id);m.update(w,{customerPayments:g,partyPaid:f,revenueAdjustment:calculateRevenueAdjustment(t,g)}),console.log(`âœ… Applied â‚¹${u} to order ${e.id}`),p-=u}if(p>0&&u.length>0){let e=u[u.length-1];if(e&&e.id){console.log(`ðŸ’° Overpayment of â‚¹${p} detected. Applying to order ${e.id} as profit adjustment.`);let t=(0,a.JU)(l,"orders",e.id);e.adjustmentAmount;let r=Number(e.revenueAdjustment||0);m.update(t,{revenueAdjustment:r+p})}}await m.commit(),console.log("âœ… Party payment distribution complete.")},async reconcilePartyPayments(e,t){let r=(0,i.z)();if(!r)return;let n=new Set(t);console.log(`ðŸ”„ Reconciling payments for party: ${e}`);let d=await o.XK.getAllOrders({partyName:e}),l=(0,a.qs)(r);for(let e of d){if(!e.id||!e.customerPayments||0===e.customerPayments.length)continue;let t=e.customerPayments.filter(e=>!e.ledgerEntryId||n.has(e.ledgerEntryId));if(t.length<e.customerPayments.length){let i=(0,a.JU)(r,"orders",e.id),o=t.reduce((e,t)=>e+t.amount,0),n=o>=(e.total||0)-250;l.update(i,{customerPayments:t,partyPaid:n,revenueAdjustment:calculateRevenueAdjustment(e.total||0,t)}),console.log(`ðŸ§¹ Cleaned up orphan customer payments from order ${e.id}`)}}await l.commit(),console.log("âœ… Party payment reconciliation complete.")}}}};