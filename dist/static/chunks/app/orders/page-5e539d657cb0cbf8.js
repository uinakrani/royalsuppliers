(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[569],{42482:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r.Z)("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]])},96142:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r.Z)("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]])},85790:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r.Z)("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]])},11961:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r.Z)("Truck",[["path",{d:"M5 18H3c-.6 0-1-.4-1-1V7c0-.6.4-1 1-1h10c.6 0 1 .4 1 1v11",key:"hs4xqm"}],["path",{d:"M14 9h4l4 4v4c0 .6-.4 1-1 1h-2",key:"11fp61"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}]])},39781:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let s=(0,r.Z)("Weight",[["circle",{cx:"12",cy:"5",r:"3",key:"rqqgnr"}],["path",{d:"M6.5 8a2 2 0 0 0-1.905 1.46L2.1 18.5A2 2 0 0 0 4 21h16a2 2 0 0 0 1.925-2.54L19.4 9.5A2 2 0 0 0 17.48 8Z",key:"56o5sh"}]])},94172:function(e,t,a){Promise.resolve().then(a.bind(a,64540))},64540:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return OrdersPage}});var r=a(57437),s=a(2265),n=a(70349),i=a(98025),l=a(27056),d=a(74931),o=a(61444),c=a(74513),m=a(28521),x=a(76637),u=a(45367),p=a(67972),g=a(9883),y=a(17158),h=a(4322),f=a(28203),b=a(42482),j=a(62898);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let v=(0,j.Z)("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]);var N=a(82549),w=a(54887);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let P=(0,j.Z)("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var C=a(66908);function PaymentEditPopup(e){let{isOpen:t,onClose:a,onSave:n,initialData:i,maxAmount:l}=e,[o,c]=(0,s.useState)(!1),[m,x]=(0,s.useState)(!1),[u,p]=(0,s.useState)(!1),[g,y]=(0,s.useState)("amount"),h=(0,s.useRef)(null),f=(0,s.useRef)(null),[b,j]=(0,s.useState)(""),[v,k]=(0,s.useState)(""),[S,I]=(0,s.useState)({});(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");p(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(t?(document.body.style.overflow="hidden",c(!1),x(!1),y("amount"),j(i.amount.toString()),k(new Date(i.date).toISOString().split("T")[0]),I({}),requestAnimationFrame(()=>{x(!0)})):(x(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[t,i]);let handleClose=()=>{c(!0),x(!1),setTimeout(()=>{a(),c(!1)},250)},handleSave=()=>{let e=parseFloat(b);if(!b||isNaN(e)||e<=0){I({amount:"Please enter a valid amount"}),y("amount");return}if(l&&e>l){I({amount:"Amount cannot exceed ".concat((0,d.formatIndianCurrency)(l))}),y("amount");return}if(!v){I({date:"Please select a date"}),y("date");return}n({amount:e,date:v}),handleClose()};if(!t)return null;let T=(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{ref:h,onClick:e=>{e.target===h.current&&handleClose()},className:"fixed inset-0 bg-black/50 z-[99999] popup-backdrop ".concat(o?"native-backdrop-exit":m?"native-backdrop-enter":"opacity-0"),style:{willChange:"opacity",WebkitTapHighlightColor:"transparent",touchAction:"none",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999}}),(0,r.jsx)("div",{className:"fixed inset-0 z-[99999] flex items-center justify-center pointer-events-none popup-container",style:{WebkitTapHighlightColor:"transparent",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999,padding:"1rem",paddingLeft:"max(1rem, env(safe-area-inset-left, 0px))",paddingRight:"max(1rem, env(safe-area-inset-right, 0px))"},children:(0,r.jsxs)("div",{ref:f,className:"bg-white rounded-2xl border border-gray-100 max-w-sm w-full pointer-events-auto flex flex-col ".concat(o?"native-modal-exit":m?"native-modal-enter":"opacity-0 scale-95 translate-y-4"),style:{willChange:"transform, opacity",backfaceVisibility:"hidden",WebkitFontSmoothing:"antialiased",maxHeight:"calc(100dvh - 2rem - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px))"},children:[(0,r.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200",children:["amount"!==g&&(0,r.jsx)("button",{onClick:()=>y("amount"),className:"p-2 -ml-2 active:bg-gray-100 rounded-lg transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:(0,r.jsx)(P,{size:20})}),(0,r.jsx)("h2",{className:"text-lg font-bold text-gray-900 flex-1 text-center",children:"amount"===g?"Edit Amount":"Edit Date"}),(0,r.jsx)("button",{onClick:handleClose,className:"p-2 -mr-2 active:bg-gray-100 rounded-lg transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},"aria-label":"Close",children:(0,r.jsx)(N.Z,{size:20})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4",style:{WebkitOverflowScrolling:"touch"},children:["amount"===g&&(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Amount *"}),(0,r.jsx)("input",{type:"number",step:"0.01",value:b,onChange:e=>{j(e.target.value),S.amount&&I({})},placeholder:"Enter amount",className:"w-full px-3 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 ".concat(S.amount?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"),style:{fontSize:"16px"},autoFocus:!0}),S.amount&&(0,r.jsx)("p",{className:"mt-1 text-xs text-red-600",children:S.amount}),l&&(0,r.jsxs)("p",{className:"mt-1 text-xs text-gray-500",children:["Maximum: ",(0,d.formatIndianCurrency)(l)]})]})}),"date"===g&&(0,r.jsx)("div",{className:"space-y-4",children:(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Date *"}),(0,r.jsx)("input",{type:"date",value:v,onChange:e=>{k(e.target.value),S.date&&I({})},className:"w-full px-3 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 ".concat(S.date?"border-red-500 focus:ring-red-500":"border-gray-300 focus:ring-primary-500"),style:{fontSize:"16px"},autoFocus:!0}),S.date&&(0,r.jsx)("p",{className:"mt-1 text-xs text-red-600",children:S.date})]})})]}),(0,r.jsx)("div",{className:"flex-shrink-0 border-t border-gray-200 p-4",children:(0,r.jsx)(C.Z,{onClick:()=>{if("amount"===g){let e=parseFloat(b);if(!b||isNaN(e)||e<=0){I({amount:"Please enter a valid amount"});return}if(l&&e>l){I({amount:"Amount cannot exceed ".concat((0,d.formatIndianCurrency)(l))});return}I({}),y("date")}else if("date"===g){if(!v){I({date:"Please select a date"});return}I({}),handleSave()}},variant:"primary",size:"lg",fullWidth:!0,children:"amount"===g?"Next":"Save"})})]})})]});return(0,w.createPortal)(T,document.body)}var k=a(86345),S=a(68286),I=a(42316),T=a(41587),A=a(85790),E=a(41298),D=a(30182),O=a(71037);let safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t};function PartyDetailPopup(e){let{group:t,isOpen:a,onClose:n,onEditOrder:i,onDeleteOrder:o,onOrderClick:c,onPaymentAdded:y,onPaymentRemoved:h}=e,[b,j]=(0,s.useState)(!1),[v,P]=(0,s.useState)(!1),[C,I]=(0,s.useState)(!1),[T,z]=(0,s.useState)(!1),M=(0,s.useRef)(null),Z=(0,s.useRef)(null);(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");z(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(a?(j(!1),P(!1),requestAnimationFrame(()=>{P(!0)}),document.body.style.overflow="hidden"):(P(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[a]);let handleClose=()=>{j(!0),P(!1),setTimeout(()=>{n(),j(!1)},250)},handleAddPayment=async()=>{if(!t||C)return;let e=t.totalSelling-t.totalPaid;try{let a=await S.h.prompt({title:"Add Payment",message:"Remaining balance: ".concat((0,d.formatIndianCurrency)(e)),inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Add Payment",cancelText:"Cancel"});if(!a)return;let r=Math.abs(parseFloat(String(a).replace(/,/g,"")));if(isNaN(r)||r<=0){(0,k.showToast)("Invalid amount","error");return}let s=await S.h.prompt({title:"Payment Note (optional)",inputLabel:"Note",inputPlaceholder:"Add a note (optional)",inputType:"text",required:!1,confirmText:"Save",cancelText:"Skip"});I(!0),await l.s.addPayment(t.partyName,r,s||void 0),(0,k.showToast)("Payment added successfully!","success"),y&&await y()}catch(e){(null==e?void 0:e.message)&&!e.message.includes("SweetAlert")&&(0,k.showToast)("Failed to add payment: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}finally{I(!1)}},handleRemovePayment=async e=>{if(!t||C)return;let a=await S.h.confirm({title:"Remove Payment?",message:"Are you sure you want to remove this payment? This action cannot be undone.",icon:"warning",confirmText:"Remove",cancelText:"Cancel"});if(a)try{I(!0),await l.s.removePayment(e),(0,k.showToast)("Payment removed successfully!","success"),h&&await h()}catch(e){(0,k.showToast)("Failed to remove payment: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}finally{I(!1)}};if(!a||!t)return null;let R=t.totalSelling-t.totalPaid,F=safeParseDate(t.lastPaymentDate),L=(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{ref:M,onClick:e=>{e.target===M.current&&handleClose()},className:"fixed inset-0 bg-black/50 z-[99999] popup-backdrop ".concat(b?"native-backdrop-exit":v?"native-backdrop-enter":"opacity-0"),style:{willChange:"opacity",WebkitTapHighlightColor:"transparent",touchAction:"none",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999}}),(0,r.jsx)("div",{className:"fixed z-[99999] flex items-center justify-center pointer-events-none popup-container",style:{WebkitTapHighlightColor:"transparent",position:"fixed",top:"calc(70px + env(safe-area-inset-top, 0px))",bottom:"4rem",left:0,right:0,padding:"1rem",paddingLeft:"max(1rem, env(safe-area-inset-left, 0px))",paddingRight:"max(1rem, env(safe-area-inset-right, 0px))",zIndex:99999},children:(0,r.jsxs)("div",{ref:Z,className:"bg-white rounded-2xl border border-gray-100 max-w-lg w-full pointer-events-auto flex flex-col ".concat(b?"native-modal-exit":v?"native-modal-enter":"opacity-0 scale-95 translate-y-4"),style:{willChange:"transform, opacity",backfaceVisibility:"hidden",WebkitFontSmoothing:"antialiased",maxHeight:"calc(100dvh - 70px - 4rem - 2rem - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px))"},children:[(0,r.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"p-2 bg-primary-100 rounded-lg",children:(0,r.jsx)(p.Z,{size:20,className:"text-primary-600"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:t.partyName}),t.orders.length>0&&t.orders[0].siteName&&(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-0.5",children:t.orders[0].siteName})]})]}),(0,r.jsx)("button",{onClick:handleClose,className:"p-1.5 rounded-lg active:bg-gray-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},"aria-label":"Close",children:(0,r.jsx)(N.Z,{size:20,className:"text-gray-500"})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{WebkitOverflowScrolling:"touch"},children:[(0,r.jsxs)("div",{className:"bg-primary-50 rounded-lg p-3 border border-primary-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,r.jsx)(A.Z,{size:16,className:"text-primary-600"}),(0,r.jsx)("h3",{className:"font-semibold text-gray-900",children:"Summary"})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Total Selling"}),(0,r.jsx)("span",{className:"text-sm font-bold text-gray-900",children:(0,d.formatIndianCurrency)(t.totalSelling)})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Total Profit"}),(0,r.jsx)("span",{className:"text-sm font-bold ".concat(t.totalProfit>=0?"text-green-600":"text-red-600"),children:(0,d.formatIndianCurrency)(t.totalProfit)})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Total Paid"}),(0,r.jsx)("span",{className:"text-sm font-bold text-green-600",children:(0,d.formatIndianCurrency)(t.totalPaid)})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t border-primary-200",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"Balance"}),(0,r.jsxs)("span",{className:"text-sm font-bold ".concat(R>0?"text-red-600":"text-green-600"),children:[(0,d.formatIndianCurrency)(Math.abs(R)),R>0?" (Due)":" (Overpaid)"]})]}),F&&null!==t.lastPaymentAmount&&(0,r.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t border-primary-200",children:[(0,r.jsx)("span",{className:"text-sm text-gray-600",children:"Last Payment"}),(0,r.jsxs)("span",{className:"text-sm font-semibold text-gray-900",children:[(0,m.ZP)(F,"dd MMM yyyy")," (",(0,d.formatIndianCurrency)(t.lastPaymentAmount),")"]})]})]})]}),(0,r.jsxs)("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-200",children:[(0,r.jsx)("div",{className:"flex items-center justify-between mb-3",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(x.Z,{size:16,className:"text-blue-600"}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Orders (",t.orders.length,")"]})]})}),(0,r.jsx)("div",{className:"space-y-1.5",children:t.orders.map((e,t)=>{let a=safeParseDate(e.date),s=Array.isArray(e.material)?e.material:e.material?[e.material]:[],n=Number(e.originalTotal||0),i=e.partialPayments||[],l=i.reduce((e,t)=>e+t.amount,0),o=n-l,x=(0,O.I)(e),u=(0,O.w)(e);return(0,r.jsxs)("div",{className:"bg-white rounded-lg p-2 border border-blue-300 transition-all duration-150 active:bg-blue-50 native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden",animation:"fadeInUp 0.2s ease-out ".concat(.03*t,"s both")},onClick:t=>{c&&((0,D.m)(t),handleClose(),setTimeout(()=>c(e),300))},children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-0.5",children:[a&&(0,r.jsx)("span",{className:"text-[9px] text-gray-500",children:(0,m.ZP)(a,"dd MMM")}),(0,r.jsx)("span",{className:"text-xs font-semibold text-gray-900 truncate",children:e.siteName})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1 flex-wrap",children:[s.slice(0,2).map((e,t)=>(0,r.jsx)("span",{className:"bg-primary-50 text-primary-700 px-1 py-0.5 rounded text-[8px] font-medium",children:e},t)),s.length>2&&(0,r.jsxs)("span",{className:"text-[8px] text-gray-500",children:["+",s.length-2]})]})]}),(0,r.jsxs)("div",{className:"text-right ml-2 flex-shrink-0",children:[(0,r.jsx)("p",{className:"text-xs font-bold text-primary-600",children:(0,d.formatIndianCurrency)(e.total)}),(0,r.jsx)("div",{className:"text-[10px] font-semibold mt-0.5 text-right leading-tight",children:u?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("span",{className:"text-gray-500 line-through block",children:["Profit: ",(0,d.formatIndianCurrency)(e.profit)]}),(0,r.jsx)("span",{className:"".concat(x>=0?"text-green-600":"text-red-600"," block"),children:(0,d.formatIndianCurrency)(x)})]}):(0,r.jsxs)("span",{className:"".concat(e.profit>=0?"text-green-600":"text-red-600"),children:["Profit: ",(0,d.formatIndianCurrency)(e.profit)]})})]})]}),n>0&&(0,r.jsxs)("div",{className:"flex items-center justify-between pt-1 border-t border-gray-100 text-[9px]",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Exp:"}),(0,r.jsx)("span",{className:"text-gray-700",children:(0,d.formatIndianCurrency)(n)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Paid:"}),(0,r.jsx)("span",{className:"".concat(l>0?"text-green-600":"text-gray-600"),children:(0,d.formatIndianCurrency)(l)})]}),o>0&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Rem:"}),(0,r.jsx)("span",{className:"text-red-600",children:(0,d.formatIndianCurrency)(o)})]})]})]},e.id)})})]}),(0,r.jsxs)("div",{className:"bg-green-50 rounded-lg p-3 border border-green-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(E.Z,{size:16,className:"text-green-600"}),(0,r.jsxs)("h3",{className:"font-semibold text-gray-900",children:["Payment History (",t.payments.length,")"]})]}),(0,r.jsxs)("button",{onClick:e=>{(0,D.m)(e),handleAddPayment()},disabled:C,className:"flex items-center gap-1.5 px-2 py-1 bg-green-600 text-white rounded-lg text-xs font-medium hover:bg-green-700 active:bg-green-800 transition-colors touch-manipulation native-press disabled:opacity-50 disabled:cursor-not-allowed",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:[(0,r.jsx)(g.Z,{size:14}),"Add Payment"]})]}),t.payments.length>0?(0,r.jsx)("div",{className:"space-y-2",children:t.payments.map((e,t)=>{let a=safeParseDate(e.payment.date);return(0,r.jsx)("div",{className:"bg-white rounded-lg p-2.5 border border-green-300 transition-all duration-200 active:bg-green-50",style:{animation:"fadeInUp 0.3s ease-out ".concat(.05*t,"s both")},children:(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-sm font-bold text-gray-900",children:(0,d.formatIndianCurrency)(e.payment.amount)}),a&&(0,r.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,r.jsx)(f.Z,{size:12,className:"text-gray-400"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:(0,m.ZP)(a,"dd MMM yyyy HH:mm")})]}),e.payment.note&&(0,r.jsx)("p",{className:"text-xs text-gray-600 mt-1",children:e.payment.note})]}),!e.ledgerEntryId&&(0,r.jsx)("button",{onClick:t=>{(0,D.m)(t),handleRemovePayment(e.payment.id)},disabled:C,className:"p-1.5 bg-red-50 text-red-600 rounded hover:bg-red-100 active:bg-red-200 transition-colors touch-manipulation native-press disabled:opacity-50 disabled:cursor-not-allowed",title:"Remove Payment",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:(0,r.jsx)(u.Z,{size:14})}),e.ledgerEntryId&&(0,r.jsx)("span",{className:"text-[9px] text-gray-400 px-2 py-1 bg-gray-100 rounded",title:"Linked to ledger entry - edit in ledger",children:"From Ledger"})]})},"".concat(e.invoiceId,"-").concat(e.payment.id,"-").concat(t))})}):(0,r.jsx)("div",{className:"bg-white border border-green-300 rounded-lg p-4 text-center",children:(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"No payments recorded"})})]})]})]})})]});return(0,w.createPortal)(L,document.body)}var z=a(11961);let OrderDetailPopup_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t},M="manual-party-adjustment";function OrderDetailPopup(e){let{order:t,isOpen:a,onClose:i,onEdit:l,onDelete:o,onEditPayment:c,onRemovePayment:g,onOrderUpdated:y}=e,[b,j]=(0,s.useState)(!1),[P,C]=(0,s.useState)(!1),[I,T]=(0,s.useState)(!1),D=(0,s.useRef)(null),O=(0,s.useRef)(null),[Z,R]=(0,s.useState)(""),[F,L]=(0,s.useState)(!1);(0,s.useEffect)(()=>{if(t){let e=(t.customerPayments||[]).reduce((e,t)=>e+t.amount,0),a=e>0?e:t.total;R(a.toString())}},[t]);let handleSaveAdjustment=async()=>{if(!(null==t?void 0:t.id))return;let e=parseFloat(Z);if(isNaN(e)||e<0){(0,k.showToast)("Invalid amount","error");return}let a=t.customerPayments||[],r=a.find(e=>e.id===M),s=a.filter(e=>e.id!==M),i=s.reduce((e,t)=>e+t.amount,0);if(e+.01<i){(0,k.showToast)("Actual amount cannot be less than recorded receipts (".concat((0,d.formatIndianCurrency)(i),")"),"error");return}let l=Number((e-i).toFixed(2)),o=[...s];if(l>.01){let e=(null==r?void 0:r.createdAt)||new Date().toISOString();o.push({id:(null==r?void 0:r.id)||M,amount:l,date:e,createdAt:e,note:"Manual adjustment via order details"})}try{await n.XK.updateOrder(t.id,{customerPayments:o}),L(!1),R(e.toString()),y&&await y(),(0,k.showToast)("Party payment saved","success")}catch(e){console.error(e),(0,k.showToast)("Failed to save party payment","error")}};(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");T(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(a?(j(!1),C(!1),requestAnimationFrame(()=>{C(!0)}),document.body.style.overflow="hidden"):(C(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[a]);let handleClose=()=>{j(!0),C(!1),setTimeout(()=>{i(),j(!1)},250)},handleDelete=async()=>{if(!(null==t?void 0:t.id))return;let e=await S.h.confirm({title:"Delete Order?",message:"Are you sure you want to delete this order? This action cannot be undone.",icon:"warning",confirmText:"Delete",cancelText:"Cancel"});e&&(o(t.id),handleClose())};if(!a||!t)return null;let W=OrderDetailPopup_safeParseDate(t.date),H=Array.isArray(t.material)?t.material:t.material?[t.material]:[],_=t.partialPayments||[],B=_.reduce((e,t)=>e+t.amount,0),q=(t.customerPayments||[]).reduce((e,t)=>e+t.amount,0),K=_.reduce((e,t)=>e+t.amount,0),U=Number(t.expenseAdjustment||0),X=Number(t.revenueAdjustment||0),G=Number(t.adjustmentAmount||0),V=t.profit+U+X+G,Y=q-K-t.additionalCost+G,J=(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{ref:D,onClick:e=>{e.target===D.current&&handleClose()},className:"fixed inset-0 bg-black/50 z-[99999] popup-backdrop ".concat(b?"native-backdrop-exit":P?"native-backdrop-enter":"opacity-0"),style:{willChange:"opacity",WebkitTapHighlightColor:"transparent",touchAction:"none",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999}}),(0,r.jsx)("div",{className:"fixed z-[99999] flex items-center justify-center pointer-events-none popup-container",style:{WebkitTapHighlightColor:"transparent",position:"fixed",top:"calc(70px + env(safe-area-inset-top, 0px))",bottom:"4rem",left:0,right:0,padding:"1rem",paddingLeft:"max(1rem, env(safe-area-inset-left, 0px))",paddingRight:"max(1rem, env(safe-area-inset-right, 0px))",zIndex:99999},children:(0,r.jsxs)("div",{ref:O,className:"bg-white rounded-2xl border border-gray-100 max-w-lg w-full pointer-events-auto flex flex-col ".concat(b?"native-modal-exit":P?"native-modal-enter":"opacity-0 scale-95 translate-y-4"),style:{willChange:"transform, opacity",backfaceVisibility:"hidden",WebkitFontSmoothing:"antialiased",maxHeight:"calc(100dvh - 70px - 4rem - 2rem - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px))"},children:[(0,r.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:"Order Details"}),(0,r.jsx)("button",{onClick:handleClose,className:"p-1.5 rounded-lg active:bg-gray-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},"aria-label":"Close",children:(0,r.jsx)(N.Z,{size:20,className:"text-gray-500"})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",style:{WebkitOverflowScrolling:"touch"},children:[(0,r.jsxs)("div",{className:"bg-primary-50 rounded-lg p-3 border border-primary-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.Z,{size:16,className:"text-primary-600"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900",children:t.partyName})]}),(0,r.jsx)("span",{className:"text-lg font-bold text-primary-600",children:(0,d.formatIndianCurrency)(t.total)})]}),(0,r.jsx)("div",{className:"text-xs text-gray-600 mt-1",children:t.siteName})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{className:"bg-green-50 rounded-lg p-2.5 border border-green-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)(A.Z,{size:14,className:"text-green-600"}),(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Profit"})]}),(0,r.jsx)("div",{className:"font-bold ".concat(t.profit>=0?"text-green-700":"text-red-600"),style:{fontSize:"14px"},children:(0,d.formatIndianCurrency)(t.profit)})]}),(0,r.jsxs)("div",{className:"bg-blue-50 rounded-lg p-2.5 border border-blue-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)(E.Z,{size:14,className:"text-blue-600"}),(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Raw Payments"})]}),(0,r.jsx)("div",{className:"font-bold text-blue-700",style:{fontSize:"14px"},children:(0,d.formatIndianCurrency)(B)})]}),(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-2.5 border border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)(f.Z,{size:14,className:"text-gray-600"}),(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Date"})]}),(0,r.jsx)("div",{className:"font-semibold text-gray-900",style:{fontSize:"12px"},children:W?(0,m.ZP)(W,"dd MMM yyyy"):"Invalid Date"}),W&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:(0,m.ZP)(W,"hh:mm a")})]}),(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-2.5 border border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)(z.Z,{size:14,className:"text-gray-600"}),(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Truck Owner"})]}),(0,r.jsx)("div",{className:"font-semibold text-gray-900",style:{fontSize:"12px"},children:t.truckOwner}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:t.truckNo})]})]}),(0,r.jsxs)("div",{className:"bg-yellow-50 rounded-lg p-3 border border-yellow-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(E.Z,{size:16,className:"text-yellow-700"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 text-xs",children:"Profit Adjustments"})]}),F?(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:handleSaveAdjustment,className:"text-green-600 text-xs font-bold",children:"Save"}),(0,r.jsx)("button",{onClick:()=>L(!1),className:"text-gray-500 text-xs",children:"Cancel"})]}):(0,r.jsx)("button",{onClick:()=>L(!0),className:"text-primary-600 text-xs font-medium",children:"Adjust Party Payment"})]}),F?(0,r.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600 w-20",children:"Actual Paid:"}),(0,r.jsx)("input",{type:"number",value:Z,onChange:e=>R(e.target.value),className:"flex-1 p-1.5 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-primary-500 outline-none",placeholder:"Enter amount"})]}),(0,r.jsxs)("div",{className:"text-[10px] text-gray-500",children:["Expected Total: ",(0,d.formatIndianCurrency)(t.total)]})]}):(0,r.jsxs)("div",{className:"flex flex-col gap-2 text-xs text-gray-700",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{children:"Realized Profit (Payments)"}),(0,r.jsx)("span",{className:"font-bold ".concat(Y>=0?"text-green-700":"text-red-600"),children:(0,d.formatIndianCurrency)(Y)})]}),(0,r.jsxs)("div",{className:"border-t border-yellow-200 pt-2 space-y-1 text-[10px] text-gray-600",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"Projected Profit (Original)"}),(0,r.jsx)("span",{className:"font-medium text-gray-700",children:(0,d.formatIndianCurrency)(t.profit)})]}),Math.abs(U)>.01&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"Raw Expense Adjustment"}),(0,r.jsx)("span",{className:"".concat(U>=0?"text-green-700":"text-red-600"," font-semibold"),children:(0,d.formatIndianCurrency)(U)})]}),Math.abs(X)>.01&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"Party Payment Adjustment"}),(0,r.jsx)("span",{className:"".concat(X>=0?"text-green-700":"text-red-600"," font-semibold"),children:(0,d.formatIndianCurrency)(X)})]}),Math.abs(G)>.01&&(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"Manual Adjustment"}),(0,r.jsx)("span",{className:"".concat(G>=0?"text-green-700":"text-red-600"," font-semibold"),children:(0,d.formatIndianCurrency)(G)})]}),(0,r.jsxs)("div",{className:"flex justify-between font-semibold text-gray-900 text-xs border-t border-yellow-200 pt-2 mt-1",children:[(0,r.jsx)("span",{children:"Projected Profit (Adjusted)"}),(0,r.jsx)("span",{className:"".concat(V>=0?"text-green-700":"text-red-600"),children:(0,d.formatIndianCurrency)(V)})]})]})]})]}),(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-2.5 border border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-2",children:[(0,r.jsx)(h.Z,{size:14,className:"text-gray-600"}),(0,r.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Material"})]}),(0,r.jsx)("div",{className:"flex flex-wrap gap-1.5",children:H.map((e,t)=>(0,r.jsx)("span",{className:"bg-white px-2 py-1 rounded text-xs font-medium text-gray-700 border border-gray-300",children:e},t))})]}),(0,r.jsxs)("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-200",children:[(0,r.jsx)("div",{className:"flex items-center justify-between mb-3",children:(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(E.Z,{size:16,className:"text-blue-600"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900",children:"Raw Material Payments"})]})}),0===_.length?(0,r.jsx)("div",{className:"text-center text-gray-500 py-4 text-xs",children:"No payments added yet"}):(0,r.jsx)("div",{className:"space-y-2",children:_.map(e=>{let a=OrderDetailPopup_safeParseDate(e.date),s=!!e.ledgerEntryId;return(0,r.jsxs)("div",{className:"bg-white rounded-lg p-2.5 border border-blue-300 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"font-semibold text-gray-900",style:{fontSize:"13px"},children:(0,d.formatIndianCurrency)(e.amount)}),s&&(0,r.jsx)("span",{className:"text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-medium",children:"From Ledger"})]}),a&&(0,r.jsx)("span",{className:"text-xs text-gray-500",children:(0,m.ZP)(a,"dd MMM yyyy")})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[a&&(0,r.jsx)("div",{className:"text-xs text-gray-500",children:(0,m.ZP)(a,"hh:mm a")}),e.note&&(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:["• ",e.note]})]})]}),!s&&(0,r.jsxs)("div",{className:"flex gap-1 ml-2",children:[(0,r.jsx)("button",{onClick:()=>{handleClose(),setTimeout(()=>{c(t,e.id)},300)},className:"p-1.5 bg-blue-100 text-blue-700 rounded active:bg-blue-200 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Edit Payment",children:(0,r.jsx)(v,{size:14})}),(0,r.jsx)("button",{onClick:async()=>{let a=await S.h.confirm({title:"Remove Payment?",message:"Are you sure you want to remove this payment?",icon:"warning"});a&&(g(t,e.id),y&&await y())},className:"p-1.5 bg-red-100 text-red-700 rounded active:bg-red-200 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Remove Payment",children:(0,r.jsx)(u.Z,{size:14})})]})]},e.id)})})]}),(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200 space-y-2",children:[(0,r.jsx)("div",{className:"text-xs font-medium text-gray-700 mb-2",children:"Additional Details"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Weight:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:t.weight.toFixed(2)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Rate:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:(0,d.formatIndianCurrency)(t.rate)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Original Weight:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:t.originalWeight.toFixed(2)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Original Rate:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:(0,d.formatIndianCurrency)(t.originalRate)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Original Total:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:(0,d.formatIndianCurrency)(t.originalTotal)})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Additional Cost:"}),(0,r.jsx)("span",{className:"font-semibold text-gray-900 ml-1",children:(0,d.formatIndianCurrency)(t.additionalCost)})]})]}),(0,r.jsxs)("div",{className:"pt-2 border-t border-gray-300 flex items-center gap-2",children:[t.invoiced?(0,r.jsxs)("span",{className:"flex items-center gap-1 text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium",children:[(0,r.jsx)(x.Z,{size:12}),"Invoiced"]}):(0,r.jsx)("span",{className:"text-xs text-gray-500",children:"Not Invoiced"}),(()=>{let e=t.partialPayments||[],a=e.reduce((e,t)=>e+t.amount,0);return(0,n.sA)(t)?(0,r.jsx)("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium",children:"Paid"}):a>0?(0,r.jsx)("span",{className:"text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-medium",children:"Partially Paid"}):null})()]})]})]}),(0,r.jsxs)("div",{className:"flex-shrink-0 flex gap-2 p-4 border-t border-gray-200",children:[(0,r.jsxs)("button",{onClick:handleDelete,className:"flex-1 px-4 py-3 bg-red-600 text-white rounded-lg font-medium active:bg-red-700 transition-colors touch-manipulation flex items-center justify-center gap-2",style:{WebkitTapHighlightColor:"transparent"},children:[(0,r.jsx)(u.Z,{size:18}),(0,r.jsx)("span",{children:"Delete"})]}),(0,r.jsxs)("button",{onClick:()=>{handleClose(),setTimeout(()=>l(t),300)},className:"flex-1 px-4 py-3 bg-primary-600 text-white rounded-lg font-medium active:bg-primary-700 transition-colors touch-manipulation flex items-center justify-center gap-2",style:{WebkitTapHighlightColor:"transparent"},children:[(0,r.jsx)(v,{size:18}),(0,r.jsx)("span",{children:"Edit"})]})]})]})})]});return(0,w.createPortal)(J,document.body)}function SelectionSheet(e){let{isOpen:t,onClose:a,title:n,children:i}=e,l=(0,s.useRef)(null),d=(0,s.useRef)(null),[o,c]=(0,s.useState)(!1),[m,x]=(0,s.useState)(!1);(0,s.useEffect)(()=>(t?(document.body.style.overflow="hidden",c(!1),requestAnimationFrame(()=>{x(!0)})):(x(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[t]);let handleClose=()=>{c(!0),x(!1),setTimeout(()=>{a(),c(!1)},300)};return t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{ref:d,onClick:e=>{e.target===d.current&&handleClose()},className:"fixed inset-0 bg-black/50 z-[99990] transition-opacity duration-300 ".concat(o||!m?"opacity-0":"opacity-100"),style:{WebkitTapHighlightColor:"transparent",backdropFilter:"blur(2px)"}}),(0,r.jsxs)("div",{ref:l,className:"fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-[100000] transition-transform duration-300 ease-out ".concat(o||!m?"translate-y-full":"translate-y-0"),style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y",paddingBottom:"env(safe-area-inset-bottom, 0)",backfaceVisibility:"hidden",willChange:"transform",maxHeight:"85vh",display:"flex",flexDirection:"column"},onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("div",{className:"flex justify-center pt-3 pb-2 flex-shrink-0",onClick:handleClose,children:(0,r.jsx)("div",{className:"w-12 h-1.5 bg-gray-300 rounded-full"})}),(0,r.jsxs)("div",{className:"px-4 pb-2 flex items-center justify-between flex-shrink-0 border-b border-gray-100",children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-gray-900",children:n}),(0,r.jsx)("button",{onClick:handleClose,className:"p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition-colors",children:(0,r.jsx)(N.Z,{size:20})})]}),(0,r.jsx)("div",{className:"overflow-y-auto p-4",children:i})]})]}):null}/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let Z=(0,j.Z)("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]]),SupplierDetailPopup_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t};function SupplierDetailPopup(e){let{group:t,isOpen:a,onClose:n,onEditOrder:i,onDeleteOrder:l,onOrderClick:o,onRefresh:c}=e,[u,p]=(0,s.useState)(!1),[g,y]=(0,s.useState)(!1),[b,j]=(0,s.useState)(!1),v=(0,s.useRef)(null),P=(0,s.useRef)(null);(0,s.useEffect)(()=>{let checkStandalone=()=>{let e=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.documentElement.classList.contains("standalone");j(e)};checkStandalone();let e=new MutationObserver(checkStandalone);return e.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),()=>e.disconnect()},[]),(0,s.useEffect)(()=>(a?(p(!1),y(!1),requestAnimationFrame(()=>{y(!0)}),document.body.style.overflow="hidden"):(y(!1),document.body.style.overflow=""),()=>{document.body.style.overflow=""}),[a]);let handleClose=()=>{p(!0),y(!1),setTimeout(()=>{n(),p(!1)},250)};if(!a||!t)return null;let C=SupplierDetailPopup_safeParseDate(t.lastPaymentDate),k=(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{ref:v,onClick:e=>{e.target===v.current&&handleClose()},className:"fixed inset-0 bg-black/50 z-[99999] popup-backdrop ".concat(u?"native-backdrop-exit":g?"native-backdrop-enter":"opacity-0"),style:{willChange:"opacity",WebkitTapHighlightColor:"transparent",touchAction:"none",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:99999}}),(0,r.jsx)("div",{className:"fixed z-[99999] flex items-center justify-center pointer-events-none popup-container",style:{WebkitTapHighlightColor:"transparent",position:"fixed",top:"calc(70px + env(safe-area-inset-top, 0px))",bottom:"4rem",left:0,right:0,padding:"1rem",paddingLeft:"max(1rem, env(safe-area-inset-left, 0px))",paddingRight:"max(1rem, env(safe-area-inset-right, 0px))",zIndex:99999},children:(0,r.jsxs)("div",{ref:P,className:"bg-white rounded-2xl border border-gray-100 max-w-lg w-full pointer-events-auto flex flex-col ".concat(u?"native-modal-exit":g?"native-modal-enter":"opacity-0 scale-95 translate-y-4"),style:{willChange:"transform, opacity",backfaceVisibility:"hidden",WebkitFontSmoothing:"antialiased",maxHeight:"calc(100dvh - 70px - 4rem - 2rem - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px))"},children:[(0,r.jsxs)("div",{className:"flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"p-2 bg-orange-100 rounded-lg",children:(0,r.jsx)(h.Z,{size:20,className:"text-orange-600"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:t.supplierName}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-0.5",children:"Raw Material Supplier"})]})]}),(0,r.jsx)("button",{onClick:handleClose,className:"p-1.5 rounded-lg active:bg-gray-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},"aria-label":"Close",children:(0,r.jsx)(N.Z,{size:20,className:"text-gray-500"})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",style:{WebkitOverflowScrolling:"touch"},children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)("div",{className:"p-1.5 bg-orange-500 rounded-lg",children:(0,r.jsx)(Z,{size:16,className:"text-white"})}),(0,r.jsx)("h3",{className:"text-base font-bold text-gray-900",children:"Summary"})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"py-2.5 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-700 font-medium",children:"Total Amount"}),(0,r.jsx)("span",{className:"text-base font-bold text-gray-900",children:(0,d.formatIndianCurrency)(t.totalAmount)})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"(Sum of: Original Total - Direct Payments for each order)"})]}),(0,r.jsxs)("div",{className:"py-2.5 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-700 font-medium",children:"Paid (Ledger)"}),(0,r.jsx)("span",{className:"text-base font-bold text-green-600",children:(0,d.formatIndianCurrency)(t.ledgerPayments.reduce((e,t)=>e+Number(t.entry.amount||0),0))})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"(Total from all ledger expense entries for this supplier)"}),(()=>{let e=t.ledgerPayments.reduce((e,t)=>e+Number(t.entry.amount||0),0),a=t.orders.reduce((e,a)=>{let r=(a.partialPayments||[]).filter(e=>{let a=new Set(t.ledgerPayments.map(e=>e.entry.id).filter(Boolean));return e.ledgerEntryId&&a.has(e.ledgerEntryId)});return e+r.reduce((e,t)=>e+Number(t.amount||0),0)},0),s=e-a;return Math.abs(s)>.01?(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-200",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center text-xs mb-1",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Distributed to Orders:"}),(0,r.jsx)("span",{className:"font-semibold text-blue-600",children:(0,d.formatIndianCurrency)(a)})]}),s>0&&(0,r.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[(0,r.jsx)("span",{className:"text-gray-600",children:"Undistributed Amount:"}),(0,r.jsx)("span",{className:"font-semibold text-orange-600",children:(0,d.formatIndianCurrency)(s)})]}),(0,r.jsx)("div",{className:"text-xs text-gray-600 mt-1.5 px-2 py-1 bg-orange-50 rounded",children:s>0?"Not enough unpaid orders to distribute full amount":"Over-distributed - check for errors"})]}):null})()]}),(0,r.jsxs)("div",{className:"py-2.5 border-b border-gray-200",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm text-gray-700 font-medium",children:"Total Paid"}),(0,r.jsx)("span",{className:"text-base font-bold text-blue-600",children:(0,d.formatIndianCurrency)(t.totalPaid)})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1",children:"(Includes: Direct payments + Supplier payments)"})]}),(0,r.jsx)("div",{className:"py-2.5",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-700",children:"Remaining"}),(0,r.jsx)("span",{className:"text-lg font-bold ".concat(t.remainingAmount>0?"text-red-600":"text-green-600"),children:(0,d.formatIndianCurrency)(Math.abs(t.remainingAmount))})]})}),C&&null!==t.lastPaymentAmount&&(0,r.jsx)("div",{className:"pt-2.5 mt-2.5 border-t border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(f.Z,{size:14,className:"text-gray-400"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs text-gray-500",children:"Last Payment"}),(0,r.jsxs)("div",{className:"text-sm font-medium text-gray-700",children:[(0,m.ZP)(C,"dd MMM yyyy")," • ",(0,d.formatIndianCurrency)(t.lastPaymentAmount)]})]})]})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)("div",{className:"p-1.5 bg-blue-500 rounded-lg",children:(0,r.jsx)(x.Z,{size:16,className:"text-white"})}),(0,r.jsxs)("h3",{className:"text-base font-bold text-gray-900",children:["Orders (",t.orders.length,")"]})]}),(0,r.jsx)("div",{className:"space-y-3",children:t.orders.map((e,a)=>{let s=SupplierDetailPopup_safeParseDate(e.date),n=Array.isArray(e.material)?e.material:e.material?[e.material]:[],i=Number(e.originalTotal||0),l=e.partialPayments||[],c=l.filter(e=>!e.ledgerEntryId),x=new Set(t.ledgerPayments.map(e=>e.entry.id).filter(Boolean)),u=l.filter(e=>!!e.ledgerEntryId&&x.has(e.ledgerEntryId)),p=u.map(e=>{let a=t.ledgerPayments.find(t=>t.entry.id===e.ledgerEntryId);return{...e,amount:e.amount,ledgerEntry:null==a?void 0:a.entry}}),g=l.reduce((e,t)=>e+Number(t.amount||0),0),y=c.reduce((e,t)=>e+Number(t.amount||0),0);p.reduce((e,t)=>e+Number(t.amount||0),0);let h=i-g;return(0,r.jsx)("div",{className:"bg-white rounded-lg border border-gray-200 transition-all duration-150 active:bg-gray-50 native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden",animation:"fadeInUp 0.2s ease-out ".concat(.03*a,"s both")},onClick:t=>{o&&((0,D.m)(t),handleClose(),setTimeout(()=>o(e),300))},children:(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1.5",children:[s&&(0,r.jsx)("span",{className:"text-sm font-bold text-gray-900",children:(0,m.ZP)(s,"dd MMM")}),(0,r.jsx)("span",{className:"text-xs text-gray-600 truncate",children:e.siteName})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5 flex-wrap",children:[n.slice(0,2).map((e,t)=>(0,r.jsx)("span",{className:"bg-primary-50 text-primary-700 px-2 py-0.5 rounded text-xs font-medium",children:e},t)),n.length>2&&(0,r.jsxs)("span",{className:"text-xs text-gray-500",children:["+",n.length-2]})]})]}),(0,r.jsx)("div",{className:"text-right ml-3 flex-shrink-0",children:(0,r.jsx)("p",{className:"text-base font-bold text-orange-600",children:(0,d.formatIndianCurrency)(i)})})]}),i>0&&(0,r.jsxs)("div",{className:"pt-2 mt-2 border-t border-gray-100",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Raw Material Expense"}),(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(i)})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,r.jsx)("span",{className:"text-xs text-gray-600",children:"Direct Payments"}),(0,r.jsx)("span",{className:"text-sm font-semibold ".concat(y>0?"text-blue-600":"text-gray-500"),children:(0,d.formatIndianCurrency)(y)})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,r.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Payment from Ledger"}),(0,r.jsx)("span",{className:"text-sm font-bold ".concat(i-y>0?"text-purple-600":"text-gray-500"),children:(0,d.formatIndianCurrency)(Math.max(0,i-y))})]}),(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-1 px-2 py-1 bg-purple-50 rounded",children:"(Raw Material Expense - Direct Payments)"}),h>0&&(0,r.jsxs)("div",{className:"flex items-center justify-between mt-2 pt-2 border-t border-gray-200",children:[(0,r.jsx)("span",{className:"text-xs font-medium text-gray-700",children:"Remaining Unpaid"}),(0,r.jsx)("span",{className:"text-sm font-semibold text-red-600",children:(0,d.formatIndianCurrency)(h)})]}),g>0&&(0,r.jsxs)("div",{className:"mt-2 pt-2 border-t border-gray-100",children:[(0,r.jsx)("div",{className:"text-xs text-gray-500 mb-1.5 font-medium",children:"Payments"}),(0,r.jsxs)("div",{className:"space-y-1",children:[c.map((e,t)=>{let a=SupplierDetailPopup_safeParseDate(e.date);return(0,r.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[a&&(0,r.jsx)("span",{className:"text-gray-500",children:(0,m.ZP)(a,"dd MMM")}),e.note&&(0,r.jsxs)("span",{className:"truncate",children:["• ",e.note]}),(0,r.jsx)("span",{className:"text-blue-600",children:"Direct"})]}),(0,r.jsx)("span",{className:"font-medium text-gray-900 ml-2",children:(0,d.formatIndianCurrency)(e.amount)})]},t)}),p.map((e,t)=>{var a,s;let n=(null===(a=e.ledgerEntry)||void 0===a?void 0:a.date)?SupplierDetailPopup_safeParseDate(e.ledgerEntry.date):SupplierDetailPopup_safeParseDate(e.date),i=(null===(s=e.ledgerEntry)||void 0===s?void 0:s.note)||e.note;return(0,r.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-600",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[n&&(0,r.jsx)("span",{className:"text-gray-500",children:(0,m.ZP)(n,"dd MMM")}),i&&(0,r.jsxs)("span",{className:"truncate",children:["• ",i]}),(0,r.jsx)("span",{className:"text-green-600",children:"Ledger"})]}),(0,r.jsx)("span",{className:"font-medium text-gray-900 ml-2",children:(0,d.formatIndianCurrency)(e.amount)})]},t)})]})]})]})]})},e.id)})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)("div",{className:"p-1.5 bg-green-500 rounded-lg",children:(0,r.jsx)(E.Z,{size:16,className:"text-white"})}),(0,r.jsxs)("h3",{className:"text-base font-bold text-gray-900",children:["Ledger Payments (",t.ledgerPayments.length,")"]})]}),t.ledgerPayments.length>0?(0,r.jsx)("div",{className:"space-y-2",children:t.ledgerPayments.map((e,t)=>{let a=SupplierDetailPopup_safeParseDate(e.entry.date);return(0,r.jsx)("div",{className:"bg-white rounded-lg border border-gray-200 p-3 transition-all duration-200",style:{animation:"fadeInUp 0.3s ease-out ".concat(.05*t,"s both")},children:(0,r.jsx)("div",{className:"flex justify-between items-start",children:(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-base font-bold text-gray-900",children:(0,d.formatIndianCurrency)(e.entry.amount)}),a&&(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mt-1",children:[(0,r.jsx)(f.Z,{size:14,className:"text-gray-400"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:(0,m.ZP)(a,"dd MMM yyyy")})]}),e.entry.note&&(0,r.jsx)("p",{className:"text-xs text-gray-600 mt-1.5",children:e.entry.note})]})})},e.entry.id||t)})}):(0,r.jsx)("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-4 text-center",children:(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"No payments recorded"})})]})]})]})})]});return(0,w.createPortal)(k,document.body)}var R=a(24033),F=a(86725);let page_safeParseDate=e=>{if(!e||"string"!=typeof e||""===e.trim())return null;let t=new Date(e);return isNaN(t.getTime())?null:t},safeGetTime=e=>{let t=page_safeParseDate(e);return t?t.getTime():0};function OrdersPage(){let[e,t]=(0,s.useState)([]),[a,j]=(0,s.useState)([]),[w,P]=(0,s.useState)([]),[C,A]=(0,s.useState)([]),[E,z]=(0,s.useState)(!0),[M,Z]=(0,s.useState)(!1),[L,W]=(0,s.useState)(null),[H,_]=(0,s.useState)(new Set),[B,q]=(0,s.useState)(!1),[K,U]=(0,s.useState)({}),[X,G]=(0,s.useState)(new Set),[V,Y]=(0,s.useState)("allOrders"),[J,Q]=(0,s.useState)(null),[$,ee]=(0,s.useState)(!1),[et,ea]=(0,s.useState)(null),[er,es]=(0,s.useState)(!1),[en,ei]=(0,s.useState)(null),[el,ed]=(0,s.useState)(!1),[eo,ec]=(0,s.useState)([]),[em,ex]=(0,s.useState)(null),[eu,ep]=(0,s.useState)(!1),[eg,ey]=(0,s.useState)(null),[eh,ef]=(0,s.useState)(null),eb=(0,s.useRef)(null),[ej,ev]=(0,s.useState)(!0),eN=(0,s.useRef)(0),[ew,eP]=(0,s.useState)(new Set),[eC,ek]=(0,s.useState)(new Set),[eS,eI]=(0,s.useState)(null),eT=(0,s.useRef)(null),eA=(0,s.useRef)(null),[eE,eD]=(0,s.useState)(""),[eO,ez]=(0,s.useState)(""),[eM,eZ]=(0,s.useState)(""),[eR,eF]=(0,s.useState)(""),[eL,eW]=(0,s.useState)([]),[eH,e_]=(0,s.useState)(null),eB=(0,R.useSearchParams)(),eq=(0,R.useRouter)();(0,s.useEffect)(()=>{let initializeData=async()=>{z(!0);try{await loadOrders(),await Promise.allSettled([loadInvoices(),loadPartyPayments(),loadPartyNames(),loadLedgerEntries()])}catch(e){console.error("Error initializing data:",e)}finally{z(!1)}};initializeData();let e=F.ledgerService.subscribe(e=>{ec(e)});return()=>{e()}},[]);let loadLedgerEntries=async()=>{try{let e=await F.ledgerService.list();ec(e)}catch(e){console.error("Error loading ledger entries:",e)}};(0,s.useEffect)(()=>{if(!eb.current){ev(!0);return}let e=eb.current,t=!1,handleScroll=()=>{t||(window.requestAnimationFrame(()=>{let a=e.scrollTop;a>50&&a>eN.current?ev(!1):ev(!0),eN.current=a,t=!1}),t=!0)};return e.addEventListener("scroll",handleScroll,{passive:!0}),()=>e.removeEventListener("scroll",handleScroll)},[V]),(0,s.useEffect)(()=>{let e=eB.get("highlight");if(e){e_(e),setTimeout(()=>{let t=document.querySelector('[data-order-id="'.concat(e,'"]'));t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100);let t=setTimeout(()=>{e_(null),eq.replace("/orders",{scroll:!1})},1e3);return()=>clearTimeout(t)}},[eB,eq,a]);let loadPartyNames=async()=>{try{let e=await n.XK.getUniquePartyNames();eW(e)}catch(e){console.error("Error loading party names:",e)}},loadOrders=async()=>{try{let e=await n.XK.getAllOrders();t(e)}catch(e){throw console.error("Error loading orders:",e),e}},loadInvoices=async()=>{try{let e=await i.z.getAllInvoices();P(e)}catch(e){console.error("Error loading invoices:",e)}},loadPartyPayments=async()=>{try{let e=await l.s.getAllPayments();A(e)}catch(e){console.error("Error loading party payments:",e)}};(0,s.useEffect)(()=>{let t=[...e];if(ew.size>0)t=t.filter(e=>{var t;return ew.has((null===(t=e.partyName)||void 0===t?void 0:t.trim())||"")});else if(X.size>0)t=t.filter(e=>{var t;let a=(null===(t=e.partyName)||void 0===t?void 0:t.trim())||"";return X.has(a)});else if(K.partyName){let e=K.partyName.split(",").map(e=>e.trim().toLowerCase());t=t.filter(t=>e.some(e=>t.partyName.toLowerCase()===e))}if(eC.size>0)t=t.filter(e=>{let t=Array.isArray(e.material)?e.material.map(e=>String(e).trim()):[String(e.material||"").trim()].filter(Boolean);return t.some(e=>eC.has(e))});else if(K.material){let e=K.material.split(",").map(e=>e.trim().toLowerCase());t=t.filter(t=>{let a=Array.isArray(t.material)?t.material.map(e=>e.toLowerCase()):[t.material.toLowerCase()];return e.some(e=>a.some(t=>t.includes(e)))})}if(K.startDate){let e=page_safeParseDate(K.startDate);e&&(t=t.filter(t=>{let a=page_safeParseDate(t.date);return a&&a>=e}))}if(K.endDate){let e=page_safeParseDate(K.endDate);e&&(t=t.filter(t=>{let a=page_safeParseDate(t.date);return a&&a<=e}))}let getTime=e=>safeGetTime(e.createdAt||e.updatedAt||e.date);t.sort((e,t)=>getTime(t)-getTime(e)),j(t)},[e,K,X,ew,eC]);let handleSaveOrder=async e=>{console.log("\uD83D\uDCDD handleSaveOrder called",{isEdit:!!(null==L?void 0:L.id),orderId:null==L?void 0:L.id,orderData:e});try{if(null==L?void 0:L.id){console.log("\uD83D\uDD04 Updating order:",L.id);let t=L.partialPayments||[],a=e.partialPayments||[];console.log("\uD83D\uDD0D Checking for ledger payment changes:",{oldPayments:t.map(e=>({id:e.id,amount:e.amount,ledgerEntryId:e.ledgerEntryId})),newPayments:a.map(e=>({id:e.id,amount:e.amount,ledgerEntryId:e.ledgerEntryId}))});let r=new Set;if(t.forEach(e=>{if(e.ledgerEntryId){let t=a.find(t=>t.id===e.id);if(t){let a=Math.abs(Number(t.amount)-Number(e.amount))>.01;a?(console.log("  ✏️  Ledger payment ".concat(e.id," amount changed: ").concat(e.amount," → ").concat(t.amount," (ledgerEntryId: ").concat(e.ledgerEntryId,")")),r.add(e.ledgerEntryId)):console.log("  ℹ️  Ledger payment ".concat(e.id," modified (date/note only, no redistribution needed)"))}else console.log("  ❌ Ledger payment ".concat(e.id," was removed (ledgerEntryId: ").concat(e.ledgerEntryId,")")),r.add(e.ledgerEntryId)}}),a.forEach(e=>{if(e.ledgerEntryId){let a=t.find(t=>t.id===e.id);a||(console.log("  ➕ New ledger payment ".concat(e.id," added (ledgerEntryId: ").concat(e.ledgerEntryId,")")),r.add(e.ledgerEntryId))}}),console.log("\uD83D\uDCCA Found ".concat(r.size," ledger entry/entries to redistribute:"),Array.from(r)),await n.XK.updateOrder(L.id,e),console.log("✅ Order updated"),r.size>0){console.log("\uD83D\uDD04 Redistributing ".concat(r.size," ledger entry/entries")),await new Promise(e=>setTimeout(e,500));let t=Array.from(r);for(let r of t)try{let t=a.find(e=>e.ledgerEntryId===r),s=(null==t?void 0:t.date)||e.date||new Date().toISOString();await redistributeLedgerEntry(r,s),console.log("✅ Redistributed ledger entry ".concat(r))}catch(e){console.error("Error redistributing ledger entry ".concat(r,":"),e)}}(0,k.showToast)("Order updated successfully!","success")}else{console.log("➕ Creating new order");let t=await n.XK.createOrder(e);(0,k.showToast)("Order created successfully!","success"),await loadOrders(),W(null),Z(!1),e_(t),eq.replace("/orders?highlight=".concat(t),{scroll:!1}),setTimeout(()=>{e_(null),eq.replace("/orders",{scroll:!1})},1e3);return}await loadOrders(),await loadInvoices(),await loadPartyPayments(),W(null),Z(!1)}catch(e){throw console.error("Error in handleSaveOrder:",e),e}},getOrderPaymentInfo=e=>{let t=Number(e.originalTotal||0),a=e.partialPayments||[],r=a.reduce((e,t)=>e+t.amount,0);return{expenseAmount:t,totalPaid:r,remainingAmount:t-r}},handleAddPaymentToOrder=async e=>{let{expenseAmount:t,totalPaid:a,remainingAmount:r}=getOrderPaymentInfo(e),s=(0,n.sA)(e);if(s){let e=await S.h.confirm({title:"Order Already Paid",message:"This order is already marked as paid (within ₹250 tolerance). Adding more payments may cause overpayment. Continue?",icon:"warning",confirmText:"Continue",cancelText:"Cancel"});if(!e)return}let i=(e.partialPayments||[]).filter(e=>e.ledgerEntryId),l=i.length>0,o=i.reduce((e,t)=>e+Number(t.amount||0),0);try{let i=l?"Remaining: ".concat((0,d.formatIndianCurrency)(r),"\nLedger payments: ").concat((0,d.formatIndianCurrency)(o)):"Remaining amount: ".concat((0,d.formatIndianCurrency)(r)),c=await S.h.prompt({title:"Add Payment",message:i,inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Next",cancelText:"Cancel"});if(!c)return;let m=Math.abs(parseFloat(String(c).replace(/,/g,"")));if(!m||Number.isNaN(m)||m<=0){(0,k.showToast)("Invalid amount","error");return}let x=await S.h.prompt({title:"Add Note (optional)",inputLabel:"Note",inputPlaceholder:"e.g. Cash payment / Bank transfer",inputType:"text",required:!1,confirmText:"Next",cancelText:"Skip"}),u=a+m,p=u>t,g=p?u-t:0;if(p&&l){let a=await S.h.confirm({title:"Overpayment Detected",message:"Adding this payment would result in overpayment of ".concat((0,d.formatIndianCurrency)(g),".\n\nTotal payments: ").concat((0,d.formatIndianCurrency)(u),"\nOriginal total: ").concat((0,d.formatIndianCurrency)(t),"\nLedger payments on this order: ").concat((0,d.formatIndianCurrency)(o),"\n\nWould you like to reduce the ledger payment(s) on this order and redistribute to other unpaid orders of this supplier?"),icon:"question",confirmText:"Reduce & Redistribute",cancelText:"Cancel"});if(!a)return;try{let t=g,a=new Set,r=[...e.partialPayments||[]],s=[];for(let{index:e,payment:n}of(r.forEach((e,t)=>{e.ledgerEntryId&&s.push({index:t,payment:e})}),s.sort((e,t)=>{let a=new Date(e.payment.date).getTime(),r=new Date(t.payment.date).getTime();return r-a}),s)){if(t<=0)break;let s=Number(n.amount||0),i=Math.min(t,s),l=s-i;l>0?r[e]={...n,amount:l}:r.splice(e,1),a.add(n.ledgerEntryId),t-=i,console.log("  \uD83D\uDD04 Reducing ledger payment ".concat(n.id," by ").concat(i," (from ").concat(s," to ").concat(l,")"))}let i=new Date().toISOString(),l={id:Date.now().toString()+Math.random().toString(36).substr(2,9),amount:m,date:i,note:x||void 0};r.push(l),await n.XK.updateOrder(e.id,{partialPayments:r}),console.log("✅ Updated order ".concat(e.id," with reduced ledger payments and new direct payment")),await new Promise(e=>setTimeout(e,500));let d=Array.from(a);for(let e of d)try{let t=r.find(t=>t.ledgerEntryId===e),a=(null==t?void 0:t.date)||new Date().toISOString();await redistributeLedgerEntry(e,a),console.log("✅ Redistributed ledger entry ".concat(e))}catch(t){console.error("Error redistributing ledger entry ".concat(e,":"),t)}if((0,k.showToast)("Payment added and ledger payments redistributed!","success"),await loadOrders(),(null==J?void 0:J.id)===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&Q(t)}if((null==em?void 0:em.id)===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&ex(t)}return}catch(e){console.error("Error reducing ledger payments:",e),(0,k.showToast)(e.message||"Failed to reduce ledger payments","error");return}}else if(p&&!l){let e=await S.h.confirm({title:"Overpayment Warning",message:"Adding this payment would result in overpayment of ".concat((0,d.formatIndianCurrency)(g),".\n\nTotal payments: ").concat((0,d.formatIndianCurrency)(u),"\nOriginal total: ").concat((0,d.formatIndianCurrency)(t),"\n\nContinue anyway?"),icon:"warning",confirmText:"Continue",cancelText:"Cancel"});if(!e)return}let y=!1;if(s||p)(s||p&&!l)&&(y=!0);else{let e=a+m,s=e>=t-250;if(s){let e=await S.h.confirm({title:"Add Payment",message:"Payment amount: ".concat((0,d.formatIndianCurrency)(m),"\nRemaining: ").concat((0,d.formatIndianCurrency)(r),"\n\nThis payment will mark the order as paid. Continue?"),icon:"question",confirmText:"Add Payment",cancelText:"Cancel"});if(!e)return;y=!0}}await n.XK.addPaymentToOrder(e.id,m,x||void 0,y),(0,k.showToast)("Payment added successfully!","success"),await new Promise(e=>setTimeout(e,500)),await loadOrders();let h=await n.XK.getOrderById(e.id);if(h&&console.log("Order after payment:",{id:h.id,partialPayments:h.partialPayments}),(null==J?void 0:J.id)===e.id){let t=await n.XK.getOrderById(e.id);t&&Q(t)}if((null==em?void 0:em.id)===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&ex(t)}}catch(e){console.error("Error adding payment:",e),(0,k.showToast)(e.message||"Failed to add payment","error")}},handleEditPayment=(e,t)=>{var a;let r=null===(a=e.partialPayments)||void 0===a?void 0:a.find(e=>e.id===t);null!=r&&r.ledgerEntryId||ey({order:e,paymentId:t})},handleSavePaymentEdit=async e=>{if(eg&&eg.order.id)try{var t;let a=null===(t=eg.order.partialPayments)||void 0===t?void 0:t.find(e=>e.id===eg.paymentId),r=!!(null==a?void 0:a.ledgerEntryId),s=!!r&&!!a&&Math.abs(Number(e.amount)-Number(a.amount))>.01;if(await n.XK.updatePartialPayment(eg.order.id,eg.paymentId,e,null==a?void 0:a.ledgerEntryId),r&&a.ledgerEntryId&&s&&await redistributeLedgerEntry(a.ledgerEntryId,e.date),await loadOrders(),(null==em?void 0:em.id)===eg.order.id&&eg.order.id){let e=await n.XK.getOrderById(eg.order.id);e&&ex(e)}if((null==J?void 0:J.id)===eg.order.id&&eg.order.id){let e=await n.XK.getOrderById(eg.order.id);e&&Q(e)}ey(null)}catch(e){console.error("Failed to update payment:",e),(0,k.showToast)(e.message||"Failed to update payment","error"),ey(null)}},redistributeLedgerEntry=async(e,t)=>{try{console.log("\uD83D\uDD04 Redistributing ledger entry ".concat(e," (date: ").concat(t,")"));let a=await F.ledgerService.getEntryById(e);if(!a){console.warn("❌ Ledger entry ".concat(e," not found"));return}if("debit"!==a.type||!a.supplier){console.warn("❌ Ledger entry is not an expense with supplier (type: ".concat(a.type,", supplier: ").concat(a.supplier,")"));return}console.log("Redistribution is handled server-side by orderService.redistributeSupplierPayment; skipping duplicate client distribution.")}catch(e){throw console.error("❌ Error redistributing ledger entry:",e),e}},handleRemovePayment=async(e,t)=>{var a;if(!e.id)return;let r=null===(a=e.partialPayments)||void 0===a?void 0:a.find(e=>e.id===t),s=!!(null==r?void 0:r.ledgerEntryId);try{let a=await S.h.confirm({title:"Remove Payment?",message:s?"This payment is from a ledger entry. Removing it will trigger redistribution of the ledger entry. Continue?":"Are you sure you want to remove this payment? This action cannot be undone.",icon:"warning",confirmText:"Remove",cancelText:"Cancel"});if(!a)return;if(await n.XK.removePartialPayment(e.id,t),s&&r.ledgerEntryId)try{let t=e.date||new Date().toISOString();await redistributeLedgerEntry(r.ledgerEntryId,t),(0,k.showToast)("Payment removed and ledger entry redistributed!","success")}catch(e){console.error("Error redistributing ledger entry:",e),(0,k.showToast)("Payment removed, but redistribution failed","error")}else(0,k.showToast)("Payment removed successfully!","success");if(await loadOrders(),(null==em?void 0:em.id)===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&ex(t)}if((null==J?void 0:J.id)===e.id&&e.id){let t=await n.XK.getOrderById(e.id);t&&Q(t)}}catch(e){(null==e?void 0:e.message)&&!e.message.includes("SweetAlert")&&(0,k.showToast)("Failed to remove payment: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}},handleDeleteOrder=async e=>{try{console.log("Delete button clicked for order:",e);let t=await S.h.confirm({title:"Delete Order?",message:"Are you sure you want to delete this order? This action cannot be undone.",icon:"warning",confirmText:"Delete",cancelText:"Cancel"});console.log("SweetAlert confirmed:",t),t&&(await n.XK.deleteOrder(e),(0,k.showToast)("Order deleted successfully!","success"),await loadOrders(),await loadInvoices(),await loadPartyPayments())}catch(e){console.error("Error deleting order:",e),(null==e?void 0:e.message)&&!e.message.includes("SweetAlert")&&(0,k.showToast)("Failed to delete order: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}},toggleOrderSelection=e=>{let t=new Set(H);t.has(e)?t.delete(e):t.add(e),_(t)},getUniqueMaterials=()=>{let t=new Set;return e.forEach(e=>{if(Array.isArray(e.material))e.material.forEach(e=>{let a=String(e||"").trim();a&&t.add(a)});else if(e.material){let a=String(e.material).trim();a&&t.add(a)}}),Array.from(t).sort()},clearPartyFilter=()=>{eP(new Set),eI(null)},clearMaterialFilter=()=>{ek(new Set),eI(null)},handleBulkDelete=async()=>{if(0!==H.size)try{let e=await S.h.confirm({title:"Delete Selected Orders?",message:"Are you sure you want to delete ".concat(H.size," order(s)? This action cannot be undone."),icon:"warning",confirmText:"Delete",cancelText:"Cancel"});if(!e)return;let t=Array.from(H),a=0,r=0;for(let e of t)try{await n.XK.deleteOrder(e),a++}catch(t){console.error("Failed to delete order ".concat(e,":"),t),r++}a>0?((0,k.showToast)("Successfully deleted ".concat(a," order(s)").concat(r>0?". ".concat(r," failed."):""),"success"),_(new Set),await loadOrders(),await loadInvoices(),await loadPartyPayments()):(0,k.showToast)("Failed to delete orders.","error")}catch(e){(null==e?void 0:e.message)&&!e.message.includes("SweetAlert")&&(0,k.showToast)("Failed to delete orders: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}},handleBulkCreateInvoice=async()=>{if(0===H.size)return;let e=Array.from(H),t=a.filter(t=>e.includes(t.id)&&!t.invoiced);if(0===t.length){(0,k.showToast)("All selected orders already have invoices","info");return}if(t.length<e.length){let a=e.length-t.length;try{let e=await S.h.confirm({title:"Some Orders Already Invoiced",message:"".concat(a," order(s) already have invoices. Create invoice for ").concat(t.length," order(s) only?"),icon:"info",confirmText:"Create Invoice",cancelText:"Cancel"});if(!e)return}catch(e){(null==e?void 0:e.message)&&e.message.includes("SweetAlert");return}}try{let e=t.map(e=>e.id);(0,k.showToast)("Creating invoice...","info"),await i.z.createInvoice(e),(0,k.showToast)("Invoice created successfully for ".concat(t.length," order(s)!"),"success"),_(new Set),await loadOrders(),await loadInvoices(),await loadPartyPayments()}catch(e){(0,k.showToast)("Failed to create invoice: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}},applyFilterForm=()=>{let e={};eE&&(e.partyName=eE),eO&&(e.material=eO),eM&&(e.startDate=eM),eR&&(e.endDate=eR),U(e),eE&&G(new Set),q(!1)},resetFilters=()=>{eD(""),ez(""),eZ(""),eF(""),U({}),G(new Set),q(!1)},handlePartyGroupClick=e=>{ea(e),es(!0)},getPartyGroups=()=>{let e=new Map;a.forEach(t=>{let a=t.partyName;e.has(a)||e.set(a,[]),e.get(a).push(t)});let t=[];return e.forEach((e,a)=>{let r=e.reduce((e,t)=>e+t.total,0),s=e.reduce((e,t)=>e+(0,O.I)(t),0),n=C.filter(e=>e.partyName===a),i=[],l=0,d=null,o=null;n.forEach(e=>{i.push({invoiceId:"",invoiceNumber:"",payment:{id:e.id,amount:e.amount,date:e.date,...e.note?{note:e.note}:{}},ledgerEntryId:e.ledgerEntryId}),l+=e.amount;let t=page_safeParseDate(e.date);if(t){let a=page_safeParseDate(d);(!a||t>a)&&(d=e.date,o=e.amount)}}),i.sort((e,t)=>safeGetTime(t.payment.date)-safeGetTime(e.payment.date)),t.push({partyName:a,totalSelling:r,totalPaid:l,totalProfit:s,lastPaymentDate:d,lastPaymentAmount:o,orders:e.sort((e,t)=>{let a=safeGetTime(e.createdAt||e.updatedAt||e.date),r=safeGetTime(t.createdAt||t.updatedAt||t.date);return r-a}),payments:i})}),t.sort((e,t)=>e.partyName.localeCompare(t.partyName))},getSupplierGroups=()=>{let e=new Map;a.forEach(t=>{let a=t.supplier;a&&""!==a.trim()&&(e.has(a)||e.set(a,[]),e.get(a).push(t))});let t=[];return e.forEach((e,a)=>{let r=0,s=0,n=0,i=0;e.forEach(e=>{let t=Number(e.originalTotal||0),a=e.partialPayments||[],l=a.filter(e=>!e.ledgerEntryId),d=l.reduce((e,t)=>e+Number(t.amount||0),0),o=a.filter(e=>e.ledgerEntryId),c=o.reduce((e,t)=>e+Number(t.amount||0),0);r+=Math.max(0,t-d),s+=a.reduce((e,t)=>e+Number(t.amount||0),0),n+=d,i+=c});let l=eo.filter(e=>"debit"===e.type&&e.supplier===a),d=l.reduce((e,t)=>e+Number(t.amount||0),0),o=Math.max(0,r-d),c=new Set(l.map(e=>e.id).filter(Boolean)),m=0;e.forEach(e=>{let t=e.partialPayments||[];t.forEach(e=>{e.ledgerEntryId&&c.has(e.ledgerEntryId)&&(m+=e.amount)})});let x=l.reduce((e,t)=>e+Number(t.amount||0),0);Math.abs(x-m)>.01&&console.warn("⚠️ Supplier ".concat(a,": Ledger entry total (").concat(x,") doesn't match partial payments with ledgerEntryId (").concat(m,")"));let u=n+i;Math.abs(s-u)>.01&&console.warn("⚠️ Supplier ".concat(a,": Payment totals mismatch! totalPaid (").concat(s,") != direct (").concat(n,") + supplier (").concat(i,") = ").concat(u));let p=r-i;Math.abs(o-p)>.01&&console.warn("⚠️ Supplier ".concat(a,": Remaining amount mismatch! remainingAmount (").concat(o,") != totalAmount (").concat(r,") - supplier payments (").concat(i,") = ").concat(p));let g=null,y=null;e.forEach(e=>{let t=e.partialPayments||[];t.forEach(e=>{let t=page_safeParseDate(e.date);if(t){let a=page_safeParseDate(g);(!a||t>a)&&(g=e.date,y=e.amount)}})}),l.forEach(e=>{let t=page_safeParseDate(e.date);if(t){let a=page_safeParseDate(g);(!a||t>a)&&(g=e.date,y=e.amount)}});let h=l.map(e=>({entry:e})).sort((e,t)=>safeGetTime(t.entry.date)-safeGetTime(e.entry.date));t.push({supplierName:a,totalAmount:r,totalPaid:s,remainingAmount:o,lastPaymentDate:g,lastPaymentAmount:y,orders:e.sort((e,t)=>{let a=safeGetTime(e.createdAt||e.updatedAt||e.date),r=safeGetTime(t.createdAt||t.updatedAt||t.date);return r-a}),ledgerPayments:h})}),t.sort((e,t)=>{let a=safeGetTime(e.lastPaymentDate),r=safeGetTime(t.lastPaymentDate);return r-a})},handleSupplierGroupClick=e=>{ei(e),ed(!0)};return(0,r.jsxs)("div",{className:"bg-gray-50",style:{height:"100dvh",minHeight:"100dvh",display:"flex",flexDirection:"column",overflow:"hidden"},children:[(0,r.jsx)(I.Z,{isOpen:B,onClose:()=>q(!1),title:"Filters",children:(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Party Name"}),(0,r.jsx)("div",{className:"grid grid-cols-2 gap-1.5 p-2 border border-gray-300 rounded-lg bg-gray-50 max-h-48 overflow-y-auto",children:eL.map(e=>(0,r.jsxs)("label",{className:"flex items-center space-x-1.5 cursor-pointer hover:bg-gray-100 p-1.5 rounded transition-colors",children:[(0,r.jsx)("input",{type:"checkbox",checked:eE.split(",").includes(e),onChange:t=>{let a=eE.split(",").filter(e=>e.trim());eD((t.target.checked?[...a,e]:a.filter(t=>t!==e)).join(","))},className:"custom-checkbox"}),(0,r.jsx)("span",{className:"text-xs text-gray-700",children:e})]},e))})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Material"}),(0,r.jsx)("div",{className:"grid grid-cols-2 gap-1.5 p-2 border border-gray-300 rounded-lg bg-gray-50 max-h-48 overflow-y-auto",children:["Bodeli","Panetha","Nareshware","Kali","Chikhli Kapchi VSI","Chikhli Kapchi","Areth"].map(e=>(0,r.jsxs)("label",{className:"flex items-center space-x-1.5 cursor-pointer hover:bg-gray-100 p-1.5 rounded transition-colors",children:[(0,r.jsx)("input",{type:"checkbox",checked:eO.split(",").includes(e),onChange:t=>{let a=eO.split(",").filter(e=>e.trim());ez((t.target.checked?[...a,e]:a.filter(t=>t!==e)).join(","))},className:"custom-checkbox"}),(0,r.jsx)("span",{className:"text-xs text-gray-700",children:e})]},e))})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Start Date"}),(0,r.jsx)("input",{type:"date",value:eM,onChange:e=>eZ(e.target.value),className:"w-full p-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"End Date"}),(0,r.jsx)("input",{type:"date",value:eR,onChange:e=>eF(e.target.value),className:"w-full p-2 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}),(0,r.jsxs)("div",{className:"flex gap-2 pt-2 border-t border-gray-200 sticky bottom-0 bg-white pb-2",children:[(0,r.jsx)("button",{onClick:()=>{applyFilterForm(),q(!1)},className:"flex-1 bg-primary-600 text-white px-3 py-2 rounded-lg text-xs font-medium hover:bg-primary-700 transition-colors",children:"Apply"}),(0,r.jsx)("button",{onClick:()=>{resetFilters(),q(!1)},className:"flex-1 bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-xs font-medium hover:bg-gray-300 transition-colors",children:"Reset"})]})]})}),(0,r.jsx)("div",{className:"fixed left-0 right-0 z-[45] flex items-end justify-center",style:{bottom:H.size>0?"9.75rem":"5.25rem",paddingLeft:"max(0.75rem, env(safe-area-inset-left, 0px))",paddingRight:"max(0.75rem, env(safe-area-inset-right, 0px))",pointerEvents:"none",transition:"transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)",transform:ej?"translateY(0)":"translateY(calc(100% + 1rem))",opacity:ej?1:0},children:(0,r.jsxs)("div",{className:"bg-white/95 backdrop-blur-xl border border-gray-200/60 rounded-2xl flex gap-2 w-full",style:{padding:"0.5rem",boxShadow:"0 2px 16px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.03)",pointerEvents:ej?"auto":"none"},children:[(0,r.jsx)("button",{onClick:e=>{(0,D.m)(e),Y("allOrders")},className:"flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ".concat("allOrders"===V?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"),style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"All Orders"}),(0,r.jsx)("button",{onClick:e=>{(0,D.m)(e),Y("byParty")},className:"flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ".concat("byParty"===V?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"),style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"By Party"}),(0,r.jsx)("button",{onClick:e=>{(0,D.m)(e),Y("suppliers")},className:"flex-1 py-2.5 px-3 rounded-xl text-sm font-semibold transition-all native-press ".concat("suppliers"===V?"bg-primary-600 text-white":"bg-gray-100 text-gray-700 active:bg-gray-200"),style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"Suppliers"})]})}),H.size>0&&(0,r.jsx)("div",{className:"fixed left-0 right-0 z-[44] flex items-end justify-center",style:{bottom:"5.25rem",paddingLeft:"max(0.75rem, env(safe-area-inset-left, 0px))",paddingRight:"max(0.75rem, env(safe-area-inset-right, 0px))",pointerEvents:"none"},children:(0,r.jsx)("div",{className:"bg-white/95 backdrop-blur-xl border border-gray-200/60 rounded-2xl w-full",style:{padding:"0.75rem",boxShadow:"0 2px 16px rgba(0, 0, 0, 0.06), 0 1px 4px rgba(0, 0, 0, 0.03)",pointerEvents:"auto"},children:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("button",{onClick:e=>{(0,D.m)(e),handleBulkCreateInvoice()},className:"flex-1 bg-green-600 text-white px-3 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-1.5 active:bg-green-700 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:[(0,r.jsx)(x.Z,{size:18}),(0,r.jsxs)("span",{children:["Create Invoice (",H.size,")"]})]}),(0,r.jsxs)("button",{onClick:e=>{(0,D.m)(e),handleBulkDelete()},className:"flex-1 bg-red-600 text-white px-3 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-1.5 active:bg-red-700 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:[(0,r.jsx)(u.Z,{size:18}),(0,r.jsxs)("span",{children:["Delete (",H.size,")"]})]}),(0,r.jsx)("button",{onClick:e=>{(0,D.m)(e),_(new Set)},className:"px-4 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-medium active:bg-gray-300 transition-colors touch-manipulation native-press",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:"Clear"})]})})}),(0,r.jsxs)("div",{ref:eb,onClick:e=>{null===e.target.closest("[data-order-id]")&&null===e.target.closest("button")&&ef(null)},style:{flex:1,overflowY:"auto",overflowX:"allOrders"===V?"auto":"visible",WebkitOverflowScrolling:"touch",paddingBottom:H.size>0?"16rem":"9rem"},children:[E?(0,r.jsx)("div",{className:"fixed inset-0 flex items-center justify-center z-30 bg-gray-50",children:(0,r.jsx)(T.Z,{size:100})}):0===a.length?(0,r.jsx)("div",{className:"p-2.5 text-center text-sm text-gray-500",children:"No orders found"}):"byParty"===V?(0,r.jsx)("div",{className:"p-2 space-y-2",children:getPartyGroups().map((e,t)=>{let a=e.totalSelling-e.totalPaid,s=page_safeParseDate(e.lastPaymentDate);return e.totalSelling>0&&(e.totalPaid,e.totalSelling),(0,r.jsx)("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden transition-all duration-200 hover:border-primary-300 active:scale-[0.99] native-press",style:{animation:"fadeInUp 0.3s ease-out ".concat(.04*t,"s both"),WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},onClick:t=>{t.target.closest("button")||((0,D.m)(t),handlePartyGroupClick(e))},children:(0,r.jsxs)("div",{className:"p-2.5",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-0.5",children:[(0,r.jsx)(p.Z,{size:13,className:"text-primary-600 flex-shrink-0"}),(0,r.jsx)("h3",{className:"font-bold text-sm text-gray-900 truncate",children:e.partyName})]}),e.orders.length>0&&e.orders[0].siteName&&(0,r.jsx)("p",{className:"text-[10px] text-gray-500 truncate ml-4.5",children:e.orders[0].siteName})]}),(0,r.jsx)("button",{onClick:async t=>{t.stopPropagation(),(0,D.m)(t);let a=e.totalSelling-e.totalPaid;try{let t=await S.h.prompt({title:"Add Payment",message:"Remaining balance: ".concat((0,d.formatIndianCurrency)(a)),inputLabel:"Payment Amount",inputPlaceholder:"Enter amount",inputType:"text",formatCurrencyInr:!0,confirmText:"Add Payment",cancelText:"Cancel"});if(!t)return;let r=Math.abs(parseFloat(String(t).replace(/,/g,"")));if(isNaN(r)||r<=0){(0,k.showToast)("Invalid amount","error");return}let s=await S.h.prompt({title:"Payment Note (optional)",inputLabel:"Note",inputPlaceholder:"Add a note (optional)",inputType:"text",required:!1,confirmText:"Save",cancelText:"Skip"});await l.s.addPayment(e.partyName,r,s||void 0),(0,k.showToast)("Payment added successfully!","success"),await Promise.all([loadPartyPayments(),loadOrders()])}catch(e){(null==e?void 0:e.message)&&!e.message.includes("SweetAlert")&&(0,k.showToast)("Failed to add payment: ".concat((null==e?void 0:e.message)||"Unknown error"),"error")}},className:"p-2.5 bg-primary-600 text-white rounded-lg hover:bg-primary-700 active:bg-primary-800 transition-all native-press flex items-center justify-center flex-shrink-0",style:{WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},children:(0,r.jsx)(g.Z,{size:16})})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2 flex-wrap gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-gray-600",children:"Total:"}),(0,r.jsx)("span",{className:"text-xs font-bold text-primary-700",children:(0,d.formatIndianCurrency)(e.totalSelling)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-gray-600",children:"Profit:"}),(0,r.jsx)("span",{className:"text-xs font-bold ".concat(e.totalProfit>=0?"text-green-600":"text-red-600"),children:(0,d.formatIndianCurrency)(e.totalProfit)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-gray-600",children:"Receive:"}),(0,r.jsx)("span",{className:"text-xs font-bold text-green-600",children:(0,d.formatIndianCurrency)(e.totalPaid)})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-gray-600",children:"Due:"}),(0,r.jsx)("span",{className:"text-xs font-bold ".concat(a>0?"text-red-600":"text-green-600"),children:(0,d.formatIndianCurrency)(Math.abs(a))})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between pt-1.5 border-t border-gray-100",children:[s&&null!==e.lastPaymentAmount?(0,r.jsxs)("span",{className:"text-[10px] text-gray-500",children:[(0,m.ZP)(s,"dd MMM")," • ",(0,d.formatIndianCurrency)(e.lastPaymentAmount)]}):(0,r.jsx)("span",{className:"text-[10px] text-gray-400",children:"No payments"}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsxs)("span",{className:"text-[10px] text-gray-500",children:[e.orders.length," order",1!==e.orders.length?"s":""]}),(0,r.jsx)(y.Z,{size:11,className:"text-gray-400"})]})]})]})},e.partyName)})}):"suppliers"===V?(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsx)("div",{className:"grid grid-cols-2 gap-3",children:getSupplierGroups().map((e,t)=>{let a=page_safeParseDate(e.lastPaymentDate),s=e.totalAmount>0?e.totalPaid/e.totalAmount*100:0;return(0,r.jsxs)("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden transition-all duration-200 hover:border-orange-400 hover:shadow-md active:scale-[0.98] native-press group",style:{animation:"fadeInUp 0.3s ease-out ".concat(.03*t,"s both"),WebkitTapHighlightColor:"transparent",position:"relative",overflow:"hidden"},onClick:t=>{t.target.closest("button")||((0,D.m)(t),handleSupplierGroupClick(e))},children:[(0,r.jsx)("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 px-3 py-2.5 border-b border-orange-200/50",children:(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 flex-1 min-w-0",children:[(0,r.jsx)("div",{className:"p-1.5 bg-orange-500 rounded-lg shadow-sm group-hover:scale-110 transition-transform duration-200",children:(0,r.jsx)(h.Z,{size:14,className:"text-white"})}),(0,r.jsx)("h3",{className:"font-bold text-sm text-gray-900 truncate leading-tight",children:e.supplierName})]}),(0,r.jsx)(y.Z,{size:16,className:"text-orange-500 flex-shrink-0 ml-1 group-hover:translate-x-0.5 transition-transform duration-200"})]})}),(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsxs)("div",{className:"space-y-2 mb-3",children:[(0,r.jsxs)("div",{className:"bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-2 border border-gray-200/50",children:[(0,r.jsx)("div",{className:"text-[10px] text-gray-600 mb-0.5 font-medium",children:"Total Amount"}),(0,r.jsx)("div",{className:"text-sm font-bold text-gray-900 truncate",children:(0,d.formatIndianCurrency)(e.totalAmount)})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,r.jsxs)("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-2 border border-green-200/50",children:[(0,r.jsx)("div",{className:"text-[10px] text-green-700 mb-0.5 font-medium",children:"Paid"}),(0,r.jsx)("div",{className:"text-xs font-bold text-green-700 truncate",children:(0,d.formatIndianCurrency)(e.totalPaid)})]}),(0,r.jsxs)("div",{className:"rounded-lg p-2 border ".concat(e.remainingAmount>0?"bg-gradient-to-br from-red-50 to-red-100 border-red-200/50":"bg-gradient-to-br from-green-50 to-green-100 border-green-200/50"),children:[(0,r.jsx)("div",{className:"text-[10px] mb-0.5 font-medium ".concat(e.remainingAmount>0?"text-red-700":"text-green-700"),children:"Remaining"}),(0,r.jsx)("div",{className:"text-xs font-bold truncate ".concat(e.remainingAmount>0?"text-red-700":"text-green-700"),children:(0,d.formatIndianCurrency)(Math.abs(e.remainingAmount))})]})]})]}),e.totalAmount>0&&(0,r.jsxs)("div",{className:"mb-3",children:[(0,r.jsx)("div",{className:"h-2 bg-gray-200 rounded-full overflow-hidden shadow-inner",children:(0,r.jsx)("div",{className:"h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-700 ease-out shadow-sm",style:{width:"".concat(Math.min(100,s),"%")}})}),(0,r.jsxs)("div",{className:"text-[9px] text-gray-500 mt-1 text-center font-medium",children:[s.toFixed(1),"% Paid"]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between pt-2 border-t border-gray-100",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full"}),(0,r.jsxs)("span",{className:"text-[10px] text-gray-600 font-medium",children:[e.orders.length," ",1===e.orders.length?"Order":"Orders"]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),(0,r.jsxs)("span",{className:"text-[10px] text-gray-600 font-medium",children:[e.ledgerPayments.length," ",1===e.ledgerPayments.length?"Payment":"Payments"]})]})]}),a&&null!==e.lastPaymentAmount&&(0,r.jsx)("div",{className:"mt-2 pt-2 border-t border-gray-100",children:(0,r.jsxs)("div",{className:"flex items-center gap-1.5 text-[10px]",children:[(0,r.jsx)(f.Z,{size:10,className:"text-gray-400"}),(0,r.jsx)("span",{className:"text-gray-600 font-medium",children:"Last:"}),(0,r.jsx)("span",{className:"text-gray-700 font-semibold",children:(0,m.ZP)(a,"dd MMM")}),(0,r.jsx)("span",{className:"text-gray-500",children:"•"}),(0,r.jsx)("span",{className:"text-gray-700 font-semibold",children:(0,d.formatIndianCurrency)(e.lastPaymentAmount)})]})})]})]},e.supplierName)})}),0===getSupplierGroups().length&&(0,r.jsxs)("div",{className:"col-span-2 p-8 text-center",children:[(0,r.jsx)(h.Z,{size:48,className:"mx-auto mb-3 text-gray-300"}),(0,r.jsx)("p",{className:"text-sm font-medium text-gray-500",children:"No suppliers found"}),(0,r.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:"Suppliers will appear here when you create orders"})]})]}):(0,r.jsxs)("div",{className:"inline-block min-w-full",style:{paddingTop:"0.5rem"},children:[a.length>0&&(0,r.jsxs)("div",{className:"sticky top-0 z-30 shadow-sm bg-white min-w-max",children:[(0,r.jsx)("div",{ref:eT,className:"bg-white border-b border-gray-100 px-2 py-2 flex items-center justify-between sticky left-0 z-40 w-screen max-w-[100%]",children:(0,r.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},children:[(0,r.jsx)("input",{type:"checkbox",checked:a.length>0&&a.every(e=>H.has(e.id)),onChange:e=>{if(e.target.checked){let e=new Set(a.map(e=>e.id));_(e)}else _(new Set)},className:"custom-checkbox",style:{width:"22px",height:"22px"},onClick:e=>e.stopPropagation()}),(0,r.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Select All (",a.length,")"]})]})}),(0,r.jsx)("div",{ref:eA,className:"bg-gray-50 min-w-max",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-12 px-1 py-1.5 flex-shrink-0"}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Date"})}),(0,r.jsx)("div",{className:"w-28 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer",onClick:e=>{e.stopPropagation(),eI("party")},children:[(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Party/Site"}),(0,r.jsx)("div",{className:"p-0.5 hover:bg-gray-200 rounded transition-colors ".concat(ew.size>0?"text-primary-600":"text-gray-400"),children:(0,r.jsx)(b.Z,{size:10})}),ew.size>0&&(0,r.jsxs)("span",{className:"text-[9px] text-primary-600 font-bold",children:["(",ew.size,")"]})]})}),(0,r.jsx)("div",{className:"w-28 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsxs)("div",{className:"flex items-center gap-1 cursor-pointer",onClick:e=>{e.stopPropagation(),eI("material")},children:[(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Material"}),(0,r.jsx)("div",{className:"p-0.5 hover:bg-gray-200 rounded transition-colors ".concat(eC.size>0?"text-primary-600":"text-gray-400"),children:(0,r.jsx)(b.Z,{size:10})}),eC.size>0&&(0,r.jsxs)("span",{className:"text-[9px] text-primary-600 font-bold",children:["(",eC.size,")"]})]})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Wt/Rate"})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Total"})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Truck"})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Orig Wt/Rate"})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Orig Total"})}),(0,r.jsx)("div",{className:"w-24 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Add/Profit"})}),(0,r.jsx)("div",{className:"w-36 px-1 py-1.5 flex-shrink-0 border-l border-gray-200",children:(0,r.jsx)("span",{className:"text-[10px] font-semibold text-gray-600 uppercase leading-tight",children:"Actions"})})]})}),(0,r.jsx)("div",{className:"bg-primary-600 text-white border-t border-primary-700 border-b border-primary-500 min-w-max",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-12 px-1 py-0.5 flex-shrink-0"}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:(0,r.jsx)("span",{className:"text-[9px] font-bold uppercase",children:"Total"})}),(0,r.jsx)("div",{className:"w-28 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),(0,r.jsx)("div",{className:"w-28 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:(0,r.jsx)("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(a.reduce((e,t)=>e+t.total,0))})}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:(0,r.jsx)("div",{className:"text-[9px] font-bold",children:a.reduce((e,t)=>e+t.originalWeight,0).toLocaleString("en-IN")})}),(0,r.jsx)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:(0,r.jsx)("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(a.reduce((e,t)=>e+t.originalTotal,0))})}),(0,r.jsxs)("div",{className:"w-24 px-1 py-0.5 flex-shrink-0 border-l border-primary-500",children:[(0,r.jsx)("div",{className:"text-[9px] font-bold",children:(0,d.formatIndianCurrency)(a.reduce((e,t)=>e+t.additionalCost,0))}),(0,r.jsx)("div",{className:"font-bold text-[10px]",children:(0,d.formatIndianCurrency)(a.reduce((e,t)=>e+t.profit,0))})]}),(0,r.jsx)("div",{className:"w-36 px-1 py-0.5 flex-shrink-0 border-l border-primary-500"})]})})]}),(0,r.jsx)("div",{className:"divide-y divide-gray-100 min-w-max",children:a.map((e,t)=>{let a=page_safeParseDate(e.date),s=Array.isArray(e.material)?e.material:e.material?[e.material]:[],i=e.partialPayments||[],l=i.reduce((e,t)=>e+t.amount,0),o=e.customerPayments||[],c=o.reduce((e,t)=>e+t.amount,0);e.originalTotal;let u=(0,n.sA)(e),p=(0,n.jX)(e);return(0,r.jsx)("div",{"data-order-id":e.id,className:"border-b border-gray-100",children:(0,r.jsxs)("div",{onClick:t=>{t.target.closest("button")||t.target.closest('input[type="checkbox"]')||ef(e.id||null)},className:"flex items-center touch-manipulation transition-colors ".concat(eh===e.id?"bg-yellow-100":H.has(e.id)?"bg-primary-50":u?"bg-green-50/30":"bg-white"),style:{WebkitTapHighlightColor:"transparent",animation:"fadeInUp 0.2s ease-out ".concat(.02*t,"s both"),position:"relative",overflow:"hidden",minHeight:"2rem",lineHeight:"1rem"},children:[(0,r.jsx)("div",{className:"w-12 px-1 py-1 flex-shrink-0 flex items-center justify-center border-r border-gray-100",children:(0,r.jsx)("input",{type:"checkbox",checked:H.has(e.id),onChange:t=>{t.stopPropagation(),toggleOrderSelection(e.id)},className:"custom-checkbox",style:{width:"18px",height:"18px"},onClick:e=>e.stopPropagation()})}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"text-gray-600 text-[10px] leading-tight font-medium",children:a?(0,m.ZP)(a,"dd MMM"):"N/A"}),e.invoiced&&(0,r.jsx)(x.Z,{size:10,className:"text-blue-600 mt-0.5"})]}),(0,r.jsxs)("div",{className:"w-28 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-900 truncate text-[11px] leading-tight",children:e.partyName}),e.siteName&&(0,r.jsx)("div",{className:"text-[9px] text-gray-500 truncate",children:e.siteName})]}),(0,r.jsx)("div",{className:"w-28 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:(0,r.jsxs)("div",{className:"flex flex-wrap gap-0.5",children:[s.slice(0,2).map((e,t)=>(0,r.jsx)("span",{className:"bg-primary-50 text-primary-700 px-1 py-0.5 rounded text-[9px] font-medium whitespace-nowrap",title:e,children:e},t)),s.length>2&&(0,r.jsxs)("span",{className:"text-[9px] text-gray-500",children:["+",s.length-2]})]})}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"text-gray-700 text-[10px] leading-tight",children:e.weight.toLocaleString("en-IN")}),(0,r.jsx)("div",{className:"text-gray-700 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.rate)})]}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"font-bold text-primary-600 text-[11px] leading-tight",children:(0,d.formatIndianCurrency)(e.total)}),(0,r.jsx)("div",{className:"text-[10px] text-green-600 font-semibold leading-tight",children:(0,d.formatIndianCurrency)(c)})]}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"text-gray-700 text-[10px] leading-tight truncate font-semibold",children:e.truckOwner}),e.truckNo&&(0,r.jsx)("div",{className:"text-gray-700 text-[9px] leading-tight truncate",children:e.truckNo}),e.supplier&&(0,r.jsx)("div",{className:"text-orange-600 text-[9px] leading-tight truncate",children:e.supplier})]}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"text-gray-700 text-[10px] leading-tight",children:e.originalWeight.toLocaleString("en-IN")}),(0,r.jsx)("div",{className:"text-gray-700 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.originalRate)})]}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"font-semibold text-gray-800 text-[11px] leading-tight",children:(0,d.formatIndianCurrency)(e.originalTotal)}),(0,r.jsx)("div",{className:"text-[10px] text-green-600 font-semibold leading-tight",children:(0,d.formatIndianCurrency)(l)}),u&&(0,r.jsx)("span",{className:"bg-green-500 text-white px-1 py-0.5 rounded text-[8px] font-bold",children:"PAID"}),p&&(0,r.jsx)("span",{className:"bg-blue-500 text-white px-1 py-0.5 rounded text-[8px] font-bold ml-1",children:"PARTY PAID"})]}),(0,r.jsxs)("div",{className:"w-24 px-1 py-1 flex-shrink-0 border-r border-gray-100",children:[(0,r.jsx)("div",{className:"text-blue-600 text-[10px] leading-tight",children:(0,d.formatIndianCurrency)(e.additionalCost)}),(()=>{let t=Number(e.expenseAdjustment||0),a=Number(e.revenueAdjustment||0),s=Number(e.adjustmentAmount||0),n=e.profit+t+a+s,i=Math.abs(n-e.profit)>.01,l=(e.customerPayments||[]).reduce((e,t)=>e+t.amount,0),o=(e.partialPayments||[]).reduce((e,t)=>e+t.amount,0);if(p&&u){let t=l-o-e.additionalCost+s;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"font-semibold text-[11px] leading-tight text-gray-500 line-through opacity-60",children:(0,d.formatIndianCurrency)(e.profit)}),(0,r.jsx)("div",{className:"font-bold text-[11px] leading-tight ".concat(t>=0?"text-green-700":"text-red-700"),children:(0,d.formatIndianCurrency)(t)})]})}return p&&i?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"font-semibold text-[11px] leading-tight text-gray-500 line-through opacity-60",children:(0,d.formatIndianCurrency)(e.profit)}),(0,r.jsx)("div",{className:"font-bold text-[11px] leading-tight ".concat(n>=0?"text-green-700":"text-red-700"),children:(0,d.formatIndianCurrency)(n)})]}):(0,r.jsx)("div",{className:"font-semibold text-[11px] leading-tight ".concat(e.profit>=0?"text-green-600":"text-red-600"),children:(0,d.formatIndianCurrency)(e.profit)})})()]}),(0,r.jsxs)("div",{className:"w-36 px-1 py-1 flex-shrink-0 flex items-center gap-2 justify-center",children:[(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),Q(e),ee(!0)},className:"p-2 text-gray-600 hover:text-primary-600 transition-colors rounded-full hover:bg-primary-50 bg-white border border-gray-200 shadow-sm active:scale-95",title:"View",children:(0,r.jsx)(x.Z,{size:18})}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),W(e),Z(!0)},className:"p-2 text-gray-600 hover:text-primary-600 transition-colors rounded-full hover:bg-primary-50 bg-white border border-gray-200 shadow-sm active:scale-95",title:"Edit",children:(0,r.jsx)(v,{size:18})})]})]})},e.id)})})]}),M&&(0,r.jsx)(c.Z,{order:L,onClose:()=>{Z(!1),W(null)},onSave:handleSaveOrder}),(0,r.jsx)(OrderDetailPopup,{order:J,isOpen:$,onClose:()=>{ee(!1),Q(null)},onEdit:e=>{W(e),ee(!1),Z(!0)},onDelete:handleDeleteOrder,onEditPayment:handleEditPayment,onRemovePayment:handleRemovePayment,onOrderUpdated:async()=>{if(await loadOrders(),null==J?void 0:J.id){let e=await n.XK.getOrderById(J.id);e&&Q(e)}}}),(0,r.jsx)(PartyDetailPopup,{group:et,isOpen:er,onClose:()=>{es(!1),ea(null)},onEditOrder:e=>{W(e),Z(!0)},onDeleteOrder:handleDeleteOrder,onOrderClick:e=>{Q(e),ee(!0)},onPaymentAdded:async()=>{if(await loadPartyPayments(),await loadOrders(),null==et?void 0:et.partyName){let e=getPartyGroups().find(e=>e.partyName===et.partyName);e&&ea(e)}},onPaymentRemoved:async()=>{await loadPartyPayments()}}),(0,r.jsx)(SupplierDetailPopup,{group:en,isOpen:el,onClose:()=>{ed(!1),ei(null)},onEditOrder:e=>{W(e),Z(!0)},onDeleteOrder:handleDeleteOrder,onOrderClick:e=>{Q(e),ee(!0)},onRefresh:async()=>{await loadOrders(),await loadLedgerEntries()}}),eu&&em&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50",onClick:()=>{ep(!1),ex(null)}}),(0,r.jsxs)("div",{className:"fixed inset-x-0 bottom-0 bg-white rounded-t-2xl border-t border-gray-100 z-50 max-h-[80vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"sticky top-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:"Payment History"}),(0,r.jsx)("button",{onClick:()=>{ep(!1),ex(null)},className:"p-1.5 hover:bg-gray-100 rounded-lg transition-colors",children:(0,r.jsx)(N.Z,{size:20,className:"text-gray-600"})})]}),(0,r.jsx)("div",{className:"p-4 space-y-4",children:(()=>{let{expenseAmount:e,totalPaid:t,remainingAmount:a}=getOrderPaymentInfo(em),s=em.partialPayments||[];return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"bg-gray-50 rounded-lg p-4 space-y-2",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-600",children:"Total Expense"}),(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(e)})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-600",children:"Total Paid"}),(0,r.jsx)("span",{className:"text-sm font-semibold text-green-600",children:(0,d.formatIndianCurrency)(t)})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center pt-2 border-t border-gray-200",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-600",children:"Remaining"}),(0,r.jsx)("span",{className:"text-sm font-semibold ".concat(a>0?"text-red-600":"text-green-600"),children:(0,d.formatIndianCurrency)(a)})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Payment Records"}),0===s.length?(0,r.jsx)("p",{className:"text-sm text-gray-500 text-center py-4",children:"No payment records found"}):(0,r.jsx)("div",{className:"space-y-2",children:s.map(e=>{s.filter(t=>t.id!==e.id).reduce((e,t)=>e+t.amount,0);let t=!!e.ledgerEntryId;return(0,r.jsxs)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between hover:bg-gray-50 transition-colors",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-900",children:(0,d.formatIndianCurrency)(e.amount)}),t&&(0,r.jsx)("span",{className:"text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded font-medium",children:"From Ledger"})]}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:(()=>{let t=page_safeParseDate(e.date);return t?(0,m.ZP)(t,"dd MMM yyyy, hh:mm a"):"Invalid Date"})()})]}),e.note&&(0,r.jsx)("div",{className:"text-xs text-gray-500 mt-0.5",children:e.note})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 ml-3",children:[!t&&(0,r.jsx)("button",{onClick:()=>handleEditPayment(em,e.id),className:"p-1.5 bg-blue-50 text-blue-600 rounded active:bg-blue-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Edit payment",children:(0,r.jsx)(v,{size:16})}),!t&&(0,r.jsx)("button",{onClick:()=>handleRemovePayment(em,e.id),className:"p-1.5 bg-red-50 text-red-600 rounded active:bg-red-100 transition-colors touch-manipulation",style:{WebkitTapHighlightColor:"transparent"},title:"Remove payment",children:(0,r.jsx)(u.Z,{size:16})})]})]},e.id)})})]}),a>0&&(0,r.jsxs)("button",{onClick:()=>{ep(!1),handleAddPaymentToOrder(em)},className:"w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors flex items-center justify-center gap-2",children:[(0,r.jsx)(g.Z,{size:18}),"Add Payment"]})]})})()})]})]}),eg&&eg.order.partialPayments&&(()=>{let e=eg.order.partialPayments.find(e=>e.id===eg.paymentId);if(!e)return null;let t=eg.order.partialPayments.filter(e=>e.id!==eg.paymentId).reduce((e,t)=>e+t.amount,0),a=Number(eg.order.originalTotal||0);return(0,r.jsx)(PaymentEditPopup,{isOpen:!!eg,onClose:()=>ey(null),onSave:handleSavePaymentEdit,initialData:{amount:e.amount,date:e.date},maxAmount:a-t})})()]}),(0,r.jsx)(SelectionSheet,{isOpen:"party"===eS,onClose:()=>eI(null),title:"Filter by Party",children:(0,r.jsxs)("div",{className:"space-y-1",children:[ew.size>0&&(0,r.jsxs)("button",{onClick:()=>{clearPartyFilter(),eI(null)},className:"w-full text-left px-4 py-3 text-red-600 font-medium hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)(u.Z,{size:16}),"Clear Filter"]}),0===eL.length?(0,r.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No parties found"}):eL.map(e=>{let t=ew.has(e);return(0,r.jsxs)("button",{onClick:()=>{let t=new Set;t.add(e),eP(t),eI(null)},className:"w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center justify-between ".concat(t?"bg-primary-50 text-primary-700 font-semibold":"hover:bg-gray-50 text-gray-700"),children:[(0,r.jsx)("span",{className:"truncate",children:e}),t&&(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary-600"})]},e)})]})}),(0,r.jsx)(SelectionSheet,{isOpen:"material"===eS,onClose:()=>eI(null),title:"Filter by Material",children:(0,r.jsxs)("div",{className:"space-y-1",children:[eC.size>0&&(0,r.jsxs)("button",{onClick:()=>{clearMaterialFilter(),eI(null)},className:"w-full text-left px-4 py-3 text-red-600 font-medium hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2",children:[(0,r.jsx)(u.Z,{size:16}),"Clear Filter"]}),0===getUniqueMaterials().length?(0,r.jsx)("div",{className:"text-center text-gray-500 py-8",children:"No materials found"}):getUniqueMaterials().map(e=>{let t=eC.has(e);return(0,r.jsxs)("button",{onClick:()=>{let t=new Set;t.add(e),ek(t),eI(null)},className:"w-full text-left px-4 py-3 rounded-lg transition-colors flex items-center justify-between ".concat(t?"bg-primary-50 text-primary-700 font-semibold":"hover:bg-gray-50 text-gray-700"),children:[(0,r.jsx)("span",{className:"truncate",children:e}),t&&(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-primary-600"})]},e)})]})}),(0,r.jsx)(o.Z,{})]})}},71037:function(e,t,a){"use strict";a.d(t,{I:function(){return getAdjustedProfit},w:function(){return hasProfitAdjustments}});let toNumber=e=>{if("number"==typeof e)return e;if("string"==typeof e){let t=Number(e);return isNaN(t)?0:t}return 0},getAdjustedProfit=e=>{let t=toNumber(e.expenseAdjustment),a=toNumber(e.revenueAdjustment),r=toNumber(e.adjustmentAmount),s=e.profit+t+a+r;return Math.round(100*s)/100},hasProfitAdjustments=e=>{let t=getAdjustedProfit(e);return Math.abs(t-e.profit)>.01}}},function(e){e.O(0,[358,118,949,923,295,587,264,940,971,472,744],function(){return e(e.s=94172)}),_N_E=e.O()}]);