"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[264],{8005:function(t,e,r){r.d(e,{u:function(){return n}});var i=r(45050),a=r(24086);let o="ledgerActivities",n={async logActivity(t){let e=(0,i.z)();if(!e)throw Error("Firebase is not configured.");let r={ledgerEntryId:t.ledgerEntryId,activityType:t.activityType,timestamp:new Date().toISOString(),timestampTs:a.EK.now()};void 0!==t.amount&&(r.amount=t.amount),void 0!==t.previousAmount&&(r.previousAmount=t.previousAmount),void 0!==t.note&&(r.note=t.note||null),void 0!==t.previousNote&&(r.previousNote=t.previousNote||null),void 0!==t.date&&(r.date=t.date||null),void 0!==t.previousDate&&(r.previousDate=t.previousDate||null),void 0!==t.supplier&&(r.supplier=t.supplier||null),void 0!==t.previousSupplier&&(r.previousSupplier=t.previousSupplier||null),void 0!==t.partyName&&(r.partyName=t.partyName||null),void 0!==t.previousPartyName&&(r.previousPartyName=t.previousPartyName||null),void 0!==t.type&&(r.type=t.type||null),void 0!==t.previousType&&(r.previousType=t.previousType||null);let n=await (0,a.ET)((0,a.hJ)(e,o),r);return n.id},async getActivities(t,e){let r=(0,i.z)();if(!r)return[];let n=(0,a.IO)((0,a.hJ)(r,o),(0,a.Xo)("timestampTs","desc")),l=await (0,a.PL)(n),d=[];return l.forEach(r=>{let i=r.data(),a=i.timestamp||i.timestampTs&&i.timestampTs.toDate().toISOString()||new Date().toISOString();if(t){let e=new Date(t);if(e.setHours(0,0,0,0),new Date(a)<e)return}if(e){let t=new Date(e);if(t.setHours(23,59,59,999),new Date(a)>t)return}d.push({id:r.id,ledgerEntryId:i.ledgerEntryId,activityType:i.activityType,timestamp:a,amount:i.amount,previousAmount:i.previousAmount,note:i.note,previousNote:i.previousNote,date:i.date,previousDate:i.previousDate,supplier:i.supplier,previousSupplier:i.previousSupplier,partyName:i.partyName,previousPartyName:i.previousPartyName,type:i.type,previousType:i.previousType})}),d},subscribe(t,e,r){let n=(0,i.z)();if(!n)return()=>{};let l=(0,a.IO)((0,a.hJ)(n,o),(0,a.Xo)("timestampTs","desc"));return(0,a.cf)(l,i=>{let a=[];i.forEach(t=>{let i=t.data(),o=i.timestamp||i.timestampTs&&i.timestampTs.toDate().toISOString()||new Date().toISOString();if(e){let t=new Date(e);if(t.setHours(0,0,0,0),new Date(o)<t)return}if(r){let t=new Date(r);if(t.setHours(23,59,59,999),new Date(o)>t)return}a.push({id:t.id,ledgerEntryId:i.ledgerEntryId,activityType:i.activityType,timestamp:o,amount:i.amount,previousAmount:i.previousAmount,note:i.note,previousNote:i.previousNote,date:i.date,previousDate:i.previousDate,supplier:i.supplier,previousSupplier:i.previousSupplier,partyName:i.partyName,previousPartyName:i.previousPartyName,type:i.type,previousType:i.previousType})}),t(a)},e=>{console.error("Error subscribing to activities:",e),t([])})}}},86725:function(t,e,r){r.d(e,{ledgerService:function(){return u}});var i=r(24086),a=r(45050),o=r(8005),n=r(70349),l=r(27056);let d="ledgerEntries",u={async addEntry(t,e,r){let u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"manual",s=arguments.length>4?arguments[4]:void 0,p=arguments.length>5?arguments[5]:void 0,c=arguments.length>6?arguments[6]:void 0,m=(0,a.z)();if(!m)throw Error("Firebase is not configured.");let y=new Date().toISOString(),v=s||y;if(s&&!s.includes("T")){let[t,e,r]=s.split("-").map(Number),i=new Date(t,e-1,r,12,0,0);v=i.toISOString()}let g={type:t,amount:e,date:v,createdAt:y,source:u};r&&r.trim()&&(g.note=r.trim()),p&&p.trim()&&(g.supplier=p.trim()),c&&c.trim()&&(g.partyName=c.trim());let f=await (0,i.ET)((0,i.hJ)(m,d),{...g,createdAtTs:(0,i.Bt)()});if("debit"===t&&p&&p.trim())try{let t=await this.list(),i=t.map(t=>t.id).filter(Boolean);i.push(f.id),await n.XK.reconcileSupplierOrders(p.trim(),i),n.XK.distributePaymentToSupplierOrders(p.trim(),e,f.id,r).catch(t=>console.error("Failed to distribute supplier payment:",t))}catch(t){console.error("Error initiating payment distribution:",t)}if("credit"===t&&c&&c.trim())try{l.s.distributePaymentToPartyOrders(c.trim(),e,f.id,v,r).catch(t=>console.error("Failed to distribute party payment:",t))}catch(t){console.error("Error initiating party payment distribution:",t)}try{await o.u.logActivity({ledgerEntryId:f.id,activityType:"created",amount:e,note:r,date:v,supplier:p,partyName:c,type:t})}catch(t){console.error("Failed to log ledger activity for creation:",t)}return f.id},async list(){let t=(0,a.z)();if(!t)return[];let e=(0,i.IO)((0,i.hJ)(t,d),(0,i.Xo)("date","desc")),r=await (0,i.PL)(e),o=[];return r.forEach(t=>{var e,r;let i=t.data(),a=null!==(r=null!==(e=i.createdAt)&&void 0!==e?e:i.createdAtTs&&i.createdAtTs.toDate().toISOString())&&void 0!==r?r:void 0,n=i.date;n&&"function"==typeof n.toDate&&(n=n.toDate().toISOString()),o.push({id:t.id,type:i.type,amount:i.amount,note:i.note,date:n,source:i.source,supplier:i.supplier,partyName:i.partyName,...a?{createdAt:a}:{}})}),o.sort((t,e)=>{let r=t.createdAt?new Date(t.createdAt).getTime():t.date?new Date(t.date).getTime():0,i=e.createdAt?new Date(e.createdAt).getTime():e.date?new Date(e.date).getTime():0;return i-r}),o},subscribe(t){let e=(0,a.z)();if(!e)return()=>{};let r=(0,i.IO)((0,i.hJ)(e,d),(0,i.Xo)("date","desc"));return(0,i.cf)(r,e=>{let r=[];e.forEach(t=>{var e,i;let a=t.data(),o=null!==(i=null!==(e=a.createdAt)&&void 0!==e?e:a.createdAtTs&&a.createdAtTs.toDate().toISOString())&&void 0!==i?i:void 0,n=a.date;n&&"function"==typeof n.toDate&&(n=n.toDate().toISOString()),r.push({id:t.id,type:a.type,amount:a.amount,note:a.note,date:n,source:a.source,supplier:a.supplier,partyName:a.partyName,...o?{createdAt:o}:{}})}),r.sort((t,e)=>{let r=t.createdAt?new Date(t.createdAt).getTime():t.date?new Date(t.date).getTime():0,i=e.createdAt?new Date(e.createdAt).getTime():e.date?new Date(e.date).getTime():0;return i-r}),t(r)})},async getBalance(){let t=await this.list();return t.reduce((t,e)=>t+("credit"===e.type?e.amount:-e.amount),0)},async remove(t){let e=(0,a.z)();if(!e)throw Error("Firebase is not configured.");let r=null;try{r=await this.getEntryById(t)}catch(t){console.warn("Failed to get entry before deletion for activity logging:",t)}try{if(console.log("Cleaning up payments for ledger entry:",t),await n.XK.removePaymentsByLedgerEntryId(t),null==r?void 0:r.supplier){let e=await this.list(),i=e.map(t=>t.id).filter(e=>e!==t).filter(Boolean);await n.XK.reconcileSupplierOrders(r.supplier,i)}if(null==r?void 0:r.partyName){let e=await this.list(),i=e.map(t=>t.id).filter(e=>e!==t).filter(Boolean);await l.s.reconcilePartyPayments(r.partyName,i)}}catch(t){console.error("Failed to cleanup order payments for ledger entry:",t)}await (0,i.oe)((0,i.JU)(e,d,t));try{await o.u.logActivity({ledgerEntryId:t,activityType:"deleted",amount:null==r?void 0:r.amount,note:null==r?void 0:r.note,date:null==r?void 0:r.date,supplier:null==r?void 0:r.supplier,partyName:null==r?void 0:r.partyName,type:null==r?void 0:r.type})}catch(t){console.error("Failed to log ledger activity for deletion:",t)}},async removeLastEntry(){let t=await this.list();if(0===t.length)throw Error("No ledger entries found");let e=t[0];if(!e.id)throw Error("Last entry does not have an ID");await this.remove(e.id)},async getEntryById(t){let e=(0,a.z)();if(!e)return null;try{var r,o;let a=(0,i.JU)(e,d,t),n=await (0,i.QT)(a);if(!n.exists())return null;let l=n.data(),u=null!==(o=null!==(r=l.createdAt)&&void 0!==r?r:l.createdAtTs&&l.createdAtTs.toDate().toISOString())&&void 0!==o?o:void 0,s=l.date;return s&&"function"==typeof s.toDate&&(s=s.toDate().toISOString()),{id:n.id,type:l.type,amount:l.amount,note:l.note,date:s,source:l.source,supplier:l.supplier,partyName:l.partyName,...u?{createdAt:u}:{}}}catch(t){return console.error("Error getting ledger entry by ID:",t),null}},async update(t,e){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},u=(0,a.z)();if(!u)throw Error("Firebase is not configured.");let s=await this.getEntryById(t),p=(0,i.JU)(u,d,t),c={},m=new Date().toISOString();if(c.date=m,void 0!==e.amount&&(c.amount=e.amount),void 0!==e.note&&(e.note&&e.note.trim()?c.note=e.note.trim():c.note=null),void 0!==e.supplier&&(e.supplier&&e.supplier.trim()?c.supplier=e.supplier.trim():c.supplier=null),void 0!==e.partyName&&(e.partyName&&e.partyName.trim()?c.partyName=e.partyName.trim():c.partyName=null),await (0,i.r7)(p,c),!r.fromOrder)try{await n.XK.updatePaymentByLedgerEntryId(t,{amount:e.amount,date:c.date})}catch(t){console.error("Failed to sync ledger update to order payment:",t)}let y=null==s?void 0:s.type,v=void 0!==c.supplier?c.supplier:null==s?void 0:s.supplier;if("debit"===y&&v)try{console.log("\uD83D\uDD04 Triggering redistribution for updated supplier ledger entry ".concat(t)),await n.XK.redistributeSupplierPayment(t,c.date)}catch(t){console.error("Redistribution failed",t)}let g=void 0!==c.partyName?c.partyName:null==s?void 0:s.partyName;if("credit"===y&&g)try{console.log("\uD83D\uDD04 Triggering redistribution for updated party payment ledger entry ".concat(t));let e=await this.list(),r=e.map(t=>t.id).filter(Boolean);await l.s.reconcilePartyPayments(g,r);let i=e.filter(t=>t.partyName===g&&"credit"===t.type);for(let t of i)t.id&&await l.s.distributePaymentToPartyOrders(g,t.amount,t.id,t.date,t.note)}catch(t){console.error("Party payment redistribution failed",t)}try{var f,w;let r=((null==s?void 0:s.note)||"").trim()||void 0,i=void 0!==e.note?(e.note||"").trim()||void 0:r,a=null==s?void 0:s.amount,n=void 0!==e.amount?e.amount:a,l=null==s?void 0:s.date,d=c.date,u=((null==s?void 0:s.supplier)||"").trim()||void 0,p=void 0!==e.supplier?(null===(f=e.supplier)||void 0===f?void 0:f.trim())||void 0:u,m=((null==s?void 0:s.partyName)||"").trim()||void 0,y=void 0!==e.partyName?(null===(w=e.partyName)||void 0===w?void 0:w.trim())||void 0:m,v=a!==n||r!==i||l!==d||u!==p||m!==y;if(!v){console.log("No changes detected for ledger entry update, skipping activity log.");return}let g={ledgerEntryId:t,activityType:"updated",amount:n,previousAmount:a,note:i,previousNote:r,date:d,previousDate:l,supplier:p,previousSupplier:u,partyName:y,previousPartyName:m,type:null==s?void 0:s.type};console.log("\uD83D\uDCDD Logging ledger activity for update:",{ledgerEntryId:t,activityType:"updated",hasChanges:v}),await o.u.logActivity(g),console.log("✅ Activity logged successfully")}catch(t){console.error("❌ Failed to log ledger activity for update:",t)}}}},27056:function(t,e,r){r.d(e,{s:function(){return n}});var i=r(24086),a=r(45050),o=r(70349);let calculateRevenueAdjustment=(t,e)=>{if(!e||0===e.length)return 0;let r=Number(t||0),i=e.reduce((t,e)=>t+Number(e.amount||0),0),a=i-r;return .01>Math.abs(a)?0:Number(a.toFixed(2))},n={async getAllPayments(){let t=(0,a.z)();if(!t)return[];let e=[],r=(0,i.IO)((0,i.hJ)(t,"partyPayments"),(0,i.Xo)("date","desc")),o=await (0,i.PL)(r);return o.forEach(t=>{var r;let i=t.data(),a=i.date;a&&"function"==typeof a.toDate&&(a=i.date.toDate().toISOString());let o=i.createdAt;o&&"function"==typeof o.toDate&&(o=o.toDate().toISOString());let n=i.updatedAt;n&&"function"==typeof n.toDate&&(n=n.toDate().toISOString()),e.push({id:t.id,partyName:i.partyName,amount:Number(i.amount||0),date:a,ledgerEntryId:i.ledgerEntryId,note:null!==(r=i.note)&&void 0!==r?r:null,createdAt:o,updatedAt:n})}),e.sort((t,e)=>{let r=t.date?new Date(t.date).getTime():0,i=e.date?new Date(e.date).getTime():0;return i-r}),e},async addPayment(t,e,o){let n=(0,a.z)();if(!n)throw Error("Firebase is not configured.");if(!(null==t?void 0:t.trim()))throw Error("Party name is required");if(!e||e<=0)throw Error("Payment amount must be greater than zero");let l=t.trim(),d=new Date().toISOString(),u=null==o?void 0:o.trim(),{ledgerService:s}=await Promise.resolve().then(r.bind(r,86725)),p=await s.addEntry("credit",e,u,"partyPayment",d,void 0,l);await (0,i.ET)((0,i.hJ)(n,"partyPayments"),{partyName:l,amount:e,date:d,note:u||null,ledgerEntryId:p,createdAt:d,updatedAt:d})},async removePayment(t){let e=(0,a.z)();if(!e)throw Error("Firebase is not configured.");if(!t)throw Error("Payment ID is required");let o=(0,i.JU)(e,"partyPayments",t),n=await (0,i.QT)(o);if(!n.exists())throw Error("Payment not found");let l=n.data(),d=l.ledgerEntryId;if(d){let{ledgerService:t}=await Promise.resolve().then(r.bind(r,86725));await t.remove(d)}await (0,i.oe)(o)},async distributePaymentToPartyOrders(t,e,r,n,l){let d=(0,a.z)();if(!d)return;console.log("\uD83D\uDD04 Distributing income of ₹".concat(e," to party: ").concat(t));let u=await o.XK.getAllOrders({partyName:t}),s=u.filter(t=>!t.partyPaid);s.sort((t,e)=>new Date(t.date).getTime()-new Date(e.date).getTime()),console.log("Found ".concat(s.length," unpaid orders for party ").concat(t));let p=e,c=(0,i.qs)(d);for(let t of s){if(p<=0)break;if(!t.id)continue;let e=t.total||0,a=t.customerPayments||[],o=a.reduce((t,e)=>t+e.amount,0),u=Math.max(0,e-o);if(u<=0)continue;let s=Math.min(p,u),m=new Date().toISOString(),y={id:Date.now().toString()+Math.random().toString(36).substr(2,9),amount:s,date:n,createdAt:m,ledgerEntryId:r,note:l||"Auto-distributed from party payment"},v=[...a,y],g=o+s,f=g>=e-250,w=(0,i.JU)(d,"orders",t.id);c.update(w,{customerPayments:v,partyPaid:f,revenueAdjustment:calculateRevenueAdjustment(e,v)}),console.log("✅ Applied ₹".concat(s," to order ").concat(t.id)),p-=s}if(p>0&&s.length>0){let t=s[s.length-1];if(t&&t.id){console.log("\uD83D\uDCB0 Overpayment of ₹".concat(p," detected. Applying to order ").concat(t.id," as profit adjustment."));let e=(0,i.JU)(d,"orders",t.id);t.adjustmentAmount;let r=Number(t.revenueAdjustment||0);c.update(e,{revenueAdjustment:r+p})}}await c.commit(),console.log("✅ Party payment distribution complete.")},async reconcilePartyPayments(t,e){let r=(0,a.z)();if(!r)return;let n=new Set(e);console.log("\uD83D\uDD04 Reconciling payments for party: ".concat(t));let l=await o.XK.getAllOrders({partyName:t}),d=(0,i.qs)(r);for(let t of l){if(!t.id||!t.customerPayments||0===t.customerPayments.length)continue;let e=t.customerPayments.filter(t=>!t.ledgerEntryId||n.has(t.ledgerEntryId));if(e.length<t.customerPayments.length){let a=(0,i.JU)(r,"orders",t.id),o=e.reduce((t,e)=>t+e.amount,0),n=o>=(t.total||0)-250;d.update(a,{customerPayments:e,partyPaid:n,revenueAdjustment:calculateRevenueAdjustment(t.total||0,e)}),console.log("\uD83E\uDDF9 Cleaned up orphan customer payments from order ".concat(t.id))}}await d.commit(),console.log("✅ Party payment reconciliation complete.")}}}}]);